---
title: Tailscale 的工作原理
description: 
date: 2024-10-20
slug: 
image: 
draft: true
categories:
    - Go
tags:
    - 读书笔记
---



## 数据平面 WireGuard

我们的基础层是日益流行且优秀的开源[WireGuard](https://www.wireguard.com/)包（特别是用户空间 Go 变体， [wireguard-go](https://git.zx2c4.com/wireguard-go/about/) ）。 WireGuard 在计算机计算机、虚拟机或容器与网络中的任何其他节点之间创建一组极其轻量级的加密隧道。

大多数时候，VPN 用户（包括 WireGuard 用户）构建“中心辐射”架构，其中每个客户端设备（例如你的笔记本电脑）连接到中央“集中器”或 VPN 网关。

![Figure 1. A traditional hub-and-spoke VPN.](http://img.golang.space/img-1729530151535.svg)

这是设置 WireGuard 最简单的方法，因为节点之间想要连接对方，需要知道每个其它节点的公钥/IP/端口。

如果想要完全连接 10 个节点，那么每个节点必须了解对等的 9 个节点，或者 90 个独立的隧道端点。在中心辐射型结构中，在中心辐射型结构中，只有一个中心中心节点和 9 个离群点（通过“辐条”连接它们），这要简单得多。中心节点通常有一个静态 IP 地址，并且在其防火墙中打了一个洞，因此每个人都可以轻松找到它。然后，它可以按照客户端-服务器 Internet 协议的通用方式接受来自其他 IP 地址的节点的传入连接，即使这些节点本身位于防火墙后面。

轴辐式结构效果很好，但也有一些缺点。首先，大多数现代公司并没有指定一个地点作为中心。他们拥有多个办公室、多个云数据中心或区域或 VPC 等。在传统的 VPN 设置中，公司配置单个 VPN 集中器，然后在位置之间设置辅助隧道（通常使用 IPsec）。因此，远程用户到达一个地方的 VPN 集中器，然后将其流量转发到另一个地方的最终目的地。

这种传统的设置可能很难扩展。首先，远程用户可能靠近也可能不靠近 VPN 集中器；如果它们距离很远，那么它们的连接延迟就会很高。其次，他们想要访问的数据中心可能也不靠近 VPN 集中器；如果距离很远，它们会再次产生高延迟。想象一下这种情况，纽约的一名员工试图通过公司位于旧金山总部的 VPN 集中器或 BeyondCorp 代理访问纽约的服务器

幸运的是，WireGuard 不同。还记得我们上面所说的它创建了“一组极其轻量的隧道”吗？隧道足够轻，我们可以轻松创建多集线器设置：

![spoke](http://img.golang.space/img-1729530818651.svg)

唯一的问题是，现在每个数据中心都需要一个静态 IP 地址、一个开放的防火墙端口和一组 WireGuard 密钥。当我们添加新用户时，我们必须将新密钥分发到所有五台服务器。当我们添加新服务器时，我们必须将其密钥分发给每个用户。

使用 WireGuard 设置它们并不太难，尽管有点乏味，而且我们还没有真正讨论密钥管理的安全实践（见下文）。不管你信不信，这就是互联网过去的运作方式！可悲的是，开发人员已经停止构建点对点应用程序，因为现代互联网的架构几乎是偶然地完全演变为这种中心辐射式设计，通常以主要云提供商为中心收取租金。

还记得那些“极轻”的 WireGuard 隧道吗？如果您可以将所有节点直接连接到所有其他节点，那不是很好吗？这就是所谓的网状网络：

![mesh](http://img.golang.space/img-1729531566471.svg)



## 网状网络

这将非常优雅——至少，它可以让你设计优雅的点对点应用程序——但这会很棘手。如上所述，10 节点网络将需要 10 x 9 = 90 WireGuard 隧道端点配置；每个节点都需要知道自己的密钥以及另外 9 个密钥，并且每次轮换密钥或添加/删除用户时都必须更新每个节点。

所有节点都必须以某种方式找到彼此（用户设备很少有静态 IP 地址），并在其中一个节点移动时重新连接。

另外，您无法轻松地为每个节点打开防火墙端口以允许咖啡馆、酒店或机场等区域的传入连接。

然后，在完成所有这些操作后，如果您的公司有合规性要求，您需要能够以某种方式阻止和审核所有节点之间的流量，即使它不再全部通过您可以限制的中心位置。

Tailscale 也能让这一切发挥作用！我们来谈谈如何。这就是事情变得有点棘手的地方。

## 控制平台: 秘钥交换与协调

我们已经做到了这一点。我们已连接 WireGuard。我们让它一次连接多个事物。我们对其无与伦比的可靠性和效率感到惊叹。伟大的！现在我们想要构建一个网状网络——所有东西都相互连接。

所有这些防火墙和动态 IP 地址都很棘手，所以我们暂时将它们放在一边。 （请参阅下文。） 现在，假设全世界都使用静态 IP（我们敢说……IPv6 吗？）并且防火墙不存在或者很容易打开端口。

我们如何将所有 WireGuard 加密密钥（一种简化且更安全的“证书”形式）获取到每台设备上？

为此，我们使用[开源 Tailscale 节点软件](https://github.com/tailscale/tailscale)。它与我们所说的“协调服务器”（在我们的例子中为login.tailscale.com）进行对话——本质上是一个公共密钥的共享投递箱。

等等，我们又回到中心辐射了吗？不完全是。所谓的“控制平面”是中心辐射型的，但这并不重要，因为它几乎不承载任何流量。它只是交换一些微小的加密密钥并设置策略。数据平面是一个网格。

（我们喜欢这种混合集中式-分布式模型。公司和团队通常希望拥有中央控制权，但他们不希望自己的数据出现中央瓶颈。传统的 VPN 集中器将两者集中在一起，限制了性能，尤其是在压力下。相反，Tailscale 的数据处理能力随着节点数量的增加而增加。）

发生的情况如下：

1. 每个节点为自己生成一个随机的公钥/私钥对，并将公钥与其身份相关联（请参见下面的登录）。
2. 该节点联系协调服务器并留下其公钥以及有关该节点当前可以在哪里找到以及它位于哪个域的注释。
3. 节点下载其域中的公钥和地址列表，这些列表已由其他节点留在协调服务器上。
4. 节点使用适当的公钥集配置其 WireGuard 实例。

请注意，私钥永远不会离开其节点。这很重要，因为私钥是协商 WireGuard 会话时唯一可能用于模拟该节点的东西。因此，只有该节点可以加密发自其自身的数据包，或解密发往其自身的数据包。记住这一点很重要：Tailscale 节点连接是端到端加密的（称为“[零信任网络](https://tailscale.com/kb/1123/zero-trust)”的概念）。

与中心辐射型网络不同，未加密的数据包永远不需要通过线路发送，并且没有中介可以检查它们。 （例外情况是，如果您使用[子网路由](https://tailscale.com/kb/1019/subnets)，这对于 Tailscale 支持的增量部署非常有用。您可以创建一个混合网络，将新型网状连接与零个或多个解密数据包的旧式“集线器”相结合，然后转发它们连接到传统的物理网络。）

## 登录和双因素身份验证(2FA)

但我们忽略了一个细节。协调服务器如何知道哪些公钥应该发送到哪些节点？公钥就是公开的，因此泄露给任何人，甚至发布在公共网站上都是无害的。这与带有authorized_keys文件的ssh服务器的情况完全相同；你不必对你的 ssh 公钥保密，但你仍然必须小心在authorized_keys 中放入哪些公钥。

有多种方法可以做出认证决定。一个明显的方法是构建一个用户名+密码系统，也称为 PSK（预共享密钥）。要设置您的节点，请连接到服务器，输入您的用户名和密码，然后上传您的公钥并下载您的帐户或域中其他帐户发布的其他公钥。如果你想变得更花哨，你可以添加双因素身份验证（2FA，也称为 MFA），例如 SMS、Google Authenticator、Microsoft Authenticator 等。

Tailscale 围绕这些概念运行一个协调服务器。但是，我们自己不处理用户身份验证。相反，我们总是将身份验证外包给[OAuth2、OIDC (OpenID Connect) 或 SAML 提供商](https://tailscale.com/kb/1013/sso-providers)。流行的包括 Gmail、GSuite 和 Office365。

![2fa](http://img.golang.space/img-1729740678736.svg)

身份提供商维护域中的用户列表、密码、2FA 设置等。这样就无需为 VPN 维护一组单独的用户帐户或证书 - 您可以使用已设置用于 Google Docs、Office 365 和其他 Web 应用程序的身份验证。此外，由于您的所有私人用户帐户和登录数据都托管在另一项服务上，因此 Tailscale 能够运行高度可靠的中央协调服务，同时保留最少的用户个人身份信息 (PII)。 （请阅读我们的[隐私政策](https://tailscale.com/privacy-policy)了解更多信息。）

您也不必更改单点登录、帐户创建和删除、密码恢复和 2FA 设置的方式。这一切都和你已经拥有的一模一样。

正因为如此，Tailscale 域可以在您登录时立即激活。例如，如果您从 App Store 下载我们的 macOS 或 iOS 应用程序并登录到您的帐户，这会立即为您的域创建一个安全密钥保管箱，并允许您与该帐户或域中的其他设备交换公钥，例如Windows 或 Linux 服务器。

然后，正如我们刚才看到的，公钥被下载到每个节点，每个节点都为 WireGuard 配置一个到其他节点的超轻量级隧道，然后 ta da！两分钟内形成网状网络！

## NAT 穿越

……但我们还没有完全完成。回想一下上面的内容，我们决定假装每个节点都有一个静态 IP 地址和一个用于传入 WireGuard 流量的开放防火墙端口。在现实生活中，这不太可能。在现实生活中，你的一些节点在咖啡馆里、飞机上或高速公路上的 LTE 上，只有一格信号，电池耗尽，绝望地跨越州界逃离警察……哦，对不起，看错电影了。

无论如何，在最坏的情况下你所拥有的是这样的：

![remote access](http://img.golang.space/img-1729740935808.svg)

这是两个 NAT，没有开放端口。从历史上看，人们会要求您在防火墙上启用 uPnP，但这很少起作用，即使它确实起作用，通常也会[很危险](https://www.howtogeek.com/122487/htg-explains-is-upnp-a-security-risk/)，直到管理员将其关闭。

现在，只需说 Tailscale 使用了几种基于互联网[STUN](https://tools.ietf.org/html/rfc5389)和[ICE](https://tools.ietf.org/html/rfc8445)标准的非常先进的技术来使这些连接正常工作，即使您认为这是不可能的。这避免了防火墙配置或任何面向公众的开放端口的需要，从而大大减少了人为错误的可能性。

有关所有血淋淋的细节，请参阅我的队友 Dave Anderson 的帖子： [[How NAT traversal works](https://tailscale.com/blog/how-nat-traversal-works).](https://tailscale.com/blog/how-nat-traversal-works)。

## 加密 TCP 中继

还有一件事！一些特别残酷的网络完全阻止 UDP，或者在其他方面非常严格，以至于根本无法使用 STUN 和 ICE 穿越它们。针对这些情况，Tailscale 提供了所谓的 DERP（数据包指定加密中继）服务器网络。它们与 ICE 标准中的[TURN 服务器](https://tools.ietf.org/html/rfc5766)扮演相同的角色，只不过它们使用 HTTPS 流和 WireGuard 密钥而不是过时的 TURN 建议。

通过 DERP 进行中继如下所示：

![relay](http://img.golang.space/img-1729741183911.svg)

（不管上面看起来如何，我们确实拥有一个全球分布式中继服务器网络。这不仅仅是美国。用我们勇敢的设计师的话来说，“我希望将伦敦包括在内，但发现两个 SVG兼容的非墨卡托投影是一场灾难。”这就是我们对技术准确性的重视。此外，停止使用墨卡托投影是非常具有误导性的。）

请记住，Tailscale 私钥永远不会离开生成它们的节点；这意味着 DERP 服务器永远无法解密您的流量。它只是盲目地将已经加密的流量从一个节点转发到另一个节点。这就像互联网上的任何其他路由器一样，尽管使用了稍微更高级的协议来防止滥用。

网上很多人好奇WireGuard是否也像OpenVPN一样支持TCP。目前，WireGuard 本身并未内置此功能，但开源 Tailscale 节点软件包含 DERP 支持，从而添加了此功能。随着时间的推移，代码可能会被重构以在 WireGuard 本身中包含此功能。 （Tailscale 已经为 WireGuard-Go 提供了多项修复和改进。）我们还开源了[（非常简单的）DERP 中继服务器代码，](https://github.com/tailscale/tailscale/tree/main/derp)以便您可以准确地了解它的工作原理。

## 附加: ACL 和安全策略

人们通常将 VPN 视为“安全”软件。这种分类似乎很明显，因为 VPN 充满了密码学、公钥/私钥和证书。但 VPN 确实属于“连接”软件类别：它们增加了可以进入您的专用网络的设备数量。他们不会像安全软件那样减少它。

因此，VPN 集中器（记住上面的中心辐射模型）通常与防火墙结合使用；有时它们甚至一起出售。所有流量均来自各个客户端设备，流经 VPN 集中器，然后进入防火墙，防火墙根据 IP 地址应用访问控制，最后进入网络本身。

这种模式确实有效，但也可能会带来痛苦。首先，防火墙规则通常基于 IP 地址，而不是用户或角色，因此安全配置它们可能非常困难。因此，您最终必须在传输层或应用程序层添加更多层的身份验证。为什么需要 ssh 或 HTTPS？因为网络层太不安全，不值得信任。

其次，防火墙通常分散在组织各处，需要单独配置。如果您有一个多中心网络（例如，在不同地理位置有不同的 VPN 集中器），则必须确保在每个网络上正确配置防火墙，否则将面临安全漏洞的风险。

最后，配置某个特定供应商的 VPN/防火墙设备以根据其他供应商的身份系统验证 VPN 连接通常很麻烦。这就是为什么一些身份系统供应商会尝试向您出售VPN，而一些VPN供应商会尝试向您出售身份系统。

当你切换到网状网络时，这个问题似乎变得更糟——根本没有中心点，所以你甚至把防火墙规则放在哪里呢？在 Tailscale 中，答案是：在每个节点中。每个节点负责在解密时阻止不应允许的传入连接。

为了使这一过程变得更容易，您公司的安全策略存储在 Tailscale 协调服务器上，全部存储在一个位置，并自动分发到每个节点。通过这种方式，您可以集中控制策略，但可以高效、分布式执行。

![acl](http://img.golang.space/img-1729741413633.svg)

在不太细粒度的级别上，协调服务器（密钥保管箱）通过仅向每个节点提供应该连接到它的节点的公钥来保护节点。其他互联网计算机甚至无法请求连接，因为列表中没有正确的公钥，它们的加密数据包无法解码。就好像未经授权的机器根本不存在一样。这是一个非常强大的保护模型；它几乎可以防止任何类型的协议级攻击。因此，Tailscale 特别擅长保护不再维护或接收更新的遗留、非基于 Web 的服务。

## 附加: 审查日志

具有严格合规要求的公司的另一个担忧是审计跟踪。现代防火墙不仅会阻止流量，还会记录流量。由于 Tailscale 没有中央流量渠道，您能做什么？

答案是：我们允许您将每个节点的所有内部网络连接异步记录到中央日志记录服务。这种设计的一个有趣的副作用是每个连接都会被记录两次：在源计算机上和目标计算机上。因此，日志篡改很容易检测到，因为它需要在两个不同的节点上同时篡改。

由于日志是从各个节点实时流式传输的，而不是批量的，因此节点本地日志篡改的窗口极短，约为几十毫秒，即使是单节点的篡改攻击也很难实现。

Tailscale 的中央日志服务具有可控的保留期，每个节点仅记录一些有关内部网格如何建立的元数据，而不是互联网使用或个人信息。 （请阅读我们的[隐私政策](https://tailscale.com/privacy-policy)了解更多信息。）

Tailscale 日志记录服务不是提供完整的日志和指标管道，而是作为实时流数据收集器，然后可以将数据流式传输到其他系统以进行进一步分析。 （您可以[阅读我早期的博客文章，该文章演变成 Tailscale 的日志收集器架构](https://apenwarr.ca/log/20190216)。）

## 附加: 增量部署

最后一个问题经常出现：鉴于 Tailscale 创建了一个网状“覆盖”网络（与公司内部物理网络并行的 VPN），公司是否必须立即全部切换到该网络？许多 BeyondCorp 和零信任风格的产品都是这样工作的。或者可以从一个小的概念验证开始逐步部署吗？

Tailscale 非常适合增量部署。由于您根本不需要安装任何硬件或任何服务器，因此您可以在两分钟内开始使用：只需将 Tailscale 节点软件安装到两台设备（Linux、Windows、macOS、iOS）上，使用相同的密码登录两台设备即可用户帐户或身份验证域，就是这样！无论设备如何移动，它们都会安全连接。 Tailscale 在您现有的网络之上运行，因此您可以安全地部署它，而无需中断现有的基础设施和安全设置。

然后，您可以通过添加到一个或多个办公室或数据中心的[子网路](https://tailscale.com/kb/1019/subnets)由来扩展网络，构建传统的中心辐射型或多中心 VPN。

当您获得信心后，您可以在更多服务器或容器上安装 Tailscale，这允许点对点完全加密的连接（任何 LAN 上都不会传输未加密的流量）。最终的配置称为“[零信任网络](https://www.amazon.com/dp/B072WD347M/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)”，它最近越来越出名，但到目前为止还很难实现。

借助 Tailscale，您可以建立“零信任”，一次一台员工设备和一台服务器。增量部署完成后，您可以安全地关闭旧的或未加密的访问方法。

感谢我们勇敢的设计师[Ross Zurowski](https://rosszurowski.com/)为我们绘制的插图:)







## 参考

本文翻译于 [How Tailscale works](https://tailscale.com/blog/how-tailscale-works)