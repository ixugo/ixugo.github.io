[{"content":"åœ¨ linux ä¸­ï¼Œçˆ¶è¿›ç¨‹åˆ›å»ºäº†å­è¿›ç¨‹ï¼Œä¾‹å¦‚ exec.Command() å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå­å‘½ä»¤ã€‚å½“çˆ¶è¿›ç¨‹å› ä¸ºæ„å¤–å´©æºƒé€€å‡ºï¼Œæ²¡æ¥å¾—åŠæ§åˆ¶å­è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ­¤æ—¶å­è¿›ç¨‹æˆä¸ºå­¤å„¿è¿›ç¨‹ç»§ç»­è¿è¡Œã€‚\næœ¬æ–‡è°ƒç ”çš„å†…å®¹æ˜¯æ§åˆ¶å½“çˆ¶è¿›ç¨‹å› ä¸ºä»»ä½•åŸå› é€€å‡ºæ—¶ï¼Œå­è¿›ç¨‹å¿…é¡»ç«‹å³ç»“æŸã€‚\nè¿›ç¨‹ç»„ è¿›ç¨‹ç»„ç¡®å®æ˜¯ä¸€ç»„ç›¸å…³è¿›ç¨‹çš„é›†åˆï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å”¯ä¸€çš„è¿›ç¨‹ IDï¼ˆpidï¼‰ï¼ŒåŒæ—¶å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œè¿›ç¨‹ç»„æœ‰å”¯ä¸€çš„è¿›ç¨‹ç»„ IDï¼ˆpgidï¼‰ã€‚é€šå¸¸ï¼Œè¿›ç¨‹ç»„ç”±ä¸€ä¸ª â€œé¢†å¤´è¿›ç¨‹â€ åˆ›å»ºï¼Œå…¶pidä¼šæˆä¸ºè¯¥è¿›ç¨‹ç»„çš„pgidã€‚\nå½“ kill å‘½ä»¤çš„å‚æ•°æ˜¯ pgid æ—¶ï¼Œkill ä¼šå‘è¿›ç¨‹ç»„å†…çš„æ‰€æœ‰è¿›ç¨‹å‘é€ä¿¡å·ï¼Œè¿›ç¨‹å¯ä»¥æ•è·æˆ–å¿½ç•¥ä¿¡å·(SIGTERM)ã€‚\nè¿›ç¨‹ç»„ä»…æ”¯æŒ linuxï¼Œwindows æ˜¯æ²¡æœ‰è¿›ç¨‹ç»„çš„æ¦‚å¿µ ä¸»è¿›ç¨‹å´©æºƒï¼Œå­è¿›ç¨‹è¿˜æ˜¯ä¼šæˆä¸ºå­¤å„¿è¿›ç¨‹è¿è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 import ( \u0026#34;fmt\u0026#34; \u0026#34;os/exec\u0026#34; \u0026#34;syscall\u0026#34; ) func main() { // åˆ›å»ºä¸€ä¸ªå‘½ä»¤ cmd := exec.Command(\u0026#34;sleep\u0026#34;, \u0026#34;1000\u0026#34;) // ç¤ºä¾‹å‘½ä»¤ï¼Œè®©è¿›ç¨‹ä¼‘çœ  1000 ç§’ // è®¾ç½® SysProcAttr ä»¥åˆ›å»ºæ–°è¿›ç¨‹ç»„ cmd.SysProcAttr = \u0026amp;syscall.SysProcAttr{ Setpgid: true, // åˆ›å»ºæ–°è¿›ç¨‹ç»„ Pgid: 0, // 0 è¡¨ç¤ºä½¿ç”¨å­è¿›ç¨‹çš„ PID ä½œä¸ºè¿›ç¨‹ç»„ ID } // å¯åŠ¨å‘½ä»¤ if err := cmd.Start(); err != nil { fmt.Printf(\u0026#34;å¯åŠ¨è¿›ç¨‹å¤±è´¥: %v\\n\u0026#34;, err) return } // è·å–è¿›ç¨‹ç»„ IDï¼ˆç­‰äºå­è¿›ç¨‹çš„ PIDï¼‰ pgid := -cmd.Process.Pid // åœ¨ Linux ä¸­ï¼Œè´Ÿ PID è¡¨ç¤ºè¿›ç¨‹ç»„ fmt.Printf(\u0026#34;å­è¿›ç¨‹ PID: %d\\n\u0026#34;, cmd.Process.Pid) fmt.Printf(\u0026#34;è¿›ç¨‹ç»„ ID: %d\\n\u0026#34;, pgid) // å‘è¿›ç¨‹ç»„å‘é€ä¿¡å·ï¼ˆä¾‹å¦‚ SIGTERMï¼‰ if err := syscall.Kill(pgid, syscall.SIGTERM); err != nil { fmt.Printf(\u0026#34;å‘é€ä¿¡å·å¤±è´¥: %v\\n\u0026#34;, err) return } fmt.Println(\u0026#34;å·²å‘è¿›ç¨‹ç»„å‘é€ç»ˆæ­¢ä¿¡å·\u0026#34;) // ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæˆ if err := cmd.Wait(); err != nil { fmt.Printf(\u0026#34;å‘½ä»¤æ‰§è¡Œå®Œæˆ: %v\\n\u0026#34;, err) } } å°è¯•è§£å†³æ–¹æ¡ˆ å¼‚æ­¥ç›‘å¬æ ‡å‡†è¾“å…¥ 1 2 3 4 5 6 7 8 9 10 // interrupt ç”¨äºé˜»å¡ interrupt := make(chan os.Signal, 1) signal.Notify(interrupt, syscall.SIGINT, syscall.SIGTERM) go func() { _, err := io.Copy(io.Discard, os.Stdin) // æŒç»­è¯»å–æ ‡å‡†è¾“å…¥ï¼ˆä½†ä¸¢å¼ƒæ•°æ®ï¼‰ slog.Info(\u0026#34;main -\u0026gt; Copy\u0026#34;, \u0026#34;err\u0026#34;, err) // è®°å½•è¯»å–ç»“æŸæ—¶çš„é”™è¯¯ï¼ˆå¦‚ EOFï¼‰ interrupt \u0026lt;- syscall.SIGTERM // å‘é€ç»ˆæ­¢ä¿¡å· }() \u0026lt;- interrupt çˆ¶è¿›ç¨‹é€šè¿‡ exec.Command() å¯åŠ¨å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹æŒç»­ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®ï¼Œå¹¶ç›´æ¥ä¸¢å¼ƒã€‚å¦‚æœè¾“å…¥æµå…³é—­(ç»ˆç«¯å…³é—­ï¼Œç®¡é“æ–­å¼€ç­‰)ï¼Œ io.Copy ä¼šç«‹å³ç»“æŸï¼Œå¹¶å‘é€ç»ˆæ­¢ä¿¡å·ã€‚\né€šè¿‡ç›‘å¬æ ‡å‡†è¾“å…¥çš„å…³é—­äº‹ä»¶ï¼Œè§¦å‘ç¨‹åºçš„ä¼˜é›…é€€å‡ºæœºåˆ¶ã€‚\nä½†å¦‚æœæ˜¯ä»¥æœåŠ¡æ–¹å¼å¯åŠ¨ï¼Œå­è¿›ç¨‹ä¼šç«‹å³é€€å‡ºï¼ŒæœåŠ¡ç®¡ç†å™¨é€šè¿‡ä¼šå°†æ ‡å‡†è¾“å…¥è®¾ç½®ä¸ºç©ºè®¾å¤‡ (/dev/null) æˆ–ç›´æ¥å…³é—­ï¼Œå¯¼è‡´å­è¿›ç¨‹çš„ os.Stdin åœ¨å¯åŠ¨æ—¶å·²ç»å¤„äº EOF çŠ¶æ€ã€‚\n1 2 3 4 5 6 7 8 // åˆ¤æ–­æ˜¯å¦åœ¨æœåŠ¡æ¨¡å¼ä¸‹è¿è¡Œï¼ˆstdin æŒ‡å‘ /dev/null æˆ–å·²å…³é—­ï¼‰ func isServiceMode() bool { info, err := os.Stdin.Stat() if err != nil { return true // æ— æ³•è·å–çŠ¶æ€ï¼Œå‡è®¾ä¸ºæœåŠ¡æ¨¡å¼ } return info.Mode()\u0026amp;os.ModeCharDevice == 0 // éç»ˆç«¯è®¾å¤‡ï¼ˆå¦‚ /dev/nullï¼‰ } æ—¢ç„¶å¯ä»¥ç›‘å¬æ ‡å‡†è¾“å…¥çš„æ–¹å¼åˆ¤æ–­çˆ¶è¿›ç¨‹æ˜¯å¦å­˜æ´»ï¼Œé‚£ä¹ˆé€šè¿‡è¿›ç¨‹é€šä¿¡ç®¡é“å‘¢?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 package main import ( \u0026#34;bytes\u0026#34; \u0026#34;log/slog\u0026#34; \u0026#34;os\u0026#34; \u0026#34;os/exec\u0026#34; \u0026#34;os/signal\u0026#34; \u0026#34;syscall\u0026#34; \u0026#34;time\u0026#34; ) func main() { // åˆ›å»ºç”¨äºé€šä¿¡çš„ç®¡é“ r, w, err := os.Pipe() if err != nil { slog.Error(\u0026#34;åˆ›å»ºç®¡é“å¤±è´¥\u0026#34;, \u0026#34;err\u0026#34;, err) return } defer w.Close() // å¯åŠ¨å­è¿›ç¨‹ï¼Œå¹¶å°†ç®¡é“å†™å…¥ç«¯ä¼ é€’ç»™å­è¿›ç¨‹ cmd := exec.Command(\u0026#34;./child\u0026#34;) // å‡è®¾å­è¿›ç¨‹ç¨‹åºåä¸º child cmd.Stdin = r // å­è¿›ç¨‹ä»ç®¡é“è¯»å–æ•°æ® cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr // å¯åŠ¨å­è¿›ç¨‹ if err := cmd.Start(); err != nil { slog.Error(\u0026#34;å¯åŠ¨å­è¿›ç¨‹å¤±è´¥\u0026#34;, \u0026#34;err\u0026#34;, err) return } slog.Info(\u0026#34;å­è¿›ç¨‹å·²å¯åŠ¨\u0026#34;, \u0026#34;pid\u0026#34;, cmd.Process.Pid) // çˆ¶è¿›ç¨‹å®šæœŸå‘ç®¡é“å†™å…¥æ•°æ®ï¼ˆå¿ƒè·³ï¼‰ go func() { ticker := time.NewTicker(time.Second) defer ticker.Stop() for range ticker.C { _, err := w.Write([]byte(\u0026#34;heartbeat\\n\u0026#34;)) if err != nil { slog.Warn(\u0026#34;å†™å…¥ç®¡é“å¤±è´¥ï¼Œå­è¿›ç¨‹å¯èƒ½å·²é€€å‡º\u0026#34;, \u0026#34;err\u0026#34;, err) break } } }() // å¤„ç†çˆ¶è¿›ç¨‹é€€å‡ºä¿¡å· sigCh := make(chan os.Signal, 1) signal.Notify(sigCh, syscall.SIGINT, syscall.SIGTERM) \u0026lt;-sigCh slog.Info(\u0026#34;çˆ¶è¿›ç¨‹æ­£åœ¨é€€å‡º...\u0026#34;) w.Close() // å…³é—­ç®¡é“ï¼Œé€šçŸ¥å­è¿›ç¨‹ // ç­‰å¾…å­è¿›ç¨‹é€€å‡º if err := cmd.Wait(); err != nil { slog.Error(\u0026#34;ç­‰å¾…å­è¿›ç¨‹å¤±è´¥\u0026#34;, \u0026#34;err\u0026#34;, err) } slog.Info(\u0026#34;çˆ¶è¿›ç¨‹å·²é€€å‡º\u0026#34;) } å­è¿›ç¨‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 package main import ( \u0026#34;io\u0026#34; \u0026#34;log/slog\u0026#34; \u0026#34;os\u0026#34; \u0026#34;os/signal\u0026#34; \u0026#34;syscall\u0026#34; \u0026#34;time\u0026#34; ) func main() { interrupt := make(chan os.Signal, 1) signal.Notify(interrupt, syscall.SIGTERM, syscall.SIGINT) // è·å–çˆ¶è¿›ç¨‹ PID parentPID := os.Getppid() slog.Info(\u0026#34;çˆ¶è¿›ç¨‹ PID\u0026#34;, \u0026#34;pid\u0026#34;, parentPID) // ç›‘å¬ç®¡é“å…³é—­äº‹ä»¶ï¼ˆçˆ¶è¿›ç¨‹å´©æºƒæˆ–æ­£å¸¸é€€å‡ºï¼‰ go func() { // ä» stdin è¯»å–æ•°æ®ï¼ˆå®é™…è¿æ¥åˆ°çˆ¶è¿›ç¨‹åˆ›å»ºçš„ç®¡é“ï¼‰ _, err := io.Copy(io.Discard, os.Stdin) if err != nil { slog.Info(\u0026#34;ç®¡é“å…³é—­\u0026#34;, \u0026#34;err\u0026#34;, err) } else { slog.Info(\u0026#34;ç®¡é“æ­£å¸¸å…³é—­\u0026#34;) } interrupt \u0026lt;- syscall.SIGTERM // è§¦å‘ä¼˜é›…é€€å‡º }() // å®šæœŸæ£€æŸ¥çˆ¶è¿›ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆåŒé‡ä¿é™©ï¼‰ go func() { ticker := time.NewTicker(2 * time.Second) defer ticker.Stop() for range ticker.C { // å°è¯•å‘çˆ¶è¿›ç¨‹å‘é€ 0 ä¿¡å·ï¼ˆä»…æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼‰ err := syscall.Kill(parentPID, 0) if err != nil { slog.Info(\u0026#34;çˆ¶è¿›ç¨‹å·²é€€å‡º\u0026#34;, \u0026#34;err\u0026#34;, err) interrupt \u0026lt;- syscall.SIGTERM // è§¦å‘ä¼˜é›…é€€å‡º break } } }() slog.Info(\u0026#34;å­è¿›ç¨‹è¿è¡Œä¸­...\u0026#34;) \u0026lt;-interrupt // é˜»å¡ç›´åˆ°æ”¶åˆ°é€€å‡ºä¿¡å· slog.Info(\u0026#34;å­è¿›ç¨‹ä¼˜é›…é€€å‡º\u0026#34;) } æ€»ç»“ ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ¡ˆ\nå­è¿›ç¨‹å®šæœŸæ£€æµ‹çˆ¶è¿›ç¨‹æ˜¯å¦å­˜æ´»ï¼Œå¯ä»¥ç›‘å¬å›ºå®šç«¯å£ä¹Ÿå¥½ï¼Œpid çŠ¶æ€ä¹Ÿå¥½ï¼Œç½‘ç»œé€šä¿¡ä¹Ÿå¥½ã€‚(å­è¿›ç¨‹è·Ÿéšçˆ¶è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ) çˆ¶è¿›ç¨‹å¯åŠ¨å­è¿›ç¨‹æ—¶ï¼Œè®°å½•å­è¿›ç¨‹çš„ idï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶ï¼Œæ ¹æ®éœ€è¦å†åœæ­¢å­è¿›ç¨‹æˆ–ç»§ç»­å¤ç”¨å­è¿›ç¨‹ã€‚(å…è®¸å­è¿›ç¨‹å­˜æ´»ï¼Œå¹¶åœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶æ¥ç®¡) ","date":"2025-07-14T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%AD%90%E8%BF%9B%E7%A8%8B%E9%9A%8F%E7%9D%80%E7%88%B6%E8%BF%9B%E7%A8%8B%E5%85%B3%E9%97%AD%E8%B0%83%E7%A0%94/","title":"å­è¿›ç¨‹éšç€çˆ¶è¿›ç¨‹å…³é—­è°ƒç ”"},{"content":"æˆ‘è´¹äº†å¥½å¤§åŠ²æ‰å¼„æ¸…æ¥šï¼Œä¸ºä»€ä¹ˆè¿™æ ·ä¸€ä¸ªçœ‹ä¼¼æ— å…³ç´§è¦çš„å˜åŒ–ä¼šå¯¼è‡´å¦‚æ­¤å·¨å¤§çš„æ€§èƒ½å·®å¼‚ã€‚æœ€ç»ˆï¼Œæœ€æœ‰å¸®åŠ©çš„æ˜¯ Go å·¥å…·é“¾ä¸­ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…·ï¼šä½¿ç”¨ -base é€‰é¡¹å¯è§†åŒ–ä¸¤ä¸ªæ€§èƒ½é…ç½®æ–‡ä»¶ä¹‹é—´çš„å·®å¼‚ï¼Œ pprof ã€‚\nä½¿ç”¨ pprof è·å–ä¸¤ä¸ªé…ç½®æ–‡ä»¶çš„å·®å¼‚ Go è¯­è¨€è‡ªå¸¦ä¸€ä¸ªå¼ºå¤§çš„æ€§èƒ½åˆ†æå·¥å…· pprof ã€‚ä¸å…¶ä»–ä¸€äº›è¯­è¨€ä¸åŒï¼Œæ‚¨å¿…é¡»åœ¨ä»£ç ä¸­æ˜¾å¼å¯ç”¨å®ƒæ‰èƒ½è·å–æ€§èƒ½åˆ†æç»“æœï¼›æ‚¨æ— æ³•äº‹åæˆ–ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°å¯ç”¨å®ƒã€‚è¿™å¾ˆç®€å•ï¼Œä½†æ‚¨å¿…é¡»ç¼–å†™ä»£ç æ‰èƒ½å®ç°ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘å°†å…¶ç›´æ¥æ”¾åœ¨è¦åˆ†æçš„æµ‹è¯•æ–¹æ³•ä¸­ã€‚\n1 2 3 4 5 6 7 8 func TestRegressionTests(t *testing.T) { // We\u0026#39;ll only run this on GitHub Actions, so set this environment variable to run locally if _, ok := os.LookupEnv(\u0026#34;REGRESSION_TESTING\u0026#34;); !ok { // t.Skip() } p := profile.Start(profile.CPUProfile) defer p.Stop() æ­¤ä»£ç ç‰‡æ®µçš„æœ€åä¸¤è¡Œå¯åŠ¨ CPU æ€§èƒ½åˆ†æï¼Œå¹¶åœ¨æ–¹æ³•å®Œæˆæ—¶åœæ­¢ã€‚å®ƒä½¿ç”¨äº† github.com/pkg/profile åŒ…ï¼Œè¯¥åŒ…ä¸ºå†…ç½®æ€§èƒ½åˆ†æå™¨åº“æä¾›äº†ä¸€ä¸ªæ›´ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„åŒ…è£…å™¨ã€‚è¿è¡Œæ‰§è¡Œæ­¤æ“ä½œçš„ä»£ç ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š\n1 2025/06/20 14:10:40.548730 profile: cpu profiling disabled, C:\\Users\\ZACHMU~1\\AppData\\Local\\Temp\\profile1113350212\\cpu.pprof è¿™æ˜¯è¿è¡Œç”Ÿæˆçš„é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œæ‚¨åº”è¯¥è®°ä¸‹å®ƒæˆ–å°†å…¶å¤åˆ¶åˆ°å…·æœ‰æ›´å®¹æ˜“è®°ä½çš„åç§°çš„å…¶ä»–ä½ç½®ã€‚\nä¸ºäº†æµ‹è¯•ï¼Œæˆ‘æƒ³çœ‹çœ‹ main åˆ†æ”¯å’Œå½“å‰åˆ†æ”¯ä¹‹é—´çš„æ€§èƒ½å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘åœ¨æ¯ä¸ªåˆ†æ”¯ä¸Šéƒ½å¯ç”¨äº†æ€§èƒ½åˆ†æåŠŸèƒ½ï¼Œå¹¶è¿›è¡Œäº†æµ‹è¯•ã€‚ç°åœ¨ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ -base å‚æ•°å’Œ pprof æ¥æ¯”è¾ƒå®ƒä»¬ã€‚\næ£€æŸ¥æ€§èƒ½å·®å¼‚ è·å¾—æ¯ä¸ªåˆ†æ”¯çš„æ¦‚å†µåï¼Œç°åœ¨æˆ‘åªéœ€è¦å¯¹å®ƒä»¬è¿›è¡Œæ¯”è¾ƒã€‚\n1 go tool pprof -http=:8090 -base main.pprof branch.pprof -base æ ‡å¿—å‘Šè¯‰ pprof åœ¨æŠ¥å‘Šæ€§èƒ½æ•°æ®æ—¶ï¼Œä»å¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­â€œå‡å»â€æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘æƒ³æŸ¥çœ‹ branch.pprof ä¸­å‘ç”Ÿçš„æƒ…å†µï¼Œè€Œä¸æ˜¯ main.pprof è¿è¡Œå¤ªæ…¢äº†ã€‚æˆ‘è¿˜ä¸€ç›´ä½¿ç”¨ -http å‚æ•°ï¼Œå®ƒä¼šè¿è¡Œä¸€ä¸ªäº¤äº’å¼ Web æœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯å‘½ä»¤è¡Œç•Œé¢ã€‚æˆ‘å‘ç°åœ¨åˆ†ææ€§èƒ½é…ç½®æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªå‚æ•°è¦æ–¹ä¾¿å¾—å¤šã€‚\nå½“æˆ‘è¿è¡Œè¯¥å‘½ä»¤æ—¶ï¼Œæˆ‘çš„ Web æµè§ˆå™¨ä¼šå¯åŠ¨åˆ°é»˜è®¤æ˜¾ç¤ºç•Œé¢ï¼Œå³ä¸€å¼ æŒ‰å‡½æ•°å¤§è‡´æ‹“æ‰‘æ’åºçš„ç´¯è®¡ CPU é‡‡æ ·å›¾ï¼Œè¿™æ ·ä½ å°±å¯ä»¥çœ‹åˆ°å“ªäº›å‡½æ•°è°ƒç”¨äº†å“ªäº›å‡½æ•°ã€‚ä¸æ™®é€šçš„é…ç½®æ–‡ä»¶åˆ†æä¸åŒï¼Œè¿™é‡Œæ˜¾ç¤ºçš„æ•°å­—ä¸¥æ ¼æ¥è¯´æ˜¯ä¸¤ä¸ªé…ç½®æ–‡ä»¶ä¹‹é—´çš„å·®å¼‚ï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„ç»å¯¹è¿è¡Œæ—¶é—´ã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨ Web è§†å›¾ä¸­çœ‹åˆ°çš„å†…å®¹ï¼š\nDatabase.tableInsensitive å‡½æ•°ç”¨äºè·å–æŸ¥è¯¢å¼•æ“ä½¿ç”¨çš„è¡¨å¯¹è±¡ã€‚ä¸çŸ¥ä½•æ•…ï¼Œå°½ç®¡æˆ‘æ²¡æœ‰ç›´æ¥ä¿®æ”¹å®ƒï¼Œä½†æˆ‘çš„ä¿®æ”¹å´ä½¿è¿™ä¸ªå‡½æ•°å˜å¾—éå¸¸éå¸¸æ…¢ã€‚æœ‰äº†è¿™ä¸ªçº¿ç´¢ï¼Œæˆ‘æ‰¾åˆ°äº†æ€§èƒ½é—®é¢˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // from tableInsensitive() ... tableNames, err := db.getAllTableNames(ctx, root, true) if err != nil { return doltdb.TableName{}, nil, false, err } if root.TableListHash() != 0 { tableMap := make(map[string]string) for _, table := range tableNames { tableMap[strings.ToLower(table)] = table } dbState.SessionCache().CacheTableNameMap(root.TableListHash(), tableMap) } tableName, ok = sql.GetTableNameInsensitive(tableName, tableNames) if !ok { return doltdb.TableName{}, nil, false, nil } å¦‚æœæ‰€æœ‰è¡¨åå°šæœªç¼“å­˜åœ¨ä¼šè¯ä¸­ï¼Œåˆ™ä»£ç ç‰‡æ®µçš„ç¬¬ä¸€è¡Œä¼šä»æ•°æ®åº“ä¸­åŠ è½½å®ƒä»¬ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„è¡¨åå­˜å‚¨æ—¶åŒºåˆ†å¤§å°å†™ï¼Œè€Œ SQL ä¸åŒºåˆ†å¤§å°å†™ã€‚å› æ­¤ï¼Œåœ¨ä»æ•°æ®åº“åŠ è½½è¡¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†æŸ¥è¯¢ä¸­è¯·æ±‚çš„ä¸åŒºåˆ†å¤§å°å†™çš„åç§°æ›´æ­£ä¸ºåŒºåˆ†å¤§å°å†™çš„åç§°ï¼Œä»¥ä¾¿åœ¨å­˜å‚¨å’Œ I/O å±‚ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œå¯¹ db.getAllTableNames() çš„è°ƒç”¨åŒ…å«ä¸€ä¸ªæœ€ç»ˆå‚æ•°ï¼š includeGeneratedSystemTables ã€‚å®ƒè¢«ç¡¬ç¼–ç ä¸º trueï¼Œè¿™æ„å‘³ç€å®ƒæ€»æ˜¯è°ƒç”¨æ–°çš„ã€æ›´æ˜‚è´µçš„æ–¹æ³•æ¥è·å–ç”Ÿæˆçš„ç³»ç»Ÿè¡¨çš„åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…æ‹¬æ½œåœ¨çš„ç£ç›˜è®¿é—®ä»¥è·å–æ•°æ®åº“æ¨¡å¼é›†ï¼Œç„¶åå¯¹å®ƒä»¬è¿›è¡Œå¤§é‡çš„è¿­ä»£ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 schemas, err := root.GetDatabaseSchemas(ctx) if err != nil { return nil, err } // For dolt there are no stored schemas, search the default (empty string) schema if len(schemas) == 0 { schemas = append(schemas, schema.DatabaseSchema{Name: doltdb.DefaultSchemaName}) } for _, schema := range schemas { tableNames, err := root.GetTableNames(ctx, schema.Name) if err != nil { return nil, err } for _, pre := range doltdb.GeneratedSystemTablePrefixes { for _, tableName := range tableNames { s.Add(doltdb.TableName{ Name: pre + tableName, Schema: schema.Name, }) } } // For doltgres, we also support the legacy dolt_ table names, addressable in any user schema if UseSearchPath \u0026amp;\u0026amp; schema.Name != \u0026#34;pg_catalog\u0026#34; \u0026amp;\u0026amp; schema.Name != doltdb.DoltNamespace { for _, name := range doltdb.DoltGeneratedTableNames { s.Add(doltdb.TableName{ Name: name, Schema: schema.Name, }) } } } äº‹å®è¯æ˜ï¼Œç¡¬ç¼–ç çš„ true å®Œå…¨æ˜¯é”™è¯¯çš„â€”â€”è¯¥æ–¹æ³•æ ¹æœ¬ä¸éœ€è¦è€ƒè™‘ç³»ç»Ÿç”Ÿæˆçš„è¡¨åã€‚ä½†åœ¨æˆ‘è®©ç”Ÿæˆè¿™äº›åç§°çš„è¿‡ç¨‹å˜å¾—æ›´åŠ æ˜‚è´µä¹‹å‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æ— å®³çš„é”™è¯¯ï¼Œå¹¶ä¸”å¤šå¹´æ¥ä¸€ç›´å­˜åœ¨äºä»£ç ä¸­è€Œæœªè¢«æ³¨æ„åˆ°ã€‚å°†æ­¤å€¼æ›´æ”¹ä¸º false ä»¥æ¶ˆé™¤ä¸å¿…è¦çš„å·¥ä½œï¼Œä¿®å¤äº†æ€§èƒ½å›å½’é—®é¢˜ï¼Œå¹¶ä¸”è¿˜ç¨å¾®åŠ å¿«äº† Dolt çš„åŸºå‡†æµ‹è¯•é€Ÿåº¦ã€‚\nread_tests è¯»å–æµ‹è¯• from_latency to_latency å»¶è¿Ÿ percent_change ç™¾åˆ†æ¯”å˜åŒ– covering_index_scan è¦†ç›–ç´¢å¼•æ‰«æ 0.68 0.67 -1.4 groupby_scan 19.65 19.29 -1.83 index_join ç´¢å¼•è¿æ¥ 2.57 2.52 -1.95 index_join_scan ç´¢å¼•è¿æ¥æ‰«æ 1.44 1.44 0.0 index_scan ç´¢å¼•æ‰«æ 30.26 29.72 -1.78 oltp_point_select 0.29 0.28 -3.45 oltp_read_only 5.37 5.28 -1.68 select_random_points é€‰æ‹©éšæœºç‚¹ 0.61 0.6 -1.64 select_random_ranges é€‰æ‹©éšæœºèŒƒå›´ 0.64 0.62 -3.13 table_scan è¡¨æ‰«æ 32.53 31.94 -1.81 types_table_scan ç±»å‹è¡¨æ‰«æ 127.81 125.52 -1.79 å¦‚æœæ²¡æœ‰ -base æ ‡å¿—ä¸ºæˆ‘æŒ‡æ˜æ­£ç¡®çš„æ–¹å‘ï¼Œæˆ‘ä¸ç¡®å®šæˆ‘æ˜¯å¦èƒ½æ‰¾å‡ºè¿™ç§ä½æ•ˆç‡çš„æ ¹æºã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Finding performance problems by diffing two Go profiles\n","date":"2025-06-30T00:00:00Z","permalink":"https://blog.golang.space/p/%E6%AF%94%E8%BE%83%E4%B8%A4%E4%B8%AA-go-pprof-%E6%96%87%E4%BB%B6%E6%9D%A5%E6%9F%A5%E6%89%BE%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98/","title":"æ¯”è¾ƒä¸¤ä¸ª go pprof æ–‡ä»¶æ¥æŸ¥æ‰¾æ€§èƒ½é—®é¢˜"},{"content":"Go 1.25 ä¸­ json åŒ…çš„ v2 ç‰ˆæœ¬æ˜¯ä¸€ä¸ªé‡å¤§æ›´æ–°ï¼Œå®ƒæœ‰å¾ˆå¤šçªç ´æ€§çš„å˜åŒ–ã€‚v2 åŒ…æ·»åŠ äº†æ–°åŠŸèƒ½ï¼Œä¿®å¤äº† API é—®é¢˜å’Œè¡Œä¸ºç¼ºé™·ï¼Œå¹¶æé«˜äº†æ€§èƒ½ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼\nMarshal å’Œ Unmarshal çš„åŸºæœ¬ç”¨ä¾‹ä¿æŒä¸å˜ã€‚æ­¤ä»£ç é€‚ç”¨äº v1 å’Œ v2ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 type Person struct { Name string Age int } alice := Person{Name: \u0026#34;Alice\u0026#34;, Age: 25} // Marshal Alice. b, err := json.Marshal(alice) fmt.Println(string(b), err) // Unmarshal Alice. err = json.Unmarshal(b, \u0026amp;alice) fmt.Println(alice, err) ä½†å…¶ä½™çš„åˆ™å¤§ä¸ç›¸åŒã€‚\nMarshalWrite and UnmarshalRead åœ¨ v1 ä¸­ï¼Œæ˜¯è¿™æ ·çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 // Marshal Alice. alice := Person{Name: \u0026#34;Alice\u0026#34;, Age: 25} out := new(strings.Builder) // io.Writer enc := json.NewEncoder(out) enc.Encode(alice) fmt.Println(out.String()) // Unmarshal Bob. in := strings.NewReader(`{\u0026#34;Name\u0026#34;:\u0026#34;Bob\u0026#34;,\u0026#34;Age\u0026#34;:30}`) // io.Reader dec := json.NewDecoder(in) var bob Person dec.Decode(\u0026amp;bob) fmt.Println(bob) åœ¨ v2 ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ MarshalWrite å’Œ UnmarshalReadï¼Œæ— éœ€ä»»ä½•ä¸­ä»‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // Marshal Alice. alice := Person{Name: \u0026#34;Alice\u0026#34;, Age: 25} out := new(strings.Builder) json.MarshalWrite(out, alice) fmt.Println(out.String()) // Unmarshal Bob. in := strings.NewReader(`{\u0026#34;Name\u0026#34;:\u0026#34;Bob\u0026#34;,\u0026#34;Age\u0026#34;:30}`) var bob Person json.UnmarshalRead(in, \u0026amp;bob) fmt.Println(bob) ä¸è¿‡ï¼Œå®ƒä»¬ä¸èƒ½äº’æ¢ï¼š\nä¸æ—§çš„ Encoder.Encode ä¸åŒï¼ŒMarshalWrite ä¸æ·»åŠ æ¢è¡Œç¬¦ã€‚ UnmarshalRead ä¼šè¯»å–è¯»å–å™¨ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œç›´åˆ°å®ƒåˆ°è¾¾ ioã€‚EOFï¼Œè€Œæ—§çš„ Decoder.Decode ä»…è¯»å–ä¸‹ä¸€ä¸ª JSON å€¼ã€‚ MarshalEncode and UnmarshalDecode Encoder å’Œ Decoder ç±»å‹å·²ç§»è‡³æ–°çš„ jsontext åŒ…ä¸­ï¼Œå®ƒä»¬çš„æ¥å£å·²å‘ç”Ÿé‡å¤§å˜åŒ–ï¼ˆä»¥æ”¯æŒä½çº§æµå¼ç¼–ç /è§£ç ä½œï¼‰ã€‚\nä½ å¯ä»¥å°†å®ƒä»¬ä¸ json å‡½æ•°ä¸€èµ·ä½¿ç”¨æ¥è¯»å–å’Œå†™å…¥ JSON æµï¼Œç±»ä¼¼äºä¹‹å‰ Encode å’Œ Decode çš„å·¥ä½œæ–¹å¼ï¼š\nv1 Encoder.Encode â†’ v2 json.MarshalEncode + jsontext.Encoder. v1 Decoder.Decode â†’ v2 json.UnmarshalDecode + jsontext.Decoder. æµå¼å¤„ç†ç¼–ç å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 people := []Person{ {Name: \u0026#34;Alice\u0026#34;, Age: 25}, {Name: \u0026#34;Bob\u0026#34;, Age: 30}, {Name: \u0026#34;Cindy\u0026#34;, Age: 15}, } out := new(strings.Builder) enc := jsontext.NewEncoder(out) for _, p := range people { json.MarshalEncode(enc, p) } fmt.Print(out.String()) æµå¼è§£ç å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 in := strings.NewReader(` {\u0026#34;Name\u0026#34;:\u0026#34;Alice\u0026#34;,\u0026#34;Age\u0026#34;:25} {\u0026#34;Name\u0026#34;:\u0026#34;Bob\u0026#34;,\u0026#34;Age\u0026#34;:30} {\u0026#34;Name\u0026#34;:\u0026#34;Cindy\u0026#34;,\u0026#34;Age\u0026#34;:15} `) dec := jsontext.NewDecoder(in) for { var p Person // Decodes one Person object per call. err := json.UnmarshalDecode(dec, \u0026amp;p) if err == io.EOF { break } fmt.Println(p) } ä¸ UnmarshalRead ä¸åŒï¼ŒUnmarshalDecode ä»¥å®Œå…¨æµå¼å¤„ç†çš„æ–¹å¼å·¥ä½œï¼Œæ¯æ¬¡è°ƒç”¨ä¸€æ¬¡è§£ç ä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯è¯»å–æ‰€æœ‰å†…å®¹ç›´åˆ° io.EOF.\né€‰é¡¹ é€‰é¡¹ä½¿ç”¨ç‰¹å®šåŠŸèƒ½é…ç½®ç¼–ç»„å’Œè§£ç»„åŠŸèƒ½ï¼š\nFormatNilMapAsNull å’Œ FormatNilSliceAsNull å®šä¹‰å¦‚ä½•ç¼–ç  nil æ˜ å°„å’Œåˆ‡ç‰‡ã€‚ MatchCaseInsensitiveNames å…è®¸åŒ¹é… Name â†” name ç­‰ã€‚ Multiline å°† JSON å¯¹è±¡æ‰©å±•ä¸ºå¤šè¡Œã€‚ OmitZeroStructFields ä»è¾“å‡ºä¸­çœç•¥å…·æœ‰é›¶å€¼çš„å­—æ®µã€‚ SpaceAfterColon å’Œ SpaceAfterComma åœ¨æ¯ä¸ª : æˆ– , åæ·»åŠ ä¸€ä¸ªç©ºæ ¼ StringifyNumbers å°†æ•°å­—ç±»å‹è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²ã€‚ WithIndent å’Œ WithIndentPrefix ç¼©è¿›åµŒå¥—å±æ€§ï¼ˆè¯·æ³¨æ„ï¼Œ MarshalIndent å‡½æ•°å·²è¢«åˆ é™¤ï¼‰ã€‚ æ¯ä¸ªç¼–ç»„æˆ–è§£ç»„å‡½æ•°å¯ä»¥é‡‡ç”¨ä»»æ„æ•°é‡çš„é€‰é¡¹ï¼š\n1 2 3 4 5 6 7 8 alice := Person{Name: \u0026#34;Alice\u0026#34;, Age: 25} b, _ := json.Marshal( alice, json.OmitZeroStructFields(true), json.StringifyNumbers(true), jsontext.WithIndent(\u0026#34; \u0026#34;), ) fmt.Println(string(b)) è¿˜å¯ä»¥å°†é€‰é¡¹ä¸ JoinOptions ç»„åˆï¼š\n1 2 3 4 5 6 7 alice := Person{Name: \u0026#34;Alice\u0026#34;, Age: 25} opts := json.JoinOptions( jsontext.SpaceAfterColon(true), jsontext.SpaceAfterComma(true), ) b, _ := json.Marshal(alice, opts) fmt.Println(string(b)) è¯·å‚é˜…æ–‡æ¡£ä¸­çš„å®Œæ•´é€‰é¡¹åˆ—è¡¨ï¼šä¸€äº›ä½äº json åŒ…ä¸­ï¼Œå…¶ä»–ä½äº jsontext åŒ…ä¸­ã€‚\nTags v2 æ”¯æŒ v1 ä¸­å®šä¹‰çš„å­—æ®µæ ‡ç­¾ï¼š\nomitzero å’Œ omitempty çœç•¥ç©ºå€¼ï¼Œomitempty æ˜¯ go1.24 ä¹‹å‰ç”¨äºçœç•¥ nil å¯¹è±¡çš„ï¼Œomitzero æ˜¯ go1.24 åŠ å…¥ç”¨äºçœç•¥é›¶å€¼å¯¹è±¡ã€‚ string å°†æ•°å­—ç±»å‹è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²ã€‚ - å¿½ç•¥å­—æ®µã€‚ å¹¶æ·»åŠ äº†ä¸€äº›ï¼š\ncase:ignore æˆ– case:strict æŒ‡å®šå¦‚ä½•å¤„ç†å¤§å°å†™å·®å¼‚ã€‚ format:template æ ¹æ®æ¨¡æ¿æ ¼å¼åŒ–å­—æ®µå€¼ã€‚ inline é€šè¿‡å°†åµŒå¥—å¯¹è±¡çš„å­—æ®µæå‡åˆ°çˆ¶çº§æ¥å±•å¹³è¾“å‡ºã€‚ unknown ä¸ºæœªçŸ¥å­—æ®µæä¾›äº†â€œå…¨éƒ¨æ•è·â€ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªæ¼”ç¤º inline å’Œ format ç¤ºä¾‹ï¼š\nåŒ¿åå±æ€§ä¸€æ ·æœ‰ inline çš„æ•ˆæœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 type Person struct { Name string `json:\u0026#34;name\u0026#34;` // Format date as yyyy-mm-dd. BirthDate time.Time `json:\u0026#34;birth_date,format:DateOnly\u0026#34;` // Inline address fields into the Person object. Address `json:\u0026#34;,inline\u0026#34;` } type Address struct { Street string `json:\u0026#34;street\u0026#34;` City string `json:\u0026#34;city\u0026#34;` } func main() { alice := Person{ Name: \u0026#34;Alice\u0026#34;, BirthDate: time.Date(2001, 7, 15, 12, 35, 43, 0, time.UTC), Address: Address{ Street: \u0026#34;123 Main St\u0026#34;, City: \u0026#34;Wonderland\u0026#34;, }, } b, _ := json.Marshal(alice, jsontext.WithIndent(\u0026#34; \u0026#34;)) fmt.Println(string(b)) } //{ // \u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, // \u0026#34;birth_date\u0026#34;: \u0026#34;2001-07-15\u0026#34;, // \u0026#34;street\u0026#34;: \u0026#34;123 Main St\u0026#34;, // \u0026#34;city\u0026#34;: \u0026#34;Wonderland\u0026#34; //} unknown ç”¨äºå°†ç»“æ„ä½“ä¸­æœªå®šä¹‰çš„å†…å®¹ï¼Œåœ¨ååºåˆ—åŒ–æ—¶æ”¶æŸåˆ°æ­¤ï¼Œæ­é… map[string]any ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 type Person struct { Name string `json:\u0026#34;name\u0026#34;` // Collect all unknown Person fields // into the Data field. Data map[string]any `json:\u0026#34;,unknown\u0026#34;` } func main() { src := `{ \u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;hobby\u0026#34;: \u0026#34;adventure\u0026#34;, \u0026#34;friends\u0026#34;: [ {\u0026#34;name\u0026#34;: \u0026#34;Bob\u0026#34;}, {\u0026#34;name\u0026#34;: \u0026#34;Cindy\u0026#34;} ] }` var alice Person json.Unmarshal([]byte(src), \u0026amp;alice) fmt.Println(alice) } // {Alice map[friends:[map[name:Bob] map[name:Cindy]] hobby:adventure]} è‡ªå®šä¹‰marshaling ä½¿ç”¨ Marshaler å’Œ Unmarshaler æ¥å£è¿›è¡Œè‡ªå®šä¹‰å°é€å¤„ç†çš„åŸºæœ¬ç”¨ä¾‹ä¿æŒä¸å˜ã€‚ä»¥ä¸‹ä»£ç åœ¨ v1 å’Œ v2 ç‰ˆæœ¬ä¸­å‡æœ‰æ•ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // A custom boolean type represented // as \u0026#34;âœ“\u0026#34; for true and \u0026#34;âœ—\u0026#34; for false. type Success bool func (s Success) MarshalJSON() ([]byte, error) { if s { return []byte(`\u0026#34;âœ“\u0026#34;`), nil } return []byte(`\u0026#34;âœ—\u0026#34;`), nil } func (s *Success) UnmarshalJSON(data []byte) error { // Data validation omitted for brevity. *s = string(data) == `\u0026#34;âœ“\u0026#34;` return nil } func main() { // Marshaling. val := Success(true) data, err := json.Marshal(val) fmt.Println(string(data), err) // Unmarshaling. src := []byte(`\u0026#34;âœ“\u0026#34;`) err = json.Unmarshal(src, \u0026amp;val) fmt.Println(val, err) } ä½†æ˜¯ï¼ŒGo æ ‡å‡†åº“æ–‡æ¡£å»ºè®®ä½¿ç”¨æ–°çš„ MarshalerTo å’Œ UnmarshalerFrom æ¥å£ï¼ˆå®ƒä»¬ä»¥çº¯æµæ–¹å¼å·¥ä½œï¼Œé€Ÿåº¦æ›´å¿«ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // A custom boolean type represented // as \u0026#34;âœ“\u0026#34; for true and \u0026#34;âœ—\u0026#34; for false. type Success bool func (s Success) MarshalJSONTo(enc *jsontext.Encoder) error { if s { return enc.WriteToken(jsontext.String(\u0026#34;âœ“\u0026#34;)) } return enc.WriteToken(jsontext.String(\u0026#34;âœ—\u0026#34;)) } func (s *Success) UnmarshalJSONFrom(dec *jsontext.Decoder) error { // Data validation omitted for brevity. tok, err := dec.ReadToken() *s = tok.String() == `\u0026#34;âœ“\u0026#34;` return err } func main() { // Marshaling. val := Success(true) data, err := json.Marshal(val) fmt.Println(string(data), err) // Unmarshaling. src := []byte(`\u0026#34;âœ“\u0026#34;`) err = json.Unmarshal(src, \u0026amp;val) fmt.Println(val, err) } æ›´æ£’çš„æ˜¯ï¼Œä¸å†å±€é™äºåªä½¿ç”¨ä¸€ç§ç‰¹å®šç±»å‹çš„ marshaling æ–¹å¼ã€‚ç°åœ¨ï¼Œæ‚¨å¯ä»¥éšæ—¶é€šè¿‡é€šç”¨çš„ MarshalFunc å’Œ UnmarshalFunc å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ marshalers and unmarshalersã€‚\n1 2 func MarshalFunc[T any](fn func(T) ([]byte, error)) *Marshalers func UnmarshalFunc[T any](fn func([]byte, T) error) *Unmarshalers ä¾‹å¦‚ï¼Œå¯ä»¥å°† bool å€¼ç¼–ç»„ä¸º âœ“ æˆ– âœ— è€Œæ— éœ€åˆ›å»ºè‡ªå®šä¹‰ç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // Custom marshaler for bool values. boolMarshaler := json.MarshalFunc( func(val bool) ([]byte, error) { if val { return []byte(`\u0026#34;âœ“\u0026#34;`), nil } return []byte(`\u0026#34;âœ—\u0026#34;`), nil }, ) // Pass the custom marshaler to Marshal // using the WithMarshalers option. val := true data, err := json.Marshal(val, json.WithMarshalers(boolMarshaler)) fmt.Println(string(data), err) å¹¶å°† âœ“ æˆ– âœ— è§£ç»„ä¸º bool ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Custom unmarshaler for bool values. boolUnmarshaler := json.UnmarshalFunc( func(data []byte, val *bool) error { *val = string(data) == `\u0026#34;âœ“\u0026#34;` return nil }, ) // Pass the custom unmarshaler to Unmarshal // using the WithUnmarshalers option. src := []byte(`\u0026#34;âœ“\u0026#34;`) var val bool err := json.Unmarshal(src, \u0026amp;val, json.WithUnmarshalers(boolUnmarshaler)) fmt.Println(val, err) è¿˜æœ‰ MarshalToFunc å’Œ UnmarshalFromFunc å‡½æ•°ç”¨äºåˆ›å»ºè‡ªå®šä¹‰ç¼–ç»„å™¨ã€‚å®ƒä»¬ä¸ MarshalFunc å’Œ UnmarshalFunc ç±»ä¼¼ï¼Œä½†å®ƒä»¬ä¸ jsontext.Encoder å’Œ jsontext.Decoder ä¸€èµ·ä½¿ç”¨ï¼Œè€Œä¸æ˜¯å­—èŠ‚åˆ‡ç‰‡ã€‚\n1 2 func MarshalToFunc[T any](fn func(*jsontext.Encoder, T) error) *Marshalers func UnmarshalFromFunc[T any](fn func(*jsontext.Decoder, T) error) *Unmarshalers å¯ä»¥ä½¿ç”¨ JoinMarshalers ç»„åˆ marshalersï¼ˆå¹¶ä½¿ç”¨ JoinUnmarshalers ç»„åˆunmarshalersï¼‰ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•å°†å¸ƒå°”å€¼ï¼ˆ true / false ï¼‰å’Œâ€œç±»å¸ƒå°”â€å­—ç¬¦ä¸²ï¼ˆ on / off ï¼‰å°é€ä¸º âœ“ æˆ– âœ— ï¼ŒåŒæ—¶ä¿ç•™æ‰€æœ‰å…¶ä»–å€¼çš„é»˜è®¤å°é€æ–¹å¼ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬ä¸ºå¸ƒå°”å€¼å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ marshalerï¼š\n1 2 3 4 5 6 7 8 9 // Marshals boolean values to âœ“ or âœ—.. boolMarshaler := json.MarshalToFunc( func(enc *jsontext.Encoder, val bool) error { if val { return enc.WriteToken(jsontext.String(\u0026#34;âœ“\u0026#34;)) } return enc.WriteToken(jsontext.String(\u0026#34;âœ—\u0026#34;)) }, ) ç„¶åæˆ‘ä»¬ä¸ºå¸ƒå°”å­—ç¬¦ä¸²å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ marshalerï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // Marshals boolean-like strings to âœ“ or âœ—. strMarshaler := json.MarshalToFunc( func(enc *jsontext.Encoder, val string) error { if val == \u0026#34;on\u0026#34; || val == \u0026#34;true\u0026#34; { return enc.WriteToken(jsontext.String(\u0026#34;âœ“\u0026#34;)) } if val == \u0026#34;off\u0026#34; || val == \u0026#34;false\u0026#34; { return enc.WriteToken(jsontext.String(\u0026#34;âœ—\u0026#34;)) } // SkipFunc is a special type of error that tells Go to skip // the current marshaler and move on to the next one. In our case, // the next one will be the default marshaler for strings. return json.SkipFunc }, ) æœ€åï¼Œæˆ‘ä»¬å°†ç¼–ç»„å™¨ä¸ JoinMarshalers ç»“åˆèµ·æ¥ï¼Œå¹¶ä½¿ç”¨ WithMarshalers é€‰é¡¹å°†å®ƒä»¬ä¼ é€’ç»™ç¼–ç»„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 // Combine custom marshalers with JoinMarshalers. marshalers := json.JoinMarshalers(boolMarshaler, strMarshaler) // Marshal some values. vals := []any{true, \u0026#34;off\u0026#34;, \u0026#34;hello\u0026#34;} data, err := json.Marshal(vals, json.WithMarshalers(marshalers)) fmt.Println(string(data), err) // [\u0026#34;âœ“\u0026#34;,\u0026#34;âœ—\u0026#34;,\u0026#34;hello\u0026#34;] \u0026lt;nil\u0026gt; è¿™ä¸æ˜¯å¾ˆé…·å—ï¼Ÿ\né»˜è®¤è¡Œä¸º v2 ä¸ä»…æ”¹å˜äº†åŒ…æ¥å£ï¼Œè¿˜æ”¹å˜äº†é»˜è®¤çš„ç¼–ç»„/è§£ç»„è¡Œä¸ºã€‚\nä¸€äº›å€¼å¾—æ³¨æ„çš„ç¼–ç»„å·®å¼‚åŒ…æ‹¬ï¼š\nv1 å°† nil åˆ‡ç‰‡å°é€ä¸º null ï¼Œv2 åˆ™å°é€ä¸º [] ã€‚æ‚¨å¯ä»¥ä½¿ç”¨FormatNilSliceAsNull é€‰é¡¹è¿›è¡Œæ›´æ”¹ã€‚ v1 å°† nil map å°é€ä¸º null ï¼Œv2 åˆ™å°†å…¶å°é€ä¸º {} ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ FormatNilMapAsNull é€‰é¡¹è¿›è¡Œæ›´æ”¹ã€‚ v1 å°†å­—èŠ‚æ•°ç»„ç¼–ç»„ä¸ºæ•°å­—æ•°ç»„ï¼Œv2 åˆ™å°†å…¶ç¼–ç»„ä¸º base64 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ format:array å’Œ format:base64 æ ‡ç­¾è¿›è¡Œæ›´æ”¹ã€‚ v1 å…è®¸å­—ç¬¦ä¸²ä¸­åŒ…å«æ— æ•ˆçš„ UTF-8 å­—ç¬¦ï¼Œè€Œ v2 åˆ™ä¸å…è®¸ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ AllowInvalidUTF8 é€‰é¡¹è¿›è¡Œæ›´æ”¹ã€‚ ä»¥ä¸‹æ˜¯é»˜è®¤ v2 è¡Œä¸ºçš„ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 type Person struct { Name string Hobbies []string Skills map[string]int Secret [5]byte } func main() { alice := Person{ Name: \u0026#34;Alice\u0026#34;, Secret: [5]byte{1, 2, 3, 4, 5}, } b, _ := json.Marshal(alice, jsontext.Multiline(true)) fmt.Println(string(b)) } //{ // \u0026#34;Name\u0026#34;: \u0026#34;Alice\u0026#34;, // \u0026#34;Hobbies\u0026#34;: [], // \u0026#34;Skills\u0026#34;: {}, // \u0026#34;Secret\u0026#34;: \u0026#34;AQIDBAU=\u0026#34; //} ä»¥ä¸‹æ˜¯å¼ºåˆ¶æ‰§è¡Œ v1 è¡Œä¸ºçš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 type Person struct { Name string Hobbies []string Skills map[string]int Secret [5]byte `json:\u0026#34;,format:array\u0026#34;` } func main() { alice := Person{ Name: \u0026#34;Alice\u0026#34;, Secret: [5]byte{1, 2, 3, 4, 5}, } b, _ := json.Marshal( alice, json.FormatNilMapAsNull(true), json.FormatNilSliceAsNull(true), jsontext.Multiline(true), ) fmt.Println(string(b)) } // { // \u0026#34;Name\u0026#34;: \u0026#34;Alice\u0026#34;, // \u0026#34;Hobbies\u0026#34;: null, // \u0026#34;Skills\u0026#34;: null, // \u0026#34;Secret\u0026#34;: [ // 1, // 2, // 3, // 4, // 5 // ] // } ä¸€äº›å€¼å¾—æ³¨æ„çš„è§£ç»„å·®å¼‚åŒ…æ‹¬ï¼š\nv1 ç‰ˆæœ¬ä½¿ç”¨ä¸åŒºåˆ†å¤§å°å†™çš„å­—æ®µåç§°åŒ¹é…ï¼Œv2 ç‰ˆæœ¬åˆ™ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ MatchCaseInsensitiveNames é€‰é¡¹æˆ– case æ ‡ç­¾è¿›è¡Œæ›´æ”¹ã€‚ v1 ç‰ˆæœ¬å…è®¸å¯¹è±¡ä¸­å­˜åœ¨é‡å¤å­—æ®µï¼Œè€Œ v2 ç‰ˆæœ¬åˆ™ä¸å…è®¸ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ AllowDuplicateNames é€‰é¡¹è¿›è¡Œæ›´æ”¹ã€‚ ä»¥ä¸‹æ˜¯é»˜è®¤ v2 è¡Œä¸ºï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰çš„ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 type Person struct { FirstName string LastName string } func main() { src := []byte(`{\u0026#34;firstname\u0026#34;:\u0026#34;Alice\u0026#34;,\u0026#34;lastname\u0026#34;:\u0026#34;Zakas\u0026#34;}`) var alice Person json.Unmarshal(src, \u0026amp;alice) fmt.Printf(\u0026#34;%+v\\n\u0026#34;, alice) } // {FirstName: LastName:} ä»¥ä¸‹æ˜¯å¼ºåˆ¶æ‰§è¡Œ v1 è¡Œä¸ºçš„æ–¹æ³•ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type Person struct { FirstName string LastName string } func main() { src := []byte(`{\u0026#34;firstname\u0026#34;:\u0026#34;Alice\u0026#34;,\u0026#34;lastname\u0026#34;:\u0026#34;Zakas\u0026#34;}`) var alice Person json.Unmarshal( src, \u0026amp;alice, json.MatchCaseInsensitiveNames(true), ) fmt.Printf(\u0026#34;%+v\\n\u0026#34;, alice) } // {FirstName:Alice LastName:Zakas} è¯·å‚é˜…æ–‡æ¡£ä¸­çš„è¡Œä¸ºå˜åŒ–çš„å®Œæ•´åˆ—è¡¨ã€‚\nè¡¨ç° ç¼–ç»„ (Marshaling) æ—¶ï¼Œv2 çš„æ€§èƒ½ä¸ v1 å¤§è‡´ç›¸åŒã€‚å¯¹äºæŸäº›æ•°æ®é›†ï¼Œå®ƒçš„é€Ÿåº¦æ›´å¿«ï¼Œä½†å¯¹äºå…¶ä»–æ•°æ®é›†ï¼Œå®ƒçš„é€Ÿåº¦è¾ƒæ…¢ã€‚ç„¶è€Œï¼Œè§£ç»„ (Unmarshaling) çš„æ€§èƒ½è¦å¥½å¾—å¤š ï¼šv2 æ¯” v1 å¿« 2.7 å€åˆ° 10.2 å€ã€‚\næ­¤å¤–ï¼Œä»å¸¸è§„çš„ MarshalJSON å’Œ UnmarshalJSON åˆ‡æ¢åˆ°å…¶æµå¼æ›¿ä»£æ–¹æ¡ˆâ€”â€” MarshalJSONTo å’Œ UnmarshalJSONFrom ï¼Œå¯ä»¥è·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚æ® Go å›¢é˜Ÿç§°ï¼Œå®ƒå…è®¸å°†æŸäº› O(nÂ²) çš„è¿è¡Œæ—¶åœºæ™¯è½¬æ¢ä¸º O(n)ã€‚ä¾‹å¦‚ï¼Œåœ¨ Kubernetes OpenAPI è§„èŒƒä¸­ï¼Œä» UnmarshalJSON åˆ‡æ¢åˆ° UnmarshalJSONFrom ä½¿å…¶é€Ÿåº¦æé«˜äº†çº¦ 40 å€ ã€‚\næœ‰å…³åŸºå‡†æµ‹è¯•çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… jsonbench repoã€‚\næœ€åçš„æƒ³æ³• å‘¼ï¼è¿™å¯çœŸæ˜¯è®©äººè´¹è§£ã€‚v2 åŒ…æ¯” v1 åŠŸèƒ½æ›´å¤šã€æ›´çµæ´»ï¼Œä½†ä¹Ÿå¤æ‚å¾—å¤šï¼Œå°¤å…¶æ˜¯æ‹†åˆ†æˆäº† json/v2 å’Œ jsontext ä¸¤ä¸ªå­åŒ…ä¹‹åã€‚\néœ€è¦è®°ä½ä»¥ä¸‹å‡ ç‚¹ï¼š\nä» Go 1.25 å¼€å§‹ï¼Œ json/v2 åŒ…å¤„äºå®éªŒé˜¶æ®µï¼Œå¯ä»¥é€šè¿‡åœ¨æ„å»ºæ—¶è®¾ç½® GOEXPERIMENT=jsonv2 æ¥å¯ç”¨ã€‚è¯¥åŒ…çš„ API å¯èƒ½ä¼šåœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å‘ç”Ÿå˜åŒ–ã€‚ å¼€å¯ GOEXPERIMENT=jsonv2 ä¼šä½¿ v1 json åŒ…ä½¿ç”¨æ–°çš„ JSON å®ç°ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œå¹¶æ”¯æŒä¸€äº›é€‰é¡¹ï¼Œä»¥ä¾¿æ›´å¥½åœ°å…¼å®¹æ—§çš„ç¼–ç»„å’Œè§£ç»„è¡Œä¸ºã€‚ æœ€åï¼Œè¿™é‡Œæœ‰ä¸€äº›é“¾æ¥å¯ä»¥äº†è§£æœ‰å…³ v2 è®¾è®¡å’Œå®ç°çš„æ›´å¤šä¿¡æ¯ï¼š\nproposal p.1 â€¢ proposal p.2 â€¢ json/v2 â€¢ jsontext\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº JSON evolution in Go: from v1 to v2\n","date":"2025-06-29T00:00:00Z","permalink":"https://blog.golang.space/p/go-%E4%B8%AD%E7%9A%84-json-%E6%BC%94%E5%8F%98-%E4%BB%8E-v1-%E5%88%B0-v2/","title":"Go ä¸­çš„ JSON æ¼”å˜, ä» v1 åˆ° v2"},{"content":"Golang clear å¾ˆæ¶ˆè€—æ€§èƒ½å—? clear å†…ç½®å‡½æ•°åœ¨ Go 1.21 ç‰ˆæœ¬ä¸­æ–°å¢ã€‚\næ­¤å‡½æ•°ç”¨äºæ¸…é™¤ map å’Œ sliceã€‚å¯¹äº map ä¼šåˆ é™¤æ‰€æœ‰é”®å€¼å¯¹ï¼Œä»è€Œç”Ÿæˆä¸€ä¸ªç©º mapï¼Œå¯¹äº sliceï¼Œä¼šå°†é•¿åº¦ä»¥å†…å…¨éƒ¨è®¾ç½®ä¸ºå¯¹åº”å…ƒç´ ç±»å‹çš„é›¶å€¼ã€‚\né‚£ä¹ˆ clear æ¶ˆè€—æ€§èƒ½å—?\nè®©æˆ‘çœ‹å›¾å†™æ–‡\nclear(make([]byte,256*1024)) æ—¶ï¼Œruntime è°ƒç”¨äº† memclrNoHeapPointers\nloop_zva æ˜¯è¿™æ®µ ARM64 æ±‡ç¼–ä»£ç ä¸­çš„ä¸€ä¸ªå…³é”®å¾ªç¯ï¼Œç”¨äºé«˜æ•ˆæ¸…é›¶å¤§å—å†…å­˜ï¼Œåˆ©ç”¨äº† ARM64 çš„ DC ZVAï¼ˆData Cache Zero by VAï¼‰ æŒ‡ä»¤ã€‚å®ƒçš„ä½œç”¨æ˜¯é€šè¿‡ç¡¬ä»¶åŠ é€Ÿçš„æ–¹å¼ï¼Œå¿«é€Ÿæ¸…é›¶ç¼“å­˜è¡Œï¼ˆcache lineï¼‰å¤§å°çš„å†…å­˜å—ï¼Œæ¯”æ™®é€šçš„ STPï¼ˆå­˜å‚¨é›¶å€¼ï¼‰æŒ‡ä»¤æ›´å¿«ã€‚\næ˜æ˜ç¡¬ä»¶åŠ é€Ÿåˆ é™¤ï¼Œæ€ä¹ˆè¿˜éœ€è¦ 1.24s å‘¢? DC ZVA å¹¶ä¸æ˜¯ç®€å•çš„â€œç¬é—´æ¸…é›¶å†…å­˜â€ï¼Œå®ƒçš„å®é™…è¡Œä¸ºåŒ…æ‹¬ï¼š\nç¼“å­˜è¡Œæ“ä½œï¼š DC ZVA ä¼šæ¸…é›¶æ•´ä¸ªç¼“å­˜è¡Œï¼ˆé€šå¸¸ 64 å­—èŠ‚ï¼‰ï¼Œä½†éœ€è¦å…ˆåŠ è½½ç¼“å­˜è¡Œåˆ° CPU ç¼“å­˜ï¼ˆå¦‚æœæœªåŠ è½½ï¼‰ï¼Œå†æ¸…é›¶å¹¶å†™å›å†…å­˜ã€‚ å¦‚æœç›®æ ‡å†…å­˜å°šæœªç¼“å­˜ï¼Œå¯èƒ½éœ€è¦ä»ä¸»å­˜åŠ è½½ï¼Œè¿™ä¼šå¢åŠ å»¶è¿Ÿã€‚ å†…å­˜è®¿é—®æ¨¡å¼çš„å½±å“ï¼š å¦‚æœå†…å­˜åŒºåŸŸæ˜¯éè¿ç»­è®¿é—®ï¼ˆä¾‹å¦‚è·¨å¤šä¸ªç¼“å­˜è¡Œï¼‰ï¼Œæˆ–è€…å†…å­˜å¸¦å®½å—é™ï¼ŒDC ZVA çš„æ•ˆç‡ä¼šä¸‹é™ã€‚ å¯¹äºå¤§å—å†…å­˜ï¼ŒDC ZVA å¯èƒ½éœ€è¦å¤šæ¬¡æ“ä½œï¼Œæ¯æ¬¡æ“ä½œéƒ½æœ‰å›ºå®šå¼€é”€ã€‚ ä¸ç”¨ clear å‘¢? 1 2 3 for i := range buf { buf[i] = 0 } æ›´æ…¢äº†è€¶!! range è¯»å–çš„å‰¯æœ¬ï¼Œéœ€è¦ copy å¹¶åŠ è½½åˆ° cpuã€‚\næ€»ç»“ åœ¨æ€§èƒ½ä¸Šè¦æ›´é«˜è¦æ±‚çš„åœ°æ–¹ï¼Œå¯¹äºå¤§å†…å­˜å—ï¼Œä¸æ‰§è¡Œæ¸…é›¶æ“ä½œï¼Œå–æŒ‡å®šé•¿åº¦çš„å­åˆ‡ç‰‡ç›´æ¥è¦†ç›–ä½¿ç”¨å³å¯ã€‚\nä»¥ä¸Šå†…å®¹æ¥æºäºå¼€æºé¡¹ç›® https://github.com/ixugo/bytepool\nè¿™æ˜¯å¸¦å¼•ç”¨çš„è®¡æ•°å†…å­˜æ± ï¼ŒåŸºäº sync.Pool å®ç°ï¼Œé€‚ç”¨äºå¤šåç¨‹å…±äº«åŒä¸€å—å†…å­˜ï¼Œä¸çŸ¥é“ä½•æ—¶æ”¾å›å†…å­˜æ± åœºæ™¯ã€‚(å†…å­˜å¤åˆ¶åˆ°å„ä¸ªåç¨‹ä¼šæ›´å®‰å…¨ï¼Œä½†å…±äº«ä¼šæ›´é«˜æ€§èƒ½ï¼Œå»ºè®®é€‰æ‹©å‰è€…ï¼Œç°åœ¨æœåŠ¡å™¨åŸºæœ¬å†…å­˜ç®¡é¥±)\nè‡ªåŠ¨å¼•ç”¨è®¡æ•° åˆ†å±‚å†…å­˜æ±  é›¶æ‹·è´è®¾è®¡ å¹¶å‘å®‰å…¨ å†…ç½®ç»Ÿè®¡æ•°æ® é«˜æ€§èƒ½ ","date":"2025-05-29T00:00:00Z","permalink":"https://blog.golang.space/p/golang-clear-%E5%BE%88%E6%B6%88%E8%80%97%E6%80%A7%E8%83%BD%E5%90%97/","title":"Golang clear å¾ˆæ¶ˆè€—æ€§èƒ½å—?"},{"content":"é»˜è®¤æƒ…å†µä¸‹ï¼ŒGo åœ¨ä¼ é€’å€¼æ—¶ä¼šå¤åˆ¶å®ƒä»¬ã€‚ä½†æœ‰æ—¶è¿™å¯èƒ½æ˜¯ä¸å¸Œæœ›çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä¸å°å¿ƒå¤åˆ¶äº†ä¸€ä¸ªäº’æ–¥é”ï¼Œå¹¶ä¸”å¤šä¸ª goroutine åœ¨ä¸åŒçš„é”å®ä¾‹ä¸Šå·¥ä½œï¼Œå®ƒä»¬å°†æ— æ³•æ­£ç¡®åŒæ­¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼ é€’é”çš„æŒ‡é’ˆå¯ä»¥é¿å…å¤åˆ¶å¹¶æŒ‰é¢„æœŸå·¥ä½œã€‚\nä»¥è¿™ä¸ªä¾‹å­æ¥è¯´ï¼šé€šè¿‡å€¼ä¼ é€’ sync.WaitGroup ä¼šä»¥å¾®å¦™çš„æ–¹å¼ç ´åç¨‹åºï¼š\n1 2 3 4 5 6 7 8 func f(wg sync.WaitGroup) { // ... do something with the waitgroup } func main() { var wg sync.WaitGroup f(wg) // oops! wg is getting copied here! } sync.WaitGroup è®©ä½ å¯ä»¥ç­‰å¾…å¤šä¸ª goroutine å®Œæˆä¸€äº›å·¥ä½œã€‚åœ¨å¹•åï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å« Add ã€ Done å’Œ Wait ç­‰æ–¹æ³•çš„ç»“æ„ä½“ï¼Œç”¨äºåŒæ­¥å¹¶å‘è¿è¡Œçš„ goroutineã€‚\nè¿™æ®µä»£ç å¯ä»¥ç¼–è¯‘ï¼Œä½†ç”±äºæˆ‘ä»¬åœ¨ f å‡½æ•°ä¸­å¤åˆ¶äº†é”è€Œä¸æ˜¯å¼•ç”¨å®ƒï¼Œå› æ­¤ä¼šå¯¼è‡´é”™è¯¯è¡Œä¸ºã€‚\nå¹¸è¿çš„æ˜¯ï¼Œ go vet ä¼šæ•è·è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœä½ åœ¨ä»£ç ä¸Šè¿è¡Œ vetï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªç±»ä¼¼äºè¿™æ ·çš„è­¦å‘Šï¼š\n1 2 f passes lock by value: sync.WaitGroup contains sync.noCopy call of f copies lock value: sync.WaitGroup contains sync.noCopy è¿™æ„å‘³ç€å½“æˆ‘ä»¬åº”è¯¥ä¼ é€’ä¸€ä¸ªå¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬å´é€šè¿‡å€¼ä¼ é€’äº† wg ã€‚è¿™æ˜¯ä¿®å¤æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 func f(wg *sync.WaitGroup) { // pass by reference // ... do something with the waitgroup } func main() { var wg sync.WaitGroup f(\u0026amp;wg) // pass a pointer to wg } ç”±äºè¿™ç§ä¸æ­£ç¡®çš„å¤åˆ¶ä¸ä¼šæŠ›å‡ºç¼–è¯‘é”™è¯¯ï¼Œå¦‚æœä½ è·³è¿‡äº† go vet ï¼Œä½ å¯èƒ½æ°¸è¿œä¹Ÿå‘ç°ä¸äº†å®ƒã€‚è¿™ä¹Ÿæ˜¯å§‹ç»ˆå®¡æŸ¥ä»£ç çš„å¦ä¸€ä¸ªåŸå› ã€‚\næˆ‘å¾ˆå¥½å¥‡ Go å·¥å…·é“¾æ˜¯å¦‚ä½•å¼ºåˆ¶æ‰§è¡Œè¿™ä¸€ç‚¹çš„ã€‚çº¿ç´¢å°±åœ¨ vet è­¦å‘Šä¸­ï¼š\næ‰€ä»¥ sync.noCopy ç»“æ„ä½“åœ¨ sync.WaitGroup ä¸­åšäº†äº›ä»€ä¹ˆæ¥æé†’ go vet å½“ä½ é€šè¿‡å€¼ä¼ é€’å®ƒæ—¶ã€‚\næŸ¥çœ‹ sync.WaitGroup 1 çš„å®ç°ï¼Œä½ ä¼šå‘ç°ï¼š\n1 2 3 4 5 6 type WaitGroup struct { noCopy noCopy state atomic.Uint64 sema uint32 } ç„¶åæˆ‘è¿½è¸ªäº† noCopy åœ¨ sync/cond.go 2 ä¸­çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 // noCopy may be added to structs which must not be copied // after the first use. // Note that it must not be embedded, due to the Lock and Unlock methods. type noCopy struct{} // Lock is a no-op used by -copylocks checker from `go vet`. func (*noCopy) Lock() {} func (*noCopy) Unlock() {} åªéœ€è¦åœ¨ noCopy ä¸Šå®šä¹‰é‚£äº›ç©ºçš„ Lock å’Œ Unlock æ–¹æ³•ã€‚è¿™å®ç°äº† Locker 3 æ¥å£ã€‚ç„¶åå¦‚æœä½ å°†è¿™ä¸ªç»“æ„ä½“åµŒå…¥åˆ°å¦ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œ go vet å°†ä¼šæ ‡è®°ä½ åœ¨å°è¯•å¤åˆ¶å¤–éƒ¨ç»“æ„ä½“æ—¶å‡ºç°çš„æƒ…å†µã€‚\nå¦å¤–ï¼Œè¯·æ³¨æ„æ³¨é‡Šï¼šä¸è¦åµŒå…¥ noCopy ã€‚æ˜¾å¼åŒ…å«å®ƒã€‚åµŒå…¥ä¼šä½¿ Lock å’Œ Unlock åœ¨å¤–éƒ¨ç»“æ„ä½“ä¸­å¯è§ï¼Œè¿™å¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚\nGo å·¥å…·é“¾é€šè¿‡ -copylocks æ£€æŸ¥å™¨æ¥å¼ºåˆ¶æ‰§è¡Œè¿™ä¸€ç‚¹ã€‚å®ƒæ˜¯ go vet çš„ä¸€éƒ¨åˆ†ã€‚ä½ å¯ä»¥å•ç‹¬ä½¿ç”¨ go vet -copylocks ./... æ¥è°ƒç”¨å®ƒã€‚å®ƒä¼šæŸ¥æ‰¾ä»»ä½•åŒ…å« Lock å’Œ Unlock æ–¹æ³•çš„åµŒå¥—ç»“æ„ä½“çš„å€¼æ‹·è´ã€‚è¿™äº›æ–¹æ³•çš„å…·ä½“åŠŸèƒ½å¹¶ä¸é‡è¦ï¼Œåªè¦æœ‰è¿™äº›æ–¹æ³•å°±è¶³å¤Ÿäº†ã€‚\nå½“ vet è¿è¡Œæ—¶ï¼Œå®ƒä¼šéå†æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œå¹¶åœ¨èµ‹å€¼ã€å‡½æ•°è°ƒç”¨ã€è¿”å›å€¼ã€ç»“æ„ä½“å­—é¢é‡ã€èŒƒå›´å¾ªç¯ã€é€šé“å‘é€ç­‰ä»»ä½•å€¼è¢«æ‹·è´çš„åœ°æ–¹åº”ç”¨æ£€æŸ¥å™¨ã€‚å¦‚æœå®ƒå‘ç°ä½ æ‹·è´äº†ä¸€ä¸ªåŒ…å« noCopy çš„ç»“æ„ä½“ï¼Œå®ƒä¼šå‘å‡ºè­¦å‘Šã€‚ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æ£€æŸ¥çš„å®ç° 4 ã€‚\næœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœä½ å°† noCopy å®šä¹‰ä¸ºä»»ä½•éç»“æ„ä½“ç±»å‹å¹¶å®ç° Locker æ¥å£ï¼Œvet ä¼šå¿½ç•¥å®ƒã€‚æˆ‘åœ¨ Go 1.24 ä¸­è¿›è¡Œäº†æµ‹è¯•ï¼š\n1 2 3 type noCopy int // this is valid but vet doesn\u0026#39;t get triggered func (*noCopy) Lock() {} func (*noCopy) Unlock() {} è¿™ä¸ä¼šè§¦å‘ vetã€‚åªæœ‰å½“ noCopy æ˜¯ç»“æ„ä½“æ—¶æ‰ä¼šç”Ÿæ•ˆã€‚åŸå› æ˜¯ vet åœ¨æ£€æŸ¥ä½•æ—¶è§¦å‘è­¦å‘Šæ—¶é‡‡å–äº†ä¸€æ¡æ·å¾„ 5 ã€‚ç›®å‰ï¼Œå®ƒæ˜ç¡®æŸ¥æ‰¾æ»¡è¶³ Locker æ¥å£çš„ç»“æ„ä½“ï¼Œå¹¶å¿½ç•¥ä»»ä½•å…¶ä»–ç±»å‹ï¼Œå³ä½¿å®ƒä»¬å®ç°äº†è¯¥æ¥å£ã€‚\nä½ ä¹Ÿä¼šåœ¨ sync åŒ…çš„å…¶ä»–éƒ¨åˆ†çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚ sync.Mutex ä½¿ç”¨äº†åŒæ ·çš„æŠ€å·§ï¼š\n1 2 3 4 5 type Mutex struct { _ noCopy mu isync.Mutex } åŒæ ·é€‚ç”¨äº sync.Once :\n1 2 3 4 5 type Once struct { done uint32 m Mutex noCopy noCopy } è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ -copylocks é¿å…å¤åˆ¶æˆ‘ä»¬è‡ªå·±çš„ç»“æ„ä½“çš„å®Œæ•´ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 type Svc struct{ _ noCopy } type noCopy struct{} func (*noCopy) Lock() {} func (*noCopy) Unlock() {} // Use this func main() { var svc Svc _ = svc // go vet will complain about this copy op } è¿è¡Œ go vet å¾—åˆ°ï¼š\n1 2 assignment copies lock value to s: play.Svc contains play.noCopy call of fmt.Println copies lock value: play.Svc contains play.noCopy æœ‰äººåœ¨ Reddit ä¸Šé—®æˆ‘ï¼Œæ˜¯ä»€ä¹ˆè§¦å‘äº† copylock æ£€æŸ¥å™¨åœ¨ go vet â€” æ˜¯ç»“æ„ä½“çš„å­—é¢åç§° noCopy è¿˜æ˜¯å®ƒå®ç°äº† Locker æ¥å£ï¼Ÿ\nnoCopy è¿™ä¸ªåå­—ä¸æ˜¯ç‰¹æ®Šçš„ã€‚ä½ å¯ä»¥æƒ³å«å®ƒä»€ä¹ˆå°±å«ä»€ä¹ˆã€‚åªè¦å®ƒå®ç°äº† Locker æ¥å£ï¼Œ go vet ä¼šåœ¨å‘¨å›´ç»“æ„ä½“è¢«å¤åˆ¶æ—¶æŠ±æ€¨ã€‚å‚è§è¿™ä¸ª Go Playground ç‰‡æ®µ 6 ã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Preventing accidental struct copies in Go\n","date":"2025-04-26T00:00:00Z","permalink":"https://blog.golang.space/p/%E9%81%BF%E5%85%8D%E5%9C%A8-go-%E4%B8%AD%E6%84%8F%E5%A4%96%E5%9C%B0%E5%A4%8D%E5%88%B6%E7%BB%93%E6%9E%84%E4%BD%93/","title":"é¿å…åœ¨ Go ä¸­æ„å¤–åœ°å¤åˆ¶ç»“æ„ä½“"},{"content":"ä¸Šå‘¨ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šåƒµå°¸è¿›ç¨‹å¯¼è‡´æˆ‘çš„æ¼”ç¤ºæœåŠ¡å™¨å´©æºƒ ğŸ§Ÿâ€â™‚ï¸ å¦‚æœä½ æœ‰è¿‡åœ¨ Go æˆ– Docker ä¸­å¤„ç†è¿›ç¨‹ç®¡ç†çš„ç»éªŒï¼Œä½ å¯èƒ½ä¼šå¯¹è¿™æ®µç»å†æ„ŸåŒèº«å—ã€‚ä¸‹é¢æ˜¯å¯¹è¿™ä¸ªé—®é¢˜çš„æ·±å…¥æŠ€æœ¯åˆ†æï¼Œä»¥åŠæˆ‘æ˜¯å¦‚ä½•è¿½è¸ªå¹¶è§£å†³å®ƒçš„ã€‚\næˆ‘ä»¬æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œåœ¨ Stormkit ä¸­å¯ä»¥æ ¹æ®è‡ªæ‰˜ç®¡ç”¨æˆ·çš„éœ€æ±‚å¯åŠ¨ Node.js æœåŠ¡å™¨ï¼Œä½¿ç”¨åŠ¨æ€ç«¯å£åˆ†é…åœ¨åŒä¸€æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªå®ä¾‹ã€‚å®ƒæ˜¯ç”¨ Go ç¼–å†™çš„ï¼Œåˆ©ç”¨ os/exec æ¥ç®¡ç†è¿›ç¨‹ã€‚è¯¥ç³»ç»Ÿä¸€ç›´éå¸¸ç¨³å®šâ€”â€”æ²¡æœ‰å®•æœºæ—¶é—´ï¼Œç”¨æˆ·ä¹Ÿå¾ˆæ»¡æ„ã€‚\næœ€è¿‘ï¼Œæˆ‘è®¾ç½®äº†ä¸€ä¸ªç”¨äºæ‰˜ç®¡ Next.js å’Œ Svelte æœåŠ¡å™¨ç«¯åº”ç”¨çš„æ¼”ç¤ºæœåŠ¡å™¨ã€‚ä¸€åˆ‡çœ‹èµ·æ¥éƒ½æ­£å¸¸ï¼Œç›´åˆ°æœåŠ¡å™¨å¼€å§‹éšæœºå‡ºç° Redis å‘å¸ƒ/è®¢é˜…é”™è¯¯è€Œå´©æºƒã€‚\næˆ‘å°† Redis å‡çº§åˆ°äº† 7.x ç‰ˆæœ¬ï¼Œæ£€æŸ¥äº†æ—¥å¿—å¹¶å°è¯•åœ¨æœ¬åœ°é‡ç°é—®é¢˜â€”â€”æ²¡æœ‰å‘ç°ä»»ä½•é—®é¢˜ã€‚å´©æºƒæ˜¯éšæœºä¸”éš¾ä»¥æ‰æ‘¸çš„ã€‚ç„¶åï¼Œæˆ‘ç¦ç”¨äº† Next.js åº”ç”¨ï¼Œå´©æºƒå°±åœæ­¢äº†ã€‚æˆ‘æ€€ç–‘æ˜¯ Next.js æœ¬èº«çš„é—®é¢˜ï¼Œäºæ˜¯æ·±å…¥ç ”ç©¶äº†å…¶è¿è¡Œæ—¶è¡Œä¸ºï¼Œä½†æ²¡æœ‰å‘ç°ä»€ä¹ˆå¼‚å¸¸ã€‚\næŸ¥çœ‹æœåŠ¡å™¨æŒ‡æ ‡æ—¶ï¼Œæˆ‘å‘ç°å†…å­˜ä½¿ç”¨ç‡åœ¨å´©æºƒå‰ä¼šæ¿€å¢ã€‚å¿«é€Ÿè¿è¡Œ ps aux å‘½ä»¤åï¼Œæˆ‘å‘ç°æœ‰ä¸€å †é—ç•™çš„ Next.js è¿›ç¨‹æ²¡æœ‰è¢«ç»ˆæ­¢ã€‚æˆ‘ä»¬çš„å…³æœºé€»è¾‘å¤±è´¥äº†ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œæœ€ç»ˆè€—å°½äº†æœåŠ¡å™¨èµ„æºã€‚\nç½ªé­ç¥¸é¦–åœ¨äºæˆ‘ä»¬çš„ Go ä»£ç ã€‚æˆ‘ä½¿ç”¨ os.Process.Kill æ¥ç»ˆæ­¢è¿›ç¨‹ï¼Œä½†æ²¡æœ‰æ€æ­»ç”± npm å¯åŠ¨çš„å­è¿›ç¨‹ï¼ˆä¾‹å¦‚ï¼Œ npm run start å¯åŠ¨äº† next start ï¼‰ã€‚è¿™å¯¼è‡´å­¤å„¿è¿›ç¨‹ä¸æ–­ç´¯ç§¯ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªåŸå§‹ä»£ç çš„ç®€åŒ–ç‰ˆæœ¬ï¼š\n1 2 3 4 5 6 7 func stopProcess(cmd *exec.Cmd) error { if cmd.Process != nil { return cmd.Process.Kill() } return nil } æˆ‘é€šè¿‡å¯åŠ¨ä¸€ä¸ªå¸¦æœ‰å­è¿›ç¨‹çš„ Node.js è¿›ç¨‹å¹¶æ€æ­»çˆ¶è¿›ç¨‹æ¥æœ¬åœ°é‡ç°äº†è¿™ä¸ªé—®é¢˜ã€‚æœç„¶ï¼Œå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œã€‚åœ¨ Go ä¸­ï¼Œ os.Process.Kill å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼Œä½†ä¸å¤„ç†å…¶å­è¿›ç¨‹ã€‚\nè§£å†³å°è¯•ï¼šè¿›ç¨‹ç»„ è¦æ€æ­»å­è¿›ç¨‹ï¼Œæˆ‘ä¿®æ”¹ä»£ç ä½¿ç”¨äº†è¿›ç¨‹ç»„ã€‚é€šè¿‡ä½¿ç”¨ syscall.SysProcAttr è®¾ç½®è¿›ç¨‹ç»„ IDï¼ˆPGIDï¼‰ï¼Œæˆ‘å¯ä»¥å‘æ•´ä¸ªç»„å‘é€ä¿¡å·ã€‚è¿™æ˜¯æ›´æ–°åçš„ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package main import ( \u0026#34;log\u0026#34; \u0026#34;os/exec\u0026#34; \u0026#34;syscall\u0026#34; ) func startProcess() (*exec.Cmd, error) { cmd := exec.Command(\u0026#34;npm\u0026#34;, \u0026#34;run\u0026#34; \u0026#34;start\u0026#34;) cmd.SysProcAttr = \u0026amp;syscall.SysProcAttr{Setpgid: true} // Assign PGID if err := cmd.Start(); err != nil { return nil, err } return cmd, nil } func stopProcess(cmd *exec.Cmd) error { if cmd.Process == nil { return nil } // Send SIGTERM to the process group pgid, err := syscall.Getpgid(cmd.Process.Pid) if err != nil { return err } return syscall.Kill(-pgid, syscall.SIGTERM) // Negative PGID targets group } è¿™åœ¨æœ¬åœ°å·¥ä½œäº†ï¼šæ€æ­»çˆ¶è¿›ç¨‹ä¹Ÿç»ˆæ­¢äº†å­è¿›ç¨‹ã€‚æˆ‘å°†ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬éƒ¨ç½²åˆ°æˆ‘ä»¬çš„è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼ŒæœŸæœ›èƒœåˆ©ã€‚ä½† ps aux æ˜¾ç¤º \u0026lt;defunct\u0026gt; æ¥è¿‘è¿›ç¨‹æ—è¾¹â€”â€”åƒµå°¸è¿›ç¨‹ï¼ğŸ§ \nåƒµå°¸è¿›ç¨‹ 101 åœ¨ Linux ä¸­ï¼Œå½“ä¸€ä¸ªå­è¿›ç¨‹ç»ˆæ­¢ï¼Œä½†å…¶çˆ¶è¿›ç¨‹æ²¡æœ‰æ”¶é›†å…¶é€€å‡ºçŠ¶æ€ï¼ˆé€šè¿‡ wait æˆ– waitpidï¼‰æ—¶ï¼Œå°±ä¼šå‡ºç°åƒµå°¸è¿›ç¨‹ã€‚è¯¥è¿›ç¨‹ä¼šåœç•™åœ¨è¿›ç¨‹è¡¨ä¸­ï¼Œæ ‡è®°ä¸º \u0026lt;defunct\u0026gt; ã€‚å°‘é‡çš„åƒµå°¸è¿›ç¨‹æ˜¯æ— å®³çš„ï¼Œä½†å½“å®ƒä»¬ç§¯ç´¯æ—¶ï¼Œä¼šè€—å°½è¿›ç¨‹è¡¨ï¼Œé˜»æ­¢æ–°è¿›ç¨‹çš„å¯åŠ¨ã€‚\nåœ¨æœ¬åœ°ï¼Œæˆ‘çš„ Go äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥æ­£å¸¸å›æ”¶è¿›ç¨‹ã€‚ä½†åœ¨è¿œç¨‹ï¼Œåƒµå°¸è¿›ç¨‹ä»ç„¶å­˜åœ¨ã€‚å…³é”®åŒºåˆ«åœ¨äºè¿œç¨‹æœåŠ¡å™¨åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œäº† Stormkitã€‚\nDocker çš„åƒµå°¸è¿›ç¨‹é—®é¢˜ Docker å°† PID 1 åˆ†é…ç»™å®¹å™¨çš„å…¥å£ç‚¹ï¼ˆå³æˆ‘ä»¬çš„ Go äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€‚åœ¨ Linux ä¸­ï¼ŒPID 1ï¼ˆ init/systemd ï¼‰è´Ÿè´£æ”¶å…»å­¤å„¿è¿›ç¨‹å¹¶å›æ”¶å…¶è‡ªèº«çš„åƒµå°¸å­è¿›ç¨‹ï¼ŒåŒ…æ‹¬å®ƒå·²ç»æ”¶å…»çš„å‰å­¤å„¿è¿›ç¨‹ã€‚å¦‚æœ PID 1 æ²¡æœ‰å¤„ç† SIGCHLD ä¿¡å·å¹¶è°ƒç”¨ waitï¼Œåƒµå°¸è¿›ç¨‹å°±ä¼šç´¯ç§¯ã€‚æˆ‘ä»¬çš„ Go ç¨‹åºå¹¶æ²¡æœ‰è®¾è®¡æˆä¸€ä¸ªåˆå§‹åŒ–ç³»ç»Ÿï¼Œæ‰€ä»¥å®ƒå¿½ç•¥äº†å­¤å„¿è¿›ç¨‹ã€‚\nè§£å†³æ–¹æ¡ˆï¼šTini ç»è¿‡è¿›ä¸€æ­¥è°ƒæŸ¥ï¼Œæˆ‘å‘ç°å›æ”¶åƒµå°¸è¿›ç¨‹æ˜¯ Docker é•¿æœŸå­˜åœ¨çš„é—®é¢˜ï¼Œæ‰€ä»¥å¸‚åœºä¸Šå·²ç»æœ‰äº†è§£å†³æ–¹æ¡ˆã€‚æœ€ç»ˆæˆ‘æ‰¾åˆ°äº† Tiniï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ºå®¹å™¨è®¾è®¡çš„è½»é‡çº§åˆå§‹åŒ–ç³»ç»Ÿã€‚Tini ä½œä¸º PID 1 è¿è¡Œï¼Œé€šè¿‡å¤„ç† SIGCHLD å’Œ wait æ‰€æœ‰è¿›ç¨‹æ¥æ­£ç¡®å›æ”¶åƒµå°¸è¿›ç¨‹ã€‚æˆ‘æ›´æ–°äº†æˆ‘ä»¬çš„ Dockerfileï¼š\n1 2 ENTRYPOINT [\u0026#34;/usr/bin/tini\u0026#34;, \u0026#34;--\u0026#34;] CMD [\u0026#34;/app/stormkit\u0026#34;] æˆ–è€…ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ Docker çš„ \u0026ndash;init æ ‡å¿—ï¼Œè¯¥æ ‡å¿—ä¼šè‡ªåŠ¨æ·»åŠ  Tiniã€‚\nä½¿ç”¨ Tini éƒ¨ç½²åï¼Œ ps aux å¹²å‡€äº†â€”â€”æ²¡æœ‰åƒµå°¸è¿›ç¨‹ï¼ğŸ‰ æœåŠ¡å™¨ç¨³å®šäº†ï¼ŒRedis é”™è¯¯æ¶ˆå¤±äº†ï¼Œå› ä¸ºå®ƒä»¬æ˜¯èµ„æºè€—å°½çš„å‰¯ä½œç”¨ã€‚\næ€»ç»“ Go è¿›ç¨‹ç®¡ç†ï¼šos.Process.Kill ä¸å¤„ç†å­è¿›ç¨‹ã€‚ä½¿ç”¨è¿›ç¨‹ç»„æˆ–é€‚å½“çš„ä¿¡å·å¤„ç†ä»¥å®ç°å¹²å‡€ç»ˆæ­¢ã€‚ Docker PID 1ï¼šå¦‚æœä½ çš„åº”ç”¨ç¨‹åºä½œä¸º PID 1 è¿è¡Œï¼Œå®ƒéœ€è¦å›æ”¶åƒµå°¸è¿›ç¨‹æˆ–å§”æ‰˜ç»™åƒ Tini è¿™æ ·çš„åˆå§‹åŒ–ç³»ç»Ÿã€‚ è°ƒè¯•æç¤ºï¼šå¤„ç†å´©æºƒæ—¶ï¼Œè¯·å§‹ç»ˆæ£€æŸ¥ ps aux æŸ¥çœ‹è¿›ç¨‹ã€‚ æ ¹æœ¬åŸå› å¾ˆé‡è¦ï¼šRedis é”™è¯¯åªæ˜¯ä¸€ä¸ªè¯¯å¯¼â€”â€”åƒµå°¸è¿›ç¨‹å¯¼è‡´çš„å†…å­˜è€—å°½æ‰æ˜¯çœŸæ­£çš„é—®é¢˜ã€‚ å‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Hunting Zombie Processes in Go and Docker ","date":"2025-04-25T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%9C%A8-go-%E5%92%8C-docker-%E4%B8%AD%E6%90%9C%E5%AF%BB%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B/","title":"åœ¨ Go å’Œ Docker ä¸­æœå¯»åƒµå°¸è¿›ç¨‹"},{"content":"ä»€ä¹ˆæ˜¯å¼±æŒ‡é’ˆå‘¢? å¼±æŒ‡é’ˆåŸºæœ¬ä¸Šæ˜¯ä¸€ç§å¼•ç”¨ä¸€å—å†…å­˜è€Œä¸é”å®šå®ƒçš„æ–¹æ³•ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰å…¶ä»–äººä¸»åŠ¨æŒæœ‰å®ƒï¼Œåƒåœ¾æ”¶é›†å™¨å¯ä»¥æ¸…ç†å®ƒã€‚\nä¸ºä»€ä¹ˆè¿˜è¦ä¸ºå¼±æŒ‡é’ˆçƒ¦æ¼å‘¢ï¼Ÿ Go æœ‰å—ï¼Ÿ\nå—¯ï¼Œæ˜¯çš„ï¼ŒGo ç¡®å®æœ‰å¼±æŒ‡é’ˆçš„æ¦‚å¿µã€‚å®ƒæ˜¯å¼±åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œä¸ Go è¿è¡Œæ—¶ç´§å¯†ç›¸è¿ã€‚æœ‰è¶£çš„æ˜¯ï¼Œå®ƒæ›¾ç»æ›´å¤šåœ°æ˜¯ä¸€ä¸ªå†…éƒ¨å·¥å…·ï¼Œä½†æœ€è¿‘æœ‰äººé€šè¿‡è¿™ä¸ªææ¡ˆæ¨åŠ¨å°†å…¶å…¬å¼€ã€‚\nå¾ˆé…·ï¼Œå¯¹å§ï¼Ÿ\nå¼±æŒ‡é’ˆçš„å…³é”®æ˜¯å®ƒä»¬æ˜¯å®‰å…¨çš„ã€‚å¦‚æœå®ƒä»¬æŒ‡å‘çš„å†…å­˜è¢«æ¸…ç†ï¼Œå¼±æŒ‡é’ˆä¼šè‡ªåŠ¨å˜ä¸ºnilå› æ­¤ä¸å­˜åœ¨æ„å¤–æŒ‡å‘å·²é‡Šæ”¾å†…å­˜çš„é£é™©ã€‚å½“æ‚¨ç¡®å®éœ€è¦ä¿ç•™è¯¥å†…å­˜æ—¶ï¼Œå¯ä»¥å°†å¼±æŒ‡é’ˆè½¬æ¢ä¸ºå¼ºæŒ‡é’ˆã€‚è¿™ä¸ªå¼ºæŒ‡é’ˆå‘Šè¯‰åƒåœ¾æ”¶é›†å™¨ï¼Œâ€œå˜¿ï¼Œå½“æˆ‘ä½¿ç”¨å®ƒæ—¶ï¼Œè¯·æŠŠå®ƒæ”¾å¼€ã€‚â€\nç­‰ç­‰ï¼Œå®ƒå°±è‡ªåŠ¨å˜æˆ nil äº†ï¼Ÿè¿™å¬èµ·æ¥â€¦â€¦æœ‰é£é™©\næ˜¯çš„ï¼Œå¼±æŒ‡é’ˆè‚¯å®šä¼šå˜æˆnilæœ‰æ—¶åœ¨ä½ æ„æƒ³ä¸åˆ°çš„æ—¶åˆ»ã€‚\nå®ƒä»¬æ¯”å¸¸è§„æŒ‡é’ˆæ›´éš¾ä½¿ç”¨ã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œå¦‚æœå¼±æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜è¢«æ¸…ç†ï¼Œå®ƒå°±å¯ä»¥å˜æˆnil ã€‚å½“æ²¡æœ‰å¼ºæŒ‡é’ˆæŒæœ‰è¯¥å†…å­˜æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚å› æ­¤ï¼Œå§‹ç»ˆæ£€æŸ¥åˆšåˆšä»å¼±æŒ‡é’ˆè½¬æ¢è€Œæ¥çš„å¼ºæŒ‡é’ˆæ˜¯å¦ä¸ºniléå¸¸é‡è¦ã€‚\nç°åœ¨ï¼Œå…³äºæ¸…ç†ä½•æ—¶å‘ç”Ÿâ€”â€”å®ƒä¸æ˜¯ç«‹å³å‘ç”Ÿçš„ã€‚å³ä½¿æ²¡æœ‰äººå¼•ç”¨å†…å­˜ï¼Œæ¸…ç†æ—¶é—´ä¹Ÿå®Œå…¨å–å†³äºåƒåœ¾æ”¶é›†å™¨ã€‚\nç°åœ¨ï¼Œå±•ç¤ºä¸€äº›ä»£ç ã€‚\nåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå¼±åŒ…å°šæœªæ­£å¼å‘å¸ƒã€‚é¢„è®¡å°†åœ¨ Go 1.24 ä¸­è½åœ°ã€‚ä½†æˆ‘ä»¬å¯ä»¥å·çœ‹ä¸€ä¸‹æºä»£ç å¹¶å°è¯•ä¸€ä¸‹ã€‚è¯¥è½¯ä»¶åŒ…ä¸ºæ‚¨æä¾›äº†ä¸¤ä¸ªä¸»è¦çš„ APIï¼š\nweak.Make ï¼šä»å¼ºæŒ‡é’ˆåˆ›å»ºå¼±æŒ‡é’ˆã€‚ weak.Pointer[T].Strong ï¼šå°†å¼±æŒ‡é’ˆè½¬æ¢å›å¼ºæŒ‡é’ˆã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type T struct { a int b int } func main() { a := new(string) println(\u0026#34;original:\u0026#34;, a) // make a weak pointer weakA := weak.Make(a) runtime.GC() // use weakA strongA := weakA.Strong() println(\u0026#34;strong:\u0026#34;, strongA, a) runtime.GC() // use weakA again strongA = weakA.Strong() println(\u0026#34;strong:\u0026#34;, strongA) } // Output: // original: 0x1400010c670 // strong: 0x1400010c670 0x1400010c670 // strong: 0x0 è¿™æ˜¯ä»£ç ä¸­å‘ç”Ÿçš„äº‹æƒ…ï¼š\nåœ¨ç¬¬ä¸€æ¬¡åƒåœ¾å›æ”¶ï¼ˆ runtime.GC() ï¼‰ä¹‹åï¼Œå¼±æŒ‡é’ˆweakAä»ç„¶æŒ‡å‘å†…å­˜ï¼Œå› ä¸ºæˆ‘ä»¬ä»åœ¨ä½¿ç”¨å˜é‡a println(\u0026quot;strong:\u0026quot;, strongA, a) çº¿ã€‚ç”±äºå†…å­˜æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œå› æ­¤è¿˜æ— æ³•æ¸…ç†ã€‚ ä½†æ˜¯å½“ç¬¬äºŒæ¬¡åƒåœ¾æ”¶é›†è¿è¡Œæ—¶ï¼Œå¼ºå¼•ç”¨ï¼ˆ a ï¼‰ä¸å†ä½¿ç”¨ã€‚è¿™æ„å‘³ç€åƒåœ¾æ”¶é›†å™¨å¯ä»¥å®‰å…¨åœ°æ¸…ç†å†…å­˜ï¼Œè®©weakA.Strong()è¿”å›nil ã€‚ ç°åœ¨ï¼Œå¦‚æœæ‚¨å°è¯•ä½¿ç”¨stringæŒ‡é’ˆä»¥å¤–çš„å…¶ä»–å†…å®¹ï¼ˆä¾‹å¦‚*int ã€ *boolæˆ–å…¶ä»–ç±»å‹ï¼‰æ¥å°è¯•æ­¤ä»£ç ï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸åŒçš„è¡Œä¸ºï¼Œæœ€åä¸€ä¸ªstrongè¾“å‡ºå¯èƒ½ä¸æ˜¯nil ã€‚\nè¿™ä¸ Go å¦‚ä½•å¤„ç†int ã€ bool ã€ float32 ã€ float64ç­‰â€œå¾®å°å¯¹è±¡â€æœ‰å…³ã€‚è¿™äº›ç±»å‹è¢«åˆ†é…ä¸ºå¾®å°å¯¹è±¡ï¼Œå³ä½¿å®ƒä»¬åœ¨æŠ€æœ¯ä¸Šæœªä½¿ç”¨ï¼Œåƒåœ¾æ”¶é›†å™¨ä¹Ÿå¯èƒ½ä¸ä¼šç«‹å³æ¸…ç†å®ƒä»¬åœ¨åƒåœ¾æ”¶é›†æœŸé—´ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æ›´æ·±å…¥åœ°ç ”ç©¶Go Runtime Finalizer å’Œ Keep Aliveä¸­çš„å¾®å°å¯¹è±¡åˆ†é…ã€‚\nå¼±æŒ‡é’ˆå¯¹äºç‰¹å®šåœºæ™¯ä¸‹çš„å†…å­˜ç®¡ç†éå¸¸å®ç”¨ã€‚\nä¾‹å¦‚ï¼Œå®ƒä»¬éå¸¸é€‚åˆè§„èŒƒåŒ–æ˜ å°„ - æ‚¨åªæƒ³ä¿ç•™ä¸€ä»½æ•°æ®çš„ä¸€ä»½å‰¯æœ¬çš„æƒ…å†µã€‚è¿™ä¸æˆ‘ä»¬ä¹‹å‰å…³äºå­—ç¬¦ä¸²é©»ç•™çš„è®¨è®ºæœ‰å…³ã€‚ å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œå½“æ‚¨å¸Œæœ›æŸäº›å†…å­˜çš„å¯¿å‘½ä¸å¦ä¸€ä¸ªå¯¹è±¡çš„å¯¿å‘½ç›¸åŒ¹é…æ—¶ï¼Œç±»ä¼¼äº JavaScript çš„ WeakMap çš„å·¥ä½œæ–¹å¼ã€‚ WeakMap å…è®¸å¯¹è±¡åœ¨ä¸å†ä½¿ç”¨æ—¶è‡ªåŠ¨æ¸…ç†ã€‚ å› æ­¤ï¼Œå¼±æŒ‡é’ˆçš„ä¸»è¦å¥½å¤„æ˜¯å®ƒä»¬å¯ä»¥è®©ä½ å‘Šè¯‰åƒåœ¾æ”¶é›†å™¨ï¼Œ *â€œå˜¿ï¼Œå¦‚æœæ²¡æœ‰äººä½¿ç”¨è¿™ä¸ªèµ„æºï¼Œå°±å¯ä»¥åˆ é™¤å®ƒâ€”â€”æˆ‘ä»¥åå¯ä»¥éšæ—¶é‡æ–°åˆ›å»ºå®ƒã€‚â€*è¿™å¯¹äºå ç”¨å¤§é‡å†…å­˜ä½†ä¸éœ€è¦ä¿ç•™çš„å¯¹è±¡éå¸¸æœ‰æ•ˆï¼Œé™¤éå®ƒä»¬æ­£åœ¨è¢«ç§¯æä½¿ç”¨ã€‚\nå¼±æŒ‡é’ˆå¦‚ä½•å·¥ä½œï¼Ÿ\næœ‰è¶£çš„æ˜¯ï¼Œå¼±æŒ‡é’ˆå®é™…ä¸Šå¹¶ä¸ç›´æ¥æŒ‡å‘å®ƒä»¬å¼•ç”¨çš„å†…å­˜ã€‚ç›¸åï¼Œå®ƒä»¬æ˜¯åŒ…å«â€œé—´æ¥å¯¹è±¡â€çš„ç®€å•ç»“æ„ï¼ˆä½¿ç”¨æ³›å‹ï¼‰ã€‚è¿™ä¸ªå¯¹è±¡å¾ˆå°ï¼Œåªæœ‰ 8 ä¸ªå­—èŠ‚ï¼Œå®ƒæŒ‡å‘å®é™…çš„å†…å­˜ç›®æ ‡ã€‚\n1 2 3 type Pointer[T any] struct { u unsafe.Pointer } ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡å‘¢ï¼Ÿ\næ­¤è®¾ç½®ä½¿åƒåœ¾æ”¶é›†å™¨å¯ä»¥é«˜æ•ˆåœ°ä¸€æ¬¡æ€§æ¸…ç†æŒ‡å‘ç‰¹å®šå¯¹è±¡çš„å¼±æŒ‡é’ˆã€‚å½“å®ƒå†³å®šåº”è¯¥é‡Šæ”¾å†…å­˜æ—¶ï¼Œæ”¶é›†å™¨åªéœ€å°†é—´æ¥å¯¹è±¡ä¸­çš„æŒ‡é’ˆè®¾ç½®ä¸ºnil ï¼ˆæˆ–0x0 ï¼‰ã€‚å®ƒä¸å¿…å•ç‹¬æ›´æ–°æ¯ä¸ªå¼±æŒ‡é’ˆã€‚\næœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªè®¾è®¡æ”¯æŒç›¸ç­‰æ£€æŸ¥ï¼ˆ == ï¼‰ã€‚ä»åŒä¸€åŸå§‹æŒ‡é’ˆåˆ›å»ºçš„å¼±æŒ‡é’ˆå°†è¢«è§†ä¸ºâ€œç›¸ç­‰â€ï¼Œå³ä½¿å®ƒä»¬æŒ‡å‘çš„å¯¹è±¡å·²è¢«åƒåœ¾å›æ”¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main() { a := new(string) // make a weak pointers weakA := weak.Make(a) weakA2 := weak.Make(a) println(\u0026#34;Before GC - Equality check:\u0026#34;, weakA == weakA2) runtime.GC() // Test their equality println(\u0026#34;After GC - Strong:\u0026#34;, weakA.Strong(), weakA2.Strong()) println(\u0026#34;After GC - Equality check:\u0026#34;, weakA == weakA2) } // Before GC - Equality check: true // After GC - Strong: 0x0 0x0 // After GC - Equality check: true è¿™æ˜¯å¯è¡Œçš„ï¼Œå› ä¸ºæ¥è‡ªåŒä¸€åŸå§‹å¯¹è±¡çš„å¼±æŒ‡é’ˆå…±äº«ç›¸åŒçš„é—´æ¥å¯¹è±¡ã€‚å½“æ‚¨è°ƒç”¨weak.Makeæ—¶ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„å¼±æŒ‡é’ˆï¼Œåˆ™ç°æœ‰çš„é—´æ¥å¯¹è±¡å°†è¢«é‡ç”¨ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚\nç­‰ç­‰ï¼Œä½¿ç”¨ 8 ä¸ªå­—èŠ‚ä½œä¸ºé—´æ¥å¯¹è±¡ä¸æ˜¯æœ‰ç‚¹æµªè´¹å—ï¼Ÿ\nçœ‹èµ·æ¥å¥½åƒæ˜¯è¿™æ ·ï¼Œä½†ä½œè€…ä¼šè¯´ï¼Œè¿™å¹¶ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ã€‚å¼±æŒ‡é’ˆé€šå¸¸ç”¨äºæ€»ä½“ç›®æ ‡æ˜¯èŠ‚çœå†…å­˜çš„æƒ…å†µã€‚ä¾‹å¦‚ï¼Œåœ¨è§„èŒƒåŒ–æ˜ å°„ä¸­ï¼ˆé€šè¿‡ä»…ä¿ç•™æ¯ä¸ªå”¯ä¸€æ•°æ®çš„ä¸€ä»½å‰¯æœ¬æ¥æ¶ˆé™¤é‡å¤é¡¹ï¼‰ï¼Œæ‚¨å·²ç»é€šè¿‡é¿å…å†—ä½™èŠ‚çœäº†å¤§é‡å†…å­˜ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ‚¨å­˜åœ¨å¤§é‡å”¯ä¸€é¡¹å’Œå¾ˆå°‘é‡å¤é¡¹çš„æƒ…å†µä¸‹ä½¿ç”¨å¼±æŒ‡é’ˆï¼Œåˆ™æœ€ç»ˆå¯èƒ½ä¼šä½¿ç”¨æ¯”é¢„æœŸæ›´å¤šçš„å†…å­˜ã€‚å› æ­¤ï¼Œåœ¨å†³å®šå¼±æŒ‡é’ˆæ˜¯å¦æ˜¯é€‚åˆè¯¥å·¥ä½œçš„å·¥å…·æ—¶ï¼Œè€ƒè™‘å…·ä½“ç”¨ä¾‹éå¸¸é‡è¦ã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Weak Pointers in Go: Why They Matter Now\n","date":"2024-12-01T00:00:00Z","permalink":"https://blog.golang.space/p/go-%E4%B8%AD%E7%9A%84%E5%BC%B1%E6%8C%87%E9%92%88%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BB%96%E4%BB%AC%E7%8E%B0%E5%9C%A8%E5%BE%88%E9%87%8D%E8%A6%81/","title":"Go ä¸­çš„å¼±æŒ‡é’ˆ:ä¸ºä»€ä¹ˆä»–ä»¬ç°åœ¨å¾ˆé‡è¦?"},{"content":"typora åœ¨å¯¼å‡º HTML æ–‡ä»¶æ—¶ï¼Œå…¶å›¾ç‰‡ä½ç½®æ˜¯æ ¹æ®å†™ markdown æ—¶é—´å®šä¹‰çš„ï¼Œæ¯”å¦‚åœ¨ markdown ä¸­æ˜¯ç½‘ç»œå›¾ç‰‡ï¼Œåˆ™å¯¼å‡º HTML ä¹Ÿæ˜¯ç½‘ç»œå›¾ç‰‡ã€‚\nå›¾ç‰‡åœ¨ç¼–è¾‘è€…æœ¬åœ°ï¼Œæˆ–å›¾ç‰‡åœ¨ç½‘ç»œä½† HTML ä½¿ç”¨åœ¨ç¦»çº¿ç¯å¢ƒï¼Œæ­¤æ—¶å›¾ç‰‡æ˜¯æ— æ³•æ­£ç¡®åŠ è½½çš„ã€‚\né€šè¿‡è®¾ç½® typora å¯¼å‡ºåæ‰§è¡Œå‘½ä»¤ï¼Œå°†å›¾ç‰‡æ›¿æ¢æˆ base64 æ¥è§£å†³ä»¥ä¸Šé—®é¢˜ã€‚\næµ‹è¯•ç¯å¢ƒ typora 1.9.4\nMacbook Pro\nè§£å†³æ–¹æ¡ˆ åœ¨ typora å¯¼å‡ºè®¾ç½®ä¸­ï¼Œç»™ html ç±»å‹å¯¼å‡ºåæ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤ ~/typora_format_html ${outputPath}ï¼Œ``~/typora_format_htmlæ˜¯ç”¨äºæ ¼å¼åŒ– html çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œ${outputPath}` æ˜¯å¯¼å‡ºåçš„æ–‡ä»¶è·¯å¾„ã€‚ ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶ https://github.com/ixugo/typora_plugin/releases/tag/v0.0.1 æ­¤å¯æ‰§è¡Œæ–‡ä»¶ç”± Golang ç¼–å†™ï¼Œä¸‹è½½åå­˜æ”¾è·¯å¾„è¦ä¸ç¬¬ä¸€æ­¥ä¸­å¡«å†™è·¯å¾„åç§°ç›¸åŒã€‚\næ­£å¸¸æ‰§è¡Œå¯¼å‡º HTML æ“ä½œï¼ŒæŸ¥çœ‹æ–‡ä»¶å¯ä»¥å‘ç°å›¾ç‰‡å·²ç»æ˜¯ base64ã€‚\n","date":"2024-12-01T00:00:00Z","permalink":"https://blog.golang.space/p/typora-%E5%AF%BC%E5%87%BA%E5%B8%A6%E5%9B%BE%E7%89%87%E7%9A%84-html/","title":"typora å¯¼å‡ºå¸¦å›¾ç‰‡çš„ html"},{"content":"HTTP/1.1 å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡ç¤ºä¾‹ã€‚\n1 2 3 4 5 m := http.NewServeMux() m.HandleFunc(\u0026#34;/proto\u0026#34;, func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(r.Proto)) }) go http.ListenAndServe(\u0026#34;:8080\u0026#34;, m) H2C h2c æ˜¯æœªåŠ å¯†çš„ http/2 åè®®ï¼Œå¯åŠ¨ä¸€ä¸ª h2c æœåŠ¡ç¤ºä¾‹ã€‚\n1 2 3 4 5 6 m := http.NewServeMux() m.HandleFunc(\u0026#34;/proto\u0026#34;, func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(r.Proto)) }) h := h2c.NewHandler(m, \u0026amp;http2.Server{IdleTimeout: time.Minute}) go http.ListenAndServe(\u0026#34;:8080\u0026#34;, h) å®¢æˆ·ç«¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 cli := \u0026amp;http.Client{ Timeout: 10 * time.Second, Transport: \u0026amp;http2.Transport{ AllowHTTP: true, DialTLSContext: func(ctx context.Context, network, addr string, cfg *tls.Config) (net.Conn, error) { var dialer net.Dialer return dialer.DialContext(ctx, network, addr) }, }, } { resp, err := cli.Get(\u0026#34;http://localhost:8080/proto\u0026#34;) if err != nil { t.Fatal(err) } defer resp.Body.Close() data, err := io.ReadAll(resp.Body) if err != nil { t.Fatal(err) } fmt.Println(\u0026#34;h2c\u0026#34;, string(data)) } h2c å®¢æˆ·ç«¯è¯·æ±‚ h2c æœåŠ¡ç«¯ï¼Œå¯ä»¥ä»ä¸‹é¢æˆªå›¾çœ‹å‡ºåè®®æ˜¯ HTTP/2.0ã€‚\nh1 å®¢æˆ·ç«¯è¯·æ±‚ h2c æœåŠ¡ç«¯ï¼Œåè®®ä¸º HTTP/1.1ã€‚\né‚£å¦‚æœ h2c å®¢æˆ·ç«¯è¯·æ±‚ h1 æœåŠ¡ç«¯å‘¢? å°†ä¼šæ”¶è·ä»¥ä¸‹é”™è¯¯ã€‚\nGet \u0026quot;http://localhost:8080/proto\u0026quot;: read tcp [::1]:61776-\u0026gt;[::1]:8080: read: connection reset by peer\næˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç° RoundTrip æ¥å£ï¼Œå½“ h2c è¿æ¥ä¸ä¸Šæ—¶ï¼Œé™çº§åˆ° h1 ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // CustomTransport å®ç° HTTP/2 å›é€€åˆ° HTTP/1.1 çš„é€»è¾‘ type CustomTransport struct { h2cTransport *http2.Transport h1Transport *http.Transport } func NewCustomTransport() *CustomTransport { return \u0026amp;CustomTransport{ h2cTransport: \u0026amp;http2.Transport{ AllowHTTP: true, DialTLSContext: func(ctx context.Context, network, addr string, _ *tls.Config) (net.Conn, error) { var dialer net.Dialer return dialer.DialContext(ctx, network, addr) }, IdleConnTimeout: time.Minute, }, h1Transport: \u0026amp;http.Transport{ IdleConnTimeout: time.Minute, }, } } func (f *CustomTransport) RoundTrip(req *http.Request) (*http.Response, error) { // ä½¿ç”¨ HTTP/2 Transport ä½œä¸ºé»˜è®¤ä¼ è¾“ resp, err := f.h2cTransport.RoundTrip(req) if err != nil { // å¦‚æœ HTTP/2 å¤±è´¥ï¼Œå›é€€åˆ° HTTP/1.1 è¿æ¥ return f.h1Transport.RoundTrip(req) } return resp, nil } å†å°è¯•ä¸€æ¬¡è¯•è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 cli := \u0026amp;http.Client{ Timeout: 10 * time.Second, Transport: NewCustomTransport(), } { resp, err := cli.Get(\u0026#34;http://localhost:8080/proto\u0026#34;) if err != nil { t.Fatal(err) } defer resp.Body.Close() data, err := io.ReadAll(resp.Body) if err != nil { t.Fatal(err) } fmt.Println(\u0026#34;h2c\u0026#34;, string(data)) } ","date":"2024-10-25T00:00:00Z","permalink":"https://blog.golang.space/p/go-h2c/","title":"Go H2C"},{"content":"å¯¹äº Go ç¨‹åºå‘˜æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¿«å°±ä¼šæ­»è®°ç¡¬èƒŒçš„ä¹ æƒ¯ç”¨æ³•ï¼šæ¯å½“ä½ æƒ³å‡ºä¸€ä¸ªå®ç°io.Closeræ¥å£çš„å€¼æ—¶ï¼Œåœ¨æ£€æŸ¥é”™è¯¯åï¼Œä½ ä¼šç«‹å³deferå…¶Close()æ–¹æ³•ã€‚åœ¨å‘å‡º HTTP è¯·æ±‚æ—¶æœ€å¸¸çœ‹åˆ°è¿™ç§æƒ…å†µï¼š\n1 2 3 4 5 resp, err := http.Get(\u0026#34;https://joeshaw.org\u0026#34;) if err != nil { return err } defer resp.Body.Close() æˆ–æ‰“å¼€æ–‡ä»¶ï¼š\n1 2 3 4 5 f, err := os.Open(\u0026#34;/home/joeshaw/notes.txt\u0026#34;) if err != nil { return err } defer f.Close() ä½†è¿™ç§ä¹ æƒ¯ç”¨æ³•å®é™…ä¸Šå¯¹å¯å†™æ–‡ä»¶æœ‰å®³ï¼Œå› ä¸ºå»¶è¿Ÿå‡½æ•°è°ƒç”¨ä¼šå¿½ç•¥å…¶è¿”å›å€¼ï¼Œå¹¶ä¸”Close()æ–¹æ³•å¯èƒ½ä¼šè¿”å›é”™è¯¯ã€‚å¯¹äºå¯å†™æ–‡ä»¶ï¼ŒGo ç¨‹åºå‘˜åº”è¯¥é¿å…deferä¹ æƒ¯ç”¨æ³•ï¼Œå¦åˆ™ä¼šå‡ºç°éå¸¸ç½•è§çš„ä»¤äººæŠ“ç‹‚çš„é”™è¯¯ã€‚\nä¸ºä»€ä¹ˆæ‚¨ä¼šä»Close()ä¸­æ”¶åˆ°é”™è¯¯ï¼Œä½†åœ¨ä¹‹å‰çš„Write()è°ƒç”¨ä¸­å´æ²¡æœ‰æ”¶åˆ°é”™è¯¯ï¼Ÿä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è¡¥å……ä¸€ä¸‹è®¡ç®—æœºä½“ç³»ç»“æ„é¢†åŸŸçŸ¥è¯†ã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œå½“ä½ ä» CPU å‘å¤–ç§»åŠ¨æ—¶ï¼Œæ“ä½œçš„é€Ÿåº¦ä¼šå˜å¾—æ…¢å‡ ä¸ªæ•°é‡çº§ã€‚å†™å…¥ CPU å¯„å­˜å™¨éå¸¸å¿«ã€‚è®¿é—®ç³»ç»Ÿ RAM ç›¸å¯¹è¾ƒæ…¢ã€‚è¿›è¡Œç£ç›˜æˆ–ç½‘ç»œ I/O åˆ™æ…¢å¾—å¤šã€‚\nå¦‚æœæ¯ä¸ªWrite()è°ƒç”¨éƒ½å°†æ•°æ®åŒæ­¥æäº¤åˆ°ç£ç›˜ï¼Œæˆ‘ä»¬ç³»ç»Ÿçš„æ€§èƒ½å°†ä¼šæ…¢å¾—æ— æ³•ä½¿ç”¨ã€‚è™½ç„¶åŒæ­¥å†™å…¥å¯¹äºæŸäº›ç±»å‹çš„è½¯ä»¶ï¼ˆä¾‹å¦‚æ•°æ®åº“ï¼‰éå¸¸é‡è¦ï¼Œä½†å¤§å¤šæ•°æ—¶å€™å®ƒæ˜¯å¤šä½™çš„ã€‚\næœ€ç³Ÿç³•çš„æƒ…å†µæ˜¯ä¸€æ¬¡å†™å…¥ä¸€ä¸ªå­—èŠ‚åˆ°æ–‡ä»¶ä¸­ã€‚ç¡¬ç›˜é©±åŠ¨å™¨â€”â€”ç²—æš´çš„æœºæ¢°è®¾å¤‡â€”â€”éœ€è¦å°†ç£å¤´ç‰©ç†ç§»åŠ¨åˆ°ç›˜ç‰‡ä¸Šçš„ä½ç½®ï¼Œå¹¶å¯èƒ½éœ€è¦ç­‰å¾…æ•´ç›˜çš„æ—‹è½¬æ‰èƒ½å°†æ•°æ®æŒä¹…åŒ–ã€‚å›ºæ€ç¡¬ç›˜ï¼ˆSSDï¼‰ï¼Œå®ƒä»¬ä»¥å—çš„å½¢å¼å­˜å‚¨æ•°æ®ï¼Œå¹¶ä¸”æ¯ä¸ªå—çš„å†™å…¥å‘¨æœŸæ˜¯æœ‰é™çš„ï¼Œä¼šå› ä¸ºå—è¢«åå¤å†™å…¥å’Œè¦†ç›–è€Œè¿…é€Ÿç£¨æŸã€‚\nå¹¸è¿çš„æ˜¯ï¼Œè¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºç¡¬ä»¶å’Œè½¯ä»¶çš„å¤šä¸ªå±‚æ¬¡å®ç°äº†ç¼“å­˜å’Œå†™å…¥ç¼“å†²ã€‚å½“ä½ è°ƒç”¨ Write() æ—¶ï¼Œæ•°æ®ä¸ä¼šç«‹å³è¢«å†™å…¥åˆ°ä»‹è´¨ä¸Šã€‚æ“ä½œç³»ç»Ÿã€å­˜å‚¨æ§åˆ¶å™¨å’Œä»‹è´¨æœ¬èº«éƒ½åœ¨ç¼“å­˜æ•°æ®ï¼Œä»¥ä¾¿å°†è¾ƒå°çš„å†™å…¥æ“ä½œæ‰¹é‡å¤„ç†ï¼Œä¼˜åŒ–æ•°æ®åœ¨ä»‹è´¨ä¸Šçš„å­˜å‚¨ï¼Œå¹¶å†³å®šä½•æ—¶æœ€ä½³åœ°æäº¤æ•°æ®ã€‚è¿™å°†æˆ‘ä»¬çš„å†™å…¥æ“ä½œä»ç¼“æ…¢çš„ã€é˜»å¡çš„åŒæ­¥æ“ä½œè½¬å˜ä¸ºå¿«é€Ÿçš„ã€å¼‚æ­¥çš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¸ä¼šç›´æ¥è§¦åŠæ›´æ…¢çš„ I/O è®¾å¤‡ã€‚ä¸€æ¬¡å†™å…¥ä¸€ä¸ªå­—èŠ‚ä»æ¥ä¸æ˜¯æœ€æœ‰æ•ˆçš„åšæ³•ï¼Œä½†è‡³å°‘æˆ‘ä»¬ä¸ä¼šå› ä¸ºè¿™æ ·åšè€Œè€—æŸç¡¬ä»¶ã€‚\nå½“ç„¶ï¼Œè¿™äº›å­—èŠ‚æœ€ç»ˆå¿…é¡»è¢«å†™å…¥ç£ç›˜ã€‚æ“ä½œç³»ç»ŸçŸ¥é“å½“æˆ‘ä»¬å…³é—­ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¯¹å®ƒçš„æ“ä½œï¼Œä¸ä¼šæœ‰åç»­çš„å†™å…¥æ“ä½œå‘ç”Ÿã€‚å®ƒè¿˜çŸ¥é“å…³é—­æ–‡ä»¶æ˜¯å®ƒæœ€åä¸€æ¬¡å‘Šè¯‰æˆ‘ä»¬æ˜¯å¦å‡ºç°äº†é—®é¢˜çš„æœºä¼šã€‚\nåœ¨ Linux å’Œ macOS ç­‰ POSIX ç³»ç»Ÿä¸Šï¼Œå…³é—­æ–‡ä»¶æ˜¯é€šè¿‡closeç³»ç»Ÿè°ƒç”¨æ¥å¤„ç†çš„ã€‚ close(2)çš„ BSD æ‰‹å†Œé¡µè®¨è®ºäº†å®ƒå¯èƒ½è¿”å›çš„é”™è¯¯ï¼š\n1 2 3 4 5 6 7 8 9 ERRORS The close() system call will fail if: [EBADF] fildes is not a valid, active file descriptor. [EINTR] Its execution was interrupted by a signal. [EIO] A previously-uncommitted write(2) encountered an input/output error. EIO æ­£æ˜¯æˆ‘ä»¬æ‹…å¿ƒçš„é”™è¯¯ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åœ¨å°è¯•å°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜æ—¶ä¸¢å¤±äº†æ•°æ®ï¼Œæˆ‘ä»¬çš„ Go ç¨‹åºåœ¨è¿™ç§æƒ…å†µä¸‹ç»å¯¹ä¸åº”è¿”å› nil é”™è¯¯ã€‚\nè§£å†³è¿™ä¸ªé—®é¢˜æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯åœ¨å†™å…¥æ–‡ä»¶æ—¶ä¸ä½¿ç”¨defer ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 func helloNotes() error { f, err := os.Create(\u0026#34;/home/joeshaw/notes.txt\u0026#34;) if err != nil { return err } if err = io.WriteString(f, \u0026#34;hello world\u0026#34;); err != nil { f.Close() return err } return f.Close() } è¿™ç¡®å®æ„å‘³ç€åœ¨å‡ºç°é”™è¯¯æ—¶éœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œé¢å¤–çš„è®°å½•ï¼šåœ¨io.WriteString()å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¾å¼å…³é—­å®ƒï¼ˆå¹¶å¿½ç•¥å®ƒçš„é”™è¯¯ï¼Œå› ä¸ºå†™å…¥é”™è¯¯ä¼˜å…ˆï¼‰ã€‚ä½†å®ƒå¾ˆæ¸…æ™°ã€ç›´æ¥ï¼Œå¹¶ä¸”å¯ä»¥æ­£ç¡®æ£€æŸ¥f.Close()è°ƒç”¨ä¸­çš„é”™è¯¯ã€‚\næœ‰ä¸€ç§æ–¹æ³•å¯ä»¥é€šè¿‡ä½¿ç”¨å‘½åè¿”å›å€¼å’Œé—­åŒ…deferå¤„ç†è¿™ç§æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func helloNotes() (err error) { var f *os.File f, err = os.Create(\u0026#34;/home/joeshaw/notes.txt\u0026#34;) if err != nil { return } defer func() { cerr := f.Close() if err == nil { err = cerr } }() err = io.WriteString(f, \u0026#34;hello world\u0026#34;) return } æ­¤æ¨¡å¼çš„ä¸»è¦å¥½å¤„æ˜¯ä¸å¯èƒ½å¿˜è®°å…³é—­æ–‡ä»¶ï¼Œå› ä¸ºå»¶è¿Ÿå…³é—­å§‹ç»ˆä¼šæ‰§è¡Œã€‚åœ¨å…·æœ‰æ›´å¤šif err != nilæ¡ä»¶åˆ†æ”¯çš„è¾ƒé•¿å‡½æ•°ä¸­ï¼Œæ­¤æ¨¡å¼è¿˜å¯ä»¥å‡å°‘ä»£ç è¡Œæ•°å’Œé‡å¤æ¬¡æ•°ã€‚\nå°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯è§‰å¾—è¿™ç§æ¨¡å¼æœ‰ç‚¹é­”æ³•äº†ã€‚æˆ‘ä¸å–œæ¬¢ä½¿ç”¨å‘½åè¿”å›å€¼ï¼Œå¹¶ä¸”å³ä½¿å¯¹äºç»éªŒä¸°å¯Œçš„ Go ç¨‹åºå‘˜æ¥è¯´ï¼Œåœ¨æ ¸å¿ƒå‡½æ•°å®Œæˆåä¿®æ”¹è¿”å›å€¼ä¹Ÿä¸æ˜¯ç›´è§‚ä¸Šæ¸…æ¥šçš„ã€‚\næˆ‘æ„¿æ„æ¥å—æ›´å…·å¯è¯»æ€§å’Œæ˜“äºç†è§£çš„ä»£ç çš„æƒè¡¡ï¼Œå› ä¸ºéœ€è¦ä¸æ–­åœ°å®¡æŸ¥ä»£ç ä»¥ç¡®ä¿æ–‡ä»¶åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½å·²å…³é—­ï¼Œè¿™å°±æ˜¯æˆ‘åœ¨å‘å…¶ä»–äººæä¾›çš„ä»£ç å®¡æŸ¥ä¸­æ¨èçš„æ–¹æ³•ã€‚\næ›´æ–° 1\nBen Johnson åœ¨ Twitter ä¸Šå»ºè®®ï¼Œå¯¹æ–‡ä»¶å¤šæ¬¡è¿è¡ŒClose()å¯èƒ½æ˜¯å®‰å…¨çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 func doSomething() error { f, err := os.Create(\u0026#34;foo\u0026#34;) if err != nil { return err } defer f.Close() if _, err := f.Write([]byte(\u0026#34;bar\u0026#34;); err != nil { return err } return f.Close() } io.Closerä¸Šçš„ Go æ–‡æ¡£æ˜ç¡®æŒ‡å‡ºï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨åçš„æ¥å£çº§åˆ«è¡Œä¸ºæ˜¯æœªæŒ‡å®šçš„ï¼Œä½†ç‰¹å®šçš„å®ç°å¯èƒ½ä¼šè®°å½•å…¶è‡ªå·±çš„è¡Œä¸ºã€‚\nä¸å¹¸çš„æ˜¯ï¼Œ *os.Fileçš„æ–‡æ¡£å¹¶ä¸æ¸…æ¥šå®ƒçš„è¡Œä¸ºï¼Œåªæ˜¯è¯´ï¼Œâ€œClose å…³é—­æ–‡ä»¶ï¼Œä½¿å…¶æ— æ³•ç”¨äº I/Oã€‚å¦‚æœæœ‰çš„è¯ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚â€ç„¶è€Œï¼Œä» 1.8 å¼€å§‹çš„å®ç°æ˜¾ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (f *File) Close() error { if f == nil { return ErrInvalid } return f.file.close() } func (file *file) close() error { if file == nil || file.fd == badFd { return syscall.EINVAL } var err error if e := syscall.Close(file.fd); e != nil { err = \u0026amp;PathError{\u0026#34;close\u0026#34;, file.name, e} } file.fd = -1 // so it can\u0026#39;t be closed again // no need for a finalizer anymore runtime.SetFinalizer(file, nil) return err } ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œ badFdè¢«å®šä¹‰ä¸º -1 ï¼Œå› æ­¤éšåå°è¯•å…³é—­*os.Fileå°†ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œå¹¶è¿”å›syscall.EINVAL ã€‚ä½†ç”±äºæˆ‘ä»¬å¿½ç•¥äº†deferçš„é”™è¯¯ï¼Œæ‰€ä»¥è¿™å¹¶ä¸é‡è¦ã€‚ç¡®åˆ‡åœ°è¯´ï¼Œå®ƒä¸æ˜¯å¹‚ç­‰çš„ï¼Œä½†æ­£å¦‚ Ben åæ¥åœ¨ Twitter å¸–å­ä¸­æ‰€è¯´çš„é‚£æ ·ï¼Œ â€œwonâ€™t blow shit up if you call it twice.â€\næ›´æ–° 2\nå…³é—­æ–‡ä»¶æ˜¯æ“ä½œç³»ç»Ÿå‘Šè¯‰æˆ‘ä»¬é—®é¢˜çš„æœ€åæœºä¼šï¼Œä½†å…³é—­æ–‡ä»¶æ—¶ç¼“å†²åŒºä¸ä¸€å®šä¼šè¢«åˆ·æ–°ã€‚å…³é—­æ–‡ä»¶åå®Œå…¨æœ‰å¯èƒ½å°†å†™å…¥ç¼“å†²åŒºåˆ·æ–°åˆ°ç£ç›˜ï¼Œå¹¶ä¸”æ— æ³•æ•è·å…¶ä¸­çš„æ•…éšœã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œé€šå¸¸æ„å‘³ç€å‡ºç°ä¸¥é‡é”™è¯¯ï¼Œä¾‹å¦‚ç£ç›˜å‡ºç°æ•…éšœã€‚\nä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨*os.Fileä¸Šçš„Sync()æ–¹æ³•å¼ºåˆ¶å†™å…¥ç£ç›˜ï¼Œè¯¥æ–¹æ³•è°ƒç”¨fsyncç³»ç»Ÿè°ƒç”¨ã€‚æ‚¨åº”è¯¥æ£€æŸ¥è¯¥è°ƒç”¨ä¸­çš„é”™è¯¯ï¼Œä½†æˆ‘è®¤ä¸ºå¿½ç•¥Close()ä¸­çš„é”™è¯¯æ˜¯å®‰å…¨çš„ã€‚è°ƒç”¨fsyncå¯¹æ€§èƒ½æœ‰ä¸¥é‡å½±å“ï¼šå®ƒå°†å†™å…¥ç¼“å†²åŒºåˆ·æ–°åˆ°é€Ÿåº¦è¾ƒæ…¢çš„ç£ç›˜ã€‚ä½†å¦‚æœæ‚¨çœŸçš„éå¸¸æƒ³è¦å°†æ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œé‚£ä¹ˆæœ€å¥½éµå¾ªçš„æ¨¡å¼å¯èƒ½æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 func helloNotes() error { f, err := os.Create(\u0026#34;/home/joeshaw/notes.txt\u0026#34;) if err != nil { return err } defer f.Close() if err = io.WriteString(f, \u0026#34;hello world\u0026#34;); err != nil { return err } return f.Sync() } ","date":"2024-09-17T00:00:00Z","permalink":"https://blog.golang.space/p/%E4%B8%8D%E8%A6%81%E5%9C%A8%E5%8F%AF%E5%86%99%E6%96%87%E4%BB%B6%E4%B8%8A%E5%BB%B6%E8%BF%9F-close/","title":"ä¸è¦åœ¨å¯å†™æ–‡ä»¶ä¸Šå»¶è¿Ÿ Close"},{"content":"è ¢èŒçš„æ­»æ³•: æŒ‡é’ˆä¸­çš„éšæœºå€¼ æœ€è¿‘æœ‰äººæå‡ºã€Œæ˜¯å¦å¯ä»¥å°†éæŒ‡é’ˆæ”¾å…¥ unsafe.Pointer å˜é‡ã€çš„é—®é¢˜ã€‚æ™®éçš„ååº”æ˜¯ã€ŒNOï¼Œè¿™æ˜¯ä¸€ä¸ªåä¸»æ„ã€ã€‚æˆ‘åŒæ„ï¼Œä½†å¦‚æœæˆ‘ä»¬ä»ä¸æ¢ç´¢ç³Ÿç³•çš„æƒ³æ³•ï¼Œæ°¸è¿œä¸ä¼š\u0026hellip;å—¯ï¼Œå®é™…ä¸Šï¼Œå¦‚æœä»ä¸æ¢ç´¢ç³Ÿç³•çš„æƒ³æ³•ï¼Œç»å¯¹ä¸ä¼šå‡ºé—®é¢˜ã€‚\nè®©æˆ‘ä»¬æ¢è®¨ä¸€ä¸‹è¿™ä¸ª Bad idea\nä¸ºä»€ä¹ˆæ˜¯åä¸»æ„? ä¸»è¦æ˜¯å¯èƒ½æ˜¯ä¼šè®© Go çš„åƒåœ¾æ”¶é›†å™¨å´©æºƒã€‚Go GC ä¼šæŸ¥çœ‹ç¨‹åºå¯è§çš„æ¯ä¸ªæŒ‡é’ˆï¼Œä»¥æŸ¥çœ‹å“ªäº›å†…å­˜ä»åœ¨ä½¿ç”¨ï¼Œä»¥åŠå“ªäº›å†…å­˜å¯ä»¥é‡Šæ”¾ã€‚å¦‚æœå®ƒè·Ÿéšçš„æŒ‡é’ˆæœªæŒ‡å‘æœ‰æ•ˆçš„å†…å­˜åœ°å€ï¼Œåˆ™å¯èƒ½ä¼šå´©æºƒã€‚\nè®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹ï¼Œåˆ†é…åäº¿ä¸ª unsafe.Pointers å¹¶å°†ä»–ä»¬å…¨éƒ¨è®¾ç½®ä¸ºæ— æ•ˆæŒ‡é’ˆçš„å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 func TestRandomUnsafePointers(t *testing.T) { x := make([]unsafe.Pointer, 1e9) for i := range x { // Possible misuse of unsafe.Pointer? Definite misuse of unsafe.Pointer! x[i] = unsafe.Pointer(uintptr(i * 8)) } runtime.GC() runtime.KeepAlive(x) } æ­¤ä»£ç åˆ›å»ºä¸€ä¸ªåŒ…å« 10 äº¿ä¸ªunsafe.Pointerçš„åˆ‡ç‰‡ï¼Œç„¶åå¼ºåˆ¶ GC è¿è¡Œã€‚å®ƒä¸ä¼šå´©æºƒã€‚\næˆ‘ä»¬å¯ä»¥ç”¨çœŸæ­£çš„éšæœºå€¼å†è¯•ä¸€æ¬¡ï¼Œå¹¶ä¸”åšä¸€äº›å‚»äº‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func TestRandomUnsafePointers2(t *testing.T) { x := make([]unsafe.Pointer, 1e9) for i := range x { // Possible misuse of unsafe.Pointer? Definite misuse of unsafe.Pointer! x[i] = unsafe.Pointer(uintptr(rand.Int64())) } runtime.GC() for range 10 { for i := range x { // Possible misuse of unsafe.Pointer? Definite misuse of unsafe.Pointer! x[i] = unsafe.Add(x[i], 3) } runtime.GC() } runtime.KeepAlive(x) } ä»æ—§æœªå´©æºƒã€‚\nå¦‚æœæˆ‘ä»¬ä¸å¤Ÿèªæ˜æ€ä¹ˆåŠï¼Ÿ\nGo å¯èƒ½ä¼šæŸ¥çœ‹è¿™äº›å€¼å¹¶æ€è€ƒã€Œå•Šå˜ã€ï¼Œç„¶åå¿½ç•¥ä»–ã€‚ Go å¯ä»¥ä¸ C äº¤äº’ï¼Œå› æ­¤å®ƒéœ€è¦èƒ½å¤Ÿå¤„ç†åœ¨å…¶æ§åˆ¶ä¹‹å¤–åˆ†é…çš„å†…å­˜ã€‚å¤šå¹´æ¥ï¼Œæˆ‘è¿˜ä½¿ç”¨ Go ç›´æ¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ†é…çš„å†…å­˜ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼ˆç¥ˆç¥·ï¼‰ã€‚\nå¦‚æœæŒ‡é’ˆçš„å€¼çœ‹èµ·æ¥åƒå®ƒåº”è¯¥å…³å¿ƒçš„å†…å­˜ï¼ŒGo å¯èƒ½ä¼šå‘ç°å®ƒæ›´å›°éš¾ã€‚å¦‚æœæˆ‘ä»¬å­˜å‚¨çš„å€¼æ›¾ç»æ˜¯ Go æœ¬èº«åˆ†é…çš„æœ‰æ•ˆå†…å­˜åœ°å€ï¼Œä½†æˆ‘ä»¬çŸ¥é“å®ƒä¸å†æœ‰æ•ˆæ€ä¹ˆåŠï¼Ÿ\nè¿™é‡Œæˆ‘ä»¬åˆ†é…ä¸€ä¸ªè¶³å¤Ÿå¤§çš„åˆ‡ç‰‡ï¼Œä»¥ä¾¿å§‹ç»ˆåˆ†é…åœ¨å †ä¸Šã€‚ç„¶åï¼Œæˆ‘ä»¬è·å–æ”¯æŒè¯¥åˆ‡ç‰‡çš„æ•°ç»„çš„åœ°å€ï¼Œå¹¶å°†å…¶æ”¾å…¥ uintptr ä¸­ã€‚æˆ‘ä»¬çŸ¥é“ Go ä¸ä¼šå°† uintptr è§†ä¸ºæŒ‡é’ˆï¼Œå› æ­¤å°†å€¼ä¿å­˜åœ¨ uintptr ä¸­ä¸åº”å¯¼è‡´ Go ä¿ç•™åˆ†é…ã€‚\nå¦‚æœæˆ‘ä»¬éšååˆ é™¤å¯¹åˆ‡ç‰‡çš„å¼•ç”¨å¹¶å¼ºåˆ¶æ‰§è¡Œ GCï¼Œåˆ™åº”è¯¥é‡Šæ”¾å†…å­˜ã€‚\n1 2 3 4 y := make([]int, 1e4) yptr := uintptr(unsafe.Pointer(unsafe.SliceData(y))) y = nil runtime.GC() ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°†æ­¤å€¼å­˜å‚¨åœ¨unsafe.Pointerä¸­å¹¶å†æ¬¡è¿è¡Œ GCï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°éº»çƒ¦ã€‚è¿™æ˜¯å®Œæ•´çš„æµ‹è¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 func TestUnsafePointerBadNumber(t *testing.T) { y := make([]int, 1e4) yptr := uintptr(unsafe.Pointer(unsafe.SliceData(y))) y = nil runtime.GC() runtime.GC() x := unsafe.Pointer(yptr) runtime.GC() runtime.GC() runtime.KeepAlive(x) } äº‹å®ä¸Šï¼Œè¿™ç¡®å®å¼•èµ·äº† panic ã€‚\n1 2 3 4 5 6 7 runtime: pointer 0xc000162000 to unallocated span span.base()=0xc000288000 span.limit=0xc000290000 span.state=0 runtime: found in object at *(0xc00005ff58+0x0) object=0xc00005ff58 s.base()=0xc00005e000 s.limit=0xc000066000 s.spanclass=0 s.elemsize=2048 s.state=mSpanManual : : ... fatal error: found bad pointer in Go heap (incorrect use of unsafe or cgo?) å¦‚æœæ‚¨æƒ³çŸ¥é“ä¸ºä»€ä¹ˆè¦å¤šæ¬¡è°ƒç”¨runtime.GC() ï¼Œæˆ‘ä¹Ÿæ˜¯ã€‚è¿™ä¼¼ä¹ä½¿å®ƒæ›´å¯é åœ°å´©æºƒã€‚\nè¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ\nGo çš„åƒåœ¾æ”¶é›†å™¨éå¸¸å¼ºå¤§ï¼Œå¯ä»¥å¤„ç†å¾ˆå¤šæ»¥ç”¨æƒ…å†µã€‚æ‚¨å¯ä»¥å°†å€¼å­˜å‚¨åœ¨ GC ä¸çŸ¥é“çš„æŒ‡é’ˆä¸­ï¼Œæˆ–è€…ç”šè‡³ä¸æ˜¯æœ‰æ•ˆçš„å†…å­˜åœ°å€ã€‚\nä½†å¦‚æœä½ å­˜å‚¨äº† GC è®¤ä¸ºå®ƒèƒ½æ§åˆ¶çš„å†…å­˜åœ°å€ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‘ç”Ÿ Panicã€‚å¦‚æœæ‚¨å°†éæŒ‡é’ˆå€¼å­˜å‚¨åœ¨unsafe.Pointerä¸­ï¼Œæ‚¨å¯èƒ½ä¸ä¼šç«‹å³çœ‹åˆ°é—®é¢˜ã€‚ä½ çš„æµ‹è¯•å¯èƒ½ä¸ä¼šæ˜¾ç¤ºä»»ä½•é—®é¢˜ã€‚ä½†æœ‰ä¸€å¤©ï¼Œæ€»ä¼šæœ‰å¼‚å¸¸ç”©ä½ è„¸ä¸Šï¼Œè€Œä½ å´ä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚\næˆ‘çš„ç»“è®ºå¦‚ä¸‹ã€‚\né™¤éç¡®å®å¿…è¦ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨unsafe.Pointer ã€‚ é™¤éç¡®å®æœ‰å¿…è¦ï¼Œå¦åˆ™ä¸è¦ä¿ç•™unsafe.PointeræŒ‡é’ˆå€¼ã€‚å¤§å¤šæ•°ä½¿ç”¨unsafe.Pointerçš„å®‰å…¨æ“ä½œä»…å°†å…¶ç”¨ä½œç¬æ€å€¼ï¼ŒåŒæ—¶å°†æŸäº›å†…å®¹è½¬æ¢ä¸ºå…¶ä»–å†…å®¹ã€‚ ä½ å¯èƒ½ä¸éœ€è¦ã€‚ ä»…å°†å†…å­˜åœ°å€å­˜å‚¨åœ¨unsafe.Pointerä¸­ã€‚ ä¹Ÿè®¸åªæœ‰åœ¨ Go è¿è¡Œæ—¶ä¹‹å¤–åˆ†é…çš„å†…å­˜åœ°å€ï¼ˆä¾‹å¦‚é€šè¿‡ç›´æ¥è°ƒç”¨ mmap ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚ å‚è€ƒ æœ¬æ–‡ç¿»è¯‘äºDumb ways to die: Random Values in Pointers\n","date":"2024-09-16T00:00:00Z","permalink":"https://blog.golang.space/p/%E6%8C%87%E9%92%88%E4%B8%AD%E7%9A%84%E9%9A%8F%E6%9C%BA%E5%80%BC/","title":"æŒ‡é’ˆä¸­çš„éšæœºå€¼"},{"content":"è¿™å‡ å¤©ï¼Œæˆ‘å¼€å‘äº†ä¸€ä¸ªåä¸º \u0026ldquo;Horcux\u0026rdquo; çš„ç¨‹åºï¼Œå®ƒå…è®¸å°†ä¸€ä¸ªæ–‡ä»¶æ‹†åˆ†ä¸ºä»»æ„æ•°é‡çš„é­‚å™¨ï¼Œç„¶åå¯ä»¥é‡æ–°ç»„åˆä»¥æ¢å¤åŸå§‹æ–‡ä»¶ã€‚æœŸé—´ï¼Œæˆ‘äº†è§£äº†å¾ˆå¤šæœ‰å…³ io.Reader å’Œ io.Writer æ¥å£çš„çŸ¥è¯†ï¼Œä¸å¤§å®¶åˆ†äº«ã€‚\nä¸ºä»€ä¹ˆä½¿ç”¨ io.Reader å’Œ io.Writer? åœ¨ Horcrux çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼Œåšäº†ç±»ä¼¼ä»¥ä¸‹çš„äº‹æƒ…æ¥åŠ å¯†æ–‡ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 func main() { // plaintext: \u0026#34;this is my file\u0026#39;s content\u0026#34; content, _ := ioutil.ReadFile(\u0026#34;myfile\u0026#34;) encryptedContent := encrypt(content) // ciphertext: \u0026#34;uijt!jt!nz!gjmf(t!dpoufou\u0026#34; ioutil.WriteFile(\u0026#34;myfile.encryped\u0026#34;, encryptedContent, 0644) } å°æ–‡ä»¶è¶…çº§å¿«ã€‚å½“æ–‡ä»¶ä¸º 1GB æ—¶è¶…çº§æ…¢ã€‚æˆ‘çš„ç›®çš„æ˜¯åŠ å¯†æºæ–‡ä»¶ï¼Œè€Œä¸æ˜¯å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™å°±æ˜¯ io.Reader å’Œ io.Writer å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚\nio.Reader ä»æºè¯»å–æ•°æ®ã€‚io.Writer å°†å†…å®¹å†™å…¥ç›®çš„åœ°ï¼Œä¸¤ä¸ªæ¥å£æ˜¯å¤„ç†æµä¿¡æ¯çš„æ¥å£ã€‚\næµå¼æ–¹æ³•æœ‰å‡ ä¸ªå¥½å¤„:\nç”¨ä¸€ä¸ªå°çš„ç¼“å†²åŒºè¯»å†™æ•°æ®ï¼Œä¸éœ€è¦å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ ä¸éœ€è¦ç­‰å¾…æ•´ä¸ªæ–‡ä»¶åŠ è½½å¥½æ‰å¼€å§‹åŠ å¯†ï¼Œä¸€æ—¦æ•°æ®è¯»å…¥ç¼“å†²åŒºï¼Œå³å¯å¼€å§‹å†™å…¥ç›®æ ‡æ–‡ä»¶ã€‚ io.Reader ä»€ä¹ˆæ˜¯ io.Reader?\n1 2 3 type Reader interface { Read(p []byte) (n int, err error) } å¸¸è§çš„è¿”å›é”™è¯¯æ˜¯ io.EOFï¼Œå®ƒä»£è¡¨è¯»å–ç»“æŸã€‚\næŒ‰ç…§æƒ¯ä¾‹ï¼Œåœ¨ Go ä¸­ï¼Œå½“å‡½æ•°æœ‰å¤šä¸ªè¿”å›å€¼æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ errorï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå…¶ä»–å€¼åº”ä¸ºé›¶å€¼ã€‚ä½†è€ƒè™‘å¦‚æœè¯»å–ä¸­é€”å‘ç”Ÿé”™è¯¯ï¼Œåº”è¯¥å‘Šè¯‰è°ƒç”¨è€…å½“å‰è¯»å–äº†å¤šå°‘å­—èŠ‚ã€‚\nä½¿ç”¨ io.Reader\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func main(){ reader := strings.NewReader(\u0026#34;this is the stuff i\u0026#39;m reading\u0026#34;) var result []byte buf := make([]byte,4) for { n,err := reader.Read(buf) result = append(result, buf[:n]...) if err != nil { if err == io.EOF { break } log.Fatal(err) } } fmt.Println(string(result)) } åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ›å»ºç¼“å†²åŒº(å¤§å°ä¸º 4 å­—èŠ‚) å¹¶æ‰§è¡Œå¾ªç¯ï¼Œåœ¨æ¯æ¬¡å¾ªç¯ä¸­è°ƒç”¨è¯»å–å™¨ä¸Šçš„ Read æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿”å›å€¼æ¥æŸ¥çœ‹å·²å†™å…¥å¤šå°‘å­—èŠ‚ã€‚æœ€åå°†è¿™äº›æ•°æ®é™„åŠ åˆ°ç»“æœä¸­ï¼Œå¦‚æœå‡ºç° EOF é”™è¯¯ï¼Œè·³å‡ºå¾ªç¯ã€‚\\\næ³¨æ„æœ‰ä¸€ä¸ªç‚¹æ˜¯å…ˆå¤„ç†æ•°æ®ï¼Œå†å¤„ç†é”™è¯¯ã€‚è¿”å› (0,nil) å¹¶ä¸æ„å‘³ç€æ²¡æœ‰æ›´å¤šå†…å®¹å¯è¯»ï¼Œå¯èƒ½æ˜¯æ­£åœ¨ç­‰å¾…åº•å±‚æºè¿”å›æ›´å¤šçš„æ•°æ®ã€‚\nå®ç° io.Reader\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type myReader strcut{ content []byte position int } func (r *myReader) Read(buf []byte) (int,error) { remainingBytes := len(r.content) - r.position n := min(remainingBytes,len(buf)) if n == 0 { return 0, io.EOF } copy(buf[:n], r.content[r.position:r.position+n]) r.position += n return n,nil } åœ¨è¿™é‡Œï¼Œåˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«è¦è¯»å–çš„å†…å®¹ content å­—æ®µï¼Œä»¥åŠç”¨äºè·Ÿè¸ªè¯»å–ä½ç½®çš„ position å­—æ®µã€‚ å°†æºæ•°æ®å¡«å……ç¼“å­˜åŒºå¹¶é˜²æ­¢æº¢å‡ºã€‚\næ³¨æ„ï¼Œå½“æ²¡æœ‰æ›´å¤šå†…å®¹å¯è¯»å–æ—¶ï¼Œè¿”å› (0,io.EOF) ï¼Œä»è€Œé¿å…è°ƒç”¨è€…å¯¹ Read æ–¹æ³•è¿›è¡Œä¸å¿…è¦çš„è°ƒç”¨ã€‚\nç¼–å†™ io.Readers\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 type augmentedReader struct{ innerReader io.Reader augmentFunc func([]byte) []byte } // replaces \u0026#39; \u0026#39; with \u0026#39;!\u0026#39; func bangify(buf []byte) []byte { return bytes.Replace(buf, []byte(\u0026#34; \u0026#34;), []byte(\u0026#34;!\u0026#34;), -1) } func (r *augmentedReader) Read(buf []byte) (int, error) { tmpBuf := make([]byte, len(buf)) n, err := r.innerReader.Read(tmpBuf) copy(buf[:n], r.augmentFunc(tmpBuf[:n])) return n, err } func BangReader(r io.Reader) io.Reader { return \u0026amp;augmentedReader{innerReader: r, augmentFunc: bangify} } func UpcaseReader(r io.Reader) io.Reader { return \u0026amp;augmentedReader{innerReader: r, augmentFunc: bytes.ToUpper} } ... package main import ( . \u0026#34;augment\u0026#34; ... ) func main() { originalReader := strings.NewReader(\u0026#34;this is the stuff I\u0026#39;m reading\u0026#34;) augmentedReader := UpcaseReader(BangReader(originalReader)) result, err := ioutil.ReadAll(augmentedReader) if err != nil { log.Fatal(err) } fmt.Println(string(result)) // THIS!IS!THE!STUFF!I\u0026#39;M!READING } è¿™ä¸€ä¸ªå¢å¼ºåŒ…ï¼Œå®ƒå¯¼å‡ºä¸€äº›å¯ç»„åˆçš„è¯»å–å™¨å‡½æ•°ã€‚æ¯ä¸ªå‡½æ•°éƒ½æ¥å—ä¸€ä¸ª io.Readerï¼Œå¹¶è¿”å›ä¸€ä¸ª io.Readerã€‚ä½†å†…éƒ¨ io.Reader çš„è¾“å‡ºç”±å¤–éƒ¨ IO å¢å¼ºã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œå°† \u0026quot; \u0026quot; ä¸ ! äº¤æ¢ã€‚\nä½¿ç”¨ io.Writer\n1 2 3 4 func main() { writer := os.Stdout writer.Write([]byte(\u0026#34;hello there\\n\u0026#34;)) } å®ç° io.Writer\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 type myWriter struct { content []byte } func (w *myWriter) Write(buf []byte) (int, error) { w.content = append(w.content, buf...) return len(buf), nil } func (w *myWriter) String() string { return string(w.content) } func main() { writer := \u0026amp;myWriter{} writer.Write([]byte(\u0026#34;hello there\\n\u0026#34;)) fmt.Println(writer.String()) // \u0026#34;hello there\\n\u0026#34; } åœ¨ Write æ–¹æ³•ä¸­ä»…è·å–ç¼“å†²åŒºå¹¶å°†å…¶é™„åŠ åˆ°å…¶å†…éƒ¨å†…å®¹ã€‚æˆ‘ä»¬è¿˜ç»™å®ƒä¸€ä¸ªStringæ–¹æ³•æ¥å‘Šè¯‰æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢å®ƒå†™äº†ä»€ä¹ˆã€‚ç¢°å·§æˆ‘ä»¬åœ¨è¿™é‡Œå®ç°äº† bytes.Buffer çš„ç²¾ç®€ç¼–å†™å™¨ç‰ˆæœ¬ã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Golang IO Cookbook\n","date":"2024-08-27T00:00:00Z","permalink":"https://blog.golang.space/p/golang-io-cookbook/","title":"Golang IO Cookbook"},{"content":"ç†è§£ maps çš„çœŸæ­£å·¥ä½œåŸç†æœ‰å¯èƒ½ç›¸å½“å›°éš¾ï¼Œä¸¾ä¸ªä¾‹å­: ä½ æ˜¯å¦æ›¾ç»è®¾ç½®è¿‡ map çš„ hintï¼Œå³ make(map,hint)ï¼Œä¸ºä»€ä¹ˆå®ƒå« hint ï¼Œè€Œä¸æ˜¯sliceé‚£æ ·çš„ len?\nä½ å¯ä»¥å·²ç»æ³¨æ„åˆ°ï¼Œå½“ä½ åœ¨ map ä¸Šä½¿ç”¨ for-range æ—¶ï¼Œé¡ºåºä¸æ’å…¥é¡ºåºä¸åŒ¹é…ã€‚å¦‚æœåœ¨ä¸åŒçš„æ—¶é—´å¾ªç¯åŒä¸€ä¸ª mapï¼Œæ¯æ¬¡çš„ç»“æœå¯èƒ½éƒ½ä¸ä¸€æ ·ã€‚å¥‡æ€ªçš„æ˜¯ï¼ŒåŒä¸€ä¸ªæ—¶é—´å¾ªç¯ï¼Œé¡ºåºé€šå¸¸ä¿æŒä¸å˜ã€‚\nè·Ÿä¸Šï¼Œå¸¦ä½ çœ‹çœ‹ã€‚\næœ¬æ–‡åŸºäº Go 1.23 ç‰ˆæœ¬ã€‚\nå¿«é€Ÿå¼€å§‹ Go ä¸­çš„ mapï¼Œæ˜¯ä¸€ç§å†…ç½®ç±»å‹ï¼Œå……å½“é”®å€¼å­˜å‚¨ï¼Œ key å¯ä»¥æ˜¯ä»»ä½•å¯æ¯”è¾ƒçš„ç±»å‹ã€‚\n1 2 3 4 5 m := make(map[string]int) m[\u0026#34;a\u0026#34;] = 1 m[\u0026#34;b\u0026#34;] = 2 m // map[a:1 b:2] åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨ make() åˆ›å»ºäº†ä¸€ä¸ªç©º mapï¼Œå…¶ä¸­ key æ˜¯å­—ç¬¦ä¸²ï¼Œvalue æ˜¯æ•´æ•°ã€‚\nå¯ä»¥åœ¨å£°æ˜ map çš„åŒæ—¶èµ‹å€¼é”®å€¼å¯¹ã€‚\n1 2 3 4 m := map[string]int{ \u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, } åˆ é™¤çš„æ–¹æ³•æ˜¯ delete(m,\u0026quot;a\u0026quot;)\nmap çš„é›¶å€¼æ˜¯ nilï¼Œå¹¶ä¸” nil map åœ¨æŸäº›æ–¹é¢æœ‰ç‚¹åƒ empty mapï¼Œå¯ä»¥å°è¯•åœ¨å…¶ä¸­æŸ¥æ‰¾ keyï¼Œgolang ä¸ä¼šå‘ç”Ÿ panic ã€‚\nå¦‚æœæœç´¢ä¸å­˜åœ¨çš„ keyï¼ŒGo ä¼šæä¾›è¯¥ç±»å‹çš„é›¶å€¼ã€‚\n1 2 3 4 var m map[string]int println(m[\u0026#34;a\u0026#34;]) // 0 m[\u0026#34;a\u0026#34;] = 1 // panic: assignment to entry in nil map è­¦å‘Š: ä½†ä¸èƒ½å¯¹ nil map æ·»åŠ æ–°çš„é”®å€¼å¯¹!\näº‹å®ä¸Šï¼Œ Go å¤„ç† map çš„æ–¹å¼ä¸å¤„ç† slice çš„æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œä¸¤è€…çš†ä»¥ nil å¼€å§‹ï¼Œfor-range ä¹Ÿä¸ä¼šå‘ç”Ÿ panicï¼ŒGo å°†ä»»ä½•ç±»å‹çš„é›¶å€¼è§†ä¸ºæœ‰ç”¨çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯å¯¼è‡´ç¨‹åºå´©æºƒçš„ä¸œè¥¿ï¼Œé™¤éå½“ä½ åšäº†ä¸€äº›éæ³•çš„äº‹æƒ…ï¼Œä¾‹å¦‚å°è¯•åƒ nil map æ·»åŠ æ–°çš„é”®å€¼å¯¹ï¼Œæˆ–è€…å¯¹ nil slice è¶Šç•Œç´¢å¼•ã€‚\nå…³äº Go ä¸­çš„ mapï¼Œåº”è¯¥äº†è§£ä»¥ä¸‹å‡ ç‚¹:\nmap çš„éå†æ˜¯ä¹±åºçš„ map éçº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸”æ•°æ®ç«äº‰æ—¶ä¼šå‘ç”Ÿ panic å¯ä»¥é€šè¿‡ ok æ¥æ£€æŸ¥ key æ˜¯å¦å­˜åœ¨ _,ok := m[key] map çš„ key å¿…é¡»æ˜¯å¯æ¯”è¾ƒçš„ é‚£ä¹ˆï¼Œå¯æ¯”è¾ƒç±»å‹åˆ°åº•æ˜¯ä»€ä¹ˆ?\nç®€å•çš„å¾ˆï¼Œå¦‚æœå¯ä»¥ä½¿ç”¨ == æ¥åˆ¤æ–­ç›¸åŒç±»å‹çš„ä¸¤ä¸ªå€¼ï¼Œé‚£ä¹ˆè¯¥ç±»å‹è¢«è®¤ä¸ºå¯ä»¥æ¯”è¾ƒã€‚\n1 2 3 4 5 6 7 8 9 func main() { var s map[int]string if s == s { println(\u0026#34;comparable\u0026#34;) } } // compile error: invalid operation: s == s (map can only be compared to nil) æ˜¾ç„¶ï¼Œä¸Šé¢çš„ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œmap åªèƒ½ä¸ nil æ¯”è¾ƒã€‚\nåŒæ ·çš„è§„åˆ™é€‚ç”¨äºå…¶ä»–ä¸å¯æ¯”è¾ƒçš„ç±»å‹ï¼Œä¾‹å¦‚sliceã€å‡½æ•°æˆ–åŒ…å«sliceæˆ–mapçš„ç»“æ„ç­‰ã€‚\nä½†è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œæ¥å£æ˜¯å¯ä»¥æ¯”è¾ƒçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸å¯æ¯”è¾ƒçš„ã€‚\nä»€ä¹ˆæ„æ€? å³å¯ä»¥å®šä¹‰ä¸€ä¸ªç©ºæ¥å£ä¸ºé”®çš„ map ï¼Œè€Œä¸ä¼šç¼–è¯‘å‡ºé”™ï¼Œä½†å¯ä»¥è¿è¡Œæ—¶å‡ºé”™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 func main() { m := map[interface{}]int{ 1: 1, \u0026#34;a\u0026#34;: 2, } m[[]int{1, 2, 3}] = 3 m[func() {}] = 4 } // panic: runtime error: hash of unhashable type []int // panic: runtime error: hash of unhashable type func() ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼Œç›´åˆ°å°è¯•åˆ†é…ä¸€ä¸ªä¸å¯æ¯”è¾ƒçš„ç±»å‹ä½œä¸º key ã€‚è¿™æ¯”ç¼–è¯‘é”™è¯¯æ›´éš¾å¤„ç†ï¼Œåº”å½“é¿å…ä½¿ç”¨ interface{} ä½œä¸º map çš„ key ã€‚\nMap å‰–æ è®©æˆ‘ä»¬ç”±æµ…å…¥æ·±ï¼Œç»†å“ï¼Œåˆ«é™·å…¥ Go æºç çš„å…·ä½“å®ç°ã€‚\nå®é™…ä¸Šï¼Œé”®å€¼å¯¹æ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œåº•å±‚æ˜¯ç”±è®¸å¤šç§°ä¸º bucket çš„è¾ƒå°å•å…ƒé˜»å¡ã€‚\n1 2 3 4 5 type hmap struct { ... buckets unsafe.Pointer ... } æ³¨æ„çœ‹ï¼Œè¿™ä¸ª buckets æ˜¯æŒ‡é’ˆï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå°† map åˆ†é…ç»™å˜é‡æˆ–ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œåœ¨å¤–éƒ¨çš„ä¿®æ”¹ä¹Ÿä¼šå½±å“åˆ°è¿™ä¸ªå€¼ã€‚\n1 2 3 4 5 6 7 8 9 func changeMap(m2 map[string]int) { m2[\u0026#34;hello\u0026#34;] = 2 } func main() { m1 := map[string]int{\u0026#34;hello\u0026#34;: 1} changeMap(m1) println(m1[\u0026#34;hello\u0026#34;]) // 2 } map æ˜¯æŒ‡å‘è¿è¡Œæ—¶ hmap çš„æŒ‡é’ˆï¼Œä½†å®ƒä»¬ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¦‚æœå¦‚ä¸‹æ‰€ç¤ºçš„æ›´æ”¹ï¼Œå®ƒä¸ä¼šåæ˜ åˆ°è°ƒç”¨è€…ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 func changeMap(m2 map[string]int) { m2 = map[string]int{\u0026#34;hello\u0026#34;: 2} } func main() { m1 := map[string]int{\u0026#34;hello\u0026#34;: 1} changeMap(m1) println(m1[\u0026#34;hello\u0026#34;]) // 1 } åœ¨ Go ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯æŒ‰å€¼ä¼ é€’çš„ã€‚çœŸæ­£å‘ç”Ÿçš„æƒ…å†µæœ‰ç‚¹ä¸åŒï¼Œå½“ä½ å°† map m1 ä¼ é€’ç»™ changeMap å‡½æ•°æ—¶ï¼ŒGo ä¼šåˆ›å»º *hmap ç»“æ„çš„å‰¯æœ¬ã€‚å› æ­¤ï¼Œmain() ä¸­çš„ m1 å’Œ changeMap() å‡½æ•°ä¸­çš„ m2 ä»æŠ€æœ¯ä¸Šè®²æ˜¯æŒ‡å‘ç›¸åŒ hmap ä¸åŒçš„æŒ‡é’ˆã€‚\næ¯ä¸ªå­˜å‚¨æ¡¶æœ€å¤šåªèƒ½å®¹çº³ 8 ä¸ªé”®å€¼å¯¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nä¸Šé¢çš„mapæœ‰2ä¸ªbucketï¼Œ len(map)æ˜¯6ã€‚\nå½“æ·»åŠ é”®å€¼å¯¹æ—¶ï¼Œä¼šæ ¹æ® hash(key, seed) å°†é”®å€¼å¯¹æ”¾å…¥å…¶ä¸­ä¸€ä¸ªå­˜å‚¨æ¡¶ä¸­ã€‚\nçœ‹çœ‹ä»¥ä¸‹åœºæ™¯: æœ‰ä¸€ä¸ª nil map å¹¶ä¸ºå…¶åˆ†é…é”®å€¼å¯¹\nå®ƒé¦–å…ˆå°†â€œhelloâ€æ•£åˆ—åˆ°ä¸€ä¸ªæ•°å­—ï¼Œç„¶åè·å–è¯¥æ•°å­—å¹¶æŒ‰å­˜å‚¨æ¡¶çš„æ•°é‡å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚\nç”±äºæˆ‘ä»¬è¿™é‡Œåªæœ‰ä¸€ä¸ªå­˜å‚¨æ¡¶ï¼Œä»»ä½•æ•°å­— mod 1 éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥å®ƒä¼šç›´æ¥è¿›å…¥å­˜å‚¨æ¡¶ 0ï¼Œå½“æ‚¨æ·»åŠ å¦ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œä¹Ÿä¼šå‘ç”Ÿç›¸åŒçš„è¿‡ç¨‹ã€‚å®ƒå°†å°è¯•å°†å…¶æ”¾å…¥å­˜å‚¨æ¡¶ 0 ä¸­ï¼Œå¦‚æœç¬¬ä¸€ä¸ª bucket å·²è¢«å ç”¨æˆ–å…·æœ‰ä¸åŒçš„å¯†é’¥ï¼Œå®ƒå°†ç§»åŠ¨åˆ°è¯¥å­˜å‚¨æ¡¶ä¸­çš„ä¸‹ä¸€ä¸ª bucketã€‚\nçœ‹ä¸€ä¸‹hash(key, seed) ï¼Œå½“æ‚¨åœ¨å…·æœ‰ç›¸åŒé”®çš„ä¸¤ä¸ªmapä¸Šä½¿ç”¨ for-range å¾ªç¯æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°é”®ä»¥ä¸åŒçš„é¡ºåºå‡ºç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func main() { a := map[string]int{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, \u0026#34;c\u0026#34;: 3, \u0026#34;d\u0026#34;: 4, \u0026#34;e\u0026#34;: 5, \u0026#34;f\u0026#34;: 6} b := map[string]int{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, \u0026#34;c\u0026#34;: 3, \u0026#34;d\u0026#34;: 4, \u0026#34;e\u0026#34;: 5, \u0026#34;f\u0026#34;: 6} for i := range a { print(i, \u0026#34; \u0026#34;) } println() for i := range b { print(i, \u0026#34; \u0026#34;) } } // Output: // a b c d e f // c d e f a b è¿™æ€ä¹ˆå¯èƒ½ï¼Ÿmap a ä¸­çš„é”®â€œaâ€å’Œmap b ä¸­çš„é”®â€œaâ€ä¸æ˜¯ä»¥ç›¸åŒçš„æ–¹å¼æ•£åˆ—å—ï¼Ÿ\nä½†äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œè™½ç„¶ Go ä¸­ç”¨äº map çš„å“ˆå¸Œå‡½æ•°åœ¨å…·æœ‰ç›¸åŒé”®ç±»å‹çš„æ‰€æœ‰ map ä¸­æ˜¯ä¸€è‡´çš„ï¼Œä½†è¯¥å“ˆå¸Œå‡½æ•°ä½¿ç”¨çš„seedå¯¹äºæ¯ä¸ª map å®ä¾‹æ˜¯ä¸åŒçš„ã€‚å› æ­¤ï¼Œå½“æ‚¨åˆ›å»ºæ–° map æ—¶ï¼ŒGo ä¼šä¸“é—¨ä¸ºè¯¥ map ç”Ÿæˆä¸€ä¸ªéšæœºç§å­ã€‚\nä¸€ä¸ª bucket çš„é•¿åº¦æœ€å¤§æ˜¯ 8ï¼Œé‚£æ»¡äº†ä¼šæ€æ ·?\nå½“æ¡¶å¼€å§‹å˜æ»¡ï¼Œç”šè‡³å‡ ä¹æ»¡æ—¶ï¼Œæ ¹æ®ç®—æ³•å¯¹â€œæ»¡â€çš„å®šä¹‰ï¼Œmap å°†è§¦å‘æ‰©å®¹ï¼Œè¿™å¯èƒ½ä¼šä½¿ main buckets çš„æ•°é‡å¢åŠ ä¸€å€ã€‚\næœ‰è¶£ã€‚\nå½“æˆ‘è¯´â€œ main bucketsâ€ æ—¶ï¼Œæˆ‘æ­£åœ¨è®¾ç½®å¦ä¸€ä¸ªæ¦‚å¿µï¼šâ€œoverflow bucketsâ€ã€‚å½“é‡åˆ°é«˜ç¢°æ’çš„æƒ…å†µæ—¶ï¼Œè¿™äº›å°±ä¼šå‘æŒ¥ä½œç”¨ã€‚è¯•æƒ³: å­˜åœ¨ 4 ä¸ªbucketï¼Œä½†å…¶ä¸­ä¸€ä¸ªç”±äºé«˜å†²çªè€Œå®Œå…¨è£…æ»¡ï¼Œå¦å¤– 3 ä¸ªåˆ™ç©ºç€ã€‚\næ˜¯å¦çœŸçš„éœ€è¦å°† map ç¿»å€æ‰©å®¹åˆ° 8 ä¸ª buckets? ä»…ä»…æ˜¯éœ€è¦æ·»åŠ ä¸€ä¸ªä¸å¹¸ä¹Ÿè½åˆ° bucket 0 çš„é”®å€¼å¯¹?\nNo! è¿™æ ·å¤ªæµªè´¹äº†ã€‚\nGo é€šè¿‡åˆ›å»ºé“¾æ¥åˆ°ç¬¬ä¸€ä¸ª bucket çš„ overflow bucket æ¥æ›´æœ‰æ•ˆå¤„ç†è¿™ä¸ªé—®é¢˜ã€‚æ–°çš„é”®å€¼å¯¹å­˜å‚¨åœ¨è¿™ä¸ªæº¢å‡ºæ¡¶ä¸­ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶å®Œå…¨æ‰©å®¹ã€‚\nå½“æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€æ—¶ï¼ŒGo ä¸­çš„ map å°±ä¼šæ‰©å®¹: è¦ä¹ˆæº¢å‡ºæ¡¶å¤ªå¤šï¼Œè¦ä¹ˆ map è¿‡è½½(è´Ÿè½½å› å­å¤ªé«˜)ã€‚\nå¯¹åº”è¿™ä¸¤ç§æ¡ä»¶ï¼Œä¹Ÿæœ‰ä¸¤ç§æ‰©å®¹æ–¹å¼:\nç¿»å€æ‰©å®¹(è¿‡è½½æ—¶) ä¿æŒç›¸åŒå¤§å°ï¼Œä½†é‡æ–°åˆ†é… bucket ä¸­çš„æ•°æ®ã€‚(å½“æº¢å‡ºæ¡¶å¤ªå¤šæ—¶) ç›®å‰ï¼ŒGo çš„è´Ÿè½½å› å­è®¾ç½®ä¸º 6.5ï¼Œè¿™æ„å‘³ç€ map è®¾è®¡ä¸ºæ¯ä¸ª bucket å¹³å‡ç»´æŠ¤ 6,5 ä¸ªï¼Œå¤§çº¦æ˜¯ 80%çš„å®¹é‡ï¼Œå½“è´Ÿè½½å› å­è¶…è¿‡æ­¤é˜ˆå€¼ï¼Œmap è§†ä¸ºè¿‡è½½ã€‚æ­¤æ—¶ï¼Œå°†é€šè¿‡åˆ†é…ä¸€ä¸ªæ–°çš„ buckets æ•°ç»„ï¼Œè¯¥æ•°ç»„æ˜¯å¤§å°æ˜¯å½“å‰çš„ä¸¤å€ï¼Œç„¶åå…ƒç´ é‡æ–°æ•£åˆ—åˆ°æ–°çš„ buckets ä¸­ã€‚\næˆ‘ä»¬é€šå¸¸è®¤ä¸ºåœ¨mapä¸­è®¿é—®å’Œèµ‹å€¼æ˜¯ O(1)ï¼Œå¯¹å§ï¼Ÿä½†äº‹æƒ…å¹¶ä¸æ€»æ˜¯é‚£ä¹ˆç®€å•ã€‚\nbucket ä¸­çš„å…ƒç´ è¶Šå¤šï¼Œé€Ÿåº¦å°±è¶Šæ…¢ã€‚\nå½“æ‚¨æƒ³è¦æ·»åŠ å¦ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œä¸ä»…ä»…æ˜¯æ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦æœ‰ç©ºé—´ï¼Œè€Œæ˜¯å°†é”®ä¸è¯¥å­˜å‚¨æ¡¶ä¸­çš„æ¯ä¸ªç°æœ‰é”®è¿›è¡Œæ¯”è¾ƒï¼Œä»¥å†³å®šæ˜¯æ·»åŠ æ–°æ¡ç›®è¿˜æ˜¯æ›´æ–°ç°æœ‰æ¡ç›®ã€‚\nå½“æ‚¨æœ‰æº¢å‡ºæ¡¶æ—¶ï¼Œæƒ…å†µä¼šå˜å¾—æ›´ç³Ÿï¼Œå› ä¸ºæ‚¨è¿˜å¿…é¡»æ£€æŸ¥è¿™äº›æº¢å‡ºæ¡¶ä¸­çš„æ¯ä¸ªæ’æ§½ã€‚è¿™ç§é€Ÿåº¦å‡æ…¢ä¹Ÿä¼šå½±å“è®¿é—®å’Œåˆ é™¤æ“ä½œã€‚\nä½† Go å›¢é˜Ÿå¼ºå‘€ï¼Œä»–ä»¬ä¸ºæˆ‘ä»¬ä¼˜åŒ–äº†è¿™ä¸ªæ¯”è¾ƒã€‚\nè¿˜è®°å¾—æˆ‘ä»¬å¯¹é”®â€œHelloâ€è¿›è¡Œæ•£åˆ—æ—¶å¾—åˆ°çš„æ•£åˆ—å—ï¼Ÿ Go ä¸åªæ˜¯æŠŠå®ƒæ‰”æ‰ã€‚å®ƒå®é™…ä¸Šå°†â€œHelloâ€çš„ tophash ä½œä¸ºuint8ç¼“å­˜åœ¨å­˜å‚¨æ¡¶ä¸­ï¼Œå¹¶ä½¿ç”¨å®ƒä¸ä»»ä½•æ–°å¯†é’¥çš„ tophash è¿›è¡Œå¿«é€Ÿæ¯”è¾ƒã€‚è¿™ä½¿å¾—åˆå§‹æ£€æŸ¥è¶…çº§å¿«ã€‚\næ¯”è¾ƒtophashåï¼Œå¦‚æœå®ƒä»¬åŒ¹é…ï¼Œåˆ™æ„å‘³ç€å¯†é’¥â€œå¯èƒ½â€ç›¸åŒã€‚ç„¶åï¼ŒGo ç»§ç»­è¿›è¡Œè¾ƒæ…¢çš„è¿‡ç¨‹ï¼Œæ£€æŸ¥å¯†é’¥æ˜¯å¦å®é™…ä¸Šç›¸åŒã€‚\nä¸ºä»€ä¹ˆä½¿ç”¨ make(map,hint) åˆ›å»ºæ–° map ä¸æä¾›ç¡®åˆ‡çš„å¤§å°è€Œåªæä¾› hintï¼Ÿ\nmake(map, hint)ä¸­çš„hintå‚æ•°å‘Šè¯‰Goæ‚¨æœŸæœ›mapä¿å­˜çš„å…ƒç´ çš„åˆå§‹æ•°é‡ã€‚æ­¤ hint æœ‰åŠ©äºæœ€å¤§é™åº¦åœ°å‡å°‘æ·»åŠ å…ƒç´ æ—¶ map éœ€è¦æ‰©å®¹çš„æ¬¡æ•°ã€‚\nç”±äºæ¯ä¸ªæ‰©å®¹æ“ä½œéƒ½æ¶‰åŠåˆ†é…æ–°çš„å­˜å‚¨æ¡¶æ•°ç»„å¹¶å¤åˆ¶ç°æœ‰å…ƒç´ ï¼Œå› æ­¤è¿™ä¸æ˜¯æœ€æœ‰æ•ˆçš„è¿‡ç¨‹ã€‚ä»è¾ƒå¤§çš„åˆå§‹å®¹é‡å¼€å§‹å¯ä»¥å¸®åŠ©é¿å…ä¸€äº›æˆæœ¬é«˜æ˜‚çš„æ‰©å®¹æ“ä½œã€‚\nå½“æ‚¨æ·»åŠ æ›´å¤šå…ƒç´ æ—¶ï¼Œå­˜å‚¨æ¡¶å¤§å°è¿™æ ·æ‰©å®¹ï¼š\nHint Range Bucket Count Capacity 0 - 8 1 8 9 - 13 2 16 14 - 26 4 32 27 - 52 8 64 53 - 104 16 128 105 - 208 32 256 209 - 416 64 512 417 - 832 128 1024 833 - 1664 256 2048 ä¸ºä»€ä¹ˆ hint= 14 ä¼šäº§ç”Ÿ 4 ä¸ªæ¡¶ï¼Ÿæˆ‘ä»¬åªéœ€è¦ 2 ä¸ªæ¡¶å°±å¯ä»¥å®¹çº³ 14 ä¸ªå…ƒç´ ã€‚\nè¿™å°±æ˜¯è´Ÿè½½å› å­å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ï¼Œå½“ hint=13ï¼Œæœ‰ 2 ä¸ª bucketsï¼Œè´Ÿè½½å› å­ä¸º 13/2=6.5ï¼Œè¾¾åˆ°é˜ˆå€¼ä½†æœªè¶…è¿‡ã€‚å› æ­¤ï¼Œå½“ hint=14ï¼Œè´Ÿè½½å› å­è¶…è¿‡ 6.5ï¼Œè§¦å‘ç¿»å€æ‰©å®¹ã€‚\nhint=26ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œ26/4=6.5ï¼Œå½“ hint\u0026gt;26ï¼Œmap éœ€è¦æ‰©å®¹ä»¥æœ‰æ•ˆå®¹çº³æ›´å¤šå…ƒç´ ã€‚\næ•£åˆ— ä¸ºä»€ä¹ˆæ— æ³•è·å– map å…ƒç´ çš„åœ°å€? ä¸ºä»€ä¹ˆä¸åŒæ—¶é—´ä¸èƒ½ä¿è¯èŒƒå›´å†…çš„é¡ºåº?\nå½“ map å¢é•¿æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ buckets æ•°ç»„ï¼Œæ˜¯æ—§ buckets çš„ä¸¤å€ï¼Œæ—§ buckets ä¸­æ‰€æœ‰å…ƒç´ éƒ½å˜å¾—æ— æ•ˆï¼Œéœ€è¦ç§»åŠ¨åˆ°æ–°å†…å­˜åœ°å€çš„ buckets ä¸­ã€‚\nå¦‚æœ map å¾ˆå¤§ï¼Œä¸€æ¬¡æ€§çš„ç§»åŠ¨æƒ³å½“æ˜‚è´µï¼Œå¯èƒ½åœ¨ç›¸å½“é•¿çš„æ—¶é—´å†…é˜»å¡ goroutineã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒGo ä½¿ç”¨å¢é‡çš„æ–¹å¼ï¼Œä¸€æ¬¡åªé‡æ–°å“ˆå¸Œä¸€éƒ¨åˆ†å…ƒç´ ã€‚ä½ çš„ç¨‹åºå¯ä»¥ä¿æŒå¹³ç¨³è¿è¡Œï¼Œä¸ä¼šçªç„¶å‡ºç°æ»åã€‚\nä»æ—§ buckets è¿ç§»åˆ° æ–° buckets ä»€ä¹ˆæ—¶å€™å‘ç”Ÿ?\nä¸¤ç§æƒ…å†µ:\næ·»åŠ æ–°çš„é”®å€¼å¯¹ ä» map ä¸­åˆ é™¤é”®å€¼å¯¹ ä¾‹å¦‚ map[\u0026quot;hello\u0026quot;]=2 æ—¶ï¼Œå®é™…ç¬¬ä¸€ä»¶äº‹æ˜¯æ¸…ç©ºåŒ…å« hello çš„æ—§ bucketsã€‚\nå¦‚æœæ—§ buckets æœ‰æº¢å‡ºæ¡¶ï¼Œ map ä¹Ÿä¼šå°†è¿™äº› overflow buckets çš„å…ƒç´ ç§»åŠ¨åˆ°æ–° bucketsï¼Œç§»åŠ¨æ‰€æœ‰å…ƒç´ åï¼Œ map é€šè¿‡åœ¨ tophash å­—æ®µå°†æ—§æ¡¶æ ‡è®°ä¸º evacuated ã€‚\nå…ˆè¿™ä¹ˆå¤šå“ˆï¼ŒGo map ç¡®å®æ¯”è¿™æ›´å¤æ‚ï¼Œå¾ˆå¤šå°ç»†èŠ‚å…ˆä¸ç»†è¯´ã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Go Maps Explained: How Key-Value Pairs Are Actually Stored\n","date":"2024-08-22T00:00:00Z","permalink":"https://blog.golang.space/p/go-maps-%E5%88%86%E6%9E%90-%E9%94%AE%E5%80%BC%E5%AF%B9%E5%AE%9E%E9%99%85%E4%B8%8A%E6%98%AF%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%E7%9A%84/","title":"Go Maps åˆ†æ é”®å€¼å¯¹å®é™…ä¸Šæ˜¯å¦‚ä½•å­˜å‚¨çš„?"},{"content":"è¿­ä»£å™¨ è¿­ä»£å™¨æ˜¯å°†åºåˆ—çš„è¿ç»­å…ƒç´ ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å‡½æ•°ã€‚å½“åºåˆ—å®Œæˆæˆ–å›è°ƒè¿”å›falseæ—¶ï¼Œè¯¥å‡½æ•°å°†åœæ­¢ï¼ŒæŒ‡ç¤ºæå‰åœæ­¢è¿­ä»£ã€‚\n1.23 ä¹‹å‰çš„ stdlib ä¸­çš„è¿­ä»£å™¨çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯sync.Map.Rangeæ–¹æ³•ï¼Œå®ƒè¿­ä»£å¹¶å‘å®‰å…¨æ˜ å°„ï¼š\n1 2 3 4 5 6 7 8 9 10 var m sync.Map m.Store(\u0026#34;alice\u0026#34;, 11) m.Store(\u0026#34;bob\u0026#34;, 12) m.Store(\u0026#34;cindy\u0026#34;, 13) m.Range(func(key, value any) bool { fmt.Println(key, value) return true }) ä» Go 1.23 å¼€å§‹ï¼Œå¯ä»¥åœ¨ for-range å¾ªç¯ä¸­ä½¿ç”¨è¿­ä»£å™¨ã€‚ä»æ˜¾å¼è°ƒç”¨å˜æˆäº†éšå¼è°ƒç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 // go 1.22 m.Range(func(key, val any) bool { fmt.Println(key, val) return true }) // go 1.23 for key, val := range m.Range { fmt.Println(key, val) } for-range å¾ªç¯ä¸­çš„rangeå­å¥æ¥å—ä»¥ä¸‹ä»»æ„å‡½æ•°ç±»å‹ï¼š\n1 2 3 func(func() bool) func(func(K) bool) func(func(K, V) bool) è¿­ä»£å™¨ç±»å‹ è¿­ä»£å™¨ç±»å‹åœ¨æ–°çš„iteråŒ…ä¸­æ­£å¼å®šä¹‰ï¼š\n1 2 3 4 type ( Seq[V any] func(yield func(V) bool) Seq2[K, V any] func(yield func(K, V) bool) ) Seqäº§ç”Ÿå•ä¸ªå€¼ï¼Œè€ŒSeq2äº§ç”Ÿå¯¹ï¼ˆå°±åƒsync.Map.Rangeä¸€æ ·ï¼‰ã€‚\nYieldå‚æ•°åç§°åªæ˜¯ä¸€ä¸ªçº¦å®šï¼Œæ‚¨å¯ä»¥å°†å…¶å‘½åä¸ºfooæˆ–baræˆ–å…¶ä»–ä»»ä½•åç§° - å”¯ä¸€é‡è¦çš„æ˜¯å‡½æ•°ç­¾å\nä½¿ç”¨Seq / Seq2ç±»å‹ä½¿è¿­ä»£å™¨å®šä¹‰æ›´åŠ ç®€æ´ã€‚æ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªè¿”å›è¿­ä»£å™¨çš„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 // Reversed returns an iterator that loops over a slice in reverse order. func Reversed[V any](s []V) iter.Seq[V] { return func(yield func(V) bool) { for i := len(s) - 1; i \u0026gt;= 0; i-- { if !yield(s[i]) { return } } } } è¿˜æœ‰ä¸€ä¸ªä½¿ç”¨è¿­ä»£å™¨çš„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 // PrintAll prints all elements in a sequence. func PrintAll[V any](s iter.Seq[V]) { for v := range s { fmt.Print(v, \u0026#34; \u0026#34;) } fmt.Println() } å¹¶ä»¥æ–¹ä¾¿çš„æ–¹å¼ç»„åˆå®ƒä»¬ï¼š\n1 2 3 4 func main() { s := []int{1, 2, 3, 4, 5} PrintAll(Reversed(s)) } æ‹‰è¿­ä»£å™¨ Seqå’ŒSeq2å¯ä»¥è¢«è®¤ä¸ºæ˜¯æ¨é€è¿­ä»£å™¨ï¼Œå°†å€¼æ¨é€åˆ°æ”¶ç›Šå‡½æ•°ã€‚\næœ‰æ—¶ï¼ŒèŒƒå›´å¾ªç¯å¹¶ä¸æ˜¯ä½¿ç”¨åºåˆ—å€¼çš„é¦–é€‰æ–¹å¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨iter.Pullå°†æ¨å¼è¿­ä»£å™¨è½¬æ¢ä¸ºæ‹‰å¼è¿­ä»£å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func main() { s := []int{1, 2, 3, 4, 5} // uses the Reversed iterator defined previously next, stop := iter.Pull(Reversed(s)) defer stop() for { v, ok := next() if !ok { break } fmt.Print(v, \u0026#34; \u0026#34;) } } Pullå¯åŠ¨ä¸€ä¸ªè¿­ä»£å™¨å¹¶è¿”å›ä¸€å¯¹å‡½æ•° - nextå’Œstop - åˆ†åˆ«è¿”å›è¿­ä»£å™¨çš„ä¸‹ä¸€ä¸ªå€¼å¹¶åœæ­¢å®ƒã€‚æ‚¨è°ƒç”¨nextä»è¿­ä»£å™¨ä¸­æå–ä¸‹ä¸€ä¸ªå€¼ - å› æ­¤å¾—åã€‚\nå¦‚æœå®¢æˆ·ç«¯ä¸ä½¿ç”¨åºåˆ—æ¥å®Œæˆï¼Œåˆ™å®ƒä»¬å¿…é¡»è°ƒç”¨stop ï¼Œè¿™å…è®¸è¿­ä»£å™¨å‡½æ•°å®Œæˆå¹¶è¿”å›ã€‚å¦‚ç¤ºä¾‹æ‰€ç¤ºï¼Œç¡®ä¿è¿™ä¸€ç‚¹çš„ä¼ ç»Ÿæ–¹æ³•æ˜¯ä½¿ç”¨defer ã€‚\nåˆ‡ç‰‡è¿­ä»£å™¨ slicesåŒ…æ·»åŠ äº†å‡ ä¸ªä¸è¿­ä»£å™¨ä¸€èµ·ä½¿ç”¨çš„å‡½æ•°ã€‚\nAllè¿”å›åˆ‡ç‰‡ç´¢å¼•å’Œå€¼çš„è¿­ä»£å™¨ï¼š\n1 2 3 4 5 s := []string{\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;} for i, v := range slices.All(s) { fmt.Printf(\u0026#34;%d:%v \u0026#34;, i, v) } // 0:a 1:b 2:c Valuesè¿”å›åˆ‡ç‰‡å…ƒç´ ä¸Šçš„è¿­ä»£å™¨ï¼š\n1 2 3 4 5 s := []string{\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;} for v := range slices.Values(s) { fmt.Printf(\u0026#34;%v \u0026#34;, v) } // a b c Backwardè¿”å›ä¸€ä¸ªå€’åºåˆ‡ç‰‡çš„è¿­ä»£å™¨ï¼š\n1 2 3 4 5 s := []string{\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;} for i, v := range slices.Backward(s) { fmt.Printf(\u0026#34;%d:%v \u0026#34;, i, v) } // 2:c 1:b 0:a Collectå°†è¿­ä»£å™¨ä¸­çš„å€¼æ”¶é›†åˆ°æ–°åˆ‡ç‰‡ä¸­ï¼š\n1 2 3 4 s1 := []int{11, 12, 13} s2 := slices.Collect(slices.Values(s1)) fmt.Println(s2) // [11 12 13] AppendSeqå°†è¿­ä»£å™¨ä¸­çš„å€¼è¿½åŠ åˆ°ç°æœ‰åˆ‡ç‰‡ï¼š\n1 2 3 4 5 s1 := []int{11, 12} s2 := []int{13, 14} s := slices.AppendSeq(s1, slices.Values(s2)) fmt.Println(s) // [11 12 13 14] Sortedå°†è¿­ä»£å™¨ä¸­çš„å€¼æ”¶é›†åˆ°æ–°åˆ‡ç‰‡ä¸­ï¼Œç„¶åå¯¹åˆ‡ç‰‡è¿›è¡Œæ’åºï¼š\n1 2 3 4 s1 := []int{13, 11, 12} s2 := slices.Sorted(slices.Values(s1)) fmt.Println(s2) // [11 12 13] SortedFuncä¸ Sorted ç±»ä¼¼ï¼Œä½†å…·æœ‰æ¯”è¾ƒå‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 type person struct { name string age int } s1 := []person{{\u0026#34;cindy\u0026#34;, 20}, {\u0026#34;alice\u0026#34;, 25}, {\u0026#34;bob\u0026#34;, 30}} compare := func(p1, p2 person) int { return cmp.Compare(p1.name, p2.name) } s2 := slices.SortedFunc(slices.Values(s1), compare) fmt.Println(s2) // [{alice 25} {bob 30} {cindy 20}] SortedStableFuncä¸ SortFunc ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ç¨³å®šæ’åºç®—æ³•ã€‚\nChunkè¿”å› s çš„æœ€å¤š n ä¸ªå…ƒç´ çš„è¿ç»­å­åˆ‡ç‰‡çš„è¿­ä»£å™¨ã€‚é™¤æœ€åä¸€ä¸ªå­åˆ‡ç‰‡ä¹‹å¤–çš„æ‰€æœ‰å­åˆ‡ç‰‡çš„å¤§å°å‡ä¸º nã€‚æ‰€æœ‰å­åˆ‡ç‰‡éƒ½è¢«å‰ªè£ï¼Œä½¿å…¶æ²¡æœ‰è¶…å‡ºé•¿åº¦çš„å®¹é‡ã€‚å¦‚æœ s ä¸ºç©ºï¼Œåˆ™åºåˆ—ä¸ºç©ºï¼šåºåˆ—ä¸­ä¸å­˜åœ¨ç©ºåˆ‡ç‰‡ã€‚å¦‚æœ n å°äº 1ï¼ŒChunk ä¼šå‘ç”Ÿ panicã€‚\n1 2 3 4 5 6 s := []int{1, 2, 3, 4, 5} chunked := slices.Chunk(s, 2) for v := range chunked { fmt.Printf(\u0026#34;%v \u0026#34;, v) } // [1 2]-2 [3 4]-2 [5 6]-2 [7]-1 map è¿­ä»£å™¨ mapsåŒ…æ·»åŠ äº†å‡ ä¸ªä¸è¿­ä»£å™¨ä¸€èµ·ä½¿ç”¨çš„å‡½æ•°ï¼š\nAllè¿”å›æ˜ å°„ä¸­é”®å€¼å¯¹çš„è¿­ä»£å™¨ï¼š\n1 2 3 4 5 m := map[string]int{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, \u0026#34;c\u0026#34;: 3} for k, v := range maps.All(m) { fmt.Printf(\u0026#34;%v:%v \u0026#34;, k, v) } // a:1 b:2 c:3 Keysè¿”å›æ˜ å°„ä¸­é”®çš„è¿­ä»£å™¨ï¼š\n1 2 3 4 5 6 m := map[string]int{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, \u0026#34;c\u0026#34;: 3} for k := range maps.Keys(m) { fmt.Printf(\u0026#34;%v \u0026#34;, k) } fmt.Println() // c a b ","date":"2024-08-12T00:00:00Z","permalink":"https://blog.golang.space/p/go-1.23/","title":"Go 1.23"},{"content":"Trace runtime/trace åŒ…åŒ…å«ä¸€ä¸ªç”¨äºç†è§£ Go ç¨‹åºå’Œæ’é™¤æ•…éšœçš„å¼ºå¤§å·¥å…·ã€‚å…¶ä¸­çš„åŠŸèƒ½å…è®¸äººä»¬åœ¨ä¸€æ®µæ—¶é—´å†…ç”Ÿæˆæ¯ä¸ª goroutine æ‰§è¡Œçš„è·Ÿè¸ªã€‚ä½¿ç”¨ go tool trace å‘½ä»¤æˆ–ï¼ˆæˆ–ä¼˜ç§€çš„å¼€æºgotraceui å·¥å…·ï¼‰ï¼Œç”¨å¯è§†åŒ–çš„æ¢ç´¢è¿™äº›è·Ÿè¸ªä¸­çš„æ•°æ®ã€‚\ntrace çš„ç¥å¥‡ä¹‹å¤„åœ¨äºï¼Œå®ƒå¯ä»¥è½»æ¾åœ°æ­ç¤ºç¨‹åºä¸­éš¾ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼çœ‹åˆ°çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¤§é‡ goroutine åœ¨åŒä¸€ä¸ª channel ä¸Šé˜»å¡çš„å¹¶å‘ç“¶é¢ˆå¯èƒ½å¾ˆéš¾åœ¨ CPU profile ä¸­çœ‹åˆ°ï¼Œå› ä¸ºæ²¡æœ‰å¯ä¾›é‡‡æ ·çš„æ‰§è¡Œã€‚ä½†åœ¨ trace ä¸­ï¼Œå°†ä¼šæ¸…æ™°çš„æ˜¾ç°å‡ºæ¥ï¼Œå¹¶ä¸”è¢«é˜»å¡çš„ goroutine çš„å †æ ˆè·Ÿè¸ªå°†å¾ˆå¿«æŒ‡å‡ºç½ªé­ç¥¸é¦–ã€‚\nGo å¼€å‘äººå‘˜ç”šè‡³èƒ½å¤Ÿä½¿ç”¨ tasks, regions å’Œ logs æ¥æ£€æµ‹è‡ªå·±çš„ç¨‹åºï¼Œå®ƒä»¬å¯ä»¥ä½¿ç”¨è¿™äº›å°†æ›´é«˜çº§åˆ«çš„å…³æ³¨ç‚¹å’Œè¾ƒä½çº§åˆ«çš„æ‰§è¡Œç»†èŠ‚ç›¸å…³è”ã€‚\né—®é¢˜ ä¸å¹¸çš„æ˜¯ï¼Œæ‰§è¡Œè·Ÿè¸ªä¸­çš„å¤§é‡ä¿¡æ¯é€šå¸¸æ˜¯é¥ä¸å¯åŠçš„ã€‚å†å²ä¸Šæœ‰å››ä¸ªä¸ trace æœ‰å…³çš„å¤§é—®é¢˜å›°æ‰°ç€æˆ‘ä»¬ã€‚\ntrace çš„å¼€é”€å¾ˆé«˜ã€‚ trace ä¸èƒ½å¾ˆå¥½åœ°æ‰©å±•ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå˜çš„è¿‡å¤§è€Œæ— æ³•åˆ†æã€‚ é€šå¸¸ä¸æ¸…æ¥šä½•æ—¶å¼€å§‹ trace ä»¥æ•è·ç‰¹å®šçš„ä¸è‰¯è¡Œä¸ºã€‚ ç”±äºç¼ºä¹ç”¨äºç†è§£å’Œè§£é‡Šæ‰§è¡Œè·Ÿè¸ªçš„å…¬å…±åŒ…ï¼Œåªè¦æœ€å…·å†’é™©ç²¾ç¥çš„ gopher æ‰èƒ½ä»¥ç¼–ç¨‹æ–¹å¼åˆ†æ trace ã€‚ å¹¸è¿çš„æ˜¯ï¼ŒGo åœ¨å››ä¸ªé—®é¢˜éƒ½å–å¾—äº†å·¨å¤§çš„è¿›å±•ã€‚\nä½å¼€é”€ trace åœ¨ Go 1.21 ä¹‹å‰ï¼Œå¯¹äºè®¸å¤šåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œtrace çš„è¿è¡Œæ—¶å¼€é”€çº¦ä¸º 10~20% cpuï¼Œè¿™å°† trace é™åˆ¶æƒ…æ™¯ä½¿ç”¨æƒ…å†µï¼Œè€Œä¸æ˜¯åƒ cpu åˆ†æé‚£æ ·çš„è¿ç»­ä½¿ç”¨æƒ…å†µã€‚äº‹å®è¯æ˜ï¼Œtrace å¤§éƒ¨åˆ†æˆæœ¬éƒ½å½’ç»“ä¸ºå›æº¯ã€‚è¿è¡Œæ—¶äº§ç”Ÿçš„ç»­è·Œäº‹ä»¶éƒ½é™„åŠ äº†å †æ ˆè·Ÿè¸ªï¼Œå¯¹äºå®é™…è¯†åˆ« goroutine åœ¨æ‰§è¡Œçš„å…³é”®æ—¶åˆ»æ­£åœ¨åšä»€ä¹ˆéå¸¸æœ‰ä»·å€¼ã€‚\næ„Ÿè°¢ Felix GeisendÃ¶rfer å’Œ Nick Ripley åœ¨ä¼˜åŒ–å›æº¯æ•ˆç‡æ–¹é¢æ‰€åšçš„å·¥ä½œï¼Œæ‰§è¡Œ trace çš„è¿è¡Œæ—¶ cpu å¼€é”€å·²å¤§å¹…æ¶ˆå‡ï¼Œå¯¹äºè®¸å¤šåº”ç”¨ç¨‹åºè€Œè¨€ï¼Œå·²å°†è‡³ 1~2%ï¼Œæ‚¨å¯ä»¥åœ¨Felix å…³äºè¯¥ä¸»é¢˜çš„ç²¾å½©åšå®¢æ–‡ç« ä¸­é˜…è¯»æœ‰å…³æ­¤å¤„æ‰€åšå·¥ä½œçš„æ›´å¤šä¿¡æ¯ã€‚\nå¯ç¼©æ”¾ traces trace æ ¼å¼åŠå…¶äº‹ä»¶æ˜¯å›´ç»•ç›¸å¯¹æœ‰æ•ˆè®¾è®¡çš„ï¼Œä½†éœ€è¦å·¥å…·æ¥è§£æå’Œä¿ç•™æ•´ä¸ª trace çš„çŠ¶æ€ï¼Œå‡ ç™¾ MiB çš„ trace å¯èƒ½éœ€è¦å‡ ä¸ª GiB çš„ RAM æ¥åˆ†æã€‚\nä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªé—®é¢˜å¯¹äº trace çš„ç”Ÿæˆæ–¹å¼è‡³å…³é‡è¦ã€‚ä¸ºäº†ä¿æŒè¾ƒä½çš„è¿è¡Œæ—¶å¼€é”€ï¼Œæ‰€æœ‰äº‹ä»¶éƒ½è¢«å†™å…¥ç›¸å½“äºçº¿ç¨‹æœ¬åœ°ç¼“å†²åŒºçš„ä½ç½®ã€‚ä½†è¿™æ„å‘³ç€äº‹ä»¶çš„å‡ºç°ä¸ç¬¦åˆå…¶çœŸå®é¡ºåºï¼Œå¹¶ä¸” trace å·¥å…·éœ€è¦æ‰¿æ‹…èµ·å¼„æ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆçš„è´£ä»»ã€‚\nåœ¨ä¿æŒä½å¼€é”€çš„åŒæ—¶ä½¿ç”¨ trace æ‰©å±•çš„å…³é”®æ˜¯å¶å°”åˆ†å‰²å‡ç”Ÿæˆçš„ traceã€‚æ¯ä¸ªåˆ†å‰²ç‚¹çš„è¡Œä¸ºæœ‰ç‚¹åƒä¸€æ¬¡æ€§åŒæ—¶ç¦ç”¨å’Œé‡æ–°å¯ç”¨ traceã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰ trace æ•°æ®éƒ½å°†ä»£è¡¨ä¸€ä¸ªå®Œæ•´ä¸”ç‹¬ç«‹çš„ traceï¼Œè€Œæ–°çš„ trace æ•°æ®å°†ä»å…¶ä¸­æ–­çš„ä½ç½®æ— ç¼è¡”æ¥ã€‚\næ­£å¦‚æ‚¨å¯èƒ½æƒ³è±¡çš„é‚£æ ·ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜éœ€è¦é‡æ–°æ€è€ƒå’Œé‡å†™è¿è¡Œæ—¶ä¸­çš„ trace å®ç°çš„å¤§é‡åŸºç¡€ã€‚å¾ˆé«˜å…´åœ°è¯´è¿™é¡¹å·¥ä½œå·²åœ¨ go 1.22 ä¸­å‘å¸ƒå¹¶ä¸”ç°å·²æ™®éå¯ç”¨ã€‚é‡å†™å¸¦æ¥äº†è®¸å¤šä¸é”™çš„æ”¹è¿›ï¼ŒåŒ…æ‹¬å¯¹ go tool trace å‘½ä»¤çš„ä¸€äº›æ”¹è¿›ã€‚å¦‚æœæ‚¨å¥½å¥‡çš„è¯ï¼Œè¯¦ç»†ä¿¡æ¯éƒ½åœ¨è®¾è®¡æ–‡æ¡£ä¸­ã€‚\né£è¡Œè®°å½• å‡è®¾æ‚¨ä»äº‹ Web æœåŠ¡ï¼Œå¹¶ä¸” RPC èŠ±è´¹äº†å¾ˆé•¿æ—¶é—´ã€‚å½“æ‚¨çŸ¥é“ RPC å·²ç»èŠ±è´¹äº†ä¸€æ®µæ—¶é—´æ—¶ï¼Œæ‚¨æ— æ³•å¼€å§‹è·Ÿè¸ªï¼Œå› ä¸ºç¼“æ…¢è¯·æ±‚çš„æ ¹æœ¬åŸå› å·²ç»å‘ç”Ÿå¹¶ä¸”æ²¡æœ‰è®°å½•ã€‚\næœ‰ä¸€ç§æŠ€æœ¯å¯ä»¥å¸®åŠ©å®Œæˆæ­¤ä»»åŠ¡ï¼Œç§°ä¸ºé£è¡Œè®°å½•ï¼Œæ‚¨å¯èƒ½å·²ç»åœ¨å…¶ä»–ç¼–ç¨‹ç¯å¢ƒä¸­ç†Ÿæ‚‰äº†è¯¥æŠ€æœ¯ã€‚é£è¡Œè®°å½•çš„è¦ç‚¹æ˜¯æŒç»­è·Ÿè¸ªå¹¶å§‹ç»ˆä¿ç•™æœ€æ–°çš„è·Ÿè¸ªæ•°æ®ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚ç„¶åï¼Œä¸€æ—¦å‘ç”Ÿæœ‰è¶£çš„äº‹æƒ…ï¼Œç¨‹åºå°±å¯ä»¥å†™å‡ºå®ƒæ‰€æ‹¥æœ‰çš„ä¸€åˆ‡ï¼\nåœ¨ traces è¢«åˆ†å‰²ä¹‹å‰ï¼Œè¿™å‡ ä¹æ˜¯ä¸å¯èƒ½çš„ã€‚ä½†æ˜¯ï¼Œç”±äºå¼€é”€è¾ƒä½ï¼Œè¿ç»­trace ç°åœ¨æ˜¯å¯è¡Œçš„ï¼Œè€Œä¸”è¿è¡Œæ—¶ç°åœ¨å¯ä»¥åœ¨éœ€è¦æ—¶éšæ—¶åˆ†å‰²è·Ÿè¸ªï¼Œå› æ­¤äº‹å®è¯æ˜ï¼Œå®ç°é£è¡Œè®°å½•éå¸¸ç®€å•ã€‚\nå› æ­¤ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´åœ°å®£å¸ƒè¿›è¡Œé£è¡Œè®°å½•å™¨å®éªŒï¼Œå¯åœ¨golang.org/x/exp/trace åŒ…ä¸­æ‰¾åˆ°ã€‚\nè¯·å°è¯•ä¸€ä¸‹ï¼ä¸‹é¢æ˜¯ä¸€ä¸ªè®¾ç½®é£è¡Œè®°å½•ä»¥æ•è·é•¿ HTTP è¯·æ±‚çš„ç¤ºä¾‹ï¼Œä»¥å¸®åŠ©æ‚¨å…¥é—¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func main() { // Set up the flight recorder. fr := trace.NewFlightRecorder() fr.Start() // Set up and run an HTTP server. var once sync.Once var i int http.HandleFunc(\u0026#34;/test\u0026#34;, func(w http.ResponseWriter, r *http.Request) { start := time.Now() i++ // Do the work... // doWork(w, r) if i \u0026gt; 1000 { time.Sleep(5000 * time.Millisecond) } else { time.Sleep(200 * time.Millisecond) } // We saw a long request. Take a snapshot! if time.Since(start) \u0026gt; 300*time.Millisecond { // Do it only once for simplicity, but you can take more than one. once.Do(func() { // Grab the snapshot. var b bytes.Buffer _, err := fr.WriteTo(\u0026amp;b) if err != nil { log.Print(err) return } // Write it to a file. if err := os.WriteFile(\u0026#34;trace.out\u0026#34;, b.Bytes(), 0o755); err != nil { log.Print(err) return } }) } }) log.Fatal(http.ListenAndServe(\u0026#34;:8081\u0026#34;, nil)) } trace reader api éšç€ traces å®ç°é‡å†™ï¼Œæˆ‘ä»¬è¿˜åŠªåŠ›æ¸…ç†å…¶ä»– trace å†…éƒ¨ï¼Œä¾‹å¦‚go tool trace ã€‚è¿™å‚¬ç”Ÿäº†åˆ›å»ºä¸€ä¸ªtrace reader API çš„å°è¯•ï¼Œè¯¥ API è¶³ä»¥å…±äº«å¹¶ä¸”å¯ä»¥ä½¿è·Ÿè¸ªæ›´å®¹æ˜“è®¿é—®ã€‚\nå°±åƒé£è¡Œè®°å½•å™¨ä¸€æ ·ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´åœ°å®£å¸ƒï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ä¸€ä¸ªå®éªŒæ€§çš„è·Ÿè¸ªè¯»å–å™¨ APIï¼Œæˆ‘ä»¬æ„¿æ„ä¸å¤§å®¶åˆ†äº«ã€‚å®ƒä¸é£è¡Œè®°å½•å™¨ä½äºåŒä¸€åŒ…ä¸­ï¼Œgolang.org/x/exp/trace ã€‚\næˆ‘ä»¬è®¤ä¸ºå®ƒè¶³ä»¥å¼€å§‹åœ¨å…¶ä¸Šæ„å»ºä¸œè¥¿ï¼Œæ‰€ä»¥è¯·å°è¯•ä¸€ä¸‹ï¼ä¸‹é¢çš„ç¤ºä¾‹æµ‹é‡äº†é˜»å¡ç­‰å¾…ç½‘ç»œçš„ goroutine é˜»å¡äº‹ä»¶çš„æ¯”ä¾‹ã€‚\n","date":"2024-08-10T00:00:00Z","permalink":"https://blog.golang.space/p/go-traces/","title":"Go Traces"},{"content":"Etag 1 2 3 4 5 6 7 # å®¢æˆ·ç«¯è¯·æ±‚ GET /api/data If-None-Match: \u0026#34;abc123\u0026#34; # ä¹‹å‰æœåŠ¡å™¨è¿”å›çš„ ETag # æœåŠ¡å™¨å“åº”ï¼ˆå¦‚æœæ•°æ®æœªå˜ï¼‰ HTTP/1.1 304 Not Modified # ä¸ä¼šè¿”å›å“åº”ä½“ ETag: \u0026#34;abc123\u0026#34; # é€šå¸¸ä¼šé‡æ–°ç¡®è®¤ ETag ETag æ˜¯ HTTP ç¼“å­˜æœºåˆ¶çš„é‡è¦ç»„æˆéƒ¨åˆ†,å¯ä»¥æœ‰æ•ˆå‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“ã€‚\næœåŠ¡ç«¯æºå¸¦å“åº”å¤´ ETag æ—¶ï¼Œä¸‹æ¬¡æµè§ˆå™¨è¯·æ±‚æ—¶é—´å°†ä¼šæºå¸¦æ­¤ ETag å€¼ï¼Œå¯é€šè¿‡ If-None-Match è·å–ã€‚æœåŠ¡è¯†åˆ«åˆ°ç›¸åŒçš„ ETag å¯ç›´æ¥è¿”å› 304 çŠ¶æ€ç ã€‚\n304 çŠ¶æ€ç å“åº”å¾ˆå¿«ï¼Œä¸éœ€è¦è¿”å› Bodyï¼Œè¯¥çŠ¶æ€ç è¡¨ç¤º \u0026ldquo;Not Modified\u0026rdquo;ï¼Œå…·ä½“çš„å«ä¹‰ä¸º:\nè¯·æ±‚çš„èµ„æºæœªä¿®æ”¹ å®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨æœ¬åœ°ç¼“å­˜ å“åº”ä½“ä¸ºç©ºï¼ŒèŠ‚çœå¸¦å®½ é€šè¿‡ä¸Šé¢çš„ç†è®ºï¼Œä»¥ä¸‹æ˜¯ Go/Gin çš„ ETag ä¸­é—´ä»¶å®ç°ï¼Œä¸»è¦å†…å®¹ç®€ç•¥æ¦‚æ‹¬:\nè‡ªå®šä¹‰ EtagWriterï¼Œæ•è·å“åº”å†…å®¹ ä½¿ç”¨ SHA1 ç®—æ³•ç”ŸæˆåŸºäºå†…å®¹çš„ ETag å¤„ç† If-None-Match è¯·æ±‚å¤´ è¿”å› 304 Not Modifiedï¼ˆå¦‚æœå†…å®¹æœªå˜ï¼‰ è¿”å› 200 å’Œ body (å¦‚æœå†…å®¹å‘ç”Ÿå˜åŒ–) å·¥ä½œæµç¨‹\n1 2 3 4 5 6 7 8 9 10 æµè§ˆå™¨ ---GET---\u0026gt; æœåŠ¡å™¨ å¸¦ ETag æœåŠ¡å™¨ -----\u0026gt; æ¯”å¯¹æ•°æ® -----\u0026gt; å‘ç°æœªä¿®æ”¹ æœåŠ¡å™¨ ---304---\u0026gt; æµè§ˆå™¨ ç©ºå“åº”ä½“ æµè§ˆå™¨ -----\u0026gt; ä½¿ç”¨æœ¬åœ°ç¼“å­˜ æ³¨æ„\næ­¤å®ç°é€‚ç”¨äºå†…å®¹ä¸­å°å“åº”ï¼Œä¸­å¤§å‹é™æ€æ–‡ä»¶è¯·å‚è€ƒä¸‹ä¸€ç« èŠ‚çš„ Cache-Control ETag çš„ç”Ÿæˆå¯ä»¥æ ¹æ®éœ€æ±‚ä¿®æ”¹ï¼Œå¯ä»¥åŸºäºæ—¶é—´æˆ–ç‰ˆæœ¬å· æ ¹æ® RFC 9110ï¼ˆHTTP/1.1 è§„èŒƒï¼‰ï¼ŒETag çš„å€¼æ˜¯ä¸€ä¸ªâ€œquoted-stringâ€ï¼Œå³å¸¦å¼•å·çš„å­—ç¬¦ä¸²ã€‚å¦‚æœ ETag å€¼å‰æœ‰ W/ å‰ç¼€ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¼±æ ‡ç­¾ï¼Œè¡¨æ˜èµ„æºå†…å®¹å¤§è‡´ç›¸åŒï¼Œä½†ä¸æ˜¯å®Œå…¨ç›¸åŒã€‚å¼º ETag åˆ™è¡¨ç¤ºèµ„æºå†…å®¹å®Œå…¨ç›¸åŒã€‚ å¼ºæ ‡ç­¾ï¼šETag: \u0026quot;12345abc\u0026quot; å¼±æ ‡ç­¾ï¼šETag: W/\u0026quot;12345abc\u0026quot; SHA1 (160ä½) æ¯” MD5 (128ä½) æœ‰æ›´ä½çš„ç¢°æ’æ¦‚ç‡ï¼ŒSHA1 è™½ç„¶æ¯” MD5 æ…¢ä¸€ç‚¹ï¼Œä½†å·®å¼‚æå°ï¼Œå¯¹ ETag ç”Ÿæˆè¿™ç§ä½é¢‘æ“ä½œå½±å“å¯ä»¥å¿½ç•¥ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 type EtagWriter struct { gin.ResponseWriter body bytes.Buffer } func (w *EtagWriter) Unwrap() http.ResponseWriter { return w.ResponseWriter } func (w *EtagWriter) Write(b []byte) (int, error) { return w.body.Write(b) } func EtagHandler() gin.HandlerFunc { return func(ctx *gin.Context) { bw := EtagWriter{ ResponseWriter: ctx.Writer, } ctx.Writer = \u0026amp;bw ctx.Next() hash := sha1.New() buf := bw.body.Bytes() hash.Write(buf) etag := `\u0026#34;` + hex.EncodeToString(hash.Sum(nil)) + `\u0026#34;` if match := ctx.GetHeader(\u0026#34;If-None-Match\u0026#34;); match != \u0026#34;\u0026#34; \u0026amp;\u0026amp; match == etag { ctx.Writer.WriteHeader(http.StatusNotModified) return } ctx.Header(\u0026#34;ETag\u0026#34;, etag) if _, err := bw.ResponseWriter.Write(buf); err != nil { slog.Error(\u0026#34;write err\u0026#34;, \u0026#34;err\u0026#34;, err) } } } Cache-Control Cache-Control å’Œ ETag æ˜¯ä¸¤ç§ä¸åŒçš„ç¼“å­˜æœºåˆ¶ï¼Œå®ƒä»¬çš„ä½œç”¨å’Œåœºæ™¯ä¸åŒï¼š\n1 2 3 4 5 Cache-Control: max-age=3600 # ç¼“å­˜1å°æ—¶ Cache-Control: no-cache # æ¯æ¬¡éƒ½éœ€è¦éªŒè¯ Cache-Control: no-store # å®Œå…¨ä¸ç¼“å­˜ Cache-Control: private # åªå…è®¸æµè§ˆå™¨ç¼“å­˜ Cache-Control: public # å…è®¸ä¸­é—´ä»£ç†ç¼“å­˜ å…¶ç‰¹ç‚¹æ˜¯:\nåŸºäºæ—¶é—´çš„ç¼“å­˜ç­–ç•¥ å®Œå…¨ä¸è¯·æ±‚æœåŠ¡å™¨ï¼ˆå¦‚æœç¼“å­˜æœªè¿‡æœŸï¼‰ é€‚åˆé™æ€èµ„æºï¼ˆå›¾ç‰‡ã€CSSã€JSç­‰ï¼‰ é…ç½®ç®€å•ï¼Œæ€§èƒ½æœ€å¥½ ä¸‹æ–¹æ˜¯ Go/Gin å®ç°çš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œä¸€èˆ¬é™æ€èµ„æºçš„è·å–(HTTP/CSS/JS ç­‰)é‡‡ç”¨ GET è¯·æ±‚ï¼Œæ ¹æ®ä¼ å…¥çš„ millisecond è®©æµè§ˆå™¨ç¼“å­˜ä¸€å®šæ—¶é—´ã€‚\n1 2 3 4 5 6 7 8 9 func CacheControlMaxAge(millisecond int) gin.HandlerFunc { age := strconv.Itoa(millisecond) return func(ctx *gin.Context) { if ctx.Request.Method == \u0026#34;GET\u0026#34; { ctx.Header(\u0026#34;Cache-Control\u0026#34;, \u0026#34;max-age=\u0026#34;+age) } ctx.Next() } } ä¸¤è€…å¯ç»„åˆä½¿ç”¨\n1 2 Cache-Control: max-age=3600 ETag: \u0026#34;abc123\u0026#34; 1å°æ—¶å†…ç›´æ¥ä½¿ç”¨ç¼“å­˜ è¶…è¿‡1å°æ—¶åç”¨ETagéªŒè¯ æ—¢èŠ‚çœèµ„æºåˆä¿è¯å‡†ç¡®æ€§ å»ºè®® å»ºè®®å¯¹äºä¸ä¼šå˜åŒ–çš„é™æ€èµ„æº\n1 2 # é•¿æœŸç¼“å­˜ Cache-Control: max-age=31536000 # 1å¹´ å¯¹äº API æ•°æ®\n1 2 3 # çŸ­æœŸç¼“å­˜+ETagéªŒè¯ Cache-Control: max-age=60 # 1åˆ†é’Ÿ ETag: \u0026#34;data-version\u0026#34; å¯¹äºæ—¶åˆ»å˜åŒ–çš„å†…å®¹\n1 2 3 # åªç”¨ETag Cache-Control: no-cache ETag: \u0026#34;content-hash\u0026#34; Goweb ä¸­æœ€ä½³å®è·µ æ­¤å®è·µåœºæ™¯ä¸º Go æä¾›é™æ€ web èµ„æºè®¿é—®æœåŠ¡ï¼Œä»¥æ­¤ç±»æ¨ï¼Œä½¿ç”¨ nginx ç­‰å…¶å®ƒæ–¹å¼éƒ¨ç½² web é™æ€èµ„æºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸Šçš„ç¼“å­˜æ§åˆ¶æ–¹æ¡ˆã€‚\né€šè¿‡å‰ç¼€å°†é™æ€èµ„æºåˆ†ç»„ å¯¹äºè¯¥åˆ†ç»„ï¼Œä½¿ç”¨ gzip å‹ç¼©ï¼ŒCache-Control ç¼“å­˜åˆ°å®¢æˆ·ç«¯ ä»£ç ç¤ºä¾‹é‡Œé¢æ˜¯é€šè¿‡ embed å†…åµŒé™æ€èµ„æºçš„ï¼Œä¹Ÿå¯ä»¥è¯»å–ç£ç›˜æ–‡ä»¶ è®¿é—®æ ¹è·¯ç”±æ—¶ï¼Œè·³è½¬åˆ°é™æ€èµ„æºé¦–é¡µ 1 2 3 4 5 6 7 const publicPrefix = \u0026#34;/cloud\u0026#34; admin := router.Group(publicPrefix, gzip.Gzip(gzip.DefaultCompression), web.CacheControlMaxAge(7200)) admin.StaticFS(\u0026#34;/\u0026#34;, static.FileSystem()) g.GET(\u0026#34;/\u0026#34;, func(ctx *gin.Context) { ctx.Redirect(http.StatusPermanentRedirect, publicPrefix) }) ","date":"2024-08-01T00:00:00Z","permalink":"https://blog.golang.space/p/http-cache/","title":"HTTP Cache"},{"content":"ä»‹ç» Base64 æ˜¯ä¸€ç§ç”¨äºå°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼çš„æ ‡å‡†ç¼–ç ã€‚ Base64 é€šå¸¸ç”¨äºå¯¹ JSONã€XML å’Œ HTML ç­‰æ–‡æœ¬æ ¼å¼çš„äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œç¼–ç ã€‚ Base64 è¿˜ç”¨äºå¯¹ç”µå­é‚®ä»¶é™„ä»¶ä¸­çš„äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œç¼–ç ã€‚\nGo ä¸­çš„ Base64 ç¼–ç  Encoding æ˜¯å°†æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼çš„è¿‡ç¨‹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºæ–‡æœ¬ã€‚ base64 åŒ…æä¾›äº† EncodeToString å‡½æ•°ï¼Œç”¨äºå°†äºŒè¿›åˆ¶æ•°æ®ç¼–ç ä¸º Base64ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 package main import ( \u0026#34;encoding/base64\u0026#34; \u0026#34;fmt\u0026#34; ) func main(){ data := []byte(\u0026#34;Hello World!\u0026#34;) encoded := base64.StdEncoding.EncodeToString(data) fmt.Println(encoded) } // SGVsbG8gV29ybGQh EncodeToString å‡½æ•°å°†å­—èŠ‚åˆ‡ç‰‡ä½œä¸ºè¾“å…¥å¹¶è¿”å›å­—ç¬¦ä¸²ã€‚ StdEncoding å˜é‡æ˜¯å®ç° Encoding æ¥å£çš„ *Encoding ç±»å‹ã€‚ Encoding æ¥å£æä¾› EncodeToString åŠŸèƒ½ã€‚\nGo ä¸­çš„ Base64 è§£ç  Decoding æ˜¯å°†æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼çš„è¿‡ç¨‹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†æ–‡æœ¬è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®ã€‚ base64 åŒ…æä¾›äº† DecodeString å‡½æ•°ï¼Œç”¨äºå°† Base64 è§£ç ä¸ºäºŒè¿›åˆ¶æ•°æ®ã€‚\nDecodeString å‡½æ•°å°†å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥å¹¶è¿”å›å­—èŠ‚åˆ‡ç‰‡ã€‚ StdEncoding å˜é‡æ˜¯å®ç° Encoding æ¥å£çš„ *Encoding ç±»å‹ã€‚ Encoding æ¥å£æä¾› DecodeString åŠŸèƒ½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package main import ( \u0026#34;encoding/base64\u0026#34; \u0026#34;fmt\u0026#34; ) func main(){ data := []byte(\u0026#34;SGVsbG8gV29ybGQh\u0026#34;) decoded, err := base64.StdEncoding.DecodeString(string(data)) if err != nil { fmt.Println(err) } fmt.Println(string(decoded)) } // Hello World! URLç¼–ç ä¸è§£ç  base64 åŒ…æä¾› URLEncoding å˜é‡ï¼Œç”¨äºä½¿ç”¨ URL å’Œæ–‡ä»¶åå®‰å…¨å­—æ¯è¡¨è¿›è¡Œ Base64 ç¼–ç å’Œè§£ç ã€‚ URLEncoding å˜é‡æ˜¯å®ç° Encoding æ¥å£çš„ *Encoding ç±»å‹ã€‚ Encoding æ¥å£æä¾› EncodeToString å’Œ DecodeString åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main import ( \u0026#34;encoding/base64\u0026#34; \u0026#34;fmt\u0026#34; ) func main(){ data := []byte(\u0026#34;Hello World!\u0026#34;) encoded := base64.URLEncoding.EncodeToString(data) fmt.Println(encoded) decoded, err := base64.URLEncoding.DecodeString(encoded) if err != nil { fmt.Println(err) } fmt.Println(string(decoded)) } // SGVsbG8gV29ybGQh // Hello World! è¯¥ç¨‹åºçš„åŠŸèƒ½ä¸å‰ä¸€ä¸ªç¨‹åºç›¸åŒï¼Œä½†ä½¿ç”¨ URLEncoding å˜é‡è€Œä¸æ˜¯ StdEncoding å˜é‡ã€‚\nåŸå§‹ç¼–ç å’Œè§£ç  base64 åŒ…æä¾› RawStdEncoding å˜é‡ï¼Œç”¨äºä½¿ç”¨æ ‡å‡†åŸå§‹ã€æœªå¡«å……çš„ Base64 æ ¼å¼å¯¹ Base64 è¿›è¡Œç¼–ç å’Œè§£ç ã€‚ RawStdEncoding å˜é‡æ˜¯å®ç° Encoding æ¥å£çš„ *Encoding ç±»å‹ã€‚ Encoding æ¥å£æä¾› EncodeToString å’Œ DecodeString åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package main import ( \u0026#34;encoding/base64\u0026#34; \u0026#34;fmt\u0026#34; ) func main(){ data := []byte(\u0026#34;Hello World!\u0026#34;) encoded := base64.RawStdEncoding.EncodeToString(data) fmt.Println(encoded) decoded, err := base64.RawStdEncoding.DecodeString(encoded) if err != nil { fmt.Println(err) } fmt.Println(string(decoded)) } å½“å¯¹éœ€è¦ä»¥æ–‡æœ¬æ ¼å¼å­˜å‚¨çš„äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œç¼–ç æ—¶ï¼ŒåŸå§‹ç¼–ç å’Œè§£ç éå¸¸æœ‰ç”¨ã€‚ç¨‹åºçš„è¾“å‡ºæ˜¯ï¼š\n1 2 SGVsbG8gV29ybGQh Hello World! ç¤ºä¾‹ï¼šç¼–ç å’Œè§£ç  JSON å¯¹è±¡ base64 åŒ…æä¾›äº† EncodeToString å’Œ DecodeString å‡½æ•°ç”¨äºbase64ç¼–ç å’Œè§£ç ã€‚ json åŒ…æä¾›äº† Marshal å’Œ Unmarshal å‡½æ•°æ¥ç¼–ç å’Œè§£ç  JSONã€‚ json åŒ…è¿˜æä¾›äº† MarshalIndent å‡½æ•°ï¼Œç”¨äºä½¿ç”¨ç¼©è¿›ç¼–ç  JSONã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package main import ( \u0026#34;encoding/base64\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; ) type Person struct { Name string Age int } func main(){ p := Person{ Name: \u0026#34;John Doe\u0026#34;, Age: 30, } data, err := json.MarshalIndent(p, \u0026#34;\u0026#34;, \u0026#34; \u0026#34;) if err != nil { fmt.Println(err) } encoded := base64.StdEncoding.EncodeToString(data) fmt.Println(encoded) decoded, err := base64.StdEncoding.DecodeString(encoded) if err != nil { fmt.Println(err) } var p2 Person err = json.Unmarshal(decoded, \u0026amp;p2) if err != nil { fmt.Println(err) } fmt.Println(p2) } // eyJBY2UiOjMwLCJOYW1lIjoiSm9obiBEb2UifQ== // {30 John Doe} MarshalIndent å‡½æ•°æ¥å—ä¸€ä¸ªå€¼å¹¶è¿”å›ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ã€‚ MarshalIndent å‡½æ•°è¿˜é‡‡ç”¨å‰ç¼€å’Œç¼©è¿›å­—ç¬¦ä¸²ã€‚è¯¥å‰ç¼€è¢«æ·»åŠ åˆ°è¾“å‡ºçš„æ¯ä¸€è¡Œä¹‹å‰ã€‚ç¼©è¿›å­—ç¬¦ä¸²ç”¨äºç¼©è¿›è¾“å‡ºçš„æ¯ä¸ªçº§åˆ«ã€‚ MarshalIndent å‡½æ•°å¯¹äºä½¿ç”¨ç¼©è¿›ç¼–ç  JSON éå¸¸æœ‰ç”¨ã€‚\nUnmarshal å‡½æ•°é‡‡ç”¨ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡å’Œä¸€ä¸ªæŒ‡å‘å€¼çš„æŒ‡é’ˆã€‚ Unmarshal å‡½æ•°å¯¹ JSON ç¼–ç æ•°æ®è¿›è¡Œè§£ç ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ v æŒ‡å‘çš„å€¼ä¸­ã€‚å¦‚æœ JSON ç¼–ç æ•°æ®ä¸æ˜¯æœ‰æ•ˆè¡¨ç¤ºï¼Œ Unmarshal å‡½æ•°å°†è¿”å›é”™è¯¯v æŒ‡å‘çš„å€¼ã€‚\nBase64åŒ…ä¸­çš„å…¶ä»–å‡½æ•° NewEncoder - è¿”å›ä¸€ä¸ªæ–°çš„ Base64 æµç¼–ç å™¨ã€‚å†™å…¥è¿”å›çš„ writerï¼Œå°† base64 æ•°æ®ç¼–ç ä¸º wã€‚ NewDecoder - è¿”å›ä¸€ä¸ªæ–°çš„ Base64 æµè§£ç å™¨ã€‚ä» r è¯»å–è§£ç  Base64 æ•°æ®åˆ° wã€‚ NewEncoding - è¿”å›ç”±ç»™å®šå­—æ¯è¡¨å®šä¹‰çš„æ–°è‡ªå®šä¹‰ç¼–ç ï¼Œè¯¥ç¼–ç å¿…é¡»æ˜¯ä¸åŒ…å«å¡«å……å­—ç¬¦â€œ=â€çš„ 64 å­—èŠ‚å­—ç¬¦ä¸²ã€‚ RawStdEncoding - è¿”å›æ ‡å‡†åŸå§‹ã€æœªå¡«å……çš„ base64 ç¼–ç ã€‚ Base64 åŒ…ä¸­çš„å…¶ä»–ç±»å‹ Encoding - è¡¨ç¤º Base64 ç¼–ç /è§£ç æ–¹æ¡ˆï¼Œç”± 64 ä¸ªå­—ç¬¦çš„å­—æ¯è¡¨å®šä¹‰ã€‚æœ€å¸¸è§çš„ç”¨æ³•æ˜¯é€šè¿‡æ ‡å‡†é¢„å®šä¹‰ç¼–ç  StdEncoding å’Œ URLEncodingã€‚ CorruptInputError - æŠ¥å‘Šè¾“å…¥ä¸æ˜¯æœ‰æ•ˆçš„ Base64 æ•°æ®çš„é”™è¯¯ã€‚ å‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Golang Base64 Encoding and Decoding ","date":"2024-07-26T00:00:00Z","permalink":"https://blog.golang.space/p/base64-%E7%BC%96%E8%A7%A3%E7%A0%81/","title":"Base64 ç¼–è§£ç "},{"content":"å¦‚æœä½ åœ¨ Go 1.22 æˆ–æ›´æ—©ç‰ˆæœ¬ä¸­ä½¿ç”¨ Timer.Reset() ï¼Œä½ å¯èƒ½ä¼šåšé”™ã€‚ç”šè‡³ã€Š100 Go Mistakesã€‹ä¸€ä¹¦ï¼ˆå…³äº Go çš„ç»†å¾®å·®åˆ«é€šå¸¸æ˜¯æ­£ç¡®çš„ï¼‰ä¹ŸçŠ¯äº†é”™è¯¯ã€‚\nè®©æˆ‘ä»¬çœ‹çœ‹é—®é¢˜å¯èƒ½æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•è§£å†³å®ƒã€‚\ntime.After åœ¨ Go â‰¤1.22 çš„å¾ªç¯ä¸­ä½¿ç”¨ time.After() å¯èƒ½ä¼šå¯¼è‡´å¤§é‡å†…å­˜ä½¿ç”¨ã€‚è€ƒè™‘è¿™ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // go 1.22 type token struct{} func consumer(ctx context.Context, in \u0026lt;-chan token) { const timeout = time.Hour for { select { case \u0026lt;-in: // do stuff case \u0026lt;-time.After(timeout): // log warning case \u0026lt;-ctx.Done(): return } } } æ¶ˆè´¹è€…ä»è¾“å…¥é€šé“è¯»å–ä»¤ç‰Œï¼Œå¦‚æœä¸€å°æ—¶åé€šé“ä¸­æ²¡æœ‰å‡ºç°å€¼ï¼Œåˆ™ä¼šå‘å‡ºè­¦æŠ¥ã€‚\nè®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå®¢æˆ·ç«¯æ¥æµ‹é‡ 100K é€šé“å‘é€åçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // go 1.22 func main() { ctx, cancel := context.WithCancel(context.Background()) defer cancel() tokens := make(chan token) go consumer(ctx, tokens) memBefore := getAlloc() for range 100000 { tokens \u0026lt;- token{} } memAfter := getAlloc() memUsed := memAfter - memBefore fmt.Printf(\u0026#34;Memory used: %d KB\\n\u0026#34;, memUsed/1024) // Memory used: 20379 KB } ä»€ä¹ˆæ˜¯ getAlloc 1 2 3 4 5 6 7 8 // getAlloc returns the number of bytes of allocated // heap objects (after garbage collection). func getAlloc() uint64 { var m runtime.MemStats runtime.GC() runtime.ReadMemStats(\u0026amp;m) return m.Alloc } time.After åœ¨å¹•ååˆ›å»ºä¸€ä¸ªè®¡æ—¶å™¨ï¼Œè¯¥è®¡æ—¶å™¨åœ¨åˆ°æœŸä¹‹å‰ä¸ä¼šè¢«é‡Šæ”¾ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†è¾ƒé•¿çš„è¶…æ—¶ï¼ˆä¸€å°æ—¶ï¼‰ï¼Œå› æ­¤ for å¾ªç¯æœ¬è´¨ä¸Šåˆ›å»ºäº†æ— æ•°å°šæœªé‡Šæ”¾çš„è®¡æ—¶å™¨ã€‚è¿™äº›è®¡æ—¶å™¨æ€»å…±ä½¿ç”¨çº¦ 20 MB çš„å†…å­˜ã€‚è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚\né”™è¯¯çš„è§£å†³æ–¹æ¡ˆ æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè®¡æ—¶å™¨å¹¶åœ¨æ¯æ¬¡å¾ªç¯è¿­ä»£ä¸­é‡ç½®å®ƒæ€ä¹ˆæ ·ï¼Ÿçœ‹èµ·æ¥å¾ˆåˆç†ã€‚è¿™æ˜¯ 100 Go Mistakes å»ºè®®çš„è§£å†³æ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // go 1.22 func consumer(ctx context.Context, in \u0026lt;-chan token) { const timeout = time.Hour timer := time.NewTimer(timeout) for { timer.Reset(timeout) select { case \u0026lt;-in: // do stuff case \u0026lt;-timer.C: // log warning case \u0026lt;-ctx.Done(): return } } } // Memory used: 0 KB ç”±äºæˆ‘ä»¬é‡å¤ä½¿ç”¨ç›¸åŒçš„è®¡æ—¶å™¨å®ä¾‹è€Œä¸æ˜¯åˆ›å»ºæ–°å®ä¾‹ï¼Œå› æ­¤å†…å­˜ä½¿ç”¨é—®é¢˜å¾—åˆ°è§£å†³ã€‚ä½†é—®é¢˜æ˜¯ï¼Œè¿™ä¸æ˜¯ Go â‰¤1.22 ä¸­ä½¿ç”¨ Reset æ–¹æ³•çš„æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 // go 1.22 func main() { const timeout = 10 * time.Millisecond t := time.NewTimer(timeout) time.Sleep(20 * time.Millisecond) start := time.Now() t.Reset(timeout) \u0026lt;-t.C fmt.Printf(\u0026#34;Time elapsed: %dms\\n\u0026#34;,time.Since(start).Milliseconds()) // expected: Time elapsed: 10ms // actual: Time elapsed: 0ms } è®¡æ—¶å™¨ t çš„è¶…æ—¶æ—¶é—´ä¸º 10 æ¯«ç§’ã€‚æ‰€ä»¥æˆ‘ä»¬ç­‰å¾…äº† 20ms åï¼Œå®ƒå·²ç»è¿‡æœŸäº†ï¼Œå¹¶å‘ t.C é€šé“å‘é€äº†ä¸€ä¸ªå€¼ã€‚ç”±äº Reset ä¸ä¼šæ’ç©ºé€šé“ï¼Œå› æ­¤ \u0026lt;-t.C ä¸ä¼šé˜»å¡å¹¶ç«‹å³ç»§ç»­ã€‚å¦å¤–ï¼Œç”±äº Reset é‡æ–°å¯åŠ¨äº†è®¡æ—¶å™¨ï¼Œ10 æ¯«ç§’åæˆ‘ä»¬å°†åœ¨ t.C ä¸­çœ‹åˆ°å¦ä¸€ä¸ªå€¼ã€‚\nè¿™ä¸æ˜¯ä¸€ä¸ªå°é—®é¢˜ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœæ¶ˆè´¹è€…ä¸­çš„â€œdo stuffâ€åˆ†æ”¯èŠ±è´¹çš„æ—¶é—´è¶…è¿‡è®¡æ—¶å™¨è¶…æ—¶æ—¶é—´ä¼šå‘ç”Ÿä»€ä¹ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // go 1.22 func consumer(ctx context.Context, in \u0026lt;-chan token) { const timeout = 10 * time.Millisecond timer := time.NewTimer(timeout) for { timer.Reset(timeout) select { case \u0026lt;-in: // do stuff time.Sleep(20 * time.Millisecond) case \u0026lt;-timer.C: panic(\u0026#34;should not happen\u0026#34;) case \u0026lt;-ctx.Done(): return } } } ç”±äºè®¡æ—¶å™¨é€šé“æœªè€—å°½ï¼Œå› æ­¤æ— è®º Reset è°ƒç”¨å¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œè®¡æ—¶å™¨åˆ†æ”¯ï¼Œä»è€Œå¯¼è‡´ææ…Œã€‚\nè®©æˆ‘åœ¨è¿™é‡Œå¼•ç”¨ Go stdlib æ–‡æ¡£ï¼š\nFor a Timer created with NewTimer, Reset should be invoked only on stopped or expired timers with drained channels.\nå¯¹äºä½¿ç”¨ NewTimer åˆ›å»ºçš„è®¡æ—¶å™¨ï¼Œä»…åº”åœ¨é€šé“å·²è€—å°½çš„åœæ­¢æˆ–è¿‡æœŸè®¡æ—¶å™¨ä¸Šè°ƒç”¨ Resetã€‚\nå®ƒå¯èƒ½ä¸æ˜¯å¾ˆç›´è§‚ï¼Œä½†å®ƒæ˜¯åœ¨ Go â‰¤1.22 ä¸­æ­£ç¡®ä½¿ç”¨ Reset çš„å”¯ä¸€æ–¹æ³•ã€‚\n1.23 ä¿®å¤ Go 1.23 ä¿®å¤äº†é‡ç½®é—®é¢˜ã€‚å†æ¬¡å¼•ç”¨æ–‡æ¡£ï¼š\nThe timer channel associated with a Timer is now unbuffered, with capacity 0. The main effect of this change is that Go now guarantees that for any call to a Reset (or Stop) method, no stale values prepared before that call will be sent or received after the call.\nä¸ Timer å…³è”çš„è®¡æ—¶å™¨é€šé“ç°åœ¨æ˜¯æ— ç¼“å†²çš„ï¼Œå®¹é‡ä¸º 0ã€‚æ­¤æ›´æ”¹çš„ä¸»è¦æ•ˆæœæ˜¯ï¼ŒGo ç°åœ¨ä¿è¯å¯¹äºä»»ä½•å¯¹ Resetï¼ˆæˆ– Stopï¼‰æ–¹æ³•çš„è°ƒç”¨ï¼Œä¸ä¼šå‘é€è¯¥è°ƒç”¨ä¹‹å‰å‡†å¤‡çš„è¿‡æ—¶å€¼ï¼Œæˆ–è€…é€šè¯åæ”¶åˆ°ã€‚\nä½†å¦‚æœæ‚¨æŸ¥çœ‹ä»£ç ï¼Œæ‚¨ä¼šå‘ç°é€šé“å®é™…ä¸Šä»åœ¨ç¼“å†²ä¸­ï¼š\n1 2 3 4 5 6 7 8 // As of Go 1.23, the channel is synchronous (unbuffered, capacity 0), // eliminating the possibility of those stale values. func NewTimer(d Duration) *Timer { c := make(chan Time, 1) t := (*Timer)(newTimer(when(d), 0, sendTime, c, syncTimer(c))) t.C = c return t } time/sleep.go\næ ¹æ®æäº¤æ¶ˆæ¯ï¼ŒGo å›¢é˜Ÿå°†è®¡æ—¶å™¨é€šé“ä¿ç•™ä¸ºç¼“å†²çŠ¶æ€ï¼ˆä¸ä»£ç æ³¨é‡Šæ‰€è¿°ç›¸åï¼‰ã€‚ä½†ä»–ä»¬è¿˜ç ´è§£äº† chan ç±»å‹æœ¬èº«ï¼Œä»¥è¿”å›è®¡æ—¶å™¨é€šé“çš„é›¶é•¿åº¦å’Œå®¹é‡ï¼š\nruntime/chan.go â€¢ commit message\nå¯¹æˆ‘æ¥è¯´è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªè‚®è„çš„é»‘å®¢æ–¹æ³•ï¼Œä½†æˆ‘æ‡‚ä»€ä¹ˆï¼Ÿ\n1.23 ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆ è™½ç„¶ç®€å•çš„ Reset åº”è¯¥é€‚ç”¨äº 1.23+ï¼Œä½†åœ¨æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è®¡æ—¶å™¨åœæ­¢æˆ–è¿‡æœŸï¼Œå¹¶ä¸”å…·æœ‰è€—å°½çš„é€šé“ã€‚è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¾…åŠ©å‡½æ•°å¹¶åœ¨æ¶ˆè´¹è€…ä¸­ä½¿ç”¨å®ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // resetTimer stops, drains and resets the timer. func resetTimer(t *time.Timer, d time.Duration) { if !t.Stop() { select { case \u0026lt;-t.C: default: } } t.Reset(d) } // go 1.22 func consumer(ctx context.Context, in \u0026lt;-chan token) { const timeout = time.Hour timer := time.NewTimer(timeout) for { resetTimer(timer, timeout) select { case \u0026lt;-in: // do stuff case \u0026lt;-timer.C: // log warning case \u0026lt;-ctx.Done(): return } } } ç°åœ¨ï¼Œæ— è®ºè¶…æ—¶å€¼å’Œâ€œdo stuffâ€æ‰§è¡Œæ—¶é—´å¦‚ä½•ï¼Œæ¶ˆè´¹è€…éƒ½å¯ä»¥ä¿è¯æ­£å¸¸å·¥ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 // go 1.22 func main() { const timeout = 10 * time.Millisecond t := time.NewTimer(timeout) time.Sleep(20 * time.Millisecond) start := time.Now() resetTimer(t, timeout) \u0026lt;-t.C fmt.Printf(\u0026#34;Time elapsed: %dms\\n\u0026#34;, time.Since(start).Milliseconds()) } 1.23 åçš„è§£å†³æ–¹æ¡ˆ ä» Go 1.23 å¼€å§‹ï¼Œåƒåœ¾æ”¶é›†å™¨å¯ä»¥é‡Šæ”¾æ´»åŠ¨çš„ï¼ˆä½†æœªå¼•ç”¨çš„ï¼‰è®¡æ—¶å™¨ã€‚å› æ­¤å¾ªç¯ä¸­çš„ time.After ä¸ä¼šå †ç§¯å†…å­˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // go 1.23 func consumer(ctx context.Context, in \u0026lt;-chan token) { const timeout = time.Hour for { select { case \u0026lt;-in: // do stuff case \u0026lt;-time.After(timeout): // log warning case \u0026lt;-ctx.Done(): return } } } å½“ç„¶ï¼Œå®ƒä»ç„¶ä¼šè¿›è¡Œå¤§é‡åˆ†é…ã€‚å› æ­¤ï¼Œæ‚¨å¯èƒ½æ›´å–œæ¬¢ NewTimer + Reset æ–¹æ³• - å®ƒä¸ä¼šåˆ›å»ºæ–°çš„è®¡æ—¶å™¨ï¼Œå› æ­¤ GC ä¸éœ€è¦æ”¶é›†å®ƒä»¬ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // go 1.23 func consumer(ctx context.Context, in \u0026lt;-chan token) { const timeout = time.Hour timer := time.NewTimer(timeout) for { timer.Reset(timeout) select { case \u0026lt;-in: // do stuff case \u0026lt;-timer.C: // log warning case \u0026lt;-ctx.Done(): return } } } ä»¥ä¸‹ä¸¤ä¸ªé€‰é¡¹ï¼ˆ time.After VS timer.Reset ï¼‰ï¼š\n1 2 BenchmarkAfter-8 24 49271620 ns/op 23201095 B/op 300012 allocs/op BenchmarkReset-8 40 29428138 ns/op 652 B/op 8 allocs/op èƒœåˆ©è€…å·²ç»å¾ˆæ˜æ˜¾äº†ã€‚\ntime.AfterFunc æ›´ç³Ÿç³•çš„æ˜¯ï¼Œ time.AfterFunc è¿˜åˆ›å»ºäº†ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ªéå¸¸ä¸åŒçš„è®¡æ—¶å™¨ã€‚å®ƒæœ‰ä¸€ä¸ª nil C é€šé“ï¼Œå› æ­¤ Reset æ–¹æ³•çš„å·¥ä½œæ–¹å¼ä¸åŒï¼š\nå¦‚æœè®¡æ—¶å™¨ä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€ï¼ˆæœªåœæ­¢ï¼Œæœªè¿‡æœŸï¼‰ï¼Œ Reset ä¼šæ¸…é™¤è¶…æ—¶ï¼Œä»è€Œæœ‰æ•ˆåœ°é‡æ–°å¯åŠ¨è®¡æ—¶å™¨ã€‚ å¦‚æœè®¡æ—¶å™¨å·²åœæ­¢æˆ–åˆ°æœŸï¼Œ Reset ä¼šå®‰æ’æ–°çš„å‡½æ•°æ‰§è¡Œã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func main() { var start time.Time work := func() { fmt.Printf(\u0026#34;work done after %dms\\n\u0026#34;, time.Since(start).Milliseconds()) } // run work after 10 milliseconds timeout := 10 * time.Millisecond start = time.Now() // ignore the data race for simplicity t := time.AfterFunc(timeout, work) // wait for 5 to 15 milliseconds delay := time.Duration(5+rand.Intn(11)) * time.Millisecond time.Sleep(delay) fmt.Printf(\u0026#34;%dms has passed...\\n\u0026#34;, delay.Milliseconds()) // Reset behavior depends on whether the timer has expired t.Reset(timeout) start = time.Now() time.Sleep(50*time.Millisecond) } å¦‚æœè®¡æ—¶å™¨å°šæœªåˆ°æœŸï¼Œ Reset ä¼šæ¸…é™¤è¶…æ—¶ï¼š\n1 2 8ms has passed... work done after 10ms å¦‚æœè®¡æ—¶å™¨å·²è¿‡æœŸï¼ŒReset ä¼šå®‰æ’æ–°çš„å‡½æ•°è°ƒç”¨ï¼š\n1 2 3 work done after 10ms 13ms has passed... work done after 10ms æœ€å é‡ç”³ä¸€ä¸‹ï¼š\nGo â‰¤ 1.22ï¼šå¯¹äºä½¿ç”¨ NewTimer åˆ›å»ºçš„ Timer ï¼Œ Reset åªèƒ½åœ¨é€šé“è€—å°½çš„è®¡æ—¶å™¨åœæ­¢æˆ–è¿‡æœŸæ—¶è°ƒç”¨ã€‚ Go â‰¥ 1.23ï¼šå¯¹äºä½¿ç”¨ NewTimer åˆ›å»ºçš„ Timer ï¼Œåœ¨ä»»ä½•çŠ¶æ€ï¼ˆæ´»åŠ¨ã€åœæ­¢æˆ–è¿‡æœŸï¼‰çš„è®¡æ—¶å™¨ä¸Šè°ƒç”¨ Reset éƒ½æ˜¯å®‰å…¨çš„ã€‚ä¸éœ€è¦é€šé“è€—å°½ï¼Œå› ä¸ºè®¡æ—¶å™¨é€šé“ï¼ˆæŸç§ç¨‹åº¦ä¸Šï¼‰ä¸å†è¢«ç¼“å†²ã€‚ å¯¹äºä½¿ç”¨ AfterFunc åˆ›å»ºçš„ Timer ï¼Œ Reset è¦ä¹ˆé‡æ–°å®‰æ’è¯¥å‡½æ•°ï¼ˆå¦‚æœè®¡æ—¶å™¨ä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€ï¼‰ï¼Œè¦ä¹ˆå®‰æ’è¯¥å‡½æ•°å†æ¬¡è¿è¡Œï¼ˆå¦‚æœè®¡æ—¶å™¨å·²å·²åœæ­¢æˆ–å·²è¿‡æœŸï¼‰ã€‚ [Documentation pre-1.23] â€¢ [Documentation 1.23+] â€¢ 100 Go Mistakes\nå®šæ—¶å™¨å¹¶ä¸æ˜¯ Go ä¸­æœ€æ˜æ˜¾çš„ä¸œè¥¿ï¼Œä¸æ˜¯å—ï¼Ÿ\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Resetting timers in Go\n","date":"2024-07-18T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%9C%A8-go-%E4%B8%AD%E9%87%8D%E7%BD%AE%E8%AE%A1%E6%97%B6%E5%99%A8/","title":"åœ¨ Go ä¸­é‡ç½®è®¡æ—¶å™¨"},{"content":"2023 å¹´ï¼ŒGo 1.21 å¼•å…¥äº†é…ç½®æ–‡ä»¶å¼•å¯¼ä¼˜åŒ–ï¼ˆPGOï¼‰ã€‚ä½¿ç”¨ PGOï¼Œæ‚¨å¯ä»¥åœ¨è¿è¡Œæ—¶å‘ Go ç¼–è¯‘å™¨æä¾›åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œç„¶å Go ç¼–è¯‘å™¨ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶å°±å¦‚ä½•åœ¨ä¸‹ä¸€ä¸ªæ„å»ºä¸­ä¼˜åŒ–ä»£ç åšå‡ºæ›´æ˜æ™ºçš„å†³ç­–ã€‚\nGoogle å’Œ Uber çš„å›¢é˜Ÿä» 2021 å¹´å¼€å§‹åˆä½œæ„å»º PGOã€‚æˆ‘ä»¬ä¸€èµ·å°è¯•äº†å„ç§ä¼˜åŒ–ï¼Œä»¥æé«˜è®¡ç®—æ•ˆç‡å¹¶é™ä½æˆæœ¬ã€‚å¦‚ä»Šï¼ŒUber å·²åœ¨æ•´ä¸ªè½¦é˜ŸèŒƒå›´å†…æ¨å‡ºäº† PGOï¼Œé™ä½äº†è®¸å¤šæœåŠ¡çš„ CPU åˆ©ç”¨ç‡ã€‚é˜…è¯»æ›´å¤šå†…å®¹ï¼Œäº†è§£å¦‚ä½•åœ¨ Go åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ PGOã€‚\nä»€ä¹ˆæ˜¯PGOï¼Ÿ å½“æ‚¨æ„å»º Go äºŒè¿›åˆ¶æ–‡ä»¶æ—¶ï¼ŒGo ç¼–è¯‘å™¨ä¼šæ‰§è¡Œä¼˜åŒ–ï¼Œå°è¯•ç”Ÿæˆæ€§èƒ½æœ€ä½³çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ä½†è¿™å¹¶ä¸æ€»æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ï¼šåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿‡åº¦æ¿€è¿›çš„ä¼˜åŒ–å®é™…ä¸Šå¯èƒ½ä¼šæŸå®³æ€§èƒ½æˆ–å¯¼è‡´æ„å»ºæ—¶é—´è¿‡é•¿ï¼Œéœ€è¦æƒè¡¡å–èˆã€‚åœ¨ä¸çŸ¥é“ä»£ç åœ¨è¿è¡Œæ—¶å¦‚ä½•ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä½¿ç”¨é™æ€å¯å‘å¼æ–¹æ³•æ¥å¯¹ä»£ç æœ€å¸¸è°ƒç”¨çš„è·¯å¾„è¿›è¡Œæœ€ä½³çŒœæµ‹ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ã€‚\nä½†æ˜¯ï¼Œå¦‚æœæ‚¨å¯ä»¥å‡†ç¡®åœ°å‘Šè¯‰ç¼–è¯‘å™¨æ‚¨çš„ä»£ç åœ¨è¿è¡Œæ—¶å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿæœ‰äº† PGOï¼Œæ‚¨å°±å¯ä»¥åšåˆ°ã€‚å¦‚æœæ‚¨åœ¨ç”Ÿäº§ä¸­æ”¶é›†åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨ä¸‹ä¸€ä¸ªæ„å»ºä¸­ä½¿ç”¨æ­¤é…ç½®æ–‡ä»¶ï¼Œç¼–è¯‘å™¨å¯ä»¥åšå‡ºæ›´æ˜æ™ºçš„å†³ç­–ï¼Œä¾‹å¦‚æ›´ç§¯æåœ°ä¼˜åŒ–æœ€å¸¸ç”¨çš„å‡½æ•°ï¼Œæˆ–æ›´å‡†ç¡®åœ°é€‰æ‹©å‡½æ•°å†…çš„å¸¸è§æƒ…å†µã€‚\nåœ¨ Go åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ PGO ä½¿ç”¨ PGO éå¸¸ç®€å•ã€‚åªéœ€åœ¨è¿è¡Œæ—¶æ”¶é›†åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡æ„å»ºæ—¶å‘ç¼–è¯‘å™¨æä¾›é…ç½®æ–‡ä»¶å³å¯ã€‚å…·ä½“åšæ³•å¦‚ä¸‹ï¼š\nå¯¼å…¥å¹¶å¯ç”¨åˆ†æï¼šåœ¨ main åŒ…ä¸­ï¼Œå¯¼å…¥ net/http/pprof åŒ…ã€‚è¿™ä¼šè‡ªåŠ¨å°† /debug/pprof/profile ç«¯ç‚¹æ·»åŠ åˆ°æœåŠ¡å™¨ä»¥è·å– CPU é…ç½®æ–‡ä»¶ã€‚\næ”¶é›†é…ç½®æ–‡ä»¶ï¼šç…§å¸¸æ„å»ºæ‚¨çš„é¡¹ç›®ï¼Œç„¶ååœ¨ä»£è¡¨æ€§ç¯å¢ƒï¼ˆä¾‹å¦‚ç”Ÿäº§ã€ç™»å°ï¼‰æˆ–å®é™…æµ‹è¯•æ¡ä»¶ä¸‹è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºã€‚å½“æ‚¨çš„åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œå¹¶ç»å†å…¸å‹è´Ÿè½½æ—¶ï¼Œä»æ‚¨åœ¨ä¸Šä¸€æ­¥ä¸­åˆ›å»ºçš„æœåŠ¡å™¨ç«¯ç‚¹ä¸‹è½½é…ç½®æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºåœ¨æœ¬åœ°è¿è¡Œï¼š\n1 curl -o cpu.pprof \u0026#34;http://localhost:8080/debug/pprof/profile?seconds=30\u0026#34; ä½¿ç”¨é…ç½®æ–‡ä»¶ä¼˜åŒ–æ‚¨çš„ä¸‹ä¸€ä¸ªæ„å»ºï¼šç°åœ¨æ‚¨æœ‰äº†é…ç½®æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹ä¸€ä¸ªæ„å»ºä¸­ä½¿ç”¨å®ƒã€‚å½“ Go å·¥å…·é“¾åœ¨ä¸»åŒ…ç›®å½•ä¸­æ‰¾åˆ°åä¸º default.pgo çš„é…ç½®æ–‡ä»¶æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å¯ç”¨ PGOã€‚æˆ–è€…ï¼Œ go build çš„ -pgo æ ‡å¿—é‡‡ç”¨ç”¨äº PGO çš„é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚æˆ‘ä»¬å»ºè®®å°† default.pgo æ–‡ä»¶æäº¤åˆ°æ‚¨çš„å­˜å‚¨åº“ï¼Œä»¥ä¾¿ç”¨æˆ·è‡ªåŠ¨è®¿é—®è¯¥é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”æ‚¨çš„æ„å»ºä¿æŒå¯é‡ç°ï¼ˆå¹¶ä¸”é«˜æ€§èƒ½ï¼ï¼‰ï¼š\n1 2 $ mv cpu.pprof default.pgo $ go build è¡¡é‡æ”¹è¿›ï¼šå¦‚æœæ‚¨èƒ½å¤Ÿå¤åˆ¶åˆ›å»ºç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨æ¯ç§’æä¾›æ’å®šæ•°é‡æŸ¥è¯¢çš„è´Ÿè½½æµ‹è¯•ï¼‰ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨ä¼˜åŒ–çš„æ„å»ºå’Œæ”¶é›†æ–°çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ go tool pprof å‘½ä»¤å°†å…¶ä¸ç¬¬ä¸€ä¸ªè¿›è¡Œæ¯”è¾ƒï¼Œä»¥æµ‹é‡ CPU ä½¿ç”¨ç‡çš„å‡å°‘æƒ…å†µï¼š\n1 $ go tool pprof -diff_base nopgo.pprof yespgo.pprof æœ‰å…³å¦‚ä½•å¯¹æ€§èƒ½æ”¹è¿›è¿›è¡ŒåŸºå‡†æµ‹è¯•çš„è¯¦ç»†ç¤ºä¾‹ä»¥åŠæ›´å¤šä¿¡æ¯ï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹ Go åšå®¢ä¸­çš„è¿™ç¯‡æ–‡ç«  ã€‚æ‚¨è¿˜å¯ä»¥äº†è§£ PGO åœ¨å¹•åçš„å·¥ä½œåŸç†ä»¥åŠå¦‚ä½•åœ¨ Go docs ä¸­ç”Ÿæˆæ›´å¼ºå¤§çš„åˆ†æç­–ç•¥ã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Boost performance of Go applications with profile-guided optimization\n","date":"2024-07-12T00:00:00Z","permalink":"https://blog.golang.space/p/%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%BC%95%E5%AF%BC%E4%BC%98%E5%8C%96%E6%8F%90%E5%8D%87-go-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%80%A7%E8%83%BD/","title":"é€šè¿‡é…ç½®æ–‡ä»¶å¼•å¯¼ä¼˜åŒ–æå‡ Go åº”ç”¨ç¨‹åºçš„æ€§èƒ½"},{"content":"SOLID åŸåˆ™æ˜¯ä¸€ç»„è®¾è®¡æŒ‡å—ï¼Œå¯å¸®åŠ©å¼€å‘äººå‘˜ç¼–å†™æ›´å¯ç»´æŠ¤ã€å¯æ‰©å±•å’Œå¯æµ‹è¯•çš„ä»£ç ã€‚\næ„å»ºè½¯ä»¶æ˜¯ä¸€ä¸ªä¸æ–­å˜åŒ–çš„æŒ‘æˆ˜ã€‚ä¸ºäº†åº”å¯¹è¿™ç§å¤æ‚æ€§ï¼Œå¼€å‘äººå‘˜ä¾é ç»è¿‡éªŒè¯çš„è®¾è®¡åŸåˆ™æ¥ç¼–å†™å¥å£®ã€é€‚åº”æ€§å¼ºä¸”æ˜“äºç®¡ç†çš„ä»£ç ã€‚å…¶ä¸­ä¸€ç»„åŸåˆ™æ˜¯ SOLIDï¼ˆç”± Robert C. Martin é¦–å…ˆæå‡ºï¼‰ã€‚\nSOLID ä»£è¡¨ï¼šå•ä¸€èŒè´£ã€å¼€é—­å¼ã€é‡Œæ°æ›¿æ¢ã€æ¥å£éš”ç¦»å’Œä¾èµ–å€’ç½®ã€‚æ¯æ¡åŸåˆ™åœ¨æé«˜ç¨‹åºçš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¯æµ‹è¯•æ€§æ–¹é¢éƒ½å‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚\nå°½ç®¡Golangä¸æ˜¯çº¯ç²¹çš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥åº”ç”¨SOLIDåŸåˆ™æ¥æ”¹è¿›æˆ‘ä»¬çš„Goä»£ç ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥ç ”ç©¶æ¯ä¸ªåŸåˆ™ï¼Œæ¢ç´¢å…¶å«ä¹‰ï¼Œå¹¶å‘ç°å¦‚ä½•åœ¨ Go ä¸­æœ‰æ•ˆåœ°åˆ©ç”¨å®ƒã€‚\nS - å•ä¸€è´£ä»»åŸåˆ™ å•ä¸€èŒè´£åŸåˆ™ (Single Responsibility Principle) è§„å®šç»“æ„/åŒ…åº”ä¸“æ³¨äºå•ä¸ªæ˜ç¡®å®šä¹‰çš„åŠŸèƒ½åŒºåŸŸã€‚å°†æ¯ä¸ªç»“æ„æƒ³è±¡æˆå…·æœ‰ç‰¹å®šä¸“ä¸šçŸ¥è¯†çš„ä¸“å®¶ã€‚è¿™å¯ä»¥ä½¿æ‚¨çš„ä»£ç ä¿æŒäº•äº•æœ‰æ¡å¹¶é™ä½å¤æ‚æ€§ã€‚å¯¹ç»“æ„åŠŸèƒ½çš„æ›´æ”¹æ˜¯éš”ç¦»çš„ï¼Œä½¿ç»´æŠ¤å’Œæœªæ¥çš„æ›´æ–°å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚\nA class should have one, and only one, reason to change.\nRobert C. Martin\nGo æ“…é•¿ç»“æ„ä½“ï¼Œè€Œä¸æ˜¯ç±»ã€‚ä½†ä¸ç”¨æ‹…å¿ƒï¼ŒSRP å»ºè®®åœ¨è¿™é‡Œä»ç„¶é€‚ç”¨ã€‚å°†æ¯ä¸ªç»“æ„æƒ³è±¡ä¸ºä¸€ä¸ªç´§å¯†ç»“åˆçš„æ¨¡å—ï¼Œè´Ÿè´£ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ä»»åŠ¡ã€‚è¿™ç§æ¨¡å—åŒ–æ–¹æ³•å¯ä»¥ä¿æŒä»£ç æ•´æ´ã€é™ä½å¤æ‚æ€§å¹¶æé«˜å¯ç»´æŠ¤æ€§ã€‚\nSRP çš„é­”åŠ›ä¹Ÿå»¶ä¼¸åˆ°äº† Go åŒ…ä¸­ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼ŒåŒ…åº”è¯¥ä¸“æ³¨äºå•ä¸€åŠŸèƒ½é¢†åŸŸã€‚è¿™å¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘ä¾èµ–æ€§å¹¶ä½¿äº‹æƒ…äº•äº•æœ‰æ¡ã€‚é€šè¿‡åœ¨ç»“æ„å’ŒåŒ…ä¸­é‡‡ç”¨ SRPï¼Œæ‚¨å¯ä»¥ä¸ºå¹²å‡€ã€å¯ç»´æŠ¤å’Œå¯æ‰©å±•çš„ Go åº”ç”¨ç¨‹åºå¥ å®šåŸºç¡€ã€‚\nä¸€äº›å¥½çš„åŒ…çš„ä¾‹å­ï¼š\ncoding/json - æä¾› JSON çš„ç¼–ç /è§£ç ã€‚ net/url - è§£æ URLã€‚ ä¸å¤ªå¥½çš„ä¾‹å­ï¼š\nutils - æ‚é¡¹åƒåœ¾åœºï¼Ÿ è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª Go ä¸­çš„ç¤ºä¾‹ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª struct Surveyï¼Œå…¶ä¸­åŒ…å«ä¸€äº›å±æ€§å’Œå‡ ä¸ªæ–¹æ³•ï¼šGetTitle()ã€Validate() å’Œ Save()ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package survey type Survey struct { Title string Questions []string } func (s *Survey) GetTitle() string { return s.Title } func (s *Survey) Validate() bool { return len(s.Questions) \u0026gt; 0 } func (s *Survey) Save() error { // saves the survey to the database return nil } æˆ‘ä»¬å½“å‰çš„ Survey ç»“æ„ä¼¼ä¹è®¾è®¡å¾—å¾ˆå¥½ï¼Œé™¤äº† Save() æ–¹æ³•ä¹‹å¤–ã€‚å®ƒçš„å­˜åœ¨è¿åäº† SRPã€‚ç”±äºæ•°æ®å­˜å‚¨å’Œè°ƒæŸ¥é€»è¾‘ä½äºåŒä¸€ç»“æ„ä¸­ï¼Œç»´æŠ¤ã€æµ‹è¯•å’Œæ‰©å±•å˜å¾—æ›´å…·æŒ‘æˆ˜æ€§ã€‚\nä¸ºäº†éµå®ˆ SRPï¼Œæˆ‘ä»¬åº”è¯¥åŒºåˆ†è¿™äº›é—®é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 package survey type Survey struct { Title string Questions []string } func (s *Survey) GetTitle() string { return s.Title } func (s *Survey) Validate() bool { return len(s.Questions) \u0026gt; 0 } type Repository interface { Save(survey *Survey) error } // One of many possible implementations type InMemoryRepository struct { surveys []*Survey } func (r *InMemoryRepository) Save(survey *Survey) error { r.surveys = append(r.surveys, survey) return nil } func SaveSurvey(survey *Survey, repo Repository) error { return repo.Save(survey) } ç°åœ¨ï¼ŒSurvey ç»“æ„åªè´Ÿè´£ç®¡ç†è°ƒæŸ¥æ•°æ®ï¼Œè€Œ Repository æ¥å£å’Œ InMemoryRepository ç»“æ„åˆ™å¤„ç†æ•°æ®åº“æ“ä½œã€‚\nOâ€”â€”å¼€é—­åŸåˆ™ å¼€é—­åŸåˆ™ (Open-Closed Principle) æ˜¯è‰¯å¥½è½¯ä»¶è®¾è®¡çš„åŸºçŸ³ã€‚å®ƒè§„å®šè½¯ä»¶å®ä½“ï¼ˆç±»ã€æ¨¡å—ã€åŠŸèƒ½ç­‰ï¼‰çš„è®¾è®¡åº”è€ƒè™‘åˆ°æœªæ¥çš„å¢é•¿ã€‚è¿™æ„å‘³ç€å®ƒä»¬åº”è¯¥å¼€æ”¾æ‰©å±•ï¼Œå…è®¸æ·»åŠ æ–°ç‰¹æ€§å’ŒåŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒå…³é—­ä¿®æ”¹ã€‚ä¿®æ”¹ç°æœ‰ä»£ç æ¥é€‚åº”æ–°çš„éœ€æ±‚æ˜¯æœ‰é£é™©çš„ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¼•å…¥é”™è¯¯å¹¶ä½¿æœªæ¥çš„ç»´æŠ¤æˆä¸ºä¸€åœºå™©æ¢¦ã€‚\nA module should be open for extension but closed for modification.\nRobert C. Martin\nå›åˆ°æˆ‘ä»¬çš„è°ƒæŸ¥ç¤ºä¾‹ã€‚è®©æˆ‘ä»¬å‘ç»“æ„ä½“æ·»åŠ ä¸€ä¸ªæ–°æ–¹æ³• - Export()ï¼Œå®ƒå¯ä»¥å°†è°ƒæŸ¥æ•°æ®å¯¼å‡ºåˆ°æŸäº›å¤–éƒ¨æœåŠ¡/å­˜å‚¨ä¸­ã€‚ç”±äºå¯èƒ½æœ‰å¤šä¸ªå¯¼å‡ºç›®æ ‡ï¼Œå› æ­¤ Export() æ–¹æ³•æœ‰ä¸€ä¸ª switch å—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package survey // ... func ExportSurvey(s *Survey, dst string) error { switch dst { case \u0026#34;s3\u0026#34;: // export to s3 return nil case \u0026#34;gcs\u0026#34;: // export to gcs return nil default: return nil } } å¦‚æœæˆ‘ä»¬éœ€è¦æ·»åŠ å¯¹å…¶ä»–æœåŠ¡çš„æ”¯æŒï¼Œåˆ™å½“å‰çš„å®ç°éœ€è¦ä¿®æ”¹ï¼Œè¿™è¿åäº† OCPã€‚\nä¸ºäº†éµå®ˆ OCPï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª Exporter æ¥å£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¸ºä¸åŒçš„ç›®æ ‡æ·»åŠ æ–°çš„å¯¼å‡ºå™¨ï¼Œè€Œæ— éœ€ä¿®æ”¹ç°æœ‰çš„ä»£ç åº“ã€‚\nè¿™éµå¾ª OCPï¼Œæé«˜äº†ä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚æˆ‘ä»¬çš„ä»£ç å¯¹æ‰©å±•å¼€æ”¾ï¼ˆæˆ‘ä»¬å¯ä»¥æ·»åŠ æ–°çš„å¯¼å‡ºå™¨ï¼‰ï¼Œä½†å¯¹ä¿®æ”¹å…³é—­ï¼ˆæˆ‘ä»¬ä¸éœ€è¦æ›´æ”¹ Export() å‡½æ•°ï¼‰ã€‚\nL - é‡Œæ°æ›¿æ¢åŸç† é‡Œæ°æ›¿æ¢åŸåˆ™ (Liskov Substitution Principle) ç¡®ä¿å¯ä»¥åœ¨ä¸ç ´åç¨‹åºçš„æƒ…å†µä¸‹äº¤æ¢å¯¹è±¡ã€‚è™½ç„¶ Go ç¼ºä¹ä¼ ç»Ÿçš„ç»§æ‰¿ï¼Œä½†æ¥å£å®ç°äº†è¿™ä¸€ç‚¹ã€‚ä»»ä½•ç±»å‹éƒ½å¯ä»¥é€šè¿‡å…·æœ‰ä¸å…¶ç­¾åç›¸åŒ¹é…çš„æ–¹æ³•æ¥â€œå®ç°â€æ¥å£ã€‚è¿™æé«˜äº†çµæ´»æ€§â€”â€”ä½¿ç”¨æ¥å£çš„ä»£ç å¯ä»¥ä¸å„ç§ç±»å‹ä¸€èµ·å·¥ä½œï¼Œåªè¦å®ƒä»¬å±¥è¡ŒåˆåŒã€‚\nIf S is a subtype of T, then objects of type T may be replaced with objects of type S, without breaking the program\nB. Liskov\nåœ¨ Go ä¸­ï¼ŒLSP çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯ io.Writer æ¥å£ï¼š\n1 2 3 type Writer interface { Write(buf []byte) (n int, err error) } io.Writer çš„ç¥å¥‡ä¹‹å¤„åœ¨äºå®ƒèƒ½å¤Ÿå°†å­—èŠ‚åˆ‡ç‰‡å†™å…¥ä»»ä½•æµï¼šæ–‡ä»¶ã€HTTP å“åº”ç­‰ã€‚\nç°åœ¨å›åˆ°æˆ‘ä»¬çš„ Survey ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–¹æ³• Write() æ¥å°†è°ƒæŸ¥å¯¹è±¡å†™å…¥æŸå¤„ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°è®©å®ƒæ¥å— io.Writerï¼Œè¿™æ ·å®ç°å°±å¯ä»¥å†³å®šå°†å…¶å†™å…¥ä½•å¤„ã€‚\nè¿™ä¸ªå‡½æ•°çš„ç”¨æˆ·ç°åœ¨æœ‰å¾ˆå¤§çš„çµæ´»æ€§ï¼Œå› ä¸ºä»–ä»¬åªéœ€è¦ä½¿ç”¨ä¸€äº›å®ç° io.Writer çš„ç»“æ„ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 file, err := os.Open(\u0026#34;file.go\u0026#34;) if err != nil { log.Fatal(err) } survey := \u0026amp;Survey{Title: \u0026#34;Feedback Form\u0026#34;} WriteSurvey(\u0026amp;Survey, file) Iâ€”â€”æ¥å£éš”ç¦»åŸåˆ™ æ¥å£éš”ç¦»åŸåˆ™ (Interface Segregation Principle) è§„å®šå®¢æˆ·ç«¯ä¸åº”è¢«è¿«ä¾èµ–äºä»–ä»¬ä¸ä½¿ç”¨çš„æ¥å£ã€‚è¿™ä¸€åŸåˆ™é¼“åŠ±åˆ›å»ºæ›´å°ã€æ›´é›†ä¸­çš„ç•Œé¢ï¼Œè€Œä¸æ˜¯å¤§å‹ã€å•ä¸€çš„ç•Œé¢ã€‚\nClients should not be forced to depend on methods they do not use.\nRobert C. Martin\nåŒæ ·ï¼ŒGo çš„ io åŒ…å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚å®ƒæœ‰å¤šä¸ªå°æ¥å£åŠå…¶ç»„åˆï¼Œä¾‹å¦‚ io.Readerã€io.ReadWriterã€io.ReadCloserã€io.ReadWriteCloser ç­‰ã€‚\nåœ¨æˆ‘ä»¬çš„è°ƒæŸ¥ç¤ºä¾‹ä¸­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¤šç§é—®é¢˜ç±»å‹ï¼šæ–‡æœ¬å’Œä¸‹æ‹‰åˆ—è¡¨ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªé€šç”¨çš„ Question æ¥å£ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Question interface { SetTitle() AddOption() } type TextQuestion struct { Title string } func (q *TextQuestion) SetTitle(title string) { q.Title = title } func (q *TextQuestion) AddOption(option string) { // not supported as text fields don\u0026#39;t have options } type DropdownQuestion struct { Title string Options []string } func (q *DropdownQuestion) SetTitle(title string) { q.Title = title } func (q *DropdownQuestion) AddOption(option string) { q.Options = append(q.Options, option) } Question ç•Œé¢ä¸­çš„ AddOption() æ–¹æ³•å¾ˆçªå‡ºã€‚è¿™å¯¹äº TextQuestion æ¥è¯´æ²¡æœ‰æ„ä¹‰å¹¶ä¸”è¿åäº† ISPã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¦‚ä½•éµå¾ª ISP å¹¶æ”¹è¿›è®¾è®¡ï¼šå°†é—®é¢˜ç•Œé¢æ‹†åˆ†ä¸ºæ›´å°ã€æ›´é›†ä¸­çš„ç•Œé¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Question interface { SetTitle() } type QuestionWithOptions interface { Question AddOption() } type TextQuestion struct { Title string } func (q *TextQuestion) SetTitle(title string) { q.Title = title } type DropdownQuestion struct { Title string Options []string } func (q *DropdownQuestion) SetTitle(title string) { q.Title = title } func (q *DropdownQuestion) AddOption(option string) { q.Options = append(q.Options, option) } D - ä¾èµ–å€’ç½®åŸåˆ™ ä¾èµ–å€’ç½®åŸåˆ™ (Dependency Inversion Principle) è§„å®šé«˜çº§æ¨¡å—ä¸åº”ä¾èµ–äºä½çº§æ¨¡å—ã€‚ä¸¤è€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡ã€‚\nç®€å•æ¥è¯´ï¼ŒDIP å»ºè®®æ‚¨çš„ä»£ç åº”è¯¥ä¾èµ–äºæ¥å£æˆ–æŠ½è±¡ç±»ï¼Œè€Œä¸æ˜¯å…·ä½“çš„ç±»æˆ–å‡½æ•°ã€‚è¿™ç§æ§åˆ¶åè½¬å‡å°‘äº†è½¯ä»¶ä¸åŒéƒ¨åˆ†ä¹‹é—´çš„è€¦åˆï¼Œä½¿å…¶æ›´åŠ æ¨¡å—åŒ–ã€å¯æ‰©å±•ä¸”æ˜“äºæµ‹è¯•ã€‚\nAbstractions should not depend on details. Details should depend on abstractions.\nRobert C. Martin\nä½œä¸ºç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªå¤„ç†è°ƒæŸ¥åˆ›å»ºçš„ SurveyManager ç»“æ„ï¼Œæ‚¨å¯ä»¥æƒ³è±¡å®ƒä¾èµ–äºæ•°æ®åº“ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type InMemoryRepository struct { surveys []*Survey } type SurveyManager struct { store InMemoryRepository } func NewSurveyManager() *SurveyManager { return \u0026amp;SurveyManager{ store: InMemoryRepository{}, } } func (m *SurveyManager) Save(survey *Survey) error { return m.store.Save(survey) } è¿™é‡Œç³Ÿç³•çš„è®¾è®¡æ˜¯å®ƒä¸¥é‡ä¾èµ–InMemoryRepositoryï¼Œè¿åäº†é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—çš„åŸåˆ™ã€‚\nåŒæ ·ï¼Œæ¥å£å’Œæ„é€ å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£è€¦äº‹ç‰©ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type Repository interface { Save(survey *Survey) error } type SurveyManager struct { store Repository } func NewSurveyManager(store Repository) *SurveyManager { return \u0026amp;SurveyManager{ store: store, } } func (m *SurveyManager) Save(survey *Survey) error { return m.store.Save(survey) } ç»“è®º SOLID åŸåˆ™æ˜¯æ„å»ºå¹²å‡€ã€å¯ç»´æŠ¤å’Œå¯æ‰©å±•è½¯ä»¶çš„åŸºçŸ³ã€‚è™½ç„¶å…·ä½“çš„å®ç°ç»†èŠ‚å¯èƒ½ä¼šå› ç¼–ç¨‹è¯­è¨€çš„ä¸åŒè€Œæœ‰æ‰€ä¸åŒï¼ˆä¾‹å¦‚åœ¨ Go ä¸­ä½¿ç”¨æ¥å£ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿ï¼‰ï¼Œä½† SOLID çš„æ ¸å¿ƒåŸåˆ™ä»ç„¶æ™®éé€‚ç”¨ã€‚é€šè¿‡éµå¾ªè¿™äº›åŸåˆ™ï¼Œå¼€å‘äººå‘˜å¯ä»¥ç¼–å†™æ›´å…·é€‚åº”æ€§ã€æ›´å®¹æ˜“æµ‹è¯•å¹¶æœ€ç»ˆæ›´èƒ½é€‚åº”å˜åŒ–çš„ä»£ç ï¼Œæ— è®ºä»–ä»¬é€‰æ‹©å“ªç§è¯­è¨€ã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Mastering SOLID Principles with Go Examples ","date":"2024-07-10T00:00:00Z","permalink":"https://blog.golang.space/p/%E9%80%9A%E8%BF%87-go-%E7%A4%BA%E4%BE%8B%E6%8E%8C%E6%8F%A1-solid-%E5%8E%9F%E5%88%99/","title":"é€šè¿‡ Go ç¤ºä¾‹æŒæ¡ SOLID åŸåˆ™"},{"content":"è¿™äº›å¯èƒ½æ˜¯æ‚¨åœ¨å°è¯•ä½¿ç”¨ Go çš„ HTTP å®¢æˆ·ç«¯æ—¶çœ‹åˆ°çš„ç¬¬ä¸€ç»„ä»£ç ç‰‡æ®µã€‚\n1 2 3 4 resp, err := http.Get(\u0026#34;http://example.com/\u0026#34;) ... resp, err := http.Post(\u0026#34;http://example.com/upload\u0026#34;, \u0026#34;image/jpeg\u0026#34;, \u0026amp;buf) ... ç±»ä¼¼çš„ä»£ç å¯èƒ½å¯¼è‡´ä½ çš„ç¬¬ä¸€æ¬¡ç”Ÿäº§ä¸­æ–­ã€‚è¿™æ˜¯éå¸¸å¥½çš„ä»£ç ï¼Œå½“å°†ä»¥ä¸‹å†…å®¹å¼•å…¥å…¶ä¸­æ—¶ï¼Œäº‹æƒ…å¼€å§‹å˜å¾—å¤æ‚ã€‚\nå½“ç¨‹åºå¼€å§‹å¤§é‡ HTTP è°ƒç”¨æ—¶ã€‚ å½“ç¨‹åºå¯¹å¤šä¸ªæœåŠ¡ä¸»æœºè¿›è¡Œ HTTP è°ƒç”¨æ—¶ã€‚ å…¶èƒŒåçš„åŸå› æ˜¯ net/http åŒ…ä¸­å£°æ˜çš„è¿™ä¸ªå˜é‡ã€‚\nè®¤è¯† DefaultClient DefaultClient çš„ç±»å‹æ˜¯ *http.Clientï¼Œhttp.Client æ˜¯åŒ…å«æ‰§è¡Œ HTTP è°ƒç”¨çš„æ‰€æœ‰æ–¹æ³•ç»“æ„ã€‚DefaultClient æ˜¯ä¸€ä¸ª HTTP å®¢æˆ·ç«¯ï¼Œæ‰€æœ‰åº•å±‚è®¾ç½®éƒ½æŒ‡å‘é»˜è®¤å€¼ã€‚\nå½“æ‚¨å°è¯•è°ƒç”¨è¿™äº›åŒ…çº§ HTTP æ–¹æ³•ï¼ˆä¾‹å¦‚ http.Get ã€ http.Post ã€ http.Do ç­‰ï¼‰æ—¶ï¼Œå°†ä½¿ç”¨ DefaultClient å˜é‡ã€‚ http.Client ç»“æ„ä¸­çš„ä¸¤ä¸ªå­—æ®µå¯èƒ½ä¼šå°† http.DefaultClient çš„â€œé»˜è®¤â€å’Œâ€œå…±äº«â€è¡Œä¸ºè½¬åŒ–ä¸ºæ½œåœ¨é—®é¢˜ï¼š\n1 2 3 4 type Client struct { Transport RoundTripper Timeout time.Duration } Timeout çš„é»˜è®¤å€¼ä¸ºé›¶ï¼Œå› æ­¤ http.DefaultClient é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šè¶…æ—¶ï¼Œå¹¶ä¸”åªè¦è¿æ¥å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå°±ä¼šå°è¯•ä¿ç•™æœ¬åœ°ç«¯å£/å¥—æ¥å­—ã€‚å¦‚æœè¯·æ±‚å¤ªå¤šæ€ä¹ˆåŠï¼Ÿç­”æ¡ˆæ˜¯å‘ç”Ÿäº†ç”Ÿäº§ä¸­æ–­ï¼Œä½ å°†è€—å°½ç«¯å£ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰å¯ç”¨çš„ç«¯å£è¿›è¡Œè¿›ä¸€æ­¥çš„ HTTP è°ƒç”¨ã€‚\næ¥ä¸‹æ¥æ˜¯ http.Client ä¸­çš„ Transport å­—æ®µã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»¥ä¸‹ DefaultTransport å°†åœ¨ DefaultClient ä¸­ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 var DefaultTransport RoundTripper = \u0026amp;Transport{ Proxy: ProxyFromEnvironment, DialContext: defaultTransportDialContext(\u0026amp;net.Dialer{ Timeout: 30 * time.Second, KeepAlive: 30 * time.Second, }), ForceAttemptHTTP2: true, MaxIdleConns: 100, IdleConnTimeout: 90 * time.Second, TLSHandshakeTimeout: 10 * time.Second, ExpectContinueTimeout: 1 * time.Second, } ï¼ˆé‡Œé¢æœ‰å¾ˆå¤šä¸œè¥¿ï¼Œä½†æ˜¯æŠŠä½ çš„æ³¨æ„åŠ›è½¬å‘ MaxIdleConns ï¼‰\nè¿™æ˜¯å…³äºå®ƒçš„ä½œç”¨çš„æ–‡æ¡£ï¼š\n1 2 3 // MaxIdleConns controls the maximum number of idle (keep-alive) // connections across all hosts. Zero means no limit. MaxIdleConns int ç”±äº DefaultClient æ˜¯å…±äº«çš„ï¼Œå› æ­¤æ‚¨æœ€ç»ˆå¯èƒ½ä¼šä»ä¸­è°ƒç”¨å¤šä¸ªæœåŠ¡ï¼ˆä¸»æœºåï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé»˜è®¤å®¢æˆ·ç«¯ä¸ºç»™å®šä¸»æœºé›†ç»´æŠ¤çš„ MaxIdleConns å¯èƒ½å­˜åœ¨ä¸å…¬å¹³çš„åˆ†é…ã€‚\nä¸€ä¸ªå°ä¾‹å­ è®©æˆ‘ä»¬åœ¨è¿™é‡Œä¸¾ä¸ªæ —å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type LoanAPIClient struct {} func (l *LoanAPIClient) List() ([]Loan, error) { // .... err := http.Get(\u0026#34;https://loan.api.example.com/v1/loans\u0026#34;) // .... } type PaymentAPIClient struct {} func (p *PaymentAPIClient) Pay(amount int) (error) { // .... err := http.Post(\u0026#34;https://payment.api.example.com/v1/card\u0026#34;, \u0026#34;application/json\u0026#34;, \u0026amp;req) // .... } LoanAPIClient å’Œ PaymentAPIClient éƒ½é€šè¿‡è°ƒç”¨ http.Get å’Œ http.Post æ¥ä½¿ç”¨ http.DefaultClient ã€‚å‡è®¾æˆ‘ä»¬çš„ç¨‹åºæœ€åˆä» LoanAPIClient è¿›è¡Œ 80 æ¬¡è°ƒç”¨ï¼Œç„¶åä» PaymentAPIClient è¿›è¡Œ 200 æ¬¡è°ƒç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ DefaultClient ä»…ç»´æŠ¤æœ€å¤§100ä¸ªç©ºé—²è¿æ¥ã€‚å› æ­¤ï¼Œ LoadAPIClient å°†å é¢†è¿™ 100 ä¸ªä½ç½®ä¸­çš„ 80 ä¸ªä½ç½®ï¼Œè€Œ PaymentAPIClient å°†ä»…è·å¾— 20 ä¸ªå‰©ä½™ä½ç½®ã€‚è¿™æ„å‘³ç€å¯¹äºæ¥è‡ª PaymentAPIClient çš„å…¶ä½™ 60 ä¸ªè°ƒç”¨ï¼Œéœ€è¦æ‰“å¼€å’Œå…³é—­ä¸€ä¸ªæ–°è¿æ¥ã€‚è¿™ä¼šå¯¹æ”¯ä»˜APIæœåŠ¡å™¨é€ æˆä¸å¿…è¦çš„å‹åŠ›ã€‚è¿™äº› MaxIdleConns çš„åˆ†é…å¾ˆå¿«å°±ä¼šè„±ç¦»ä½ çš„æŒæ§ï¼ ï¼ˆç›¸ä¿¡æˆ‘ğŸ˜…ï¼‰\næˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ å¢åŠ  MaxIdleConns ï¼Ÿæ˜¯çš„ï¼Œæ‚¨å¯ä»¥ï¼Œä½†å¦‚æœå®¢æˆ·ç«¯ä»ç„¶åœ¨ LoanAPIClient å’Œ PaymentAPIClient ä¹‹é—´å…±äº«ï¼Œé‚£ä¹ˆè¿™ä¹Ÿä¼šåœ¨æŸç§ç¨‹åº¦ä¸Šå¤±æ§ã€‚\næˆ‘å‘ç°äº† MaxIdleConns çš„å…„å¼Ÿï¼Œé‚£å°±æ˜¯ MaxIdleConnsPerHost ã€‚\nè¿™æœ‰åŠ©äºä¸ºæ¯ä¸ªç«¯ç‚¹ï¼ˆä¸»æœºåï¼‰ç»´æŠ¤å¯é¢„æµ‹æ•°é‡çš„ç©ºé—²è¿æ¥ã€‚\nå¥½å§ï¼Œæˆ‘ä¼šå¦‚ä½•ä¿®å¤å®ƒ? å¦‚æœæ‚¨çš„ç¨‹åºæ­£åœ¨è°ƒç”¨å¤šä¸ª HTTP æœåŠ¡ï¼Œé‚£ä¹ˆæ‚¨å¾ˆå¯èƒ½è¿˜æƒ³è°ƒæ•´å®¢æˆ·ç«¯çš„å…¶ä»–è®¾ç½®ã€‚å› æ­¤ï¼Œä¸ºè¿™äº›æœåŠ¡æä¾›å•ç‹¬çš„ http.Client å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å°†æ¥éœ€è¦æ—¶å¯¹å®ƒä»¬è¿›è¡Œå¾®è°ƒã€‚\n1 2 3 4 5 6 7 type LoanAPIClient struct { client *http.Client } type PaymentAPIClient struct { client *http.Client } åˆ«æ‹…å¿ƒ ç»“è®ºæ˜¯è¿™æ ·çš„ï¼šä½¿ç”¨ http.DefaultClient å¼€å§‹æ˜¯å¯ä»¥çš„ã€‚ä½†å¦‚æœæ‚¨è®¤ä¸ºæ‚¨å°†æ‹¥æœ‰æ›´å¤šå®¢æˆ·ç«¯å¹¶ä¸”ä¼šè¿›è¡Œæ›´å¤š API è°ƒç”¨ï¼Œè¯·é¿å…è¿™æ ·åšã€‚\næé†’ï¼šå¦‚æœæ‚¨æ­£åœ¨ç¼–å†™å…·æœ‰ API å®¢æˆ·ç«¯çš„åº“ï¼Œè¯·ä¸ºæ‚¨çš„ç”¨æˆ·æä¾›ä¸€ä¸ªå¸®åŠ©ï¼šæä¾›ä¸€ç§è‡ªå®šä¹‰ç”¨äºè¿›è¡Œ API è°ƒç”¨çš„ http.Client çš„æ–¹æ³•ã€‚è¿™æ ·ï¼Œæ‚¨çš„ç”¨æˆ·å°±å¯ä»¥å®Œå…¨æ§åˆ¶ä»–ä»¬åœ¨ä½¿ç”¨æ‚¨çš„å®¢æˆ·ç«¯æ—¶æƒ³è¦å®ç°çš„ç›®æ ‡ã€‚\nHTTP æœåŠ¡å™¨å†…çš„ HTTP å®¢æˆ·ç«¯ä¸å¦ä¸€ä¸ªå…·æœ‰ HTTP å®¢æˆ·ç«¯çš„ HTTP æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œæ‰€æœ‰è¿™äº›éƒ½ç”±æ‚¨ç¼–å†™ã€‚é‚£å°†æ˜¯ä½ çš„æç¤ºã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äºKnow when to break up with Go\u0026rsquo;s http.DefaultClient\n","date":"2024-07-09T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%9F%A5%E9%81%93%E4%BD%95%E6%97%B6-go-%E7%9A%84-http.defaultclient-%E6%96%AD%E5%BC%80/","title":"çŸ¥é“ä½•æ—¶ Go çš„ http.DefaultClient æ–­å¼€"},{"content":"æ—¥å¿—è®°å½•å¯¹äºä»»ä½•é‡è›®ç”Ÿé•¿çš„åº”ç”¨å¿…ä¸å¯å°‘ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šå›é¡¾æ€§çš„æŸ¥é˜…æ—¥å¿—ä»¥äº†è§£è¿‡å»ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®æ—¶è®¿é—®æœ‰å…³ç‰¹å®šç”¨æˆ·æ“ä½œçš„è¯¦ç»†æµç¨‹æ˜¯è¯†åˆ«é—®é¢˜çš„æœ€ä½³(æœ‰æ—¶æ˜¯å”¯ä¸€)æ–¹æ³•ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Go åŠ Slog åŒ…å®ç°è¿™ç§æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚\nå½“ç”¨æˆ·å¼€å§‹æŠ±æ€¨åº”ç”¨ä¸­çš„ç‰¹å®šåŠŸèƒ½ä¸èµ·ä½œç”¨æ—¶ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿé¦–å…ˆï¼Œä½ å¯èƒ½ä¼šè¯„ä¼°ç—‡çŠ¶å¹¶éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨æ„æ–™ä¹‹å¤–çš„è¡Œä¸ºã€‚ç„¶åï¼Œä½ å¯ä»¥æ£€æŸ¥ä½ çš„é”™è¯¯è·Ÿè¸ªæœåŠ¡ï¼ˆè¿™é‡Œæ²¡ä»€ä¹ˆå¯çœ‹çš„ï¼‰ã€æ­£å¸¸è¿è¡Œæ—¶é—´å’Œé‡è¦æŒ‡æ ‡ï¼ˆä¸€åˆ‡æ­£å¸¸ï¼‰ã€‚æœ€åï¼Œä»»ä½•æ½œåœ¨æœ‰ç”¨ä¿¡æ¯çš„æœ€åä¸€ä¸ªæ¥æºéƒ½éšè—åœ¨æ—¥å¿—ä¸­çš„æŸä¸ªåœ°æ–¹ã€‚ä½†æ˜¯ï¼Œé»˜è®¤ç”Ÿäº§æ—¥å¿—çº§åˆ«ä¸ºâ€œINFOâ€ï¼ˆå¯¹å—ï¼Ÿï¼‰ï¼Œå› æ­¤ï¼Œå°½ç®¡å¯èƒ½å­˜åœ¨ä¸€äº›è­¦å‘Šå’Œé”™è¯¯ï¼Œä½†è¿™äº›æ—¥å¿—ä¸å¤ªå¯èƒ½åŒ…å«æœ‰å…³é—®é¢˜çš„è¶³å¤Ÿä¿¡æ¯ã€‚ä¸‹ä¸€æ­¥è¯¥æ€ä¹ˆåšï¼Ÿ\nåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³æ¢è®¨ä¸åŒçš„é€‰é¡¹ï¼ŒåŒ…æ‹¬å¦‚ä½•ä¸´æ—¶å¯ç”¨è¯¦ç»†ï¼ˆé€šå¸¸æ˜¯é€‰æ‹©æ€§ï¼‰æ—¥å¿—è®°å½•ä»¥è¿›è¡Œæ•…éšœæ’é™¤ï¼Œä»¥åŠå¦‚ä½•ä½¿è¿™äº›ç±»å‹çš„æ—¥å¿—èƒ½å¤Ÿéšæ—¶éšåœ°å®æ—¶è½»æ¾è®¿é—®ã€‚è¿™ç§æ—¥å¿—è®°å½•æœ‰æ—¶ç§°ä¸ºè¯Šæ–­æ—¥å¿—è®°å½•ã€‚\nåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ä¸€äº›ä¸åŒçš„ç­–ç•¥ï¼Œç”¨äºå°†è¯Šæ–­æ—¥å¿—è®°å½•å¼•å…¥ç”± slog åŒ…æ”¯æŒçš„ Go åº”ç”¨ç¨‹åºï¼Œå¹¶æ¶µç›–è¯¥è¿‡ç¨‹ä¸­çš„ä»¥ä¸‹ä¸»é¢˜ï¼š\næ›´æ–°å…¨å±€æ—¥å¿—çº§åˆ« (æ— è®ºæ˜¯å¦é‡å¯) Slog æ˜¯å¤§é“ï¼Œå¤§é“è‡³ç®€ å¤š handler Slogging æé«˜æ€§èƒ½çš„æ–¹æ³• æ›´æ–°å…¨å±€æ—¥å¿—çº§åˆ« (æ— è®ºæ˜¯å¦é‡å¯) è®©æˆ‘ä»¬ä»ä¸€äº›ç®€å•æ˜äº†ä¸”é€‚ç”¨äºä»»ä½•åº”ç”¨ç¨‹åºçš„ä¸œè¥¿å¼€å§‹ï¼Œè€Œä¸ä»…ä»…æ˜¯é‚£äº›ç”¨ Go ç¼–å†™çš„åº”ç”¨ç¨‹åºã€‚\nä½ å¯ä»¥æš‚æ—¶å°†åº”ç”¨ç¨‹åºæ—¥å¿—çº§åˆ«æ›´æ–°ä¸ºâ€œDEBUGâ€å¹¶é‡æ–°å¯åŠ¨å®ƒã€‚ç°åœ¨ï¼Œä½ å·²ç»è®°å½•äº†å¤§é‡æ—¥å¿—ï¼Œå¹¶ä¸”ï¼ˆæˆ‘å¸Œæœ›ï¼‰æœ‰ä¸€ä¸ªä¸é”™çš„æ—¥å¿—æ”¶é›†å’ŒæŸ¥çœ‹æœåŠ¡ï¼ˆå³ä¸æ˜¯æ™®é€šæ–‡ä»¶ï¼‰æ¥æœç´¢ç›¸å…³äº‹ä»¶ã€‚é—®é¢˜è§£å†³äº†ï¼Œç‰›é€¼ã€‚\nå¯¹å—? ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä¸èƒ½ä»…ä»…ä¸ºäº†è°ƒè¯•è€Œé‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºæ€ä¹ˆåŠ? è¿™æ­£æ˜¯ AnyCable æˆ–ä»»ä½•å…¶ä»–æœåŠ¡äºæ•°åƒä¸ªæŒä¹…è¿æ¥çš„åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚ï¼Œåœ¨çº¿æ´»åŠ¨å¹³å°ï¼‰çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé‡æ–°å¯åŠ¨æœåŠ¡å™¨å°†éœ€è¦é‡æ–°åˆå§‹åŒ–æ‰€æœ‰æ´»åŠ¨å®¢æˆ·ç«¯ï¼ˆé‡æ–°å»ºç«‹è¿æ¥å¹¶æ¢å¤çŠ¶æ€ï¼‰ã€‚ä»ç”¨æˆ·ä½“éªŒçš„è§’åº¦æ¥çœ‹ï¼Œè¿™å¹¶ä¸å¥½ï¼Œä»æœåŠ¡å™¨çš„è§’åº¦æ¥çœ‹ä¹Ÿä¸å¥½ï¼Œè€Œä¸”å¤§è§„æ¨¡çš„é‡æ–°è¿æ¥ï¼ˆä¹Ÿç§°ä¸ºè¿æ¥é›ªå´©ï¼‰å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„è´Ÿè½½å³°å€¼ã€‚\nå› æ­¤ï¼Œé‡æ–°å¯åŠ¨æœåŠ¡å™¨ä¸æ˜¯ä¸€ç§é€‰æ‹©ã€‚å› æ­¤æˆ‘ä»¬æ›´æ”¹æ—¥å¿—è®°å½•è®¾ç½®çš„å”¯ä¸€æ–¹æ³•æ˜¯å‘åº”ç”¨ç¨‹åºæ·»åŠ ä¸€äº›è‡ªå®šä¹‰é€»è¾‘ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å¼€å§‹å†™ä¸€äº› Goã€‚\nSlog æ˜¯å¤§é“ï¼Œå¤§é“è‡³ç®€ è®©æˆ‘ä»¬æ³¨æ„ slog åŒ…çš„ä¸¤ä¸ªä¸»è¦æ¦‚å¿µï¼š\nslog.Logger æ˜¯æ—¥å¿—è®°å½•å…¥å£ç‚¹ï¼Œæ˜¯è°ƒç”¨ Info() ã€ Debug() ç­‰å‡½æ•°çš„ç»“æ„ã€‚ slog.Handler æ˜¯ä¸€ä¸ªæ¥å£ï¼Œè´Ÿè´£å¤„ç†æ—¥å¿—æ¡ç›®ï¼ˆæˆ–è®°å½•ï¼‰å¹¶æ‰§è¡Œå¯¹æ—¥å¿—è®°å½•è®¾å¤‡çš„å†™å…¥ã€çº§åˆ«è¿‡æ»¤ã€æ ¼å¼åŒ–ç­‰ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨çš„åŸºæœ¬ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package main import \u0026#34;log/slog\u0026#34; func main() { opts := \u0026amp;slog.HandlerOptions{ Level: slog.LevelInfo, } logger := slog.New( slog.NewTextHandler(os.Stdout, opts), ) // ... } è¯·æ³¨æ„ï¼Œæ—¥å¿—è®°å½•çº§åˆ«æ˜¯ handler çš„ç‰¹å¾ï¼Œè€Œä¸æ˜¯ logger å®ä¾‹çš„ç‰¹å¾ã€‚æ²¡æœ‰ logger.SetLogLevel(lvl) å‡½æ•°æˆ–ä»»ä½•ç±»ä¼¼çš„æœºåˆ¶ï¼ˆå¦‚åœ¨è®¸å¤šæ—¥å¿—è®°å½•åº“ä¸­ï¼‰æ¥æ›´æ”¹æ—¥å¿—çº§åˆ«ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•åŠ¨æ€åœ°æ›´æ”¹æ—¥å¿—çº§åˆ«å‘¢ï¼Ÿ\næœ‰å¾ˆå¤šè§£å†³æ–¹æ³•ï¼Œä½†æˆ‘æ›´å–œæ¬¢çš„ä¸€ç§å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package main import \u0026#34;log/slog\u0026#34; var LOG_LEVEL = new(slog.LevelVar) func main() { LOG_LEVEL.Set(slog.LevelInfo) opts := \u0026amp;slog.HandlerOptions{ Level: LOG_LEVEL, } logger := slog.New( slog.NewTextHandler(os.Stdout, opts), ) // ... } // SetLogLevel updates the application log level func SetLogLevel(lvl slog.Level) { LOG_LEVEL.Set(lvl) } åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ç‰¹æ®Š slog.LevelVar å˜é‡ä½œä¸ºå½“å‰æ—¥å¿—è®°å½•çº§åˆ«çš„å®¹å™¨ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨ä¸ä¸­æ–­åº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹æ›´æ”¹æ—¥å¿—è®°å½•çº§åˆ«ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨è¯¥ SetLogLevel å‡½æ•°ã€‚ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ª SIGQUIT ä¿¡å·å¤„ç†ç¨‹åºæ¥åœ¨â€œDEBUGâ€å’Œâ€œINFOâ€ä¹‹é—´åˆ‡æ¢æ—¥å¿—å€¼ï¼ˆæ‚¨å¯ä»¥åœ¨æ­¤ this gist æ‰¾åˆ°ä¸€ä¸ªå®Œæ•´çš„å·¥ä½œç¤ºä¾‹ï¼‰ã€‚\nå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè½»æ¾è®¿é—®æ—¥å¿—ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ»¡è¶³ä¸æ–­å¤§æµ·æé’ˆçš„éœ€è¦ï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ³•å°±è¶³å¤Ÿå¥½äº†ï¼Œå› ä¸ºåœ¨å…¨å±€èŒƒå›´å†…å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ã€‚\næˆ‘ä»¬åœ¨å¼€å‘æ•…éšœæ’é™¤æ—¥å¿—åŠŸèƒ½æ—¶è€ƒè™‘äº†ä¸¤ä¸ªç”¨ä¾‹ï¼š\nä¸ºç”¨æˆ·æä¾›è½»æ¾çš„æ—¥å¿—è®¿é—®ã€‚ é€šè¿‡åå°ç®¡ç† UI è®¿é—®æ—¥å¿—ã€‚ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œéƒ½æ— æ³•å¯¹æ—¥å¿—çš„æ”¶é›†æ–¹å¼åšå‡ºä»»ä½•å‡è®¾ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ç‹¬ç«‹äºåŸºç¡€è®¾æ–½çš„æ–¹å¼æ¥æŒ‰éœ€æµå¼ä¼ è¾“è¯¦ç»†æ—¥å¿—ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¼€å§‹å¯»æ‰¾åŒæ—¶å°†æ—¥å¿—å†™å…¥å¤šä¸ªè¾“å‡ºçš„æ–¹æ³•ã€‚\nè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ slog å®ç°å¤šè¾“å‡ºæ—¥å¿—è®°å½•ã€‚\nå¤š handler Slogging æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰‡å‡ºæ¨¡å¼æ„å»ºä¸€ä¸ªå¤šè¾“å‡ºè®°å½•å™¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package main import \u0026#34;log/slog\u0026#34; type MultiHandler struct { left slog.Handler right slog.Handler } func (t *MultiHandler) Enabled(ctx context.Context, level slog.Level) bool { return left.Enabled() || right.Enabled() } func (t *MultiHandler) Handle(ctx context.Context, r slog.Record) (err error) { if t.left.Enabled(ctx, r.Level) { err = t.left.Handle(ctx, r) } if t.right.Enabled(ctx, r.Level) { err = t.right.Handle(ctx, r) } return } func (t *MultiHandler) WithAttrs(attrs []slog.Attr) slog.Handler { return \u0026amp;MultiHandler{t.left.WithAttrs(attrs), t.right.WithAttrs(attrs)} } func (t *MultiHandler) WithGroup(name string) slog.Handler { return \u0026amp;MultiHandler{t.left.WithGroup(name), t.right.WithGroup(name)} } func main() { jsonHandler := slog.NewJSONHandler( os.Stdout, \u0026amp;slog.HandlerOptions{ Level: slog.LevelInfo, }, ) textErrorHandler := slog.NewTextHandler( os.Stderr, \u0026amp;slog.HandlerOptions{ Level: slog.LevelError, }, ) logger := slog.New( \u0026amp;MultiHandler{ jsonHandler, textErrorHandler, }, ) // ... } æˆ‘ä»¬çš„ MultiHandler å¿…é¡»å®ç°ä»¥ä¸‹ slog.Handler æ¥å£ï¼šè¯¥ Enabled() å‡½æ•°æ˜¯è®°å½•å™¨ç”¨æ¥å†³å®šå¤„ç†ç¨‹åºæ˜¯å¦è¦å¤„ç†æ­¤æ¡ç›®çš„ä¿æŠ¤; å¦‚æœæ˜¯ï¼Œåˆ™ç”Ÿæˆ slog.Record ç»“æ„å¹¶å°†å…¶ä¼ é€’ç»™ Handle() å‡½æ•°ã€‚\nWithAttrs() and WithGroup() å‡½æ•°ç”¨äºåˆ›å»ºé™„åŠ äº†ç»™å®šä¸Šä¸‹æ–‡çš„å¤„ç†ç¨‹åºçš„å‰¯æœ¬ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å¤„ç†ç¨‹åºï¼Œå³ spy handler ï¼Œå½“ä¸”ä»…å½“è‡³å°‘æœ‰ä¸€ä¸ªç”¨æˆ·è¯·æ±‚æ—¥å¿—æ—¶ï¼Œå®ƒå°†ä½¿ç”¨æ‰€æœ‰æ—¥å¿—ã€‚ç”±äºè¯Šæ–­æ—¥å¿—è®°å½•å¯ä»¥åœ¨ç”Ÿäº§å’Œé«˜å³°æ—¶æ®µä½¿ç”¨ï¼Œå› æ­¤å­˜åœ¨ä¸æ€§èƒ½ç›¸å…³çš„é‡è¦æ³¨æ„äº‹é¡¹ï¼š\nå°† spy handler é™„åŠ åˆ°è®°å½•å™¨æ—¶ï¼Œå½“å®ƒå¤„äºéæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œä¸å¾—äº§ç”Ÿæ˜æ˜¾çš„æ€§èƒ½å¼€é”€ï¼ˆå³ï¼Œå®ƒä¸åº”è¯¥å‘ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼‰ ä¸€æ—¦æ¿€æ´»ï¼Œ spy handler ä¸å¾—å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ spy handler å¿…é¡»æ˜¯éé˜»å¡çš„ï¼ˆå¯ä»¥è·³è¿‡ä¸€äº›æ¶ˆæ¯æ¥å®ç°è¿™ä¸€ç‚¹ï¼‰ã€‚ è®©æˆ‘ä»¬åˆ†äº«ä¸€ä¸‹æˆ‘ä»¬ä¸ºè·å¾—ä»¤äººæ»¡æ„çš„æ•ˆæœè€Œé‡‡å–çš„æ­¥éª¤ï¼\næé«˜æ€§èƒ½çš„æ–¹æ³• éé˜»å¡çš„è¦æ±‚ï¼Œæ„å‘³ç€åœ¨å•ç‹¬çš„ Go åç¨‹ä¸­å¤„ç†æ—¥å¿—æ¡ç›®ï¼Œå¹¶ä½¿ç”¨é€šé“ä½œä¸ºä¼ è¾“ã€‚æˆ‘ä»¬è¿˜éœ€è¦è·Ÿè¸ªå¤„ç†ç¨‹åºçŠ¶æ€ï¼Œæ— è®ºæ˜¯æ´»åŠ¨è¿˜æ˜¯éæ´»åŠ¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†è¿™ä¸ª spy handler çš„åˆå§‹å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 type SpyHandler struct { active bool ch chan *slog.Record } func NewSpyHandler(callback func(*slog.Record)) *SpyHandler { h := \u0026amp;SpyHandler{ ch: make(chan *slog.Record, 2048), } go func() { for r := range h.ch { callback(r) } } return h } func (h *SpyHandler) Enabled(ctx context.Context, level slog.Level) bool { return true } func (h *SpyHandler) Handle(ctx context.Context, r slog.Record) error { if h.active { h.enqueueRecord(\u0026amp;r) } return nil } func (h *SpyHandler) enqueueRecord(r *slog.Record) { select { case h.ch \u0026lt;- r: default: } } ä¸Šé¢ä»£ç æ®µä¸­çš„é‡è¦éƒ¨åˆ†å¦‚ä¸‹ï¼š\nè¯¥ select { ... default:} æ¨¡å¼çš„ä½¿ç”¨é¿å…äº†å¯èƒ½é˜»å¡é€šé“å†™å…¥æ“ä½œï¼ˆå¦‚æœé€šé“çš„ç¼“å†²åŒºå·²æ»¡ï¼Œåˆ™é»˜è®¤å­å¥åªä¼šåˆ é™¤è®°å½•ï¼‰ã€‚\nEnabled() å‡½æ•°ä¸­ return true ï¼Œæˆ‘ä»¬çš„å¤„ç†ç¨‹åºåº”è¯¥æ¶ˆè´¹æ‰€æœ‰æ—¥å¿—ï¼Œå¯¹å§ï¼Ÿ åœ¨æˆ‘ä»¬ç»§ç»­å®Œå–„æ­¤å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬æœ€å¥½è¿è¡Œä¸€äº›æ€§èƒ½æµ‹è¯•å¹¶æ£€æŸ¥è¿™ç§æ–¹æ³•æ˜¯å¦å¯è¡Œã€‚å¹¸è¿çš„æ˜¯ï¼Œåœ¨ Go ä¸­ç¼–å†™æ€§èƒ½æµ‹è¯•ï¼ˆæˆ–åŸºå‡†æµ‹è¯•ï¼‰æ˜¯ä¸€ä»¶è½»è€Œæ˜“ä¸¾çš„äº‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func BenchmarkSpy(b *testing.B) { handler := slog.NewTextHandler(os.Stderr, \u0026amp;slog.HandlerOptions{Level: slog.LevelError}) callback: = func(r *slog.Record) { // Immitate some work to ensure that the spy is not blocking the logger time.Sleep(10 * time.Millisecond) } spy := NewSpyHandler(callback) configs := []struct { spy *SpyHandler active bool }{ {spy, true}, {spy, false}, {nil, false}, } for _, config := range configs { desc := \u0026#34;no spy\u0026#34; if config.spy != nil { desc = \u0026#34;active spy\u0026#34; if !config.active { desc = \u0026#34;inactive spy\u0026#34; } } b.Run(desc, func(b *testing.B) { var logger slog.Logger if config.spy != nil { config.spy.active = config.active logger = slog.New(\u0026amp;MultiHandler{handler, config.spy}) } else { logger := slog.New(handler) } b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { logger.Debug(\u0026#34;test\u0026#34;, \u0026#34;key\u0026#34;, 1, \u0026#34;key2\u0026#34;, \u0026#34;value2\u0026#34;, \u0026#34;key3\u0026#34;, 3.14) } }) } } æˆ‘ä»¬å¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 BenchmarkSpy BenchmarkSpy/active_spy 401.4 ns/op BenchmarkSpy/inactive_spy 266.0 ns/op BenchmarkSpy/no_spy 8.142 ns/op å“‡ï¼ç›‘è§†è°ƒè¯•æ—¥å¿—æ¯”æ²¡æœ‰ç›‘è§†æ…¢ 40 å€ã€‚ä½†è¿™å¹¶ä¸å¥‡æ€ªï¼šå¦‚æœæˆ‘ä»¬å°†åŸºæœ¬å¤„ç†ç¨‹åºçš„æ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºâ€œDEBUGâ€ï¼Œæˆ‘ä»¬å°†åœ¨â€œæ— ç›‘è§†â€åœºæ™¯ä¸­çœ‹åˆ°ç±»ä¼¼ï¼ˆç”šè‡³æ›´é«˜ï¼‰çš„æ•°å­—ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œé™„åŠ ä¸€ä¸ªæ´»è·ƒçš„ç›‘è§†å¤§è‡´ç­‰äºå…¨å±€å¯ç”¨è¯¦ç»†æ—¥å¿—ã€‚æ›´æœ‰è¶£çš„æ˜¯ï¼Œå³ä½¿ç›‘è§†å¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥è§‚å¯Ÿåˆ°æ˜æ˜¾çš„å¼€é”€ï¼šæ•°ç™¾çº³ç§’ vs çº¦åå‡ çº³ç§’ã€‚\nè™½ç„¶å½“æœ‰äººè¯»å–è¯Šæ–­æ—¥å¿—æ—¶ï¼Œæœ‰ä¸€äº›å¼€é”€æ˜¯å¯ä»¥çš„ï¼Œä½†æ€»æ˜¯æœ‰å¼€é”€æ˜¯ä¸å¯æ¥å—çš„ã€‚\næˆ‘å†³å®šä»”ç»†ç ”ç©¶ä¸€ä¸‹ slog æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥ä¾¿å¼„æ¸…æ¥šè¿™ç§å¼€é”€å¯èƒ½æ¥è‡ªå“ªé‡Œã€‚ä¸‹é¢æ˜¯ç”± Info() ã€ Debug() ç­‰å‡½æ•°è°ƒç”¨çš„ slog.Logger.log() å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (l *Logger) log(ctx context.Context, level Level, msg string, args ...any) { if !l.Enabled(ctx, level) { return } var pc uintptr if !internal.IgnorePC { var pcs [1]uintptr // skip [runtime.Callers, this function, this function\u0026#39;s caller] runtime.Callers(3, pcs[:]) pc = pcs[0] } r := NewRecord(time.Now(), level, msg, pc) r.Add(args...) if ctx == nil { ctx = context.Background() } _ = l.Handler().Handle(ctx, r) } ä½ å¯ä»¥çœ‹åˆ°ï¼Œå®ƒåšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è°ƒç”¨ Enabled() å‡½æ•°ï¼Œå®ƒä¾èµ–äºä¸å¤„ç†ç¨‹åºç›¸åŒçš„å‡½æ•°ã€‚ç„¶åï¼Œå¦‚æœå¤„ç†ç¨‹åºå“åº”â€œæ˜¯ï¼Œæˆ‘å·²å¯ç”¨â€ï¼Œæˆ‘ä»¬å°†åˆ†å¤šä¸ªé˜¶æ®µç”Ÿæˆæ—¥å¿—æ¡ç›®è®°å½•ã€‚çœ‹å®Œè¿™æ®µä»£ç åï¼Œæˆ‘æ„è¯†åˆ°äº†ä»€ä¹ˆï¼Ÿæˆ‘çŸ¥é“æœ‰ä¸¤ä¸ªå‡½æ•°ï¼ˆç‰¹åˆ«æ˜¯ Enabled() å’Œ Handle() ï¼‰çš„å­˜åœ¨æ˜¯æœ‰åŸå› çš„ï¼šæ„å»ºæ—¥å¿—è®°å½•ä¸æ˜¯ä¸€ä¸ªå…è´¹æ“ä½œ;ä»æ€§èƒ½çš„è§’åº¦æ¥çœ‹ï¼Œé¦–å…ˆæ„å»ºè®°å½•ï¼Œç„¶åæ‰æ£€æŸ¥æ—¥å¿—çº§åˆ«ï¼ˆå¦‚æœæˆ‘ä»¬åªæœ‰å‡½æ•° Handle() ï¼‰å°†ä¸æ˜¯æœ€ä½³çš„ã€‚\næ‚¨å¯èƒ½å·²ç»æ„è¯†åˆ°æˆ‘ä»¬éœ€è¦åº”ç”¨çš„å¿«é€Ÿä¿®å¤ç¨‹åºï¼Œä»¥é¿å…åœ¨éæ´»åŠ¨çŠ¶æ€æœŸé—´è¿›è¡Œé—´è°å¼€é”€ï¼š\n1 2 3 4 func (h *SpyHandler) Enabled(ctx context.Context, level slog.Level) bool { - return true + return h.active } è€Œè¿™ä¸ªå˜åŒ–ä¹‹åçš„åŸºå‡†æµ‹è¯•ç»“æœè¦å¥½å¾—å¤šï¼š\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¼€é”€ç°åœ¨åœ¨è¯¯å·®èŒƒå›´å†…ã€‚\nå½“æˆ‘ä»¬å°†è¿™ä¸ªæ¦‚å¿µéªŒè¯è½¬å˜ä¸ºæ›´å¼ºå¤§çš„è§£å†³æ–¹æ¡ˆæ—¶ï¼Œè®©æˆ‘è·³è¿‡è¿™ä¸€éƒ¨åˆ†ï¼ˆé€šè¿‡ç”¨åŸå­æ›¿æ¢å¸ƒå°”æ´»åŠ¨å­—æ®µä»¥å®ç°å®‰å…¨çš„å¹¶å‘ï¼Œå¹¶åœ¨è¾“å‡ºä¸­å¼•å…¥ç¼“å†²åŒºï¼‰ã€‚ç›¸åï¼Œæˆ‘æƒ³è°ˆè°ˆæˆ‘ä»¬åœ¨æŸ¥çœ‹ slog æºä»£ç æ—¶å‘ç°çš„å¦ä¸€ä¸ªä¼˜åŒ–ã€‚\nå˜¿ï¼Œæ‚¨å¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°å®Œæ•´ç‰ˆçš„ SpyHandlerï¼špalkan/slog-spy. ã€‚å®ƒæ˜¯ä» AnyCable+ ä¸­æå–çš„ï¼Œå¹¶ä¸”æ˜¯å¼€æºçš„ï¼Œå°½æƒ…äº«å—å§ï¼\nIgnorePCçš„æ•…äº‹ ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°è¿™ä¸ªå†…éƒ¨é…ç½®å‚æ•°ï¼Œ internal.IgnorePC ï¼Ÿå®ƒè´Ÿè´£å°†è°ƒç”¨æ–¹æŒ‡é’ˆé™„åŠ åˆ°æ—¥å¿—è®°å½•ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¯¥ AddSource: true é€‰é¡¹ä¸å†…ç½®å¤„ç†ç¨‹åºä¸€èµ·ä½¿ç”¨ã€‚\nåœ¨å¼€å‘ä¸­å‘æ—¥å¿—æ·»åŠ æºä»£ç è¡Œæ˜¯ä¸€ä¸ªä¸é”™çš„åŠŸèƒ½ï¼Œä½†åœ¨ç”Ÿäº§ä¸­ä¸éœ€è¦ã€‚å› æ­¤ï¼Œæˆ‘å†³å®šçœ‹çœ‹ç¦ç”¨æ­¤åŠŸèƒ½æ˜¯å¦ä¼šå¸¦æ¥ä»»ä½•æ€§èƒ½æå‡ã€‚ä¸ºæ­¤ï¼Œæˆ‘è°ƒæ•´äº† slog æºä»£ç ï¼Œå°† IgnorePC var è®¾ç½®ä¸º trueï¼Œç„¶åå†æ¬¡è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š\nThe effect of removing the caller information from the log record turned out to be quite good. I wondered why there wasnâ€™t an option to disable this feature (or why we donâ€™t automatically disable it when the AddSource option is set to false). There was an opportunity for a pull request and a contribution here butâ€¦ this fairy tale had no happy ending: this situation is already known to the Go team (and actually, thereâ€™s a benchmark in the slog package) and they decided not to overoptimize. Maybe, that will change in the future. Weâ€™ll see.\nç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€äº›ç¼–è¯‘å™¨çº§åˆ«çš„ hacky æ¥æ›´æ”¹é¡¹ç›®ä¸­çš„å€¼ IgnorePC ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 //go:linkname IgnorePC log/slog/internal.IgnorePC var IgnorePC = true å¦‚æœä½ æƒ³è®©æ—¥å¿—è®°å½•æ›´å¿«ï¼Œè¯·å°†è¿™ä¸ªå’’è¯­æ”¾åœ¨ä»£ç ä¸­çš„æŸä¸ªä½ç½®ã€‚ï¼ˆä¸è¿‡ï¼Œå¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œslog è‚¯å®šå·²ç»è¶³å¤Ÿå¿«äº†â€”â€”æŠ•å…¥å…¶ä¸­çš„å·¥ä½œå’Œæƒ³æ³•éå¸¸å‡ºè‰²ã€‚\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº Realtime diagnostic logging, or how to really spy on your Go web apps\n","date":"2024-07-04T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%AE%9E%E6%97%B6%E8%AF%8A%E6%96%AD%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%A6%82%E4%BD%95%E7%9B%91%E8%A7%86-go-web-%E5%BA%94%E7%94%A8/","title":"å®æ—¶è¯Šæ–­æ—¥å¿—è®°å½•ï¼Œå¦‚ä½•ç›‘è§† Go Web åº”ç”¨"},{"content":"Go ä»ç„¶æ˜¯ä¸€é—¨æ–°è¯­è¨€ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨å®ƒï¼Œå®ƒå¾ˆå¯èƒ½ä¸æ˜¯ä½ çš„ç¬¬ä¸€é—¨ç¼–ç¨‹è¯­è¨€ã€‚\nä¸åŒçš„è¯­è¨€ï¼Œæ—¢ä¸ºä½ å¸¦æ¥äº†ç»éªŒï¼Œä¹Ÿå¸¦æ¥äº†åè§ã€‚ä½ ç”¨ä»¥å‰çš„ä»»ä½•è¯­è¨€åšçš„äº‹æƒ…ï¼Œåœ¨ Go ä¸­ç”¨ç›¸åŒçš„æ–¹æ³•å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚\nå­¦ä¹  Go ä¸ä»…ä»…æ˜¯å­¦ä¹ ä¸€ç§æ–°çš„è¯­æ³•ã€‚è¿™ä¹Ÿæ˜¯å­¦ä¹ ä¸€ç§æ–°çš„æ€ç»´æ–¹å¼æ¥æ€è€ƒä½ çš„ç¨‹åºï¼š\nGo is a language for writing Go programs, not Java programs or Haskell programs or any other languageâ€™s programs. You need to think a different way to write good Go programs. But that takes time and effort, more than most will invest. So the usual story is to translate one program from another language into Go and see how it turns out. But translation misses idiom. A first attempt to write, for example, some Java construct in Go will likely fail, while a different Go-specific approach might succeed and illuminate. After 10 years of Java programming and 10 minutes of Go programming, any comparison of the languageâ€™s capabilities is unlikely to generate insight, yet here come the results, because thatâ€™s a modern programmerâ€™s job.\nRob Pike â€” Esmereldaâ€™s Imagination\næ­£å¦‚ Rob Pike æ‰€å»ºè®®çš„é‚£æ ·ï¼Œå¦‚æœä½ æƒ³æé«˜å›´æ£‹æŠ€èƒ½ï¼Œéœ€è¦æŠ•å…¥æ—¶é—´å’Œç²¾åŠ›æ¥å­¦ä¹ è¿™é—¨è¯­è¨€çš„ä¹ è¯­ã€‚\nGo åœ¨å‡ ä»¶äº‹ä¸Šä¸å…¶ä»–ä¼ ç»Ÿè¯­è¨€ä¸åŒï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†é‡ç‚¹ä»‹ç»å…¶ä¸­ä¹‹ä¸€ï¼šæ¥å£ã€‚\nä¸‹é¢åˆ—å‡ºäº†äººä»¬åœ¨ç¼–å†™ Go æ¥å£æ—¶å¸¸çŠ¯çš„é”™è¯¯ã€‚è¿™äº›åœ¨å…¶ä»–è¯­è¨€ä¸­å¯èƒ½ä¸æ˜¯é”™è¯¯ï¼Œä½†åœ¨ Go ä¸­ï¼Œä½ éœ€è¦å¿˜è®°å®ƒä»¬ã€‚æˆ–è€…è‡³å°‘ï¼Œç»™ä¸€ä¸ªæœºä¼šï¼Œæš‚æ—¶ä¸å’Œä»–ä»¬ä¸€èµ·å·¥ä½œï¼Œçœ‹çœ‹è¿™ä¼šæŠŠä½ å¼•å‘ä½•æ–¹ã€‚\nä½†åœ¨è¿™ä¹‹å‰ ä»¥ä¸‹æ˜¯é˜…è¯»æœ¬æ–‡æ—¶è¦è®°ä½çš„äº‹é¡¹åˆ—è¡¨ã€‚å¦‚æœä½ å·²ç»ç†Ÿæ‚‰å®ƒä»¬ï¼Œè¯·éšæ„è·³è¿‡ã€‚\næ¥å£éš”ç¦»åŸåˆ™ï¼šä¸åº”å¼ºåˆ¶å®¢æˆ·ç«¯å®ç°å®ƒä¸ä½¿ç”¨çš„æ¥å£ï¼Œä¹Ÿä¸åº”å¼ºåˆ¶å®¢æˆ·ç«¯ä¾èµ–äºå®ƒä»¬ä¸ä½¿ç”¨çš„æ–¹æ³•ã€‚\nå¤šæ€æ€§ï¼šä¸€æ®µä»£ç æ ¹æ®å®ƒæ”¶åˆ°çš„å…·ä½“æ•°æ®æ”¹å˜å…¶è¡Œä¸ºã€‚\nLiskov æ›¿æ¢åŸåˆ™ï¼šå¦‚æœä½ çš„ä»£ç ä¾èµ–äºæŠ½è±¡ï¼Œé‚£ä¹ˆä¸€ä¸ªå®ç°å¯ä»¥è¢«å¦ä¸€ä¸ªå®ç°æ›¿æ¢ï¼Œè€Œæ— éœ€æ›´æ”¹ä½ çš„ä»£ç ã€‚\næŠ½è±¡çš„ç›®çš„ä¸æ˜¯æ¨¡ç³Šä¸æ¸…ï¼Œè€Œæ˜¯åˆ›é€ ä¸€ä¸ªæ–°çš„è¯­ä¹‰å±‚æ¬¡ï¼Œåœ¨è¿™ä¸ªå±‚æ¬¡ä¸Šå¯ä»¥ç»å¯¹ç²¾ç¡®ã€‚â€” E.W.è¿ªå…‹æ–¯ç‰¹æ‹‰\næ¥å£æ˜¯ç²¾ç¡®åŒ…å«ç”¨äºç¼–å†™ç¨‹åºçš„æƒ³æ³•çš„æ¦‚å¿µã€‚\nä»¥æ­£ç¡®çš„æ–¹å¼ä½¿ç”¨æ¥å£å¯ä»¥å¸¦æ¥ç®€å•æ€§ã€å¯è¯»æ€§å’Œ organic code è®¾è®¡ã€‚\norganic code æ˜¯ä»£ç ä¼šæ ¹æ®ä½ åœ¨æŸä¸ªæ—¶é—´ç‚¹æ‰€éœ€çš„è¡Œä¸ºè€Œå¢é•¿ã€‚å®ƒä¸ä¼šå¼ºè¿«ä½ æå‰è€ƒè™‘ä½ çš„ç±»å‹ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼Œå› ä¸ºä½ å¾ˆå¯èƒ½æ— æ³•æ­£ç¡®ç†è§£å®ƒä»¬ã€‚\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ Go åçˆ±ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿ã€‚ä½ æœ‰ä¸€å°ç»„è¡Œä¸ºï¼Œä½ å¯ä»¥ä»ä¸­ç¼–å†™ä»»ä½•ä½ æƒ³è¦çš„ï¼Œè€Œä¸æ˜¯é¢„å®šä¹‰ç”±å…¶ä»–ç±»å‹ç»§æ‰¿çš„ç±»å‹å¹¶å¸Œæœ›å®ƒä»¬é€‚åˆé—®é¢˜åŸŸã€‚\nRob Pike åœ¨ golang-nuts è®ºå›ä¸Šè§£é‡Šäº†è¿™ç§æ–¹æ³•ï¼š\nGo çš„æ¥å£ä¸æ˜¯ Java æˆ– C# æ¥å£çš„å˜ä½“ï¼Œå®ƒä»¬è¿œä¸æ­¢äºæ­¤ã€‚å®ƒä»¬æ˜¯å¤§è§„æ¨¡ç¼–ç¨‹å’Œé€‚åº”æ€§å¼ºçš„æ¼”è¿›è®¾è®¡çš„å…³é”®ã€‚\næ— è®ºå¦‚ä½•ï¼Œç†è®ºå·²ç»è¶³å¤Ÿäº†ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹æœ€å¸¸è§çš„é”™è¯¯ï¼š\n1. ä½ åˆ›å»ºäº†å¤ªå¤šçš„æ¥å£ æ¥å£è¿‡å¤šçš„æœ¯è¯­ç§°ä¸ºæ¥å£æ±¡æŸ“ interface pollution.ã€‚å½“ä½ åœ¨ç¼–å†™å…·ä½“ç±»å‹ä¹‹å‰å¼€å§‹æŠ½è±¡æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ç”±äºä½ æ— æ³•é¢„è§ä½ éœ€è¦ä»€ä¹ˆæŠ½è±¡ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å†™å‡ºå¤ªå¤šçš„æ¥å£ï¼Œè¿™äº›æ¥å£åœ¨ä»¥åè¦ä¹ˆæ˜¯é”™è¯¯çš„ï¼Œè¦ä¹ˆæ˜¯æ— ç”¨çš„ã€‚\nRob Pike æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æŒ‡å—ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬é¿å…ç•Œé¢æ±¡æŸ“ï¼š\nDonâ€™t design with interfaces, discover them.\nRob Pike\nRob åœ¨è¿™é‡ŒæŒ‡å‡ºçš„æ˜¯ï¼Œä½ ä¸éœ€è¦æå‰è€ƒè™‘ä½ éœ€è¦ä»€ä¹ˆæŠ½è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨å…·ä½“ç»“æ„å¼€å§‹è®¾è®¡ï¼Œå¹¶ä»…åœ¨è®¾è®¡éœ€è¦æ—¶åˆ›å»ºæ¥å£ã€‚é€šè¿‡è¿™æ ·åšï¼Œä½ çš„ä»£ç ä¼šé¡ºå…¶è‡ªç„¶çš„å¢é•¿åˆ°é¢„æœŸçš„è®¾è®¡ã€‚\næˆ‘ä»ç„¶çœ‹åˆ°äººä»¬æå‰åˆ›å»ºæ¥å£ï¼Œå› ä¸ºä»–ä»¬è®¤ä¸ºä»–ä»¬å°†æ¥å¯èƒ½éœ€è¦å¤šä¸ªå®ç°ã€‚\næˆ‘å¯¹ä»–ä»¬è¯´ï¼š\nä»¥ä¸€ç§å¥½çš„æ–¹å¼æ‡’æƒ°ã€‚åˆ›å»ºæ¥å£çš„æœ€ä½³æ—¶æœºæ˜¯ä½ çœŸæ­£éœ€è¦å®ƒçš„æ—¶å€™ï¼Œè€Œä¸æ˜¯ä½ é¢„æµ‹éœ€è¦å®ƒçš„æ—¶å€™ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡æå‰æ€è€ƒåˆ›å»ºæ¥å£çš„ç¤ºä¾‹ï¼Œä»¥åŠå®ƒå¯¼è‡´äº†ä»€ä¹ˆã€‚\næ— ç”¨çš„æ¥å£å¾€å¾€åªæœ‰ä¸€ä¸ªå®ç°ã€‚å®ƒä»¬åªæ˜¯å¢åŠ äº†ä¸€ä¸ªé¢å¤–çš„é—´æ¥çº§åˆ«ï¼Œè¿«ä½¿ç¨‹åºå‘˜åœ¨çœŸæ­£æƒ³è¦å®ç°æ—¶æ€»æ˜¯é€šè¿‡å®ƒä»¬ã€‚\næ¥å£æ˜¯æœ‰ä»£ä»·çš„ï¼šè¿™æ˜¯æ‚¨åœ¨æ¨ç†ä»£ç æ—¶éœ€è¦è®°ä½çš„ä¸€ä¸ªæ–°æ¦‚å¿µã€‚æ­£å¦‚ Djikstra æ‰€è¯´ï¼Œç†æƒ³çš„ç•Œé¢å¿…é¡»æ˜¯â€œa new semantic level in which one can be absolutely precise.â€ã€‚\nå¦‚æœä½ çš„ä»£ç éœ€è¦ Box çš„æ¦‚å¿µï¼Œä»…ç”± Box å®ç°çš„åä¸º Container çš„é¢å¤–æ¥å£æ²¡æœ‰å¸¦æ¥ä»»ä½•å¥½å¤„ï¼Œé™¤äº†æ··æ·†ã€‚\nå› æ­¤ï¼Œåœ¨åˆ›å»ºæ¥å£ä¹‹å‰ï¼Œå…ˆé—®é—®è‡ªå·±ï¼šæ¥å£æœ‰å¤šä¸ªå®ç°å—ï¼Ÿæˆ‘å¼ºè°ƒä½¿ç”¨äº†â€˜æœ‰â€™ï¼Œå› ä¸ºâ€˜å°†ä¼šæœ‰â€™å‡è®¾äº†ä½ èƒ½é¢„æµ‹æœªæ¥ï¼Œè€Œä½ ä¸èƒ½ã€‚\n2. ä½ æœ‰å¤ªå¤šçš„æ–¹æ³• åœ¨ PHP é¡¹ç›®ä¸­ï¼Œçœ‹åˆ° 10 ç§æ–¹æ³•æ¥å£æ˜¯å¾ˆå¸¸è§çš„ã€‚åœ¨ Go ä¸­ï¼Œæ¥å£å¾ˆå°ï¼Œæ ‡å‡†åº“ä¸­æ‰€æœ‰æ¥å£ä¸Šçš„å¹³å‡æ–¹æ³•æ•°ä¸º 2ã€‚\nThe bigger the interface the weaker the abstractionï¼Œè¿™æ˜¯ Go è°šè¯­ä¹‹ä¸€ã€‚æ­£å¦‚ Rob Pike æ‰€è¯´ï¼Œè¿™æ˜¯æ¥å£æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œè¿™æ„å‘³ç€æ¥å£è¶Šå°ï¼Œå®ƒå°±è¶Šæœ‰ç”¨ã€‚\næ¥å£å¯ä»¥æ‹¥æœ‰çš„å®ç°è¶Šå¤šï¼Œå®ƒçš„é€šç”¨æ€§å°±è¶Šå¼ºã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªåŒ…å«å¤§é‡æ–¹æ³•çš„æ¥å£ï¼Œåˆ™å¾ˆéš¾æœ‰å®ƒçš„å¤šä¸ªå®ç°ã€‚æ‚¨æ‹¥æœ‰çš„æ–¹æ³•è¶Šå¤šï¼Œæ¥å£å°±è¶Šå…·ä½“ã€‚å®ƒè¶Šå…·ä½“ï¼Œä¸åŒç±»å‹æ˜¾ç¤ºç›¸åŒè¡Œä¸ºçš„å¯èƒ½æ€§å°±è¶Šä½ã€‚\næœ‰ç”¨æ¥å£çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯ io.Reader å’Œ io.Writerï¼Œå®ƒä»¬å…·æœ‰æ•°ç™¾ä¸ªå®ç°ã€‚æˆ–è€… error æ¥å£ï¼Œå®ƒéå¸¸å¼ºå¤§ï¼Œå¯ä»¥åœ¨ Go ä¸­å®ç°æ•´ä¸ªé”™è¯¯å¤„ç†ã€‚\nè¯·è®°ä½ï¼Œä½ å¯ä»¥ç¨åç”¨å…¶ä»–æ¥å£ç»„åˆæ¥å£ã€‚ä¾‹å¦‚ï¼Œ ReadWriteCloser ä¸‹é¢æ˜¯ç”± 3 ä¸ªè¾ƒå°çš„æ¥å£ç»„æˆçš„ï¼š\n1 2 3 4 5 type ReadWriteCloser interface { Reader Writer Closer } 3. ä½ ä¸ç¼–å†™è¡Œä¸ºé©±åŠ¨çš„æ¥å£ åœ¨ä¼ ç»Ÿè¯­è¨€ä¸­ï¼Œåè¯æ¥å£å¦‚ Userã€Requestã€ç­‰ç­‰éƒ½æ˜¯å¾ˆå¸¸è§çš„ã€‚åœ¨ Go ä¸­ï¼Œå¤§å¤šæ•°æ¥å£éƒ½æœ‰ä¸€ä¸ª er åç¼€ï¼š Reader Writer Closer ç­‰ã€‚è¿™æ˜¯å› ä¸ºï¼Œåœ¨ Go ä¸­ï¼Œæ¥å£å…¬å¼€äº†è¡Œä¸ºï¼Œå®ƒä»¬çš„åç§°æŒ‡å‘äº†è¯¥è¡Œä¸ºã€‚\næ­£å¦‚æˆ‘ä¹‹å‰åœ¨ IO åŸºç¡€ä¸­æ‰€å†™çš„ï¼Œåœ¨ Go ä¸­å®šä¹‰æ¥å£æ—¶ï¼Œä½ å®šä¹‰çš„ä¸æ˜¯æŸç‰©æ˜¯ä»€ä¹ˆï¼Œè€Œæ˜¯å®ƒæä¾›äº†ä»€ä¹ˆâ€”â€”è¡Œä¸ºï¼Œè€Œä¸æ˜¯äº‹ç‰©ï¼è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Go ä¸­æ²¡æœ‰ File æ¥å£ï¼Œè€Œæ˜¯ Reader å’Œ Writer ï¼š è¿™äº›æ˜¯è¡Œä¸ºï¼Œå¹¶ä¸”æ˜¯ File å®ç° Reader å’Œ Writer çš„ä¸œè¥¿ã€‚\nåœ¨å®˜æ–¹æŒ‡å—ã€ŠEffective Goã€‹ä¸­ä¹Ÿæåˆ°äº†åŒæ ·çš„æƒ³æ³•ï¼š\nGo ä¸­çš„æ¥å£æä¾›äº†ä¸€ç§æŒ‡å®šå¯¹è±¡è¡Œä¸ºçš„æ–¹æ³•ï¼šå¦‚æœæŸäº›ä¸œè¥¿å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨ã€‚\nåœ¨ç¼–å†™æ¥å£æ—¶ï¼Œè¯·å°è¯•è€ƒè™‘æ“ä½œæˆ–è¡Œä¸ºã€‚å¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªåä¸ºçš„ Thing æ¥å£ï¼Œé—®é—®è‡ªå·±ä¸ºä»€ä¹ˆ Thing ä¸æ˜¯ä¸€ä¸ªç»“æ„ã€‚\n4. ä½ åœ¨ç”Ÿäº§è€…ç«¯ç¼–å†™æ¥å£ æˆ‘ç»å¸¸åœ¨ä»£ç å®¡æŸ¥ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ï¼šäººä»¬åœ¨ç¼–å†™å…·ä½“å®ç°çš„åŒä¸€åŒ…ä¸­å®šä¹‰æ¥å£ã€‚\nä½†æ˜¯ï¼Œä¹Ÿè®¸å®¢æˆ·ç«¯ä¸æƒ³ä½¿ç”¨ç”Ÿäº§è€…ç•Œé¢ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚è¯·è®°ä½ï¼Œä»æ¥å£éš”ç¦»åŸåˆ™ä¸­ï¼Œâ€œä¸åº”å¼ºè¿«å®¢æˆ·ç«¯å®ç°å®ƒä¸ä½¿ç”¨çš„æ–¹æ³•â€ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package main // ====== producer side // This interface is not needed type UsersRepository interface { GetAllUsers() GetUser(id string) } type UserRepository struct { } func (UserRepository) GetAllUsers() {} func (UserRepository) GetUser(id string) {} // ====== client side // Client only needs GetUser and // can create this interface implicitly implemented // by concrete UserRepository on his side type UserGetter interface { GetUser(id string) } å¦‚æœå®¢æˆ·æƒ³ä½¿ç”¨ producer çš„æ‰€æœ‰æ–¹æ³•ï¼Œä»–å¯ä»¥ä½¿ç”¨å…·ä½“ç»“æ„ã€‚è¯¥è¡Œä¸ºå·²é€šè¿‡ struct æ–¹æ³•æä¾›ã€‚\nå³ä½¿å®¢æˆ·ç«¯æƒ³è¦è§£è€¦å…¶ä»£ç å¹¶ä½¿ç”¨å¤šä¸ªå®ç°ï¼Œä»–ä»ç„¶å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒ…å«ä»–è¿™è¾¹æ‰€æœ‰æ–¹æ³•çš„æ¥å£ï¼š\nè¿™äº›ä¸œè¥¿æ˜¯é€šè¿‡ Go ä¸­çš„æ¥å£éšå¼æ»¡è¶³è¿™ä¸€äº‹å®æ¥å®ç°çš„ã€‚å®¢æˆ·ç«¯ä»£ç ä¸å†éœ€è¦å¯¼å…¥æŸäº›æ¥å£å¹¶å†™å…¥ implements ï¼Œå› ä¸º Go ä¸­æ²¡æœ‰è¿™æ ·çš„å…³é”®å­—ã€‚å¦‚æœ Implementation å…·æœ‰ä¸ Interface ç›¸åŒçš„æ–¹æ³•ï¼Œåˆ™ Implementation å·²æ»¡è¶³è¯¥æ¥å£ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ä½¿ç”¨ã€‚\n5. ä½ çš„æ–¹æ³•è¿”å›æ¥å£ å¦‚æœæ–¹æ³•è¿”å›æ¥å£è€Œä¸æ˜¯å…·ä½“ç»“æ„ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•çš„æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å°†å¼ºåˆ¶ä½¿ç”¨ç›¸åŒçš„æŠ½è±¡ã€‚ä½ éœ€è¦è®©å®¢æˆ·å†³å®šä»–ä»¬éœ€è¦ä»€ä¹ˆæŠ½è±¡ï¼Œå› ä¸ºä»£ç æ˜¯ä»–ä»¬çš„åº­é™¢ã€‚\nå½“ä½ æƒ³ä½¿ç”¨ç»“æ„ä¸­çš„æŸäº›å†…å®¹ä½†ä¸èƒ½ä½¿ç”¨æ—¶ï¼Œè¿™å¾ˆçƒ¦äººï¼Œå› ä¸ºæ¥å£æ²¡æœ‰å…¬å¼€å®ƒã€‚è¿™ç§é™åˆ¶å¯èƒ½æœ‰åŸå› ï¼Œä½†å¹¶éæ€»æ˜¯å¦‚æ­¤ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªäººä¸ºçš„ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package main import \u0026#34;math\u0026#34; type Shape interface { Area() float64 Perimeter() float64 } type Circle struct { Radius float64 } func (c Circle) Area() float64 { return math.Pi * c.Radius * c.Radius } func (c Circle) Perimeter() float64 { return 2 * math.Pi * c.Radius } // NewCircle returns an interface instead of struct func NewCircle(radius float64) Shape { return Circle{Radius: radius} } func main() { circle := NewCircle(5) // we lose access to circle.Radius } åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸ä»…å¤±å»äº†å¯¹ circle.Radius çš„è®¿é—®æƒé™ï¼Œè€Œä¸”æ¯æ¬¡æˆ‘ä»¬æƒ³è¦è®¿é—®å®ƒæ—¶ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ç”¨ç±»å‹æ–­è¨€å¡«å……æˆ‘ä»¬çš„ä»£ç ï¼š\n1 2 3 4 5 shape := NewCircle(5) if circle, ok := shape.(Circle); ok { fmt.Println(circle.Radius) } è¦éµå¾ªæ³¢æ–¯ç‰¹å°”å®šå¾‹ï¼Œâ€œä½ æ¥å—ä»€ä¹ˆæ˜¯è‡ªç”±çš„ï¼Œè€Œä½ å‘é€ä»€ä¹ˆæ˜¯ä¿å®ˆçš„â€ï¼Œä»ä½ çš„æ–¹æ³•ä¸­è¿”å›å…·ä½“çš„ç»“æ„ï¼Œå¹¶é€‰æ‹©ç”¨æ¥å£æ¥æ”¶ã€‚\nåœ¨ Dave Cheney çš„ Practical Go ä¸­ï¼Œæœ‰ä¸€ç¯‡å¾ˆå¥½çš„æ–‡ç«  a nice write-up è§£é‡Šäº†ä¸ºä»€ä¹ˆä»¥ä¸‹ä»£ç ï¼š\n1 2 // Save writes the contents of doc to the file f. func Save(f *os.File, doc *Document) error é€šè¿‡æ¥å—æ¥å£è¿›è¡Œæ”¹è¿›ï¼š\n1 2 3 // Save writes the contents of doc to the supplied // Writer. func Save(w io.Writer, doc *Document) error 6. ä½ åˆ›å»ºæ¥å£çº¯ç²¹æ˜¯ä¸ºäº†æµ‹è¯• è¿™æ˜¯æ¥å£æ±¡æŸ“çš„å¦ä¸€ä¸ªåŸå› ï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰ä¸€ä¸ªå®ç°çš„æ¥å£ï¼Œåªæ˜¯å› ä¸ºä½ æƒ³æ¨¡æ‹Ÿè¿™ä¸ªå®ç°ã€‚\nå¦‚æœé€šè¿‡åˆ›å»ºè®¸å¤šæ¨¡æ‹Ÿæ¥æ»¥ç”¨æ¥å£ï¼Œåˆ™æœ€ç»ˆä¼šæµ‹è¯•ä»æœªåœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿‡çš„æ¨¡æ‹Ÿï¼Œè€Œä¸æ˜¯åº”ç”¨ç¨‹åºçš„å®é™…é€»è¾‘ã€‚åœ¨ä½ çš„å®é™…ä»£ç ä¸­ï¼Œä½ ç°åœ¨æœ‰ 2 ä¸ªæ¦‚å¿µï¼ˆæ­£å¦‚ Djikstra æ‰€è¯´ï¼Œè¯­ä¹‰çº§åˆ«ï¼‰å¯ä»¥åœ¨å…¶ä¸­æ‰§è¡Œã€‚è¿™åªæ˜¯ä¸ºäº†ä½ æƒ³è¦æµ‹è¯•çš„ä¸œè¥¿ã€‚ä½ æƒ³åœ¨æ¯æ¬¡åˆ›å»ºæ–°æµ‹è¯•æ—¶å°†è¯­ä¹‰çº§åˆ«æé«˜ä¸€å€å—ï¼Ÿ\nä¾‹å¦‚ï¼Œä½ å§‹ç»ˆå¯ä»¥ä½¿ç”¨ testcontainers è€Œä¸æ˜¯æ¨¡æ‹Ÿä½ çš„æ•°æ®åº“ã€‚æˆ–è€…ï¼Œå¦‚æœ testcontainers å°šä¸æ”¯æŒï¼Œåˆ™åªéœ€æ‹¥æœ‰è‡ªå·±çš„å®¹å™¨ã€‚\næˆ–è€…ï¼Œä¹Ÿè®¸ä½ éœ€è¦ mock ä¸€äº›ä¸œè¥¿ï¼Œä½†ä¸æ˜¯æ•´ä¸ªäº‹æƒ…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªåŒ…å« 10 ç§æ–¹æ³•çš„ç»“æ„ï¼Œä¹Ÿè®¸ä½ ä¸éœ€è¦æ¨¡æ‹Ÿæ•´ä¸ªç»“æ„ã€‚ä¹Ÿè®¸ä½ åªèƒ½æ¨¡æ‹Ÿä¸€å°éƒ¨åˆ†ï¼Œä½ å¯ä»¥åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ä½ çš„å…·ä½“ç»“æ„ã€‚æ¨¡æ‹Ÿæ•´ä¸ªç»“æ„ä½“æ˜¯ä¸€ç§éå¸¸æ‡’æƒ°çš„æµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚\nå¦‚æœä½ ç¼–å†™ä¸€ä¸ª APIï¼Œä½ ä¸éœ€è¦å‘ä½ çš„å®¢æˆ·ç«¯æä¾›ä¸€ä¸ªæ¥å£ï¼Œè¿™æ ·ä»–ä»¬å°±å¯ä»¥ç”¨å®ƒæ¥æ¨¡æ‹Ÿã€‚å¦‚æœä»–ä»¬æƒ³ç¼–å†™æ¨¡æ‹Ÿï¼Œä»–ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šè‡ªå·±çš„æ¥å£æ¥è‡ªå·±å®Œæˆï¼ˆå‚è§ç¬¬ 4 ç‚¹ï¼‰\n7. æ‚¨ä¸éªŒè¯æ¥å£åˆè§„æ€§ å‡è®¾ä½ æœ‰ä¸€ä¸ªåŒ…ï¼Œè¯¥åŒ…å¯¼å‡ºäº†åä¸º User çš„ç±»å‹ï¼Œå¹¶ä¸”nä½ å®ç°äº†è¯¥ Stringer æ¥å£ï¼Œå› ä¸ºå‡ºäºæŸç§åŸå› ï¼Œå½“ä½ æ‰“å°å®ƒæ—¶ï¼Œä½ ä¸å¸Œæœ›æ˜¾ç¤ºç”µå­é‚®ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 package users type User struct { Name string Email string } func (u User) String() string { return u.Name } å®¢æˆ·ç«¯å…·æœ‰ä»¥ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;pkg/users\u0026#34; ) func main() { u := users.User{ Name: \u0026#34;John Doe\u0026#34;, Email: \u0026#34;john.doe@gmail.com\u0026#34;, } fmt.Printf(\u0026#34;%s\u0026#34;, u) } è¿™å°†æ­£ç¡®è¾“å‡ºï¼š John Doe ã€‚\nç°åœ¨ï¼Œå‡è®¾æ‚¨é‡æ„ï¼Œå¹¶ä¸”é”™è¯¯åœ°åˆ é™¤æˆ–æ³¨é‡Šäº† String() å®ç°ï¼Œå¹¶ä¸”æ‚¨çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 package users type User struct { Name string Email string } åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»£ç ä»å°†ç¼–è¯‘å¹¶è¿è¡Œï¼Œä½†è¾“å‡ºç°åœ¨å°†ä¸º {John Doe john.doe@gmail.com} â€œæ²¡æœ‰åé¦ˆå¼ºåˆ¶æ‰§è¡Œä¹‹å‰çš„æ„å›¾â€ã€‚\nå½“æ‚¨æœ‰æ¥å— User çš„æ–¹æ³•æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä¸ºæ‚¨æä¾›å¸®åŠ©ï¼Œä½†åœ¨ä¸Šè¿°æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¸ä¼šã€‚\nä¸ºäº†å¼ºåˆ¶æ‰§è¡ŒæŸä¸ªç±»å‹å®ç°æ¥å£çš„äº‹å®ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package users import \u0026#34;fmt\u0026#34; type User struct { Name string Email string } var _ fmt.Stringer = User{} // User implements the fmt.Stringer func (u User) String() string { return u.Name } ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åˆ é™¤è¯¥ String() æ–¹æ³•ï¼Œæˆ‘ä»¬å°†åœ¨æ„å»ºæ—¶å¾—åˆ°ä»¥ä¸‹å†…å®¹ï¼š\n1 cannot use User{} (value of type User) as fmt.Stringer value in variable declaration: User does not implement fmt.Stringer (missing method String) æˆ‘ä»¬åœ¨é‚£ä¸€è¡Œä¸­æ‰€åšçš„æ˜¯ï¼Œå°è¯•å°†ä¸€ä¸ªç©º User{} åˆ†é…ç»™ç±»å‹ fmt.Stringer ã€‚ç”±äºåœæ­¢å®ç° fmt.Stringer ï¼Œ User{} æ”¶åˆ°äº†æŠ•è¯‰ã€‚æˆ‘ä»¬ä½¿ç”¨ _ ä½œä¸ºå˜é‡åç§°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰çœŸæ­£ä½¿ç”¨å®ƒæ‰€ä»¥ä¸ä¼šæ‰§è¡Œä»»ä½•åˆ†é…ã€‚\nä¸Šé¢æˆ‘ä»¬æœ‰ User å®ç°æ¥å£ã€‚ User å¹¶ä¸”æ˜¯ *User ä¸åŒçš„ç±»å‹ã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³å®ç°å®ƒï¼Œ *User ä½ å¯ä»¥åšè¿™æ ·çš„äº‹æƒ…ï¼š\n1 var _ fmt.Stringer = (*User)(nil) // *User implements the fmt.Stringer æˆ‘ä¹Ÿå–œæ¬¢åœ¨è¿™æ ·åšæ—¶ï¼Œæˆ‘çš„Goland IDEä¼šå‘æˆ‘æ˜¾ç¤ºä¸€ä¸ªâ€œå®ç°ç¼ºå°‘çš„æ–¹æ³•â€é€‰é¡¹ï¼š\nå¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·æŸ¥çœ‹ article from Mat Ryer æˆ– Uber Go Style çš„æŒ‡å—ã€‚\nè™½ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆé…·çš„æŠ€å·§ï¼Œä½†ä½ ä¸éœ€è¦å¯¹æ¯ä¸ªå®ç°æ¥å£çš„ç±»å‹éƒ½è¿™æ ·åšï¼Œå¦‚æœæˆ‘ä»¬æœ‰éœ€è¦æ¥å£çš„å‡½æ•°ï¼Œå¦‚æœä½ å°è¯•ä½¿ç”¨ä¸å®ç°å®ƒä»¬çš„ç±»å‹ï¼Œç¼–è¯‘å™¨å·²ç»æŠ±æ€¨äº†ã€‚æˆ‘è‡ªå·±ä¸å¾—ä¸æ€è€ƒä¸€æ®µæ—¶é—´æ‰èƒ½ä¸ºæœ¬æ–‡æƒ³å‡ºä¸€ä¸ªä¾‹å­ï¼Œæ‰€ä»¥çœŸçš„ï¼Œè¿™æ˜¯ä¸€ä¸ªç½•è§çš„æ¡ˆä¾‹ã€‚\næ­£å¦‚æˆ‘ä»¬åœ¨ Effective Go ä¸­è¢«è­¦å‘Šçš„é‚£æ ·ï¼š\nThe appearance of the blank identifier in this construct indicates that the declaration exists only for the type checking, not to create a variable. Donâ€™t do this for every type that satisfies an interface, though. By convention, such declarations are only used when there are no static conversions already present in the code, which is a rare event.\nå°±è¿™äº›äº†!\nå‚è€ƒ æœ¬æ–‡ç¿»è¯‘äº \u0026lt;7 Common Interface Mistakes in Go\u0026gt;\n","date":"2024-07-01T00:00:00Z","permalink":"https://blog.golang.space/p/go-%E4%B8%AD%E7%9A%84-7-%E4%B8%AA%E5%B8%B8%E8%A7%81%E6%8E%A5%E5%8F%A3%E9%94%99%E8%AF%AF/","title":"Go ä¸­çš„ 7 ä¸ªå¸¸è§æ¥å£é”™è¯¯"},{"content":"ç±»ä¼¼ä»¥ä¸‹ä»£ç ï¼Œæ‰§è¡Œæç¤ºå¤±è´¥äº†ï¼Œä½†æ˜¯è½¬ç ç»“æœæœ‰è¾“å‡ºã€‚\né”™è¯¯æ˜¯ ERROR exec: \u0026quot;ffmpeg\u0026quot;: executable file not found in $PATH\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func ffmpegPipeExec(ctx context.Context, in io.Reader, out io.Writer, args ...string) error { argsData := append(append([]string{\u0026#34;-y\u0026#34;, \u0026#34;-hide_banner\u0026#34;, \u0026#34;-loglevel\u0026#34;, \u0026#34;error\u0026#34;, \u0026#34;-i\u0026#34;, \u0026#34;pipe:0\u0026#34;}, args...), \u0026#34;pipe:1\u0026#34;) cmd := exec.CommandContext(ctx, \u0026#34;ffmpeg\u0026#34;, argsData...) // nolint cmd.Stdin = in cmd.Stdout = out errOut := bytes.NewBuffer(nil) cmd.Stderr = errOut if err := cmd.Run(); err != nil { slog.Error(err.Error()) } if err := errOut.String(); len(err) \u0026gt; 0 \u0026amp;\u0026amp; strings.Contains(err, \u0026#34;Error\u0026#34;) { return fmt.Errorf(err) } return nil } é—®é¢˜åˆ†æ é€šè¿‡æ–­ç‚¹æ£€æµ‹ Go åŸºç¡€åº“ï¼Œåœ¨è¿™é‡Œé‡åˆ°é”™è¯¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 if filepath.Base(name) == name { lp, err := LookPath(name) if lp != \u0026#34;\u0026#34; { // Update cmd.Path even if err is non-nil. // If err is ErrDot (especially on Windows), lp may include a resolved // extension (like .exe or .bat) that should be preserved. cmd.Path = lp } if err != nil { cmd.Err = err } } ç»§ç»­æ·±å…¥\n1 path := os.Getenv(\u0026#34;PATH\u0026#34;) exec.Command ä¼šä»ç¯å¢ƒå˜é‡ä¸­åˆ¤æ–­å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚æˆ‘é€šè¿‡ brew å®‰è£…çš„ ffmpegï¼Œè·¯å¾„åœ¨ /opt/homebrew/bin ç›®å½•ä¸‹ï¼Œshell æ˜¯æœ‰å†™å…¥ PATH çš„ã€‚\nåœ¨ç»ˆç«¯æ‰§è¡Œ echo $PATH ï¼Œå¯è¾“å‡ºè¯¦ç»†ç¯å¢ƒå˜é‡ï¼Œæ˜¯æ­£å¸¸çš„ï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯ vscode åŠ è½½ç¯å¢ƒå˜é‡æ—¶å‡ºç°å¼‚å¸¸ã€‚\nè§£å†³æ–¹æ³•åœ¨ vscode çš„ settings å¢åŠ ï¼Œvscode å¯ä»¥é€šè¿‡ ${env:Name} çš„è¯­æ³•å¼•ç”¨ç¯å¢ƒå˜é‡ã€‚\n1 2 3 \u0026#34;go.toolsEnvVars\u0026#34;: { \u0026#34;PATH\u0026#34;: \u0026#34;${env:PATH}:/opt/homebrew/bin\u0026#34; } ä¸ºä»€ä¹ˆéƒ½æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¨‹åºå´æ‰§è¡ŒæˆåŠŸè¾“å‡ºç»“æœäº†å‘¢?\n1 2 3 if err := cmd.Run(); err != nil { slog.Error(err.Error()) } åœ¨è¿™ä¸€è¡Œä¸­ï¼Œæ²¡æœ‰è¿”å›é”™è¯¯ï¼Œä¸Šå±‚æ‰§è¡Œè®¤ä¸ºæ²¡æœ‰é”™è¯¯ï¼Œå†™äº†ä¸€ä¸ªç©ºæ–‡ä»¶ã€‚\nè¿™é‡Œé¿å…è¿”å›çš„åŸå› æ˜¯è®¤ä¸º ffmpeg çš„é”™è¯¯ä¿¡æ¯ä¼šæä¾›æ›´å¤šè¯¦æƒ…ç”¨äºåˆ†æï¼Œä½†ä¸åº”è¯¥å¿½ç•¥è¿™ä¸ªé”™è¯¯ï¼Œå¯ä»¥å°†æ­¤é”™è¯¯æ”¾åˆ°æœ€ååˆ¤æ–­ã€‚\nå‚è€ƒ Vscode å®˜æ–¹æ–‡æ¡£\n","date":"2024-05-26T00:00:00Z","permalink":"https://blog.golang.space/p/exec-%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F%E4%BD%86%E5%A4%B1%E8%B4%A5/","title":"Exec æ‰§è¡ŒæˆåŠŸä½†å¤±è´¥!"},{"content":"Gitea Actions ä¸‹è½½æ–‡ä»¶ 1 2 3 4 wget https://gitea.com/gitea/act_runner/releases/download/v0.2.10/act_runner-0.2.10-linux-amd64 -O act_runner chmod +x ./act_runner ./act_runner --version æœ€æ–°ç‰ˆæœ¬ç‚¹è¿™é‡Œ\næ³¨å†Œåˆ° Gitea 1 ./act_runner register --no-interactive --instance \u0026lt;instance\u0026gt; --token \u0026lt;token\u0026gt; instance å°±æ˜¯ Gitea çš„è®¿é—®åœ°å€ï¼Œä¾‹å¦‚ https://gitea.com\ntoken å¯ä»¥åœ¨ Gitea å®ä¾‹çš„ [ç®¡ç†åå°] - [Actions] è·å–ã€‚\nå¯åŠ¨ 1 ./act_runner daemon ä¹Ÿå¯ä»¥ä½¿ç”¨ docker-compose æ¥å¯åŠ¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 version: \u0026#34;3.8\u0026#34; services: runner: image: gitea/act_runner:nightly environment: CONFIG_FILE: /config.yaml GITEA_INSTANCE_URL: \u0026#34;${INSTANCE_URL}\u0026#34; GITEA_RUNNER_REGISTRATION_TOKEN: \u0026#34;${REGISTRATION_TOKEN}\u0026#34; GITEA_RUNNER_NAME: \u0026#34;${RUNNER_NAME}\u0026#34; GITEA_RUNNER_LABELS: \u0026#34;${RUNNER_LABELS}\u0026#34; volumes: - ./config.yaml:/config.yaml - ./data:/data - /var/run/docker.sock:/var/run/docker.sock åœ¨å­˜å‚¨åº“è®¾ç½®é¡µé¢å¯ç”¨ actions å‚è€ƒ act_runner gitea ä»“åº“\n","date":"2024-04-28T00:00:00Z","permalink":"https://blog.golang.space/p/%E8%AE%BE%E7%BD%AE-gitea-actions/","title":"è®¾ç½® Gitea Actions"},{"content":"è¯ä¹¦è‡ªåŠ¨ç»­ç­¾æ–¹æ¡ˆ å®‰è£… acme.sh 1 2 3 4 git clone --depth 1 https://gitee.com/neilpang/acme.sh.git cd acme.sh ./acme.sh --install -m my@example.com alias acme.sh=~/.acme.sh/acme.sh my@example.com å¯ä»¥æŒ‡å®šè‡ªå·±çš„é‚®ç®±ã€‚\nä¿®æ”¹é»˜è®¤ CA æœåŠ¡å•†ï¼Œé»˜è®¤çš„æ˜¯ zerossl\n1 ./acme.sh --set-default-ca --server letsencrypt ä¸»åŸŸåï¼Œå­åŸŸåç­¾å‘è¯ä¹¦ å¯ä»¥ä½¿ç”¨ HTTP/DNSAPI ä¸¤ç§æ–¹å¼\n1 acme.sh --issue -d example.com -w ./nginx/site/ --issue è¡¨ç¤ºè¦ç­¾å‘è¯ä¹¦\n-d æŒ‡å®šè¦ç­¾å‘çš„åŸŸåï¼Œç­¾å‘ä¹‹å‰è¦å…ˆè®¾è®¡å¥½ DNS è§£æåˆ°å½“å‰ä¸»æœºå“¦ã€‚\n-w æŒ‡å®šç½‘ç«™çš„æ ¹ç›®å½•ã€‚\n--key-file æŒ‡å®š key æ–‡ä»¶å†™å…¥å“ªé‡Œ\n--fullchain-file æŒ‡å®š cer æ–‡ä»¶å†™å…¥å“ªé‡Œ\næ³›åŸŸåç­¾å‘è¯ä¹¦ 1. è®¾ç½® DNS API å¿…é¡»ä½¿ç”¨ DNS API çš„æ–¹å¼\nå¦‚æœæ˜¯é˜¿é‡Œäº‘çš„è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ã€‚(å…¶å®ƒå‚è€ƒ)\n1 2 export Ali_Key=\u0026#34;\u0026lt;key\u0026gt;\u0026#34; export Ali_Secret=\u0026#34;\u0026lt;secret\u0026gt;\u0026#34; 2. ç­¾å‘æ³›åŸŸåè¯ä¹¦ 1 acme.sh --issue -d example.com -d \u0026#39;*.example.com\u0026#39; --dns dns_ali å°†ç­¾å‘çš„è¯ä¹¦å®‰è£…åˆ°æŒ‡å®šç›®å½•ä¸‹ ç¨‹åºå°†ä¼šæ¯ 60 å¤©é‡æ–°ç­¾å‘\n1 2 3 4 5 6 7 acme.sh --install-cert -d example.com \\ --key-file /path/to/keyfile/in/nginx/key.pem \\ --fullchain-file /path/to/fullchain/nginx/cert.pem \\ --reloadcmd \u0026#34;service nginx force-reload\u0026#34; acme.sh --install-cert -d puff.golang.space --key-file /home/apps/gb/nginx/certs/key.pem --fullchain-file /home/apps/gb/nginx/certs/cert.pem --reloadcmd \u0026#34;/home/apps/gb \u0026amp;\u0026amp; docker compose exec -it nginx nginx -s reload\u0026#34; å…¶å®ƒ 1 2 3 4 # å‡çº§å¹¶ä¿æŒè‡ªåŠ¨æ›´æ–° acme.sh --upgrade --auto-upgrade # å…³é—­è‡ªåŠ¨æ›´æ–° acme.sh --upgrade --auto-upgrade 0 å‚è€ƒ: https://github.com/acmesh-official/acme.sh\nhttps://www.orcy.net.cn/1337.html\nhttps://developers.weixin.qq.com/community/develop/article/doc/0008ae40ca0af83d0d7e3bb6b56013\nhttps://cloud.tencent.com/developer/article/2218945?areaSource=102001.10\u0026traceId=XFvJArbxeBBM3HvlN8MOV\nhttps://www.jianshu.com/p/387dcb9566f7\n","date":"2024-04-01T00:00:00Z","permalink":"https://blog.golang.space/p/%E8%AF%81%E4%B9%A6%E8%87%AA%E5%8A%A8%E7%BB%AD%E7%AD%BE%E6%96%B9%E6%A1%88/","title":"è¯ä¹¦è‡ªåŠ¨ç»­ç­¾æ–¹æ¡ˆ"},{"content":"çº¦å®š ç»“æ„ä½“å RequestQuery è¡¨ç¤ºè¯·æ±‚çš„ query å‚æ•°ï¼Œå®é™…ä¸šåŠ¡åº”è¯¥åä¸º ä¸šåŠ¡å+Inputã€‚\nç»“æ„ä½“åä¸º RequestBody è¡¨ç¤ºè¯·æ±‚çš„ body å‚æ•°ã€‚\nç»“æ„ä½“åä¸º ResponseBody è¡¨ç¤ºå“åº”çš„ body å‚æ•°ã€‚\nè®¾è®¡åŸåˆ™ å‘½å\nåå­—çš„å¯¿å‘½å¯èƒ½æ¯”é¡¹ç›®çš„ç”Ÿå‘½å‘¨æœŸè¿˜è¦é•¿ã€‚ä»å˜é‡å‘½åï¼Œç»“æ„ä½“å‘½åï¼ŒåŒ…åï¼Œå‡½æ•°åï¼Œåˆ°ä¸šåŠ¡åï¼Œæ— å¤„ä¸åœ¨ï¼Œå¦‚æœå˜é‡å« Channelï¼Œä¸šåŠ¡åå«é€šé“ï¼Œé”€å”®ç»ç†å«ç®¡é“ï¼Œå‡½æ•°åå« Pipeï¼Œè¿™ç§å‰²è£‚æ„Ÿï¼Œæ¯ä½é¡¹ç›®å‚ä¸è€…çœŸçš„èƒ½æ˜ç™½å¯¹æ–¹æƒ³è¡¨è¾¾çš„æ˜¯ä»€ä¹ˆä¸œè¥¿å—?\nä»£ç å†…çš„å‘½åè¿˜å¥½ï¼Œä¸€æ—¦æ˜¯å¼€æ”¾çš„ API ï¼Œå°±ä¸èƒ½è½»æ˜“çš„æ›´åï¼Œæ‰€ä»¥é€‰æ‹©ä¸€ä¸ªæ¸…æ™°ç®€æ´é€šä¿—æ˜“æ‡‚çš„åç§°ï¼Œæ˜¯éå¸¸å¿…è¦çš„ã€‚\næ•°æ®è¯·æ±‚/å“åº”å‚æ•°çš„å‘½åï¼Œæœ‰å¤§é©¼å³°/å°é©¼å³°/è›‡å½¢ï¼Œé‡ç‚¹ä¸åœ¨äºé€‰æ‹©å“ªç§æ–¹å¼ï¼Œè€Œåœ¨äºç»Ÿä¸€ã€‚çœ‹çœ‹ä»¥ä¸‹ JSONï¼Œä½ ä¼šè§‰å¾—å¾ˆäº«å—å—? æ¯æ¬¡å¡«å†™å‚æ•°çš„æ—¶å€™ï¼Œä½ æ˜¯å¦è¦è€ƒè™‘ä¸€ä¸‹ï¼Œè¿™ä¸ªå‚æ•°æ˜¯å°é©¼å³°è¿˜æ˜¯è›‡å½¢æ¥ç€?\nè·Ÿç€å…¬å¸æ—§é¡¹ç›®çš„å‘½åæ–¹å¼èµ°å³å¯ï¼Œå¦‚æœæ²¡æœ‰æ—§é¡¹ç›®? å¯ä»¥å‚è€ƒä½ å–œæ¬¢çš„å…¬å¸ç”¨æ€æ ·çš„å‘½åæ–¹å¼ï¼Œä¾‹å¦‚çœ‹çœ‹ ChatGPT ï¼ŒTwitter(X)ï¼Œç™¾åº¦ç­‰ç­‰ï¼Œé€‰ä¸€ä¸ªä½œä¸ºå‚è€ƒå³å¯ã€‚\n1 2 3 4 { \u0026#34;page_number\u0026#34;:1, \u0026#34;maxPageLimit\u0026#34; 2 } é‡è¯å‘½ååº”å½“ç»“å°¾å¸¦ä¸Šå•ä½ï¼Œä¾‹å¦‚å¼€å§‹æ—¶é—´ startAtMs å¼€å§‹æ—¶é—´æˆ³æ¯«ç§’ï¼ŒStartAtS å¼€å§‹æ—¶é—´æˆ³ç§’ã€‚æ–‡ä»¶å¤§å° sizeBytesï¼Œè¿™ç§æ˜ç»†çš„å•ä½ä¸ç”¨æŸ¥è¯¢æ–‡æ¡£å³å¯çŸ¥é“å…¶å«ä¹‰ã€‚å½“æ¥å£å‘ç”Ÿå˜æ›´æ—¶(ä¾‹å¦‚æ›´æ¢å•ä½)ï¼Œæ–°å¢ä¸€ä¸ªå˜é‡åå³å¯ï¼Œä¾‹å¦‚ SizeMbypes ã€‚\nç®€å•æ€§\nå¥½çš„ API åº”è¯¥éå¸¸ç®€å•çš„è°ƒç”¨ï¼Œä¸åº”è¯¥ä¸ºäº†ä¸€äº›éšè—æˆ–å…¼å®¹åŠŸèƒ½ï¼Œæé«˜è°ƒç”¨å¤æ‚åº¦ã€‚API ä¸åº”è¯•å›¾è¿‡åº¦å‡å°‘æ¥å£æ•°é‡ï¼Œè€Œåº”è¯¥å°½å¯èƒ½ä»¥æœ€ç›´æ¥çš„æ–¹å¼å…¬å¼€ç”¨æˆ·æƒ³å®ç°ä¸šåŠ¡çš„åŠŸèƒ½ã€‚\nå¯é¢„æµ‹æ€§\nåœ¨æŸäº› API ä¸­ä½¿ç”¨äº† page ä½œä¸ºåˆ†é¡µï¼Œé‚£ä¹ˆåœ¨ç›¸åŒæŸ¥è¯¢åˆ—è¡¨çš„æ¥å£ä¸­ï¼Œä¹Ÿåº”è¯¥ä½¿ç”¨ç›¸åŒçš„å•è¯ï¼Œæ‰€æœ‰æ¥å£ä½¿ç”¨ä¸€è‡´çš„å‘½åè§„åˆ™èƒ½å¤Ÿä½¿ API çš„å‚æ•°å¯ä»¥è¢«é¢„æµ‹ã€‚å¦‚æœæœ‰äº›æ¥å£ä¸­å« pageï¼Œæœ‰äº›æ¥å£å« page_numï¼Œæœ‰äº›æ¥å£å« page_size ï¼Œå¦å¤–çš„æ¥å£ç”¨ pageSizeï¼Œè°ƒç”¨è€…ä¼šå¾ˆæ··ä¹±ï¼ŒåŒä¸€ä¸ªä¸œè¥¿ä¸ºä»€ä¹ˆè¦èµ·è¿™ä¹ˆå¤šåå­—? æ˜¯æœ‰ä»€ä¹ˆç‰¹æ®Šæ€§å—?\nä¸ªäººç¼–å†™ä»£ç å¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œä½†æ›´å¤šæ˜¯å› ä¸ºå›¢é˜Ÿå¼€å‘æ‰å‡ºç°è¿™ç§æƒ…å†µï¼Œå›¢é˜Ÿå¼€å‘è€…å¦‚æœæ˜ç¡®çŸ¥é“è¿™ä¸ªæ¨¡å‹å·²ç»å®šä¹‰äº†ï¼Œåº”å½“å…ˆå»äº†è§£å·²å®šä¹‰çš„æ¨¡å‹ï¼Œè€Œä¸æ˜¯è‡ªå·±æƒ³å½“ç„¶çš„åˆ›å»ºæ–°æ¨¡å‹ã€‚\n1 2 3 4 5 6 // ä»¥ä¸‹å‡½æ•°éƒ½æ˜¯ä¸ºäº†åˆ†é¡µæŸ¥è¯¢æ¶ˆæ¯ã€‚ func findMessages(page,size int) ([]Message,error){} func findMessagesByUserID(pageNum,maxSize int) ([]Message,error){} func findMessagesByUsername(pageSize,max_limit int) ([]Message,error){} func findInformatiI( size,limit int) ([]Message,error){} // What Fuck? å¯Œæœ‰è¡¨ç°åŠ›\næ¥å£èƒ½å¤Ÿæ¸…æ¥šçš„è¡¨è¾¾ä»–ä»¬æƒ³åšçš„äº‹æƒ…ã€‚ä¾‹å¦‚ï¼Œå°†æ–‡æœ¬è½¬æ¢æˆå¦å¤–ä¸€ç§è¯­è¨€ï¼Œç”¨æˆ·å¯èƒ½ä¼šé¢‘ç¹çš„è°ƒç”¨æ¥å£å»åˆ¤æ–­å­—ç¬¦ä¸²å±äºå“ªä¸ªè¯­è¨€? è¿™å±äºä¸šåŠ¡ä¸Šçš„éœ€æ±‚ï¼Œå¦‚æœç›´æ¥æä¾›ä¸€ä¸ª detectLanguage æ¥å£è€Œä¸æ˜¯è®©ç”¨æˆ·è°ƒç”¨å¤§é‡æ¥å£å»çŒœæµ‹ï¼Œæƒ…å†µä¼šå¥½å¾—å¤šã€‚\næ ‡è¯†ç¬¦ é€šè¿‡æ ‡è¯†ç¬¦æ¥åŒºåˆ†èµ„æºã€‚å¥½çš„æ ‡è¯†ç¬¦åº”è¯¥æœ‰ä»¥ä¸‹ä¼˜ç‚¹:\næ˜“äºä½¿ç”¨ï¼Œä¸åº”è¯¥å«æœ‰ç‰¹æ®Šç¬¦å·å’Œä¿ç•™å…³é”®å­— å…¨å±€å”¯ä¸€ æ°¸ä¹…ç”Ÿå‘½å‘¨æœŸ ç”Ÿæˆå¿«é€Ÿï¼Œç®€å• ä¸å¯é¢„æµ‹ï¼Œå¯é¢„æµ‹çš„æ ‡è¯†ç¬¦æ›´å®¹æ˜“å®šä½å’Œåˆ©ç”¨æ½œåœ¨çš„æ¼æ´ å¯è¯»ï¼Œå¯å…±äº«ï¼Œå¯éªŒè¯ï¼Œåº”å½“é¿å… 1ï¼Œ|ï¼ŒLï¼Œlï¼Œiï¼ŒI è¿™äº›å®¹æ˜“æ··æ·†ï¼Œä»¥ä¸‹å­—ç¬¦ä¸²ä¸­å»æ‰äº† å®¹æ˜“ä¸ æ•°ç»„ 0 æ··æ·†çš„å­—æ¯ Oï¼Œå»æ‰äº†å®¹æ˜“ä¸æ•°å­— 1 æ··æ·†çš„å­—æ¯I å’Œ L ã€‚ 1 0123456789ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz åœ¨æ ‡è¯†ç¬¦å‰é¢åº”å½“å¢åŠ èµ„æºï¼Œä¾‹å¦‚è®¾å¤‡ /devices/5B82KZMOï¼Œé‚£å¦‚æœæƒ³æŸ¥è¯¢åˆ†é¡µè®¾å¤‡å‘¢? ä¸€èˆ¬æ¥è¯´ï¼ŒAPI ä»…å½“ä¸€ç§èµ„æºå¯¹å¦å¤–ä¸€ç§èµ„æºæ‹¥æœ‰æ‰€æœ‰æƒæ—¶ï¼Œæ‰åº”ä¾èµ–äºå±‚æ¬¡å…³ç³»ã€‚ä¾‹å¦‚åˆ†é¡µï¼Œåˆ†é¡µå±äºèµ„æºçš„å±æ€§ï¼Œå¹¶ä¸”ç»å¸¸å˜åŠ¨ä¸ä¼šæŒä¹…åŒ–å­˜å‚¨ï¼Œä¸åº”è¯¥å­˜åœ¨ /page/1 æˆ– /devices/5B82KZMO/page/1 çš„æƒ…å†µï¼Œä½¿ç”¨ /devices/5B82KZMO?page=1 æ›´åˆç†ã€‚\né‚£æƒ³æŸ¥è¯¢å±äºè¯¥è®¾å¤‡çš„é€šé“åˆ—è¡¨å‘¢? å­èµ„æºæ˜¯ä»…å­˜åœ¨äºçˆ¶èµ„æºçš„ä¸Šä¸‹æ–‡ä¸­çš„ï¼Œå¦åˆ™ä¼šå¼•å‡ºä¸€ä¸ªé—®é¢˜: å“ªä¸ªè®¾å¤‡çš„é€šé“å‘¢? ä½¿ç”¨ /devices/5B82KZMO/channels æ¯”è¾ƒåˆç†ã€‚\næœ‰ä¸€ä¸ªè¾ƒä¸ºçŸ›ç›¾çš„åœ°æ–¹ï¼Œå½“éšç€ä¸šåŠ¡å‘å±•ï¼Œå¯èƒ½ä¼šå‡ºç°åªæƒ³æŸ¥è¯¢é€šé“ï¼Œå¹¶ä¸å…³å¿ƒé€šé“å±äºè°ã€‚è¿™æ—¶ç”¨ /channels æ¯”è¾ƒåˆç†ï¼Œå½“ device_id ä½œä¸ºæŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œæ­¤èµ„æºæŸ¥è¯¢å·²åŒ…å« /devices/5B82KZMO/channels çš„ç›¸åŒåŠŸèƒ½ã€‚\næ‰€ä»¥ï¼Œå±‚çº§åˆ’åˆ†æ—¶ï¼Œå¿…é¡»æ˜ç¡®å­èµ„æºæ˜¯ä»…å­˜åœ¨äºçˆ¶èµ„æºçš„ä¸Šä¸‹æ–‡ä¸­çš„ã€‚åˆ†å±‚ä¸å®œè¿‡æ·±ï¼Œå»ºè®®æœ€å¤§ 2 å±‚ï¼Œä¾‹å¦‚ /users/1/messages/1ï¼Œç”¨æˆ·å’Œæ¶ˆæ¯ä¸¤å±‚ã€‚å½“å±‚æ•°è¿‡å¤šæ—¶ï¼Œåº”è¯¥è€ƒè™‘æ˜¯å¦åº”è¯¥å°†å­èµ„æºå‰¥ç¦»å‡ºæ¥ä½œä¸ºé¡¶å±‚èµ„æºã€‚\nè¯·æ±‚æ–¹æ³• åˆ é™¤èµ„æºï¼Œæ­£ç¡®åˆ é™¤æ—¶è¿”å› 200ï¼Œå¦‚æœèµ„æºä¸å­˜åœ¨å‘¢? æœ‰äººè®¤ä¸ºæœ€ç»ˆç»“æœæ˜¯æ­£ç¡®çš„æ‰€ä»¥åº”è¯¥è¿”å› 200 ç»“æœã€‚æœ‰äººè®¤ä¸ºåº”è¯¥åŒºåˆ†ç»“æœï¼Œå°è¯•åˆ é™¤ä¸å­˜åœ¨åº”å½“è¿”å› 404ã€‚å¦‚æœèµ„æºå­˜åœ¨ï¼Œå°è¯•è®¿é—®æ²¡æœ‰æƒé™çš„èµ„æºæ€ä¹ˆåŠå‘¢? è¿”å› 404 ä½†å®é™…èµ„æºæ˜¯å­˜åœ¨ï¼Œè¿”å› 403 æ— æƒé™ä½†è¿™ä¼šè¢«æ¶æ„æ”»å‡»è€…æ˜ç¡®èµ„æºå­˜åœ¨ï¼Œå¯èƒ½ä¼šè¢«æ¢æµ‹å¹¶ä½œä¸ºæ”»å‡»ç›®æ ‡ã€‚\nåœ¨è®¾è®¡ API æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°è¿™äº›é€‰æ‹©é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è®¨è®ºæ ‡å‡† API åº”è¯¥å¦‚ä½•è®¾è®¡ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸åº”è¯¥æ‰€æœ‰å®é™…ä¸šåŠ¡éƒ½ç”¨æ ‡å‡† API å¥—ç”¨ï¼Œé‡åˆ°ä¸šåŠ¡å¤æ‚çš„æƒ…å†µå‘¢? è¦çµæ´»ã€‚ä»¥ä¸‹å†…å®¹ä¸æ˜¯è§£å†³é—®é¢˜çš„é‡‘æ‰‹æŒ‡ï¼Œè€Œåœ¨äºå¼•èµ·ä¸€äº›æ€è€ƒã€‚\nGET (æŸ¥è¯¢èµ„æº)\nèµ„æºæ£€ç´¢ï¼Œä¸€èˆ¬é€šè¿‡å”¯ä¸€æ ‡è¯†ç¬¦æ£€ç´¢èµ„æºï¼Œæˆ–é€šè¿‡å…³é”®ä¿¡æ¯è¿‡æ»¤æŸ¥æ‰¾èµ„æºã€‚\næ­¤æ–¹æ³•åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œå‡è®¾æ²¡æœ‰å‘ç”Ÿå…¶å®ƒæ›´æ”¹çš„æƒ…å†µï¼Œåˆ™æ¯æ¬¡ç»“æœéƒ½åº”è¯¥ç›¸åŒã€‚\nè®¿é—®æ§åˆ¶ï¼Œå¦‚æœæŸäº›èµ„æºåªèƒ½è¢«ç‰¹å®šç”¨æˆ·è®¿é—®ï¼Œå¯ä»¥ç¡®ä¿èµ„æºæœ‰å•ç‹¬çš„çˆ¶çº§ï¼Œä¾‹å¦‚ /users/:id/messagesã€‚\nåœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œè®¡æ•°å¾ˆéš¾è·å–ç²¾ç¡®çš„ç»“æœï¼Œæä¾›è¿™ç§æŸ¥è¯¢å®¹æ˜“ç»™ä½¿ç”¨è€…è¯¯å¯¼ï¼Œåº”å½“ç”¨ä¼°è®¡å€¼è€Œéç²¾ç¡®è®¡æ•°;\nå‡è®¾å¯¹åˆ†å¸ƒåœ¨ 100 ä¸ªåç«¯çš„ 1 äº¿æ•°æ®åšæ’åºï¼Œè¿™ç§æŸ¥è¯¢å¾ˆå®¹æ˜“å¯¼è‡´æœåŠ¡å™¨è¿‡è½½ã€‚è¿™ç±»å¾®å°çš„åŠŸèƒ½å¾€å¾€ä¼šåœ¨æœªæ¥å¢åŠ å¤§é‡çš„å¤æ‚æ€§ï¼Œä¸”å¯¹ API ä½¿ç”¨è€…æ¥è¯´ä»·å€¼ç›¸å¯¹è¾ƒå°ã€‚ä¸ºäº†å®ç°ä¸€ä¸ªä»·å€¼ç›¸å¯¹è¾ƒå°çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œè€Œå¢åŠ æœåŠ¡çš„å¤æ‚åº¦ï¼Œä»£ç çš„ç»´æŠ¤å¤æ‚æ€§ï¼Œå†…å­˜å€å¢ï¼Œæ˜¯å€¼å¾—çš„å—?\næŸ¥è¯¢éƒ¨åˆ†èµ„æºï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢éƒ¨åˆ†èµ„æºåªä¼šæœ‰ 2 ä¸ªç‰ˆæœ¬ï¼Œå®Œæ•´æ•°æ®ç‰ˆå’ŒåŸºç¡€æ•°æ®ç‰ˆã€‚å¯ä»¥é€šè¿‡ query å‚æ•°æ¥æŒ‡å®šåŸºç¡€ç‰ˆ field=baseï¼Œå½“æƒ…å†µæ›´å¤æ‚æ—¶ï¼Œå¯ä»¥æŒ‡å®šå…·ä½“è¦å“ªäº›æ•°æ®ï¼Œä¸¤ç§æ–¹å¼åº”è¯¥æ˜¯äºŒé€‰ä¸€å®ç°ã€‚fields=name,remark,ageï¼Œæ³¨æ„å½“ä½¿ç”¨åè€…æ—¶ï¼ŒæœåŠ¡ç«¯åº”å½“å°å¿ƒçš„å¯¹å¾…è¿™äº›å‚æ•°ï¼Œé¿å… SQL æ³¨å…¥ï¼Œæˆ–ä¸å­˜åœ¨çš„å­—æ®µè¾“å…¥äº† SQL ã€‚\nPOST (åˆ›å»ºèµ„æº)\nèµ„æºåˆ›å»ºï¼Œè¯·æ±‚ä½“åŒ…å«èµ„æºåˆ›å»ºä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„èµ„æºå“åº”ã€‚ç›®æ ‡è¦ä¹ˆæ˜¯çˆ¶èµ„æºï¼Œè¦ä¹ˆæ˜¯é¡¶çº§é›†åˆã€‚ä¾‹å¦‚ /usersï¼Œ/devices ã€‚\nèµ„æºä¸€æ—¦åˆ›å»ºæˆåŠŸï¼Œæ„å‘³ç€åº”è¯¥å…è®¸æŸ¥è¯¢æˆ–åˆ é™¤/ä¿®æ”¹ç­‰æ“ä½œï¼Œè¦ä¿è¯èµ„æºä¸€è‡´æ€§ã€‚\nDelete (åˆ é™¤èµ„æº)\né€šå¸¸ä½¿ç”¨èµ„æºå”¯ä¸€æ ‡è¯†ç¬¦åˆ é™¤ï¼Œä¾‹å¦‚ DELETE /users/6n12312m ã€‚\né‡å¤åˆ é™¤ç›¸åŒçš„èµ„æºï¼Œåº”å½“è¿”å›æ­£ç¡®çš„ç»“æœï¼Œæ— è®ºèµ„æºæ˜¯å¦å­˜åœ¨ï¼Œå…¶æœ€ç»ˆè¾¾åˆ°äº†åˆ é™¤çš„ç›®çš„ã€‚å¯ä»¥å“åº”è¢«åˆ é™¤çš„æ•°æ®ï¼Œå¦‚æœèµ„æºä¸å­˜åœ¨æ—¶ï¼Œå¯èƒ½åªæœ‰èµ„æºæ ‡è¯†ç¬¦ï¼Œèµ„æºå±æ€§ä¸ºé›¶å€¼ã€‚\nPATCH (éƒ¨åˆ†æ›´æ–°)\nåœ¨ä¸šåŠ¡å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸å¤ªéœ€è¦æ˜ç¡®éƒ¨åˆ†æ›´æ–°è¿˜æ˜¯å…¨é‡æ›´æ–°çš„åŒºåˆ«ï¼Œå»ºè®®ä½¿ç”¨ PUT æ›¿ä»£ã€‚\nPUT (æ›¿æ¢èµ„æº)\nå¦‚æœä½¿ç”¨ PUT åŒ…å« PATCH çš„å†…å®¹ï¼Œä¼šå‡ºç°éƒ¨åˆ†æ›´æ–°çš„çŠ¶å†µï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨ query å‚æ•° fields æ¥è¡¨ç¤ºå“ªäº›å‚æ•°éœ€è¦æ›´æ–°ï¼Œä¾‹å¦‚ PUT /users/n1i24km?fields=name ï¼Œæ­¤æ—¶è¡¨ç¤ºåªæ›´æ–°ç”¨æˆ·åã€‚\nè‡ªå®šä¹‰æ–¹æ³•\nREST ful API æ˜¯å°† API è§†ä¸ºèµ„æºçš„è®¾è®¡æ–¹æ¡ˆï¼Œåœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œæœ‰äº›è¡Œä¸ºæ˜¯åŠ¨ä½œï¼Œæ¯”å¦‚å¯¼å…¥å¯¼å‡ºï¼Œæ¯”å¦‚è®¾å¤‡é‡å¯/æ ¼å¼åŒ–ã€‚æœ‰äº›åŠ¨ä½œå¹¶ä¸ä¸€å®šä¼šå¯¹èµ„æºå±æ€§å‘ç”Ÿæ›´æ”¹ã€‚è¿™äº›è‡ªå®šä¹‰çš„æ–¹æ³•å‡ ä¹éƒ½åº”è¯¥ä½¿ç”¨ POST HTTP Methodï¼Œå½“ç„¶ä½¿ç”¨å…¶å®ƒ Method ä¹Ÿæœ‰åº”ç”¨åœºæ™¯ï¼Œä¸æ˜ç¡®ç”¨ä»€ä¹ˆæ—¶ï¼Œé‚£å°±åº”è¯¥ç”¨ POST ã€‚\nä¸ºäº†é¿å…å¯¹èµ„æºé€ æˆæ··æ·†ï¼Œåº”å½“é¿å…ä½¿ç”¨ / ï¼Œå¯ä»¥ä½¿ç”¨ : åŠ åŠ¨è¯æ¥æŒ‡ç¤ºèµ„æºçš„æ“ä½œï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œä½†é¿å…æ­§ä¹‰å¾ˆé‡è¦ã€‚å†’å·æ˜¯ URL ä¸­ä¿ç•™ç‰¹æ®Šå­—ç¬¦ï¼Œä¼šè¢«è½¬ç ä¸º %3A ã€‚ä¾‹å¦‚å¯¼å‡ºè®¾å¤‡é€šé“ /devices/1/channels:exportï¼Œå¯¼å…¥è®¾å¤‡ä¿¡æ¯ /devices:importã€‚\nå¦‚æœå¯¹å¤šä¸ªä¸åŒçˆ¶çº§çš„ä¸€ç»„èµ„æºæ“ä½œåº”è¯¥æ€ä¹ˆå¤„ç†å‘¢? ä¾‹å¦‚ /users/1/messages å¹¶ä¸å…³å¿ƒç”¨æˆ·æ˜¯è°ï¼Œè€Œå…³å¿ƒæ“ä½œçš„å­èµ„æºï¼Œæ­¤æ—¶å¯ä»¥å°†çˆ¶æ ‡è¯†æ›¿æ¢ä¸ºé€šé…ç¬¦ï¼Œå¦‚/users/-/messagesï¼ŒæœåŠ¡ç«¯ä¸ä¼šå»å¤„ç†çˆ¶èµ„æºï¼Œä½¿ç”¨é€šé…ç¬¦ä»è¯­ä¹‰ä¸Šæ›´å®¹æ˜“æ‡‚ã€‚\né€šå¸¸è‡ªå®šä¹‰æ–¹æ³•ä¸æ˜¯å¹‚ç­‰çš„ï¼Œä¼šæœ‰å‰¯ä½œç”¨ï¼Œæ¯”å¦‚è¿ç»­ 2 æ¬¡é‡å¯è®¾å¤‡ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶è®¾å¤‡å·²ç»ç¦»çº¿äº†ã€‚ä½¿ç”¨ :\u0026lt;åŠ¨è¯\u0026gt;èƒ½å¤ŸåŒºåˆ†æ ‡å‡†çš„èµ„æºï¼Œåº”å½“è°¨æ…çš„å¯¹å¾…è¿™äº›æ¥å£ã€‚\nåˆ†é¡µæ¨¡å¼ å¤§é‡æ•°æ®è¢«åŒæ—¶æŸ¥è¯¢ï¼Œä¼šå¢åŠ æ¥å£è€—æ—¶ï¼Œå¯¹äºç”¨æˆ·ä½“éªŒä¸æ˜¯å¾ˆå¥½ï¼Œæ¯æ¬¡æ‰“å¼€å®¢æˆ·ç«¯ï¼Œéƒ½è¦ç­‰å‡ ç§’æ‰èƒ½çœ‹åˆ°ç»“æœ? æ­£ç¡®ä½¿ç”¨åˆ†é¡µæ¨¡å¼ï¼Œå°†æ¶ˆæ¯åˆ†ç‰‡ï¼Œæ¯æ¬¡è¿”å›ä¸€éƒ¨åˆ†ã€‚\nä¾‹å¦‚ç”¨æˆ·çš„æ¶ˆæ¯ã€‚\nGET /users/:id/messages?page=1\u0026amp;size=10\n1 2 3 4 type RequestQuery struct{ Page int // page ç”¨æ¥è¡¨ç¤ºè¯·æ±‚çš„å“ªä¸€é¡µ Size int // size è¡¨ç¤ºæœ€å¤§å–å¤šå°‘æ¡æ•°æ® } å“åº”\n1 { \u0026#34;items\u0026#34;:[], \u0026#34;total\u0026#34;: 200, \u0026#34;next\u0026#34;:\u0026#34;\u0026#34;} items è¡¨ç¤ºå†…å®¹åˆ—è¡¨ï¼Œtotal å’Œ next ä¸€èˆ¬æ˜¯äºŒé€‰ä¸€å­˜åœ¨ï¼Œå½“é‡åˆ°æ”¯æŒè·³é¡µæ—¶ï¼Œåº”è¯¥è¿”å› total è¡¨ç¤ºæ¶ˆæ¯æ€»æ•°ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡ total æ¥è®¡ç®—åˆ†å¤šå°‘é¡µã€‚ å½“é‡åˆ°é¡ºåºç¿»é¡µæ—¶( æ»šåŠ¨ç¿»é¡µ )ï¼Œåº”å½“è¿”å› next ï¼Œæ­¤å€¼æ˜¯è·å–ä¸‹ä¸€é¡µçš„æ–¹æ³•ã€‚\nå¯¼å…¥/å¯¼å‡ºæ¨¡å¼ é€šå¸¸å¯¼å…¥å¯¼å‡ºæ¶‰åŠåˆ°æŸ¥è¯¢è¿›åº¦ï¼ŒæŸ¥è¯¢çŠ¶æ€ï¼Œå†å²è®°å½•ï¼Œä¸‹è½½ä½ç½®ç­‰é—®é¢˜ã€‚\nä»¥å¯¼å‡ºç”¨æˆ·ä¿¡æ¯ä¸ºä¾‹:\nPOST /users/:id/messages:export\nå¯¼å…¥/å¯¼å‡ºæ˜¯ä¸€ä¸ªè¡Œä¸ºåŠ¨ä½œï¼Œæ‰€ä»¥æ­¤å¤„åº”ç”¨ POST åŠ¨è¯åŠ ä¸Šç‰¹æ®Šè¯­æ³•æ¥åŒºåˆ†ï¼Œè¿™ä¸æ˜¯æ ‡å‡† REST APIæ“ä½œã€‚\n1 2 3 4 type RequestBody struct{ Compression int // æŒ‡å®šæ–‡ä»¶å‹ç¼©çº§åˆ« \u0026lt;=0 ä¸å‹ç¼©ï¼Œ1-9 å‹ç¼©çº§åˆ« Filters string // è¿‡æ»¤å¯¼å‡ºå“ªäº›å­—æ®µ } å¯¼å…¥/å¯¼å‡ºæ¨¡å¼åº”è¯¥æŒç»­å“åº”è¿›åº¦ï¼Œå¯ä»¥è¿”å›å…·ä½“çš„é‡å€¼ï¼Œç”±å‰ç«¯æ ¹æ®éœ€è¦æ˜¯è®¡ç®—ç™¾åˆ†æ¯”ï¼Œè¿˜æ˜¯æ˜¾ç¤ºå®é™…çš„é‡å€¼ã€‚\n1 2 3 4 5 6 7 type ResponseMetadata struct{ Total int // æ€»ä»»åŠ¡é‡ Current int // å½“å‰æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªä»»åŠ¡? Success int // é¡ºåˆ©å®Œæˆä»»åŠ¡æ€»é‡ Failure int // æ“ä½œå¤±è´¥çš„ä»»åŠ¡æ€»é‡ Err string // å¦‚æœå½“å‰ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶å­˜åœ¨æ­¤ä¿¡æ¯ï¼Œå¦åˆ™ä¸º undefined } æœ€ç»ˆä»»åŠ¡å®Œæˆæ—¶ï¼Œè¿”å›æ–‡ä»¶ä¿¡æ¯ã€‚\n1 2 3 4 type ResponseBody struct{ Path string // æ–‡ä»¶åœ°å€(å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶åº”å½“è¿”å› path è·¯å¾„ï¼Œè‹¥æ˜¯ s3 å­˜å‚¨åº”å½“è¿”å›å®Œæ•´ url è·¯å¾„) Compression int // å‹ç¼©ä¿¡æ¯ } å…¶ä¸­å¯¼å‡ºæ¨¡å¼ï¼Œåº”å½“å¦å¤–æä¾›è·å–æ–‡ä»¶çš„æ¥å£ã€‚\n","date":"2024-03-30T00:00:00Z","permalink":"https://blog.golang.space/p/api-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/","title":"API è®¾è®¡æ¨¡å¼"},{"content":"ä»€ä¹ˆæ˜¯ Context? context æ˜¯ Go æ ‡å‡†åº“ä¸­çš„\nå‚è€ƒ æœ¬ç¯‡æ–‡ç« ç¿»è¯‘äº The Complete Guide to Context in Golang: Efficient Concurrency Management\n","date":"2023-12-02T00:00:00Z","permalink":"https://blog.golang.space/p/golang-context-%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/","title":"Golang Context å®Œæ•´æŒ‡å—"},{"content":"ä»€ä¹ˆæ˜¯ WHIP å’Œ WHEP ? WHIP è¡¨ç¤º WebRTC-HTTP å…¥å£åè®®ï¼ŒWHEP è¡¨ç¤º WebRTC-HTTP å‡ºå£åè®®ã€‚\nWebRTC æ˜ç¡®å†³å®šä¸é€‚ç”¨ä»»ä½•ä¿¡ä»¤åè®®ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜èƒ½å¤Ÿé€‰æ‹©ä»»ä½•ç°æœ‰ä¿¡ä»¤åè®®ã€‚å¯¹äºæµåª’ä½“è¡Œä¸šæ¥è¯´ä¸æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œå¤§å®¶éœ€è¦ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„åè®®å’Œç°æˆçš„å®ç°ï¼Œäºæ˜¯ä¹äº§ç”Ÿäº† WHIP å’Œ WHEPã€‚\nåœ¨ç›´æ’­ä¾‹å­ä¸­ï¼Œä¸»æ’­å°†æœ¬åœ°åª’ä½“ä¼ åˆ°åª’ä½“æœåŠ¡å™¨ï¼Œå°±æ˜¯ WHIP çš„ç”¨æ­¦ä¹‹åœ°ï¼Œå¦ä¸€ç«¯ç”¨æˆ·å¯ä»¥åœ¨åª’ä½“æœåŠ¡å™¨å‡ºå£ç«¯è·å–æµã€‚\nåœ¨è§†é¢‘ä¼šè®®ä¸­ï¼ŒWebRTC æ¶ˆé™¤äº†å¾ˆå¤šå¤æ‚æ€§ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´å¯èƒ½ä»…ä»…æ˜¯åŠ è½½ç½‘é¡µå°±èƒ½å¼€å§‹ä¼šè®®ã€‚\næµåª’ä½“è¡Œä¸šä¸åŒï¼Œå®ƒä¾èµ– 3 ä¸ªç»„ä»¶ï¼Œè¿™ 3 ä¸ªç»„ä»¶å¯èƒ½æ¥æºäºä¸åŒçš„æä¾›è€…ã€‚\nåª’ä½“æœåŠ¡å™¨ åª’ä½“æºï¼Œé€šå¸¸æ˜¯ç½‘ç»œæ‘„åƒæœº è§‚ä¼— WHIP å’Œ WHEP æ­£æ˜¯è¿æ¥ä¸‰è€…çš„ç­”æ¡ˆï¼ŒWHIP å°†åª’ä½“æºè¿æ¥åˆ°åª’ä½“æœåŠ¡å™¨ï¼ŒWHEP å°†åª’ä½“æœåŠ¡å™¨è¿æ¥è§‚ä¼—ã€‚\nåœ¨æµåª’ä½“è¡Œä¸šï¼ŒWebRTC å¯èƒ½æ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œæœªæ¥æ›´å¯èƒ½æ˜¯ WebTransport+WebCodecs+WebAssembly çš„æ›¿ä»£æ–¹æ¡ˆã€‚\nå‚è€ƒ ç¿»è¯‘ WHIP \u0026amp; WHEP: Is WebRTC the future of live streaming?\n","date":"2023-11-21T00:00:00Z","permalink":"https://blog.golang.space/p/%E4%BB%80%E4%B9%88%E6%98%AF-whip-%E5%92%8C-whep/","title":"ä»€ä¹ˆæ˜¯ WHIP å’Œ WHEP"},{"content":"WebRTC æ˜¯ Web å®æ—¶é€šä¿¡ï¼ˆReal-Time Communicationï¼‰çš„ç¼©å†™ï¼Œå®ƒæ—¢æ˜¯ API ä¹Ÿæ˜¯åè®®ã€‚WebRTC åè®®æ˜¯ä¸¤ä¸ª WebRTC Agent åå•†åŒå‘å®‰å…¨å®æ—¶é€šä¿¡çš„ä¸€ç»„è§„åˆ™ã€‚\nå¯ä»¥ç”¨ HTTP å’Œ Fetch API ä¹‹é—´çš„å…³ç³»ä½œä¸ºç±»æ¯”ã€‚WebRTC åè®®å°±æ˜¯ HTTPï¼Œè€Œ WebRTC API å°±æ˜¯ Fetch APIã€‚\nWebRTC åè®®æ˜¯ä¸€ç»„å…¶ä»–æŠ€æœ¯çš„é›†åˆä½“ ä¿¡ä»¤ï¼špeer å¦‚ä½•åœ¨ WebRTC ä¸­æ‰¾åˆ°å½¼æ­¤ å½“ WebRTC Agent å¯åŠ¨æ—¶ï¼Œå®ƒä¸çŸ¥é“ä¸è°é€šä¿¡ä»¥åŠä»–ä»¬å°†è¦é€šä¿¡çš„å†…å®¹ã€‚ä¿¡ä»¤è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼ä¿¡ä»¤ç”¨äºå¼•å¯¼å‘¼å«ï¼Œä»¥ä¾¿ä¸¤ä¸ª WebRTC Agent å¯ä»¥å¼€å§‹é€šä¿¡ã€‚\nä¿¡ä»¤ä½¿ç”¨ä¸€ç§ç°æœ‰çš„åè®® SDPï¼ˆä¼šè¯æè¿°åè®®ï¼‰ã€‚SDP æ˜¯ä¸€ç§çº¯æ–‡æœ¬åè®®ã€‚æ¯ä¸ª SDP æ¶ˆæ¯å‡ç”±é”® / å€¼å¯¹ç»„æˆï¼Œå¹¶åŒ…å«â€œmedia sectionsï¼ˆåª’ä½“éƒ¨åˆ†ï¼‰â€åˆ—è¡¨ã€‚\nä»»ä½•é€‚åˆå‘é€æ¶ˆæ¯çš„æ¶æ„å‡å¯è¢«ç”¨äºä¼ é€’ SDP ä¿¡æ¯ï¼Œè®¸å¤šåº”ç”¨ç¨‹åºéƒ½ä½¿ç”¨å…¶ç°æœ‰çš„åŸºç¡€è®¾æ–½ï¼ˆä¾‹å¦‚ REST ç«¯ç‚¹ï¼ŒWebSocket è¿æ¥æˆ–èº«ä»½éªŒè¯ä»£ç†ï¼‰æ¥è§£å†³é€‚å½“å®¢æˆ·ç«¯ä¹‹é—´çš„ SDP ä¼ é€’é—®é¢˜ã€‚\nä½¿ç”¨ STUN/TURN è¿›è¡Œè¿æ¥å’Œ NAT ç©¿é€ ICEï¼ˆäº¤äº’å¼è¿æ¥å»ºç«‹ï¼‰æ˜¯ WebRTC å‰ç°æœ‰çš„åè®®ã€‚ICE å…è®¸åœ¨ä¸¤ä¸ª Agent ä¹‹é—´å»ºç«‹è¿æ¥ã€‚è¿™äº› Agent å¯ä»¥åœ¨åŒä¸€ç½‘ç»œä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨ä¸–ç•Œçš„å¦ä¸€ç«¯ã€‚ICE æ˜¯æ— éœ€ä¸­å¤®æœåŠ¡å™¨å³å¯å»ºç«‹ç›´æ¥è¿æ¥çš„è§£å†³æ–¹æ¡ˆã€‚\nä½¿ç”¨ DTLS å’Œ SRTP åŠ å¯†ä¼ è¾“å±‚ ç¬¬ä¸€ä¸ªåè®®æ˜¯ DTLSï¼ˆæ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨æ€§ï¼‰ï¼Œå³åŸºäº UDP çš„ TLSã€‚\nç¬¬äºŒç§åè®®æ˜¯ SRTPï¼ˆå®‰å…¨å®æ—¶ä¼ è¾“åè®®ï¼‰ã€‚\né¦–å…ˆï¼ŒWebRTC é€šè¿‡åœ¨ ICE å»ºç«‹çš„è¿æ¥ä¸Šè¿›è¡Œ DTLS æ¡æ‰‹æ¥è¿›è¡Œè¿æ¥ã€‚ä¸ HTTPS ä¸åŒï¼ŒWebRTC ä¸ä½¿ç”¨ä¸­å¤®æˆæƒæ¥é¢å‘è¯ä¹¦ã€‚ç›¸åï¼ŒWebRTC åªæ˜¯åˆ¤æ–­é€šè¿‡ DTLS äº¤æ¢çš„è¯ä¹¦æ˜¯å¦ä¸é€šè¿‡ä¿¡ä»¤å…±äº«çš„ç­¾åç›¸ç¬¦ã€‚\næ¥ä¸‹æ¥ï¼ŒWebRTC ä½¿ç”¨ RTP åè®®è¿›è¡ŒéŸ³é¢‘ / è§†é¢‘çš„ä¼ è¾“ã€‚æˆ‘ä»¬ä½¿ç”¨ SRTP æ¥ä¿æŠ¤æˆ‘ä»¬çš„ RTP æ•°æ®åŒ…ã€‚æˆ‘ä»¬ä»åå•†çš„ DTLS ä¼šè¯ä¸­æå–å¯†é’¥ï¼Œç”¨æ¥åˆå§‹åŒ– SRTP ä¼šè¯ã€‚\né€šè¿‡ RTP å’Œ SCTP è¿›è¡Œç‚¹å¯¹ç‚¹é€šä¿¡ RTPï¼ˆå®æ—¶ä¼ è¾“åè®®ï¼‰å’Œ SCTPï¼ˆæµæ§åˆ¶ä¼ è¾“åè®®ï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨ RTP æ¥äº¤æ¢ç”¨ SRTP åŠ å¯†è¿‡çš„åª’ä½“æ•°æ®ï¼Œä½¿ç”¨ SCTP å‘é€å’Œæ¥æ”¶é‚£äº›ç”¨ DTLS åŠ å¯†è¿‡çš„ DataChannel æ¶ˆæ¯ã€‚\n","date":"2023-11-12T00:00:00Z","permalink":"https://blog.golang.space/p/webrtc-%E5%85%A5%E9%97%A8/","title":"WebRTC å…¥é—¨"},{"content":"ä½¿ç”¨ TraceQL æŸ¥è¯¢ å— PromQL å’Œ LogQL çš„å¯å‘ï¼ŒTraceQL æ˜¯ä¸€ç§æŸ¥è¯¢è¯­è¨€ï¼Œè®¾è®¡ç”¨äºåœ¨ Tempo ä¸­é€‰æ‹©è·Ÿè¸ªã€‚ç›®å‰ï¼ŒTraceQL æŸ¥è¯¢å¯ä»¥æ ¹æ®ä»¥ä¸‹å†…å®¹é€‰æ‹©è·Ÿè¸ªï¼š\nSpan and resource attributes, timing, and duration åŸºæœ¬èšåˆï¼Œ count(), avg(),min(),max(),sum() æ„å»ºæŸ¥è¯¢ åœ¨ TraceQL ä¸­ï¼ŒæŸ¥è¯¢æ˜¯ä¸€æ¬¡å¯¹ä¸€ä¸ªè¿½è¸ªæ±‚å€¼çš„è¡¨è¾¾å¼ã€‚æŸ¥è¯¢çš„ç»“æ„ä¸ºä¸€ç»„é“¾å¼è¡¨è¾¾å¼ï¼ˆç®¡é“ï¼‰ã€‚ç®¡é“ä¸­çš„æ¯ä¸ªè¡¨è¾¾å¼éƒ½ä¼šé€‰æ‹©æˆ–æ”¾å¼ƒåŒ…å«åœ¨ç»“æœé›†ä¸­çš„èŒƒå›´é›†ã€‚ä¾‹å¦‚ï¼š\n1 { span.http.status_code \u0026gt;= 200 \u0026amp;\u0026amp; span.http.status_code \u0026lt; 300 } | count() \u0026gt; 2 å¤§æ‹¬å· {} å§‹ç»ˆä»å½“å‰è¿½è¸ªä¸­é€‰æ‹©ä¸€ç»„èŒƒå›´ã€‚è‡ªå®šä¹‰å±æ€§ä»¥ .ï¼Œspan.ï¼Œresource. ä¸ºå‰ç¼€ï¼Œå†…åœ¨å‡½æ•°å¯ç›´æ¥é”®å…¥ã€‚\nå…³é”®å­—\n","date":"2023-10-15T00:00:00Z","permalink":"https://blog.golang.space/p/%E4%BD%BF%E7%94%A8-traceql-%E6%9F%A5%E8%AF%A2/","title":"ä½¿ç”¨ TraceQL æŸ¥è¯¢"},{"content":"OpenTelemetry OpenTelemetry æ˜¯ä¸€ä¸ªå¯è§‚å¯Ÿæ€§æ¡†æ¶å’Œå·¥å…·åŒ…ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†é“¾è·¯ï¼ŒæŒ‡æ ‡å’Œæ—¥å¿—ç­‰é¥æµ‹æ•°æ®ã€‚\nå®ƒä¸åƒ Jaegerï¼ŒPrometheus é‚£æ ·çš„å¯è§‚å¯Ÿæ€§åç«¯ï¼Œå®ƒä¸“æ³¨äºé¥æµ‹æ•°æ®çš„ç”Ÿæˆï¼Œæ”¶é›†ï¼Œç®¡ç†å’Œå¯¼å‡ºã€‚æ•°æ®çš„å­˜å‚¨å’Œå¯è§†åŒ–ç”±å…¶å®ƒå·¥å…·æä¾›ã€‚\nå¯è§‚å¯Ÿæ€§ ä»€ä¹ˆæ˜¯å¯è§‚å¯Ÿæ€§?\nä»å¤–éƒ¨äº†è§£åº”ç”¨ç³»ç»Ÿå†…æ­£å‘ç”Ÿä»€ä¹ˆã€‚\nå¯é æ€§å’ŒæŒ‡æ ‡\né¥æµ‹æ˜¯æŒ‡ä»ç³»ç»Ÿå‘å‡ºçš„æœ‰å…³å…¶è¡Œä¸ºçš„æ•°æ®ï¼Œæ•°æ®å¯ä»¥æ˜¯é“¾è·¯ï¼ŒæŒ‡æ ‡ï¼Œæ—¥å¿—çš„å½¢å¼ã€‚\næœåŠ¡æ˜¯å¦æŒ‰ç…§ç”¨æˆ·æœŸæœ›çš„è¿è¡Œ? å¦‚æœç”¨æˆ·å°†ä¸€æ¡é»‘è‰²è£¤å­æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œä½†ç³»ç»Ÿæ˜¾ç¤ºçº¢è‰²çš„è£¤å­ï¼Œæ˜¾ç„¶è¢«è®¤ä¸ºæ˜¯ä¸å¯é ã€‚\næŒ‡æ ‡æ˜¯ä¸€æ®µæ—¶é—´å†…ï¼Œæœ‰å…³åŸºç¡€è®¾ç½®å’Œåº”ç”¨ç¨‹åºçš„æ•°å­—æ•°æ®çš„èšåˆã€‚åŒ…æ‹¬ CPU ï¼Œé”™è¯¯ç‡ ï¼Œè°ƒç”¨é¢‘ç‡ï¼Œè¿æ¥æ•°ï¼Œè¯·æ±‚æ¬¡æ•°ç­‰ç­‰ã€‚\nSLI ( Service Level Indicator )ï¼Œè¡¨ç¤ºæœåŠ¡çš„è¡¡é‡æ ‡å‡†ï¼Œä¾‹å¦‚ç½‘é¡µåŠ è½½çš„é€Ÿåº¦ã€‚\nSLO ( Service Level Objective )ï¼Œå‘ç»„ç»‡ä¼ è¾¾å¯é æ€§çš„æ–¹å¼ã€‚\näº†è§£åˆ†å¸ƒå¼è¿½è¸ª æ—¥å¿—\næ—¥å¿—æ˜¯ç”±æœåŠ¡æˆ–å…¶å®ƒç»„ä»¶å‘å‡ºçš„å¸¦æœ‰æ—¶é—´æˆ³çš„æ¶ˆæ¯ï¼Œè¿‡å»å¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜éå¸¸ä¾èµ–å®ƒä»¬æ¥å¸®åŠ©ç†è§£ç³»ç»Ÿè¡Œä¸ºã€‚\nä½†æ—¥å¿—å¯¹äºè¿½è¸ªä»£ç æ‰§è¡Œå¹¶ä¸æ˜¯éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºé€šå¸¸ç¼ºä¹ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚å®ƒä»¬æ˜¯ä»å“ªé‡Œè°ƒç”¨çš„ã€‚\nå½“å®ƒä»¬ä¸è¿½è¸ªç›¸å…³æ—¶ï¼Œä¼šå˜å¾—æ›´åŠ æœ‰ç”¨ã€‚\nSpans\nSpan ä»£è¡¨ä¸€ä¸ªå·¥ä½œæˆ–æ“ä½œå•å…ƒã€‚å®ƒè¿½è¸ªè¯·æ±‚è¿›è¡Œçš„ç‰¹å®šæ“ä½œï¼Œæç»˜æ‰§è¡Œè¯¥æ“ä½œæœŸé—´å‘ç”Ÿçš„æƒ…å†µã€‚\nåŒ…å«åç§°ï¼Œæ—¶é—´ï¼Œç»“æ„åŒ–æ—¥å¿—æ¶ˆæ¯æˆ–å…¶å®ƒå…ƒæ•°æ®ã€‚\nåˆ†å¸ƒå¼è¿½è¸ª\nåˆ†å¸ƒå¼è¿½è¸ªï¼Œè®°å½•è¯·æ±‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ä¼ æ’­æ—¶æ‰€é‡‡ç”¨çš„è·¯å¾„ã€‚\nå¦‚æœæ²¡æœ‰è¿½è¸ªï¼Œå°±å¾ˆéš¾æŸ¥æ˜åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ€§èƒ½é—®é¢˜çš„åŸå› ã€‚\nå®ƒæé«˜äº†åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿè¿è¡ŒçŠ¶å†µçš„å¯è§æ€§ï¼Œå¹¶è®©æˆ‘ä»¬èƒ½å¤Ÿè°ƒè¯•éš¾ä»¥åœ¨æœ¬åœ°é‡ç°çš„è¡Œä¸ºã€‚\nä¿¡å· Traces æä¾›äº†åº”ç”¨ç¨‹åºå‘å‡ºè¯·æ±‚æ—¶å‘ç”Ÿçš„æƒ…å†µã€‚\né€šè¿‡ä¸‰ä¸ªå·¥ä½œå•å…ƒï¼Œç”¨ Spans è¡¨ç¤º:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # hello span # æ³¨æ„ï¼Œå®ƒæœ‰ä¸€ä¸ªæŒ‡ç¤ºè¿½è¸ªçš„ trace_id { \u0026#34;name\u0026#34;: \u0026#34;hello\u0026#34;, \u0026#34;context\u0026#34;: { \u0026#34;trace_id\u0026#34;: \u0026#34;0x5b8aa5a2d2c872e8321cf37308d69df2\u0026#34;, \u0026#34;span_id\u0026#34;: \u0026#34;0x051581bf3cb55c13\u0026#34; }, \u0026#34;parent_id\u0026#34;: null, \u0026#34;start_time\u0026#34;: \u0026#34;2022-04-29T18:52:58.114201Z\u0026#34;, \u0026#34;end_time\u0026#34;: \u0026#34;2022-04-29T18:52:58.114687Z\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;http.route\u0026#34;: \u0026#34;some_route1\u0026#34; }, \u0026#34;events\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;Guten Tag!\u0026#34;, \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-29T18:52:58.114561Z\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;event_attributes\u0026#34;: 1 } } ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # hello-greetings span # è¿™ä¸ª span å°è£…äº†ç‰¹å®šçš„ä»»åŠ¡ï¼Œå®ƒä¸ hello å…±äº« trace_idï¼Œå¹¶æœ‰ parent_id æŒ‡ç¤ºè°ƒç”¨å…³ç³»ã€‚ { \u0026#34;name\u0026#34;: \u0026#34;hello-greetings\u0026#34;, \u0026#34;context\u0026#34;: { \u0026#34;trace_id\u0026#34;: \u0026#34;0x5b8aa5a2d2c872e8321cf37308d69df2\u0026#34;, \u0026#34;span_id\u0026#34;: \u0026#34;0x5fb397be34d26b51\u0026#34; }, \u0026#34;parent_id\u0026#34;: \u0026#34;0x051581bf3cb55c13\u0026#34;, \u0026#34;start_time\u0026#34;: \u0026#34;2022-04-29T18:52:58.114304Z\u0026#34;, \u0026#34;end_time\u0026#34;: \u0026#34;2022-04-29T22:52:58.114561Z\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;http.route\u0026#34;: \u0026#34;some_route2\u0026#34; }, \u0026#34;events\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;hey there!\u0026#34;, \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-29T18:52:58.114561Z\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;event_attributes\u0026#34;: 1 } }, { \u0026#34;name\u0026#34;: \u0026#34;bye now!\u0026#34;, \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-29T18:52:58.114585Z\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;event_attributes\u0026#34;: 1 } } ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # hello-salutations # è¯¥ span ä»£è¡¨æ­¤è·Ÿè¸ªä¸­çš„ç¬¬ä¸‰ä¸ªæ“ä½œï¼Œå®ƒæ˜¯ `hello` span çš„å­çº§ï¼Œä¸ `hello-greetings` åŒçº§ã€‚ { \u0026#34;name\u0026#34;: \u0026#34;hello-salutations\u0026#34;, \u0026#34;context\u0026#34;: { \u0026#34;trace_id\u0026#34;: \u0026#34;0x5b8aa5a2d2c872e8321cf37308d69df2\u0026#34;, \u0026#34;span_id\u0026#34;: \u0026#34;0x93564f51e1abe1c2\u0026#34; }, \u0026#34;parent_id\u0026#34;: \u0026#34;0x051581bf3cb55c13\u0026#34;, \u0026#34;start_time\u0026#34;: \u0026#34;2022-04-29T18:52:58.114492Z\u0026#34;, \u0026#34;end_time\u0026#34;: \u0026#34;2022-04-29T18:52:58.114631Z\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;http.route\u0026#34;: \u0026#34;some_route3\u0026#34; }, \u0026#34;events\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;hey there!\u0026#34;, \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-29T18:52:58.114561Z\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;event_attributes\u0026#34;: 1 } } ] } åœ¨ä¸‰ä¸ª JSON å—ï¼Œæœ‰ç›¸åŒçš„ trace_idï¼Œæœ‰ parent_id æ¥è¡¨ç¤ºå±‚æ¬¡ç»“æ„ï¼Œå…·æœ‰ä¸Šä¸‹æ–‡ï¼Œç›¸å…³ä¿¡æ¯ï¼Œå±‚æ¬¡ç»“æ„ã€‚\nTracer Provider\nè¿™æ˜¯ Tracer çš„å·¥å‚ï¼Œåœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­ï¼ŒProvider ä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œè¿˜åŒ…æ‹¬ Resource å’Œ Exporter åˆå§‹åŒ–ã€‚\nTracer\ntracer åˆ›å»ºçš„ span åŒ…å«æœ‰å…³ç»™å®šæ“ä½œé”å‘ç”Ÿæƒ…å†µçš„æ›´å¤šä¿¡æ¯ï¼Œç”± Tracer Provider åˆ›å»ºã€‚\nTrace Exporters\nè¿½è¸ªå¯¼å‡ºå™¨å°†æ•°æ®å‘é€ç»™æ¶ˆè´¹è€…ã€‚å¯ä»¥æ˜¯ OpenTelemetry Collector æˆ–å…¶å®ƒåç«¯ã€‚\nContext Propagation\nä¸Šä¸‹æ–‡ä¼ æ’­æ˜¯å®ç°åˆ†å¸ƒå¼è·Ÿè¸ªçš„æ ¸å¿ƒæ¦‚å¿µã€‚é€šè¿‡ä¸Šä¸‹æ–‡ä¼ æ’­ï¼ŒSpan å¯ä»¥äº’ç›¸å…³è”å¹¶ç»„è£…æˆ Tracerã€‚\nContext æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«å‘é€å’Œæ¥æ”¶æœåŠ¡çš„ä¿¡æ¯ï¼Œç”¨äºå°†ä¸€ä¸ª Span ä¸ å¦ä¸€ä¸ª Span å…³è”èµ·æ¥ã€‚\nPropagation æ˜¯åœ¨æœåŠ¡å’Œè¿›ç¨‹ä¹‹é—´ç§»åŠ¨ä¸Šä¸‹æ–‡çš„æœºåˆ¶ï¼Œå®ƒåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚OpenTelemetry æ”¯æŒå¤šç§ä¸åŒçš„ä¸Šä¸‹æ–‡æ ¼å¼ã€‚ OpenTelemetry è·Ÿè¸ªä¸­ä½¿ç”¨çš„é»˜è®¤æ ¼å¼ç§°ä¸º W3C TraceContextã€‚\nSpans\nSpan æ˜¯ Traces çš„æ„å»ºæ¨¡å—ã€‚åŒ…å«ä»¥ä¸‹ä¿¡æ¯:\nName Parent span ID (empty for root spans) Start and End Timestamps Span Contextï¼Œæ¯ä¸ª Span ä¸å¯å˜å¯¹è±¡ï¼ŒåŒ…å« trace_idï¼Œspan_idï¼Œstate Attributesï¼ŒåŒ…å«å…ƒæ•°æ®çš„é”®å€¼å¯¹ï¼Œæè¿°è¿½è¸ªæ“ä½œçš„ä¿¡æ¯ Span Eventsï¼Œå¯ä»¥è¢«è®¤ä¸ºæ˜¯ç»“æ„åŒ–æ—¥å¿—ï¼Œé€šå¸¸è¡¨ç¤ºæŒç»­æ—¶é—´å†…æœ‰æ„ä¹‰çš„å•ä¸€æ—¶é—´ç‚¹ Span linksï¼Œå…³è”å¤šä¸ª spanï¼Œå› æœå…³ç³»ã€‚ Span Statusï¼Œå½“ä»£ç ä¸­å‡ºç°é”™è¯¯æ—¶ï¼Œå¯ä»¥è®¾ç½® span çŠ¶æ€ã€‚ Unsetï¼Œç”±å¤„ç† span çš„åç«¯åˆ†é… OKï¼Œä¸€åˆ‡æ­£å¸¸ ``Error`ï¼Œä»£ç ä¸­å‡ºç°é”™è¯¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 { \u0026#34;trace_id\u0026#34;: \u0026#34;7bba9f33312b3dbb8b2c2c62bb7abe2d\u0026#34;, \u0026#34;parent_id\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;span_id\u0026#34;: \u0026#34;086e83747d0e381e\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;/v1/sys/health\u0026#34;, \u0026#34;start_time\u0026#34;: \u0026#34;2021-10-22 16:04:01.209458162 +0000 UTC\u0026#34;, \u0026#34;end_time\u0026#34;: \u0026#34;2021-10-22 16:04:01.209514132 +0000 UTC\u0026#34;, \u0026#34;status_code\u0026#34;: \u0026#34;STATUS_CODE_OK\u0026#34;, \u0026#34;status_message\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;attributes\u0026#34;: { \u0026#34;net.transport\u0026#34;: \u0026#34;IP.TCP\u0026#34;, \u0026#34;net.peer.ip\u0026#34;: \u0026#34;172.17.0.1\u0026#34;, \u0026#34;net.peer.port\u0026#34;: \u0026#34;51820\u0026#34;, \u0026#34;net.host.ip\u0026#34;: \u0026#34;10.177.2.152\u0026#34;, \u0026#34;net.host.port\u0026#34;: \u0026#34;26040\u0026#34;, \u0026#34;http.method\u0026#34;: \u0026#34;GET\u0026#34;, \u0026#34;http.target\u0026#34;: \u0026#34;/v1/sys/health\u0026#34;, \u0026#34;http.server_name\u0026#34;: \u0026#34;mortar-gateway\u0026#34;, \u0026#34;http.route\u0026#34;: \u0026#34;/v1/sys/health\u0026#34;, \u0026#34;http.user_agent\u0026#34;: \u0026#34;Consul Health Check\u0026#34;, \u0026#34;http.scheme\u0026#34;: \u0026#34;http\u0026#34;, \u0026#34;http.host\u0026#34;: \u0026#34;10.177.2.152:26040\u0026#34;, \u0026#34;http.flavor\u0026#34;: \u0026#34;1.1\u0026#34; }, \u0026#34;events\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;OK\u0026#34;, \u0026#34;timestamp\u0026#34;: \u0026#34;2021-10-22 16:04:01.209512872 +0000 UTC\u0026#34; } ] } Span Kind\nSpan æœ‰ä»¥ä¸‹ç±»å‹:\nclientï¼Œå­çº§é€šå¸¸æ˜¯ server spanï¼Œè¡¨ç¤ºåŒæ­¥ä¼ å‡ºè¿œç¨‹è°ƒç”¨ã€‚ serverï¼Œçˆ¶çº§é€šå¸¸æ˜¯ client spanï¼Œè¡¨ç¤ºè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ã€‚ internalï¼Œæœªæä¾›ç±»å‹ï¼Œåˆ™é»˜è®¤ä¸ºæ­¤ç±»å‹ï¼Œè¡¨ç¤ºä¸è·¨è¶Š span çš„æ“ä½œã€‚ producerï¼Œå­çº§é€šå¸¸æ˜¯ consumer spanï¼Œè¡¨ç¤ºåˆ›å»ºä¸€ä¸ªç¨åå¯èƒ½ä¼šå¼‚æ­¥å¤„ç†çš„ä½œä¸šã€‚ consumerï¼Œçˆ¶çº§é€šå¸¸æ˜¯ producer spanï¼Œè¡¨ç¤ºå¯¹ producer åˆ›å»ºçš„ä½œä¸šçš„å¤„ç†ï¼Œå¯èƒ½å†å¾ˆä¹…ä¹‹åæ‰å¼€å§‹ã€‚ Metrics å¯¹è¿è¡Œæ—¶æ•è·çš„æµ‹é‡ï¼Œæ•è·æµ‹é‡çš„æ—¶åˆ»ç§°ä¸ºåº¦é‡äº‹ä»¶ï¼Œä¸ä»…åŒ…æ‹¬æµ‹é‡æœ¬èº«ï¼Œè¿˜åŒ…æ‹¬æ•è·çš„æ—¶é—´å’Œå…³è”çš„å…ƒæ•°æ®ã€‚\nåº”ç”¨ç¨‹åºå’Œè¯·æ±‚æŒ‡æ ‡æ˜¯å¯ç”¨æ€§å’Œæ€§èƒ½çš„é‡è¦æŒ‡æ ‡ï¼Œè‡ªå®šä¹‰æŒ‡æ ‡å¯ä»¥æ·±å…¥äº†è§£å…¶å¦‚ä½•å½±å“ç”¨æˆ·ä½“éªŒæˆ–ä¸šåŠ¡ã€‚æ”¶é›†çš„æ•°æ®å¯ç”¨äºå‘å‡ºè­¦æŠ¥æˆ–è°ƒåº¦å†³ç­–ï¼Œä»¥æ ¹æ®é«˜éœ€æ±‚è‡ªåŠ¨æ‰©å±•éƒ¨ç½²ã€‚\nMeter Provider\næ˜¯ Metrics çš„å·¥å‚ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œè¿˜åŒ…æ‹¬ Resource å’Œ Exporter åˆå§‹ã€‚\nMeter\nåˆ›å»ºåº¦é‡å·¥å…·ï¼Œåœ¨è¿è¡Œæ—¶æ•è·æœ‰å…³æœåŠ¡çš„æµ‹é‡ç»“æœã€‚\nMetric Exporter\nå°†æ•°æ®å‘é€ç»™æ¶ˆè´¹è€…ï¼Œå¯ä»¥æ˜¯æ ‡å‡†è¾“å‡ºOpenTelemetry Collector æˆ–å…¶å®ƒåç«¯ã€‚\nMetric Instruments\næµ‹é‡ç»“æœç”±å®ƒæ•è·ï¼Œå®šä¹‰å¦‚ä¸‹:\nName Kind Unit Description instrument çš„ kind æœ‰:\ncounterï¼Œè®¡æ•°å™¨ï¼Œåªä¼šä¸Šæ¶¨ asynchronous counterï¼Œå¼‚æ­¥è®¡æ•°å™¨ï¼Œä¸è®¡æ•°å™¨ç›¸åŒï¼Œä½†æ¯æ¬¡å¯¼å‡ºåªä¼šæ”¶é›†ä¸€æ¬¡ã€‚å¦‚æœæ— æ³•è®¿é—®è¿ç»­å¢é‡ï¼Œè€Œåªèƒ½è®¿é—®èšåˆå€¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ã€‚ UpDownCounterï¼Œéšç€æ—¶é—´ç§¯ç´¯çš„å€¼ï¼Œå¯ä»¥ä¸‹é™ã€‚ asynchronous UpDownCounterï¼Œä¸ UpDownCounter ç›¸åŒï¼Œä½†æ¯æ¬¡å¯¼å‡ºæ—¶æ”¶é›†ä¸€æ¬¡ã€‚ Gauge ï¼Œä»ªè¡¨ï¼Œæµ‹é‡è¯»å–æ—¶çš„å½“å‰å€¼ï¼Œä¾‹å¦‚æ±½è½¦çš„åŠŸç‡è¡¨ã€‚ Histogram ï¼Œç›´æ–¹å›¾ï¼Œå€¼çš„èšåˆï¼Œä¾‹å¦‚è¯·æ±‚å»¶è¿Ÿï¼Œä¾‹å¦‚æœ‰å¤šå°‘ä¸ªè¯·æ±‚èŠ±è´¹çš„æ—¶é—´å¤§äº 1 ç§’ã€‚ Aggregation\nå°†å¤§é‡ç»“æœç»„åˆæˆæœ‰å…³çª—å£æœŸå‘ç”Ÿçš„åº¦é‡äº‹ä»¶ã€‚\nä¾‹å¦‚:\nç³»ç»Ÿè°ƒç”¨æŒç»­æ—¶é—´ è¯·æ±‚æ•°é‡è¶‹åŠ¿ CPU æˆ– å†…å­˜ä½¿ç”¨æƒ…å†µ è´¦å·çš„å¹³å‡ä½™é¢ å½“å‰æ­£åœ¨å¤„ç†çš„æ´»åŠ¨è¯·æ±‚ View\nè§†å›¾ä¸ºç”¨æˆ·æä¾›è‡ªå®šä¹‰è¾“å‡ºæŒ‡æ ‡çš„çµæ´»æ€§ã€‚\nLogs Go ç‰ˆæœ¬æˆªæ­¢ 2023-10-14 å°šæœªå®ç°ï¼Œç•¥ã€‚\nBaggage æ˜¯åœ¨ Span ä¹‹é—´ä¼ é€’çš„ Context ä¿¡æ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªé”®å€¼å¯¹å­˜ã€‚\nå‡è®¾å¸Œæœ›è¿½è¸ªä¸­çš„æ¯ä¸ªèŒƒå›´éƒ½æœ‰ä¸€ä¸ª CustomerID å±æ€§ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼Œä½†æ˜¯ CustomerID ä»…ä¸€é¡¹ç‰¹å®šæœåŠ¡å¯ç”¨ï¼Œä¸ºäº†å®ç°ç›®æ ‡ï¼Œå¯ä»¥ä½¿ç”¨ Baggage åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ä¼ æ’­æ­¤å€¼ã€‚\né€šå¸¸å°† è´¦å·æ ‡è¯†ï¼Œç”¨æˆ· IDï¼Œäº§å“ IDç­‰ç­‰å†…å®¹ï¼Œé™„åŠ åˆ°ä¸‹æ¸¸æœåŠ¡ä¸­çš„ Span ï¼Œä»¥ä¾¿äºæœç´¢æ—¶è¿‡æ»¤ã€‚\nå‚è€ƒ OpenTelemetry-Go Github\nGo è¯­è¨€å®ç°çš„ Otel æ–‡æ¡£\nOtel æ¦‚å¿µ\n","date":"2023-10-10T00:00:00Z","permalink":"https://blog.golang.space/p/opentelemetry/","title":"OpenTelemetry"},{"content":"ä»‹ç» NSQ æ˜¯ä¸€ä¸ªå®æ—¶åˆ†å¸ƒå¼æ¶ˆæ¯å¹³å°ã€‚\nç‰¹æ€§:\næ”¯æŒæ— å•ç‚¹æ•…éšœçš„åˆ†å¸ƒå¼æ‹“æ‰‘ æ°´å¹³å¯æ‰©å±• ä½å»¶è¿Ÿï¼Œé«˜æ€§èƒ½çš„æ¶ˆæ¯ä¼ é€’ è´Ÿè½½å‡è¡¡å’Œæ¶ˆæ¯å¤šæ’­è·¯ç”± æ“…é•¿æµå¼(é«˜åå)å¤„ç†å’Œé¢å‘ä½œä¸š(ä½åå)çš„å·¥ä½œè´Ÿè½½ ä¸»è¦åœ¨å†…å­˜ä¸­ï¼Œè¶…è¿‡é™åˆ¶å°†é€æ˜çš„ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚ æä¾›æ¶ˆè´¹è€…æŸ¥æ‰¾ç”Ÿäº§è€…çš„æœåŠ¡å‘ç° ç­‰ç­‰\u0026hellip; è¯´æ˜ NSQ ä¸»è¦æ˜¯å†…å­˜æ¶ˆæ¯ä¼ é€’å¹³å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯ä¼šåœ¨å†…å­˜ä¸­ï¼Œè¿™ä¹Ÿæ„å‘³ç€å½“æœåŠ¡å´©æºƒæ—¶ä¼šå‘ç”Ÿä¸¢å¤±ï¼Œå¯ä»¥é€šè¿‡ --mem-queue-size=0 æ¥æ§åˆ¶å°†æ¯æ¡æ¶ˆæ¯éƒ½æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸Šã€‚ æ¶ˆæ¯è‡³å°‘ä¼ é€’ä¸€æ¬¡ã€‚è¿™æ„å‘³ç€ç”±äºå„ç§åŸå› (è¶…æ—¶/æ–­å¼€è¿æ¥/é‡æ–°æ’é˜Ÿ)ï¼Œæ¶ˆæ¯å¯ä»¥å¤šæ¬¡ä¼ é€’ã€‚æ‰§è¡Œå¹‚ç­‰æ“ä½œæˆ–é‡å¤æ•°æ®åˆ é™¤æ˜¯ç”¨æˆ·çš„è´£ä»»ã€‚ æ”¶åˆ°æ¶ˆæ¯æ˜¯æ— åºçš„ï¼Œä¸èƒ½ä¾èµ–æ¶ˆæ¯çš„é¡ºåºã€‚ æ¶ˆè´¹è€…æœ€ç»ˆæ‰¾åˆ°æ‰€æœ‰ä¸»é¢˜ç”Ÿäº§è€…ï¼Œå‘ç°æœåŠ¡è¢«è®¾è®¡æœ€ç»ˆä¸€è‡´ã€‚ è®¾è®¡ å•ä¸ª nsqd å®ä¾‹æ”¯æŒåŒæ—¶å¤„ç†å¤šä¸ªæ•°æ®æµï¼Œæµç§°ä¸º \u0026ldquo;ä¸»é¢˜\u0026rdquo;ï¼Œä¸€ä¸ªä¸»é¢˜æœ‰1 ä¸ªæˆ–å¤šä¸ª\u0026quot;é€šé“\u0026quot;ï¼Œæ¯ä¸ªé€šé“éƒ½ä¼šä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯çš„å‰¯æœ¬ã€‚ä¸€ä¸ªé€šé“é€šå¸¸å¯ä»¥è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯ï¼Œå‡è®¾è¿™äº›å®¢æˆ·ç«¯éƒ½å¤„äºæ¥æ”¶æ¶ˆæ¯çŠ¶æ€ï¼Œåˆ™æ¶ˆæ¯ä¼šéšæœºä¼ é€’è¿‡å»ã€‚\né¦–æ¬¡å‘å¸ƒåˆ°æŒ‡å®šä¸»é¢˜æ—¶ï¼Œåˆ›å»ºä¸»é¢˜ï¼Œé¦–æ¬¡è®¢é˜…æŒ‡å®šä¸»é¢˜æ—¶ï¼Œåˆ›å»ºé€šé“ã€‚\nå†…éƒ¨è®¾è®¡ NSQ ç”± 3 ä¸ªå®ˆæŠ¤è¿›ç¨‹ç»„æˆ\nnsqdï¼Œæ¥æ”¶æ¶ˆæ¯ï¼Œæ’é˜Ÿæ¶ˆæ¯ï¼Œä¼ é€’æ¶ˆæ¯ç»™å®¢æˆ·ç«¯çš„è¿›ç¨‹ nsqlookupd ç®¡ç†æ‹“æ‰‘ä¿¡æ¯å¹¶æä¾›æœ€ç»ˆä¸€è‡´çš„æœåŠ¡å‘ç° nsqadminï¼Œæ˜¯ä¸€ä¸ª Web UIï¼Œç”¨äºå®æ—¶æ£€æŸ¥é›†ç¾¤ å‚è€ƒ NSQ å®˜æ–¹æ–‡æ¡£\n","date":"2023-09-10T00:00:00Z","permalink":"https://blog.golang.space/p/nsq/","title":"NSQ"},{"content":"å‡å° Go äºŒè¿›åˆ¶æ–‡ä»¶å¤§å° åœ¨æœªè¿›è¡Œä»»ä½•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œç”±æ­¤åˆ›å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶è¾ƒä¸ºåºå¤§ã€‚è¿™ä¼šæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œä¼ é€æµé‡ã€‚å› æ­¤ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œä¼˜åŒ–å¤„ç†ï¼Œä»¥å°½å¯èƒ½åœ°å‡å°å…¶ä½“ç§¯ï¼ŒåŒæ—¶ä¿è¯ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚\nä½¿ç”¨ go build æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ­¤æ—¶çš„å¤§å°æ˜¯ 19.1 MBï¼Œè¿™ä¹Ÿå¤ªå¤§äº†ã€‚\nä½¿ç”¨ go build --ldflags \u0026quot;-s -w\u0026quot; æ„å»ºï¼Œå‡å°‘äº† 5.7 MBã€‚\nç»è¿‡ä½¿ç”¨UPXè¿›è¡Œå‹ç¼©ï¼Œæ–‡ä»¶å¤§å°ä»19.1MBæˆåŠŸå‡å°è‡³5.4MBã€‚\næ€»ç»“ ä½¿ç”¨-ldflags=\u0026quot;-s -w\u0026quot;è¿›è¡Œé™æ€é“¾æ¥ä¼˜åŒ–ï¼Œè¿™å°†åˆ é™¤äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„è°ƒè¯•ä¿¡æ¯å’Œç¬¦å·è¡¨ï¼Œä»è€Œå‡å°äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ã€‚ ä½¿ç”¨ç±»ä¼¼äºupxçš„å·¥å…·è¿›è¡Œå‹ç¼©ï¼Œè¿›ä¸€æ­¥å‡å°äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ã€‚ å¦‚æœç¨‹åºä¸­åŒ…å«ç½‘é¡µï¼Œè¯·å°½å¯èƒ½é¿å…ä½¿ç”¨æ¡†æ¶ï¼Œè€Œåº”è¯¥ä½¿ç”¨åŸç”Ÿçš„HTML/CSS/JSæ¥å®Œæˆã€‚è‹¥ç½‘é¡µå¤§å°å¤§æ¦‚åªæœ‰å‡ ç™¾KBï¼Œåˆ™å¯ä»¥ç›´æ¥å°†å…¶åµŒå¥—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚ 1 2 # macbook ä½¿ç”¨ brew å®‰è£… upx brew install --build-from-source upx ","date":"2023-05-18T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%87%8F%E5%B0%8F-go-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F/","title":"å‡å° Go äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°"},{"content":"Go é¡¹ç›®çš„æ€è€ƒä¸æ¶æ„è®¾è®¡ è¯»å®Œã€ŠDomain-Driven Design with Golangã€‹è¿™æœ¬ä¹¦åï¼Œæˆ‘æœ‰äº†ä¸€äº›æ„Ÿæ‚Ÿã€‚\né¢†åŸŸé©±åŠ¨è®¾è®¡å¹¿æ³›åº”ç”¨äºè§£å†³å¤§å‹å¤æ‚é¡¹ç›®çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œå°† DDD åº”ç”¨äº CURD ç¨‹åºå¯èƒ½ä¼šè¿‡åº¦è®¾è®¡ï¼Œå¹¶ä¸”ä¼šä½¿äº¤ä»˜é€Ÿåº¦å˜ç¼“ä¸”æ›´åŠ ç¹çã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´æ›´å¤šä¸­å°å‹é¡¹ç›®å¿«é€Ÿè½åœ°çš„æƒ…æ™¯ï¼Œå› æ­¤éœ€è¦å¯»æ±‚å¼€å‘æ•ˆç‡å’Œæ¶æ„è®¾è®¡ä¹‹é—´çš„å¹³è¡¡ç‚¹ã€‚\nåŒæ—¶ï¼Œåœ¨ä¿è¯é«˜æ•ˆç‡å¼€å‘å’Œå¯æ‰©å±•æ€§çš„å‰æä¸‹ï¼Œåº”é¿å…è¿‡åº¦è®¾è®¡ï¼Œç¡®ä¿ä»£ç å…·æœ‰è‰¯å¥½çš„å¯è¯»æ€§ã€ç¨³å®šæ€§å’Œå¯æµ‹è¯•æ€§ã€‚\nå¦‚æœæ‚¨æƒ³æ·±å…¥äº†è§£é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼Œå¯ä»¥é˜…è¯»ç›¸å…³çš„ä¸“ä¸šä¹¦ç±ã€‚å¯¹æˆ‘è€Œè¨€ï¼Œå°†å…¶ä¸­çš„ä¼˜ç‚¹åº”ç”¨äºæˆ‘æ‰€é‡åˆ°çš„é¡¹ç›®ï¼Œä¸ä¼šå®Œå…¨æŒ‰ç…§DDDè§„èŒƒå»è®¾è®¡å’Œå¼€å‘ï¼Œæœ‰æ—¶å¯èƒ½è¿˜ä¼šé‡‡ç”¨åæ¨¡å¼ã€‚\nä»åˆ†å±‚æ¶æ„åˆ°åˆ†æ¨¡å‹æ¶æ„ é€šå¸¸ï¼Œç¼–å†™çš„åº”ç”¨ç¨‹åºä¸­æœ€å¤šçš„æ˜¯ CRUDã€‚åœ¨è¿™ç±»é¡¹ç›®ä¸­ï¼Œåˆ†å±‚æ¶æ„å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚æ— è®ºæ€æ ·å˜åŒ–ï¼Œå®ƒå¤§è‡´éƒ½è¢«åˆ†ä¸º API/Service/DAO ä¸‰å±‚ã€‚éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€å±‚å†…æœ‰ 20 æˆ– 30 ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”ä¸€ä¸ªç»“æ„ä½“çš„æ–¹æ³•å¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ã€‚å› æ­¤ï¼Œç»„ä»¶ä¹Ÿå¾ˆéš¾è¢«å¤ç”¨äºå…¶ä»–é¡¹ç›®ã€‚\né‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæ¶æ„è®¾è®¡éœ€è¦åˆ†å±‚å‘¢ï¼Ÿåˆ†å±‚æ¶æ„çš„ä¼˜ç‚¹åœ¨äºå…³æ³¨ç‚¹åˆ†ç¦»ã€åˆ†è€Œæ²»ä¹‹ã€ä½è€¦åˆå’Œé«˜å†…èšã€‚\nåŒæ ·å…·å¤‡è¿™äº›ä¼˜ç‚¹çš„æ˜¯åˆ†æ¨¡å‹æ¶æ„ï¼Œæ‰€è°“åˆ†æ¨¡å‹æ¶æ„ï¼ŒåŸºäºæ¨¡å‹é©±åŠ¨è®¾è®¡çš„æ€æƒ³ï¼Œå°†å¤æ‚ç³»ç»Ÿæ‹†åˆ†ä¸ºå‡ ä¸ªç›¸å…³çš„æ¨¡å‹ã€‚æ¯ä¸ªæ¨¡å‹å…·æœ‰ç‹¬ç«‹çš„èŒè´£ï¼Œå¹¶ä¸”è´Ÿè´£å¤„ç†ç‰¹å®šçš„åŠŸèƒ½ï¼Œè¿™ç§æ¶æ„éœ€è¦æ¶æ„å¸ˆå¯¹ä¸šåŠ¡é¢†åŸŸéå¸¸ç†Ÿæ‚‰ã€‚\nç›¸æ¯”åˆ†å±‚æ¶æ„ï¼Œå®ƒå¯¹è¡Œä¸ºä¸Šä¸‹æ–‡è¿›è¡Œäº†æ›´åŠ æ˜ç¡®çš„ç•Œé™ï¼Œä½¿å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºè‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚\né¢†åŸŸå°±åƒç§¯æœ¨ï¼Œæœ‰ç®€å•çš„åŸºå±‚å­åŸŸï¼Œä¹Ÿæœ‰ä¾èµ–å­åŸŸå®ç°çš„æ›´å¤æ‚é¢†åŸŸã€‚é¢†åŸŸå’Œå­åŸŸå‡ ä¹å¯ä»¥äº’æ¢ä½¿ç”¨ï¼Œè¿™å–å†³äºå¯¹è¯ä¸Šä¸‹æ–‡ã€‚\nè€ƒè™‘åˆ°å¹¶ä¸å®Œå…¨é‡‡ç”¨ DDDï¼Œä½†åŸºäºæ¨¡å‹é©±åŠ¨è®¾è®¡ï¼Œæ¥ä¸‹æ¥å°†ä»¥â€œDDD liteâ€çš„æ–¹å¼ç§°ä¹‹ï¼Œå›  DDD ä¸€è¯­åŒå…³ï¼ŒD å¯ä»¥æ˜¯ Domainï¼Œå¯ä»¥æ˜¯ Dataã€‚\nDDD lite Golang æœ‰è®¸å¤šè°šè¯­ï¼Œä¾‹å¦‚ ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚ éµå¾ªè¿™æ ·çš„è°šè¯­å¯ä»¥æé«˜ç¼–ç¨‹ä½“éªŒå’Œä»£ç è´¨é‡ã€‚\nä»¥ä¸‹æ˜¯ä¸ DDD lite ç›¸å…³çš„è°šè¯­ï¼Œè¿™äº›è°šè¯­ç”šè‡³æœ¬èº«å°±æ˜¯è®¾è®¡æ¨¡å¼ã€‚å®ƒå°†å¸®åŠ©æˆ‘ä»¬å®ç°æ›´å¥½çš„æ¶æ„è®¾è®¡ã€‚åœ¨è®¾è®¡æ—¶ï¼Œåº”è€ƒè™‘åˆ°æœªæ¥å¯èƒ½çš„éœ€æ±‚å˜åŒ–ï¼Œå…·å¤‡é«˜åº¦çš„å¯æ‰©å±•æ€§å’Œçµæ´»æ€§ï¼›è€Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåˆ™éœ€è¦æ ¹æ®å½“å‰çš„éœ€æ±‚å’Œé™åˆ¶ï¼Œæ³¨é‡å®ç°å’Œå¯ç»´æŠ¤æ€§ï¼Œä»¥è¾¾æˆäº¤ä»˜å¯é ä»£ç çš„ç›®æ ‡ã€‚\né€šç”¨è¯­è¨€ å›¢é˜Ÿåº”è¯¥ä½¿ç”¨ç»Ÿä¸€çš„æœ¯è¯­è¡¨ï¼Œè¿™æ ·åœ¨é’ˆå¯¹ä¸šåŠ¡çš„è®¨è®ºä¸­å°±å¯ä»¥æ›´åŠ ç²¾å‡†ï¼Œä¸ä¼šå‡ºç°è¯ä¸è¾¾æ„ã€ä¸¤ä¸ªäººè¯´çš„ä¸æ˜¯åŒä¸€ä»¶äº‹çš„æƒ…å†µã€‚\nå¼€å‘è€…åº”è¯¥åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™äº›æœ¯è¯­ã€å‡½æ•°åå’Œå˜é‡åï¼Œä¾‹å¦‚ç”¨â€œå®ç®±çš„å¼€å…³â€ä»£æ›¿â€œè®¾ç½®å±æ€§ä¸º trueâ€ã€‚\næœ‰äº›äººæ€ç»´æ•æ·ï¼Œå¯èƒ½ä¼šåœ¨ä¸Šä¸€ç§’è°ˆè®ºè¿™ä¸ªé—®é¢˜ï¼Œä¸‹ä¸€ç§’è°ˆè®ºå¦ä¸€ä¸ªé—®é¢˜ã€‚å¯¹äºç›¸ä¼¼è¡Œä¸ºçš„é¡µé¢ï¼Œä½¿ç”¨åŒä¸€æœ¯è¯­å¾ˆå®¹æ˜“é€ æˆè¯¯è§£ï¼Œç”šè‡³åœ¨æ²¡æœ‰å›¾ç‰‡çš„æƒ…å†µä¸‹å¾ˆéš¾ç†è§£å¯¹æ–¹åœ¨è¯´ä»€ä¹ˆã€‚\næ„å»ºä¸€ç§å¥å£®ã€æ— å¤„ä¸åœ¨çš„è¯­è¨€ï¼Œéœ€è¦èŠ±è´¹æ—¶é—´ï¼Œæ²¡æœ‰æ·å¾„å¯èµ°ã€‚åœ¨æ²Ÿé€šå’Œè®¾è®¡é˜¶æ®µï¼Œåº”è®°å½•ä»»ä½•æœ¯è¯­ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æœ¯è¯­è¡¨ä¸­ä¸å…¶ä»–åŒäº‹åˆ†äº«ã€‚\nå°½ç®¡å°è¯•åœ¨å¤šä¸ªé¡¹ç›®ã€å›¢é˜Ÿç”šè‡³æ•´ä¸ªå…¬å¸åº”ç”¨ä¸€ç§å…±é€šçš„è¯­è¨€å¯èƒ½å¾ˆè¯±äººï¼Œä½†è¿™æ ·åšä¼šå¯¼è‡´æœ¯è¯­å¤±å»ä¸¥è°¨æ€§ï¼Œå¯èƒ½ä¼šé€ æˆæ··ä¹±ã€‚å› æ­¤ï¼Œåº”è°¨æ…è€ƒè™‘å¹¶é€‰æ‹©æœ€é€‚åˆç‰¹å®šå›¢é˜Ÿå’Œé¡¹ç›®çš„å…±é€šæœ¯è¯­ã€‚\nä¾èµ–å€’ç½® ä»¥å­˜å‚¨åº“ä¸ºä¾‹ï¼Œæ ¸å¿ƒä¸šåŠ¡ä¾èµ–äºå…·ä½“å­˜å‚¨åº“çš„å®ç°ï¼Œåˆ™éœ€è¦è€ƒè™‘åˆ°éš¾ä»¥è¿›è¡Œæ‰©å±•ï¼Œä¾‹å¦‚ä» MySQL è¿ç§»åˆ° PostgreSQLã€‚\nä¸ºäº†æ–¹ä¾¿è§£è€¦å’Œæµ‹è¯•ï¼Œå¯ä»¥ä½¿æ ¸å¿ƒä¸šåŠ¡ä¸æ•°æ®åº“æ— å…³ï¼Œæ ¸å¿ƒä¸šåŠ¡ä¾èµ–æŠ½è±¡æ¥å£ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„ mockStore å³å¯è¿›è¡Œæµ‹è¯•ã€‚\nå†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå½“æ•°æ®åº“æˆä¸ºç“¶é¢ˆæ—¶ï¼Œå¯ä»¥å¼•å…¥ Redis ç¼“å­˜ã€‚ç”±äºæ ¸å¿ƒä¸šåŠ¡ä¾èµ–äºæŠ½è±¡æ¥å£ï¼Œå› æ­¤å¯ä»¥æ‰©å±•ç¼“å­˜å®ç°æ¥å£æ¥ä¼˜åŒ–æ€§èƒ½ã€‚\nå®æˆ˜ REST ful æˆ‘ä»¬æŒ‰ç…§ä»¥ä¸‹çš„æ–¹å¼ç»„ç»‡ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 . â”œâ”€â”€ config # é…ç½®ç›¸å…³ä»£ç  â”œâ”€â”€ config.toml # é…ç½®æ–‡ä»¶ â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ internal # é¡¹ç›®ä¸šåŠ¡ â”‚ â”œâ”€â”€ api â”‚ â”‚ â”œâ”€â”€ api.go â”‚ â”‚ â”œâ”€â”€ message.go â”‚ â”‚ â””â”€â”€ user.go â”‚ â””â”€â”€ core # æ ¸å¿ƒä¸šåŠ¡ â”‚ â”œâ”€â”€ message # æ¶ˆæ¯é¢†åŸŸ â”‚ â”‚ â”œâ”€â”€ message.go â”‚ â”‚ â”œâ”€â”€ model.go â”‚ â”‚ â””â”€â”€ store â”‚ â”‚ â””â”€â”€ messagedb â”‚ â”‚ â””â”€â”€ db.go â”‚ â””â”€â”€ user # ç”¨æˆ·é¢†åŸŸ â”‚ â”œâ”€â”€ model.go â”‚ â”œâ”€â”€ store â”‚ â”‚ â””â”€â”€ userdb â”‚ â”‚ â”œâ”€â”€ db.go â”‚ â”‚ â”œâ”€â”€ db_test.go â”‚ â”‚ â”œâ”€â”€ record.go â”‚ â”‚ â””â”€â”€ user.go â”‚ â”œâ”€â”€ user.go â”‚ â””â”€â”€ user_test.go â”œâ”€â”€ main.go â””â”€â”€ pkg # å·¥å…·åŒ… ä»£ç çš„ç»„ç»‡æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œè¿™ç§è¾ƒä¸ºç®€å•ï¼Œå¦‚æœæœ‰å¤šä¸ª main å‡½æ•°ï¼Œå³å¤šä¸ªç¨‹åºæ—¶ï¼Œå»ºè®®åˆ›å»º cmd æ–‡ä»¶å¤¹ï¼Œæˆ–æ›´æ”¹ç›®å½•ç»“æ„ä»¥ç¬¦åˆæœ€é€‚åˆä¸šåŠ¡çš„æ–¹å¼ã€‚\ninternal æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç›®å½•ï¼Œå®ƒå°†é™åˆ¶åŒ…çš„å¯¼å…¥èŒƒå›´ï¼Œæˆ‘ä»¬å°†ä¸šåŠ¡æ‰€éœ€å…¨éƒ¨æ”¾åœ¨è¯¥ç›®å½•ä¸‹ã€‚\nåº•ä¸‹åŒ…å«ä¸¤ä¸ªä¸»è¦ç›®å½•ï¼Œapi å’Œ coreã€‚\napi æ˜¯ REST ful Web çš„å…·ä½“å®ç°ã€‚ core æ˜¯æ ¸å¿ƒä¸šåŠ¡ï¼ŒåŒ…å«çš„æ¯ä¸ªæ–‡ä»¶å¤¹å³æ˜¯ä¸€ä¸ªé¢†åŸŸã€‚ store æ˜¯æ•°æ®å­˜å‚¨ï¼Œä½¿ç”¨ä¾èµ–å€’ç½®åŸåˆ™ï¼Œé¢†åŸŸè¡Œä¸ºä¾èµ–äºæŠ½è±¡æ¥å£ï¼Œå­˜å‚¨åº“ä¾èµ–äºé¢†åŸŸæ¨¡å‹ã€‚ é¢†åŸŸæ¨¡å‹ä¸æ•°æ®åº“æ¨¡å‹å¦‚æœæ‹†åˆ†ï¼Œå°†éœ€è¦å†™è®¸å¤šè½¬æ¢å‡½æ•°ï¼Œé€šè¿‡ä¾èµ–å€’ç½®åŸåˆ™ï¼Œstore ç›´æ¥ä¾èµ–é¢†åŸŸæ¨¡å‹ã€‚\næ¥ä¸‹æ¥ä¼šæ¶‰åŠ Go ä»£ç ï¼Œå†™è¿™ç¯‡æ–‡ç« æ—¶ï¼Œæˆ‘çš„å®‰è£…çš„ç‰ˆæœ¬æ˜¯ Go1.20.3ã€‚\næ¡ˆä¾‹: æŸ¥è¯¢ä¸¤ä¸ªç”¨æˆ·å¯¹è¯çš„å†å²æ¶ˆæ¯ã€‚\nåœ¨ [core] - [message] æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ›å»º model.go æ–‡ä»¶ï¼Œå†™å…¥æ¨¡å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 type Message struct { orm.Model SenderID int `gorm:\u0026#34;notNull;default:0;index;comment:å‘é€è€…\u0026#34;` ReceiverID int `gorm:\u0026#34;notNull;default:0;index;comment:æ¥æ”¶è€…\u0026#34;` Type string `gorm:\u0026#34;type:text;notNull;default:\u0026#39;\u0026#39;;comment:ç±»å‹\u0026#34;` SessionID int `gorm:\u0026#34;notNull;default:0;index;comment:ä¼šè¯id\u0026#34;` Content []byte `gorm:\u0026#34;type:bytea; notNull; comment:æ¶ˆæ¯\u0026#34;` } func (*Message) TableName() string { return \u0026#34;messages\u0026#34; } åœ¨ [core]-[message] æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ›å»º message.go æ–‡ä»¶ï¼Œå†™å…¥è¡Œä¸ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // æ•°æ®å­˜å‚¨æŠ½è±¡ type Storer interface{ InsertOne(b orm.Tabler) error FindMessages(ms []Message, uid,sessionID,limit int) } type Core struct{ ctx context.Context // æˆ‘éå¸¸ç¡®å®šï¼Œæ•´ä¸ªé¡¹ç›®å‘¨æœŸä¸ä¼šæ›´æ¢æ—¥å¿—ç»„ä»¶ï¼Œè¿™é‡Œç›´æ¥ä¾èµ–å®ç° Log *zap.SugaredLogger // æ•°æ®äº¤äº’ store Storer } // ä½¿ç”¨å€¼å¯¹è±¡çš„ä¼˜åŠ¿æ˜¯ä¸ç”¨æ‹…å¿ƒå‰¯ä½œç”¨ func NewCore(log *zap.SugaredLogger, store Storer) Core { return Core { ctx: context.Background(), Log: log, store: store, } } // æ¯æ¬¡è®¿é—®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ with åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ // æ‹¥æœ‰å½“å‰è®¿é—®çš„ä¸‹ä¸Šæ–‡ï¼Œä»¥åŠè®°å½•è¿½è¸ª ID çš„æ—¥å¿— // é€šè¿‡æ—¥å¿—è¿½è¸ªï¼Œå¯ä»¥è¯¦ç»†äº†è§£ç”¨æˆ·çš„æ“ä½œè¡Œä¸º func (c Core) With(ctx context.Context, log *zap.SugaredLogger) Core { c.ctx = ctx c.Log = log return c } func (c Core) FindMessages(ms *[]*Message, uid,sessionID,limit int) error { if uid == 0 { return fmt.Errorf(\u0026#34;uid ä¸èƒ½ä¸ºç©º\u0026#34;) } return c.store.FindMessages( ms, uid, sessionID, limit, ) } åœ¨ [api]-[message.go] æ–‡ä»¶ä¸­å®ç° REST ful\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 type Message struct{ core message.Core } func messageAPI(g *gin.Engine, cfg Config) error { store := messagedb.NewDB(cfg.DB) if err := store.AutoMigrate();err!=nil { return err } core := message.NewCore(zap.S(), store) m := Message{core:core} chat := g.Group(\u0026#34;/chat\u0026#34;, mid.AuthMiddleware(cfg.JWTSecret)) chat.Get(\u0026#34;/messages\u0026#34;, m.FindMessages) } func (m Message) FindMessages(ctx *gin.Context) { core := m.core.With( ctx.Request.Context(), m.core.Log.With(\u0026#34;traceid\u0026#34;, mid.TraceID(ctx)) ) var input struct { SessionID int `form:\u0026#34;session_id\u0026#34;` } if err:=ctx.ShouldBindQuery(\u0026amp;input);err!=nil{ web.Fail(ctx, err) return } // .... } å®æˆ˜ gRPC æœªå®Œç»“ï¼Œæ¬²çŸ¥åäº‹å¦‚ä½•ï¼Œè¯·å¬ä¸‹å›åˆ†è§£ã€‚\n","date":"2023-05-15T00:00:00Z","permalink":"https://blog.golang.space/p/go-%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%80%9D%E8%80%83%E4%B8%8E%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/","title":"Go é¡¹ç›®çš„æ€è€ƒä¸æ¶æ„è®¾è®¡"},{"content":"ChatGPT ç¼–å†™æ˜ç¡®å’Œå…·ä½“çš„æŒ‡ä»¤ã€‚ ä½¿ç”¨åˆ†éš”ç¬¦æ¸…æ¥šåœ°æŒ‡ç¤ºè¾“å…¥çš„ä¸åŒéƒ¨åˆ†ã€‚\nä½¿æ¨¡å‹æ¸…æ¥šçš„çŸ¥é“ï¼Œè¿™æ˜¯ç‹¬ç«‹çš„éƒ¨åˆ†ã€‚å°±åƒæ˜¯äººç‰©è¯´è¯çš„å†…å®¹æ”¾åœ¨åŒå¼•å·å†…ã€‚\nè¿™å¯ä»¥é¿å…é€ æˆæ­§ä¹‰ï¼Œä¾‹å¦‚æŸäº›æ–‡å­—å¹¶ä¸æ˜¯å¯¹ gpt çš„æŒ‡ä»¤ã€‚\nä¸‰å¼•å· ä¸‰ä¸ªåå¼•å· ä¸‰ä¸ªç ´æŠ˜å· å°–æ‹¬å· è¦æ±‚ç»“æ„åŒ–è¾“å‡º\nå¯ä»¥è¯·æ±‚ HTML æˆ– JSON è¾“å‡ºã€‚\nProvide them in JSON format with the following keys: title,author\nåˆ†æ­¥éª¤æ‰§è¡Œä»»åŠ¡\n**ç»™å‡ºæ˜ç¡®è€Œå…·ä½“çš„æŒ‡ç¤ºï¼Œå‡ºç¤ºç»“æœæ¨¡æ¿\n1 2 3 ä½ çš„ä»»åŠ¡æ˜¯ä»¥ä¸€è‡´çš„é£æ ¼å›ç­”é—®é¢˜ã€‚ \u0026lt;child\u0026gt;:.... \u0026lt;grandparent\u0026gt;:.... ç»™æ¨¡å‹æ—¶é—´å»æ€è€ƒï¼Œå› çŠ¯äº†æ¨ç†é”™è¯¯ï¼Œåœ¨æ¨¡å‹æä¾›æœ€ç»ˆç­”æ¡ˆå‰è¯·æ±‚ä¸€ç³»åˆ—ç›¸å…³çš„æ¨ç† å¦‚æœç»™æ¨¡å‹ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡å¤ªå¤æ‚äº†ï¼Œå®ƒä¸èƒ½åœ¨çŸ­æ—¶é—´å†…æˆ–ç”¨å°‘é‡çš„å•è¯å®Œæˆï¼Œå®ƒå¯èƒ½ä¼šåšå‡ºä¸€ä¸ªå¯èƒ½ä¸æ­£ç¡®çš„çŒœæµ‹ã€‚\nå› æ­¤ï¼Œå¯ä»¥æŒ‡ç¤ºæ¨¡å‹æ›´é•¿æ—¶é—´åœ°æ€è€ƒé—®é¢˜ã€‚\nå°±åƒå’Œä¼™ä¼´äº¤æµé‚£æ ·ï¼Œä¹Ÿå¯ä»¥ç»™å‡ºè‡ªå·±æ¨ç†çš„è§£å†³æ–¹æ¡ˆä¾›æ¨¡å‹å‚è€ƒï¼Œè¿™æ ·æ¨¡å‹ä¼šç»™å‡ºæ›´æ¥è¿‘æ­£ç¡®çš„ç­”å¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ä½ çš„è®¤ä¸ºæ˜¯ç¡®å®šå­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆæ˜¯å¦æ­£ç¡®ã€‚è¦è§£å†³é—®é¢˜ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œ: - é¦–å…ˆåˆ¶å®šå‡ºè‡ªå·±çš„è§£å†³æ€è·¯ã€‚ - ç„¶åå°†è‡ªå·±çš„è§£é¢˜æ€è·¯ä¸å­¦ç”Ÿè§£é¢˜æ€è·¯è¿›è¡Œå¯¹æ¯”ï¼Œè¯„ä¼°å­¦ç”Ÿè§£é¢˜æ€è·¯æ­£ç¡®ä¸å¦ã€‚åœ¨ä½ è‡ªå·±åšé¢˜ä¹‹å‰ï¼Œä¸è¦å†³å®šå­¦ç”Ÿçš„ç­”æ¡ˆæ˜¯å¦æ­£ç¡®ã€‚ ä½¿ç”¨ä»¥ä¸‹æ ¼å¼: é—®é¢˜: \u0026lt;é—®é¢˜\u0026gt; å­¦ç”Ÿ: \u0026lt;å­¦ç”Ÿçš„è§£é¢˜æ€è·¯\u0026gt; å‚è€ƒç­”æ¡ˆ: \u0026lt;æ­£ç¡®çš„è§£é¢˜æ€è·¯åŠæ­¥éª¤\u0026gt; ç»“æœ: \u0026lt;å¦‚æœå­¦ç”Ÿçš„è§£é¢˜æ€è·¯æ˜¯æ­£ç¡®çš„ï¼Œæ­¤å¤„å†™ YESï¼Œå¦åˆ™å†™ NO\u0026gt; é—®é¢˜: ``` 13-8=? ``` å­¦ç”Ÿçš„è§£é¢˜æ€è·¯: ``` 13-(3+5)=13-3-5=10-5=5ï¼Œç»“æœä¸º 5 ``` æ¨¡å‹çš„é™åˆ¶ å°½ç®¡è¯­è¨€æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ¥è§¦äº†å¤§é‡çŸ¥è¯†ï¼Œä½†å®ƒå¹¶æ²¡æœ‰å®Œç¾çš„è®°ä½å®ƒæ‰€çœ‹åˆ°çš„ä¿¡æ¯ã€‚æ¨¡å‹å¯¹äºæ™¦æ¶©éš¾æ‡‚çš„é—®é¢˜é€šå¸¸ä¼šç»™å‡ºæé€ çš„æƒ³æ³•ï¼Œé€šå¸¸æˆä¸ºæ¨¡å‹çš„å¹»è§‰ã€‚\nå‡å°‘å¹»è§‰çš„ç­–ç•¥æ˜¯ä½¿ç”¨ä»¥ä¸Šå»ºè®®çš„æ–¹æ³•ï¼Œå¦ä¸€ä¸ªç­–ç•¥æ˜¯è¦æ±‚æ¨¡å‹é¦–å…ˆä»æ–‡æœ¬ä¸­æ‰¾åˆ°ç›¸å…³çš„å†…å®¹ã€‚ç„¶åè¦æ±‚å®ƒä½¿ç”¨è¿™äº›å¼•ç”¨å†…å®¹æ¥å›ç­”é—®é¢˜ã€‚\nå°†ç­”æ¡ˆè¿½æº¯åˆ°æºæ–‡æ¡£çš„æ–¹æ³•é€šå¸¸å¯¹å‡å°‘æ¨¡å‹å¹»è§‰å¾ˆæœ‰å¸®åŠ©ã€‚\nå‚è€ƒ ChatGPT æç¤ºå·¥ç¨‹å¸ˆ\n","date":"2023-05-09T00:00:00Z","permalink":"https://blog.golang.space/p/chatgpt-%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E6%8F%90%E7%A4%BA%E8%AF%8D/","title":"ChatGPT å¦‚ä½•å†™å¥½æç¤ºè¯?"},{"content":"é€‚é…å™¨æ¨¡å¼ é€‚é…å™¨æ¨¡å¼æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå…¶å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå¦ä¸€ä¸ªæŒ‡å®šçš„æ¥å£ï¼Œä»¥å®ç°åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œæ— æ³•ååŒå·¥ä½œçš„ç±»ä¹‹é—´çš„ååŒå·¥ä½œã€‚\né€šå¸¸ï¼Œåœ¨å®ŒæˆæŸäº›ä»»åŠ¡æ—¶éœ€è¦ä¸å…¶ä»–ç¨‹åºè¿›è¡Œé€šä¿¡ï¼Œå¦‚è®¿é—®æ•°æ®åº“ã€è®¿é—®å¼€å‘æ¥å£ã€ç¬¬ä¸‰æ–¹æˆæƒç™»å½•æˆ–çŸ­ä¿¡é€šçŸ¥ç­‰ã€‚\nä»£ç ä¸­ä»»ä½•å¤–éƒ¨ä¾èµ–æ€§éƒ½ä¼šå¸¦æ¥è®¾è®¡å’Œæµ‹è¯•æ–¹é¢çš„é—®é¢˜ã€‚æ­¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼ŒåŒæ—¶è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚\nç®€å•åœ°è¯´ï¼Œå¦‚æœç¨‹åºéœ€è¦æ¥å…¥ MySQLã€PostgreSQLã€SQLite ç­‰æ•°æ®åº“ï¼Œç›´æ¥é’ˆå¯¹æ¯ç§æ•°æ®åº“ç¼–å†™ CURD æ“ä½œå°†å¯¼è‡´è®¾è®¡éš¾åº¦åŠ å¤§ï¼Œä¸ä¾¿äºæµ‹è¯•ã€‚ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œåˆ™åªéœ€äº†è§£å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œå…·ä½“å®ç°ç”±åŒ…å«ä¾èµ–å…³ç³»çš„ç»„ä»¶è´Ÿè´£å®ç°ã€‚\nå°†ç‰¹å®šäºä¾èµ–å…³ç³»çš„å†…å®¹å°è£…åœ¨ä¸€ä¸ªç»„ä»¶ä¸­ï¼Œè¿›è¡Œæ ¸å¿ƒæµç¨‹æµ‹è¯•æ—¶ï¼Œå¯æ›¿æ¢ä¸º mock ç»„ä»¶ï¼Œæ¨¡æ‹Ÿå®Œæˆä¾èµ–å¯¹è±¡çš„æ“ä½œã€‚\nä»£ç ç¤ºä¾‹ åœºæ™¯ ç›®å‰ï¼Œè¯¥ç¨‹åºå·²æ¥å…¥å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½ï¼Œç°æ¬²åŠ å…¥ PayPal æ”¯ä»˜åŠŸèƒ½ã€‚\n1 2 3 4 5 6 // å¾®ä¿¡æ”¯ä»˜ type WeChatPay struct{} func (w *WeChatPay) Pay(money int64) { fmt.Println(\u0026#34;å¾®ä¿¡æ”¯ä»˜\u0026#34;) } 1 2 3 4 5 6 7 type Payer struct{ Pay(int64) } func main(){ var payer Payer = new(WeChatPay) payer.Pay() } 1 2 3 4 5 6 // ç­‰å¾…æ¥å…¥çš„ PayPal æ”¯ä»˜ type PayPal struct{} func (w *PayPal) Consume(money float64,message string){ fmt.Println(\u0026#34;PayPal æ”¯ä»˜\u0026#34;) } ä¸ä½¿ç”¨è®¾è®¡æ¨¡å¼ å°†ä¼šåœ¨ä»£ç å—é‡Œï¼Œç›´æ¥ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼Œæ²¡æœ‰è§£è€¦ï¼Œéš¾ä»¥æµ‹è¯•ï¼Œåˆ‡ä»£ç å—è¯»èµ·æ¥å¤æ‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 func main(){ payType := \u0026#34;PayPal\u0026#34; switch payType{ case \u0026#34;PayPal\u0026#34;: var payer Payer = new(WeChatPay) payer.Pay(12) case \u0026#34;Wechat\u0026#34;: pp := new(PayPal) pp.Consume(12.0, \u0026#34;è´­ä¹°ä¼šå‘˜\u0026#34;) default: fmt.Println(\u0026#34;ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼\u0026#34;) } } ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ å½“ PayPal çš„æ”¯ä»˜ç»„ä»¶ç”±åˆ«äººæä¾›æ—¶ï¼Œä¸èƒ½ä¿®æ”¹ä»£ç ã€‚æ­¤æ—¶ç”±æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªé€‚é…å™¨å®ç°æ¥å£ï¼Œå†…éƒ¨å®ç°è°ƒç”¨ PayPalã€‚\n1 2 3 4 5 6 7 8 // å®šä¹‰ PayPal å¯¹ Payer çš„é€‚é…å™¨ type PayPalAdopter struct{ payPal *PayPal } func (p *PayPalAdopter) Pay(money int64) { p.payPal.Consume(float64(money),\u0026#34;è´­ä¹°ä¼šå‘˜\u0026#34;) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func main() { payType := \u0026#34;PayPal\u0026#34; var payer Payer switch payType{ case \u0026#34;PayPal\u0026#34;: payer = new(WeChatPay) case \u0026#34;Wechat\u0026#34;: payer = new(PayPalAdopter{ new(PayPal)}) default: fmt.Println(\u0026#34;ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼\u0026#34;) } payer.Pay(12) } é€šè¿‡ä»¥ä¸Šçš„æ–¹å¼ä½¿æµ‹è¯•æ›´å®¹æ˜“ï¼Œå› ä¸ºå®ƒæ›´å®¹æ˜“æ¨ç†ï¼Œä¸å¿…æ‹…å¿ƒä¸¤ä¸ªä¸åŒä¸”ä¸ç›¸å…³çš„è¡Œä¸ºä¼šäº’ç›¸å¹²æ‰°ã€‚\nå…¶ä»–ç»“æ„å‹æ¨¡å¼ é€‚é…å™¨æ¨¡å¼é€šå¸¸åœ¨å·²æœ‰ç¨‹åºä¸­ä½¿ç”¨ï¼Œè®©äº’ç›¸ä¸å…¼å®¹çš„ç±»å‹å¥½åˆä½œï¼Œå…ˆæœ‰ä¸¤ç«¯çš„ä¸œè¥¿ï¼Œæ‰æœ‰é€‚é…å™¨ã€‚æ¡¥æ¥æ¨¡å¼ï¼Œé€šå¸¸å¼€å‘å‰æœŸè¿›è¡Œè®¾è®¡ï¼Œä½¿å„ä¸ªéƒ¨åˆ†ç‹¬ç«‹å¼€å‘ä¾¿äºå¼€å‘ï¼Œå…ˆæœ‰æ¡¥æ‰æœ‰ä¸¤ç«¯çš„ä¸œè¥¿ã€‚ å‚è€ƒ The adapter pattern in Go\né€‚é…å™¨æ¨¡å¼\n","date":"2023-05-03T00:00:00Z","permalink":"https://blog.golang.space/p/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/","title":"é€‚é…å™¨æ¨¡å¼"},{"content":"HTTP è¯»å†™è¶…æ—¶ æœåŠ¡ç«¯è¶…æ—¶\nå¯¹äºæš´éœ²åœ¨äº’è”ç½‘ä¸Šçš„ HTTP æœåŠ¡å™¨æ¥è¯´ï¼Œå¼ºåˆ¶å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶éå¸¸é‡è¦ã€‚\néå¸¸æ…¢æˆ–æ¶ˆæ¯çš„å®¢æˆ·ç«¯å¯èƒ½ä¼šå¯¼è‡´æ–‡ä»¶æè¿°ç¬¦æ³„éœ²ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯:\n1 http: Accept error: accept tcp [::]:80: accept4: too many open files; retrying in 5ms ReadTimeout æ¶µç›–ä»æ¥å—è¿æ¥åˆ°å®Œå…¨è¯»å–è¯·æ±‚æ­£æ–‡ï¼ˆå¦‚æœæ‚¨ç¡®å®è¯»å–äº†æ­£æ–‡ï¼Œå¦åˆ™åˆ°æ ‡å¤´æœ«å°¾ï¼‰çš„æ—¶é—´ã€‚å®ƒæ˜¯é€šè¿‡åœ¨ Accept ä¹‹åç«‹å³è°ƒç”¨ SetReadDeadline åœ¨ net/http ä¸­å®ç°çš„ã€‚\nWriteTimeout é€šå¸¸é€šè¿‡åœ¨ readRequest æœ«å°¾è°ƒç”¨ SetWriteDeadline æ¥è¦†ç›–ä»è¯·æ±‚æ ‡å¤´è¯»å–ç»“æŸåˆ°å“åº”å†™å…¥ç»“æŸçš„æ—¶é—´ï¼ˆä¹Ÿç§°ä¸º ServeHTTP çš„ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚\nhttp.TimeoutHandler ã€‚å®ƒä¸æ˜¯æœåŠ¡å™¨å‚æ•°ï¼Œè€Œæ˜¯é™åˆ¶ ServeHTTP è°ƒç”¨æœ€å¤§æŒç»­æ—¶é—´çš„ Handler åŒ…è£…å™¨ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ç¼“å†²å“åº”ï¼Œå¹¶åœ¨è¶…è¿‡æˆªæ­¢æ—¶é—´æ—¶å‘é€ 504 ç½‘å…³è¶…æ—¶ã€‚\nå®¢æˆ·ç«¯è¶…æ—¶\næœ€å®¹æ˜“ä½¿ç”¨çš„æ˜¯ http.Client çš„ Timeout å­—æ®µã€‚å®ƒæ¶µç›–äº†æ•´ä¸ªæµç¨‹ã€‚\nhttp.Get ç­‰åŒ…çº§å‡½æ•°ä½¿ç”¨æ²¡æœ‰è¶…æ—¶çš„å®¢æˆ·ç«¯ï¼Œå› æ­¤åœ¨å¼€æ”¾çš„ Internet ä¸Šä½¿ç”¨æ˜¯å±é™©çš„ã€‚\nnet.Dialer.Timeout é™åˆ¶å»ºç«‹ TCP è¿æ¥æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆå¦‚æœéœ€è¦æ–°è¿æ¥ï¼‰ http.Transport.TLSHandshakeTimeout é™åˆ¶æ‰§è¡Œ TLS æ¡æ‰‹æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚ http.Transport.ResponseHeaderTimeout é™åˆ¶è¯»å–å“åº”æ ‡å¤´æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚ 1 2 3 4 5 6 http.Server{ Addr: defaultAddr, Handler: handler, ReadTimeout: defaultReadTimeout, WriteTimeout: defaultWriteTimeout, } å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œå¯ä»¥ä½¿ç”¨ http.Server å®šä¹‰è¯»å†™è¶…æ—¶æ—¶é—´ï¼Œé€šå¸¸åœ¨ 5~30 ç§’ä¹‹é—´ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢åº”ç”¨ç¨‹åºæ— é™æœŸåœ°é˜»å¡åœ¨HTTPå“åº”çš„è¯»å–æˆ–å†™å…¥æ“ä½œä¸Šï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå¤±å»å“åº”å¹¶å½±å“æ•´ä½“æ€§èƒ½ã€‚\nReadTimeout æ˜¯ä» accept åˆ° request.Body è¢«å®Œå…¨è¯»å–çš„æ—¶é—´ï¼Œå¦‚æœä¸è¯» body åˆ™æ—¶é—´æˆªæ­¢åˆ°è¯»å®Œ header ä¸ºæ­¢ã€‚\nWriteTimeout æ˜¯ä» request header çš„è¯»å–ç»“æŸå¼€å§‹ï¼Œåˆ° response write ç»“æŸä¸ºæ­¢ã€‚\nä½¿ç”¨ä»¥ä¸Šå®šä¹‰çš„ä»£ç ï¼Œåœ¨ä¸Šä¼ æ–‡ä»¶åŠŸèƒ½ä¸­ï¼Œå¦‚æœæ–‡ä»¶çš„å¤§å°ä¸ç¡®å®šï¼Œå¤§æ–‡ä»¶è¯»å–ç”¨æ—¶è¶…è¿‡é¢„å®šä¹‰çš„ ReadTimeoutï¼Œåˆ™ä¼šå‡ºç°è¶…æ—¶é”™è¯¯ï¼Œç±»ä¼¼äº read tcp [::1]:1133-\u0026gt;[::1]:57471: i/o timeoutã€‚\nåœ¨ Go 1.20 ä¸­æ–°å¢åŠ äº† http.ResponseController ç±»å‹ï¼Œä½¿ç”¨è¯¥åŒ…å¯ä»¥å•ç‹¬æ§åˆ¶æ¯ä¸ª Handler çš„è¯»å†™è¶…æ—¶æ—¶é—´ã€‚\nå‚è€ƒ Github issue net/http: ResponseController to manipulate per-request timeouts (and other behaviors) #54136ã€‚\nå®ƒæœ‰ä»¥ä¸‹ä¼˜ç‚¹:\næ ¹æ®æ¯ä¸ªè¯·æ±‚è®¾ç½®è¯»å†™è¶…æ—¶æ—¶é—´ã€‚ http.Flusher å’Œ http.Hijacker ä½¿ç”¨æ›´è½»æ¾ã€‚ ä½¿åˆ›å»ºå’Œä½¿ç”¨è‡ªå®šä¹‰çš„ http.ResponseWrite å®ç°å˜å¾—æ›´å®¹æ˜“å’Œæ›´å®‰å…¨ã€‚ ä½¿ç”¨ 1 2 3 4 5 func ServeHTTPx(w http.ResponseWriter, req *http.Request) { rc := http.NewResponseController(w) _ = rc.SetReadDeadline(time.Now().Add(30 * time.Second)) _ = rc.SetWriteDeadline(time.Now().Add(30 * time.Second)) } å‚è€ƒ http timeouts\n","date":"2023-05-01T00:00:00Z","permalink":"https://blog.golang.space/p/http-%E8%AF%BB%E5%86%99%E8%B6%85%E6%97%B6/","title":"HTTP è¯»å†™è¶…æ—¶"},{"content":"HTTP SSE SSE æŒ‡çš„æ˜¯ Server-sent eventsï¼Œä½¿ç”¨æœåŠ¡å™¨å‘é€äº‹ä»¶ã€‚\nåœ¨ Go æœåŠ¡ç«¯è®¾ç½®å“åº”å¤´ä¿¡æ¯ã€‚\n1 2 3 w.Header().Set(\u0026#34;Content-Type\u0026#34;, \u0026#34;text/event-stream\u0026#34;) w.Header().Set(\u0026#34;Cache-Control\u0026#34;, \u0026#34;no-cache\u0026#34;) w.Header().Set(\u0026#34;Connection\u0026#34;, \u0026#34;keep-alive\u0026#34;) å®¢æˆ·ç«¯ä»£ç ç±»ä¼¼è¿™æ ·\n1 2 3 4 5 6 7 8 const evtSource = new EventSource(\u0026#34;/ssedemo\u0026#34;); // ç›‘å¬äº‹ä»¶ evtSource.onmessage = function(event) { const newElement = document.createElement(\u0026#34;li\u0026#34;); const eventList = document.getElementById(\u0026#34;list\u0026#34;); newElement.innerHTML = \u0026#34;message: \u0026#34; + event.data; eventList.appendChild(newElement); } HTTP æµå¼ä¼ è¾“ Transfer-Encoding å‡ºç°åœ¨ HTTP Response Header ä¸­ã€‚\nè¯¥æ¶ˆæ¯æŒ‡æ˜å°†æ¶ˆæ¯ä½“ä¼ é€’ç»™è¯·æ±‚ç«¯çš„ç¼–ç å½¢å¼ã€‚\n1 2 3 4 5 6 7 8 9 # è¯­æ³• Transfer-Encoding: chunked Transfer-Encoding: compress Transfer-Encoding: deflate Transfer-Encoding: gzip Transfer-Encoding: identity // å¯ä»¥å¤šä¸ªå€¼ï¼Œä»¥é€—å·éš”å¼€ Transfer-Encoding: gzip, chunked chunked æŒ‡æ•°æ®ä»¥ä¸€ç³»åˆ—åˆ†å—çš„å½¢å¼è¿›è¡Œå‘é€ï¼ŒContent-Length åœ¨è¿™ç§æƒ…å†µä¸‹ä¸è¢«å‘é€ï¼Œåœ¨æ¯ä¸€ä¸ªåˆ†å—çš„å¼€å¤´éœ€è¦æ·»åŠ å½“å‰åˆ†å—çš„é•¿åº¦ï¼Œä»¥åå…­è¿›åˆ¶çš„å½¢å¼è¡¨ç¤ºï¼Œåé¢ç´§è·Ÿç€ \u0026lsquo;\\r\\n\u0026rsquo;ã€‚\nåˆ†å—çš„åº”ç”¨åœºæ™¯æ˜¯è¦ä¼ è¾“å¤§é‡çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨è¯·æ±‚æ²¡æœ‰è¢«å¤„ç†å®Œä¹‹å‰å“åº”çš„é•¿åº¦æ˜¯æ— æ³•è·å¾—çš„ã€‚\næ¥ä¸‹æ¥æ¼”ç¤ºä¸€ä¸ª demoï¼Œå‡è®¾å®¢æˆ·ç«¯æœ‰ä¸€ä¸ªè¿›åº¦æ¡ï¼Œå‘ç”¨æˆ·å‘ŠçŸ¥æœåŠ¡ç«¯å¤„ç†è¿›åº¦ã€‚\nç½‘é¡µæ•ˆæœå±•ç¤º\næœåŠ¡ç«¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;io\u0026#34; \u0026#34;math/rand\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) // æµå¼ä¼ è¾“ func main() { http.HandleFunc(\u0026#34;/aaa\u0026#34;, func(w http.ResponseWriter, r *http.Request) { w.WriteHeader(200) w.Header().Set(\u0026#34;Transfer-Encoding\u0026#34;, \u0026#34;chunked\u0026#34;) w.Header().Set(\u0026#34;Content-Type\u0026#34;, \u0026#34;text/plain\u0026#34;) ch := make(chan Resp, 10) defer close(ch) go func() { // æ­¤å¤„ defer... recover()... tick := time.NewTicker(40 * time.Millisecond) defer tick.Stop() var zeroValue Resp var last *Resp fn := func(v Resp, w io.Writer) error { b, _ := json.Marshal(v) if _, err := w.Write(b); err != nil { return err } w.(http.Flusher).Flush() return nil } for { select { case \u0026lt;-tick.C: if last != nil { _ = fn(*last, w) last = nil } case v := \u0026lt;-ch: if v != zeroValue { last = \u0026amp;v continue } if last != nil { _ = fn(*last, w) } return } } }() var resp Resp resp.All = 300 ok := rand.Intn(10) == 5 for i := 0; i \u0026lt;= resp.All; i++ { time.Sleep(10 * time.Millisecond) fmt.Println(i) if ok { resp.Err = fmt.Errorf(\u0026#34;err\u0026#34;).Error() } resp.CUR = i ch \u0026lt;- resp if ok { break } } time.Sleep(30 * time.Second) }) http.Handle(\u0026#34;/\u0026#34;, http.FileServer(http.Dir(\u0026#34;./\u0026#34;))) // å±•ç¤ºç½‘é¡µ _ = http.ListenAndServe(\u0026#34;:8888\u0026#34;, nil) } type Resp struct { All int `json:\u0026#34;all\u0026#34;` CUR int `json:\u0026#34;cur\u0026#34;` Err string `json:\u0026#34;err\u0026#34;` } ç½‘é¡µç«¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34; /\u0026gt; \u0026lt;meta http-equiv=\u0026#34;X-UA-Compatible\u0026#34; content=\u0026#34;IE=edge\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;test\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;p\u0026gt;response\u0026lt;/p\u0026gt; \u0026lt;h1 id=\u0026#34;output\u0026#34;\u0026gt;...\u0026lt;/h1\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;script\u0026gt; // å‚è€ƒ: https://web.dev/i18n/zh/fetch-upload-streaming/ const { readable, writable } = new TransformStream(); document.addEventListener(\u0026#34;DOMContentLoaded\u0026#34;, async function () { const response = await fetch(\u0026#34;/aaa\u0026#34;); const reader = response.body.getReader(); while (true) { const { value, done } = await reader.read(); if (done) break; const decoder = new TextDecoder(\u0026#34;utf-8\u0026#34;); const str = decoder.decode(value); document.getElementById(\u0026#34;output\u0026#34;).innerHTML = str; } }); \u0026lt;/script\u0026gt; \u0026lt;/html\u0026gt; å‚è€ƒ ä½¿ç”¨ fetch API æµå¼å¤„ç†è¯·æ±‚\nTransfer-Encoding\nä½¿ç”¨æœåŠ¡å™¨å‘é€äº‹ä»¶\n","date":"2023-02-15T00:00:00Z","permalink":"https://blog.golang.space/p/http-%E6%B5%81%E5%BC%8F%E4%BC%A0%E8%BE%93/","title":"HTTP æµå¼ä¼ è¾“"},{"content":"æŒç»­é›†æˆ(CI)/æŒç»­äº¤ä»˜(CD) æŒç»­é›†æˆ: è‡ªåŠ¨æ„å»ºå’Œè‡ªåŠ¨åŒ–æµ‹è¯• æŒç»­äº¤ä»˜: è‡ªåŠ¨æ¨é€åˆ°å‘å¸ƒç³»ç»Ÿ æŒç»­éƒ¨ç½²: è‡ªåŠ¨å°†æ›´æ”¹æ¨é€åˆ°ç”Ÿäº§ä¸­ ä¸åŒç¯å¢ƒï¼Œå°±æœ‰ä¸åŒé—®é¢˜ã€‚å¦‚æœåº”ç”¨åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œæˆ–è€…æ“ä½œç³»ç»Ÿçš„ä¸åŒç‰ˆæœ¬ï¼Œå°±éœ€è¦æµ‹è¯•æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿã€‚\nä½¿ç”¨æŒç»­é›†æˆå·¥å…·ï¼Œåœ¨æ¯ä¸€ç§æ”¯æŒçš„å¹³å°å’Œç¯å¢ƒä¸­è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œè¦ç§¯æçš„å¯»æ‰¾é—®é¢˜ï¼Œè€Œä¸æ˜¯ç­‰é—®é¢˜æ¥æ‰¾ä½ ã€‚\nCaddy Server Caddy 2 æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€ä¼ä¸šçº§ã€**å¼€æºçš„ Web æœåŠ¡å™¨ï¼Œ**å…·æœ‰ç”¨ Go ç¼–å†™çš„ è‡ªåŠ¨ HTTPS\nåœ¨æœåŠ¡å™¨ä¸Šå®‰è£… 1 2 3 4 5 sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl -1sLf \u0026#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key\u0026#39; | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg curl -1sLf \u0026#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt\u0026#39; | sudo tee /etc/apt/sources.list.d/caddy-stable.list sudo apt update sudo apt install caddy æŸ¥çœ‹ caddy è¿è¡ŒçŠ¶æ€\n1 2 3 systemctl status caddy # å¦‚æœä½ è¿˜æ²¡æœ‰è¿è¡Œï¼Œæ‰§è¡Œ caddy start æ­¤æ—¶è®¿é—® ip å°†ä¼šçœ‹åˆ° caddy çš„é»˜è®¤é¡µé¢\ncaddy çš„å¸¸ç”¨å‘½ä»¤å¦‚ä¸‹\n1 2 3 4 # åœæ­¢ caddy stop # é‡è½½å½“å‰ç›®å½•çš„é…ç½® caddy reload åœ¨éƒ¨ç½² Drone ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç”¨ caddy ä½œä¸ºç½‘å…³ï¼Œåå‘ä»£ç†ã€‚\nåœ¨ /etc/caddy/Caddyfile å¢åŠ å‡ è¡Œ\n1 2 3 drone.example.com:80 { reverse_proxy 127.0.0.1:8000 } æ­¤å¤„ 127.0.0.1:8000 æ˜¯ drone çš„æœåŠ¡\nDrone Drone æ˜¯ä¸ºç¹å¿™çš„å¼€å‘å›¢é˜Ÿæä¾›çš„è‡ªåŠ©å¼æŒç»­é›†æˆå¹³å°ã€‚\nåœ¨ Git ä»“åº“å¹³å°åˆ›å»ºç¬¬ä¸‰æ–¹åº”ç”¨ æ­¤å¤„ä»¥å®˜ç½‘æ–‡æ¡£çš„å›¾ç‰‡ç¤ºä¾‹ï¼Œå…³äºå¦‚ä½•åˆ›å»ºï¼Œå®˜æ–¹æ–‡æ¡£éå¸¸è¯¦ç»†ã€‚\nå›è°ƒåœ°å€å¤§æ¦‚æ˜¯ åº”ç”¨ä¸»é¡µ/login\nåœ¨æœåŠ¡å™¨ä¸‹ï¼Œåˆ›å»º drone æ–‡ä»¶å¤¹ï¼Œç¼–è¾‘ docker-compose.yml æ–‡ä»¶\n1 2 mkdir /home/app/drone \u0026amp;\u0026amp; cd /home/app/drone vim docker-compose.yml ä½¿ç”¨ docker-compose éƒ¨ç½² drone\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 version: \u0026#39;3\u0026#39; services: drone-server: image: drone/drone:latest ports: - 8000:80 # - 9000:443 networks: - drone_network volumes: - $PWD/data:/data:rw - /var/run/docker.sock:/var/run/docker.sock - /etc/localtime:/etc/localtime restart: always environment: - TZ=Asia/Shanghai - DRONE_RPC_SECRET=\u0026lt;éšæœºç§˜é’¥ï¼Œè¯•è¯• openssl rand -hex 16\u0026gt; - DRONE_GITEE_CLIENT_ID=\u0026lt;åˆ›å»ºç¬¬ä¸‰æ–¹åº”ç”¨æ—¶å¾—åˆ°çš„ id\u0026gt; - DRONE_GITEE_CLIENT_SECRET=\u0026lt;åˆ›å»ºç¬¬ä¸‰æ–¹åº”ç”¨æ—¶å¾—åˆ°çš„ secret\u0026gt; - DRONE_SERVER_HOST=\u0026lt;å…¬ç½‘ IP:port æˆ–åŸŸå\u0026gt; - DRONE_SERVER_PROTO=http - DRONE_TLS_AUTOCERT=false - DRONE_USER_CREATE=username:ixugo,admin:true - DRONE_NETRC_CLONE_ONLY=true # å¦‚æœéƒ¨ç½²åé‡åˆ°é—®é¢˜ï¼Œè¿½è¸ªæ—¥å¿—ä¾æ¬¡å¤„ç† # éƒ¨ç½²æˆåŠŸåï¼Œå»ºè®®æ³¨é‡Š - DRONE_TRACE=true - DRONE_DEBUG=true - DRONE_LOGS_DEBUG=true drone-runner: image: drone/drone-runner-docker:latest command: agent restart: always ports: - 3000:3000 depends_on: - drone-server networks: - drone_network volumes: - /var/run/docker.sock:/var/run/docker.sock - /etc/localtime:/etc/localtime dns: 114.114.114.114 environment: - TZ=Asia/Shanghai - DRONE_RPC_HOST=drone-server - DRONE_RPC_PROTO=http - DRONE_RPC_SECRET=\u0026lt;éšæœºç§˜é’¥ï¼Œè·Ÿä¸Šé¢çš„é…ç½®ç›¸åŒ\u0026gt; - DRONE_RUNNER_CAPACITY=2 - DRONE_RUNNER_NETWORKS=drone_network # å¼€å¯æ—¥å¿— - DRONE_TRACE=true - DRONE_DEBUG=true - DRONE_LOGS_DEBUG=true networks: drone_network: name: drone_network æ‰§è¡Œ docker-compose up -d å³å¯ï¼Œå¦‚æœå‘ç°æ„å¤–ï¼Œæ£€æŸ¥æ—¥å¿—æŸ¥çœ‹å‘ç”Ÿçš„é—®é¢˜ã€‚\nä½¿ç”¨ CI/CD è¿›å…¥ Drone æ§åˆ¶é¢æ¿ï¼Œå°†ä¼šåŒæ­¥ä½ çš„æ‰€æœ‰ä»“åº“ã€‚\nå¦‚æœä½ ä¸æ˜¯ä»“åº“çš„ç®¡ç†å‘˜ï¼Œæ˜¯æ²¡æœ‰æƒé™æ¿€æ´»çš„ã€‚\nå¦‚æœä»“åº“çš„åç§°æœ‰é—®é¢˜ï¼Œæ‰“å¼€åä¼šæç¤º 404ã€‚\næˆåŠŸæ¿€æ´»åçš„é¡µé¢æ˜¯è¿™æ ·\nåŒæ—¶ï¼Œä½ åœ¨å¯¹åº”ä»“åº“çš„ webhook ä¸­å°†ä¼šçœ‹åˆ°å¤šå‡ºçš„é…ç½®ã€‚\nåœ¨é¡¹ç›®ä¸­åˆ›å»ºæ–‡ä»¶ .drone.ymlï¼Œå¦‚ä¸‹æ‰€ç¤º:\nè¿™é‡Œä½¿ç”¨ plugins/docker æ¥æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œé»˜è®¤ä¼šè¯†åˆ«å½“å‰ç›®å½•ä¸‹çš„ Dockerfile æ–‡ä»¶ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯å…è´¹çš„é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“ï¼Œå¦‚æœè®¤ä¸ºè¿™ä¸€æ­¥éº»çƒ¦å¯ä»¥è·³è¿‡ã€‚å°†æ„å»ºçš„åº”ç”¨ç¨‹åºæ”¾åˆ°ä¸»æœºä¸Šï¼Œè¿œç¨‹æ‰§è¡Œå‘½ä»¤åœ¨ä¸»æœºä¸Šæ„å»ºã€‚\né¿å…ç§˜é’¥æ³„éœ²åœ¨å…¬å…±ä»“åº“ä¸­ï¼Œè¯·ä½¿ç”¨ from_secretï¼Œè¯¥å‚æ•°åœ¨ drone settings ä¸­é…ç½®ã€‚\nä½¿ç”¨ appleboy/drone-ssh å¯¹è¿œç¨‹ä¸»æœºé€šä¿¡ï¼Œå¯ç”¨æ¥æ‰§è¡Œéƒ¨ç½²æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 --- kind: pipeline type: docker name: build platform: os: linux arch: amd64 steps: - name: test and build image: golang:1.19.5-alpine3.17 # privileged: true # volumes: # - name: deps # path: /tmp/cache commands: - go test ./... - go build -o start - name: build Docker image and push image: plugins/docker settings: registry: registry.cn-hangzhou.aliyuncs.com repo: \u0026lt;åå­—\u0026gt; use_cache: true username: from_secret: registry_username password: from_secret: registry_password auto_tag: true # è‡ªåŠ¨æ‰“tag - name: ssh commands image: appleboy/drone-ssh environment: DEBUG_STR: asdasd settings: host: from_secret: debug_host username: from_secret: debug_username key: from_secret: debug_password port: from_secret: debug_port script: - echo start - docker pull \u0026lt;é•œåƒå\u0026gt; environment: CGO_ENABLED: 0 GOOS: linux GOARCH: amd64 # volumes: # - name: deps # host: # path: /home/app/test/build trigger: branch: - main event: - push å½“ä½ åœ¨ main åˆ†æ”¯æ¨é€ä»£ç åï¼Œdrone å°†ä¼šè‡ªåŠ¨æ‰§è¡Œå·¥ä½œæµã€‚\nå‚è€ƒ Caddy 2 å®˜æ–¹æ–‡æ¡£\nDrone å®˜æ–¹æ–‡æ¡£\nDrone æ’ä»¶ ssh\nDrone æ’ä»¶ docker\nåšå®¢ ä½¿ç”¨ Drone Pipeline æ„å»º Docker é•œåƒ\nç§æœ‰åŒ–è½»é‡çº§æŒç»­é›†æˆéƒ¨ç½²æ–¹æ¡ˆ\u0026ndash;05-æŒç»­éƒ¨ç½²æœåŠ¡-Droneï¼ˆä¸‹ï¼‰\nç§æœ‰å­˜å‚¨åº“æ³¨å…¥èº«ä»½éªŒè¯æƒé™\n","date":"2023-02-14T00:00:00Z","image":"http://img.golang.space/img-1676339073254.png","permalink":"https://blog.golang.space/p/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90ci/%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98cd/","title":"æŒç»­é›†æˆ(CI)/æŒç»­äº¤ä»˜(CD)"},{"content":"æ•æ·ä¹‹é“ \u0026lt;é«˜æ•ˆç¨‹åºå‘˜çš„ 45 ä¸ªä¹ æƒ¯\u0026gt; è¯»ä¹¦ç¬”è®°\nä»»ä½•ä¸€ä¸ªæ„šè€…éƒ½èƒ½å¤Ÿè®©äº‹æƒ…å˜å¾—è¶Šæ¥è¶Šç¬¨é‡ï¼Œè¶Šæ¥è¶Šå¤æ‚ï¼Œè¶Šæ¥è¶Šæç«¯ï¼Œéœ€è¦æ—è§‚è€…çš„æŒ‡ç‚¹ä»¥åŠæå¤§çš„å‹‡æ°”ï¼Œæ‰èƒ½å¾—åˆ°è±ç„¶å¼€æœ—çš„å±€é¢ã€‚\næ–°é¡¹ç›®åˆšå¼€å§‹ï¼Œä»£ç å¾ˆå®¹æ˜“ç†è§£å’Œä¸Šæ‰‹ï¼Œéšç€å¼€å‘è¿‡ç¨‹çš„æ¨è¿›ï¼Œé¡¹ç›®ä¸çŸ¥ä¸è§‰æ¼”å˜æˆä¸€ä¸ªåºç„¶æ€ªç‰©ã€‚\næ˜¯ä¸ºä»€ä¹ˆè®©å®ƒæœ€ç»ˆå˜å¾—éš¾ä»¥æŒæ§? å¼€å‘äººå‘˜åœ¨å®Œæˆä»»åŠ¡æ—¶ï¼Œå¯èƒ½ä¼šéš¾æŒ¡è¯±æƒ‘ä¸ºèŠ‚çœæ—¶é—´è€Œèµ°ã€Œæ·å¾„ã€ã€‚è¿™äº›ã€Œæ·å¾„ã€å¾€å¾€åªä¼šæ¨è¿Ÿé—®é¢˜çš„çˆ†å‘æ—¶é—´ï¼Œè€Œä¸æ˜¯æŠŠå®ƒå½»åº•è§£å†³æ‰ã€‚\næœ€ç®€å•çš„è§£å†³æ–¹å¼ï¼Œå°±æ˜¯å¼€å‘è¿‡ç¨‹ä¸­æ¯å¤©ä»˜å‡ºä¸€ç‚¹å°çš„åŠªåŠ›ï¼Œé¿å…ä»£ç ã€Œè…çƒ‚ã€ã€‚\nä»£ç è¦æ¸…æ™°åœ°è¡¨è¾¾æ„å›¾ ä»£ç é˜…è¯»çš„æ¬¡æ•°è¦è¿œè¿œè¶…è¿‡ç¼–å†™çš„æ¬¡æ•°ï¼Œæ‰€ä»¥åœ¨ç¼–å†™çš„æ—¶å€™å€¼å¾—èŠ±ç‚¹åŠŸå¤«è®©å®ƒè¯»èµ·æ¥æ›´åŠ ç®€å•ã€‚\nä¾‹å¦‚:\né»˜è®¤å‚æ•°æˆ–å¯é€‰å‚æ•°ä¼šå½±å“ä»£ç å¯è¯»æ€§ï¼Œä½¿å…¶éš¾ä»¥ç†è§£å’Œè°ƒè¯•ï¼Œæœ€å¥½æ˜ç¡®åœ°æŒ‡æ˜å‚æ•°ã€‚ æ”¹åŠ¨ä»£ç ä»¥ä¿®å¤ bug æˆ–æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œåº”æœ‰æ¡ä¸ç´Šï¼Œå…ˆç†è§£ä»£ç åšäº†ä»€ä¹ˆï¼Œå¦‚ä½•åšçš„ã€‚ çœ‹çœ‹ä»£ç ä¾‹å­\n1 coffeeShop.PlaceOrder(2) è¿™ä¸ªå¤§æ¦‚å¯ä»¥ç†è§£æ˜¯åœ¨å’–å•¡åº—ä¸‹äº†è®¢å•ï¼Œ2 æ˜¯ä»€ä¹ˆæ„æ€å‘¢?\nä¸ä»¿æ·»åŠ ä¸€äº›æ³¨é‡Šã€‚\n1 coffeeShop.PlaceOrder(2) // 2: large cup æœ‰æ—¶å€™ï¼Œæ³¨é‡Šæ˜¯ä¸ºäº†å¸®å†™çš„ä¸å¥½çš„ä»£ç è¡¥æ¼ï¼Œä¸ä»¿è€ƒè™‘ç”¨æšä¸¾å€¼æ¥è¡¨è¾¾æ¦‚å¿µã€‚\n1 2 3 4 5 6 7 const ( Small = iota Medium Large ) coffeeShop.PlaceOrder(Large) è¿™æ®µä»£ç å°±å¾ˆæ˜ç™½ï¼Œæ˜¯è¦ä¸€ä¸ªå¤§æ¯çš„å’–å•¡ã€‚\nä½œä¸ºä¸€ä¸ªä¼˜é›…çš„å¼€å‘è€…ï¼Œåº”è¯¥æ—¶é•¿æé†’è‡ªå·±æ˜¯å¦æœ‰ç‰ˆæœ¬å•Šè®©å†™å‡ºçš„ä»£ç æ›´å®¹æ˜“ç†è§£ã€‚\n1 result := val \u0026lt;\u0026lt; 1 å¦‚æœä½ æ“…é•¿ä½è¿ç®—ï¼Œå°±ä¼šæ˜ç™½åªæ˜¯æŠŠ val çš„å€¼ä¹˜ä»¥ 2ã€‚ä½†å¯¹äºæ²¡æœ‰ç±»ä¼¼èƒŒæ™¯çš„äººæ¥è¯´ï¼Œä»–ä»¬èƒ½æ˜ç™½å—? å¯¹äºå›¢é˜Ÿä¸­çš„æ–°äººï¼Œå¯èƒ½ä¼šæŒ å¤´ä¸å·²ï¼ŒæŠ“è€³æŒ è…®ï¼Œç™¾æ€ä¸å¾—ã€Œçªå§ã€ã€‚\n1 result := val*2 ç”¨ä½ç§»åšä¹˜æ³•æ˜¯åœ¨å †ä»£ç è¿›è¡Œä¸å¿…è¦ä¸”å±é™©çš„æ€§èƒ½ä¼˜åŒ–ï¼Œç›´æ¥ä¹˜æ³•çœ‹èµ·æ¥æ›´æ¸…æ™°ï¼Œä¸è¦è¡¨ç°å¾—å¥½åƒå¾ˆèªæ˜ä¼¼çš„ã€‚\næœ‰æ„å›¾çš„ç¼–ç¨‹å¹¶ä¸æ˜¯æ„å‘³ç€åˆ›å»ºæ›´å¤šçš„ç±»å’Œç±»å‹ï¼Œè¿™ä¸æ˜¯è¿›è¡Œè¿‡åˆ†æŠ½è±¡çš„ç†ç”±ã€‚\nå¢é‡å¼ç¼–ç¨‹ å¼€è½¦è¿›è¡Œé•¿å›¾æ—…è¡Œæ—¶ï¼Œä¸¤æ‰‹æŠŠæˆ‘æ–¹å‘ç›˜ï¼Œå›ºå®šåœ¨ä¸€ä¸ªä½ç½®ï¼Œä¸¤çœ¼ç›´ç›¯å‰æ–¹ï¼Œæ²¹é—¨ä¸€è¸©åˆ°åº•å‡ ä¸ªå°æ—¶ï¼Œè¿™æ ·å¯èƒ½å—?\nå¦‚æœä¸å¯¹è‡ªå·±ç¼–å†™çš„ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œå¹¶ä¸”ä¿è¯æ²¡æœ‰é—®é¢˜ï¼Œå°±ä¸è¦è¿ç»­é•¿æ—¶é—´è¿›è¡Œç¼–ç¨‹ã€‚\nç›¸åï¼Œåº”è¯¥é‡‡ç”¨å¢é‡å¼çš„ç¼–ç¨‹æ–¹å¼ï¼Œå¢é‡å¼ç¼–ç¨‹å¯ä»¥ç²¾ç®€å¹¶ç»“æ„åŒ–ä½ çš„ä»£ç ã€‚æ‰€å¼€å‘çš„ä»£ç åŸºäºå³ä½¿çš„åé¦ˆï¼Œè¿™äº›åé¦ˆæ¥è‡ªå°æ­¥å¹…æ–¹å¼ç¼–å†™ä»£ç å’Œæµ‹è¯•çš„è¿‡ç¨‹ã€‚\né‡‡å–å¢é‡å¼ç¼–ç¨‹å’Œæµ‹è¯•ï¼Œä¼šå€¾å‘äºåˆ›å»ºæ›´å°çš„æ–¹æ³•å’Œæ›´å…·å†…èšæ€§çš„ç±»ï¼Œåœ¨ç¼–å†™ä»£ç æ—¶ï¼Œè¦ç»å¸¸ç•™å¿ƒå¯ä»¥æ”¹è¿›çš„å¾®å°æ–¹é¢ï¼Œè¿™å¯èƒ½ä¼šæ”¹å–„ä»£ç çš„å¯è¯»æ€§ã€‚å°†é•¿å‡½æ•°æ‹†åˆ†æˆçŸ­å‡½æ•°ï¼Œä½¿å…¶å˜å¾—æ›´æ˜“äºæµ‹è¯•ã€‚\nä¸­åº¸ä¹‹é“\nå¦‚æœæ„å»ºå’Œæµ‹è¯•å¾ªç¯èŠ±è´¹çš„æ—¶é—´è¿‡é•¿ï¼Œä½ å°±ä¸ä¼šå¸Œæœ›ç»å¸¸è¿è¡Œå®ƒä»¬äº†ã€‚è¦ä¿è¯æµ‹è¯•å¯ä»¥å¿«é€Ÿè¿è¡Œã€‚ åœ¨ç¼–è¯‘å’Œæµ‹è¯•è¿è¡Œä¸­ï¼Œåœä¸‹æ¥æƒ³ä¸€æƒ³ï¼Œå¹¶æš‚æ—¶è¿œç¦»ä»£ç ç»†èŠ‚ï¼Œè¿™æ˜¯ä¿è¯ä¸ä¼šåç¦»æ­£ç¡®æ–¹å‘çš„å¥½æ–¹æ³•ã€‚ è¦ä¼‘æ¯çš„è¯ï¼Œå°±è¦å¥½å¥½ä¼‘æ¯ï¼Œä¼‘æ¯æ—¶è¿œç¦»é”®ç›˜ è¦åƒé‡æ„ä¸šåŠ¡ä»£ç é‚£æ ·ï¼Œé‡æ„æµ‹è¯•ï¼Œè€Œä¸”è¦ç»å¸¸é‡æ„æµ‹è¯• ä¿æŒç®€å• ä¹Ÿè®¸ä½ çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼Œå…¶ä¸­æåˆ°äº†ä¸€ä¸ªè®¾è®¡æƒ³æ³•ï¼Œæ”¾ä¸‹æ–‡ç« ï¼Œçœ¼å‰çš„ä»£ç ä¼¼ä¹é©¬ä¸Šå°±å¯ä»¥ç”¨åˆ°è¿™æ ·çš„æ¨¡å¼ã€‚\nä½ çœŸçš„éœ€è¦ç”¨å®ƒå—?\næ˜¯ä¸æ˜¯ç‰¹å®šçš„é—®é¢˜å¼ºè¿«ä½ ä½¿ç”¨è¿™ä¸ªè§£å†³æ–¹æ¡ˆ ? ä¸è¦è®©è¿‡åº¦è®¾è®¡ï¼Œä¹Ÿä¸è¦å°†ä»£ç è¿‡åº¦å¤æ‚åŒ–ã€‚\nå¼€å‘äººå‘˜æ›´åº”è¯¥ä¸ºè‡ªå·±èƒ½å¤Ÿåˆ›å»ºå‡ºä¸€å¥—ç®€å•å¹¶å¯ç”¨çš„è®¾è®¡è€Œéª„å‚²ã€‚\nç®€å•ä¸æ˜¯ç®€é™‹! ç›¸æ¯”ä¸€ä¸ªè¿‡åº¦å¤æ‚ï¼Œæ‹™åŠ£çš„è§£å†³æ–¹æ¡ˆï¼Œç®€å•çš„æ–¹æ¡ˆ é€šå¸¸æ›´éš¾ä»¥è·å¾—ã€‚\nä¼˜é›…çš„ä»£ç ç¬¬ä¸€çœ¼çœ‹ä¸Šå»ï¼Œå°±çŸ¥é“å®ƒçš„ç”¨å¤„ï¼Œè€Œä¸”å¾ˆç®€æ´ã€‚è¿™æ ·çš„è§£å†³æ–¹æ¡ˆä¸æ˜¯é‚£ä¹ˆå®¹æ˜“æƒ³å‡ºæ¥çš„ã€‚ä¼˜é›…æ˜¯æ˜“äºç†è§£å’Œè¾¨è¯†çš„ã€‚\nä¸­åº¸ä¹‹é“\nä»£ç å‡ ä¹æ€»æ˜¯å¯ä»¥è¿›ä¸€æ­¥ç²¾ç‚¼ï¼Œä½†åˆ°äº†æŸä¸ªç‚¹ä¹‹åï¼Œå†ä½œæ”¹è¿›å°±ä¸ä¼šå¸¦æ¥ä»»ä½•å®è´¨æ€§çš„å¥½å¤„äº†ã€‚ ç®€å•ï¼Œå¯è¯»æ€§é«˜çš„ä»£ç ã€‚å¼ºè¡Œè®©ä»£ç å˜å¾—ä¼˜é›…ä¸è¿‡æ—©ä¼˜åŒ–ç±»ä¼¼ï¼ŒåŒæ ·ä¼šäº§ç”Ÿæ¶åŠ£çš„å½±å“ã€‚ ç®€å•çš„è§£å†³æ–¹æ¡ˆå¿…é¡»æ»¡è¶³åŠŸèƒ½éœ€æ±‚ï¼Œä¸ºäº†ç®€å•è€Œåœ¨åŠŸèƒ½ä¸Šå¦¥åï¼Œå°±æ˜¯è¿‡åº¦ç®€åŒ–ã€‚ ä¸€ä¸ªäººè®¤ä¸ºç®€å•çš„ä¸œè¥¿ï¼Œå¯èƒ½å¯¹å¦ä¸€ä¸ªäººæ„å‘³ç€å¤æ‚ã€‚ å¼€å‘å¯ä»¥å·¥ä½œï¼Œæœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚é™¤éæœ‰ä¸å¯è¾©é©³çš„åŸå› ï¼Œå¦åˆ™ä¸è¦ä¹±ç”¨è®¾è®¡æ¨¡å¼ï¼Œé«˜éš¾åº¦æŠ€æœ¯ä¹‹ç±»çš„ä¸œè¥¿ï¼Œé€ æˆä¸€å¤§é”…é»ç³Šç³Šï¼Œä¹±ä¸ƒå…«ç³Ÿã€‚ ç¼–å†™é«˜å†…èšï¼Œä½è€¦åˆçš„ä»£ç  å†…èšç¨‹åºé«˜ï¼Œè¡¨æ˜å„ä¸ªæˆå‘˜å…±åŒå®Œæˆäº†ä¸€ä¸ªåŠŸèƒ½ç‰¹æ€§æˆ–æ˜¯ä¸€ç»„åŠŸèƒ½ç‰¹æ€§ã€‚\nå‡å®šæŠŠæ‰€æœ‰è¡£æœéƒ½æ‰”åˆ°ä¸€ä¸ªè¡£æŸœï¼Œå½“éœ€è¦æ‰¾ä¸€åŒè¢œå­æ—¶ï¼Œå¾—ç¿»éé‡Œé¢æ‰€æœ‰çš„è¡£æœã€‚\nå¦‚æœæ¯ä¸ªé¡µé¢åŒ…å«å±•ç¤ºé€»è¾‘ï¼Œä¸šåŠ¡é€»è¾‘å’Œè®¿é—®æ•°æ®çš„ä»£ç ï¼Œè‡ƒè‚¿çš„å †ç§¯åœ¨ä¸€èµ·ï¼Œå¦‚æœè¦å¯¹æ•°æ®åº“çš„è¡¨ç»“æ„è¿›è¡Œä¸€æ¬¡å¾®è°ƒï¼Œè¿™ä¸ªå¾®å°çš„å˜åŒ–ä¼šå¯¼è‡´åº”ç”¨ä¸­æ‰€æœ‰çš„é¡µé¢å‘ç”Ÿå˜åŒ–ã€‚\nå‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªç±»ï¼Œå®ç°äº† 5 ç§å®Œå…¨ä¸ç›¸å¹²çš„åŠŸèƒ½ï¼Œå½“ 5 ä¸ªåŠŸèƒ½çš„éœ€æ±‚æˆ–ç»†èŠ‚å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¸ªç±»ä¹Ÿå¿…é¡»è·Ÿç€æ”¹å˜ã€‚å¦‚æœä¸€ä¸ªç±»å˜åŒ–å¾—è¿‡äºé¢‘ç¹ï¼Œè¿™æ ·çš„æ”¹å˜ä¼šå¯¹æ•´ä¸ªç³»ç»Ÿäº§ç”Ÿæ¶Ÿæ¼ªæ•ˆåº”ï¼Œå¯¼è‡´æ›´å¤šçš„ç»´æŠ¤å’Œæˆæœ¬ã€‚æ¨ä¹¦ã€Œæ•æ·è½¯ä»¶å¼€å‘: åŸåˆ™,æ¨¡å¼ä¸å®æˆ˜ã€ã€‚\nä¸­åº¸ä¹‹é“\nä¸€äº›ä¸œè¥¿æ‹†åˆ†æˆå¾ˆå¤šå¾®å°çš„éƒ¨åˆ†ï¼Œå¯èƒ½ä¼šå¤±å»ä½¿ç”¨ä»·å€¼ï¼Œå½“ä½ éœ€è¦è¢œå­çš„æ—¶å€™ï¼Œä¸€ç›’æ¯›çº¿æ˜¯ä¸å¤Ÿç”¨çš„ã€‚ å‘ŠçŸ¥ï¼Œè€Œéè¯¢é—® æœ‰ä¸ªã€Œé€æŠ¥ç”·å­©å’Œé’±åŒ…çš„æ•…äº‹ã€ï¼Œç”·å­©å°†æŠ¥çº¸é€åˆ°ä½ çš„é—¨å‰ï¼Œè¦æ±‚ä»˜æŠ¥é…¬ï¼Œä½ è½¬è¿‡èº«è®©ç”·å­©ä»ä½ çš„åå±è‚¡å…œæå‡ºé’±åŒ…ï¼Œå¹¶ä¸”ä»ä¸­æ‹¿åˆ°ä¸¤ç¾å…ƒï¼Œå†æŠŠé’±åŒ…æ”¾å›å»ã€‚\nå½“ç”·å­©æ‹¿åˆ°é’±åŒ…çš„æ—¶å€™ï¼Œä»–æ‹¿èµ°çš„æ•°é¢ä¸æ˜¯ä½ èƒ½æ§åˆ¶çš„ã€‚é€æŠ¥ç”·å­©ä½œä¸ºè°ƒç”¨è€…ï¼Œåº”è¯¥å‘Šè¯‰å®¢æˆ·éœ€è¦ä»˜å¤šå°‘é’±ï¼Œç”·å­©ä¸èƒ½æ¢å¯»å®¢æˆ·çš„è´¢åŠ¡çŠ¶å†µï¼Œä¹Ÿä¸èƒ½ä»£æ›¿åšä»»ä½•å†³ç­–ã€‚\nå‘ŠçŸ¥ï¼Œä¸è¦è¯¢é—®æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æŠ€æœ¯ï¼Œå°†åŠŸèƒ½å’Œæ–¹æ³•åˆ†ä¸ºã€Œå‘½ä»¤ã€å’Œã€ŒæŸ¥è¯¢ã€ä¸¤ç±»ï¼Œä¸€ä¸ªå¸¸è§„çš„å‘½ä»¤å¯èƒ½ä¼šæ”¹å˜å¯¹è±¡çš„çŠ¶æ€ï¼Œä¸€ä¸ªæŸ¥è¯¢ä»…ä»…æä¾›çŠ¶æ€ï¼Œä¸æä¾›ä¿®æ”¹ã€‚\næ•æ·è°ƒè¯• å³ä½¿æ˜¯è¿ä½œå¾—æœ€å¥½çš„æ•æ·é¡¹ç›®ï¼Œä¹Ÿä¼šå‘ç”Ÿé”™è¯¯ã€‚bugï¼Œé”™è¯¯ï¼Œç¼ºé™·\u0026mdash;ä¸ç®¡è¢«ç§°ä½œä»€ä¹ˆï¼Œå®ƒä»¬æ€»ä¼šå‘ç”Ÿã€‚\nè¦æƒ³æ›´åŠ æœ‰æ•ˆåœ°é‡ç”¨ä½ çš„çŸ¥è¯†å’ŒåŠªåŠ›ï¼Œè®°å½•é—®é¢˜è§£å†³æ—¥å¿—æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚\nä¸è¦åœ¨åŒä¸€å¤„è·Œå€’ä¸¤æ¬¡ï¼Œå¯ä»¥é€‰æ‹©ç¬¦åˆéœ€æ±‚çš„ä»»ä½•æ ¼å¼ï¼Œå¦‚ä¸‹:\né—®é¢˜å‘ç”Ÿæ—¥æœŸ é—®é¢˜ç®€è¿° è§£å†³æ–¹æ¡ˆè¯¦ç»†æè¿° å¼•ç”¨æ–‡ç« æˆ–ç½‘å€ ä»»ä½•ä»£ç ç‰‡æ®µï¼Œè®¾ç½®æˆ–å¯¹è¯æ¡†æˆªå± åŠ©è®°æ ‡ç­¾ å¦‚\n1 2 3 2023/02/15 golang æ›´æ–° 1.20 åï¼Œgolangci-lint åœ¨ç»ˆç«¯æç¤ºäº†å¾ˆå¤šé”™è¯¯ã€‚ åœ¨ github çš„ golangci-lint æœç´¢ç›¸å…³ issusï¼Œå‘ç° brew/vscode-go å‘è¡Œçš„ golangci-lint éƒ½æ˜¯æ—§ç‰ˆ 1.50.1ï¼Œè€Œæ­¤å·¥å…·å·²æ›´æ–°è‡³ 1.51 ä¿®å¤äº†ç›¸å…³é—®é¢˜ï¼Œç›´æ¥ä¸‹è½½æ›¿æ¢å³å¯ã€‚ å¦‚æœé¢ä¸´çš„é—®é¢˜æ— æ³•åœ¨æ—¥å¿—ä¸­æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œåœ¨é—®é¢˜è§£å†³ä¹‹åï¼Œè¦è®°å¾—é©¬ä¸Šæ›´æ–°ç»†èŠ‚è®°å½•åˆ°æ—¥å¿—ä¸­ã€‚\nè§£å†³æ–¹æ¡ˆæ—¥å¿—åº”è¯¥ä½œä¸ºæ€è€ƒçš„ä¸€ä¸ªæ¥æºï¼Œå¯ä»¥åœ¨å…¶ä¸­å‘ç°æŸäº›ç‰¹å®šé—®é¢˜çš„ç»†èŠ‚ï¼Œå¯¹äºæŸäº›ç±»ä¼¼ä½†æ˜¯æœ‰å·®å¼‚çš„é—®é¢˜ï¼Œä¹Ÿèƒ½ä»ä¸­è·å¾—ä¿®å¤çš„æŒ‡å¼•ã€‚\nä¸­åº¸ä¹‹é“\nè®°å½•é—®é¢˜çš„æ—¶é—´ä¸èƒ½è¶…è¿‡åœ¨è§£å†³é—®é¢˜ä¸ŠèŠ±è´¹çš„äº‹æƒ…ï¼Œè¦ä¿æŒè½»é‡çº§å’Œç®€å•ï¼Œä¸å¿…è¾¾åˆ°å¯¹å¤–å‘å¸ƒå¼çš„è´¨é‡ æ‰¾åˆ°ä»¥å‰çš„è§£å†³æ–¹æ³•éå¸¸å…³é”®ï¼Œä½¿ç”¨è¶³å¤Ÿçš„å…³é”®å­—ï¼Œä»¥å¸®åŠ©æŸ¥æ‰¾ å¦‚æœé€šè¿‡ web æœç´¢ï¼Œå‘ç°æ²¡äººæ›¾ç»é‡åˆ°åŒæ ·çš„é—®é¢˜ï¼Œä¹Ÿè®¸æ˜¯æœç´¢çš„æ–¹å¼æœ‰é—®é¢˜ è¦è®°å½•å‘ç”Ÿé—®é¢˜æ—¶åº”ç”¨ç¨‹åºï¼Œåº”ç”¨æ¡†æ¶æˆ–å¹³å°çš„ç‰¹å®šç‰ˆæœ¬ è®°å½•å›¢é˜Ÿåšå‡ºé‡è¦å†³ç­–çš„åŸå› ï¼Œå¦åˆ™ 6-9 ä¸ªæœˆä¹‹åï¼Œæƒ³å†é‡æ–°å›é¡¾å†³ç­–è¿‡ç¨‹ï¼Œè¿™äº›ç»†èŠ‚å°±å¾ˆéš¾å†è®°å¾—ï¼Œå®¹æ˜“å‘ç”Ÿäº’ç›¸æŒ‡è´£çš„æƒ…å½¢ã€‚ å¯¹é—®é¢˜å„ä¸ªå‡»ç ´ å•å…ƒæµ‹è¯•å¸¦æ¥çš„ç§¯ææ•ˆåº”ä¹‹ä¸€ï¼Œå°±æ˜¯å®ƒä¼šå¼ºè¿«å½¢æˆä»£ç çš„åˆ†å±‚ï¼Œè¦ä¿è¯ä»£ç å¯æµ‹è¯•ï¼Œå°±å¿…é¡»æŠŠå®ƒä»å‘¨è¾¹ä»£ç ä¸­è§£è„±å‡ºæ¥ï¼Œå¦‚æœä»£ç ä¾èµ–å…¶å®ƒæ¨¡å—ï¼Œå°±åº”è¯¥ä½¿ç”¨ mock å¯¹è±¡ã€‚\nè¯†åˆ«å¤æ‚é—®é¢˜çš„ç¬¬ä¸€æ­¥ï¼Œæ˜¯å°†ä»–ä»¬åˆ†ç¦»å‡ºæ¥ã€‚ä¸å¯èƒ½åœ¨åŠç©ºä¸­è¯•å›¾ä¿®å¤é£æœºå¼•æ“ï¼Œå°†å…¶å–å‡ºæ¥æ”¾åœ¨å·¥ä½œå°ä¸Šä¹‹åæ›´å®¹æ˜“ä¿®å¤ã€‚\nä¸­åº¸ä¹‹é“\nå°†ä»£ç ä¸­å…¶è¿è¡Œç¯å¢ƒä¸­åˆ†ç¦»åï¼Œé—®é¢˜æ¶ˆå¤±ä¸è§äº†ï¼Œæœ‰åŠ©äºéš”ç¦»é—®é¢˜ï¼Œç›¸åä¹Ÿæœ‰åŠ©äºéš”ç¦»é—®é¢˜ ä»¥äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼å®šä½é—®é¢˜å¾ˆæœ‰ç”¨ï¼Œå°†é—®é¢˜ç©ºé—´åˆ†æˆä¸¤åŠï¼Œçœ‹å“ªä¸€åŠåŒ…å«é—®é¢˜ï¼Œå†å°†åŒ…å«é—®é¢˜çš„è¿›è¡ŒäºŒåˆ†ï¼Œå¹¶ä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°å‘ç°é—®é¢˜æœ¬è´¨ã€‚ åœ¨å¤„ç†é—®é¢˜ä¹‹å‰ï¼Œå…ˆæŸ¥æ‰¾é—®é¢˜è§£å†³æ—¥å¿—ã€‚ æŠ¥å‘Šæ‰€æœ‰çš„å¼‚å¸¸ ç¼–ç¨‹ï¼Œä¸ä»…è¦è€ƒè™‘æ­£å¸¸çŠ¶æ€ä¸‹å¦‚ä½•è¿ä½œï¼Œæ›´è¦è€ƒè™‘å¼‚å¸¸æƒ…å†µä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚\næœ‰äº›å¼€å‘äººå‘˜ä¼šé‡‡ç”¨ä¸´æ—¶çš„åšæ³•ï¼Œæ•æ‰åˆ°å¼‚å¸¸åï¼Œä¸ºäº†ä¸çœ‹åˆ°ç¼–è¯‘å™¨çš„æç¤ºï¼Œå°±æŠŠå¼‚å¸¸å¿½ç•¥æ‰ã€‚\nå¿…é¡»å¤„ç†æˆ–å‘ä¸Šä¼ æ’­æ‰€æœ‰çš„å¼‚å¸¸ï¼Œä¸è¦å°†å®ƒä»¬å‹åˆ¶ä¸ç®¡ï¼Œå°±ç®—æ˜¯ä¸´æ—¶åšä¹Ÿä¸è¡Œã€‚\nä¸­åº¸ä¹‹é“\nä¸æ˜¯æ‰€æœ‰çš„é—®é¢˜éƒ½åº”è¯¥æŠ›å‡ºå¼‚å¸¸ã€‚ æŠ¥å‘Šçš„å¼‚å¸¸åº”è¯¥åœ¨ä»£ç çš„ä¸Šä¸‹æ–‡ä¸­æœ‰å®é™…æ„ä¹‰ã€‚ å¦‚æœä»£ç ä¸­ä¼šè®°å½•è¿è¡Œæ—¶è°ƒè¯•æ—¥å¿—ï¼Œå½“æ•è·æˆ–æ˜¯æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œéƒ½è¦è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ ·åšå¯¹ä»¥åçš„è·Ÿè¸ªå·¥ä½œå¾ˆæœ‰å¸®åŠ©ã€‚ æ£€æŸ¥å¼‚å¸¸å¤„ç†èµ·æ¥å¾ˆéº»çƒ¦ï¼Œæ²¡äººæ„¿æ„è°ƒç”¨æŠ›å‡º 31 ç§ä¸åŒæ£€æŸ¥å¼‚å¸¸çš„æ–¹æ³•ã€‚è¿™æ˜¯è®¾è®¡ä¸Šçš„é—®é¢˜ã€‚ è¦ä¼ æ’­ä¸èƒ½å¤„ç†çš„å¼‚å¸¸ã€‚ æä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯ å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ˜¾ç¤ºé€šç”¨çš„ä¿¡æ¯å‘Šè¯‰ç”¨æˆ·å‘ç”Ÿäº†é—®é¢˜ï¼Œè¦å¥½è¿‡äºç³»ç»Ÿå´©æºƒé€ æˆåº”ç”¨æ‰§è¡Œé”™è¯¯çš„åŠ¨ä½œã€‚ç„¶è€Œç±»ä¼¼ã€Œå‡ºé”™äº†ã€è¿™æ ·çš„æ¶ˆæ¯ï¼Œæ— æ³•å¸®åŠ©å›¢é˜Ÿé’ˆå¯¹é—®é¢˜åšå‡ºè¯Šæ–­ã€‚\nç”¨æˆ·åœ¨ç»™æ”¯æŒå›¢é˜Ÿæ‰“ç”µè¯æŠ¥å‘Šé—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ä»–ä»¬æä¾›è¶³å¤Ÿå¤šä¸”å¥½çš„ä¿¡æ¯ï¼Œä»¥å¸®åŠ©å°½å¿«è¯†åˆ«é—®é¢˜æ‰€åœ¨ã€‚\nè®°å½•æ—¥å¿— å®¢æˆ·ç«¯å±•ç¤ºåŒ…è£…çš„é”™è¯¯ï¼Œå°†é”™è¯¯ç»†èŠ‚éšè—åœ¨ã€Œè¯¦æƒ…ã€æŒ‰é’®ä¸­ï¼Œç‚¹å‡»æŒ‰é’®å¯ä»¥å°†é”™è¯¯ç»†èŠ‚ä»¥é‚®ä»¶å‘ç»™æŠ€æœ¯æ”¯æŒï¼Œæˆ–ç›´æ¥å±•ç¤ºé”™è¯¯ã€‚ æ—¥å¿—ä¸­è®°å½•çš„ä¿¡æ¯å¯èƒ½åº”è¯¥åŒ…å«å½“æ—¶çš„ç³»ç»ŸçŠ¶æ€ï¼Œç‰ˆæœ¬ç­‰å¿«ç…§ åŒºåˆ†é”™è¯¯ç±»å‹:\nç¨‹åºç¼ºé™·: è¿™æ˜¯çœŸæ­£çš„ bugï¼Œç”¨æˆ·æˆ–æŠ€æœ¯æ”¯æŒå¯¹æ­¤æŸæ‰‹æ— ç­–ï¼Œåªèƒ½ç ”å‘å¤„ç†ã€‚ ç¯å¢ƒé—®é¢˜: å¦‚æœèƒ½æä¾›è¶³å¤Ÿè¯¦ç»†çš„é”™è¯¯ï¼ŒæŠ€æœ¯æ”¯æŒå¯ä»¥è§£å†³ã€‚ ç”¨æˆ·é”™è¯¯: ç”±ç”¨æˆ·çš„è¾“å…¥é€ æˆçš„é—®é¢˜ï¼Œç”¨æˆ·å¯ä»¥é‡è¯•ã€‚é€šè¿‡è¿½è¸ªè®°å½•æŠ¥å‘Šçš„é”™è¯¯ç±»å‹ï¼Œå¯ä»¥ä¸ºå—ä¼—æä¾›æ›´ä½³åˆé€‚çš„å»ºè®®ï¼Œä¸ºç ”å‘æä¾›ç¨‹åºä¼˜åŒ–ç­‰ã€‚ ä¸­åº¸ä¹‹é“\nåƒæ— æ³•æ‰¾åˆ°æ–‡ä»¶è¿™æ ·çš„é”™è¯¯ï¼Œæœ¬èº«è€Œè¨€æ— åŠ©äºé—®é¢˜çš„è§£å†³ã€‚ ã€Œæ— æ³•æ‰¾åˆ° /home/app/main.yaml æ–‡ä»¶ ã€è¿™æ ·çš„ä¿¡æ¯æ›´æœ‰æ•ˆã€‚ åœ¨æä¾›æ›´å¤šä¿¡æ¯çš„åŒæ—¶ï¼Œä¸è¦æ³„éœ²å®‰å…¨ä¿¡æ¯ï¼Œä¸ªäººéšç§ï¼Œå•†ä¸šæœºå¯†ã€‚ æä¾›ç»™ç”¨æˆ·çš„ä¿¡æ¯å¯ä»¥åŒ…å«ä¸€ä¸ªä¸»é”®ï¼Œä»¥ä¾¿äºåœ¨æ—¥å¿—æ–‡ä»¶æˆ–æ˜¯å®¡æ ¸è®°å½•ä¸­å®šä½ç›¸å…³å†…å®¹ã€‚ æ•æ·åä½œ é«˜æ•ˆçš„åä½œæ˜¯æ•æ·å¼€å‘çš„åŸºçŸ³ã€‚\nå›¢é˜Ÿä¸­ä¸€ä¸ªäººçš„çŸ¥è¯†ï¼Œç»å¸¸å¯ä»¥è§£å†³å¦å¤–ä¸€åæˆå‘˜çš„é—®é¢˜ã€‚åªè¦å…è®¸å¤§å®¶è‡ªå·±æƒ³åŠæ³•ï¼Œå°±å¯ä»¥å¸®åŠ©å›¢é˜Ÿä¸æ–­æˆé•¿ã€‚\nå‡†å¤‡å¥½å†å…±äº«ä»£ç  code review ä¸æ–­å®Œæˆæ—§ä»»åŠ¡ï¼Œé¢†å–æ–°ä»»åŠ¡ï¼ŒåŠæ—¶é€šæŠ¥è¿›å±•ä¸é—®é¢˜ å®šæ—¶å®‰æ’ä¼šé¢æ—¶é—´ï¼Œè¦ä¿è¯ä¼šè®®è®®é¢˜ä¸ä¼šå‘æ•£ï¼Œæ¯ä¸ªäººéƒ½åº”è¯¥åªå›ç­” 3 ä¸ªé—®é¢˜ï¼Œå¦‚æœè¦è¯¦ç»†è®¨è®ºæŸäº›é—®é¢˜ï¼Œå¯ä»¥åœ¨ä¼šè®®ç»“æŸåï¼Œå†ä¸“é—¨å¬é›†ç›¸å…³äººå‘˜ç§èŠã€‚\næ˜¨å¤©æœ‰ä»€ä¹ˆæ”¶è·? ä»Šå¤©è®¡åˆ’åšå“ªäº›å·¥ä½œ? é¢ä¸´å“ªäº›éšœç¢? æˆä¸ºæŒ‡å¯¼è€… å¥½çš„æƒ³æ³•ä¸ä¼šå› ä¸ºè¢«è®¸å¤šäººäº†è§£è€Œå‰Šå¼±ï¼Œå¥½ä¸»æ„å°±åƒç«ï¼Œå¯ä»¥å¼•é¢†è¿™ä¸ªä¸–ç•Œã€‚\nä¸åˆ«äººå…±äº‹ï¼Œæ¿€åŠ±ä»–ä»¬å˜å¾—æ›´å‡ºè‰²ï¼ŒåŒæ—¶å¯ä»¥æå‡å›¢é˜Ÿçš„æ•´ä½“å®åŠ›ã€‚\næˆä¸ºæŒ‡å¯¼è€…ï¼Œå¹¶ä¸æ„å‘³ç€è¦æ‰‹æŠŠæ‰‹æ•™æˆå‘˜æ€ä¹ˆåšï¼Œä¹Ÿä¸æ˜¯åœ¨ç™½æ¿å‰è®²åº§ã€‚å¤šæ•°æ—¶å€™ï¼Œæˆä¸ºæŒ‡å¯¼è€…ï¼Œæ˜¯æŒ‡åœ¨å¸®åŠ©å›¢é˜Ÿæˆå‘˜æå‡æ°´å¹³çš„åŒæ—¶ä¹Ÿæé«˜è‡ªå·±ã€‚\næˆä¸ºæŒ‡å¯¼è€…æ„å‘³ç€è¦åˆ†äº«ï¼Œè€Œä¸æ˜¯å›ºå®ˆã€‚\nä¸­åº¸ä¹‹é“\nå¦‚æœæ€»æ˜¯è¢«ä¸€äº›æ‡’äºè‡ªå·±å¯»æ‰¾ç­”æ¡ˆçš„äººæ‰“æ‰°\u0026hellip; ä¸ºå›¢é˜Ÿæˆå‘˜åœ¨å¯»æ±‚å¸®åŠ©ä¹‹å‰ï¼Œè®¾å®šä¸€ä¸ªé™·å…¥æ—¶é—´ï¼Œ1 å°æ—¶åº”è¯¥ä¸é”™ åš code review ä»£ç åˆšåˆšå®Œæˆæ—¶ï¼Œæ˜¯å¯»æ‰¾é—®é¢˜çš„æœ€ä½³æ—¶æœºã€‚\nä¸­åº¸ä¹‹é“\nä¸è¿›è¡Œæ€è€ƒçš„ code review æ²¡æœ‰ä»»ä½•ä»·å€¼ ä»£ç å¤æ‚éœ€è¦ç§¯æè¯„ä¼°ä»£ç çš„è®¾è®¡å’Œæ¸…æ™°ç¨‹åºï¼Œå¸¦ç€é—®é¢˜å»å¤æŸ¥ èµ°å‘æ•æ· ä¸€ç¯èƒ½é™¤åƒå¹´æš—ï¼Œä¸€æ™ºèƒ½ç­ä¸‡å¹´æ„šã€‚ \u0026mdash;- æ…§èƒ½ï¼Œä¸­å›½ç¦…å®—ç¬¬å…­ä»£ç¥–å¸ˆ\n","date":"2023-02-10T00:00:00Z","permalink":"https://blog.golang.space/p/%E6%95%8F%E6%8D%B7%E4%B9%8B%E9%81%93-%E4%B8%8B/","title":"æ•æ·ä¹‹é“ (ä¸‹)"},{"content":"æ•æ·ä¹‹é“(ä¸Š) \u0026lt;é«˜æ•ˆç¨‹åºå‘˜çš„ 45 ä¸ªä¹ æƒ¯\u0026gt; è¯»ä¹¦ç¬”è®°\næ€åº¦å†³å®šä¸€åˆ‡ å‘ç”Ÿé—®é¢˜åï¼Œæœ€é«˜çš„ä¼˜å…ˆçº§æ˜¯æ‰¾å‡ºç½ªé­ç¥¸é¦–å¯¹å—?\nè‚¯å®šçš„ç­”æ¡ˆæ˜¯: ä¼˜å…ˆè§£å†³é—®é¢˜!\nå¦‚æœè¯´å‡ºæ¥çš„è¯åªæ˜¯è®©äº‹æ€æ›´å¤æ‚ï¼Œæˆ–ä¸€å‘³åœ°æŠ±æ€¨ï¼Œæˆ–è€…ä¼¤å®³ä»–äººçš„æ„Ÿæƒ…ï¼Œæ— æ„ä¸­åœ¨ç»™é—®é¢˜ç«ä¸Šæµ‡æ²¹ã€‚\nä¸ºäº†è§£å†³æˆ–ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåšäº›ä»€ä¹ˆ?\næ•æ·å¼€å‘å›¢é˜Ÿä¸­æ¯ä¸ªäººéƒ½åº”è¯¥æŠ±ç€è¿™æ ·çš„è§‚ç‚¹ï¼Œå’±ä»¬å¯ä»¥ä»è‡ªå·±åšèµ·ã€‚ä¾‹å¦‚ä¸€ä¸ªå¼€å‘è€…å¸¦ç€æŠ±æ€¨æˆ–é—®é¢˜æ¥è¿‡æ¥ï¼Œå’±ä»¬è¦äº†è§£å…·ä½“çš„é—®é¢˜ï¼Œè¯¢é—®ä»–éœ€è¦ä»€ä¹ˆæ ·çš„å¸®åŠ©ã€‚è¿™æ ·ä¸€ä¸ªç®€å•çš„è¡Œä¸ºè¡¨æ˜ç›®çš„æ˜¯è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯è¿½ç©¶è´£ä»»ã€‚\nç›¸åå’±ä»¬æ‰¾äººå¸®å¿™ï¼Œå´æ²¡äººç§¯æå“åº”ï¼Œé‚£ä¹ˆåº”è¯¥ä¸»åŠ¨å¼•å¯¼å¯¹è¯ï¼Œè§£é‡Šæ¸…æ¥šæƒ³è¦ä»€ä¹ˆã€‚\nä¸€ä¸ªé‡å¤§çš„é”™è¯¯åº”è¯¥è¢«å½“åšæ˜¯ä¸€æ¬¡å­¦ä¹ ï¼Œè€Œä¸æ˜¯æŒ‡è´£ä»–äººçš„æœºä¼šã€‚\næŒ‡è´£ä¸èƒ½ä¿®å¤é—®é¢˜.\nVlame doesn\u0026rsquo;t fix bugs.\nä¸­åº¸ä¹‹é“\nã€Œè¿™ä¸æ˜¯æˆ‘çš„é”™ã€è¿™å¥è¯ä¸å¯¹ï¼Œã€Œè¿™éƒ½æ˜¯ä½ /ä»–çš„é”™ã€è¿™å¥è¯æ›´ä¸å¯¹ å¦‚æœæ²¡æœ‰çŠ¯è¿‡ä»»ä½•é”™è¯¯ï¼Œè¯´æ˜å¯èƒ½æ²¡æœ‰åŠªåŠ›å»å·¥ä½œ å¦‚æœä¸€ä¸ªå›¢é˜Ÿæˆå‘˜è¯¯è§£äº†éœ€æ±‚/API/ä¼šè®®å†³ç­–ï¼Œé‚£ä¹ˆï¼Œæ„å‘³ç€å…¶ä»–æˆå‘˜ä¹Ÿæœ‰ç›¸åŒçš„è¯¯è§£ï¼Œè¦ç¡®ä¿æ•´ä¸ªå›¢é˜Ÿå°½å¿«æ¶ˆé™¤è¯¯è§£ã€‚ å¦‚æœæŸä¸ªå›¢é˜Ÿæˆå‘˜ä¸æ˜¯åœ¨å¸®åŠ©å›¢é˜Ÿè§£å†³é—®é¢˜çš„æ–¹å‘å‰è¿›ï¼Œåˆ™åº”è¯¥è¦æ±‚ä»–ç¦»å¼€å½“å‰é¡¹ç›®ä¸Šçš„ä¸»è¦å·¥ä½œã€‚ æ¬²é€Ÿåˆ™ä¸è¾¾ æ‹™åŠ£çš„ç å†œä¼šä¸å‡æ€ç´¢çš„æ”¹å®Œä»£ç ï¼Œå¿«é€Ÿè½¬å‘ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚\nå“è¶Šçš„ç å†œä¼šæŒ–æ˜æ›´æ·±ä¸€å±‚ï¼Œå»ç†è§£è¿™ä¸ªå‡½æ•°çš„æ„ä¹‰ï¼Œæ€è€ƒä¿®æ”¹å‡½æ•°çš„å½±å“ã€‚\nå¦åˆ™ï¼Œåœ¨ç»å¹´ç´¯æœˆçš„å±å±±ä¸­æ·»åŠ æ–°åŠŸèƒ½æˆ–ä¿®å¤ bugï¼Œéš¾é€ƒè„±å‘çš„å„è¿ã€‚\nåƒé‡Œä¹‹å ¤æºƒäºèšç©´ã€‚å¿«é€Ÿä¿®å¤çš„è¯±æƒ‘å¾ˆå®¹æ˜“ä»¤äººæŠŠæŒä¸ä½ï¼Œæ²»æ ‡ä¸æ²»æœ¬å•Š!\né˜²å¾®æœæ¸.\nBeware of land mines.\nå¾ˆå¯èƒ½åœ¨å…¬å¸é‡Œï¼Œæœ‰äººå‘Šè¯‰ä½ :\u0026ldquo;æ— è®ºå¦‚ä½•åƒä¸‡ä¸èƒ½ç¢°é‚£ä¸ªå‡½æ•°ï¼Œå†™ä»£ç é‚£å“¥ä»¬æ—©å°±ä¸åœ¨äº†ï¼Œæ²¡æœ‰äººèƒ½çœ‹æ‡‚ä»–çš„ä»£ç \u0026rdquo;\nå»ºè®®:\nä¸è¦å­¤ç«‹åœ°ç¼–ç .\nå›¢é˜Ÿæˆå‘˜åº”è¯¥èŠ±æ—¶é—´é˜…è¯»å…¶ä»–åŒæ—¶çš„ä»£ç ï¼Œç¡®ä¿ä»£ç æ˜¯å¯è¯»å¯ç†è§£çš„ã€‚\nDon\u0026rsquo;t code in isolation.\nå•å…ƒæµ‹è¯•.\nå•å…ƒæµ‹è¯•å¾ˆè‡ªç„¶å°±ä¼šå¸®åŠ©ä½ æŠŠä»£ç åˆ†å±‚ï¼Œè§£è€¦æˆå°çš„æ¨¡å—ã€‚\nUse unit tests.\nä¸­åº¸ä¹‹é“\nå¿…é¡»ç†è§£ä»£ç æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½†ä¸ä¸€å®šè¦æˆä¸ºä¸“å®¶ï¼Œèƒ½å¤Ÿä½¿ç”¨å®ƒè¿›è¡Œæœ‰æ•ˆå·¥ä½œå³å¯ã€‚ å¦‚æœæœ‰ä¸€å—ä»£ç å…¶ä»–äººå¾ˆéš¾çœ‹æ‡‚ï¼Œæ„å‘³ç€ä»»ä½•äººåŒ…æ‹¬åŸä½œè€…éƒ½å¾ˆéš¾ç»´æŠ¤å®ƒ æ‰€æœ‰çš„å¤§å‹ç³»ç»Ÿéƒ½éå¸¸å¤æ‚ï¼Œæ²¡æœ‰ä¸€ä¸ªäººèƒ½å¤Ÿå®Œå…¨æ˜ç™½æ‰€æœ‰ä»£ç ã€‚å’±ä»¬é™¤äº†æ·±å…¥å¼€å‘çš„éƒ¨åˆ†ä»£ç ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä»æ›´é«˜å±‚é¢äº†è§£ç³»ç»Ÿæ¶æ„ï¼Œå„ä¸ªåŠŸèƒ½æ¨¡å—æ˜¯å¦‚ä½•äº¤äº’çš„ã€‚ ä¸è¦æ€¥äºä¿®å¤ä¸€æ®µæ²¡èƒ½ç†è§£çš„ä»£ç ã€‚ å¯¹äº‹ä¸å¯¹äºº \u0026ldquo;é‚£æ ·å¾ˆè ¢!\u0026rdquo; è¿™å¥è¯æƒ³è¡¨è¾¾è®¾è®¡ä¸Šçš„é—®é¢˜ï¼Œä½†æ— æ„ä¸­å´é‡ä¼¤äº†ä»–äººï¼Œæœ‰æ˜ç¤ºè®¾è®¡è€…å¾ˆè ¢ä¹‹æ„ã€‚\næ›´æœ‰æ•ˆä¼˜é›…çš„æ–¹å¼åº”è¯¥æ˜¯: ã€Œæ„Ÿè°¢ï¼Œæˆ‘æƒ³çŸ¥é“ï¼Œå¦‚æœä¸¤ä¸ªç”¨æˆ·åŒæ—¶ç™»å½•ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µ?ã€\né€šå¸¸å¯¹ä¸€ä¸ªæ˜æ˜¾é”™è¯¯æœ‰å“ªäº›ååº”?\nå¦å®šä¸ªäººèƒ½åŠ› æŒ‡å‡ºç¼ºç‚¹ï¼Œå¦åˆ™å…¶è§‚ç‚¹ é—®è¯¢å¹¶æå‡ºé¡¾è™‘ ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œæ²¡æœ‰è°´è´£ï¼Œæ²¡æœ‰æ‰¹åˆ¤ï¼Œç”±æ­¤ç”±æµ…å…¥æ·±çš„äº¤è°ˆï¼Œè€Œéé¢çº¢è€³èµ¤çš„äº‰è¾©ã€‚\nå°è¯•å¼•å¯¼æ€§çš„æå‡ºé—®é¢˜ã€‚\næˆ‘ä»¬æ¯ä¸ªäººéƒ½æœ‰ä¸€äº›æå¥½çš„åˆ›æ–°æƒ³æ³•ï¼ŒåŒæ ·ä¹Ÿä¼šèŒç”Ÿä¸€äº›å¾ˆæ„šè ¢çš„æƒ³æ³•ã€‚å¥½çš„ä½œå“å’Œè®¾è®¡éƒ½éœ€è¦å¤§é‡çš„åˆ›é€ åŠ›å’Œæ´å¯ŸåŠ›ï¼Œåˆ†äº«å¹¶èåˆå„ç§ä¸åŒçš„æƒ³æ³•å’Œè§‚ç‚¹ï¼Œè¿œèƒœäºå•ä¸ªæƒ³æ³•ä¸ºé¡¹ç›®å¸¦æ¥çš„ä»·å€¼ã€‚\né‡ç‚¹è¦æ”¾åœ¨è§£å†³é—®é¢˜ä¸Šï¼Œè€Œä¸æ˜¯æåŠ›è¯æ˜è°çš„ä¸»æ„æ›´å¥½ã€‚å›¢é˜Ÿä¸­ä¸€ä¸ªäººçš„æ™ºå•†é«˜æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå¦‚ä½•å¾ˆé¡½å›ºå¹¶ä¸”æ‹’ç»åˆä½œï¼Œé‚£å°±æ›´ç³Ÿç³•ã€‚\næ¯ä¸ªäººéƒ½éƒ½ä¼šæœ‰å¥½çš„æƒ³æ³•ï¼Œä¹Ÿä¼šæœ‰ä¸å¯¹çš„æƒ³æ³•ï¼Œæ¯ä¸ªäººéƒ½éœ€è¦è‡ªç”±è¡¨è¾¾è§‚ç‚¹ã€‚ä½ ä¸éœ€è¦å¾ˆå‡ºè‰²æ‰èƒ½èµ·æ­¥ï¼Œä½†æ˜¯ä½ å¿…é¡»èµ·æ­¥æ‰èƒ½å˜å¾—å¾ˆå‡ºè‰²ã€‚\næœ‰å…³äºå›¢é˜Ÿå†³ç­–çš„æœ‰æ•ˆæ–¹æ³•è®º:\nè®¾å®šæœ€ç»ˆæœŸé™ï¼Œä»¥é˜²æ­¢é™·å…¥æ— ä¼‘æ­¢çš„ç†è®ºäº‰è¾©ã€‚\né€†å‘æ€ç»´ï¼Œå…ˆç§¯æçœ‹åˆ°å®ƒçš„æ­£é¢ï¼Œç„¶ååŠªåŠ›ä»åé¢è®¤è¯†å®ƒã€‚ç›®çš„æ˜¯æ‰¾å‡ºä¼˜ç‚¹æœ€å¤šç¼ºç‚¹æœ€å°‘çš„æ–¹æ¡ˆã€‚\nè®¾ç«‹ä»²è£äººï¼Œé€‰ä¸€ä¸ªä»²è£äººä½œä¸ºæœ¬æ¬¡ä¼šè®®çš„å†³ç­–è€…ã€‚ä»²è£äººåº”è¯¥ä¸“æ³¨äºè°ƒåœï¼Œè€Œä¸æ˜¯å‘è¡¨è‡ªå·±çš„è§‚ç‚¹ï¼Œç†æƒ³æƒ…å†µä¸‹ä¸åº”åœ¨é¡¹ç›®ä¸­æœ‰æ—¢å¾—åˆ©ç›Šã€‚\næ”¯æŒå·²ç»åšå‡ºçš„å†³å®šï¼Œä¸€æ—¦æ–¹æ¡ˆè¢«ç¡®å®šï¼Œå›¢é˜Ÿæˆå‘˜å¿…é¡»é€šåŠ›åˆä½œã€‚ç›®æ ‡æ˜¯è®©é¡¹ç›®æˆåŠŸæ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œå®¢æˆ·å¹¶ä¸å…³å¿ƒè¿™æ˜¯è°çš„ä¸»æ„ï¼Œåªå…³å¿ƒäº§å“æ˜¯å¦ç¬¦åˆä»–ä»¬çš„æœŸæœ›ã€‚\nè®¾è®¡å……æ»¡äº†å¦¥åï¼Œå·¥ä½œè€…ä¸æ„Ÿæƒ…ç”¨äº‹æ˜¯éœ€è¦å…‹åˆ¶åŠ›çš„ï¼Œè‹¥å’±ä»¬èƒ½å±•ç°å‡ºæˆç†Ÿå¤§åº¦æ¥ï¼Œå¤§å®¶ä¸€å®šä¸ä¼šè§†è€Œä¸è§ï¼Œè¿™éœ€è¦æœ‰äººå¸¦å¤´ï¼Œèº«ä½“åŠ›è¡Œï¼Œå»æ„ŸæŸ“å¦ä¸€éƒ¨åˆ†äººã€‚\nä¸­åº¸ä¹‹é“\nå°½åŠ›è´¡çŒ®è‡ªå·±çš„å¥½æƒ³æ³•ï¼Œæ²¡æœ‰è¢«é‡‡çº³ä¹Ÿæ— éœ€è¿‡å¤šæƒ…ç»ªï¼Œä¸è¦å› ä¸ºè¡¨ç°è‡ªå·±çš„æƒ³æ³•è€Œç”»è›‡æ·»è¶³ã€‚\nè„±ç¦»å®é™…çš„åæ–¹è§‚ç‚¹ä¼šä½¿äº‰è®ºå˜å‘³ï¼Œä½ å¾ˆå®¹æ˜“æå‡ºä¸€å †ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„æƒ…å½¢å»æ‰¹é©³å®ƒï¼Œè¿™æ—¶éœ€è¦æ‰ªå¿ƒè‡ªé—®: ç±»å‹é—®é¢˜ä»¥å‰å‘ç”Ÿè¿‡å—? æ˜¯å¦ç»å¸¸å‘ç”Ÿå‘¢?\nã€Œæˆ‘ä»¬ä¸èƒ½é‡‡ç”¨è¿™ä¸ªæ–¹æ¡ˆï¼Œä¸‡ä¸€æ•°æ®åº“å‚å•†å€’é—­.ã€ã€Œç”²æ–¹ç»ä¸å¯¹æ¥æ”¶è¿™ä¸ªæ–¹æ¡ˆã€ï¼Œä¸èƒ½å‡­ç©ºæƒ³è±¡ã€‚\næ’é™¤ä¸‡èƒ½ï¼Œå¥‹å‹‡å‰è¿› è°å»ç»™çŒ«ç³»é“ƒé“›?\nè€é¼ ä»¬æ‰“ç®—åœ¨çŒ«çš„è„–å­ä¸Šç³»ä¸€ä¸ªé“ƒé”€ï¼Œè¿™æ ·çŒ«å·¡é€»é è¿‘çš„æ—¶å€™ï¼Œå°±èƒ½é¢„å…ˆå¾—åˆ°è­¦æŠ¥ã€‚æ¯åªè€é¼ éƒ½ç‚¹å¤´ï¼Œè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªç»å¦™çš„æƒ³æ³•ã€‚è¿™æ—¶ä¸€åªå¹´è€çš„è€é¼ é—®é“ï¼šâ€œé‚£ä¹ˆï¼Œè°æ„¿æ„æŒºèº«è€Œå‡ºå»ç³»é“ƒé“›å‘¢ï¼Ÿâ€æ¯«æ— ç–‘é—®ï¼Œæ²¡æœ‰ä¸€åªè€é¼ ç«™å‡ºæ¥ã€‚å½“ç„¶ï¼Œè®¡åˆ’ä¹Ÿå°±è¿™æ ·æ³¡æ±¤äº†ã€‚\næœ‰æ—¶ï¼Œç»å¦™çš„è®¡åˆ’ä¼šå› ä¸ºå‹‡æ°”ä¸è¶³è€Œæœ€ç»ˆå¤±è´¥ã€‚å°½ç®¡å‰æ–¹å¾ˆå±é™©â€”ä¸ç®¡æ˜¯çœŸçš„é±¼é›·æˆ–è€…åªæ˜¯ä¸€ä¸ªæ¯”å–»â€”â€”ä½ å¿…é¡»æœ‰å‹‡æ°”å‘å‰å†²é”‹ï¼Œåšä½ è®¤ä¸ºå¯¹çš„äº‹æƒ…ã€‚\nå‡å¦‚è¦ä¿®å¤å…¶ä»–äººç¼–å†™çš„ä»£ç ï¼Œå¾ˆè„ä¹±ï¼Œå¾ˆéš¾ç†è§£ï¼Œè¿™æ—¶æ€ä¹ˆåŠ?\nä¹Ÿè®¸ä¼šè·³èµ·æ¥å‘Šè¯‰å‘¨å›´äººï¼Œä»£ç æ˜¯å¤šä¹ˆç³Ÿç³•ï¼Œä½†é‚£åªæ˜¯æŠ±æ€¨å’Œå‘æ³„ï¼Œå¹¶ä¸èƒ½è§£å†³é—®é¢˜ã€‚\nç›¸åï¼Œå’±ä»¬åº”è¯¥é‡å†™è¿™äº›ä»£ç ï¼Œå¹¶æ¯”è¾ƒé‡å†™å‰åçš„ä¼˜ç¼ºç‚¹ï¼ŒåŠ¨æ‰‹è¯æ˜æ˜¯æœ€æœ‰æ•ˆçš„æ–¹å¼ã€‚\nä¸­åº¸ä¹‹é“\nè®¾è®¡æˆ–ä»£ç ä¸­å‡ºç°äº†å¥‡æ€ªçš„é—®é¢˜ï¼ŒèŠ±æ—¶é—´å»ç†è§£ä¸ºä»€ä¹ˆï¼Œå¦‚æœæ¸…æ™°æ˜æœ—éœ€è¦é‡æ„ä»£ç å°±å»åšã€‚ä½†å¦‚æœæ²¡æœ‰é©¬ä¸Šç†è§£é‚£æ®µä»£ç ï¼Œä¸è¦è½»æ˜“åœ°å¦å®šå’Œé‡å†™å®ƒä»¬ï¼Œé‚£ä¸æ˜¯å‹‡æ°”æ˜¯é²è½ã€‚ ã€Œæ›´æ¸…æ™°çš„ä»£ç ã€æ˜¯æ— æ³•æ‰“åŠ¨ç”Ÿæ„äººçš„ï¼ŒèŠ‚çº¦èµ„é‡‘ï¼Œè·å¾—æ›´å¥½çš„æŠ•èµ„å›æŠ¥ç­‰ä¼šè®©è®ºç‚¹æ›´æœ‰è¯´æœåŠ›ã€‚ å­¦æ— æ­¢å¢ƒ é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ã€‚\nè®¸å¤šæ–°æŠ€æœ¯éƒ½åŸºäºç°æœ‰çš„æŠ€æœ¯å’Œæ€æƒ³ï¼Œå®ƒä»¬ä¼šåŠ å…¥ä¸€äº›æ–°çš„ä¸œè¥¿ï¼Œè¿™äº›æ–°ä¸œè¥¿æ˜¯é€æ­¥åŠ çš„é‡ï¼Œå¦‚æœè·Ÿè¸ªæŠ€æœ¯å˜åŒ–ï¼Œé‚£ä¹ˆå­¦ä¹ è¿™äº›æ–°ä¸œè¥¿å°±æ˜¯å¢é‡å˜åŒ–ã€‚\næ•æ·çš„æ ¹æœ¬ä¹‹ä¸€æ˜¯æ‹¥æŠ±å˜åŒ–ï¼Œæ›¾ç»éå¸¸æœ‰ç”¨çš„ä¸œè¥¿å¾€å¾€ä¼šé è¾¹ç«™ï¼Œè¿˜ä¼šé™ä½æ•ˆç‡ã€‚\nåœ¨å­¦ä¹ æ–°çš„ä¸œè¥¿ï¼Œè¦ä¸¢å¼ƒé˜»æ­¢ä½ å‰è¿›çš„æ—§ä¹ æƒ¯ã€‚\nå¦‚ä½•æ‰èƒ½è·Ÿä¸ŠæŠ€æœ¯å˜åŒ–çš„æ­¥ä¼å‘¢?\nè¿­ä»£å’Œå¢é‡å¼çš„å­¦ä¹ ï¼Œæ¯å¤©è®¡åˆ’ç”¨ä¸€ç‚¹æ—¶é—´æ¥å­¦ä¹ æ–°æŠ€æœ¯ã€‚å¬åˆ°ä¸ç†Ÿæ‚‰çš„æœ¯è¯­æˆ–çŸ­è¯­ï¼Œè®°å½•ä¸‹æ¥ï¼Œåœ¨è®¡åˆ’æ—¶é—´æ·±å…¥ç ”ç©¶ã€‚ é€šè¿‡é‚®ä»¶/æŠ€æœ¯åšå®¢/ç¤¾åŒºäº†è§£è¡Œæƒ… é˜…è¯» ä¸­åº¸ä¹‹é“\nä½ ä¸å¯èƒ½ç²¾é€šæ¯ä¸€é¡¹æŠ€æœ¯ï¼Œæ²¡æœ‰å¿…è¦å»åšè¿™æ ·çš„å°è¯•ï¼Œåªè¦åœ¨æŸäº›æ–¹é¢æˆä¸ºä¸“å®¶ï¼Œå°±èƒ½ç”¨åŒæ ·çš„æ–¹æ³•ï¼Œå¾ˆå®¹æ˜“æˆä¸ºæ–°é¢†åŸŸçš„ä¸“å®¶ã€‚ ä½ è¦æ˜ç™½ä¸ºä»€ä¹ˆéœ€è¦è¿™é¡¹æ–°æŠ€æœ¯ï¼Œå®ƒè¯•å›¾è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜? é¿å…ä¸€æ—¶å†²åŠ¨çš„æƒ…å†µä¸‹ï¼Œåªæ˜¯å› ä¸ºæƒ³å­¦ä¹ è€Œå°†åº”ç”¨åˆ‡æ¢åˆ°æ–°çš„æŠ€æœ¯ã€‚åœ¨å†³ç­–æ—¶ï¼Œå¿…é¡»è¯„ä¼°æ–°æŠ€æœ¯çš„ä¼˜åŠ¿ï¼Œå¼€å‘ä¸€ä¸ªå°çš„åŸå‹ç³»ç»Ÿæ˜¯å¯¹ä»˜æŠ€æœ¯ç‹‚çƒ­è€…çš„ä¸€å‰‚è‰¯è¯ã€‚ æ‰“ç ´ç ‚é”…é—®åˆ°åº• åœ¨è®¡ç®—æœºä¸–ç•Œï¼Œå¾ˆå¤šé—®é¢˜ä¼šå½±å“åº”ç”¨ï¼Œä¸ºäº†è§£å†³é—®é¢˜ï¼Œéœ€è¦çŸ¥é“è®¸å¤šå½±å“çš„å› ç´ ã€‚å½“æ‰¾äººè¯¢é—®ä»»ä½•ç›¸å…³é—®é¢˜æ—¶ï¼Œè®©ä»–ä»¬è€å¿ƒå›ç­”ï¼Œè¿™æ˜¯ä½ çš„èŒè´£ã€‚\nä½ çš„é—®é¢˜ç”šè‡³ä¼šå¸®åŠ©ä»–ä»¬ç†æ¸…æ€è·¯ï¼Œä»ä¸€ä¸ªæ–°äººçš„è§’åº¦æå‡ºçš„é—®é¢˜ï¼Œç»™ä»–ä»¬æä¾›äº†ä¸€ä¸ªæ–°çš„è§†è§’ï¼Œä¹Ÿè®¸å°±å¸®åŠ©ä»–ä»¬è§£å†³äº†ä¸€ç›´ä»¤äººå›°æ‰°çš„é—®é¢˜ã€‚\nã€Œå“å‘€ï¼Œåªè¦æ¯å‘¨é‡å¯ä¸€æ¬¡ç³»ç»Ÿï¼Œå°±æ²¡é—®é¢˜äº†ã€\nã€Œä½ å¿…é¡»ä¾æ¬¡æ‰§è¡Œ 3 æ¬¡æ„å»ºæ‰èƒ½å®Œæˆæ„å»ºã€\nã€Œæˆ‘ä»¬çš„ç”¨æˆ·æ ¹æœ¬ä¸æƒ³è¦é‚£ä¸ªåŠŸèƒ½ã€\nçœŸçš„å—? ä¸ºä»€ä¹ˆå‘€? ä¸èƒ½åªæ»¡è¶³äºåˆ«äººå‘Šè¯‰ä½ çš„è¡¨é¢ç°è±¡ï¼Œè¦ä¸åœåœ°æé—®ç›´åˆ°ä½ æ˜ç™½é—®é¢˜çš„æ ¹æºã€‚\nä¸­åº¸ä¹‹é“\nå’±ä»¬å¯èƒ½è·‘é¢˜ï¼Œé—®ä¸€äº›ä¸ä¸»é¢˜æ— å…³çš„é—®é¢˜ï¼Œè¦é—®åˆ°ç‚¹å­ä¸Šã€‚ å½“é—®ä¸ºä»€ä¹ˆçš„æ—¶å€™ï¼Œä¹Ÿè®¸ä¼šè¢«åé—®ï¼Œã€Œä¸ºä»€ä¹ˆä½ é—®è¿™ä¸ªé—®é¢˜ã€ï¼Œåœ¨æé—®ä¹‹å‰ï¼Œæƒ³å¥½æé—®çš„ç†ç”±ï¼Œä¹Ÿè®¸æœ‰åŠ©äºé—®å‡ºæ°å½“çš„é—®é¢˜ã€‚ ã€Œè¿™ä¸ªï¼Œæˆ‘ä¸çŸ¥é“ã€æ˜¯ä¸€ä¸ªå¥½çš„èµ·ç‚¹ã€‚ æŠŠæ¡å¼€å‘èŠ‚å¥ åœ¨è®¸å¤šä¸æˆåŠŸçš„é¡¹ç›®ä¸­ï¼ŒåŸºæœ¬éƒ½æ˜¯éšæ„å®‰æ’å·¥ä½œè®¡åˆ’ï¼Œé‚£æ ·éšæœºå®‰æ’å¾ˆéš¾å¤„ç†ï¼Œæ ¹æœ¬ä¸çŸ¥é“æ˜å¤©å°†ä¼šå‘ç”Ÿä»€ä¹ˆã€‚\nä¸­åº¸ä¹‹é“\næ¯å¤©ç»“æŸçš„æ—¶å€™ï¼Œæµ‹è¯•ä»£ç ï¼Œæäº¤ä»£ç ï¼Œæ²¡æœ‰æ®‹ç•™çš„ä»£ç  ä¸è¦æå¾—ç»å¸¸åŠ ç­ å¦‚æœå¼€å‘èŠ‚å¥è¿‡äºå¯†é›†ï¼Œä¼šç²¾ç–²åŠ›ç«­ æœ‰è§„å¾‹çš„å¼€å‘èŠ‚å¥ä¼šæš´éœ²å¾ˆå¤šé—®é¢˜ äº¤ä»˜ç”¨æˆ·æƒ³è¦çš„è½¯ä»¶ è®©å®¢æˆ·åšå†³å®šã€‚\nå¼€å‘è€…èƒ½åšçš„ä¸€ä¸ªæœ€é‡è¦çš„å†³å®šå°±æ˜¯ï¼Œåˆ¤æ–­å“ªäº›æ˜¯è‡ªå·±å†³å®šä¸äº†çš„ã€‚\nåº”è¯¥è®©ä¸šä¸»åšå†³å®šï¼Œä½ ä¸éœ€è¦è‡ªå·±ç»™ä¸šåŠ¡ä¸Šçš„å…³é”®é—®é¢˜åšå†³å®šã€‚æ¯•ç«Ÿï¼Œé‚£ä¸æ˜¯ä½ çš„äº‹æƒ…ã€‚\nä¸­åº¸ä¹‹é“\nè®°å½•å®¢æˆ·åšå‡ºçš„å†³å®šï¼Œå¹¶æ³¨æ˜åŸå› ï¼Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ ä¸è¦ç”¨ä½çº§åˆ«å’Œæ²¡æœ‰ä»·å€¼çš„é—®é¢˜æ‰“æ‰°ç¹å¿™çš„ä¸šåŠ¡äººå‘˜ ä¸è¦å‡è®¾ä½çº§åˆ«çš„é—®é¢˜ä¸ä¼šå½±å“ä»–ä»¬çš„ä¸šåŠ¡ å¦‚æœä¸šåŠ¡è´Ÿè´£äººå›ç­”æˆ‘ä¸çŸ¥é“ï¼Œå°½ä½ æ‰€èƒ½æä¾›å»ºè®® ä¿æŒå¯ä»¥å‘å¸ƒ åœ¨å›¢é˜Ÿå·¥ä½œï¼Œä¿®æ”¹ä¸€äº›ä¸œè¥¿çš„æ—¶å€™å¿…é¡»å¾ˆè°¨æ…ï¼Œæ—¶åˆ»è­¦æƒ•ï¼Œæ¯æ¬¡æ”¹åŠ¨éƒ½ä¼šå½±å“ç³»ç»Ÿçš„çŠ¶æ€å’Œæ•´ä¸ªå›¢é˜Ÿçš„å·¥ä½œæ•ˆç‡ã€‚\nåœ¨åŠå…¬å®¤ä¸èƒ½å®¹å¿ä»»ä½•äººä¹±ä¸¢åƒåœ¾ï¼Œä¸ºä»€ä¹ˆå°±å¯ä»¥å®¹å¿ä¸€äº›äººç»™é¡¹ç›®å¸¦æ¥åƒåœ¾ä»£ç å‘¢?\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å·¥ä½œæµç¨‹ï¼Œå¯ä»¥é˜²æ­¢ä½ æäº¤ç ´åç³»ç»Ÿçš„ä»£ç ã€‚\nåœ¨æœ¬åœ°è¿è¡Œæµ‹è¯• æ£€å‡ºæœ€æ–°çš„ä»£ç  git pull æäº¤ä»£ç  ææ—©é›†æˆï¼Œé¢‘ç¹é›†æˆ ç»ä¸è¦åšå¤§çˆ†ç‚¸å¼çš„é›†æˆã€‚è¶Šæ—©è§£å†³å®ƒä»¬ï¼Œå·¥ä½œé‡å°±è¶Šå°ã€‚å¦‚æœæ¨è¿Ÿé›†æˆçš„æ—¶é—´ï¼Œè§£å†³è¿™äº›é—®é¢˜å°±ä¼šå˜å¾—å¾ˆéš¾ï¼Œéœ€è¦å¤§é‡å’Œå¤§èŒƒå›´åœ°ä¿®æ”¹ä»£ç ã€‚\nå›ºå®šçš„ä»·æ ¼å°±æ˜¯ä¿è¯è¦èƒŒå›æ‰¿è¯º è½¯ä»¶é¡¹ç›®å¤©ç”Ÿå°±æ˜¯å˜åŒ–æ— å¸¸çš„ï¼Œå¦‚æœè¦æå‰ç»™å‡ºä¸€ä¸ªå›ºå®šçš„å¼€å‘æ—¶é—´ï¼Œå°±å‡ ä¹è‚¯å®šä¸èƒ½éµå®ˆå¼€å‘ä¸Šçš„æ‰¿è¯ºã€‚\né‚£å¦‚ä½•åšåˆ°æ›´ç²¾ç¡®çš„è¯„ä¼°å‘¢? å¯ä»¥è¯•è¯•è¿™æ ·çš„æ–¹æ³•:\nä¸»åŠ¨æè®®å…ˆæ„å»ºç³»ç»Ÿæœ€åˆï¼Œæœ‰ç”¨çš„éƒ¨åˆ†ï¼Œè¿™æ—¶å€™ä¸æ˜¯è¦å®Œæˆæ‰€æœ‰çš„åŠŸèƒ½ï¼Œè€Œæ˜¯è¶³å¤Ÿä¸€æ¬¡äº¤ä»˜ï¼Œå¹¶èƒ½è®©ç”¨æˆ·çœŸæ­£ä½¿ç”¨ï¼Œé€šå¸¸åœ¨ 6~8 å‘¨ã€‚ ç¬¬ä¸€æ¬¡è¿­ä»£ç»“æŸï¼Œå®¢æˆ·æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œå¯ä»¥æ–°å¢åŠŸèƒ½ç»§ç»­ä¸‹ä¸€ä¸ªäº¤ä»˜ï¼Œè¦ä¹ˆå–æ¶ˆåˆåŒï¼Œä»…éœ€æ”¯ä»˜ç¬¬ä¸€ä¸ªè¿­ä»£çš„è´¹ç”¨ã€‚ å¦‚ä½•ç»§ç»­å‰è¿›ï¼Œè¿™æ—¶æ ¹æ®æå‡ºçš„å¢é‡åŠŸèƒ½ï¼Œåº”è¯¥å°±å¯ä»¥å¾ˆå¥½é¢„æµ‹ä¸‹ä¸€ä¸ªè¿­ä»£å·¥ä½œã€‚ æ•æ·åé¦ˆ ç¼–å†™èƒ½äº§ç”Ÿåé¦ˆçš„ä»£ç ï¼Œé€šè¿‡å•å…ƒæµ‹è¯•æ¥è·å–åé¦ˆã€‚\nç¡®ä¿æµ‹è¯•æ˜¯å¯é‡å¤çš„ï¼Œä½¿ç”¨å½“å‰æ—¶é—´/æœºå™¨å›ºå®š IP ç­‰éƒ½æ˜¯ä½¿å…¶ä¾èµ–è¿è¡Œæ—¶çš„æœºå™¨ æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼Œæ¯”å¦‚æ—¥æœŸ 11:59:59/0:00:00ï¼Œæ¯”å¦‚æœˆä»½ 0 / 13 / -1 ä¸è¦æ”¾è¿‡ä»»ä½•å¤±è´¥çš„æµ‹è¯• ä¸€æ—¦å•å…ƒæµ‹è¯•åˆ°ä½ï¼Œé‡‡ç”¨è¿™æ ·çš„å›å½’æµ‹è¯•ï¼Œå°±å¯ä»¥éšæ„é‡æ„ä»£ç ã€‚å•å…ƒæµ‹è¯•ä¼šç¡®ä¿ä½ ä¸ä¼šæ„å¤–åœ°ç ´åä»»ä½•åŠŸèƒ½ã€‚\nå¦‚æœä½ ä»ç„¶åœ¨å¯»æ‰¾å¼€å§‹å•å…ƒæµ‹è¯•çš„ç†ç”±ï¼Œä¸‹é¢æœ‰å¾ˆå¤š:\nå•å…ƒæµ‹è¯•èƒ½åŠæ—¶æä¾›åé¦ˆ å•å…ƒæµ‹è¯•è®©ä½ çš„ä»£ç æ›´ä½³å¥å£® å•å…ƒæµ‹è¯•æ˜¯æœ‰ç”¨çš„è®¾è®¡å·¥å…· å•å…ƒæµ‹è¯•æ˜¯è®©ä½ è‡ªä¿¡çš„åå° å•å…ƒæµ‹è¯•æ˜¯è§£å†³é—®é¢˜æ—¶çš„æ¢æµ‹å™¨ å•å…ƒæµ‹è¯•æ˜¯å¯ä¿¡çš„æ–‡æ¡£ å•å…ƒæµ‹è¯•æ˜¯å­¦ä¹ å·¥å…· å…ˆç”¨å®ƒå†å®ç°å®ƒ åœ¨è¯´æœä»–äººä½¿ç”¨å®ƒä¹‹å‰ï¼Œå…ˆå¾—è®©è‡ªå·±åˆ‡å®çš„ä½¿ç”¨äº§å“ã€‚\nå…ˆå†™æµ‹è¯•ï¼Œä½ å°±ä¼šç«™åœ¨ä»£ç ç”¨æˆ·çš„è§’åº¦æ¥æ€è€ƒï¼Œè€Œä¸ä»…ä»…æ˜¯å•çº¯çš„å®ç°ã€‚\nä½ ä¼šå‘ç°å› ä¸ºä½ è‡ªå·±è¦ä½¿ç”¨å®ƒä»¬ï¼Œæ‰€ä»¥èƒ½è®¾è®¡ä¸€ä¸ªæ›´æœ‰ç”¨ï¼Œæ›´ä¸€è‡´çš„æ¥å£ã€‚\nå…ˆå†™æµ‹è¯•æœ‰åŠ©äºæ¶ˆé™¤å¤æ‚çš„è®¾è®¡ï¼Œè®©ä½ å¯ä»¥ä¸“æ³¨äºçœŸæ­£éœ€è¦å®Œæˆçš„å·¥ä½œã€‚\nä¸¾ä¸€ä¸ªç¼–ç¨‹ä¾‹å­ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥ä¸¤ä¸ªäººç©çš„ã€Œäº•å­—æ——ã€ æ¸¸æˆ:\nå¼€å§‹ï¼Œä¼šæ€è€ƒå¦‚ä½•ä¸ºè¿™ä¸ªæ¸¸æˆåšä»£ç è®¾è®¡ï¼Œä¹Ÿè®¸ä¼šè€ƒè™‘åˆ°éœ€è¦è¿™äº›ç±»ï¼Œæ£‹ç›˜/è¡Œåˆ—/ç”¨æˆ·/è§„åˆ™/ç­‰ã€‚\né¦–å…ˆå†™æ£‹ç›˜çš„æµ‹è¯•ï¼Œç±»ä¼¼äºè¿™æ ·\n1 2 3 4 5 func TestBoard(t *testint.T) { s := NewBoard() request.NoNil(t,s) request.IsFalse(t,s.GameOver) } æ­¤æ—¶æ‰§è¡Œæµ‹è¯•åº”è¯¥æ˜¯å¤±è´¥çš„ï¼Œå› ä¸ºç»“æ„ä½“ board è¿˜ä¸å­˜åœ¨ï¼Œéœ€è¦å®ç°è¿™ä¸ªç»“æ„ä½“ã€‚\n1 2 3 4 5 6 7 type Board struct{ GameOver bool } func NewBoard() *Board{ return \u0026amp;Board{} } æ­¤æ—¶å†æ‰§è¡Œæµ‹è¯•ï¼Œä»¥ä¿è¯æµ‹è¯•é€šè¿‡ï¼Œä¸é€šè¿‡è¯çš„ä¿®æ”¹ç›´åˆ°é€šè¿‡ã€‚\nä¸‹ä¸€æ­¥ï¼Œå¿…é¡»å†³å®šè°å…ˆå¼€å§‹èµ°ç¬¬ä¸€æ­¥æ£‹ï¼Œéœ€è¦è®¾ç¬¬ä¸€ä¸ªæ¯”èµ›è€…ï¼Œå†™ä¸‹ç›¸å…³æµ‹è¯•\n1 2 3 func TestSetFirstPlayer(){ // test content } è¿™æ—¶ï¼Œæµ‹è¯•ä¼šè¿«ä½¿ä½ å†³å®šå¦‚ä½•åœ¨ä»£ç ä¸­è¡¨ç¤ºæ¯”èµ›è€…ï¼Œå¹¶åˆ†é…åˆ°æ£‹ç›˜ä¸Šã€‚\nå¯èƒ½æ˜¯è¿™æ ·çš„\n1 2 # ç©å®¶ mark ä½¿ç”¨ X board.SetFirstPlayer(new Player(\u0026#34;Mark\u0026#34;), \u0026#34;X\u0026#34;) ä½†çœŸçš„éœ€è¦ player è¿™ä¸ªç»“æ„ä½“å—? æˆ–è€…éœ€è¦ç©å®¶çš„åå­—å—? æ­¤æ—¶è¿˜æ²¡æœ‰å®ç° SetFirstPlayer æ–¹æ³•ï¼ŒåˆæœŸè®©æˆ‘ä»¬çš„æµ‹è¯•æ›´ç®€å•ä¸€äº›ï¼Œæ¯”å¦‚\n1 board.SetFirstPlayer(\u0026#34;X\u0026#34;) è¿™ä¸ªç‰ˆæœ¬éšè—ç€é£é™©ï¼Œå¯ä»¥ä¼ é€’ä»»ä½•å­—æ¯ç»™ SetFirstPlayerï¼Œæ„å‘³ç€éœ€è¦æ·»åŠ ä»£ç æ¥æ£€æŸ¥å‚æ•°çš„æ­£ç¡®æ€§ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ï¼Œç”¨ä¸€ä¸ª bool æ¥è¡¨ç¤ºç¬¬ä¸€ä¸ªç©å®¶æ˜¯ O è¿˜æ˜¯ xã€‚\nä¾‹å¦‚è¿™æ ·\n1 2 3 4 func TestSetFirstPlayer(){ board.FirstPlayerPegIsX = true; requests.IsTrue(board.FirstPlayerPegIsX) } æˆ‘ä»¬çš„æ€è€ƒæ˜¯ä» player ç±»å¼€å§‹ï¼Œæœ€åå®ç°åªç”¨äº†ç®€å•çš„å¸ƒå°”ç±»å‹å±æ€§ï¼Œæˆ‘ä»¬ä¸æ˜¯è¦æ‰”æ‰å¥½çš„è®¾è®¡ï¼Œä»…ä»…ç”¨å¤§é‡çš„å¸ƒå°”ç±»å‹æ¥ç¼–ç æ‰€æœ‰ä¸œè¥¿ï¼Œè€Œæ˜¯æˆåŠŸåœ°å®ç°ç‰¹å®šåŠŸèƒ½çš„æœ€ä½æˆæœ¬ã€‚ç¨‹åºå‘˜å¾ˆå®¹æ˜“èµ°å‘å¦ä¸€ä¸ªæç«¯ï¼Œä¸€äº›ä¸å¿…è¦è¿‡äºå¤æ‚çš„äº‹æƒ…ã€‚\næ¶ˆé™¤è¿˜æ²¡æœ‰ç¼–å†™å¥½çš„ç±»ï¼Œè¿™ä¼šå¾ˆå®¹æ˜“ç®€åŒ–ä»£ç ï¼Œç›¸åï¼Œä¸€æ—¦å·²ç»ç¼–å†™äº†ä»£ç ï¼Œä¹Ÿè®¸ä¼šå¼ºè¿«è‡ªå·±ä¿ç•™è¿™äº›ä»£ç ï¼Œå¹¶ç»§ç»­ä½¿ç”¨å®ƒã€‚\nå¥½çš„è®¾è®¡å¹¶ä¸æ„å‘³ç€éœ€è¦æ›´å¤šçš„ç±»\næ·»åŠ æ— ç”¨çš„ä»£ç æ€»æ˜¯ä¸å¥½çš„æƒ³æ³•ï¼Œä¸ç®¡ä»–ä»¬æ˜¯å¦çœŸçš„éœ€è¦ï¼ŒTDD æœ‰æœºä¼šè®©ä½ ç¼–å†™ä»£ç ä¹‹å‰ï¼Œå¯ä»¥æ·±æ€ç†Ÿè™‘å°†å¦‚ä½•ä½¿ç”¨å®ƒã€‚è¿™ä¼šè¿«ä½¿ä½ å»æ€è€ƒå®ƒçš„å¯ç”¨æ€§å’Œä¾¿åˆ©æ€§ï¼Œè®©ä½ çš„è®¾è®¡æ›´æ³¨é‡å®æ•ˆã€‚\nè®¾è®¡å¹¶ä¸æ˜¯å¼€å§‹ç¼–ç çš„æ—¶å€™å°±ç»“æŸäº†ï¼Œéœ€è¦åœ¨äº§å“çš„ç”Ÿå‘½å‘¨æœŸä¸­æŒç»­æ·»åŠ æµ‹è¯•ï¼Œæ·»åŠ ä»£ç ï¼Œé‡æ–°è®¾è®¡ã€‚\nä¸­åº¸ä¹‹é“\nä¸è¦æŠŠæµ‹è¯•ä»£ç å’Œæäº¤ä»£ç ä¹‹å‰çš„æµ‹è¯•ç­‰åŒï¼Œå•å…ƒæµ‹è¯•å¯ä»¥ä¿è¯ä»£ç çš„å¥å£®æ€§ï¼Œæäº¤ä»£ç å‰çš„åŠŸèƒ½æµ‹è¯•å¯ä»¥ä¿è¯äº§å“çš„ç¨³å®šæ€§ã€‚ ä»»ä½•ä¸€ä¸ªè®¾è®¡éƒ½å¯ä»¥è¢«æ”¹è¿› å•çº¯çš„å•å…ƒæµ‹è¯•æ— æ³•ä¿è¯å¥½çš„è®¾è®¡ï¼Œä½†ä»–ä»¬å›åˆ°è®¾è®¡æœ‰æ‰€å¸®åŠ©ï¼Œä½¿è®¾è®¡æ›´ä½³ç®€å•ã€‚ ä¸åŒç¯å¢ƒï¼Œå°±æœ‰ä¸åŒé—®é¢˜ ä½ çš„åº”ç”¨ç¨‹åºè¦åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œæˆ–è€…ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„ä¸åŒç‰ˆæœ¬ï¼Œå°±éœ€è¦æµ‹è¯•æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿã€‚\nä¸åŒç¯å¢ƒå°±æœ‰ä¸åŒçš„é—®é¢˜ï¼Œä½¿ç”¨æŒç»­é›†æˆå·¥å…·ï¼Œåœ¨æ¯ä¸€ç§æ”¯æŒçš„å¹³å°å’Œç¯å¢ƒä¸­è¿è¡Œå•å…ƒæµ‹è¯•ã€‚è¦ç§¯æåœ°å¯»æ‰¾é—®é¢˜ï¼Œè€Œä¸æ˜¯ç­‰é—®é¢˜æ¥æ‰¾ä½ ã€‚\n","date":"2023-01-19T00:00:00Z","permalink":"https://blog.golang.space/p/%E6%95%8F%E6%8D%B7%E4%B9%8B%E9%81%93-%E4%B8%8A/","title":"æ•æ·ä¹‹é“ (ä¸Š)"},{"content":"JSON JSON charset web å“åº”è¦æŒ‡å®š Content-Typeï¼Œä½ å¯èƒ½è§è¿‡ Content-Type: application/json; charset=utf-8\nåœ¨ RFC ä¸­æŒ‡å‡º:\nJSON text exchanged between systems that are not part of a closed ecosystem MUST be encoded using UTF-8.\né¢å‘å…¬ä¼—çš„åº”ç”¨ç¨‹åºå¿…é¡»å§‹ç»ˆé‡‡ç”¨ UTF-8 ç¼–ç ï¼Œæ‰€ä»¥ä¸éœ€è¦æ ‡æ³¨å­—ç¬¦é›†ï¼ŒContent-Type: application/json å³å¯\nJSON encode time.Time å€¼å°†ä¼šè¢«ç¼–ç ä¸º RFC 3339 æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚\u0026quot;2020-11-08T06:27:59+01:00\u0026quot; []byte åˆ‡ç‰‡å°†è¢«ç¼–ç ä¸º base64 å­—ç¬¦ä¸² æ— æ³•å¯¹ channel/function/complex è¿›è¡Œç¼–ç ï¼Œå¦‚æœè¿™æ ·åšï¼Œåœ¨è¿è¡Œæ—¶å°†ä¼šå¾—åˆ° json.UnsupportedTypeErrorçš„é”™è¯¯ ä»»æ„æŒ‡é’ˆéƒ½ç¼–ç ä¸ºæŒ‡å‘çš„å€¼ å¦‚æœä½ æœ‰ä¸€ä¸ª io.Writer ï¼Œå¯ä»¥ä½¿ç”¨ err := json.NewEncoder(w).Encode(data) ç›´æ¥å†™å…¥ã€‚\njson.Encoder å’Œ json.Marshal() æ€§èƒ½å·®å¼‚ json.Marshal() æ¯” json.Encoder å¤šä¸€æ¬¡å †å†…å­˜åˆ†é…ã€‚\nåµŒå¥—ç»“æ„ä½“åºåˆ—åŒ–ä¸ä¼š omitempty 1 2 3 4 5 type A struct{ b struct{ Bar string `json:\u0026#34;,omitempty\u0026#34;` } `json:\u0026#34;,omitempty\u0026#34;` } ç»“æ„ä½“ä¸ºå€¼ç±»å‹ï¼Œä¸å­˜åœ¨ nil çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸ä¼š omitemptyã€‚\nå¦‚æœéœ€è¦çœç•¥ï¼Œå»ºè®®æ›¿æ¢æˆ pointerã€‚\nè½¬ä¹‰å­—ç¬¦ å¦‚æœå­—ç¬¦ä¸²ä¸­åŒ…å« \u0026lt;\u0026gt;\u0026amp; å­—ç¬¦ï¼Œå°†ä¼šè½¬ä¹‰æˆ unicodeï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢æŸäº› web æµè§ˆå™¨æ„å¤–è§£é‡Š JSON å“åº”ä¸º HTMLï¼Œå¦‚æœä¸éœ€è¦è½¬ä¹‰ï¼Œä½¿ç”¨ json.Encoder SetEscapeHTML(false) æ‰§è¡Œç¼–ç ã€‚\nè½¬ä¹‰å­—ç¬¦ unicode \u0026lt; \\u003c \u0026gt; \\u003e \u0026amp; \\u0026 åˆ é™¤ float å°æ•°ç‚¹æœ«å°¾çš„ 0 1 2 3 4 5 s := []float64{ 123.0, 456.100, 789.990, } ç¼–ç åå°†å¾—åˆ°\n1 [123,456.1,789.99] é¢„ç¼–ç  JSON å¦‚æœä½ æœ‰ä¸€ä¸ªåŒ…å«é¢„ç¼–ç çš„ string æˆ–è€… []byteï¼Œä½¿ç”¨ JSON tag å°†ä¼šè¢«è½¬ä¹‰å¹¶ç¼–ç ä¸º json å­—ç¬¦ä¸²\n1 2 3 4 5 m := struct { Person string }{ Person: `{\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 21}`, } ç¼–ç åå¾—åˆ°\n1 {\u0026#34;Person\u0026#34;:\u0026#34;{\\\u0026#34;name\\\u0026#34;: \\\u0026#34;Alice\\\u0026#34;, \\\u0026#34;age\\\u0026#34;: 21}\u0026#34;} å¦‚æœæƒ³æ’å…¥ JSON è€Œé JSON å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨ json.RawMessage\n1 2 3 4 5 m := struct { Person json.RawMessage }{ Person: json.RawMessage(`{\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 21}`), } ç¼–ç åå¾—åˆ°\n1 {\u0026#34;Person\u0026#34;:{\u0026#34;name\u0026#34;:\u0026#34;Alice\u0026#34;,\u0026#34;age\u0026#34;:21}} ä½¿ç”¨ json.RawMessage è¦ç¡®ä¿é¢„ç¼–ç çš„å€¼æ˜¯æœ‰æ•ˆçš„ JSONï¼Œå¦åˆ™ä¼šå‡ºé”™ã€‚å¦‚æœéœ€è¦åœ¨è¿è¡Œæ—¶æ£€æŸ¥ JSON æ˜¯å¦æœ‰æ•ˆï¼Œå¯ä»¥ä½¿ç”¨ json.Valid() å‡½æ•°\nMarshalText å¦‚æœç±»å‹æœ‰æ²¡æœ‰ MarshalJSON() æ–¹æ³•ï¼Œä½†æ˜¯æœ‰ MarshalText() æ–¹æ³•ï¼Œä»¥å®ç° encoding.TextMarshaler æ¥å£ï¼Œä½¿ç”¨ JSON ç¼–ç å°†ä¼šæ˜¾ç¤º json å­—ç¬¦ä¸²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 type myFloat float64 func (f myFloat) MarshalText() ([]byte, error) { return []byte(fmt.Sprintf(\u0026#34;%.2f\u0026#34;, f)), nil } func main() { f := myFloat(1.0/3.0) js, err := json.Marshal(f) if err != nil { log.Fatal(err) } fmt.Printf(\u0026#34;%s\u0026#34;, js) } å®ƒå°†ä¼šæ‰“å°ç”± MarshalText() å‡½æ•°è¿”å›çš„ JSON å­—ç¬¦ä¸²\n1 0.33 MarshalJSON çš„æ¥æ”¶å™¨ å½“è‡ªå®šä¹‰ç±»å‹å®ç°äº† MarshalJSON()ï¼Œå¹¶ä½¿ç”¨ pointer æ¥æ”¶å™¨æ—¶ï¼Œä»…ä¼ é€’æŒ‡é’ˆæ—¶å‡½æ•°æœ‰æ•ˆã€‚\nå…³äºæ¥æ”¶å™¨çš„æŒ‡é’ˆä¸å€¼çš„è§„åˆ™æ˜¯:\nå€¼æ–¹æ³•å¯ä»¥ç”¨æŒ‡é’ˆæˆ–å€¼è°ƒç”¨ï¼Œä½†æŒ‡é’ˆæ–¹æ³•åªèƒ½åœ¨æŒ‡é’ˆä¸Šè°ƒç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 type myFloat float64 // This has a pointer receiver. func (f *myFloat) MarshalJSON() ([]byte, error) { return []byte(fmt.Sprintf(\u0026#34;%.2f\u0026#34;, *f)), nil } func main() { f := myFloat(1.0 / 3.0) // When encoding a value, the MarshalJSON method is used. // å¾—åˆ° 0.33 js, err := json.Marshal(\u0026amp;f) if err != nil { log.Fatal(err) } fmt.Printf(\u0026#34;%s\\n\u0026#34;, js) // When encoding a value, the MarshalJSON method is ignored. // å¾—åˆ°é»˜è®¤çš„ 0.3333333333333333 js, err = json.Marshal(f) if err != nil { log.Fatal(err) } fmt.Printf(\u0026#34;%s\u0026#34;, js) } éƒ¨åˆ† JSON è§£ç  å¦‚æœä½ åªéœ€è¦å¤„ç† JSON ä¸­çš„ä¸€å°éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // Let\u0026#39;s say that the only thing we\u0026#39;re interested in is processing the \u0026#34;genres\u0026#34; array in // the following JSON object js := `{\u0026#34;title\u0026#34;: \u0026#34;Top Gun\u0026#34;, \u0026#34;genres\u0026#34;: [\u0026#34;action\u0026#34;, \u0026#34;romance\u0026#34;], \u0026#34;year\u0026#34;: 1986}` // Decode the JSON object to a map[string]json.RawMessage type. The json.RawMessage // values in the map will retain their original, un-decoded, JSON values. var m map[string]json.RawMessage err := json.NewDecoder(strings.NewReader(js)).Decode(\u0026amp;m) if err != nil { log.Fatal(err) } // We can then access the JSON \u0026#34;genres\u0026#34; value from the map and decode it as normal using // the json.Unmarshal() function. var genres []string err = json.Unmarshal(m[\u0026#34;genres\u0026#34;], \u0026amp;genres) if err != nil { log.Fatal(err) } fmt.Printf(\u0026#34;genres: %v\\n\u0026#34;, genres) è§£ç åå¾—åˆ°\n1 genres: [action romance] è§£ç æˆä»»æ„ç±»å‹ è§£ç æˆä»»æ„ç±»å‹åœ¨ä»¥ä¸‹æƒ…å†µå¾ˆæœ‰ç”¨\näº‹å…ˆä¸çŸ¥é“è§£ç çš„æ˜¯ä»€ä¹ˆ éœ€è¦è§£ç åŒ…å«ä¸åŒç±»å‹çš„çš„ array/map æ•°å­—è§£ç åˆ°ä»»æ„ç±»å‹æ—¶ï¼Œä¸º float64 ï¼Œå³ä½¿å®ƒæ˜¯æ•´æ•°ã€‚\nå¦‚æœæƒ³è·å¾—æ•´æ•°å½¢å¼(è€Œé float64)ï¼Œåº”è¯¥åœ¨ json.Decoder å®ä¾‹ä½¿ç”¨ UseNumber() æ–¹æ³•ï¼Œå°†ä¼šå¯¼è‡´è§£ç ä¸º json.Number ç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 js := `10` var n any dec := json.NewDecoder(strings.NewReader(js)) dec.UseNumber() // Call the UseNumber() method on the decoder before using it. err := dec.Decode(\u0026amp;n) if err != nil { log.Fatal(err) } // Type assert the any value to a json.Number, and then call the Int64() method // to get the number as a Go int64. nInt64, err := n.(json.Number).Int64() if err != nil { log.Fatal(err) } // Likewise, you can use the String() method to get the number as a Go string. nString := n.(json.Number).String() fmt.Printf(\u0026#34;type: %T; value: %v\\n\u0026#34;, n, n) fmt.Printf(\u0026#34;type: %T; value: %v\\n\u0026#34;, nInt64, nInt64) fmt.Printf(\u0026#34;type: %T; value: %v\\n\u0026#34;, nString, nString) out:\n1 2 3 type: json.Number; value: 10 type: int64; value: 10 type: string; value: 10 struct tag æŒ‡ä»¤ æŒ‡ä»¤ è¯´æ˜ å¤‡æ³¨ json:\u0026quot;-\u0026quot; ç¼–è§£ç æ—¶å¿½ç•¥( å±æ€§åé¦–å­—æ¯å°å†™ä¹Ÿå¯ä»¥å¿½ç•¥ ) json:\u0026quot;,omitempty\u0026quot; è§£ç æ—¶ä¸ºé›¶å€¼åˆ™å¿½ç•¥ åµŒå¥—ç»“æ„ä½“æ— æ•ˆ json:\u0026quot;,omitempty,string\u0026quot; ä»¥å­—ç¬¦ä¸²ç±»å‹ç¼–è§£ç  é€‚ç”¨äºæ•°å­—/å¸ƒå°”/æ•°å­—æŒ‡é’ˆç±»å‹ è‡ªå®šä¹‰ç¼–ç  æ–¹æ³•ä¸€\nåœ¨ MarshalJSON ä¸­å®šä¹‰ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œå¯¹å…¶ç¼–ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 // Note that there are no struct tags on the Movie struct itself. type Movie struct { ID int64 CreatedAt time.Time Title string Year int32 Runtime int32 Genres []string Version int32 } // Implement a MarshalJSON() method on the Movie struct, so that it satisfies the // json.Marshaler interface. func (m Movie) MarshalJSON() ([]byte, error) { // Declare a variable to hold the custom runtime string (this will be the empty // string \u0026#34;\u0026#34; by default). var runtime string // If the value of the Runtime field is not zero, set the runtime variable to be a // string in the format \u0026#34;\u0026lt;runtime\u0026gt; mins\u0026#34;. if m.Runtime != 0 { runtime = fmt.Sprintf(\u0026#34;%d mins\u0026#34;, m.Runtime) } // Create an anonymous struct to hold the data for JSON encoding. This has exactly // the same fields, types and tags as our Movie struct, except that the Runtime // field here is a string, instead of an int32. Also notice that we don\u0026#39;t include // a CreatedAt field at all (there\u0026#39;s no point including one, because we don\u0026#39;t want // it to appear in the JSON output). aux := struct { ID int64 `json:\u0026#34;id\u0026#34;` Title string `json:\u0026#34;title\u0026#34;` Year int32 `json:\u0026#34;year,omitempty\u0026#34;` Runtime string `json:\u0026#34;runtime,omitempty\u0026#34;` // This is a string. Genres []string `json:\u0026#34;genres,omitempty\u0026#34;` Version int32 `json:\u0026#34;version\u0026#34;` }{ // Set the values for the anonymous struct. ID: m.ID, Title: m.Title, Year: m.Year, Runtime: runtime, // Note that we assign the value from the runtime variable here. Genres: m.Genres, Version: m.Version, } return json.Marshal(aux) } æ–¹æ³•äºŒ\nåµŒå…¥åˆ«åï¼Œä¸ºç»“æ„ä½“è®¾ç½®åˆ«åï¼Œä»¥é¿å…åºåˆ—åŒ–æ­»å¾ªç¯ã€‚\nç”¨ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼ŒåŒ¿ååµŒå¥—ä¸Šé¢çš„åˆ«åï¼Œå¹¶åœ¨æ–°ç»“æ„ä½“é‡Œè®¾ç½®åŒåå‚æ•°ä»¥è¦†ç›–ã€‚\nç¼ºç‚¹:\nå°†å¤±å»ç¼–ç åçš„é¡ºåºï¼Œå¦‚æœä½ çš„åº”ç”¨åœºæ™¯éœ€è¦å›ºå®šé¡ºåºï¼Œå¦‚å¯¹ JSON æ±‚ MD5ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // Notice that we use the - directive on the Runtime field, so that it never appears // in the JSON output. type Movie struct { ID int64 `json:\u0026#34;id\u0026#34;` CreatedAt time.Time `json:\u0026#34;-\u0026#34;` Title string `json:\u0026#34;title\u0026#34;` Year int32 `json:\u0026#34;year,omitempty\u0026#34;` Runtime int32 `json:\u0026#34;-\u0026#34;` Genres []string `json:\u0026#34;genres,omitempty\u0026#34;` Version int32 `json:\u0026#34;version\u0026#34;` } func (m Movie) MarshalJSON() ([]byte, error) { // Create a variable holding the custom runtime string, just like before. var runtime string if m.Runtime != 0 { runtime = fmt.Sprintf(\u0026#34;%d mins\u0026#34;, m.Runtime) } // Define a MovieAlias type which has the underlying type Movie. Due to the way that // Go handles type definitions (https://golang.org/ref/spec#Type_definitions) the // MovieAlias type will contain all the fields that our Movie struct has but, // importantly, none of the methods. type MovieAlias Movie // Embed the MovieAlias type inside the anonymous struct, along with a Runtime field // that has the type string and the necessary struct tags. It\u0026#39;s important that we // embed the MovieAlias type here, rather than the Movie type directly, to avoid // inheriting the MarshalJSON() method of the Movie type (which would result in an // infinite loop during encoding). aux := struct { MovieAlias Runtime string `json:\u0026#34;runtime,omitempty\u0026#34;` }{ MovieAlias: MovieAlias(m), Runtime: runtime, } return json.Marshal(aux) } è§£ç ç±»å‹ JSON type Supported Go types boolean bool string string number int*,uint*,float*,rune array array,slice object struct, map JSON é”™è¯¯åˆ†ç±» å¯¹äºé¢å‘å…¬ä¼—çš„ APIï¼Œé”™è¯¯æ¶ˆæ¯æœ¬èº«å¹¶ä¸ç†æƒ³ã€‚æœ‰äº›ä»¤äººå›°æƒ‘ä¸”éš¾ä»¥ç†è§£ï¼Œæˆ–æš´éœ²äº†åº•å±‚ API ç»†èŠ‚ä¿¡æ¯ã€‚\nDecode æ–¹æ³•ï¼Œå¯èƒ½ä¼šè¿”å› 5 ç§ç±»å‹çš„é”™è¯¯\nError types åŸå›  json.SyntaxError json è¯­æ³•å­˜åœ¨é—®é¢˜ io.ErrUnexpectedEOF json è¯­æ³•å­˜åœ¨é—®é¢˜ json.UnmarshalTypeError JSON å€¼ä¸é€‚ç”¨äºç›®æ ‡ Go ç±»å‹ã€‚ json.InvalidUnmarshalError è§£ç ç›®æ ‡æ— æ•ˆï¼Œé€šå¸¸å› ä¸ºå®ƒä¸æ˜¯æŒ‡é’ˆï¼Œè¿™å®é™…ä¸Šæ˜¯ç¨‹åºä»£ç çš„é—®é¢˜ io.EOF json ä¸ºç©º ååºåˆ—æ—¶æƒ³å¯¹éƒ¨åˆ†å­—æ®µä¸èµ‹å€¼ å®¢æˆ·ç«¯ä¼ é€’çš„ json æ˜¯æ— æ³•æ§åˆ¶çš„ã€‚\nä½ å¯ä»¥åœ¨ååºåˆ—åŒ–åå¯¹æŒ‡å®šå­—æ®µç½®é›¶ï¼Œä½†è¿™æ˜¾å¾—æœ‰ç‚¹ç¬¨æ‹™ï¼Œå¦‚æœç»“æ„ä½“å¢åŠ äº†å­—æ®µä½†å¿˜è®°ååºåˆ—åŒ–åç½®é›¶ï¼Œè¿™æ ·çš„å†™æ³•ä¼šç»™æœªæ¥ç•™ä¸‹æŠ€æœ¯æ ˆã€‚\nå»ºè®®æ–°å»ºä¸€ä¸ªç»“æ„ä½“ç”¨äºåºåˆ—åŒ–ï¼Œæ—¶å€™èµ‹å€¼ç»™æŒ‡å®šç»“æ„ä½“ã€‚å¦‚:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type User struct{ Name string Age int } func main(){ var input struct{ Name string } s := `{\u0026#34;name\u0026#34;:\u0026#34;Nacy\u0026#34;}` if err := json.UnmarshalJSON([]byte(s), \u0026amp;input);err!=nil{ panic(err) } user := User{ Name: input.Name, } _ = user } å‚è€ƒ æ­¤æ–‡ç« å†…å®¹ä¸º Let\u0026rsquo;s Go Further è¯»ä¹¦ç¬”è®°\n","date":"2023-01-12T16:11:45Z","permalink":"https://blog.golang.space/p/json/","title":"JSON"},{"content":"FFmpeg åŸºç¡€çŸ¥è¯† ffmpeg å¤„ç†æµç¨‹ ä»ä¸€ç§ç¼–ç è½¬æ¢åˆ°å¦ä¸€ç§ç¼–ç ã€‚\nåŸºæœ¬ä¿¡æ¯æŸ¥è¯¢å‘½ä»¤ å‘½ä»¤ è¯´æ˜ å‘½ä»¤ è¯´æ˜ -version ç‰ˆæœ¬ -formats æ˜¾ç¤ºå¯ç”¨çš„æ ¼å¼ -demuxers æ˜¾ç¤ºå¯ç”¨çš„ demuxers -protocols æ˜¾ç¤ºå¯ç”¨çš„åè®® -muxers æ˜¾ç¤ºå¯ç”¨çš„ muxers -filters æ˜¾ç¤ºå¯ç”¨çš„è¿‡æ»¤å™¨ -devices æ˜¾ç¤ºå¯ç”¨çš„è®¾å¤‡ -pix_fmts æ˜¾ç¤ºå¯ç”¨çš„åƒç´ æ ¼å¼ -decoders æ˜¾ç¤ºå¯ç”¨çš„è§£ç å™¨ -layouts æ˜¾ç¤º channel åç§° -encoders æ˜¾ç¤ºæ‰€æœ‰ç¼–ç å™¨ -colors æ˜¾ç¤ºè¯†åˆ«çš„é¢œè‰²åç§° -bsfs æ˜¾ç¤ºæ¯”ç‰¹ç‡ filter D è¡¨ç¤ºè§£ç å™¨ E è¡¨ç¤ºç¼–ç å™¨ å½•åˆ¶å‘½ä»¤ ä½¿ç”¨ ffmpeg å½•åˆ¶å±å¹•\n1 ffmpeg -f avfoundation -r 30 -i 2 out.yuv -f: æŒ‡å®šä½¿ç”¨ avfoundation é‡‡é›†æ•°æ®ï¼Œmac ä¸‹ä¸“ç”¨äºéŸ³è§†é¢‘å¤„ç† -i: æŒ‡å®šä»å“ªå„¿é‡‡é›†è¾“å…¥ï¼Œæ˜¯ä¸€ä¸ªæ–‡ä»¶ç´¢å¼•å· -r: æŒ‡å®šå¸§ç‡ ä½¿ç”¨ ffplay æ’­æ”¾è§†é¢‘\n1 ffplay -video_size 2560x1440 -pixel_format uyvy422 out.yuv -video_size: yuv ä¸­ä¸åŒ…å«è§†é¢‘å¤§å°ï¼Œéœ€è¦æŒ‡å®šå°ºå¯¸ï¼Œåœ¨ä¸Šé¢å½•åˆ¶æ—¶å°±å·²ç»™å®šã€‚ -pixel_format: æ’­æ”¾å¸§æ ¼å¼ä¸å½•åˆ¶çš„æ ¼å¼å¿…é¡»ç›¸åŒï¼Œæ‰èƒ½çœŸç¡®æ’­æ”¾ ä¸Šé¢æåˆ° -i æŒ‡å®šé‡‡é›†è¾“å…¥ï¼Œå¦‚ä½•æŸ¥çœ‹ç´¢å¼•å·å‘¢?\n1 ffmpeg -f avfoundation -list_devices true -i \u0026#34;\u0026#34; ä½¿ç”¨ ffmpeg å½•åˆ¶éŸ³é¢‘\n1 2 3 ffmpeg -f avfoundation -i :2 out.wav # æ’­æ”¾éŸ³é¢‘ ffplay out.wav æ³¨æ„è¿™æ¬¡åºå·å‰é¢åŠ äº†:ï¼Œå†’å·å‰é¢è¡¨ç¤ºè§†é¢‘è®¾å¤‡ï¼Œå†’å·åé¢è¡¨ç¤ºéŸ³é¢‘è®¾å¤‡ã€‚ åˆ†è§£/å¤ç”¨å‘½ä»¤ å°† mp4 è½¬æˆ flv\n1 ffmpeg -i out.mp4 -vcodec copy -acodec copy out.flv -vcodec: è§†é¢‘ç¼–ç å¤„ç†æ–¹å¼ï¼Œcopy è¡¨ç¤ºä½¿ç”¨åŸå§‹æ ¼å¼q -acodec: éŸ³é¢‘ç¼–ç å¤„ç†æ–¹å¼ æŠ½å–è§†é¢‘\n1 ffmpeg -i video.MP4 -an -vcodec copy out.h264 æŠ½å–éŸ³é¢‘\n1 ffmpeg -i video.MP4 -vn -acodec copy out.aac -an: audio nullï¼Œè¡¨ç¤ºè¿‡æ»¤æ‰éŸ³é¢‘ -vn: video nullï¼Œè¡¨ç¤ºè¿‡æ»¤æ‰è§†é¢‘ å¤„ç†åŸå§‹æ•°æ®å‘½ä»¤ æå‰ YUV æ•°æ®\n1 ffmpeg -i video.MP4 -an -c:v rawvideo -pixel_format yuv420p out.yuv -c: æŒ‡å®šç¼–è§£ç å™¨ -c:v: é™å®šåªå¤„ç†è§†é¢‘ç”»é¢ï¼Œä¾‹å¦‚ -c:v libx264è¡¨ç¤ºè½¬æ¢ä¸º h264ï¼Œ-c:v rawvideoè¡¨æ˜¯æå– YUV æ•°æ®ï¼Œä¹Ÿå¯ä»¥-c:v h264 ç›´æ¥æ“ä½œã€‚ -c:a: é™å®šåªå¤„ç†éŸ³é¢‘å£°éŸ³ï¼Œä¾‹å¦‚ -c:a libmp3lameï¼Œè¡¨ç¤ºè½¬æ¢ mp3ï¼Œä¹Ÿå¯ä»¥-c:a mp3ç›´æ¥æ“ä½œã€‚ -c:s: é™å®šåªå¤„ç†å­—å¹• æå– PCM æ•°æ®\n1 ffmpeg -i video.MP4 -vn -ar 44100 -ac2 -f s16le out.pcm -ar: audio rateï¼ŒæŒ‡å®šéŸ³é¢‘é‡‡æ ·ç‡ -ac: audio channelï¼ŒæŒ‡å®šå£°é“ï¼Œ2 è¡¨ç¤ºåŒå£°é“ -f: æŒ‡å®šæ ¼å¼ï¼Œsæœ‰ç¬¦å·ï¼Œ16è¡¨ç¤ºæ¯ä¸ªæ•°å€¼æ˜¯ 16 ä½ æ’­æ”¾ PCM æ•°æ®\nè·Ÿæå–æ—¶ä¸€æ ·ï¼Œä¹Ÿè¦æŒ‡å®šç›¸å…³å‚æ•°\n1 ffplay -ar 44100 -ac 2 -f s16le out.pcm è£å‰ªä¸åˆå¹¶å‘½ä»¤ è§†é¢‘è£å‰ª\n1 ffmpeg -i video.MP4 -c copy -ss 00:00:00 -t 10 out.ts -ss: å¼€å§‹è£å‰ªæ—¶é—´ï¼ŒæŒ‡å®šæ—¶åˆ†ç§’ -t: è£å‰ªå¸‚åœºï¼Œå•ä½ç§’ è§†é¢‘åˆå¹¶\nåœ¨åˆå¹¶ä¹‹å‰ï¼Œéœ€è¦åˆ›å»ºåŒ…å«æ‰€æœ‰åˆ‡ç‰‡çš„æ–‡ä»¶\n1 2 3 # input.txt file \u0026#39;1.ts\u0026#39; file \u0026#39;2.ts\u0026#39; 1 ffmpeg -f concat -i input.txt out.mp4 -f concat: æŒ‡å®šåˆå¹¶ å›¾ç‰‡/è§†é¢‘äº’è½¬å‘½ä»¤ è§†é¢‘è½¬å›¾ç‰‡\né…åˆè§†é¢‘è£å‰ªæœ‰å¥‡æ•ˆã€‚\n1 2 3 ffmpeg -i video.MP4 -r 1 -f image2 image-%3d.jpeg ffmpeg -i video.MP4 -ss 00:00:00 -t 5 -r 1 -f image2 image-%2d.jpeg -r: æŒ‡å®šè½¬æ¢å›¾ç‰‡çš„å¸§ç‡ï¼Œ1 è¡¨ç¤ºæ¯ç§’è½¬å‡ºä¸€å¼ å›¾ç‰‡ -f image2: æŒ‡å®š jpeg ç¼–ç å™¨ %3d.jpeg: è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€å¢é•¿çš„æ–‡ä»¶åï¼Œæœ€å¤§ 3 ä½æ•°ï¼Œä¸è¶³è¡¥ 0ã€‚ å›¾ç‰‡è½¬è§†é¢‘\n1 ffmpeg -i image-%2d.jpeg out.mp4 ç›´æ’­æ¨/æ‹‰æµ ç›´æ’­æ¨æµ\n1 ffmpeg -re -i video.mp4 -c copy -f flv \u0026#34;rtmp://server/live/streamName\u0026#34; -re: å‡æ…¢å¸§ç‡é€Ÿåº¦ï¼Œå¯¹äºç›´æ’­æµæ¥è¯´ï¼Œè®©å¸§ç‡ä¸å£°éŸ³ä¿æŒåŒæ­¥ -c copy: ä¸åšéŸ³è§†é¢‘ç¼–ç  ç›´æ’­æ‹‰æµ\n1 ffmpeg -i \u0026#34;rtmp://server/live/streamName\u0026#34; -c copy dump.flv æ»¤é•œå‘½ä»¤ å€é€Ÿï¼Œç”»ä¸­ç”»ï¼Œä¿®æ”¹é•¿å®½ç­‰ã€‚\nè°ƒæ•´å®½é«˜\n1 ffmpeg -i video.MP4 -vf crop=in_w-200:in_h-200 -c:v libx264 -c:a copy out.mp4 -vf: æŒ‡å®šæ»¤é•œ crop=in_w-200:in_h-200: ä¿®æ”¹å®½é«˜ -c:v: è§†é¢‘ç¼–ç  ","date":"2022-11-25T00:00:00Z","permalink":"https://blog.golang.space/p/ffmpeg-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","title":"FFmpeg åŸºç¡€çŸ¥è¯†"},{"content":"ç¼–è¯‘å™¨ åœ¨ mac å¹³å°ä¸‹ï¼Œç¼–è¯‘å™¨æ˜¯ GCC/CLANGã€‚\n1 gcc/clang -g -O2 -o test test.c -I... -L... -l... -g: è¾“å‡ºæ–‡ä»¶å¢åŠ è°ƒè¯•ä¿¡æ¯ -O: æŒ‡ä»¤ä¼˜åŒ–çº§åˆ«ï¼Œ-O1 ä¸ä¼˜åŒ–ï¼Œ-O2 ä»£è¡¨ç¬¬äºŒä¸ªçº§åˆ«ä¼˜åŒ–ã€‚ -o: å¯æ‰§è¡Œç¨‹åºè¾“å‡ºçš„åå­— test.c: åœ¨è¿™é‡Œæ˜¯æºä»£ç æ–‡ä»¶ -I: æŒ‡å®šå¤´æ–‡ä»¶ -L: æŒ‡å®šåº“æ–‡ä»¶ä½ç½® -l: æŒ‡å®šä½¿ç”¨å“ªä¸ªåº“ ç¼–è¯‘è¿‡ç¨‹ é¢„ç¼–è¯‘ï¼Œå°†å¤´æ–‡ä»¶ä¸æºä»£ç åˆåœ¨ä¸€èµ·ï¼Œä¼šå½¢æˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ ç¼–è¯‘ï¼Œç”Ÿæˆ .o æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸­é—´æ–‡ä»¶ï¼Œæ˜¯å¯æ‰§è¡Œç¨‹åºçš„ä¸€éƒ¨åˆ† é“¾æ¥ï¼Œå°† .o æ–‡ä»¶ä¸ç¬¬ä¸‰æ–¹åº“/ç³»ç»Ÿåº“é“¾æ¥åˆ°ä¸€èµ· 1 2 3 4 5 6 // vim add.c #include \u0026lt;stdio.h\u0026gt; void add(int a,int b){ printf(\u0026#34;%d\\n\u0026#34;,a+b); } 1 2 3 clang -g -c add.c # é“¾æ¥ libtool -static -o libadd.a add.o 1 2 // åˆ›å»º add.h æ–‡ä»¶ void add(int a,int b); è°ƒç”¨æ–‡ä»¶\n1 2 3 4 5 6 7 #include \u0026lt;stdio.h\u0026gt; // å¼•å·è¡¨ç¤ºä¼˜å…ˆåœ¨æœ¬åœ°ç›®å½•æœç´¢ï¼Œä¹Ÿå¯ä»¥ç”¨å°–æ‹¬å·æŒ‡å®šä½ç½® #include \u0026#34;add.h\u0026#34; int main(){ add(5,3); return 0; } ç¼–è¯‘\n1 gcc -g -o test main.c -I . -L . -l add è°ƒè¯• Mac ä¸‹æ˜¯ lldb\nLinux ä¸‹æ˜¯ gdb\nè¯´æ˜ å‘½ä»¤ è‹±æ–‡ è®¾ç½®æ–­ç‚¹ b break è¿è¡Œç¨‹åº r run å•æ­¥æ‰§è¡Œ n next è·³å…¥å‡½æ•° s step è·³å‡ºå‡½æ•° finish æ‰“å°å†…å®¹ p print é€€å‡º q quit æŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹ break l break list ä½¿ç”¨ -g åŠ å…¥è°ƒè¯•ä¿¡æ¯ï¼Œåœ¨ç›®å½•ä¸‹ä¹Ÿä¼šç”Ÿæˆ test.dSYM ç›®å½•\n1 dwarfdump test ","date":"2022-11-25T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%8D%81%E5%85%AD%E8%AF%BE-%E7%BC%96%E8%AF%91%E5%99%A8/","title":"ç¬¬åå…­è¯¾ ç¼–è¯‘å™¨"},{"content":"éŸ³è§†é¢‘åŸºç¡€ åª’ä½“åŸºç¡€çŸ¥è¯† å›¾åƒ ã€Œå›¾åƒã€æ˜¯ã€Œåƒç´ ã€çš„é›†åˆï¼Œæœ‰å®½åº¦å’Œé«˜åº¦ï¼Œæ¯ä¸ªåƒç´ å—æ˜¯å•ä¸€çš„é¢œè‰²ã€‚\nã€Œå›¾åƒåˆ†è¾¨ç‡ã€è¡¨ç¤ºå›¾åƒçš„è´¨é‡å’Œåƒç´ æ•°ï¼Œç”± x è½´ä¹˜ä»¥ Y è½´çš„åƒç´ ä¸ªæ•°å¾—å‡ºï¼Œå¸¸è§åˆ†è¾¨ç‡:\nHD( 1920 * 1080 ) UHD ( 3840*2160 ) 4K ( 4096*2160 ) å›¾åƒçš„çºµæ¨ªæ¯”æ˜¯å®½é«˜æ¯”ï¼Œå¸¸è§çš„æœ‰\n16:9 4:3 å¸¸è§åˆ†è¾¨ç‡\næ ¼å¼ åˆ†è¾¨ç‡ 360P(æµç•…) 640x360 480P(æ ‡æ¸…) 854x480 720P(é«˜æ¸…) 1280*720 1080P(é«˜æ¸…) 1920*1080 2160P(4K) 3840*2160 4320P(8K) 7860*4320 è§†é¢‘ è§†é¢‘æ˜¯ä¸€ç³»åˆ—çš„å›¾åƒï¼Œåœ¨è§†é¢‘ä¸Šä¸‹æ–‡ä¸­ï¼Œæ¯ä¸ªå›¾åƒç§°ä¸ºã€Œå¸§ã€ï¼Œã€Œå¸§ç‡ã€(fps)è¡¨ç¤ºæ¯ç§’æœ‰å¤šå°‘å¸§ï¼Œå¸¸è§çš„å¸§ç‡:\n15 (å®æ—¶é€šä¿¡) 25 (åŠ¨ç”») 30 (å®æ—¶é€šä¿¡) 60 (ç”µå½±/æ¸¸æˆ) æœªç¼–ç è§†é¢‘çš„ RGB ç æµè®¡ç®—æ–¹æ³• = åˆ†è¾¨ç‡ * 3 * å¸§ç‡\nä¾‹å¦‚1280*720*3*25ï¼Œçº¦ç­‰äºæ¯ç§’ 69MBã€‚\nYUV Y æ˜äº®åº¦ UV è‰²å½©åŠé¥±å’Œåº¦ ä¸»è¦çš„é‡‡æ ·æ ¼å¼æœ‰:\nYUV4:2:0ï¼Œåº”ç”¨æœ€å¹¿æ³›çš„æ ¼å¼ï¼Œ YUV4:2:2ï¼Œæ¯ä¸€ä¸ªæ¨ªè¡Œéš”ä¸€ä¸ªå«æœ‰ä¸€ä¸ª uv YUV4:4:4 RGB ç”¨äºå±å¹•å›¾åƒçš„å±•ç¤ºï¼ŒYUV ç”¨äºé‡‡é›†å’Œç¼–ç \nç”Ÿæˆ YUV\n1 2 3 4 5 ffmpeg -i input.mp4 \\ -an \\ -c:v rawvideo \\ -pix_fmt yuv420p \\ out.yuv -i è¾“å…¥ -anï¼Œaudio nullï¼Œè¡¨ç¤ºè¿‡æ»¤æ‰éŸ³é¢‘ -cï¼ŒæŒ‡å®šè§†é¢‘ç¼–ç å™¨ä¸º rawvideo è§†é¢‘ç¼–è§£ç  H.264ï¼Œåœ¨ä»Šå¤©äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¤šï¼Œä¸ YUV çš„å‹ç¼©æ¯”æ˜¯ç™¾åˆ†ä¹‹ä¸€ã€‚\nH.265 æ˜¯å‰è€…çš„ç»§æ‰¿è€…ï¼Œæä¾›äº†æ›´å¥½çš„å‹ç¼©æ•ˆæœ\nVP9ï¼Œèµ·æºäº Google\nGOPï¼Œå¼ºç›¸å…³çš„ä¸€ç»„å¸§ï¼Œå¼ºç›¸å…³çš„å¸§æ”¾åœ¨ä¸€èµ·å‹ç¼©ï¼Œå‹ç¼©ç‡æ›´é«˜\nç¼–ç å¸§çš„åˆ†ç±»\nI (interframe frame) å¸§ï¼Œå…³é”®å¸§ï¼Œé‡‡ç”¨å¸§å†…å‹ç¼©æŠ€æœ¯ P (forward predicted frame)ï¼Œå‘å‰å‚è€ƒå¸§ï¼Œå‹ç¼©æ—¶åªå‚è€ƒå‰é¢å·²ç»å¤„ç†çš„å¸§ï¼Œé‡‡ç”¨å¸§é—´å‹ç¼©æŠ€æœ¯ï¼Œå  I å¸§ä¸€åŠå¤§å°ã€‚ B (Bidirectionally predicted frame)ï¼ŒåŒå‘å‚è€ƒå¸§ï¼Œå‹ç¼©æ—¶å³å‚è€ƒå‰é¢å·²å¤„ç†çš„å¸§ï¼Œä¹Ÿå‚è€ƒåé¢çš„å¸§ï¼Œå¸§é—´å‹ç¼©æŠ€æœ¯ï¼Œå  I å¸§ Â¼ å¤§å°ã€‚B å¸§è¶Šå¤šï¼Œå»¶è¿Ÿè¶Šå¤§ï¼Œå ç”¨ CPUï¼Œç©ºé—´æœ€å°ã€‚ IDR å¸§æ˜¯è§£ç å™¨ç«‹å³åˆ·æ–°å¸§ï¼Œè§£ç å™¨é‡åˆ° IDR å¸§ä¼šæ¸…ç©º buffer ä¸­çš„æ•°æ®ï¼Œé˜²æ­¢é”™è¯¯çš„ä¼ æ’­ï¼Œæ¯ä¸ª GOP ä¸­çš„ç¬¬ä¸€å¸§å°±æ˜¯ IDR å¸§ã€‚IDR å¸§æ˜¯ä¸€ç§ç‰¹æ®Šçš„ I å¸§ã€‚\nåœ¨æ¯ä¸ª IDR å¸§å‰é¢éƒ½æœ‰ SPS ä¸ PPSã€‚\nSPS (Sequence Parameter Set): çº¦æŸï¼Œå‚è€ƒå¸§çš„æ•°é‡ï¼Œè§£ç å›¾åƒå°ºå¯¸ï¼Œç¼–ç æ¨¡å¼ PPS (Picture Parameter set): å›¾åƒå‚æ•°é›†ã€‚ H264å‹ç¼©æŠ€æœ¯\nå¸§å†…å‹ç¼©ï¼Œè§£å†³çš„æ˜¯ç©ºåŸŸæ•°æ®å†—ä½™é—®é¢˜ (æœ‰æŸ) å¸§é—´å‹ç¼©ï¼Œè§£å†³çš„æ˜¯æ—¶åŸŸæ•°æ®å†—ä½™é—®é¢˜ (æœ‰æŸ) æ•´æ•°ç¦»æ•£ä½™å¼¦å˜åŒ–(DCT)ï¼Œå°†ç©ºé—´ä¸Šçš„ç›¸å…³æ€§å˜ä¸ºé¢‘åŸŸä¸Šæ— å…³æ•°æ®ç„¶åè¿›è¡Œé‡åŒ– CABAC å‹ç¼© å®å—\nå®å—æ˜¯è§†é¢‘å‹ç¼©æ“ä½œçš„åŸºæœ¬å•å…ƒï¼Œæ— è®ºæ˜¯å¸§å†…å‹ç¼©è¿˜æ˜¯å¸§é—´å‹ç¼©ï¼Œä»–ä»¬éƒ½ä»¥å®å—ä¸ºå•ä½ã€‚\nè§†é¢‘èŠ±å±åŸå› \nGOP åˆ†ç»„ä¸­çš„å¸§ä¸¢å¤±ï¼Œé€ æˆè§£ç ç«¯çš„å›¾åƒå‘ç”Ÿé”™è¯¯ï¼Œä¼šå‡ºç°èŠ±å±ã€‚\nè§†é¢‘å¡é¡¿åŸå› \nä¸ºäº†é¿å…èŠ±å±é—®é¢˜å‘ç”Ÿï¼Œå‘ç°æœ‰å¸§ä¸¢å¤±æ—¶ï¼Œå°±ä¸¢å¼ƒ GOP å†…çš„æ‰€æœ‰å¸§ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ª IDR å¸§é‡æ–°åˆ·æ–°å›¾åƒã€‚\nI å¸§æœ‰ä¸€ä¸ªæ¯”è¾ƒé•¿çš„å‘¨æœŸï¼Œåœ¨ä¸‹ä¸€ä¸ª I å¸§æ¥ä¹‹å‰ä¸æ˜¾ç¤ºåé¢çš„å›¾åƒï¼Œè§†é¢‘å°±é™æ­¢ä¸åŠ¨äº†ï¼Œå³å‡ºç°å¡é¡¿ç°è±¡ã€‚\nè§†é¢‘å‹ç¼© å®ƒçš„å·¥ä½œåŸç†æ˜¯ä»åŸå§‹å›¾åƒæˆ–è§†é¢‘å¸§ä¸­å»é™¤å†—ä½™ä¿¡æ¯ï¼Œæœ‰ä¸¤ç§å†—ä½™ä¿¡æ¯\nå›¾åƒæˆ–å¸§å­˜åœ¨å†—ä½™ åŒä¸€åœºæ™¯çš„æ¯ä¸¤ä¸ªè¿ç»­å¸§ä¹‹é—´å­˜åœ¨å†—ä½™ H264 Profileï¼Œå¯¹è§†é¢‘å‹ç¼©ç‰¹æ€§çš„æè¿°ã€‚\nH264 Level æ˜¯å¯¹è§†é¢‘çš„æè¿°ï¼ŒLevel è¶Šé«˜ï¼Œè§†é¢‘çš„ç ç‡ï¼Œåˆ†è¾¨ç‡ï¼Œfps è¶Šé«˜ã€‚\néŸ³é¢‘ éŸ³é¢‘æ ·æœ¬é€šå¸¸å­˜å‚¨ä¸º 8 ä½ï¼Œ16 ä½ï¼Œ24 ä½ï¼Œç”šè‡³æ˜¯ 32 ä½çš„å€¼ï¼Œä½æ•°è¶Šå¤šï¼Œæ„å‘³ç€éŸ³é¢‘è´¨é‡è¶Šé«˜ã€‚é‡‡æ ·ç‡è¡¨ç¤ºæ¯ç§’æœ‰å¤šå°‘ä¸ªæ ·æœ¬ï¼Œå¯ä»¥å¯¹ 44.1kHZ \u0026hellip;.é‡‡æ ·ï¼Œé¢‘ç‡è¶Šé«˜æ„å‘³ç€æ›´é«˜çš„è´¨é‡ã€‚\néŸ³é¢‘ channel è¡¨ç¤ºå•ä¸ªé‡‡æ ·åºåˆ—ï¼Œchannels å¯ä»¥ç»„æˆä¸åŒçš„å¸ƒå±€ï¼Œå•ä¸ª channel ç§°ä¸ºå•å£°é“ï¼Œä¸¤ä¸ª channel ç§°ä¸ºç«‹ä½“å£°(å·¦å£°é“/å³å£°é“)ã€‚\néŸ³è½¨(track) è¡¨ç¤º channel çš„é›†åˆï¼Œå•ä¸ªåª’ä½“æ–‡ä»¶ä¸­å¯ä»¥æœ‰å¤šä¸ªéŸ³è½¨ã€‚ä¸åŒçš„éŸ³è½¨ç”¨äºç»„ç»‡ä¸åŒä¸€æ—¶é—´çº¿ç›¸å…³çš„ä¸åŒå£°éŸ³\nç¼–è§£ç \nPCMï¼Œæœ€æµè¡Œçš„æ ¼å¼ï¼Œä½†ä¸å‹ç¼© AAC MP3 container é€šå¸¸è¡¨ç¤ºä¸€ç§æ–‡ä»¶æ ¼å¼ï¼Œåª’ä½“æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„ç»„ç»‡æ–¹å¼ã€‚æ¯”å¦‚æ–‡ä»¶æœ‰å¤šå°‘æµï¼Œå“ªé‡Œå¯ä»¥æ‰¾åˆ°éŸ³è½¨ç­‰ç­‰ã€‚\nMP4ï¼Œæœ€å—æ¬¢è¿çš„ MXFï¼Œå¤§å¤šæ•°é«˜è´¨é‡çš„ä¸“ä¸šæ‘„åƒæœºè®°å½• QT/MOV MKV éŸ³é¢‘\nWAVï¼Œç”¨äºå­˜å‚¨é«˜è´¨é‡å’Œå‹ç¼©çš„ PCM éŸ³é¢‘ M4Aï¼Œç”¨äºå­˜å‚¨å‹ç¼©çš„ AAC éŸ³é¢‘ æ¶æ„æ¨¡å‹ æµåª’ä½“æœåŠ¡å™¨ æ¨æµå·¥å…·( ffmepg / obs ) æ‹‰æµ (ffplay / vlc / iina) ç¤ºä¾‹\n1 2 3 4 5 # æ¨æµ ffmpeg -i video.mp4 -f flv -rtmp_playpath \u0026#34;BSWMSId4g?sign=BSZaSIO4gz\u0026#34; rtmp://localhost/live # æ‹‰æµ ffplay rtmp://localhost/live/BSWMSId4g -i è¡¨ç¤ºè¾“å…¥ -f è¡¨ç¤ºè¾“å‡ºæ ¼å¼ -rtmp_playpath æŒ‡å®šè·¯å¾„ ç®€å•å°è¯•ä¸€ä¸‹ï¼Œä¼šå‘ç°æ¨æµå¤±è´¥æˆ–æ¸…æ™°åº¦ä¸é«˜çš„é—®é¢˜ã€‚\n-re è®©åª’ä½“ä»¥åŸæ¥éŸ³è§†é¢‘åŒæ­¥çš„é€Ÿåº¦æ’­æ”¾ï¼Œå¢åŠ æ­¤å‚æ•°å¯ä»¥é¿å…æ¨æµå¤±è´¥ ä½¿ç”¨ -f æŒ‡å®šè¾“å‡ºæ ¼å¼ï¼Œä¼šå°†åŸæ ¼å¼ç¼–è§£ç åˆ°æ–°æ ¼å¼ï¼Œå°†æŸå¤±ä¸€å®šçš„è´¨é‡ï¼Œæ‰€ä»¥æ¸…æ™°åº¦ä¸é«˜ã€‚\n-c copy ä¸é‡æ–°ç¼–ç ï¼Œä½¿ç”¨åŸæ¥çš„éŸ³è§†é¢‘æ–¹å¼ï¼Œå°†ä¼šæ˜¯åŸè§†é¢‘çš„æ¸…æ™°åº¦ã€‚ éŸ³é¢‘å¤„ç†æµç¨‹ éŸ³é¢‘æ•°æ®æµ\nåŸå§‹æ•°æ® PCM =\u0026gt; å‹ç¼©æ•°æ® AAC/MP3 =\u0026gt; å¤šåª’ä½“åŒ… MP4/FLV\nHZ ï¼Œå£°éŸ³åœ¨ä¸€ç§’å†…éœ‡åŠ¨çš„æ¬¡æ•°ï¼Œäººç±»å¬è§‰èŒƒå›´æ˜¯ 20HZ ~ 20KHZã€‚\nå£°éŸ³ä¸‰è¦ç´ :\néŸ³è°ƒï¼ŒéŸ³é¢‘çš„å¿«æ…¢ éŸ³é‡ï¼ŒæŒ¯åŠ¨çš„å¹…åº¦ éŸ³è‰²ï¼Œè°æ³¢ æ¨¡æ•°è½¬æ¢ï¼Œå¯¹å£°éŸ³è¿›è¡Œé‡åŒ–ï¼Œå°†åè¿›åˆ¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶ã€‚\néŸ³é¢‘åŸå§‹æ•°æ®æœ‰ä¸¤ç§ï¼ŒåŸå§‹æ•°æ®æ˜¯ PCMï¼Œå°è£…æˆæ ¼å¼åä¸º WAVã€‚WAV æ˜¯åœ¨ PCM çš„åŸºç¡€ä¸Šå¥—äº†ä¸€ä¸ª Headerï¼Œå¢åŠ äº†æè¿°ä¿¡æ¯ï¼Œå¦‚é€šé“æ•°ï¼Œé‡‡æ ·ç‡ï¼Œé‡‡æ ·å¤§å°ï¼Œå­—èŠ‚å¯¹é½ï¼Œé‡‡æ ·ç‡çš„å­—èŠ‚æ•°ï¼Œ\né‡‡æ ·å¤§å°ï¼Œä¸€ä¸ªé‡‡æ ·ç”¨å¤šå°‘ bit å­˜æ”¾ï¼Œå¸¸ç”¨æ˜¯ 16bitã€‚ é‡‡æ ·ç‡ï¼Œ8Kï¼Œ16Kï¼Œ32Kï¼Œ44.1Kï¼Œ48Kï¼Œé€šå¸¸æ‰“ç”µè¯æ˜¯ 8K æœ‰ä¸€å®šçš„å¤±çœŸã€‚ å£°é“æ•°ï¼Œå•å£°é“ï¼ŒåŒå£°é“ï¼Œå¤šå£°é“ã€‚æ¯”å¦‚åœ¨ç”µå½±é™¢æ„Ÿå—åˆ°çš„å£°éŸ³å°±å¾ˆéœ‡æ’¼ï¼Œæœ‰å¾ˆå¤šå–‡å­å›´ç»•åœ¨å››å‘¨ã€‚ ç ç‡è®¡ç®—\nPCM éŸ³é¢‘æµçš„ç ç‡ = é‡‡æ ·ç‡ * é‡‡æ ·å¤§å° * å£°é“æ•°\nä¾‹å¦‚: é‡‡æ ·ç‡=44.1KHzï¼Œé‡‡æ ·å¤§å°ä¸º 16bitï¼ŒåŒå£°é“çš„ PCM ç¼–ç æ–‡ä»¶ï¼Œ44.1K * 16*2 = 1411.2KB/sã€‚\nAAC è§„æ ¼ AAC LC:(Low Complexity)ä½å¤æ‚åº¦è§„æ ¼ï¼Œç æµæ˜¯ 128Kï¼ŒéŸ³è´¨å¥½ã€‚ AAC HE:ç­‰äº AAC LC + SBRï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯æŒ‰é¢‘è°±åˆ†ä¿å­˜ã€‚ç æµæ˜¯ 64Kã€‚ AAC HE v2:ç­‰äº AAC LC + SBR + PSï¼ŒåŒå£°é“çš„å£°éŸ³å­˜åœ¨æŸç§ç›¸ä¼¼æ€§ï¼Œåªéœ€å­˜å‚¨ä¸€ä¸ªå£°é“ï¼Œå¹¶èŠ±å¾ˆå°‘å­—èŠ‚æè¿°å¦ä¸€ä¸ªå£°é“ä¸åŒçš„åœ°æ–¹ã€‚ AAC æ ¼å¼ ADIF (audio date interchange format)ï¼Œå¯ä»¥ç¡®å®šçš„æ‰¾åˆ°éŸ³é¢‘æ•°æ®çš„å¼€å§‹ï¼Œåªèƒ½ä»å¤´å¼€å§‹è§£ç ã€‚\nADTS (audio data transport stream)ï¼Œæ¯ä¸€å¸§éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å­—ï¼Œå¯ä»¥åœ¨éŸ³é¢‘ä»»æ„ä½ç½®è§£ç ï¼Œé€‚ç”¨æ€§æ›´å¹¿ï¼Œæ›´é€‚åˆæµåª’ä½“ä¼ è¾“ã€‚\nç”± 7/9 ä¸ªå­—èŠ‚ç»„æˆï¼Œ\né€šè¿‡ ffmpeg ç”Ÿæˆ AAC æ–‡ä»¶ 1 2 3 4 5 6 7 ffmpeg -i xxx.mp4 \\ -vn \\ -c:a aac \\ -ar 44100 \\ -channels 2 \\ -profile:a aac_he_v2 \\ xxx.aac -vn: video nullï¼Œç”¨äºè¿‡æ»¤æ‰è§†é¢‘ -c: æŒ‡å®šç¼–ç å™¨ï¼Œa è¡¨ç¤º audioï¼Œlibfdk_aac ç›¸å¯¹è€Œè¨€ï¼Œè¿™ä¸ªæ€§èƒ½æ˜¯æœ€å¥½çš„ç¼–ç å™¨ -ar: audio rate é‡‡æ ·ç‡ -channels: é€šé“æ•° -profile:æŒ‡å®šå‚æ•° éŸ³é¢‘é‡é‡‡æ ·? ä»€ä¹ˆæ˜¯éŸ³é¢‘é‡é‡‡æ ·?\nå°†éŸ³é¢‘ä¸‰å…ƒç»„è½¬æ¢æˆå¦å¤–ä¸€ç»„å€¼ï¼Œä¾‹å¦‚å°† 44100/16/2 =\u0026gt; 48000/16/2\nä¸ºä»€ä¹ˆè¦é‡é‡‡æ ·?\né‡‡æ ·çš„éŸ³é¢‘æ•°æ®ä¸ç¼–ç å™¨è¦æ±‚çš„æ•°æ®ä¸ä¸€è‡´ æ‰¬å£°å™¨è¦æ±‚çš„éŸ³é¢‘æ•°æ®ä¸è¦æ’­æ”¾çš„éŸ³é¢‘æ•°æ®ä¸ä¸€è‡´ æ–¹ä¾¿è¿ç®—ï¼Œæ¯”å¦‚å›éŸ³æ¶ˆé™¤ï¼Œéœ€è¦å°†å…¶è½¬æˆå•å£°é“å¤„ç† å¦‚ä½•çŸ¥é“æ˜¯å¦éœ€è¦è¿›è¡Œé‡é‡‡æ ·?\näº†è§£éŸ³é¢‘è®¾å¤‡çš„å‚æ•° æŸ¥çœ‹ ffmpeg æºç  é‡é‡‡æ ·çš„æ­¥éª¤\nåˆ›å»ºé‡é‡‡æ ·ä¸Šä¸‹æ–‡ è®¾ç½®å‚æ•° åˆå§‹åŒ–é‡é‡‡æ · è¿›è¡Œé‡é‡‡æ · æµåª’ä½“ RTMP åˆ›å»ºæµçš„åŸºæœ¬æµç¨‹ tcp è¿æ¥ rtmp æ¡æ‰‹ å»ºç«‹ rtmp è¿æ¥ åˆ›å»º rtmp æµ å‚è€ƒ ffmpeg æ¨æµ rtmp çš„å‚æ•°è®¾ç½®\nç æµå‚è€ƒå€¼\n","date":"2022-11-24T00:00:00Z","permalink":"https://blog.golang.space/p/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%9F%BA%E7%A1%80/","title":"éŸ³è§†é¢‘åŸºç¡€"},{"content":"Certified Kubernetes Application Developer (CKAD)ï¼Œè®¤è¯ Kubernetes åº”ç”¨å¼€å‘äººå‘˜ã€‚è¯¥è€ƒè¯•ç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰è”åˆLinuxåŸºé‡‘ä¼šæ¨å‡ºï¼Œæ—¨åœ¨è€ƒå¯Ÿç›¸å…³ä»ä¸šè€…å¯¹ Kubernetes çš„è¿ç»´å’Œå¼€å‘çŸ¥è¯†äº†è§£ç¨‹åº¦çš„è®¤è¯è€ƒè¯•ã€‚\nCKAD è€ƒè¯•æ˜¯ä¸€ä¸ªå®Œå…¨åŠ¨æ‰‹çš„è€ƒè¯•ï¼Œéœ€è¦æ‚¨åœ¨å¤šä¸ªKubernetesé›†ç¾¤ä¸­è§£å†³é—®é¢˜ã€‚æ‚¨éœ€è¦ç†è§£ã€ä½¿ç”¨å’Œé…ç½®ä¸åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ç›¸å…³çš„KubernetesåŸè¯­ã€‚ ä»¥å®˜æ–¹è¯´æ³•ï¼Œé€šè¿‡CKADè€ƒè¯•åï¼ŒæŒè¯è€…å³è¢«è®¤å¯èƒ½å¤Ÿä¸ºKubernetesè®¾è®¡ã€æ„å»ºã€é…ç½®å’Œéƒ¨ç½²äº‘åŸç”Ÿåº”ç”¨ï¼Œåœ¨Kubernetesä¸­èƒ½å¤Ÿå®šä¹‰åº”ç”¨ç¨‹åºèµ„æºï¼Œä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½æ„å»ºã€ç›‘æ§å’Œè¯Šæ–­å¯ä¼¸ç¼©çš„åº”ç”¨ç¨‹åºã€‚\nè¿™æ˜¯æˆ‘çš„è¯ä¹¦ã€‚\nè€ƒè¯• æˆ‘åœ¨ Linux Foundation è´­ä¹°çš„è®¤è¯è€ƒè¯•ã€‚åŸä»·æ˜¯ 2498ï¼Œå»ºè®®æŠ˜æ‰£æ´»åŠ¨æœŸé—´è´­ä¹°ï¼Œæˆ‘æ˜¯åœ¨é»‘è‰²æ˜ŸæœŸäº”ä¹°çš„ã€‚\nè´­ä¹°ååœ¨ \u0026ldquo;ä¸ªäººä¸­å¿ƒ\u0026rdquo; - \u0026ldquo;æˆ‘çš„è€ƒè¯•\u0026rdquo; å¯ä»¥çœ‹åˆ°è€ƒè¯•åˆ¸ï¼Œéœ€è¦å»è‹±æ–‡å®˜ç½‘æ¿€æ´»ã€‚\nåœ¨è¿™é‡Œ é¢„çº¦è€ƒè¯•ï¼Œéœ€è¦æå‰ä¸€å¤©é¢„çº¦ã€‚å…·ä½“æ­¥éª¤å’Œç›¸å…³è¯´æ˜å®˜æ–¹æ–‡æ¡£éƒ½å†™çš„å¾ˆæ¸…æ¥šï¼Œå»ºè®®æŸ¥çœ‹ å®˜æ–¹æ–‡æ¡£ã€‚\næœ‰ä¸¤æ¬¡æ¨¡æ‹Ÿè€ƒçš„æœºä¼šï¼Œä¸€æ¬¡æ˜¯ 36 ä¸ªå°æ—¶ï¼Œæ¨¡æ‹Ÿè€ƒè¯•æ¯”æ­£å¸¸è€ƒè¯•æ›´éš¾ï¼Œæ¨¡æ‹Ÿè€ƒçš„é¢˜ç›®å§‹ç»ˆæ˜¯ä¸€æ ·çš„ï¼Œå»ºè®®å¤šåˆ·å‡ éæ¨¡æ‹Ÿè€ƒã€‚\nå»ºè®®æå‰åŠä¸ªå°æ—¶ï¼Œç‚¹å‡»å¯åŠ¨è€ƒè¯•ï¼Œæ­¤æ—¶ä¼šè·³è½¬åˆ°ç›¸å…³é¡µé¢ï¼Œä¸‹è½½è€ƒè¯•è½¯ä»¶ã€‚æˆ‘ä¿ç•™äº†ä¸‹è½½åœ°å€åˆ†äº«ç»™ä½  è€ƒè¯•è½¯ä»¶ PSI ä¸‹è½½ã€‚\nå¦‚æœä½ çš„ç½‘ç»œä¸å¥½ï¼Œè½¯ä»¶ä¼šå¼¹çª—æç¤ºä½ ï¼Œå¹¶åªæœ‰ä¸€ä¸ªé€€å‡ºé€‰é¡¹ ! æˆ‘å› ä¸ºç½‘ç»œåŸå› å´©äº† 3 æ¬¡ã€‚\næ‰“å¼€è½¯ä»¶åï¼Œè·Ÿç€ç›¸å…³æ­¥éª¤æ“ä½œï¼Œå…è®¸ä½¿ç”¨è§†é¢‘å’Œå£°éŸ³ï¼Œæ‹æ‘„è‡ªå·±çš„èº«ä»½è¯åŠè€ƒè¯•æˆ¿é—´çš„ç¯å¢ƒã€‚ç­‰å¾…äº† 10 åˆ†é’Ÿï¼Œä¼šå¼¹å‡ºä¸è€ƒå®˜çš„ä¼šè¯çª—å£ã€‚å¦‚æœå‰é¢çš„å“ªäº›æ­¥éª¤æ²¡æœ‰è¾¾åˆ°è¦æ±‚ï¼Œè€ƒå®˜ä¼šæç¤ºè¿›ä¸€æ­¥æ“ä½œã€‚\nè€ƒè¯•æ—¶é—´æ˜¯ 2 ä¸ªå°æ—¶ã€‚å› ä¸ºåšæ¨¡æ‹Ÿè€ƒçš„æ—¶å€™æ„Ÿè§‰æ—¶é—´ä¸æ˜¯å¾ˆå……è£•ï¼Œæ‰€ä»¥çœŸå®è€ƒè¯•æ—¶ï¼Œæˆ‘å…ˆè¿…é€Ÿåšé¢˜ï¼Œä¸æ£€æŸ¥ç»“æœã€‚å®é™…ä¸Šæˆ‘è¿˜æœ‰è¶³å¤Ÿçš„æ—¶é—´å†æ£€æŸ¥ä¸€éã€‚æ‰“å¥½åŸºç¡€ï¼Œä¸ç”¨æ‹…å¿ƒæ—¶é—´ä¸å¤Ÿç”¨ã€‚\nè€ƒè¯•ç¯å¢ƒçš„æµè§ˆå™¨æ¯”è¾ƒå¡é¡¿ï¼Œé¡µé¢å†…æ–‡å­—æœç´¢ç‚¹å‡»æ²¡ååº”ï¼Œæ€»ç»“æœ‰ç‚¹ä¸æ–¹ä¾¿åœ¨ kubernets å®˜æ–¹å¯»æ‰¾ yaml é…ç½®ã€‚\næ³¨æ„å¤åˆ¶å’Œç²˜è´´åŠŸèƒ½ï¼Œwindows ç”µè„‘éœ€è¦å¤šæŒ‰ä¸€ä¸ª SHEFTï¼Œ CTRL + SHEFT +c/vï¼ŒMac ç”µè„‘æ”¹æˆå‰é¢çš„æ“ä½œï¼Œæ³¨æ„ä½¿ç”¨ command +c/v æ˜¯æ— æ•ˆçš„ï¼Œå»ºè®®æå‰ç»ƒä¹ å¿«æ·é”®ã€‚\nåœ¨è€ƒè¯•ç»“æŸå 24 å°æ—¶å†…å°†ä¼šæ”¶åˆ°é‚®ä»¶ï¼Œé€šçŸ¥ä½ çš„æˆç»©ã€‚\nå­¦ä¹ èµ„æ–™ CKAD-exercises\nKubernets å®˜æ–¹æ–‡æ¡£\n","date":"2022-07-04T00:00:00Z","image":"http://img.golang.space/shot-1656933075470.png","permalink":"https://blog.golang.space/p/kubernetes-%E5%BC%80%E5%8F%91%E8%AE%A4%E8%AF%81ckad%E8%80%83%E8%AF%95%E5%BF%83%E5%BE%97/","title":"Kubernetes å¼€å‘è®¤è¯(CKAD)è€ƒè¯•å¿ƒå¾—"},{"content":"åŸºäº docker-compose æ¨¡æ‹Ÿ PostgreSQL 12.2 ä¸»ä» ä¸»æœåŠ¡å™¨å’Œåå¤‡æœåŠ¡å™¨ä¸€èµ·å·¥ä½œæ¥æä¾›é«˜å¯ç”¨é›†ç¾¤èƒ½åŠ›ã€‚ä¸»æœåŠ¡å™¨åœ¨è¿ç»­å½’æ¡£æ¨¡å¼ä¸‹æ“ä½œï¼Œæ¯ä¸€ä¸ªåå¤‡æœåŠ¡å™¨åœ¨è¿ç»­æ¢å¤æ¨¡å¼ä¸‹æ“ä½œå¹¶ä¸”æŒç»­ä»ä¸»æœåŠ¡å™¨è¯»å– WAL æ–‡ä»¶ã€‚è¦å¯ç”¨è¿™ç§èƒ½åŠ›ä¸éœ€è¦å¯¹æ•°æ®åº“è¡¨åšä»»ä½•æ”¹åŠ¨ï¼Œå› æ­¤å®ƒç›¸å¯¹äºå…¶ä»–å¤åˆ¶æ–¹æ¡ˆé™ä½äº†ç®¡ç†å¼€é”€ã€‚è¿™ç§é…ç½®å¯¹ä¸»æœåŠ¡å™¨çš„æ€§èƒ½å½±å“ä¹Ÿç›¸å¯¹è¾ƒä½ã€‚\nPostgreSQLé€šè¿‡ä¸€æ¬¡ä¸€æ–‡ä»¶ï¼ˆWAL æ®µï¼‰çš„ WAL è®°å½•ä¼ è¾“å®ç°äº†åŸºäºæ–‡ä»¶çš„æ—¥å¿—ä¼ é€ã€‚æ—¥å¿—ä¼ é€æ˜¯å¼‚æ­¥çš„ï¼Œå³ WAL è®°å½•æ˜¯åœ¨äº‹åŠ¡æäº¤åæ‰è¢«ä¼ é€ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä¸€ä¸ªçª—å£æœŸå†…å¦‚æœä¸»æœåŠ¡å™¨å‘ç”Ÿç¾éš¾æ€§çš„å¤±æ•ˆåˆ™ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œè¿˜æ²¡æœ‰è¢«ä¼ é€çš„äº‹åŠ¡å°†ä¼šè¢«ä¸¢å¤±ã€‚åŸºäºæ–‡ä»¶çš„æ—¥å¿—ä¼ é€ä¸­è¿™ä¸ªæ•°æ®ä¸¢å¤±çª—å£çš„å°ºå¯¸å¯ä»¥é€šè¿‡ä½¿ç”¨å‚æ•°archive_timeoutè¿›è¡Œé™åˆ¶ï¼Œå®ƒå¯ä»¥è¢«è®¾ç½®æˆä½è‡³æ•°ç§’ã€‚ä½†æ˜¯è¿™æ ·ä½çš„è®¾ç½®å¤§ä½“ä¸Šä¼šå¢åŠ æ–‡ä»¶ä¼ é€æ‰€éœ€çš„å¸¦å®½ã€‚\nå‚è€ƒ é«˜å¯ç”¨ã€è´Ÿè½½å‡è¡¡å’Œå¤åˆ¶\ndocker-compose é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 services: pg_master: restart: always image: postgres:12.2 environment: - POSTGRES_PASSWORD=123456789 - TZ=Asia/Shanghai volumes: - $PWD/master:/var/lib/postgresql/data:rw ports: - \u0026#34;1556:5432\u0026#34; extra_hosts: - \u0026#34;postgres_master:172.22.0.2\u0026#34; - \u0026#34;postgres_standby:172.22.0.3\u0026#34; networks: localnet: ipv4_address: 172.22.0.2 pg_standby: restart: always image: postgres:12.2 environment: - POSTGRES_PASSWORD=123456789 - TZ=Asia/Shanghai volumes: - $PWD/standby:/var/lib/postgresql/data:rw ports: - \u0026#34;1557:5432\u0026#34; extra_hosts: - \u0026#34;postgres_master:172.22.0.2\u0026#34; - \u0026#34;postgres_standby:172.22.0.3\u0026#34; networks: localnet: ipv4_address: 172.22.0.3 networks: localnet: driver: bridge ipam: config: - subnet: \u0026#34;172.22.0.0/16\u0026#34; gateway: \u0026#34;172.22.0.1\u0026#34; å…·ä½“æ“ä½œ å¦‚æœæ˜¯åœ¨å¤šå°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼Œå»ºè®®æ‰€æœ‰è®¾å¤‡ä¸Šä¿®æ”¹ /etc/hosts æ–‡ä»¶ï¼Œå¢åŠ ç›¸å…³é…ç½®\n1 2 postgres_master 172.22.0.2 postgres_standby 172.22.0.3 ä¸»åº“ åˆ›å»ºå«æœ‰ç›¸å…³æƒé™çš„ç”¨æˆ·ï¼Œä¸“ç”¨äºæµå¤åˆ¶ã€‚ 1 2 3 CREATE ROLE replica login replication encrypted password \u0026#39;xxxxxxxxxxx\u0026#39;; \\du # æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ ä¿®æ”¹ data/pg_hba.conf æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ç”¨äºé…ç½®æ˜¯å¦å…è®¸å…¶å®ƒä¸»æœºè®¿é—®ã€‚\nå‚è€ƒæ–‡æ¡£\næ ¼å¼: host replication åŒæ­¥ç”¨çš„ç”¨æˆ·å å¤‡åº“IPåœ°å€æˆ–åŸŸå/24 trust\nä»åº“å¯ä»¥åŠ ä¸Šä¸»åº“çš„ï¼Œä¾¿äºä»¥åä¸»ä»åˆ‡æ¢\n1 2 3 4 host replication replica postgres_two trust # å¦‚æœæŸä¸ªç½‘æ®µéƒ½å¯ä»¥å…è®¸ host replication replica 192.168.0.0/24 trust é…ç½®ä¸»åº“çš„é…ç½®æ–‡ä»¶ data/postgres,confï¼Œä¸ºäº†æ–¹ä¾¿ä»¥ååšä¸»ä»åˆ‡æ¢ï¼Œå»ºè®®æ‰€æœ‰ä»åº“é…ç½®ç›¸åŒå‚æ•°\nä¿®æ”¹å®Œæˆåé‡å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # ç›‘å¬æ‰€æœ‰åœ°å€çš„å®¢æˆ·ç«¯è¿æ¥ listen_addresses = \u0026#39;*\u0026#39; # æ¥è‡ªå®¢æˆ·ç«¯å¹¶å‘è¿æ¥çš„æœ€å¤§æ•°é‡ï¼Œåå¤‡æœåŠ¡å™¨å¿…é¡» \u0026gt;= è¯¥å€¼ max_connections = 500 # è®¾ç½® WAL å½’æ¡£ archive_mode = on archive_command = \u0026#39;cp %p /var/lib/postgresql/data/pg_archive/%f\u0026#39; restore_command = \u0026#39;cp /var/lib/postgresql/data/pg_archive/%f %p\u0026#39; recovery_target_timeline = latest # æ—¥å¿—æ ¼å¼ wal_level = replica # è®¾ç½®æµå¤åˆ¶ä¿ç•™çš„æœ€å¤šæ®µæ•°ç›® wal_keep_segments = 64 # ä¸­æ–­é‚£äº›åœæ­¢æ´»åŠ¨è¶…è¿‡è¿™ä¸ªæ—¶é—´é‡çš„å¤åˆ¶è¿æ¥ wal_sender_timeout = 30s # æ¥è‡ªåå¤‡æœåŠ¡å™¨å¹¶å‘è¿æ¥çš„æœ€å¤§æ•°é‡ï¼Œå®˜æ–¹æ–‡æ¡£å»ºè®® \u0026gt; max_connections max_wal_senders=50 # å¼€å¯æ—¥å¿— logging_collector = on log_directory = \u0026#39;/var/lib/postgresql/data/log\u0026#39; log_filename = \u0026#39;pg-%Y-%m-%d_%H%M%S.log\u0026#39; log_file_mode = 0600 log_rotation_age = 72h # æ¢å¤æœŸé—´ï¼Œå…è®¸è¿æ¥å¹¶æŸ¥è¯¢ hot_standby = on # æµå¤åˆ¶æœ€å¤§å»¶è¿Ÿï¼Œé»˜è®¤ 30s max_standby_streaming_delay = 30s # å‘ä¸»æŠ¥å‘ŠçŠ¶æ€ï¼Œé»˜è®¤ 10s wal_receiver_status_interval = 10s å¤‡åº“è®¾ç½® 1 2 3 4 5 6 7 8 9 # å¤‡ä»½ä¹‹å‰çš„æ•°æ® cp data ../data_back # åˆ é™¤æ•°æ® rm -rf data/* # è¿›å…¥å®¹å™¨ï¼Œåˆ‡æ¢ postgres ç”¨æˆ·ï¼Œæ‹‰å–ä¸»åº“çš„æ•°æ® docker exec -it 5123123 sh su postgres pg_basebackup -h postgres_one -U replica -Fp -P -R -D /var/lib/postgresql/data å‚æ•° è¯´æ˜ -h host -U ç”¨æˆ·å -F p æ˜¯é»˜è®¤è¾“å‡ºæ ¼å¼ï¼Œt è¡¨ç¤º tar æ ¼å¼ -P æ˜¾ç¤ºè¿›åº¦ -D è¾“å‡ºåˆ°æŒ‡å®šç›®å½• -R å»ºç«‹ standby.signal å¹¶é™„åŠ è¿æ¥è®¾ç½®åˆ°postgresql.auto.conf æ¥ç®€åŒ–è®¾ç½®ä¸€ä¸ªåå¤‡æœåŠ¡å™¨ æ£€æŸ¥æ˜¯å¦æˆåŠŸ\nè¿›å…¥ä¸»åº“æŸ¥è¯¢ï¼Œå¦‚æ˜¾ç¤ºå¤‡åº“è¡¨ç¤ºæˆåŠŸ\n1 2 psql select client_addr,sync_state from pg_stat_replication; ","date":"2022-05-25T00:00:00Z","image":"http://img.golang.space/img-1669079318266.png","permalink":"https://blog.golang.space/p/%E5%9F%BA%E4%BA%8E-docker-compose-%E6%A8%A1%E6%8B%9F-postgresql-12.2-%E4%B8%BB%E4%BB%8E/","title":"åŸºäº docker-compose æ¨¡æ‹Ÿ PostgreSQL 12.2 ä¸»ä»"},{"content":"å•ä½“æœåŠ¡çš„æ¼”è¿›è¿‡ç¨‹ æœ€åˆä¸šåŠ¡åˆšå¼€å§‹\nä¸Šé¢æ²¡æœ‰å®¹ç¾çš„æ–¹æ¡ˆï¼ŒæœåŠ¡ç«¯æŒ‚äº†ï¼Œå°±ç›´æ¥æŒ‚äº†ã€‚\nå½“ä¸šåŠ¡æœ‰ç‚¹å‘å±•ä»¥åï¼Œä½¿ç”¨ nginx åšè´Ÿè½½å‡è¡¡ï¼Œæ¨ªå‘æ‰©å±•æœåŠ¡ï¼Œæ•°æ®åº“å‡çº§ä¸€ä¸‹ã€‚\nåœ¨ DNS ä¸ŠåŠ è´Ÿè½½å‡è¡¡ï¼Œä½¿ç”¨ K8S ç®¡ç†æœåŠ¡ï¼Œä½¿ç”¨ redis å¢åŠ ç¼“å­˜ã€‚\nè¿™ä¸ªæ¶æ„è¶³ä»¥æ”¯æŒå¤§éƒ¨åˆ†åˆåˆ›é¡¹ç›®ã€‚\nä¼˜ç‚¹ å¼€å‘ç®€å• æµ‹è¯•ç®€å• éƒ¨ç½²ç®€å• ç¼ºç‚¹ éš¾ä»¥ç†è§£å’Œæ‰©å±• å°æ”¹åŠ¨ä¹Ÿå¾—å…¨é‡æ›´æ–° å°é—®é¢˜å®¹æ˜“è§¦å‘å¤§æ•…éšœ èƒ½å¤Ÿæ”¯æŒçš„ä¸šåŠ¡è§„æ¨¡æœ‰é™ å¾®æœåŠ¡ å•ä½“èƒ½å¤Ÿæ‰¿è½½çš„ä¸šåŠ¡è§„æ¨¡æœ‰é™ï¼Œå½“è§„æ¨¡æ‰©å¤§çš„æ—¶å€™ï¼Œå°±éœ€è¦å‡çº§åˆ°å¾®æœåŠ¡ã€‚\næ¯ä¸ªå¾®æœåŠ¡éƒ½å•ç‹¬è¿æ¥ä¸€ä¸ªæ•°æ®åº“ã€‚\nä¼˜ç‚¹ è¾¹ç•Œæ¸…æ™°çš„ä¸šåŠ¡æ‹†åˆ† æ˜“å¼€å‘ï¼Œæ˜“ç†è§£ï¼Œæ˜“ç»´æŠ¤ æŠ€æœ¯æ ˆå¯ç›¸å¯¹ç‹¬ç«‹ æŒç»­é›†æˆï¼ŒæŒç»­éƒ¨ç½²æ›´å®¹æ˜“ æŒ‰éœ€å¯¹æœåŠ¡è¿›è¡Œæ²»ç† ç¨³å®šæ€§æ›´å®¹æ˜“ä¿éšœ ç¼ºç‚¹ å¢é‡äº†ç³»ç»Ÿå¤æ‚åº¦ æ•°æ®æ‹†åˆ†å¤æ‚åº¦ éš¾è°ƒè¯•ï¼Œéš¾æµ‹è¯• è·¨æœåŠ¡ä¿®æ”¹éº»çƒ¦ éš¾éƒ¨ç½² ä»€ä¹ˆä¿¡å·è¡¨æ˜è¯¥è€ƒè™‘å•ä½“è½¬å¾®æœåŠ¡äº† å•ä½“ç³»ç»Ÿè¿‡åº¦å¤æ‚ å½“å‰æ¶æ„ä¸èƒ½æ»¡æ„ä¸šåŠ¡å‘å±•éœ€è¦ ç ”å‘æ•ˆç‡ä½ä¸‹ï¼Œæäº¤ä»£ç å†²çª æŒç»­é›†æˆï¼ŒæŒç»­äº¤ä»˜æ¯”è¾ƒå›°éš¾ï¼Œä¸å¤ªæ•¢æ›´æ–°ï¼Œå°ç‰ˆæœ¬è¦ç­‰å¤§ç‰ˆæœ¬ï¼Œè¦æ­»ä¸€èµ·æ­» å›¢é˜Ÿäººå‘˜è¾ƒå¤š å¦‚ä½•å¯åŠ¨? å¼€ç€é£æœºæ¢å¼•æ“\nåœ¨è½¬å‹çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆéš¾é›¶æ•…éšœçš„å®Œå…¨è½¬æ¢ã€‚\néœ€è¦å…¬å¸æˆ–éƒ¨é—¨é¢†å¯¼çš„æ”¯æŒï¼Œè¦æœ‰ä¸€ä¸ªæ•¢äºæ‰›è´£ä»»çš„é¢†å¯¼ï¼Œåœ¨æ”¹é€ æœŸé—´ï¼Œè¦ç®¡ç†å¥½é¢„æœŸæ”¶ç›Šï¼Œå®é™…åœ¨è½¬æ¢æœŸé—´æ˜¯å¾ˆéš¾çœ‹åˆ°æˆæœçš„ã€‚\nå»ºç«‹æœåŠ¡è¿ç§»æ ¸å¿ƒå›¢é˜Ÿï¼Œéœ€è¦ç»éªŒï¼Œæ‰§è¡ŒåŠ›å¼ºï¼Œè‡ªé©±åŠ›å¼ºçš„é˜Ÿå‘˜ã€‚ä»ä¸€ä¸ªå°çš„æœåŠ¡å¼€å§‹ï¼Œé‡åˆ°é—®é¢˜ä¸èƒ½è·³è¿‡ï¼Œä¸€å®šè¦è§£å†³ï¼Œå®Œæˆè¿™ä¸ªæœåŠ¡å½¢æˆæœ€ä½³å®è·µåï¼Œå¯ä»¥æ¨å¹¿åˆ°æ•´ä¸ªå›¢é˜Ÿã€‚\nå¾®æœåŠ¡æ”¹é€ ç­–ç•¥ ç”±å¤–å‘å†…ï¼Œç”±è¾¹ç¼˜åˆ°æ ¸å¿ƒ æ•°æ®æ‹†åˆ†ï¼Œè¿ç§»å’ŒéªŒè¯ï¼Œå¯å›æ»š (è¦ä¿è¯å½“å¾®æœåŠ¡æŒ‚æ‰åï¼Œå¯ä»¥å›æ»šåˆ°æ—§çš„æœåŠ¡) fork è¯·æ±‚ï¼Œproxy éªŒè¯ å®šæœŸå¤ç›˜è¿‡ç¨‹ï¼Œæ€»ç»“å¯å¤åˆ¶å¥—è·¯ æ±‡æŠ¥æˆæœï¼Œè®©é¢†å¯¼çœ‹åˆ°æ”¶ç›Š å¾®æœåŠ¡æ•°æ®åº“æ‹†åˆ† æ•°æ®ä¸èƒ½ä¹±ï¼Œè§„åˆ™å…ˆç¡®å®š å®šä¹‰æ•°æ®è¾¹ç•Œï¼Œé¿å…æ•°æ®å†—ä½™ æ•°æ®åº“äº’ç›¸éš”ç¦»ï¼Œé¿å…æ•…éšœä¼ é€’ æ¥å£èšç±»æ”¶æ•› æŒ‰åŠŸèƒ½èšç±»æ¥å£ é¿å…å¾®æœåŠ¡è¿‡å¾® é¿å…è°ƒç”¨é“¾è·¯è¿‡æ·± fork è¯·æ±‚ å°†è€çš„æœåŠ¡ä¸Šé¢çš„è¯·æ±‚ fork åˆ°æ–°çš„æœåŠ¡ä¸Šï¼Œæ¯”è¾ƒç»“æœæ˜¯å¦ä¸€è‡´ã€‚\nå¾ªåºæ¸è¿›å¯å›æ»š fork è¯·æ±‚ï¼ŒéªŒè¯æ­£ç¡®æ€§ ç°åº¦é€æ­¥è¿ç§» ç›‘æ§æœ‰æ— æ¼ç½‘è¯·æ±‚ ä¿è¯å›æ»šå¯èƒ½æ€§ å•ä½“åˆ°å¾®æœåŠ¡æ”¹é€ æ¡ˆä¾‹ å•ä½“åº”ç”¨ï¼Œæœ‰é€šçŸ¥å’Œæ‰“å¡ä¸¤ä¸ªæ¨¡å—ï¼Œä¸€ä¸ª DB è¯»å­˜æ•°æ®\nç¬¬ä¸€æ­¥ï¼Œæ‰ä»£ç ä¸Šæ‹†åˆ†ï¼ŒæœåŠ¡éƒ¨ç½²çš„æ–¹å¼æ²¡æœ‰æ”¹å˜ã€‚åªæ˜¯å°† æ‰“å¡ æ¨¡å—çš„ä»£ç æŠ½å‡ºæ¥ã€‚\nç¬¬äºŒæ­¥ï¼Œæ•°æ®åº“çš„æ‹†åˆ†ã€‚ä¾ç„¶è¿˜æ˜¯ä¸€ä¸ªå•ä½“ï¼Œä½†è¿æ¥ä¸¤ä¸ªæ•°æ®åº“ã€‚\nå¢åŠ ä¸€ä¸ª DB ç”¨æ¥å­˜å‚¨æ‰“å¼€ç›¸å…³å†…å®¹ã€‚\nç¬¬ä¸‰æ­¥ï¼Œå°†æ‰“å¡æœåŠ¡å•ç‹¬éƒ¨ç½²ã€‚æ‰¿è½½ fork çš„è¯·æ±‚ï¼Œç„¶åæ¯”è¾ƒæ–°æ—§æœåŠ¡è¿”å›çš„ç»“æœæ˜¯å¦ä¸€è‡´ã€‚\næ³¨æ„åŒä¸€ä¸ª DB è¯»å–æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œä½†æ˜¯å†™å…¥éœ€è¦åšéš”ç¦»ã€‚\nç¬¬å››æ­¥ï¼Œé€šè¿‡ä¸€æ®µæ—¶é—´çš„æµ‹è¯•ï¼Œç¡®ä¿æœåŠ¡æµ‹è¯•é€šè¿‡åï¼Œå°±å¯ä»¥ä¸Šçº¿ã€‚\nåŠ ä¸€ä¸ª api_getwayï¼Œå°†è¯·æ±‚å…¨éƒ¨å‘åˆ°æ–°æœåŠ¡ä¸Šã€‚è¿™é‡Œè¦ä¿ç•™æ—§çš„æœåŠ¡ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œéšæ—¶å›æ»šã€‚\nç¬¬äº”æ­¥ï¼Œè€çš„æœåŠ¡ç¡®å®æ²¡æœ‰æµé‡äº†ï¼Œæ–°æœåŠ¡å®Œå…¨ç¨³å®šäº†ï¼Œå°†è€çš„æœåŠ¡åˆ é™¤ã€‚\nå‚è€ƒ ä¸ƒç‰›äº‘æ¶æ„å¸ˆå®è·µè¯¾\n","date":"2022-03-27T00:00:00Z","image":"http://img.golang.space/shot-1649475285445.png","permalink":"https://blog.golang.space/p/%E5%8D%95%E4%BD%93%E5%A6%82%E4%BD%95%E5%8D%87%E7%BA%A7%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1/","title":"å•ä½“å¦‚ä½•å‡çº§åˆ°å¾®æœåŠ¡"},{"content":"æ³›å‹ ç®€å•å°è¯•æ³›å‹å‡½æ•° 1 2 3 4 5 6 7 func SumIntsOrFloats[K comparable, V int64 | float64](m map[K]V) V { var s V for _, v := range m { s += v } return s } comparable å…è®¸å…¶å€¼å¯ç”¨ä½œæ¯”è¾ƒè¿ç®—ç¬¦çš„ä»»ä½•ç±»å‹ï¼Œè¿™é‡Œä½œä¸º map çš„ key æ˜¯å¿…è¦çš„ã€‚\nå‚æ•° V æ˜¯ä¸¤ç§ç±»å‹çš„è”åˆï¼Œä½¿ç”¨ | æŒ‡å®šï¼Œæ„å‘³ç€æ­¤çº¦æŸå…è®¸ä»»ä½•ä¸€ç§ç±»å‹ã€‚\nè°ƒç”¨æ–¹æ³•ã€‚æŒ‡å®šç±»å‹å‚æ•°ï¼Œä»¥ä¾¿æ¸…æ¥šåœ°äº†è§£åœ¨è°ƒç”¨çš„å‡½æ•°ä¸­æ›¿æ¢ç±»å‹å‚æ•°çš„ç±»å‹ã€‚é€šå¸¸å¯ä»¥çœç•¥ï¼Œå¦‚æœ Go ç¼–è¯‘å™¨å¯ä»¥ä»ä»£ç ä¸­æ¨æ–­å‡ºå®ƒä»¬ã€‚(è°ƒç”¨æ²¡æœ‰å‚æ•°çš„æ³›å‹å‡½æ•°ï¼Œæ— æ³•æ¨æ–­)\n1 2 3 4 fmt.Printf(\u0026#34;Generic Sums: %v and %v\\n\u0026#34;, SumIntsOrFloats[string, int64](ints), SumIntsOrFloats[string, float64](floats), ) å£°æ˜ç±»å‹çº¦æŸ å½“æ‚¨å¸Œæœ›å°†ç±»å‹å‚æ•°çº¦æŸä¸º int64æˆ– float64æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ª Number ç±»å‹çº¦æŸï¼Œè€Œä¸æ˜¯å†™å‡º int64 | float64ã€‚\n1 2 3 type Number interface { int64 | float64 } 1 2 3 4 5 6 7 func SumNumbers[K comparable, V Number](m map[K]V) V { var s V for _, v := range m { s += v } return s } å‚è€ƒ Go å®˜æ–¹æ³›å‹æ•™ç¨‹\næ³›å‹è®¾è®¡\n","date":"2022-03-18T18:00:00Z","permalink":"https://blog.golang.space/p/25.%E6%B3%9B%E5%9E%8B/","title":"25.æ³›å‹"},{"content":"åˆ†æä¸è¿½è¸ª è¿™é‡Œä¸»è¦å…³æ³¨ä¸¤ç§æ€§èƒ½åˆ†å‹ã€‚é’ˆå¯¹é˜»å¡å’Œäº’æ–¥é”æ‰€åšçš„æ€§èƒ½åˆ†æä»·å€¼ä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œé‚£æ˜¯é’ˆå¯¹ç¨‹åºä¸­å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚é˜»å¡æƒ…å†µè€Œåšçš„ï¼Œæ‰€ä»¥ä¸å¤ªèƒ½å¤Ÿçœ‹å‡ºç¨‹åºçš„æ•´ä½“çš„æƒ…å†µï¼Œå½“ç„¶ï¼Œæ¥ä¸‹æ¥è¯´æ˜çš„æŠ€å·§ä¹Ÿå¯ä»¥ç”¨åœ¨è¿™ä¸ªä¸Šé¢ã€‚\nCPU å±‚é¢çš„ å†…å­˜å±‚é¢çš„ é€šè¿‡è¿½è¸ªä¸ä»…èƒ½ç¨‹åºé‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Œè¿˜èƒ½çŸ¥é“å“ªäº›äº‹æƒ…æ²¡æœ‰å‘ç”Ÿã€‚\nä» CPU å±‚é¢ï¼Œæˆ‘ä»¬è¦å…³æ³¨çš„æ˜¯ç¨‹åºæŠŠå¤§éƒ¨åˆ†æ—¶é—´éƒ½è€—åœ¨å“ªäº›å‡½æ•°ä¸Šé¢ ä»å†…å­˜å±‚é¢ï¼Œè¦å…³æ³¨ä¸¤é¡¹æŒ‡æ ‡ ç¨‹åºè¦ç»™å †ä¸Šé¢æ”¾å¤šå°‘ä¸ªå€¼ï¼Œå¦‚æœè¿™æ ·çš„å€¼æ¯”è¾ƒå¤šä¸”æœ‰æ•ˆæœŸæ¯”è¾ƒçŸ­ï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å·¥ä½œå°±å¾—èŠ±è´¹å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆã€‚ å †çš„æ€»å¤§å°ï¼Œèƒ½ä¸èƒ½å°‘ç”¨ä¸€äº›ç©ºé—´ æ ˆè¿½è¸ª ç¨‹åºå‘ç”Ÿ panic æ—¶ï¼Œç»ˆç«¯ä¼šè¾“å‡ºæ ˆè°ƒç”¨ä¿¡æ¯ã€‚\nå¾®è§‚ä¼˜åŒ– å…³æ³¨å•ä¸ªå‡½æ•°ï¼Œè®©è¿™ä¸ªå‡½æ•°è¿è¡Œæ›´å¿«ï¼Œå¯èƒ½è¦æŸ¥çœ‹ CPU çš„ä½¿ç”¨æƒ…å†µï¼Œæˆ–å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µåˆ†æã€‚\nä½¿ç”¨ -memprofile å¯¹åŸºå‡†æµ‹è¯•ç”Ÿæˆå†…å­˜æŠ¥å‘Š\n1 go test -run none -bench . -benchtime 3s -benchmem -memprofile m.out go tool pprof å¯ä»¥æŸ¥çœ‹æ¶‰åŠ CPUï¼Œå†…å­˜ï¼Œä»¥åŠé˜»å¡çš„åˆ†ææ–‡ä»¶ã€‚\n1 2 3 go tool pprof -alloc_space m.out # é€šè¿‡ list å‘½ä»¤æŸ¥çœ‹åˆ†æ list \u0026lt;å‡½æ•°å\u0026gt; -alloc_space æŸ¥çœ‹å†…å­˜åˆ†é…æƒ…å†µ -alloc_objects æŸ¥çœ‹å„ç§å†…å®¹çš„æ•°é‡ -inuse_sapce é»˜è®¤é€‰é¡¹ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢æ¡†æœ‰ä¸¤æ ã€‚ç¬¬ä¸€æ  flat è¡¨ç¤ºè¯¥è¡Œçš„å†…å­˜åˆ†é…ï¼Œå‡å¦‚æŸ¥çœ‹çš„ Profile æ˜¯é’ˆå¯¹ CPU ç”Ÿæˆçš„ï¼Œåˆ™è¯¥æ æ˜¯ CPU çš„ç”¨é‡ã€‚ç¬¬äºŒæ  cum è¡¨ç¤ºä»è¿™ä¸€è¡Œç®—èµ·ï¼Œä¸€ç›´æ²¿ç€è°ƒç”¨æ ˆå¾€ä¸‹ç´¯è®¡ï¼Œçœ‹çœ‹å®ƒæœ¬èº«åŠè°ƒç”¨çš„ä»£ç æ€»å…±åˆ†é…äº†å¤šå°‘å†…å­˜ã€‚\næ¯”å¦‚ä¸‹å›¾ä¸­çš„æ„æ€æ˜¯ï¼Œ26 è¡Œæœ¬èº«æ²¡æœ‰åˆ†é…å†…å­˜ï¼Œä½†æ˜¯å®ƒè°ƒç”¨æ ˆå¾€ä¸‹ç´¯è®¡ï¼Œå‘ç”Ÿäº†åˆ†é… 512.05kb å†…å­˜ã€‚\nä¹Ÿå¯ä»¥ä½¿ç”¨ç½‘é¡µç‰ˆ\nFlat è¯¥å‡½æ•°æœ¬æ¬¡è¿è¡Œè€—è´¹èµ„æº Flat% å æ€»èµ„æºçš„æ¯”ä¾‹ Sum% è¯¥æ•°æ®ç´¯è®¡è€—è´¹èµ„æºæ¯”ä¾‹ Cum è¯¥å‡½æ•°åŠè°ƒç”¨æ ˆæ€»è€—è´¹èµ„æº Cum% æ¯”ä¾‹ Name å‡½æ•°å èµ„æº - inuse_spce å·²åˆ†é…å°šæœªé‡Šæ”¾çš„å†…å­˜ inuse_objects å·²åˆ†é…ä½†å°šæœªé‡Šæ”¾çš„å¯¹è±¡æ•°é‡ alloc_space åˆ†é…çš„å†…å­˜æ€»é‡ alloc_objects åˆ†é…çš„å¯¹è±¡æ€»æ•° 1 2 3 4 5 6 # å®‰è£…å›¾å½¢å·¥å…·, ç”¨äºç»˜åˆ¶å›¾å½¢ brew install graphviz # ç”Ÿæˆ cpu.out æ–‡ä»¶ go test -bench . -cpuprofile cpu.out # è§å›¾2, è¾“å…¥ web åç”Ÿæˆ å›¾3 go tool pprof -http :3333 cpu.out æ ¹æ®å›¾ä¸­æ˜¾ç¤º, å“ªä¸€å—æœ€æ¶ˆè€—æ€§èƒ½, é’ˆå¯¹ä¿®æ”¹, ä½¿ç”¨ pprof ç»§ç»­è¿›è¡Œæµ‹è¯•, ä»¥å®Œæˆæ€§èƒ½ä¼˜åŒ–\nå®è§‚ä¼˜åŒ– æŸ¥çœ‹ç¨‹åºè°ƒåº¦ä¿¡æ¯ æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä»½è°ƒåº¦ä¿¡æ¯\n1 GODEBUG=schedtrace=1000 ./main \u0026gt; /dev/null ç»ˆç«¯ä¼šè¾“å‡ºæ­£åœ¨è¿è¡Œçš„è·Ÿå¯è¿è¡Œçš„ goroutineã€‚\nç¬¬ä¸€æ æ˜¯è¿½è¸ªä¿¡æ¯çš„æ—¶åˆ» ç¬¬äºŒæ æ˜¯æœ‰å¤šå°‘ä¸ª procså¯ä»¥ä½¿ç”¨ ç¬¬ä¸‰æ é—²ç½®çš„ procs æ•°é‡ ç¬¬å››æ æœ‰å¤šå°‘æ“ä½œç³»ç»Ÿçº§åˆ«çš„çº¿ç¨‹ ç¬¬äº”æ  spinningthreads ï¼ŒæŒ‡çš„æ˜¯æŸä¸ª procs å‘ç°è‡ªå·±ä¸€ç›´æ²¡äº‹åšï¼Œæ‰€ä»¥çºµå‘ä»åˆ«å¤„æ‹¿ä¸€ç‚¹å„¿ä»»åŠ¡è¿‡æ¥ï¼Œæˆ–è€…å°±æ˜¯æƒ³è®©è‡ªå·±åœ¨è¿™é‡Œç©ºè½¬ï¼Œé˜²æ­¢ç³»ç»ŸæŠŠè‡ªå·±ç»™åˆ‡æ¢æ‰ ç¬¬å…­æ æ˜¯é—²ç½®çš„ç³»ç»Ÿçº§çº¿ç¨‹ ç¬¬ä¸ƒæ æ˜¯å…¨å±€è¿è¡Œé˜Ÿåˆ— æœ€åæ˜¯æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼Œæ–¹æ‹¬å·çš„æ¯ä¸ªæ•°å­—éƒ½è¡¨ç¤ºä¸€ä¸ªé€»è¾‘å¤„ç†å™¨(procs) ç»™ç³»ç»Ÿå¢åŠ è´Ÿè½½åšæµ‹è¯•\n1 hey -m GET -c 100 -n 10000 \u0026#34;http://localhost:1323/app\u0026#34; å¦‚æœå‘ç”Ÿäº† goroutine æ³„éœ²ï¼Œé‚£ä¹ˆè¿™äº› goroutine å°±ä¼šè¿›å…¥ waiting çŠ¶æ€ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸å±€éƒ¨é˜Ÿåˆ—é‡Œçš„æ•°å­—å°±ä¼šä¸æ–­å¢é•¿ã€‚ç›¸åå¦‚æœä»»åŠ¡å®Œæˆï¼Œè¿™äº›æ•°å­—éƒ½ä¼šé™åˆ° 0ï¼Œè¯´æ˜æœåŠ¡å™¨æ˜¯å¾ˆå¥åº·çš„ï¼Œå¹¶æ²¡æœ‰æ³„éœ²ä»€ä¹ˆã€‚\næŸ¥çœ‹ç¨‹åºåƒåœ¾æ”¶é›†ä¿¡æ¯ æ¯æ¬¡åƒåœ¾æ”¶é›†æ‰“æ‰“å°ä¸€æ¡è¿½è¸ªä¿¡æ¯\n1 GODEBUG=gctrace=1 ./main \u0026gt; /dev/null gc 1 å’Œ gc 2\u0026hellip; åˆ†åˆ«è¡¨ç¤ºç¬¬å‡ æ¬¡åƒåœ¾æ”¶é›† ç¬¬äºŒæ è¡¨ç¤ºåœ¨ç”Ÿæˆè¿™æ¡ä¿¡æ¯æ—¶ï¼Œç¨‹åºå·²ç»è¿è¡Œäº†å¤šé•¿æ—¶é—´ ç¬¬ä¸‰æ è¡¨ç¤ºä¸ºäº†å®Œæˆè¿™æ¬¡åƒåœ¾æ”¶é›†å·¥ä½œï¼Œä½¿ç”¨äº†å¤šå°‘ CPU èµ„æºï¼Œå›¾ä¸­ä¸º 0%ï¼Œè¯´æ˜ä»»åŠ¡å®Œæˆçš„ç›¸å½“å¿« ç¬¬å››æ æ˜¾ç¤ºäº†åƒåœ¾æ”¶é›†çš„ä¸‰ä¸ªé˜¶æ®µæ‰€èŠ±çš„æ—¶é—´ï¼Œæ¯”å¦‚0.022+0.75+0.035 æ˜¯ STW + Concurrent +STWï¼Œä¸¤ä¸ª STW åŠ èµ·æ¥ä¸åº”è¯¥è¶…è¿‡ 100 å¾®ç§’(0.1 æ¯«ç§’)ï¼Œå¦‚æœå †æ­£åœ¨è†¨èƒ€ï¼Œé‚£ä¹ˆå¶å°”å¯èƒ½ä¼šè¶…è¿‡è¿™ä¸ªå€¼ï¼Œä½†ä¸åº”è¯¥é¢‘ç¹å‘ç”Ÿã€‚æˆ‘ä»¬è¦å…³æ³¨çš„æ˜¯ Concurrent å®é™…ç»è¿‡æ—¶é—´ã€‚ ç¬¬å››æ æ˜¯ CPU æ‰€èŠ±çš„æ—¶é—´ï¼Œæœ€å·¦è¾¹å’Œæœ€å³è¾¹å’Œä¸Šé¢ä¸€æ ·ï¼Œä¹Ÿæ˜¯ STW æ‰€èŠ±çš„æ—¶é—´ï¼Œä½†å®ƒå°†ä¸­é—´ Concurrent åˆ†æˆäº†ä¸‰ä¸ªå°çš„éƒ¨åˆ†ï¼Œè¿™é‡Œé‡ç‚¹æ˜¯æ£€æŸ¥ä¸¤ä¸ª STW æ‰€èŠ±çš„æ—¶é—´ã€‚ ç¬¬äº”æ ï¼Œå¦‚æœä½ æ€€ç–‘ç¨‹åºæœ‰å†…å­˜æ³„éœ²é—®é¢˜ï¼Œé‚£åªèƒ½é€šè¿‡è¿™ä¸ªåœ°æ–¹æ¥åˆ¤æ–­ã€‚4-\u0026gt;5-\u0026gt;1 MBï¼Œæ”¶é›†åƒåœ¾ä¹‹å‰çš„å †å¤§å°ï¼Œå®Œæˆæ”¶é›†åƒåœ¾åçš„å †å¤§å°ï¼Œæœ€åæ˜¯æ´»è·ƒå †çš„å¤§å°ã€‚ web åº”ç”¨å¼•å…¥ pprof ç›‘æµ‹æ€§èƒ½ 1 2 // å¼•å…¥åŒ…ï¼Œä»…ä»…æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ _ \u0026#34;net/http/pprof\u0026#34; allocs å¯¹è¿‡å»æ‰€æœ‰çš„å†…å­˜åˆ†é…è¡Œä¸ºé‡‡æ ·ï¼Œæ€§èƒ½è°ƒä¼˜æŸ¥çœ‹é‡ç‚¹æ­¤é¡¹ã€‚ block å¯¼è‡´é˜»å¡çš„å †æ ˆè·Ÿè¸ª cmdline å½“å‰ç¨‹åºé€šè¿‡ä»€ä¹ˆæ ·å‘½ä»¤è°ƒç”¨çš„ goroutine æ‰€æœ‰å½“å‰ goroutine çš„å †æ ˆç—•è¿¹ heap æ´»è·ƒå¯¹è±¡å†…å­˜åˆ†é…æƒ…å†µï¼Œheap æ˜¯ä»¥å‰çš„è€è·¯å¾„ï¼Œallocs æ˜¯1.11 åŠ è¿›æ¥äº†æ–°è·¯å¾„ã€‚ pprof ä¼šæ³¨å†Œåˆ°net/http åŒ…é»˜è®¤çš„æœåŠ¡ä¸Šï¼Œå»ºè®®å•ç‹¬å¼€ä¸€ä¸ªä¸“é—¨ pprof çš„æœåŠ¡ï¼Œç«¯å£ä¸è¦æš´éœ²åˆ°å…¬ç½‘ã€‚\nåˆ†ææ­£åœ¨è¿è¡Œçš„ Go ç¨‹åº CPU è¿™è·Ÿ heap æ–¹é¢çš„æ•°æ®æœ‰ç‚¹åŒºåˆ«ï¼Œé‚£ä¸ªåªéœ€è¦æ ¹æ®ä»¥å¾€çš„å †æ•°æ®å°±èƒ½ç»Ÿè®¡å‡ºæ¥ã€‚ä½† CPU æ–¹é¢çš„ä¸åŒï¼Œè¦æƒ³å¾—åˆ°æœ‰æ•ˆçš„æŠ¥å‘Šï¼Œå¿…é¡»ç»™ç¨‹åºå¢åŠ è´Ÿè½½ï¼Œé»˜è®¤çš„æ ‡å‡†ä¸­ï¼Œåœ¨ç”Ÿæˆ CPU æŠ¥å‘Šæ—¶ï¼Œéœ€è¦è®©ç¨‹åºè¿è¡Œ 30 ç§’ï¼Œä»¥ä¾¿æ”¶é›†è¶³å¤Ÿé‡çš„æ•°æ®ã€‚\nå¦‚æœä½ æƒ³è‡ªå®šä¹‰æ—¶é—´\n1 http://localhost:6060/debug/pprof/profile?seconds=5 åˆ†æ CPU\n1 go tool pprof -http :5050 \u0026#34;http://localhost:6060/debug/pprof/profile\u0026#34; å¦ä¸€ç§åŠæ³•åšæ€§èƒ½åˆ†æ é™¤äº†å‘½ä»¤è¡Œ go tool pprof ï¼Œè¿˜æœ‰å¦ä¸€ç§åŠæ³•åšæ€§èƒ½åˆ†æã€‚\nç¨‹åºä¼šå‘æ ‡å‡†è¾“å‡ºç«¯è¾“å‡ºä¸€ä»½åˆ†ææŠ¥å‘Šã€‚ æ³¨æ„: ä¸æ²¡æœ‰åšæ€§èƒ½åˆ†ææ—¶ç›¸æ¯”ï¼Œè¿™æ¬¡çš„ç¨‹åºèŠ±çš„æ—¶é—´ä¼šé•¿ä¸€äº›ã€‚\n1 2 3 4 5 6 7 import \u0026#34;runtime/pprof\u0026#34; func main() { pprof.StartCPUProfile(os.Stdout) defer pprof.StopCPUProfile() // ... } 1 2 3 main \u0026gt; cpu.out go tool pprof cpu.out æœ‰æ—¶ï¼Œä½ ä¼šå‘ç°å¤§éƒ¨åˆ†æ€§èƒ½æ¶ˆè€—åœ¨æ“ä½œç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œprofile æ²¡èƒ½å‘æŒ¥ä½œç”¨ï¼Œè¯•è¯• traceã€‚\nç”¨ Tracer è¿½è¸ªç¨‹åºè¿è¡Œæƒ…å†µ åš trace ä¹Ÿæœ‰å¾ˆå¤šç§åŠæ³•:\nåœ¨å‘½ä»¤è¡Œé‡Œæ‰§è¡Œ benchmark çš„æ—¶å€™å¢åŠ  -trace é€‰é¡¹ æ ‡å‡†åº“é‡Œçš„å‡½æ•° æœ‰æ—¶å€™æˆ‘ä»¬è¦çœ‹çš„ä¸æ˜¯ç¨‹åºå‘ç”Ÿäº†ä»€ä¹ˆï¼Œè€Œæ˜¯è¿˜æ²¡æœ‰å‘ç”Ÿçš„äº‹æƒ…ã€‚\n1 2 3 4 5 6 7 import \u0026#34;runtime/trace\u0026#34; func main() { trace.Start(os.Stdout) defer trace.Stop() // ... } è¿½è¸ªå’Œæ€§èƒ½æµ‹è¯•ä¸åŒï¼Œå®ƒä¸è¦æ±‚ç¨‹åºå¿…é¡»åœä¸‹æ¥ï¼Œåªæ˜¯ä¼šæŠŠæ¯æ¬¡å‡½æ•°è°ƒç”¨éƒ½è®°å½•ä¸‹æ¥ï¼Œè€Œä¸”ä¼šç²¾ç¡®åˆ°å¾®ç§’çº§åˆ«ã€‚\n1 2 main \u0026gt; cpu.out go tool trace c.out ","date":"2022-03-01T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%88%86%E6%9E%90%E4%B8%8E%E8%BF%BD%E8%B8%AA/","title":"åˆ†æä¸è¿½è¸ª"},{"content":"æ–°çš„æ€ç»´æ–¹å¼ ä»£ç è¡Œæ•°ï¼Œç¡®å®ä¼šå½±å“é¡¹ç›®çš„å¥åº·ç¨‹åºï¼Œå›¢é˜Ÿçš„å¥åº·ç¨‹åºã€‚\nå¦‚æœå°† Linux è§†ä¸ºä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œé‚£ä¹ˆä»Šå¤©è¯¥é¡¹ç›®ä¸­çº¦æœ‰ 2400 ä¸‡è¡Œä»£ç ï¼Œè¿™éå¸¸åºå¤§ï¼Œéœ€è¦ä¸€ä¸ªåºå¤§çš„å›¢é˜Ÿæ¥å¤„ç†ã€‚\næˆä¸ºè´¨é‡ï¼Œæ•ˆç‡å’Œç®€å•æ€§çš„æ‹¥æŠ¤è€…ã€‚\næ˜¯ä»€ä¹ˆæ¨åŠ¨äº†æˆ‘åšå‡ºçš„å·¥ç¨‹å†³ç­–? ä½œä¸ºå¼€å‘äººå‘˜ï¼Œæˆ‘åœ¨è¿›æ­¥å—?\né‡‡ç”¨æ–°æŠ€æœ¯æ€»æ˜¯å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯é‡‡ç”¨æ–°çš„æ€ç»´æ–¹å¼å´å¾ˆéš¾ã€‚\nå°‘å³æ˜¯å¤š å¦‚æœä½ çš„å·¥ä½œåšå¾—å¾ˆå¥½ï¼Œæ²¡äººåº”è¯¥çŸ¥é“ä½ çš„åå­—ã€‚\nå¦‚æœæœ‰äººçŸ¥é“ä½ çš„åå­—ï¼Œå¯èƒ½æ„å‘³ç€ä½ çš„è½¯ä»¶å‡ºç°æ•…éšœæˆ–å¯¼è‡´é—®é¢˜ã€‚\nä½ æƒ³è®©åˆ«äººçŸ¥é“ä½ çš„åå­—å—? æˆä¸ºå‰ç«¯å¼€å‘è€…ã€‚é‚£ä½ ä¼šèŠ±ä¸¤å‘¨çš„æ—¶é—´åœ¨å±å¹•ä¸Šå·¥ä½œï¼Œä¼šæœ‰äººçœ‹ç€ä½ çš„é¡µé¢æŒ‡å‡ºäº†ä»–ä»¬ä¸å–œæ¬¢çš„ä¸œè¥¿ã€‚å•Šï¼Œè¿™æ›¾ç»è®©æˆ‘å‘ç–¯ã€‚\nä¸ç®¡æ˜¯ä»€ä¹ˆè¡Œä¸šï¼Œä¸ç®¡è½¯ä»¶æ˜¯å¦æ­£ç¡®ï¼Œäººä»¬çš„ç”Ÿæ´»ï¼Œä»–ä»¬çš„å¹¸ç¦ï¼Œä¸€åˆ‡éƒ½ä¾èµ–äºä½ æ­£åœ¨æ„å»ºçš„æŠ€æœ¯ã€‚æˆ‘ä»¬å¿…é¡»è®¤çœŸå¯¹å¾…ï¼Œä¿æŒè½¯ä»¶çš„å®Œæ•´æ€§ã€‚\nå®Œæ•´æ€§æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªå¾®è§‚å±‚é¢å’Œä¸€ä¸ªå®è§‚å±‚é¢ã€‚\nåœ¨å¾®è§‚å±‚é¢ï¼Œéœ€è¦æ˜ç™½ä½ å†™çš„æ¯ä¸€è¡Œä»£ç ã€‚æ¯ä¸€è¡Œä»£ç è¦ä¹ˆåšä¸‰ä»¶äº‹ä¹‹ä¸€ï¼Œå®ƒåˆ†é…å†…å­˜ï¼Œè¯»å–å†…å­˜ï¼Œå†™å…¥å†…å­˜ã€‚ä½¿ç”¨ Go è¯­è¨€ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­æ‰€éœ€è¦åšçš„åªæ˜¯è¯»å–å¹¶å†™å…¥å†…å­˜ï¼Œæ‰€æœ‰è¿™äº›è¯»å–å’Œå†™å…¥éƒ½ä¼šå¯¼è‡´æˆ‘ä»¬å‘¨å›´çš„ä¸€åˆ‡å‘ç”Ÿ: ç¯äº®äº†ã€‚ä½ æ­£åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚\nä¸Šé¢æåˆ°è¿‡ï¼Œä¸€èˆ¬å¼€å‘è€…é¢å¯¹è¶…è¿‡ 10000 è¡Œä»£ç ï¼Œä¼šäº§ç”Ÿä¸¥é‡çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚è€Œä¸”å¹³å‡æ¯ 100 è¡Œä»£ç æœ‰å¯èƒ½ä¼šäº§ç”Ÿ 10-20 ä¸ªé”™è¯¯ã€‚å½“ä»£ç æ¯”é¢„ä¼°éœ€è¦çš„å¤šæ—¶ï¼Œå°±ä¼šæœ‰æ›´å¤šçš„åœ°æ–¹å¯ä»¥éšè—é”™è¯¯ï¼Œè¿™ä¹Ÿæ„å‘³ç€æœ‰æ›´å¤šä¸å®Œæ•´çš„æµ‹è¯•ã€‚\né™¤äº†ç¼–å†™æ›´å°‘çš„ä»£ç ä¹‹å¤–ï¼Œå®Œæ•´æ€§çš„å¦ä¸€ä¸ªé‡è¦éƒ¨åˆ†æ˜¯é”™è¯¯å¤„ç†ã€‚ä½ çš„è½¯ä»¶å¿…é¡»ä¿æŒç¨³å®šï¼Œè€Œä¸æ˜¯å¢åŠ å±æœºï¼Œåº”è¯¥è¯•å›¾ä»é”™è¯¯ä¸­æ¢å¤ã€‚\nless is always more\nå®Œæ•´æ€§æ˜¯é¦–è¦çš„ï¼Œæ¬¡è¦çš„æ˜¯å¯è¯»æ€§ã€‚è¦ä»¥ä¸€ç§æ˜“äºç†è§£çš„æ–¹å¼æ„å»ºæˆ‘ä»¬çš„è½¯ä»¶ã€‚\næŠ½è±¡çš„ç›®çš„ä¸æ˜¯æ¨¡ç³Šï¼Œè€Œæ˜¯åˆ›é€ ä¸€ä¸ªæ–°çš„è¯­ä¹‰å±‚æ¬¡ï¼Œä¸€ä¸ªå¯ä»¥ç»å¯¹ç²¾ç¡®çš„å±‚æ¬¡ã€‚\nå°è£…ä¸ä»…ä»…æ˜¯å¯æµ‹è¯•çš„ï¼Œè¦ç¡®ä¿å®ƒä»¬æä¾›äº†ä¸€ç§è¯­ä¹‰ç²¾ç¡®çš„å±‚æ¬¡ï¼Œè€Œä¸æ˜¯éšè—å¤æ‚æ€§ã€‚\næ€§èƒ½ è½¯ä»¶çš„æ€§èƒ½ä¸è¶³ï¼Œæœ‰å¯èƒ½æ¥è‡ªå››ä¸ªåœ°æ–¹ã€‚\nå»¶è¿Ÿï¼Œç½‘ç»œï¼ŒIOï¼Œç£ç›˜ IO ç­‰ç±»å‹çš„å»¶è¿Ÿ åƒåœ¾å›æ”¶å’Œå†…å­˜åˆ†é… è®¿é—®æ•°æ®çš„æ–¹å¼ï¼Œæ•ˆç‡ ç®—æ³•æ•ˆç‡ï¼Œæ˜¯å¦å¯ä»¥ä¼˜åŒ–ç®—æ³•ä»¥é‡‡å–æ›´å°‘çš„æ­¥éª¤è€Œä¸æ˜¯æ›´å¤šçš„æ­¥éª¤ è®©å®ƒæ­£ç¡®ï¼Œè®©å®ƒæ¸…æ™°ï¼Œè®©å®ƒç®€æ´ï¼Œè®©å®ƒå¿«é€Ÿ\né¢å‘æ•°æ®çš„è®¾è®¡ Go è¯­è¨€çš„ç‰¹æ€§ï¼Œå®ƒè¦æ±‚ä½ å¿…é¡»æŠŠè‡ªå·±çš„æ€ç»´æ–¹å¼ï¼Œä» é¢å‘å¯¹è±¡çš„è®¾è®¡ åˆ° é¢å‘æ•°æ®çš„è®¾è®¡ã€‚\næ€ä¹ˆæ‰èƒ½å°†ä»£ç å’Œæœ‰å¯èƒ½æ”¹å˜çš„æ•°æ®ç›¸è§£è€¦å‘¢? å¦‚ä½•å¯ä»¥è§£è€¦ï¼Œé‚£å°±å¯ä»¥å°½é‡é™ä½ç”±äºæ•°æ®æ”¹åŠ¨é€ æˆçš„è¿é”ååº”ã€‚\næ€»æ˜¯åœ¨åšæŠ½è±¡ï¼Œåœ¨æŠ½è±¡ä¸Šé¢åšå¦ä¸€å±‚æŠ½è±¡ï¼Œé‚£ä¹ˆå°±ä¼šç¦»ä¸Šé¢è¯´çš„è§£è€¦è¶Šæ¥è¶Šè¿œï¼Œè€Œä¸”å¾ˆéš¾ä¿è¯ä»£ç å‡†ç¡®æ— è¯¯ï¼Œæ¸…æ™°æ˜“è¯»ï¼Œå› ä¸ºè¿™æ ·å†™å‡ºæ¥çš„ä»£ç å¤ªè¿‡æŠ½è±¡ï¼Œè®©æˆ‘ä»¬å¾ˆéš¾ç†è§£å…¶ä¸­çš„æ€è·¯ã€‚\nä»£ç è¦é’ˆå¯¹å½“ä¸‹æ¥å†™ï¼Œæ¶æ„è¦é¢å‘æœªæ¥è®¾è®¡ã€‚ä¸è¦å†™å‡ºç›®å‰æ ¹æœ¬ç”¨ä¸åˆ°çš„ä»£ç ï¼Œé‚£æ ·å†™åªä¼šäº§ç”Ÿæ›´å¤šçš„ bugã€‚å› ä¸ºä»£ç è¶Šå¤šï¼Œè¶Šå®¹æ˜“å‡º bugã€‚\né¢å‘æ•°æ®çš„è®¾è®¡ï¼Œæ˜¯è¦æ±‚å¿…é¡»å°†æ•°æ®ææ‡‚ï¼Œè¦æ±‚æˆ‘ä»¬åªç¼–å†™å¿…é¡»ç”¨åˆ°çš„ä»£ç å’Œç®—æ³•ï¼Œè¦å¯¹ç®—æ³•è§£è€¦ï¼Œä»¥é™ä½æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶æ•´ä¸ªé¡¹ç›®å—åˆ°çš„å½±å“ã€‚æˆ‘ä»¬è¦åšæ˜¯ï¼Œæ€æ ·åšåˆ°æ•°é‡æœ€å°‘å†™æ³•æœ€æ¸…æ™°çš„ä»£ç æŠŠé—®é¢˜è§£å†³ã€‚\næ•°æ®åº”è¯¥åœ¨ç‰¹å®šçš„æƒ…å†µä¸‹æ‰æœ‰è¡Œä¸ºï¼Œå¦‚æœä½ æ˜¯ä»é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€åˆ‡æ¢åˆ° Goï¼Œé‚£å¯èƒ½ä¸å¤ªå®¹æ˜“æ¥å—è¿™ç§ç†å¿µã€‚å› ä¸º OOP æ€»æ˜¯è¦æ±‚ä½ è€ƒè™‘æ•°æ®çš„çŠ¶æ€ï¼Œä»¥åŠæ•°æ®ä¼šæœ‰æ€æ ·çš„è¡Œä¸ºã€‚é¢å‘å¯¹è±¡å¹¶ä¸æ˜¯ Go è¯­è¨€é‡Œé¢æœ€å¥½çš„ç¼–ç¨‹æ€è·¯ï¼ŒGo è¯­è¨€åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¿½æ±‚çš„å…¶å®æ˜¯æŠŠçŠ¶æ€è·Ÿè¡Œä¸ºåˆ†å¼€ï¼Œåšåˆ°è¿™ç‚¹å¯ä»¥å°‘å†™ä¸€ç‚¹ä»£ç ï¼Œå¹¶ä¸”å¯ä»¥ç®€åŒ–ç¼–ç¨‹å·¥ä½œã€‚\né¦–å…ˆåº”è¯¥è€ƒè™‘å‡½æ•°ï¼Œåªæœ‰åœ¨ä¸è¯¥ç”¨æˆ–ä¸æ–¹ä¾¿ä½¿ç”¨å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥è€ƒè™‘æ–¹æ³•ã€‚\né—ç•™ä»£ç  æˆ‘ä»¬è®¤ä¸ºç³Ÿç³•çš„ä»£ç æ˜¯ç”±ç³Ÿç³•çš„å¼€å‘äººå‘˜ç¼–å†™çš„ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒæ˜¯ç”±åˆé€‚çš„å¼€å‘äººå‘˜åœ¨\u0026rsquo;ç³Ÿç³•çš„æƒ…å†µä¸‹\u0026rsquo;ç¼–å†™çš„ã€‚\næ€»ä¼šæœ‰äººè¯·ä½ å¸®ä»–çœ‹ä»£ç ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—å†™ä»£ç çš„äººæ˜¯ä¸æ˜¯å‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼Œæ€ä¹ˆä¼šå†™å‡ºè¿™æ ·çš„ä¸œè¥¿å‘¢?\nå…¶å®è¿™èƒŒåæ˜¯æœ‰åŸå› çš„ï¼Œä»–ä»¬æ²¡æœ‰åŠæ³•å‘Šè¯‰ä½ ï¼Œé‡åˆ°è¿™ç§ä»£ç çš„æ—¶å€™åƒä¸‡åˆ«æ€¥ã€‚å…ˆå†·é™ä¸‹æ¥ï¼Œåˆ«æ€¥ç€å»è´£æ€ªå†™å®ƒçš„é‚£ä¸ªäººï¼Œæˆ‘ä»¬åº”è¯¥é—®é—®è‡ªå·±ï¼Œè¿™ç§ä»£ç æ˜¯åœ¨ä»€ä¹ˆæ ·çš„ç¯å¢ƒæˆ–ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹å†™å‡ºæ¥çš„ã€‚\nç°åœ¨æ—¢ç„¶äº¤ç»™è‡ªå·±æ¥ç»´æŠ¤ï¼Œé‚£æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½æŠŠå®ƒæ”¹çš„å¥½ä¸€äº›å‘¢?\næ— è®ºé¢å¯¹ä»€ä¹ˆäº‹éƒ½åº”è¯¥æœ‰åŒç†å¿ƒï¼Œå› ä¸ºåšé‚£ä»¶äº‹çš„äººæ‰€å¤„çš„æƒ…å†µå¯èƒ½å’Œä½ ç°åœ¨ä¸ä¸€æ ·ï¼Œç°åœ¨æ˜¯æŠŠåˆ«äººå†™è¿‡çš„ä»£ç äº¤ç»™ä½ æ¥ç»´æŠ¤ï¼Œåè¿‡æ¥ä½ çš„ä»£ç ä¹Ÿæœ‰å¯èƒ½äº¤ç»™åˆ«äººæ¥ç»´æŠ¤ã€‚å¦‚æœèƒ½å¤Ÿæ¢ä½æ€è€ƒï¼Œé‚£ä¹ˆè·Ÿé—ç•™ä»£ç æœ‰å…³çš„è®¸å¤šé—®é¢˜æˆ–è®¸å°±èƒ½å¤Ÿè§£å†³ã€‚\nå¦‚æœä½ æƒ³ä¸€å¼€å§‹å°±æŠŠä»£ç å†™å¥½ï¼Œè€Œä¸æƒ³å†™å‡ºé‚£ç§ç•™æœ‰å¾ˆæœ‰é—®é¢˜çš„ä»£ç ï¼Œé‚£ä¹ˆé¦–å…ˆè¦æ³¨æ„çš„ï¼Œå°±æ˜¯æé†’è‡ªå·±ï¼Œè¿™å¥—ä»£ç ä¼˜é‡‡ç”¨ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥å†™ï¼Œå†™ä»£ç çš„æ€è·¯ç‰¹åˆ«å…³é”®ï¼Œæ¯å¤©é‡æ„ä»£ç ï¼Œå…¶å®éƒ½æ˜¯æŒ‰è¿™æ ·çš„æ€è·¯è¿›è¡Œä¿®æ”¹çš„ã€‚\nåœ¨å¼€å‘è€…è„‘å­é‡Œï¼Œé€šå¸¸æ²¡åŠæ³•å®¹ä¸‹è¶…è¿‡ 10000 è¡Œä»£ç ï¼Œè¿™é‡Œçš„å®¹ä¸‹ä¸æ˜¯æŒ‡å°†æ¯è¡Œä»£ç éƒ½èƒŒä¸‹æ¥ã€‚è€Œæ˜¯å¦‚æœæœ‰äººé—®ä½ æŸä¸ªå‡½æ•°åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œæˆ–æ˜¯æŸé¡¹åŠŸèƒ½çš„å®ç°ä»£ç åœ¨å“ªé‡Œï¼Œä½ å¯ä»¥å¾ˆå¿«çš„æ‰¾å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ èƒ½å¤Ÿå¼„æ¸…ä»£ç çš„æµç¨‹ï¼Œå¯¹ä»£ç éå¸¸çš„ç†Ÿæ‚‰ã€‚å¦‚æœç¨‹åºå‘ç”Ÿé”™è¯¯ï¼Œå¾ˆå¿«å°±èƒ½çŸ¥é“è‡ªå·±åº”è¯¥ä»å“ªå—ä»£ç å…¥æ‰‹ã€‚\næˆ‘ä»¬è¦å…³æ³¨ä»£ç è¡Œæ•°ï¼ŒæŠŠå®ƒé™ä½ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å›¢é˜Ÿåˆä½œé¡ºåˆ©ã€‚æ¯ä½ç¨‹åºå‘˜æ‰€éœ€è¦æŠŠæ§çš„ä»£ç ä¸åº”è¶…è¿‡ 10000 è¡Œï¼Œè¿™ç§è®¤çŸ¥æ–¹é¢çš„è´Ÿæ‹…å¿…é¡»å¼•èµ·é‡è§†ã€‚\næœ€éš¾å¯¹ä»˜çš„ bug æ˜¯æ€è·¯ä¸Šçš„ bugï¼Œå› ä¸ºä½ æ ¹æœ¬çœ‹ä¸å‡ºé—®é¢˜åœ¨å“ªã€‚\nä¸åº”è¯¥ç¬¬ä¸€æ—¶é—´ä½¿ç”¨è°ƒè¯•å™¨ï¼Œå¦‚æœæ­£å¼çš„è½¯ä»¶äº§å“é‡Œé¢å‡ºç°äº†é”™è¯¯ï¼Œé‚£ä½ åªåº”è¯¥é€šè¿‡æ•´ç†æ€è·¯ï¼Œæˆ–è€…æŸ¥çœ‹æ—¥å¿—æ¥è§£å†³é—®é¢˜ï¼Œå¦‚æœè¿™äº›æ–¹æ³•è¿˜æ˜¯ä¸èƒ½å¸®ä½ æ‰¾åˆ° bugï¼Œé‚£å°±è¯´æ˜è¿™æ®µä»£ç çš„å†™æ³•å‡ºäº†é—®é¢˜ã€‚å¦‚æœéœ€è¦è°ƒè¯•å™¨æ‰èƒ½è§£å†³é—®é¢˜ï¼Œå¯èƒ½è¿™æ®µä»£ç éœ€è¦é‡æ„ã€‚å› ä¸ºæ ¹æœ¬é—®é¢˜åœ¨äºä¿®æ­£æ€è·¯ä¸Šçš„é”™è¯¯ã€‚è¦åœ¨æ—¥å¿—é‡Œé¢å¤šè®°å½•ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬è¿˜åŸå½“æ—¶å‡ºé”™çš„è¿‡ç¨‹ã€‚\nGo æ˜¯æˆ‘è§è¿‡çš„åŠ›é‡å’Œè¡¨ç°åŠ›ä¹‹é—´çš„æœ€ä½³å¹³è¡¡ï¼Œé€šè¿‡ç®€å•ç›´æ¥çš„ç¼–ç¨‹ï¼Œä½ å‡ ä¹å¯ä»¥åšä»»ä½•ä½ æƒ³åšçš„äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œå¯¹æœºå™¨ä¸Šå°†è¦å‘ç”Ÿçš„äº‹æƒ…æœ‰ä¸€ä¸ªè‰¯å¥½çš„å¿ƒç†æ¨¡å‹\n","date":"2022-02-25T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%BA%94%E8%AF%A5%E6%9C%89%E7%9A%84-go-%E8%AF%AD%E8%A8%80%E6%80%9D%E7%BB%B4/","title":"åº”è¯¥æœ‰çš„ Go è¯­è¨€æ€ç»´"},{"content":"\u0026lt;Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜\u0026gt;è¯»ä¹¦ç¬”è®° åŸºç¡€ ç®€å•æ¥è¯´ï¼Œåº•å±‚æ•°æ®ç»“æ„ä¸€å…±æœ‰ 6 ç§ï¼Œåˆ†åˆ«æ˜¯ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ã€åŒå‘é“¾è¡¨ã€å‹ç¼©åˆ—è¡¨ã€å“ˆå¸Œè¡¨ã€è·³è¡¨å’Œæ•´æ•°æ•°ç»„ã€‚å®ƒä»¬å’Œæ•°æ®ç±»å‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä¸ºäº†å®ç°ä»é”®åˆ°å€¼çš„å¿«é€Ÿè®¿é—®ï¼ŒRedis ä½¿ç”¨äº†ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰é”®å€¼å¯¹ã€‚\nå“ˆå¸Œè¡¨çš„æœ€å¤§å¥½å¤„å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯è®©æˆ‘ä»¬å¯ä»¥ç”¨ O(1) çš„æ—¶é—´å¤æ‚åº¦æ¥å¿«é€ŸæŸ¥æ‰¾åˆ°é”®å€¼å¯¹\nä¸ºä»€ä¹ˆå“ˆå¸Œè¡¨æ“ä½œå˜æ…¢äº†ï¼Ÿ\nå½“ä½ å¾€å“ˆå¸Œè¡¨ä¸­å†™å…¥æ›´å¤šæ•°æ®æ—¶ï¼Œå“ˆå¸Œå†²çªæ˜¯ä¸å¯é¿å…çš„é—®é¢˜ã€‚è¿™é‡Œçš„å“ˆå¸Œå†²çªï¼Œä¹Ÿå°±æ˜¯æŒ‡ï¼Œä¸¤ä¸ª key çš„å“ˆå¸Œå€¼å’Œå“ˆå¸Œæ¡¶è®¡ç®—å¯¹åº”å…³ç³»æ—¶ï¼Œæ­£å¥½è½åœ¨äº†åŒä¸€ä¸ªå“ˆå¸Œæ¡¶ä¸­ã€‚\nRedis è§£å†³å“ˆå¸Œå†²çªçš„æ–¹å¼ï¼Œå°±æ˜¯é“¾å¼å“ˆå¸Œã€‚å°±æ˜¯æŒ‡åŒä¸€ä¸ªå“ˆå¸Œæ¡¶ä¸­çš„å¤šä¸ªå…ƒç´ ç”¨ä¸€ä¸ªé“¾è¡¨æ¥ä¿å­˜ï¼Œå®ƒä»¬ä¹‹é—´ä¾æ¬¡ç”¨æŒ‡é’ˆè¿æ¥ã€‚\nå“ˆå¸Œå†²çªé“¾ä¸Šçš„å…ƒç´ åªèƒ½é€šè¿‡æŒ‡é’ˆé€ä¸€æŸ¥æ‰¾å†æ“ä½œã€‚å¦‚æœå“ˆå¸Œè¡¨é‡Œå†™å…¥çš„æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œå“ˆå¸Œå†²çªå¯èƒ½ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œè¿™å°±ä¼šå¯¼è‡´æŸäº›å“ˆå¸Œå†²çªé“¾è¿‡é•¿ï¼Œè¿›è€Œå¯¼è‡´è¿™ä¸ªé“¾ä¸Šçš„å…ƒç´ æŸ¥æ‰¾è€—æ—¶é•¿ï¼Œæ•ˆç‡é™ä½ã€‚\nå¯¹äº String ç±»å‹æ¥è¯´ï¼Œæ‰¾åˆ°å“ˆå¸Œæ¡¶å°±èƒ½ç›´æ¥å¢åˆ æ”¹æŸ¥äº†ï¼Œæ‰€ä»¥ï¼Œå“ˆå¸Œè¡¨çš„ O(1) æ“ä½œå¤æ‚åº¦ä¹Ÿå°±æ˜¯å®ƒçš„å¤æ‚åº¦äº†ã€‚\nå¯¹äºé›†åˆç±»å‹æ¥è¯´ï¼Œå³ä½¿æ‰¾åˆ°å“ˆå¸Œæ¡¶äº†ï¼Œè¿˜è¦åœ¨é›†åˆä¸­å†è¿›ä¸€æ­¥æ“ä½œã€‚\nå•å…ƒç´ æ“ä½œï¼Œæ˜¯æŒ‡æ¯ä¸€ç§é›†åˆç±»å‹å¯¹å•ä¸ªæ•°æ®å®ç°çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚ä¾‹å¦‚ï¼ŒHash ç±»å‹çš„ HGETã€HSET å’Œ HDELï¼ŒSet ç±»å‹çš„ SADDã€SREMã€SRANDMEMBER ç­‰ã€‚è¿™äº›æ“ä½œçš„å¤æ‚åº¦ç”±é›†åˆé‡‡ç”¨çš„æ•°æ®ç»“æ„å†³å®šï¼Œä¾‹å¦‚ï¼ŒHGETã€HSET å’Œ HDEL æ˜¯å¯¹å“ˆå¸Œè¡¨åšæ“ä½œï¼Œæ‰€ä»¥å®ƒä»¬çš„å¤æ‚åº¦éƒ½æ˜¯ O(1)ï¼›Set ç±»å‹ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„æ—¶ï¼Œå®ƒçš„ SADDã€SREMã€SRANDMEMBER å¤æ‚åº¦ä¹Ÿæ˜¯ O(1)ã€‚\nèŒƒå›´æ“ä½œï¼Œæ˜¯æŒ‡é›†åˆç±»å‹ä¸­çš„éå†æ“ä½œï¼Œå¯ä»¥è¿”å›é›†åˆä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œæ¯”å¦‚ Hash ç±»å‹çš„ HGETALL å’Œ Set ç±»å‹çš„ SMEMBERSï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªèŒƒå›´å†…çš„éƒ¨åˆ†æ•°æ®ï¼Œæ¯”å¦‚ List ç±»å‹çš„ LRANGE å’Œ ZSet ç±»å‹çš„ ZRANGEã€‚è¿™ç±»æ“ä½œçš„å¤æ‚åº¦ä¸€èˆ¬æ˜¯ O(N)ï¼Œæ¯”è¾ƒè€—æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…ã€‚\nç»Ÿè®¡æ“ä½œï¼Œæ˜¯æŒ‡é›†åˆç±»å‹å¯¹é›†åˆä¸­æ‰€æœ‰å…ƒç´ ä¸ªæ•°çš„è®°å½•ï¼Œä¾‹å¦‚ LLEN å’Œ SCARDã€‚è¿™ç±»æ“ä½œå¤æ‚åº¦åªæœ‰ O(1)ï¼Œè¿™æ˜¯å› ä¸ºå½“é›†åˆç±»å‹é‡‡ç”¨å‹ç¼©åˆ—è¡¨ã€åŒå‘é“¾è¡¨ã€æ•´æ•°æ•°ç»„è¿™äº›æ•°æ®ç»“æ„æ—¶ï¼Œè¿™äº›ç»“æ„ä¸­ä¸“é—¨è®°å½•äº†å…ƒç´ çš„ä¸ªæ•°ç»Ÿè®¡ï¼Œå› æ­¤å¯ä»¥é«˜æ•ˆåœ°å®Œæˆç›¸å…³æ“ä½œã€‚\nä¾‹å¤–æƒ…å†µï¼Œæ˜¯æŒ‡æŸäº›æ•°æ®ç»“æ„çš„ç‰¹æ®Šè®°å½•ï¼Œä¾‹å¦‚å‹ç¼©åˆ—è¡¨å’ŒåŒå‘é“¾è¡¨éƒ½ä¼šè®°å½•è¡¨å¤´å’Œè¡¨å°¾çš„åç§»é‡ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¯¹äº List ç±»å‹çš„ LPOPã€RPOPã€LPUSHã€RPUSH è¿™å››ä¸ªæ“ä½œæ¥è¯´ï¼Œå®ƒä»¬æ˜¯åœ¨åˆ—è¡¨çš„å¤´å°¾å¢åˆ å…ƒç´ ï¼Œè¿™å°±å¯ä»¥é€šè¿‡åç§»é‡ç›´æ¥å®šä½ï¼Œæ‰€ä»¥å®ƒä»¬çš„å¤æ‚åº¦ä¹Ÿåªæœ‰ O(1)ï¼Œå¯ä»¥å®ç°å¿«é€Ÿæ“ä½œã€‚\nå®•æœºäº†ï¼Œå¦‚ä½•é¿å…æ•°æ®ä¸¢å¤± ä¸€æ—¦æœåŠ¡å™¨å®•æœºï¼Œå†…å­˜ä¸­çš„æ•°æ®å°†å…¨éƒ¨ä¸¢å¤±ã€‚\nRedis çš„æŒä¹…åŒ–ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼:\nAOFï¼ˆAppend Only Fileï¼‰æ—¥å¿— RDB (Redis DataBase) å¿«ç…§ AOF Redis æ˜¯å…ˆæ‰§è¡Œå‘½ä»¤ï¼ŒæŠŠæ•°æ®å†™å…¥å†…å­˜ï¼Œç„¶åæ‰è®°å½•æ—¥å¿—ã€‚\nä¼ ç»Ÿæ•°æ®åº“( å¦‚ Mysql )çš„æ—¥å¿—ï¼Œä¾‹å¦‚ redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼Œè®°å½•çš„æ˜¯ä¿®æ”¹åçš„æ•°æ®ï¼Œè€Œ AOF é‡Œè®°å½•çš„æ˜¯ Redis æ”¶åˆ°çš„æ¯ä¸€æ¡å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤æ˜¯ä»¥æ–‡æœ¬å½¢å¼ä¿å­˜çš„ã€‚\næˆ‘ä»¬ä»¥ Redis æ”¶åˆ°â€œset testkey â€å‘½ä»¤åè®°å½•çš„æ—¥å¿—ä¸ºä¾‹ï¼Œçœ‹çœ‹ AOF æ—¥å¿—çš„å†…å®¹ã€‚\nâ€œ*3â€è¡¨ç¤ºå½“å‰å‘½ä»¤æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯éƒ¨åˆ†éƒ½æ˜¯ç”±â€œ$+æ•°å­—â€å¼€å¤´ï¼Œåé¢ç´§è·Ÿç€å…·ä½“çš„å‘½ä»¤ã€é”®æˆ–å€¼ã€‚è¿™é‡Œï¼Œâ€œæ•°å­—â€è¡¨ç¤ºè¿™éƒ¨åˆ†ä¸­çš„å‘½ä»¤ã€é”®æˆ–å€¼ä¸€å…±æœ‰å¤šå°‘å­—èŠ‚ã€‚ä¾‹å¦‚ï¼Œâ€œ$3 setâ€è¡¨ç¤ºè¿™éƒ¨åˆ†æœ‰ 3 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯â€œsetâ€å‘½ä»¤ã€‚\nä½†æ˜¯ï¼Œä¸ºäº†é¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€ï¼ŒRedis åœ¨å‘ AOF é‡Œé¢è®°å½•æ—¥å¿—çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå…ˆå»å¯¹è¿™äº›å‘½ä»¤è¿›è¡Œè¯­æ³•æ£€æŸ¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœå…ˆè®°æ—¥å¿—å†æ‰§è¡Œå‘½ä»¤çš„è¯ï¼Œæ—¥å¿—ä¸­å°±æœ‰å¯èƒ½è®°å½•äº†é”™è¯¯çš„å‘½ä»¤ï¼ŒRedis åœ¨ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºé”™ã€‚\nè€Œå†™åæ—¥å¿—è¿™ç§æ–¹å¼ï¼Œå°±æ˜¯å…ˆè®©ç³»ç»Ÿæ‰§è¡Œå‘½ä»¤ï¼Œåªæœ‰å‘½ä»¤èƒ½æ‰§è¡ŒæˆåŠŸï¼Œæ‰ä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œå¦åˆ™ï¼Œç³»ç»Ÿå°±ä¼šç›´æ¥å‘å®¢æˆ·ç«¯æŠ¥é”™ã€‚æ‰€ä»¥ï¼ŒRedis ä½¿ç”¨å†™åæ—¥å¿—è¿™ä¸€æ–¹å¼çš„ä¸€å¤§å¥½å¤„æ˜¯ï¼Œå¯ä»¥é¿å…å‡ºç°è®°å½•é”™è¯¯å‘½ä»¤çš„æƒ…å†µã€‚\nä¸è¿‡ï¼ŒAOF ä¹Ÿæœ‰ä¸¤ä¸ªæ½œåœ¨çš„é£é™©ã€‚\né¦–å…ˆï¼Œå¦‚æœåˆšæ‰§è¡Œå®Œä¸€ä¸ªå‘½ä»¤ï¼Œè¿˜æ²¡æœ‰æ¥å¾—åŠè®°æ—¥å¿—å°±å®•æœºäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤å’Œç›¸åº”çš„æ•°æ®å°±æœ‰ä¸¢å¤±çš„é£é™©ã€‚å¦‚æœæ­¤æ—¶ Redis æ˜¯ç”¨ä½œç¼“å­˜ï¼Œè¿˜å¯ä»¥ä»åç«¯æ•°æ®åº“é‡æ–°è¯»å…¥æ•°æ®è¿›è¡Œæ¢å¤ï¼Œä½†æ˜¯ï¼Œå¦‚æœ Redis æ˜¯ç›´æ¥ç”¨ä½œæ•°æ®åº“çš„è¯ï¼Œæ­¤æ—¶ï¼Œå› ä¸ºå‘½ä»¤æ²¡æœ‰è®°å…¥æ—¥å¿—ï¼Œæ‰€ä»¥å°±æ— æ³•ç”¨æ—¥å¿—è¿›è¡Œæ¢å¤äº†ã€‚\nå…¶æ¬¡ï¼ŒAOF è™½ç„¶é¿å…äº†å¯¹å½“å‰å‘½ä»¤çš„é˜»å¡ï¼Œä½†å¯èƒ½ä¼šç»™ä¸‹ä¸€ä¸ªæ“ä½œå¸¦æ¥é˜»å¡é£é™©ã€‚è¿™æ˜¯å› ä¸ºï¼ŒAOF æ—¥å¿—ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¦‚æœåœ¨æŠŠæ—¥å¿—æ–‡ä»¶å†™å…¥ç£ç›˜æ—¶ï¼Œç£ç›˜å†™å‹åŠ›å¤§ï¼Œå°±ä¼šå¯¼è‡´å†™ç›˜å¾ˆæ…¢ï¼Œè¿›è€Œå¯¼è‡´åç»­çš„æ“ä½œä¹Ÿæ— æ³•æ‰§è¡Œäº†ã€‚\nè¿™ä¸¤ä¸ªé£é™©éƒ½æ˜¯å’Œ AOF å†™å›ç£ç›˜çš„æ—¶æœºç›¸å…³çš„ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ä¸€ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œå AOF æ—¥å¿—å†™å›ç£ç›˜çš„æ—¶æœºï¼Œè¿™ä¸¤ä¸ªé£é™©å°±è§£é™¤äº†ã€‚\n- ä¼˜ç‚¹ é£é™© AOF é¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€ï¼Œé¿å…å‡ºç°è®°å½•é”™è¯¯å‘½ä»¤çš„æƒ…å†µ ä¼šå‡ºç°æ²¡æœ‰æ¥å¾—åŠè®°æ—¥å¿—å°±å®•æœºçš„æƒ…å†µï¼Œå¯èƒ½ä¼šç»™ä¸‹ä¸€ä¸ªæ“ä½œå¸¦æ¥é˜»å¡é£é™© ä¸‰ç§å†™å›ç­–ç•¥ AOF æœºåˆ¶ç»™æˆ‘ä»¬æä¾›äº†ä¸‰ä¸ªé€‰æ‹©ï¼Œä¹Ÿå°±æ˜¯ AOF é…ç½®é¡¹ appendfsync çš„ä¸‰ä¸ªå¯é€‰å€¼ã€‚\n- - å¯é æ€§ é«˜æ€§èƒ½ Always åŒæ­¥å†™å› é«˜ ä½ Everysec æ¯ç§’å†™å›ï¼Œå…ˆæ”¾ç¼“å†²åŒº ä¸­ ä¸­ No æ“ä½œç³»ç»Ÿæ§åˆ¶çš„å†™å›ï¼Œå…ˆæ”¾ç¼“å†²åŒº ä½ é«˜ æˆ‘ä»¬ä¸€å®šè¦å°å¿ƒ AOF æ–‡ä»¶è¿‡å¤§å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚è¿™é‡Œçš„â€œæ€§èƒ½é—®é¢˜â€ï¼Œä¸»è¦åœ¨äºä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼šä¸€æ˜¯ï¼Œæ–‡ä»¶ç³»ç»Ÿæœ¬èº«å¯¹æ–‡ä»¶å¤§å°æœ‰é™åˆ¶ï¼Œæ— æ³•ä¿å­˜è¿‡å¤§çš„æ–‡ä»¶ï¼›äºŒæ˜¯ï¼Œå¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œä¹‹åå†å¾€é‡Œé¢è¿½åŠ å‘½ä»¤è®°å½•çš„è¯ï¼Œæ•ˆç‡ä¹Ÿä¼šå˜ä½ï¼›ä¸‰æ˜¯ï¼Œå¦‚æœå‘ç”Ÿå®•æœºï¼ŒAOF ä¸­è®°å½•çš„å‘½ä»¤è¦ä¸€ä¸ªä¸ªè¢«é‡æ–°æ‰§è¡Œï¼Œç”¨äºæ•…éšœæ¢å¤ï¼Œå¦‚æœæ—¥å¿—æ–‡ä»¶å¤ªå¤§ï¼Œæ•´ä¸ªæ¢å¤è¿‡ç¨‹å°±ä¼šéå¸¸ç¼“æ…¢ï¼Œè¿™å°±ä¼šå½±å“åˆ° Redis çš„æ­£å¸¸ä½¿ç”¨ã€‚\næ—¥å¿—æ–‡ä»¶å¤ªå¤§äº†æ€ä¹ˆåŠï¼Ÿ AOF é‡å†™æœºåˆ¶ï¼Œåœ¨é‡å†™æ—¶ï¼ŒRedis æ ¹æ®æ•°æ®åº“çš„ç°çŠ¶åˆ›å»ºä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ã€‚\né‡å†™æœºåˆ¶å…·æœ‰â€œå¤šå˜ä¸€â€åŠŸèƒ½ã€‚æ‰€è°“çš„â€œå¤šå˜ä¸€â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ—§æ—¥å¿—æ–‡ä»¶ä¸­çš„å¤šæ¡å‘½ä»¤ï¼Œåœ¨é‡å†™åçš„æ–°æ—¥å¿—ä¸­å˜æˆäº†ä¸€æ¡å‘½ä»¤ã€‚\nå½“ä¸€ä¸ªé”®å€¼å¯¹è¢«å¤šæ¡å†™å‘½ä»¤åå¤ä¿®æ”¹æ—¶ï¼ŒAOF æ–‡ä»¶ä¼šè®°å½•ç›¸åº”çš„å¤šæ¡å‘½ä»¤ã€‚ä½†æ˜¯ï¼Œåœ¨é‡å†™çš„æ—¶å€™ï¼Œæ˜¯æ ¹æ®è¿™ä¸ªé”®å€¼å¯¹å½“å‰çš„æœ€æ–°çŠ¶æ€ï¼Œä¸ºå®ƒç”Ÿæˆå¯¹åº”çš„å†™å…¥å‘½ä»¤ã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸€ä¸ªé”®å€¼å¯¹åœ¨é‡å†™æ—¥å¿—ä¸­åªç”¨ä¸€æ¡å‘½ä»¤å°±è¡Œäº†ï¼Œè€Œä¸”ï¼Œåœ¨æ—¥å¿—æ¢å¤æ—¶ï¼Œåªç”¨æ‰§è¡Œè¿™æ¡å‘½ä»¤ï¼Œå°±å¯ä»¥ç›´æ¥å®Œæˆè¿™ä¸ªé”®å€¼å¯¹çš„å†™å…¥äº†ã€‚\nAOF é‡å†™ä¼šé˜»å¡å—? ä¸ä¼š! å’Œ AOF æ—¥å¿—ç”±ä¸»çº¿ç¨‹å†™å›ä¸åŒï¼Œé‡å†™è¿‡ç¨‹æ˜¯ç”±åå°å­è¿›ç¨‹ bgrewriteaof æ¥å®Œæˆçš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´æ•°æ®åº“æ€§èƒ½ä¸‹é™ã€‚\nforkå­è¿›ç¨‹æ—¶ï¼Œå­è¿›ç¨‹æ˜¯ä¼šæ‹·è´çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œå³è™šå®æ˜ å°„å…³ç³»ï¼Œè€Œä¸ä¼šæ‹·è´ç‰©ç†å†…å­˜ã€‚bgrewriteaof å­è¿›ç¨‹å°±å¯ä»¥åœ¨ä¸å½±å“ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œé€ä¸€æŠŠæ‹·è´çš„æ•°æ®å†™æˆæ“ä½œï¼Œè®°å…¥é‡å†™æ—¥å¿—ã€‚\nå› ä¸ºä¸»çº¿ç¨‹æœªé˜»å¡ï¼Œä»ç„¶å¯ä»¥å¤„ç†æ–°æ¥çš„æ“ä½œã€‚æ­¤æ—¶ï¼Œå¦‚æœæœ‰å†™æ“ä½œï¼Œç¬¬ä¸€å¤„æ—¥å¿—å°±æ˜¯æŒ‡æ­£åœ¨ä½¿ç”¨çš„ AOF æ—¥å¿—ï¼ŒRedis ä¼šæŠŠè¿™ä¸ªæ“ä½œå†™åˆ°å®ƒçš„ç¼“å†²åŒºã€‚è¿™æ ·ä¸€æ¥ï¼Œå³ä½¿å®•æœºäº†ï¼Œè¿™ä¸ª AOF æ—¥å¿—çš„æ“ä½œä»ç„¶æ˜¯é½å…¨çš„ï¼Œå¯ä»¥ç”¨äºæ¢å¤ã€‚è€Œç¬¬äºŒå¤„æ—¥å¿—ï¼Œå°±æ˜¯æŒ‡æ–°çš„ AOF é‡å†™æ—¥å¿—ã€‚è¿™ä¸ªæ“ä½œä¹Ÿä¼šè¢«å†™åˆ°é‡å†™æ—¥å¿—çš„ç¼“å†²åŒºã€‚è¿™æ ·ï¼Œé‡å†™æ—¥å¿—ä¹Ÿä¸ä¼šä¸¢å¤±æœ€æ–°çš„æ“ä½œã€‚ç­‰åˆ°æ‹·è´æ•°æ®çš„æ‰€æœ‰æ“ä½œè®°å½•é‡å†™å®Œæˆåï¼Œé‡å†™æ—¥å¿—è®°å½•çš„è¿™äº›æœ€æ–°æ“ä½œä¹Ÿä¼šå†™å…¥æ–°çš„ AOF æ–‡ä»¶ï¼Œä»¥ä¿è¯æ•°æ®åº“æœ€æ–°çŠ¶æ€çš„è®°å½•ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿ä»£æ—§æ–‡ä»¶äº†ã€‚\nRDB å¿«ç…§ æ‰€è°“å†…å­˜å¿«ç…§ï¼Œå°±æ˜¯æŒ‡å†…å­˜ä¸­çš„æ•°æ®åœ¨æŸä¸€ä¸ªæ—¶åˆ»çš„çŠ¶æ€è®°å½•ã€‚\nå…¨é‡æ•°æ®è¶Šå¤šï¼ŒRDB æ–‡ä»¶å°±è¶Šå¤§ï¼Œå¾€ç£ç›˜ä¸Šå†™æ•°æ®çš„æ—¶é—´å¼€é”€å°±è¶Šå¤§ã€‚\nå¯¹äº Redis è€Œè¨€ï¼Œå®ƒçš„å•çº¿ç¨‹æ¨¡å‹å°±å†³å®šäº†ï¼Œæˆ‘ä»¬è¦å°½é‡é¿å…æ‰€æœ‰ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ“ä½œï¼Œæ‰€ä»¥ï¼Œé’ˆå¯¹ä»»ä½•æ“ä½œï¼Œæˆ‘ä»¬éƒ½ä¼šæä¸€ä¸ªçµé­‚ä¹‹é—®ï¼šâ€œå®ƒä¼šé˜»å¡ä¸»çº¿ç¨‹å—?â€RDB æ–‡ä»¶çš„ç”Ÿæˆæ˜¯å¦ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œè¿™å°±å…³ç³»åˆ°æ˜¯å¦ä¼šé™ä½ Redis çš„æ€§èƒ½ã€‚\nRedis æä¾›äº†ä¸¤ä¸ªå‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ save å’Œ bgsaveã€‚\n- - save ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œä¼šå¯¼è‡´é˜»å¡ bgsave(é»˜è®¤) åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¸“é—¨ç”¨äºå†™å…¥ RDB æ–‡ä»¶ï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡ å¿«ç…§æ—¶æ•°æ®èƒ½ä¿®æ”¹å—? ç»™åˆ«äººæ‹ç…§æ—¶ï¼Œä¸€æ—¦å¯¹æ–¹åŠ¨äº†ï¼Œé‚£ä¹ˆè¿™å¼ ç…§ç‰‡å°±æ‹ç³Šäº†ï¼Œæˆ‘ä»¬å°±éœ€è¦é‡æ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å½“ç„¶å¸Œæœ›å¯¹æ–¹ä¿æŒä¸åŠ¨ã€‚å¯¹äºå†…å­˜å¿«ç…§è€Œè¨€ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›æ•°æ®â€œåŠ¨â€ã€‚\nä¸ºäº†å¿«ç…§è€Œæš‚åœå†™æ“ä½œï¼Œè‚¯å®šæ˜¯ä¸èƒ½æ¥å—çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼ŒRedis å°±ä¼šå€ŸåŠ©æ“ä½œç³»ç»Ÿæä¾›çš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼ˆCopy-On-Write, COWï¼‰ï¼Œåœ¨æ‰§è¡Œå¿«ç…§çš„åŒæ—¶ï¼Œæ­£å¸¸å¤„ç†å†™æ“ä½œã€‚\nå¦‚æœä¸»çº¿ç¨‹è¦ä¿®æ”¹ä¸€å—æ•°æ®ï¼Œé‚£ä¹ˆï¼Œè¿™å—æ•°æ®å°±ä¼šè¢«å¤åˆ¶ä¸€ä»½ï¼Œç”Ÿæˆè¯¥æ•°æ®çš„å‰¯æœ¬ã€‚ç„¶åï¼Œä¸»çº¿ç¨‹åœ¨è¿™ä¸ªæ•°æ®å‰¯æœ¬ä¸Šè¿›è¡Œä¿®æ”¹ã€‚åŒæ—¶ï¼Œbgsave å­è¿›ç¨‹å¯ä»¥ç»§ç»­æŠŠåŸæ¥çš„æ•°æ®å†™å…¥ RDB æ–‡ä»¶ã€‚\næ··åˆ AOF/RDB Redis 4.0 ä¸­æå‡ºäº†ä¸€ä¸ªæ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§çš„æ–¹æ³•ã€‚å†…å­˜å¿«ç…§ä»¥ä¸€å®šçš„é¢‘ç‡æ‰§è¡Œï¼Œåœ¨ä¸¤æ¬¡å¿«ç…§ä¹‹é—´ï¼Œä½¿ç”¨ AOF æ—¥å¿—è®°å½•è¿™æœŸé—´çš„æ‰€æœ‰å‘½ä»¤æ“ä½œã€‚\nè¿™ä¸ªæ–¹æ³•æ—¢èƒ½äº«å—åˆ° RDB æ–‡ä»¶å¿«é€Ÿæ¢å¤çš„å¥½å¤„ï¼Œåˆèƒ½äº«å—åˆ° AOF åªè®°å½•æ“ä½œå‘½ä»¤çš„ç®€å•ä¼˜åŠ¿ï¼Œé¢‡æœ‰ç‚¹â€œé±¼å’Œç†ŠæŒå¯ä»¥å…¼å¾—â€çš„æ„Ÿè§‰ï¼Œå»ºè®®ä½ åœ¨å®è·µä¸­ç”¨èµ·æ¥ã€‚\nå…³äº AOF å’Œ RDB çš„é€‰æ‹©é—®é¢˜ï¼Œæˆ‘æƒ³å†ç»™ä½ æä¸‰ç‚¹å»ºè®®ï¼š\næ•°æ®ä¸èƒ½ä¸¢å¤±æ—¶ï¼Œå†…å­˜å¿«ç…§å’Œ AOF çš„æ··åˆä½¿ç”¨æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼› å¦‚æœå…è®¸åˆ†é’Ÿçº§åˆ«çš„æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥åªä½¿ç”¨ RDBï¼› å¦‚æœåªç”¨ AOFï¼Œä¼˜å…ˆä½¿ç”¨ everysec çš„é…ç½®é€‰é¡¹ï¼Œå› ä¸ºå®ƒåœ¨å¯é æ€§å’Œæ€§èƒ½ä¹‹é—´å–äº†ä¸€ä¸ªå¹³è¡¡ã€‚ æ³¨æ„: å†™æ¯”è¯»å¤šæ—¶ï¼ŒRDB çš„æ€§èƒ½é—®é¢˜ã€‚\n1 2 3 4 5 6 7 8 9 # å¼€å¯ RDB æŒä¹…åŒ– save 60 10000 # 60 ç§’å†…æ‰§è¡Œ 1000 æ¬¡æ“ä½œï¼ŒæŒä¹…åŒ– save 300 10 # 300 ç§’å†…æ‰§è¡Œ 10 æ¬¡æ“æ“ä½œï¼ŒæŒä¹…åŒ– save 600 1 # 600 ç§’å†…æ‰§è¡Œ 1 æ¬¡æ“ä½œï¼ŒæŒä¹…åŒ– # å¼€å¯ AOF æŒä¹…åŒ– appendonly yes appendfilename \u0026#34;appendonly.aof\u0026#34; appenddirname \u0026#34;appendonlydir\u0026#34; appendfsync everysec ä¸»ä»åº“å®ç°æ•°æ®ä¸€è‡´ ç°åœ¨æœ‰å®ä¾‹ 1ï¼ˆipï¼š172.16.19.3ï¼‰å’Œå®ä¾‹ 2ï¼ˆipï¼š172.16.19.5ï¼‰ï¼Œæˆ‘ä»¬åœ¨å®ä¾‹ 2 ä¸Šæ‰§è¡Œä»¥ä¸‹è¿™ä¸ªå‘½ä»¤åï¼Œå®ä¾‹ 2 å°±å˜æˆäº†å®ä¾‹ 1 çš„ä»åº“ï¼Œå¹¶ä»å®ä¾‹ 1 ä¸Šå¤åˆ¶æ•°æ®ï¼š\n1 replicaof 172.16.19.3 6379 ç¬¬ä¸€é˜¶æ®µï¼Œä»åº“å‘ä¸»åº“å‘é€ psync å‘½ä»¤ï¼Œå…¶ä¸­åŒ…å« runID (ä¸»åº“å”¯ä¸€æ ‡è¯†) å’Œ offset (å¤åˆ¶è¿›åº¦) ä¸¤ä¸ªå‚æ•°ï¼Œé¦–æ¬¡åŒæ­¥ï¼ŒrunID=?ï¼Œoffset=-1ã€‚ä¸»åº“è¿”å›æ­£ç¡®çš„ runID å’Œ offsetã€‚\nç¬¬äºŒé˜¶æ®µï¼Œä¸»åº“æ‰§è¡Œ bgsave ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œå‘ç»™ä»åº“ã€‚ä»åº“æ”¶åˆ°åæ¸…ç©ºå½“å‰æ•°æ®åº“ï¼ŒåŠ è½½ RDB æ–‡ä»¶ã€‚\nç¬¬ä¸‰é˜¶æ®µï¼Œä¸»åº“åœ¨åŒæ­¥è¿‡ç¨‹ä¸­æ–°å¢çš„å‘½ä»¤ï¼Œä¸“é—¨è®°å½•åˆ° replication bufferï¼Œæ­¤æ—¶å‘ç»™ä»åº“ã€‚ä»åº“æ‰§è¡Œè¿™äº›æ“ä½œå®Œæˆæ•°æ®åŒæ­¥ã€‚\nä¸€æ—¦ä¸»ä»åº“å®Œæˆäº†å…¨é‡å¤åˆ¶ï¼Œå®ƒä»¬ä¹‹é—´å°±ä¼šä¸€ç›´ç»´æŠ¤ä¸€ä¸ªç½‘ç»œè¿æ¥ï¼Œä¸»åº“ä¼šé€šè¿‡è¿™ä¸ªè¿æ¥å°†åç»­é™†ç»­æ”¶åˆ°çš„å‘½ä»¤æ“ä½œå†åŒæ­¥ç»™ä»åº“ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸ºåŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ï¼Œå¯ä»¥é¿å…é¢‘ç¹å»ºç«‹è¿æ¥çš„å¼€é”€ã€‚\nä¸»ä»çº§è”æ¨¡å¼åˆ†æ‹…å…¨é‡å¤åˆ¶æ—¶çš„ä¸»åº“å‹åŠ› ä¸€ä¸»å¤šä»æ¨¡å¼ä¸­ï¼ŒåŒæ­¥æ•°æ®ï¼Œä¸»åº“ç”Ÿæˆ RDB å’Œ å‘é€ RDB ä¼šæ¶ˆè€—æ€§èƒ½å’Œå¸¦å®½ã€‚å¯ä»¥é€šè¿‡çº§è”ï¼Œå°†å‹åŠ›åˆ†æ‹…åˆ°ä»åº“ä¸Šã€‚\nä¸»ä»åº“é—´ç½‘ç»œæ–­äº†æ€ä¹ˆåŠï¼Ÿ åŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­è¿™ä¸ªè¿‡ç¨‹ä¸­å­˜åœ¨ç€é£é™©ç‚¹ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ç½‘ç»œæ–­è¿æˆ–é˜»å¡ã€‚\nä» Redis 2.8 å¼€å§‹ï¼Œç½‘ç»œæ–­äº†ä¹‹åï¼Œä¸»ä»åº“ä¼šé‡‡ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼ç»§ç»­åŒæ­¥ã€‚å½“ä¸»ä»åº“æ–­è¿åï¼Œä¸»åº“ä¼šæŠŠæ–­è¿æœŸé—´æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼Œå†™å…¥ replication bufferï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›æ“ä½œå‘½ä»¤ä¹Ÿå†™å…¥ repl_backlog_buffer è¿™ä¸ªç¼“å†²åŒºã€‚\nrepl_backlog_buffer æ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œä¸»åº“ä¼šè®°å½•è‡ªå·±å†™åˆ°çš„ä½ç½®ï¼Œä»åº“åˆ™ä¼šè®°å½•è‡ªå·±å·²ç»è¯»åˆ°çš„ä½ç½®ã€‚\nç½‘ç»œæ–­äº†åï¼Œå°†ä¸»åº“å†™ä½ç½®å’Œä»åº“è¯»ä½ç½®çš„ä¹‹é—´çš„å‘½ä»¤åŒæ­¥ç»™ä»åº“ã€‚\nå› ä¸º repl_backlog_buffer æ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ‰€ä»¥åœ¨ç¼“å†²åŒºå†™æ»¡åï¼Œä¸»åº“ä¼šç»§ç»­å†™å…¥ï¼Œæ­¤æ—¶ï¼Œå°±ä¼šè¦†ç›–æ‰ä¹‹å‰å†™å…¥çš„æ“ä½œã€‚å¦‚æœä»åº“çš„è¯»å–é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä»åº“è¿˜æœªè¯»å–çš„æ“ä½œè¢«ä¸»åº“æ–°å†™çš„æ“ä½œè¦†ç›–äº†ï¼Œè¿™ä¼šå¯¼è‡´ä¸»ä»åº“é—´çš„æ•°æ®ä¸ä¸€è‡´ã€‚\nå› æ­¤ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•é¿å…è¿™ä¸€æƒ…å†µï¼Œä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒæ•´ repl_backlog_size è¿™ä¸ªå‚æ•°ã€‚\nä¸€ä¸ªä»åº“å¦‚æœå’Œä¸»åº“æ–­è¿æ—¶é—´è¿‡é•¿ï¼Œé€ æˆå®ƒåœ¨ä¸»åº“repl_backlog_bufferçš„slave_repl_offsetä½ç½®ä¸Šçš„æ•°æ®å·²ç»è¢«è¦†ç›–æ‰äº†ï¼Œæ­¤æ—¶ä»åº“å’Œä¸»åº“é—´å°†è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚\nå“¨å…µæœºåˆ¶: ä¸»åº“æŒ‚äº†ï¼Œä¸é—´æ–­æœåŠ¡ åŸºæœ¬æµç¨‹ å“¨å…µå…¶å®å°±æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„ Redis è¿›ç¨‹ï¼Œä¸»ä»åº“å®ä¾‹è¿è¡Œçš„åŒæ—¶ï¼Œå®ƒä¹Ÿåœ¨è¿è¡Œã€‚å“¨å…µä¸»è¦è´Ÿè´£çš„å°±æ˜¯ä¸‰ä¸ªä»»åŠ¡ï¼šç›‘æ§ã€é€‰ä¸»ï¼ˆé€‰æ‹©ä¸»åº“ï¼‰å’Œé€šçŸ¥ã€‚\nç›‘æ§æ˜¯æŒ‡å“¨å…µè¿›ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œå‘¨æœŸæ€§åœ°ç»™æ‰€æœ‰çš„ä¸»ä»åº“å‘é€ PING å‘½ä»¤ï¼Œæ£€æµ‹å®ƒä»¬æ˜¯å¦ä»ç„¶åœ¨çº¿è¿è¡Œã€‚å¦‚æœä»åº“æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”å“¨å…µçš„ PING å‘½ä»¤ï¼Œå“¨å…µå°±ä¼šæŠŠå®ƒæ ‡è®°ä¸ºâ€œä¸‹çº¿çŠ¶æ€â€ï¼›åŒæ ·ï¼Œå¦‚æœä¸»åº“ä¹Ÿæ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”å“¨å…µçš„ PING å‘½ä»¤ï¼Œå“¨å…µå°±ä¼šåˆ¤å®šä¸»åº“ä¸‹çº¿ï¼Œç„¶åå¼€å§‹è‡ªåŠ¨åˆ‡æ¢ä¸»åº“çš„æµç¨‹ã€‚\nä¸»åº“æŒ‚äº†ä»¥åï¼Œå“¨å…µå°±éœ€è¦ä»å¾ˆå¤šä¸ªä»åº“é‡Œï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™é€‰æ‹©ä¸€ä¸ªä»åº“å®ä¾‹ï¼ŒæŠŠå®ƒä½œä¸ºæ–°çš„ä¸»åº“ã€‚è¿™ä¸€æ­¥å®Œæˆåï¼Œç°åœ¨çš„é›†ç¾¤é‡Œå°±æœ‰äº†æ–°ä¸»åº“ã€‚\næœ€åï¼Œå“¨å…µä¼šæ‰§è¡Œæœ€åä¸€ä¸ªä»»åŠ¡ï¼šé€šçŸ¥ã€‚åœ¨æ‰§è¡Œé€šçŸ¥ä»»åŠ¡æ—¶ï¼Œå“¨å…µä¼šæŠŠæ–°ä¸»åº“çš„è¿æ¥ä¿¡æ¯å‘ç»™å…¶ä»–ä»åº“ï¼Œè®©å®ƒä»¬æ‰§è¡Œ replicaof å‘½ä»¤ï¼Œå’Œæ–°ä¸»åº“å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚åŒæ—¶ï¼Œå“¨å…µä¼šæŠŠæ–°ä¸»åº“çš„è¿æ¥ä¿¡æ¯é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼Œè®©å®ƒä»¬æŠŠè¯·æ±‚æ“ä½œå‘åˆ°æ–°ä¸»åº“ä¸Šã€‚\nå“¨å…µæœºåˆ¶é€šå¸¸ä¼šé‡‡ç”¨å¤šå®ä¾‹ç»„æˆçš„é›†ç¾¤æ¨¡å¼è¿›è¡Œéƒ¨ç½²ï¼Œè¿™ä¹Ÿè¢«ç§°ä¸ºå“¨å…µé›†ç¾¤ã€‚å¼•å…¥å¤šä¸ªå“¨å…µå®ä¾‹ä¸€èµ·æ¥åˆ¤æ–­ï¼Œå°±å¯ä»¥é¿å…å•ä¸ªå“¨å…µå› ä¸ºè‡ªèº«ç½‘ç»œçŠ¶å†µä¸å¥½ï¼Œè€Œè¯¯åˆ¤ä¸»åº“ä¸‹çº¿çš„æƒ…å†µã€‚åŒæ—¶ï¼Œå¤šä¸ªå“¨å…µçš„ç½‘ç»œåŒæ—¶ä¸ç¨³å®šçš„æ¦‚ç‡è¾ƒå°ï¼Œç”±å®ƒä»¬ä¸€èµ·åšå†³ç­–ï¼Œè¯¯åˆ¤ç‡ä¹Ÿèƒ½é™ä½ã€‚\nâ€œå®¢è§‚ä¸‹çº¿â€çš„æ ‡å‡†å°±æ˜¯ï¼Œå½“æœ‰ N ä¸ªå“¨å…µå®ä¾‹æ—¶ï¼Œæœ€å¥½è¦æœ‰ N/2 + 1 ä¸ªå®ä¾‹åˆ¤æ–­ä¸»åº“ä¸ºâ€œä¸»è§‚ä¸‹çº¿â€ï¼Œæ‰èƒ½æœ€ç»ˆåˆ¤å®šä¸»åº“ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚\nå¦‚ä½•é€‰å®šæ–°ä¸»åº“ï¼Ÿ é¦–å…ˆè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ï¼Œå¦‚æœåœ¨é€‰ä¸»æ—¶ï¼Œä¸€ä¸ªä»åº“æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬æŠŠå®ƒé€‰ä¸ºæ–°ä¸»åº“å¼€å§‹ä½¿ç”¨äº†ã€‚å¯æ˜¯ï¼Œå¾ˆå¿«å®ƒçš„ç½‘ç»œå‡ºäº†æ•…éšœï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¾—é‡æ–°é€‰ä¸»äº†ã€‚è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç»“æœã€‚\nå¦‚æœä»åº“æ€»æ˜¯å’Œä¸»åº“æ–­è¿ï¼Œè€Œä¸”æ–­è¿æ¬¡æ•°è¶…å‡ºäº†ä¸€å®šçš„é˜ˆå€¼ï¼Œæˆ‘ä»¬å°±æœ‰ç†ç”±ç›¸ä¿¡ï¼Œè¿™ä¸ªä»åº“çš„ç½‘ç»œçŠ¶å†µå¹¶ä¸æ˜¯å¤ªå¥½ï¼Œå°±å¯ä»¥æŠŠè¿™ä¸ªä»åº“ç­›æ‰äº†ã€‚\næ¥ä¸‹æ¥å°±è¦ç»™å‰©ä½™çš„ä»åº“æ‰“åˆ†ã€‚æˆ‘ä»¬å¯ä»¥åˆ†åˆ«æŒ‰ç…§ä¸‰ä¸ªè§„åˆ™ä¾æ¬¡è¿›è¡Œä¸‰è½®æ‰“åˆ†ï¼Œè¿™ä¸‰ä¸ªè§„åˆ™åˆ†åˆ«æ˜¯ä»åº“ä¼˜å…ˆçº§ã€ä»åº“å¤åˆ¶è¿›åº¦ä»¥åŠä»åº“ ID å·ã€‚\nç¬¬ä¸€è½®ï¼šä¼˜å…ˆçº§æœ€é«˜çš„ä»åº“å¾—åˆ†é«˜ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ slave-priority é…ç½®é¡¹ï¼Œç»™ä¸åŒçš„ä»åº“è®¾ç½®ä¸åŒä¼˜å…ˆçº§ã€‚å¦‚æœä»åº“çš„ä¼˜å…ˆçº§éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆå“¨å…µå¼€å§‹ç¬¬äºŒè½®æ‰“åˆ†ã€‚\nç¬¬äºŒè½®ï¼šå’Œæ—§ä¸»åº“åŒæ­¥ç¨‹åº¦æœ€æ¥è¿‘çš„ä»åº“å¾—åˆ†é«˜ã€‚å¦‚æœä»åº“çš„ä¼˜å…ˆçº§éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆå“¨å…µå¼€å§‹ç¬¬ä¸‰è½®æ‰“åˆ†ã€‚\nç¬¬ä¸‰è½®ï¼šID å·å°çš„ä»åº“å¾—åˆ†é«˜ã€‚\nå¦‚æœæœ‰å“¨å…µå®ä¾‹åœ¨è¿è¡Œæ—¶å‘ç”Ÿäº†æ•…éšœï¼Œä¸»ä»åº“è¿˜èƒ½æ­£å¸¸åˆ‡æ¢å—ï¼Ÿ åœ¨é…ç½®å“¨å…µçš„ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨åˆ°ä¸‹é¢çš„è¿™ä¸ªé…ç½®é¡¹ï¼Œè®¾ç½®ä¸»åº“çš„ IP å’Œç«¯å£ï¼Œå¹¶æ²¡æœ‰é…ç½®å…¶ä»–å“¨å…µçš„è¿æ¥ä¿¡æ¯ã€‚\n1 sentinel monitor \u0026lt;master-name\u0026gt; \u0026lt;ip\u0026gt; \u0026lt;redis-port\u0026gt; \u0026lt;quorum\u0026gt; è¿™äº›å“¨å…µå®ä¾‹æ—¢ç„¶éƒ½ä¸çŸ¥é“å½¼æ­¤çš„åœ°å€ï¼Œåˆæ˜¯æ€ä¹ˆç»„æˆé›†ç¾¤çš„å‘¢ï¼Ÿè¦å¼„æ˜ç™½è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦å­¦ä¹ ä¸€ä¸‹å“¨å…µé›†ç¾¤çš„ç»„æˆå’Œè¿è¡Œæœºåˆ¶äº†ã€‚\nåŸºäº pub/sub æœºåˆ¶çš„å“¨å…µé›†ç¾¤ å“¨å…µå®ä¾‹ä¹‹é—´å¯ä»¥ç›¸äº’å‘ç°ï¼Œè¦å½’åŠŸäº Redis æä¾›çš„ pub/sub æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å‘å¸ƒ / è®¢é˜…æœºåˆ¶ã€‚\nå“¨å…µåªè¦å’Œä¸»åº“å»ºç«‹èµ·äº†è¿æ¥ï¼Œå°±å¯ä»¥åœ¨ä¸»åº“ä¸Šå‘å¸ƒæ¶ˆæ¯äº†ï¼Œæ¯”å¦‚è¯´å‘å¸ƒå®ƒè‡ªå·±çš„è¿æ¥ä¿¡æ¯ï¼ˆIP å’Œç«¯å£ï¼‰ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿå¯ä»¥ä»ä¸»åº“ä¸Šè®¢é˜…æ¶ˆæ¯ï¼Œè·å¾—å…¶ä»–å“¨å…µå‘å¸ƒçš„è¿æ¥ä¿¡æ¯ã€‚å½“å¤šä¸ªå“¨å…µå®ä¾‹éƒ½åœ¨ä¸»åº“ä¸Šåšäº†å‘å¸ƒå’Œè®¢é˜…æ“ä½œåï¼Œå®ƒä»¬ä¹‹é—´å°±èƒ½çŸ¥é“å½¼æ­¤çš„ IP åœ°å€å’Œç«¯å£ã€‚\nåœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼Œä¸»åº“ä¸Šæœ‰ä¸€ä¸ªåä¸ºâ€œsentinel:helloâ€çš„é¢‘é“ï¼Œä¸åŒå“¨å…µå°±æ˜¯é€šè¿‡å®ƒæ¥ç›¸äº’å‘ç°ï¼Œå®ç°äº’ç›¸é€šä¿¡çš„ã€‚\nå®æˆ˜ç¯‡ Redis åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„åº”ç”¨ æ¶ˆæ¯é˜Ÿåˆ—åœ¨å­˜å–æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»è¦æ»¡è¶³ä¸‰ä¸ªéœ€æ±‚ï¼Œåˆ†åˆ«æ˜¯æ¶ˆæ¯ä¿åºã€å¤„ç†é‡å¤çš„æ¶ˆæ¯å’Œä¿è¯æ¶ˆæ¯å¯é æ€§ã€‚\næ¶ˆæ¯ä¿åº\nå‡è®¾æœ‰ 3 ä¸ªæ¶ˆæ¯\nå‡åº“å­˜ 5 è¯»åº“å­˜ å‡åº“å­˜ 2 å¦‚æœå‘ç”Ÿä¹±åºå¤„ç†ä»»åŠ¡ï¼Œä¼˜å…ˆæ‰§è¡Œäº† 321ï¼Œæ­¤æ—¶ 2 è¯»åˆ°çš„åº“å­˜æ˜¯é”™è¯¯çš„ã€‚\né‡å¤æ¶ˆæ¯å¤„ç†\nå› ä¸ºç½‘ç»œå µå¡è€Œå‡ºç°æ¶ˆæ¯é‡ä¼ çš„æƒ…å†µï¼Œå¯èƒ½åˆ°æ”¶åˆ°å¤šæ¡é‡å¤æ¶ˆæ¯ã€‚\nä¸€ä¸ªä»»åŠ¡æ‰£ 1 ä¸ªåº“å­˜ï¼Œå› ä¸ºé‡å¤æ¶ˆæ¯ï¼Œå´æ‰£äº† 5 æ¬¡å°±ä¸å¯¹äº†ã€‚\næ¶ˆæ¯å¯é æ€§ä¿è¯\nå› ä¸ºæ•…éšœæˆ–å®•æœºå¯¼è‡´æ¶ˆæ¯æ²¡æœ‰å¤„ç†å®Œæˆã€‚å½“æ¶ˆè´¹è€…é‡å¯åï¼Œå¯ä»¥é‡æ–°è¯»å–æ¶ˆæ¯å¤„ç†\nRedis çš„ List å’Œ Streams ä¸¤ç§æ•°æ®ç±»å‹ï¼Œå°±å¯ä»¥æ»¡è¶³æ¶ˆæ¯é˜Ÿåˆ—çš„è¿™ä¸‰ä¸ªéœ€æ±‚\nåŸºäº List çš„æ¶ˆæ¯é˜Ÿåˆ—è§£å†³æ–¹æ¡ˆ List æœ¬èº«å°±æ˜¯æŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºå¯¹æ•°æ®è¿›è¡Œå­˜å–çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½¿ç”¨ List ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¿å­˜æ¶ˆæ¯çš„è¯ï¼Œå°±å·²ç»èƒ½æ»¡è¶³æ¶ˆæ¯ä¿åºçš„éœ€æ±‚äº†ã€‚\nå½“ List ä¸­æ²¡æœ‰å€¼ï¼ŒRPOP å‘½ä»¤ä¼šè¯»åˆ°ç©ºå€¼ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº† BRPOP å‘½ä»¤ï¼ŒBRPOP å‘½ä»¤ä¹Ÿç§°ä¸ºé˜»å¡å¼è¯»å–ï¼Œå®¢æˆ·ç«¯åœ¨æ²¡æœ‰è¯»åˆ°é˜Ÿåˆ—æ•°æ®æ—¶ï¼Œè‡ªåŠ¨é˜»å¡ï¼Œç›´åˆ°æœ‰æ–°çš„æ•°æ®å†™å…¥é˜Ÿåˆ—ï¼Œå†å¼€å§‹è¯»å–æ–°æ•°æ®ã€‚\nList æœ¬èº«æ˜¯ä¸ä¼šä¸ºæ¯ä¸ªæ¶ˆæ¯ç”Ÿæˆ ID å·çš„ï¼Œæ‰€ä»¥ï¼Œæ¶ˆæ¯çš„å…¨å±€å”¯ä¸€ ID å·å°±éœ€è¦ç”Ÿäº§è€…ç¨‹åºåœ¨å‘é€æ¶ˆæ¯å‰è‡ªè¡Œç”Ÿæˆã€‚ç”Ÿæˆä¹‹åï¼Œæˆ‘ä»¬åœ¨ç”¨ LPUSH å‘½ä»¤æŠŠæ¶ˆæ¯æ’å…¥ List æ—¶ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ä¸­åŒ…å«è¿™ä¸ªå…¨å±€å”¯ä¸€ IDã€‚\nå½“æ¶ˆè´¹è€…ç¨‹åºä» List ä¸­è¯»å–ä¸€æ¡æ¶ˆæ¯åï¼ŒList å°±ä¸ä¼šå†ç•™å­˜è¿™æ¡æ¶ˆæ¯äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æœæ¶ˆè´¹è€…ç¨‹åºåœ¨å¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹å‡ºç°äº†æ•…éšœæˆ–å®•æœºï¼Œå°±ä¼šå¯¼è‡´æ¶ˆæ¯æ²¡æœ‰å¤„ç†å®Œæˆï¼Œé‚£ä¹ˆï¼Œæ¶ˆè´¹è€…ç¨‹åºå†æ¬¡å¯åŠ¨åï¼Œå°±æ²¡æ³•å†æ¬¡ä» List ä¸­è¯»å–æ¶ˆæ¯äº†ã€‚ä¸ºäº†ç•™å­˜æ¶ˆæ¯ï¼ŒList ç±»å‹æä¾›äº† BRPOPLPUSH å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤çš„ä½œç”¨æ˜¯è®©æ¶ˆè´¹è€…ç¨‹åºä»ä¸€ä¸ª List ä¸­è¯»å–æ¶ˆæ¯ï¼ŒåŒæ—¶ï¼ŒRedis ä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯å†æ’å…¥åˆ°å¦ä¸€ä¸ª Listï¼ˆå¯ä»¥å«ä½œå¤‡ä»½ Listï¼‰ç•™å­˜ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœæ¶ˆè´¹è€…ç¨‹åºè¯»äº†æ¶ˆæ¯ä½†æ²¡èƒ½æ­£å¸¸å¤„ç†ï¼Œç­‰å®ƒé‡å¯åï¼Œå°±å¯ä»¥ä»å¤‡ä»½ List ä¸­é‡æ–°è¯»å–æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†äº†ã€‚\nåŸºäº List ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æ»¡è¶³åˆ†å¸ƒå¼ç»„ä»¶å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰å¤§éœ€æ±‚ã€‚ä½†æ˜¯ï¼Œåœ¨ç”¨ List åšæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½é‡åˆ°è¿‡ä¸€ä¸ªé—®é¢˜ï¼šç”Ÿäº§è€…æ¶ˆæ¯å‘é€å¾ˆå¿«ï¼Œè€Œæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯çš„é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œè¿™å°±å¯¼è‡´ List ä¸­çš„æ¶ˆæ¯è¶Šç§¯è¶Šå¤šï¼Œç»™ Redis çš„å†…å­˜å¸¦æ¥å¾ˆå¤§å‹åŠ›ã€‚\næˆ‘ä»¬å¸Œæœ›å¯åŠ¨å¤šä¸ªæ¶ˆè´¹è€…ç¨‹åºç»„æˆä¸€ä¸ªæ¶ˆè´¹ç»„ï¼Œä¸€èµ·åˆ†æ‹…å¤„ç† List ä¸­çš„æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼ŒList ç±»å‹å¹¶ä¸æ”¯æŒæ¶ˆè´¹ç»„çš„å®ç°ã€‚é‚£ä¹ˆï¼Œè¿˜æœ‰æ²¡æœ‰æ›´åˆé€‚çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿè¿™å°±è¦è¯´åˆ° Redis ä» 5.0 ç‰ˆæœ¬å¼€å§‹æä¾›çš„ Streams æ•°æ®ç±»å‹äº†ã€‚\nåŸºäº Streams çš„æ¶ˆæ¯é˜Ÿåˆ—è§£å†³æ–¹æ¡ˆ 1 2 3 # å¾€ mqstream é˜Ÿåˆ—æ’å…¥ {resp:5} # æ˜Ÿå·è¡¨ç¤ºè‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€çš„ ID XADD mqstream * resp 5 å‚è€ƒ Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜\n","date":"2022-01-22T15:00:00Z","permalink":"https://blog.golang.space/p/redis-%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/","title":"\u003cRedis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜\u003eè¯»ä¹¦ç¬”è®°"},{"content":"åˆ†å¸ƒå¼äº‹åŠ¡ åœ¨ä¸€ä¸ªç³»ç»Ÿå†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\né‚£å¦‚æœä¸€ç¬”äº¤æ˜“ï¼Œæ¶‰åŠåˆ°è·¨å¤šä¸ªç³»ç»Ÿã€å¤šä¸ªæ•°æ®åº“çš„æ—¶å€™ï¼Œç”¨å•ä¸€çš„æ•°æ®åº“äº‹åŠ¡å°±æ²¡åŠæ³•è§£å†³äº†ã€‚\nå¦‚ä½•æ¥è§£å†³è¿™ç§è·¨ç³»ç»Ÿã€è·¨æ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å’±ä»¬è¦è®¨è®ºçš„ä¸»é¢˜ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡ä¹Ÿæ˜¯äº‹åŠ¡ï¼Œä¹Ÿéœ€è¦éµä» ACID å››ä¸ªç‰¹æ€§ï¼Œä½†å®é™…æƒ…å†µæ˜¯ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå› ä¸ºå¿…é¡»å…¼é¡¾æ€§èƒ½å’Œé«˜å¯ç”¨ï¼Œæ‰€ä»¥æ˜¯ä¸å¯èƒ½å®Œå…¨æ»¡è¶³ ACID çš„ã€‚æˆ‘ä»¬å¸¸ç”¨çš„å‡ ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°æ–¹æ³•ï¼Œéƒ½æ˜¯â€œæ®‹è¡€ç‰ˆâ€çš„äº‹åŠ¡ï¼Œè€Œä¸”ç›¸æ¯”æ•°æ®åº“äº‹åŠ¡ï¼Œæ›´åŠ çš„â€œæ®‹è¡€â€ã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š2PCã€3PCã€TCCã€Saga å’Œæœ¬åœ°æ¶ˆæ¯è¡¨ç­‰ç­‰ã€‚è¿™äº›æ–¹æ³•ï¼Œå®ƒçš„å¼ºé¡¹å’Œå¼±é¡¹éƒ½ä¸ä¸€æ ·ï¼Œé€‚ç”¨çš„åœºæ™¯ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥æœ€å¥½è¿™äº›åˆ†å¸ƒå¼äº‹åŠ¡ä½ éƒ½èƒ½å¤ŸæŒæ¡ï¼Œè¿™æ ·æ‰èƒ½åœ¨é¢ä¸´å®é™…é—®é¢˜çš„æ—¶å€™é€‰æ‹©åˆé€‚çš„æ–¹æ³•ã€‚è¿™é‡Œé¢ï¼Œ2PC å’Œæœ¬åœ°æ¶ˆæ¯è¡¨è¿™ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”è¾ƒè´´è¿‘äºæˆ‘ä»¬æ—¥å¸¸å¼€å‘çš„ä¸šåŠ¡ç³»ç»Ÿã€‚\näº‹åŠ¡æ¶ˆæ¯ åœ¨å¿«é¤åº—ç‚¹é¤å¹¶ä»˜é’±åï¼Œå¹¶ä¸ä¼šç›´æ¥ç»™ä½ é¤ç‚¹ï¼Œå¾€å¾€æ˜¯ç»™ä½ ä¸€å¼ å°ç¥¨æˆ–åºå·ï¼Œç„¶åè®©ä½ æ‹¿ç€å‡­è¯åˆ°å‡ºè´§åŒºæ’é˜Ÿå–ã€‚\nä¸ºä»€ä¹ˆè¦å°†ä»˜é’±å’Œå–è´§ä¸¤ä¸ªåŠ¨ä½œåˆ†å¼€å‘¢? ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› æ˜¯ä¸ºäº†ä½¿ä»–ä»¬æ¥å¾…èƒ½åŠ›å¢å¼ºã€‚åªè¦å‡­è¯èƒ½å¯é ä¿å­˜ï¼Œä¾é å‡­è¯(æ¶ˆæ¯)èƒ½å®Œæˆæœ€ç»ˆä¸€è‡´æ€§ã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ³• å¼ºä¸€è‡´æ€§ é«˜å¹¶å‘ å¯ç”¨æ€§ åº”ç”¨åœºæ™¯ 2PC ä¼˜ å·® å·® è®¢å•ç³»ç»Ÿå®Œæˆï¼Œä¿ƒé”€ç³»ç»Ÿé”€æ¯ä¼˜æƒ åˆ¸ æœ¬åœ°æ¶ˆæ¯è¡¨ ä¼˜ è‰¯ è‰¯ è®¢å•ç³»ç»Ÿå®Œæˆï¼Œè´­ç‰©è½¦ç³»ç»Ÿæ¸…ç©ºç‰©å“ äº‹åŠ¡æ”¶ä»¶ç®± ( Transactional outbox ) è½®è¯¢å‘å¸ƒ ( Polling publisher ) ( Transaction log tailing ) ä¸¤é˜¶æ®µæäº¤ ( 2PC ) mysqlçš„äº‹åŠ¡å°±æ˜¯é€šè¿‡**ã€Œæ—¥å¿—ç³»ç»Ÿã€**æ¥å®Œæˆä¸¤é˜¶æ®µæäº¤çš„ã€‚ç”±ä¸€ä¸ªå…¨å±€çš„äº‹åŠ¡ç®¡ç†å™¨åè°ƒå„ä¸ªå­ç³»ç»Ÿçš„å±€éƒ¨äº‹åŠ¡ç®¡ç†å™¨å®Œæˆä¸¤é˜¶æ®µæäº¤ã€‚\nåœ¨æˆ‘ä»¬è´­ç‰©ä¸‹å•æ—¶ï¼Œå¦‚æœä½¿ç”¨äº†ä¼˜æƒ åˆ¸ï¼Œè®¢å•ç³»ç»Ÿå’Œä¼˜æƒ åˆ¸ç³»ç»Ÿéƒ½è¦æ›´æ–°è‡ªå·±çš„æ•°æ®ï¼Œæ‰èƒ½å®Œæˆâ€œåœ¨è®¢å•ä¸­ä½¿ç”¨ä¼˜æƒ åˆ¸â€è¿™ä¸ªæ“ä½œã€‚\nè®¢å•ç³»ç»Ÿå†…ä¸¤ä¸ªæ“ä½œçš„ä¸€è‡´æ€§é—®é¢˜å¯ä»¥ç›´æ¥ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡æ¥è§£å†³ã€‚ä¿ƒé”€ç³»ç»Ÿéœ€è¦æ“ä½œå°±æ¯”è¾ƒç®€å•ï¼ŒæŠŠåˆšåˆšä½¿ç”¨çš„é‚£å¼ ä¼˜æƒ åˆ¸çš„çŠ¶æ€æ›´æ–°æˆâ€œå·²ä½¿ç”¨â€å°±å¯ä»¥äº†ã€‚æˆ‘ä»¬éœ€è¦è¿™ä¸¤ä¸ªç³»ç»Ÿçš„æ•°æ®æ›´æ–°æ“ä½œä¿æŒä¸€è‡´ï¼Œè¦ä¹ˆéƒ½æ›´æ–°æˆåŠŸï¼Œè¦ä¹ˆéƒ½æ›´æ–°å¤±è´¥ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ 2PC æ˜¯æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚2PC å¼•å…¥äº†ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…çš„è§’è‰²ï¼Œæ¥åè°ƒè®¢å•ç³»ç»Ÿå’Œä¿ƒé”€ç³»ç»Ÿï¼Œåè°ƒè€…å¯¹å®¢æˆ·ç«¯æä¾›ä¸€ä¸ªå®Œæ•´çš„â€œä½¿ç”¨ä¼˜æƒ åˆ¸ä¸‹å•â€çš„æœåŠ¡ï¼Œåœ¨è¿™ä¸ªæœåŠ¡çš„å†…éƒ¨ï¼Œåè°ƒè€…å†åˆ†åˆ«è°ƒç”¨è®¢å•å’Œä¿ƒé”€çš„ç›¸åº”æœåŠ¡ã€‚\näºŒé˜¶æ®µæŒ‡çš„æ˜¯å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µã€‚åœ¨å‡†å¤‡é˜¶æ®µï¼Œåè°ƒè€…åˆ†åˆ«ç»™è®¢å•ç³»ç»Ÿå’Œä¿ƒé”€ç³»ç»Ÿå‘é€â€œå‡†å¤‡â€å‘½ä»¤ï¼Œè®¢å•å’Œä¿ƒé”€ç³»ç»Ÿæ”¶åˆ°å‡†å¤‡å‘½ä»¤ä¹‹åï¼Œå¼€å§‹æ‰§è¡Œå‡†å¤‡æ“ä½œã€‚å‡†å¤‡é˜¶æ®µéƒ½éœ€è¦åšå“ªäº›äº‹å„¿å‘¢ï¼Ÿä½ å¯ä»¥ç†è§£ä¸ºï¼Œé™¤äº†æäº¤æ•°æ®åº“äº‹åŠ¡ä»¥å¤–çš„æ‰€æœ‰å·¥ä½œï¼Œéƒ½è¦åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆã€‚æ¯”å¦‚è¯´è®¢å•ç³»ç»Ÿåœ¨å‡†å¤‡é˜¶æ®µéœ€è¦å®Œæˆï¼š\nåœ¨è®¢å•åº“å¼€å¯ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ï¼› åœ¨â€œè®¢å•ä¼˜æƒ åˆ¸è¡¨â€å†™å…¥è¿™æ¡è®¢å•çš„ä¼˜æƒ åˆ¸è®°å½•ï¼› åœ¨â€œè®¢å•è¡¨â€ä¸­å†™å…¥è®¢å•æ•°æ®ã€‚ æ³¨æ„ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰æäº¤è®¢å•æ•°æ®åº“çš„äº‹åŠ¡ï¼Œæœ€åç»™äº‹åŠ¡åè°ƒè€…è¿”å›â€œå‡†å¤‡æˆåŠŸâ€ã€‚ç±»ä¼¼çš„ï¼Œä¿ƒé”€æœåŠ¡åœ¨å‡†å¤‡é˜¶æ®µï¼Œéœ€è¦åœ¨ä¿ƒé”€åº“å¼€å¯ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ï¼Œæ›´æ–°ä¼˜æƒ åˆ¸çŠ¶æ€ï¼Œä½†æ˜¯æš‚æ—¶ä¸è¦æäº¤è¿™ä¸ªæ•°æ®åº“äº‹åŠ¡ï¼Œç»™åè°ƒè€…è¿”å›â€œå‡†å¤‡æˆåŠŸâ€ã€‚åè°ƒè€…åœ¨æ”¶åˆ°ä¸¤ä¸ªç³»ç»Ÿâ€œå‡†å¤‡æˆåŠŸâ€çš„å“åº”ä¹‹åï¼Œå¼€å§‹è¿›å…¥ç¬¬äºŒé˜¶æ®µã€‚\nç­‰ä¸¤ä¸ªç³»ç»Ÿéƒ½å‡†å¤‡å¥½äº†ä¹‹åï¼Œè¿›å…¥æäº¤é˜¶æ®µã€‚æäº¤é˜¶æ®µå°±æ¯”è¾ƒç®€å•äº†ï¼Œåè°ƒè€…å†ç»™è¿™ä¸¤ä¸ªç³»ç»Ÿå‘é€â€œæäº¤â€å‘½ä»¤ï¼Œæ¯ä¸ªç³»ç»Ÿæäº¤è‡ªå·±çš„æ•°æ®åº“äº‹åŠ¡ï¼Œç„¶åç»™åè°ƒè€…è¿”å›â€œæäº¤æˆåŠŸâ€å“åº”ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å“åº”ä¹‹åï¼Œç»™å®¢æˆ·ç«¯è¿”å›æˆåŠŸå“åº”ï¼Œæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å°±ç»“æŸäº†ã€‚\nè¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œæ¥ä¸‹æ¥æ‰æ˜¯é‡ç‚¹ï¼šå¼‚å¸¸æƒ…å†µä¸‹æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬è¿˜æ˜¯åˆ†ä¸¤ä¸ªé˜¶æ®µæ¥è¯´æ˜ã€‚åœ¨å‡†å¤‡é˜¶æ®µï¼Œå¦‚æœä»»ä½•ä¸€æ­¥å‡ºç°é”™è¯¯æˆ–è€…æ˜¯è¶…æ—¶ï¼Œåè°ƒè€…å°±ä¼šç»™ä¸¤ä¸ªç³»ç»Ÿå‘é€â€œå›æ»šäº‹åŠ¡â€è¯·æ±‚ã€‚æ¯ä¸ªç³»ç»Ÿåœ¨æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œå›æ»šè‡ªå·±çš„æ•°æ®åº“äº‹åŠ¡ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œä¸¤ä¸ªç³»ç»Ÿçš„æ•°æ®åº“äº‹åŠ¡éƒ½å›æ»šäº†ï¼Œç›¸å…³çš„æ‰€æœ‰æ•°æ®å›æ»šåˆ°åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œä¹‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ²¡æœ‰æ‰§è¡Œä¸€æ ·ã€‚ä»¥ä¸‹æ˜¯å¼‚å¸¸æƒ…å†µçš„æ—¶åºå›¾ï¼š\nåœ¨å®ç° 2PC çš„æ—¶å€™ï¼Œæ²¡å¿…è¦å•ç‹¬å¯åŠ¨ä¸€ä¸ªäº‹åŠ¡åè°ƒæœåŠ¡ï¼Œè¿™ä¸ªåè°ƒæœåŠ¡çš„å·¥ä½œæœ€å¥½å’Œè®¢å•æœåŠ¡æˆ–è€…ä¼˜æƒ åˆ¸æœåŠ¡æ”¾åœ¨åŒä¸€ä¸ªè¿›ç¨‹é‡Œé¢ï¼Œè¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š\nå‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„è¿›ç¨‹æ›´å°‘ï¼Œæ•…éšœç‚¹ä¹Ÿå°±æ›´å°‘ï¼Œç¨³å®šæ€§æ›´å¥½ï¼› å‡å°‘äº†ä¸€äº›è¿œç¨‹è°ƒç”¨ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½ä¸€äº›ã€‚ 2PC æ˜¯ä¸€ç§å¼ºä¸€è‡´çš„è®¾è®¡ï¼Œå®ƒå¯ä»¥ä¿è¯åŸå­æ€§å’Œéš”ç¦»æ€§ã€‚åªè¦ 2PC äº‹åŠ¡å®Œæˆï¼Œè®¢å•åº“å’Œä¿ƒé”€åº“ä¸­çš„æ•°æ®ä¸€å®šæ˜¯ä¸€è‡´çš„çŠ¶æ€ã€‚\næ‰€ä»¥ 2PC æ¯”è¾ƒé€‚åˆé‚£äº›å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªè®¢å•ä¼˜æƒ åˆ¸çš„åœºæ™¯ï¼Œå¦‚æœä¸€è‡´æ€§ä¿è¯ä¸å¥½ï¼Œæœ‰å¯èƒ½ä¼šè¢«é»‘äº§åˆ©ç”¨ï¼Œä¸€å¼ ä¼˜æƒ åˆ¸åå¤ä½¿ç”¨ï¼Œé‚£æ ·æˆ‘ä»¬çš„æŸå¤±å°±å¤§äº†ã€‚\n2PC ä¹Ÿæœ‰å¾ˆæ˜æ˜¾çš„ç¼ºé™·ï¼Œæ•´ä¸ªäº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹éœ€è¦é˜»å¡æœåŠ¡ç«¯çš„çº¿ç¨‹å’Œæ•°æ®åº“çš„ä¼šè¯ï¼Œæ‰€ä»¥ï¼Œ2PC åœ¨å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½ä¸ä¼šå¾ˆé«˜ã€‚\nå¯èƒ½å‡ºç°çš„é—®é¢˜:\nå•ç‚¹æ•…éšœï¼Œä¸€æ—¦äº‹åŠ¡ç®¡ç†å™¨å‡ºç°æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ æ•°æ®ä¸ä¸€è‡´ï¼Œé˜¶æ®µäºŒå¦‚æœäº‹åŠ¡ç®¡ç†å™¨åªå‘é€ å“åº”æ—¶é—´è¾ƒé•¿ï¼Œæ¶ˆæ¯é“¾è·¯ä¸²è¡Œï¼Œè¦ç­‰å¾…å“åº”ç»“æœï¼Œä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ ä¸ç¡®å®šæ€§ï¼Œå½“äº‹åŠ¡ç®¡ç†å™¨å‘é€ commit ä¹‹åï¼Œå¹¶ä¸”æ­¤æ—¶åªæœ‰ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº† commitï¼Œé‚£ä¹ˆå½“è¯¥å‚ä¸è€…ä¸äº‹åŠ¡ç®¡ç†å™¨åŒæ—¶å®•æœºä¹‹åï¼Œé‡æ–°é€‰ä¸¾çš„äº‹åŠ¡ç®¡ç†å™¨æ— æ³•ç¡®å®šè¯¥æ¡æ¶ˆæ¯æ˜¯å¦æäº¤æˆåŠŸã€‚ æœ¬åœ°æ¶ˆæ¯è¡¨ 2PC å®ƒçš„é€‚ç”¨åœºæ™¯å…¶å®æ˜¯å¾ˆçª„çš„ï¼Œæ›´å¤šçš„æƒ…å†µä¸‹ï¼Œåªè¦ä¿è¯æ•°æ®æœ€ç»ˆä¸€è‡´å°±å¯ä»¥äº†ã€‚æ¯”å¦‚è¯´ï¼Œåœ¨è´­ç‰©æµç¨‹ä¸­ï¼Œç”¨æˆ·åœ¨è´­ç‰©è½¦ç•Œé¢é€‰å¥½å•†å“åï¼Œç‚¹å‡»â€œå»ç»“ç®—â€æŒ‰é’®è¿›å…¥è®¢å•é¡µé¢åˆ›å»ºä¸€ä¸ªæ–°è®¢å•ã€‚è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬çš„ç³»ç»Ÿå…¶å®åšäº†ä¸¤ä»¶äº‹å„¿ã€‚\nç¬¬ä¸€ï¼Œè®¢å•ç³»ç»Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°è®¢å•ï¼Œè®¢å•å…³è”çš„å•†å“å°±æ˜¯è´­ç‰©è½¦ä¸­é€‰æ‹©çš„é‚£äº›å•†å“ã€‚ ç¬¬äºŒï¼Œåˆ›å»ºè®¢å•æˆåŠŸåï¼Œè´­ç‰©è½¦ç³»ç»Ÿéœ€è¦æŠŠè®¢å•ä¸­çš„è¿™äº›å•†å“ä»è´­ç‰©è½¦é‡Œåˆ æ‰ã€‚ è¿™ä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œåˆ›å»ºè®¢å•å’Œæ¸…ç©ºè´­ç‰©è½¦è¿™ä¸¤ä¸ªæ•°æ®æ›´æ–°æ“ä½œéœ€è¦ä¿è¯ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚ä½†æ˜¯ï¼Œæ¸…ç©ºè´­ç‰©è½¦è¿™ä¸ªæ“ä½œï¼Œå®ƒå¯¹ä¸€è‡´æ€§è¦æ±‚å°±æ²¡æœ‰æ‰£å‡ä¼˜æƒ åˆ¸é‚£ä¹ˆé«˜ï¼Œè®¢å•åˆ›å»ºæˆåŠŸåï¼Œæ™šå‡ ç§’é’Ÿå†æ¸…ç©ºè´­ç‰©è½¦ï¼Œå®Œå…¨æ˜¯å¯ä»¥æ¥å—çš„ã€‚åªè¦ä¿è¯ç»è¿‡ä¸€ä¸ªå°çš„å»¶è¿Ÿæ—¶é—´åï¼Œæœ€ç»ˆè®¢å•æ•°æ®å’Œè´­ç‰©è½¦æ•°æ®ä¿æŒä¸€è‡´å°±å¯ä»¥äº†ã€‚\næœ¬åœ°æ¶ˆæ¯è¡¨çš„å®ç°æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œè®¢å•æœåŠ¡åœ¨æ”¶åˆ°ä¸‹å•è¯·æ±‚åï¼Œæ­£å¸¸ä½¿ç”¨è®¢å•åº“çš„äº‹åŠ¡å»æ›´æ–°è®¢å•çš„æ•°æ®ï¼Œå¹¶ä¸”ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ªæ•°æ®åº“äº‹åŠ¡è¿‡ç¨‹ä¸­ï¼Œåœ¨æœ¬åœ°è®°å½•ä¸€æ¡æ¶ˆæ¯ã€‚è¿™ä¸ªæ¶ˆæ¯å°±æ˜¯ä¸€ä¸ªæ—¥å¿—ï¼Œå†…å®¹å°±æ˜¯â€œæ¸…ç©ºè´­ç‰©è½¦â€è¿™ä¸ªæ“ä½œã€‚å› ä¸ºè¿™ä¸ªæ—¥å¿—æ˜¯è®°å½•åœ¨æœ¬åœ°çš„ï¼Œè¿™é‡Œé¢æ²¡æœ‰åˆ†å¸ƒå¼çš„é—®é¢˜ï¼Œé‚£è¿™å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å•æœºäº‹åŠ¡ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥è®©è®¢å•åº“çš„äº‹åŠ¡ï¼Œæ¥ä¿è¯è®°å½•æœ¬åœ°æ¶ˆæ¯å’Œè®¢å•åº“çš„ä¸€è‡´æ€§ã€‚å®Œæˆè¿™ä¸€æ­¥ä¹‹åï¼Œå°±å¯ä»¥ç»™å®¢æˆ·ç«¯è¿”å›æˆåŠŸå“åº”äº†ã€‚\nç„¶åï¼Œæˆ‘ä»¬å†ç”¨ä¸€ä¸ªå¼‚æ­¥çš„æœåŠ¡ï¼Œå»è¯»å–åˆšåˆšè®°å½•çš„æ¸…ç©ºè´­ç‰©è½¦çš„æœ¬åœ°æ¶ˆæ¯ï¼Œè°ƒç”¨è´­ç‰©è½¦ç³»ç»Ÿçš„æœåŠ¡æ¸…ç©ºè´­ç‰©è½¦ã€‚è´­ç‰©è½¦æ¸…ç©ºä¹‹åï¼ŒæŠŠæœ¬åœ°æ¶ˆæ¯çš„çŠ¶æ€æ›´æ–°æˆå·²å®Œæˆå°±å¯ä»¥äº†ã€‚å¼‚æ­¥æ¸…ç©ºè´­ç‰©è½¦è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ“ä½œå¤±è´¥äº†ï¼Œå¯ä»¥é€šè¿‡é‡è¯•æ¥è§£å†³ã€‚æœ€ç»ˆï¼Œå¯ä»¥ä¿è¯è®¢å•ç³»ç»Ÿå’Œè´­ç‰©è½¦ç³»ç»Ÿå®ƒä»¬çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚\næ¶ˆæ¯é˜Ÿåˆ— RocketMQ æä¾›ä¸€ç§äº‹åŠ¡æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œå…¶å®å°±æ˜¯æœ¬åœ°æ¶ˆæ¯è¡¨æ€æƒ³çš„ä¸€ä¸ªå®ç°ã€‚ä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯å¯ä»¥è¾¾åˆ°å’Œæœ¬åœ°æ¶ˆæ¯è¡¨ä¸€æ ·çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œç›¸æ¯”æˆ‘ä»¬è‡ªå·±æ¥å®ç°æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€å•ï¼Œä½ ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ã€‚\nå¦‚æœçœ‹äº‹åŠ¡çš„ ACID å››ä¸ªç‰¹æ€§ï¼Œæœ¬åœ°æ¶ˆæ¯è¡¨è¿™ç§æ–¹æ³•ï¼Œå®ƒåªèƒ½æ»¡è¶³ Dï¼ˆæŒä¹…æ€§ï¼‰ï¼ŒAï¼ˆåŸå­æ€§ï¼‰Cï¼ˆä¸€è‡´æ€§ï¼‰ã€Iï¼ˆéš”ç¦»æ€§ï¼‰éƒ½æ¯”è¾ƒå·®ï¼Œä½†æ˜¯ï¼Œå®ƒçš„ä¼˜ç‚¹éå¸¸çªå‡ºã€‚\né¦–å…ˆï¼Œå®ç°ç®€å•ï¼Œåœ¨å•æœºäº‹åŠ¡çš„åŸºç¡€ä¸Šç¨åŠ æ”¹é€ å°±å¯ä»¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¦å¤–ï¼Œæœ¬åœ°æ¶ˆæ¯è¡¨çš„æ€§èƒ½éå¸¸å¥½ï¼Œå’Œå•æœºäº‹åŠ¡çš„æ€§èƒ½å‡ ä¹æ²¡æœ‰å·®åˆ«ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œè¿˜æä¾›äº†å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½èƒ½æ¥å—çš„â€œæ•°æ®æœ€ç»ˆä¸€è‡´æ€§â€çš„ä¿è¯ï¼Œæ‰€ä»¥ï¼Œæœ¬åœ°æ¶ˆæ¯è¡¨æ˜¯æ›´åŠ å®ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡å®ç°æ–¹æ³•ã€‚\nå½“ç„¶ï¼Œå³ä½¿èƒ½æ¥å—æ•°æ®æœ€ç»ˆä¸€è‡´ï¼Œæœ¬åœ°æ¶ˆæ¯è¡¨ä¹Ÿä¸æ˜¯ä»€ä¹ˆåœºæ™¯éƒ½å¯ä»¥é€‚ç”¨çš„ã€‚å®ƒæœ‰ä¸€ä¸ªå‰ææ¡ä»¶å°±æ˜¯ï¼Œå¼‚æ­¥æ‰§è¡Œçš„é‚£éƒ¨åˆ†æ“ä½œï¼Œä¸èƒ½æœ‰ä¾èµ–çš„èµ„æºã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬ä¸‹å•çš„æ—¶å€™ï¼Œé™¤äº†è¦æ¸…ç©ºè´­ç‰©è½¦ä»¥å¤–ï¼Œè¿˜éœ€è¦é”å®šåº“å­˜ã€‚\nä¸‰é˜¶æ®µæäº¤ ( 3PC ) ç›¸å¯¹äº2PCæ¥è¯´å¢åŠ äº†CanCommité˜¶æ®µå’Œè¶…æ—¶æœºåˆ¶ã€‚å¦‚æœæ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åè°ƒè€…çš„commitè¯·æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨è¿›è¡Œcommitï¼Œè§£å†³äº†2PCå•ç‚¹æ•…éšœçš„é—®é¢˜ã€‚\nä½†æ˜¯æ€§èƒ½é—®é¢˜å’Œä¸ä¸€è‡´é—®é¢˜ä»ç„¶æ²¡æœ‰æ ¹æœ¬è§£å†³ã€‚ä¸‹é¢æˆ‘ä»¬è¿˜æ˜¯ä¸€èµ·çœ‹ä¸‹ä¸‰é˜¶æ®µæµç¨‹çš„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ\nç¬¬ä¸€é˜¶æ®µï¼Œåè°ƒè€…è¯¢é—®äº‹åŠ¡å‚ä¸è€…ï¼Œä½ æ˜¯å¦æœ‰èƒ½åŠ›å®Œæˆæ­¤æ¬¡äº‹åŠ¡ã€‚ éƒ½è¿”å› yesï¼Œè¿›å…¥ç¬¬äºŒé˜¶æ®µ æœ‰ä¸€ä¸ªè¿”å› no æˆ– ç­‰å¾…å“åº”è¶…æ—¶ï¼Œåˆ™ä¸­æ–­äº‹åŠ¡ï¼Œå¹¶å‘å‚ä¸è€…å‘é€ abort è¯·æ±‚ ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…ä¼šå‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€PreCommitè¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°åå¼€å§‹æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°†Undoå’ŒRedoä¿¡æ¯è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚å‚ä¸è€…æ‰§è¡Œå®Œäº‹åŠ¡æ“ä½œåï¼ˆæ­¤æ—¶å±äºæœªæäº¤äº‹åŠ¡çš„çŠ¶æ€ï¼‰ï¼Œå°±ä¼šå‘åè°ƒè€…åé¦ˆâ€œAckâ€è¡¨ç¤ºæˆ‘å·²ç»å‡†å¤‡å¥½æäº¤äº†ï¼Œå¹¶ç­‰å¾…åè°ƒè€…çš„ä¸‹ä¸€æ­¥æŒ‡ä»¤ã€‚ ç¬¬ä¸‰é˜¶æ®µï¼Œåœ¨é˜¶æ®µäºŒä¸­å¦‚æœæ‰€æœ‰çš„å‚ä¸è€…èŠ‚ç‚¹éƒ½å¯ä»¥è¿›è¡ŒPreCommitæäº¤ï¼Œé‚£ä¹ˆåè°ƒè€…å°±ä¼šä»â€œé¢„æäº¤çŠ¶æ€â€è½¬å˜ä¸ºâ€œæäº¤çŠ¶æ€â€ã€‚ç„¶åå‘æ‰€æœ‰çš„å‚ä¸è€…èŠ‚ç‚¹å‘é€\u0026quot;doCommit\u0026quot;è¯·æ±‚ï¼Œå‚ä¸è€…èŠ‚ç‚¹åœ¨æ”¶åˆ°æäº¤è¯·æ±‚åå°±ä¼šå„è‡ªæ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶å‘åè°ƒè€…èŠ‚ç‚¹åé¦ˆâ€œAckâ€æ¶ˆæ¯ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„Ackæ¶ˆæ¯åå®Œæˆäº‹åŠ¡ã€‚ç›¸åï¼Œå¦‚æœæœ‰ä¸€ä¸ªå‚ä¸è€…èŠ‚ç‚¹æœªå®ŒæˆPreCommitçš„åé¦ˆæˆ–è€…åé¦ˆè¶…æ—¶ï¼Œé‚£ä¹ˆåè°ƒè€…éƒ½ä¼šå‘æ‰€æœ‰çš„å‚ä¸è€…èŠ‚ç‚¹å‘é€abortè¯·æ±‚ï¼Œä»è€Œä¸­æ–­äº‹åŠ¡ã€‚ ","date":"2022-01-22T00:00:00Z","permalink":"https://blog.golang.space/p/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/","title":"åˆ†å¸ƒå¼äº‹åŠ¡"},{"content":"Pods å®˜æ–¹æ–‡æ¡£\nPod æ˜¯ k8s æŠ½è±¡å‡ºæ¥çš„ï¼Œè¡¨ç¤ºä¸€ç»„ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºå®¹å™¨ã€‚ä»¥åŠè¿™äº›å®¹å™¨çš„ä¸€äº›å…±äº«èµ„æºã€‚\nå…±äº«å­˜å‚¨ï¼Œå½“åšå· ç½‘ç»œï¼Œå”¯ä¸€çš„é›†ç¾¤ IP åœ°å€ æœ‰å…³æ¯ä¸ªå®¹å™¨å¦‚ä½•è¿è¡Œçš„ä¿¡æ¯ å·¥ä½œèŠ‚ç‚¹\nä¸€ä¸ª Pod æ€»æ˜¯è¿è¡Œåœ¨å·¥ä½œèŠ‚ç‚¹ï¼Œå·¥ä½œèŠ‚ç‚¹æ˜¯ k8s ä¸­çš„å‚ä¸è®¡ç®—çš„æœºå™¨ã€‚\næ¯ä¸ª k8s å·¥ä½œèŠ‚ç‚¹è‡³å°‘è¿è¡Œ:\nkubeletï¼Œè´Ÿè´£ k8s ä¸»èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹ä¹‹é—´é€šä¿¡çš„è¿‡ç¨‹ï¼Œå®ƒç®¡ç† Pod å’Œæœºå™¨ä¸Šè¿è¡Œçš„å®¹å™¨ å®¹å™¨è¿è¡Œæ—¶ (å¦‚ docker) è´Ÿè´£ä»ä»“åº“ä¸­æå–å®¹å™¨é•œåƒï¼Œè§£å‹å®¹å™¨å’Œè¿è¡Œåº”ç”¨ç¨‹åº kubectl get - åˆ—å‡ºèµ„æº kubectl describe - æ˜¾ç¤ºæœ‰å…³èµ„æºçš„è¯¦ç»†ä¿¡æ¯ kubectl logs - æ‰“å° pod å’Œå…¶ä¸­å®¹å™¨çš„æ—¥å¿— kubectl exec - åœ¨ pod ä¸­çš„å®¹å™¨ä¸Šæ‰§è¡Œå‘½ä»¤ 1 2 3 4 5 6 7 8 # æŸ¥çœ‹æ‰€æœ‰ pod kubectl get pods -owide # è·å– Pod ä¿¡æ¯ kubectl describe pods # æŸ¥çœ‹æ ‡ç­¾ kubectl get po --show-labels # é€šè¿‡æ ‡ç­¾æ‰¹é‡åˆ é™¤ podï¼Œ -l æ˜¯ --selector çš„çŸ­å‘½ä»¤ kubectl delete po -l name=busybox-pod é€šè¿‡æ–‡ä»¶åˆ›å»º pod\n1 2 3 4 5 # åˆ›å»º yaml æ–‡ä»¶ # ä½ å¯ä»¥ä½¿ç”¨ --dry-run=client å‚æ•°æ¥é¢„è§ˆè€Œä¸çœŸæ­£æäº¤å³å°†ä¸‹å‘åˆ°é›†ç¾¤çš„å¯¹è±¡å®ä¾‹ kubectl run redis --image=redis12 --dry-run=client -oyaml \u0026gt; redis-definition.yaml # é€šè¿‡æ–‡ä»¶åˆ›å»º pod kubectl create -f redis-definition.yaml æ›´æ–°é…ç½®\nreplace ï¼Œä½¿ç”¨æ–°çš„é…ç½®æ–‡ä»¶ä¸­çš„ API å¯¹è±¡ï¼Œæ›¿æ¢åŸæœ‰å¯¹è±¡ applyï¼Œæ‰§è¡Œä¸€ä¸ªå¯¹åŸæœ‰ API å¯¹è±¡çš„ PATCH æ“ä½œ 1 2 3 4 5 # ä¿®æ”¹ é…ç½®æ–‡ä»¶ kubectl apply xxx.yaml # æˆ–è€… kubectl edit pod redis kubectl replace -f redis.yaml --force ä½¿ç”¨ä»£ç†\n1 kubectl proxy 1 curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/ æŸ¥çœ‹æ—¥å¿—\n1 kubectl logs $POD_NAME ä¸€æ—¦ pod å¯åŠ¨å¹¶è¿è¡Œï¼Œå¯ä»¥ç›´æ¥åœ¨å®¹å™¨ä¸Šæ‰§è¡Œå‘½ä»¤\n1 2 3 4 # åˆ—å‡ºå®¹å™¨ç¯å¢ƒå˜é‡ kubectl exec $POD_NAME -- env # å¯åŠ¨ä¸€ä¸ª bash ä¼šè¯ kubectl exec -ti $POD_NAME -- bash åˆ é™¤ pod\n1 kubectl delete po/webapp ReplicaSet å®˜æ–¹æ–‡æ¡£\nç›®çš„æ˜¯ç»´æŠ¤ä¸€ç»„ä»»ä½•æ—¶å€™éƒ½å¤„äºè¿è¡ŒçŠ¶æ€çš„ Pod å‰¯æœ¬çš„ç¨³å®šé›†åˆã€‚\n1 2 3 4 5 6 7 8 # æŸ¥çœ‹ç³»ç»Ÿä¸Šè¿è¡Œäº†å¤šå°‘ replicaSet kc get rs # æŸ¥çœ‹æè¿° kc describe rs/new-replica-set # æŸ¥çœ‹è§£é‡Š kc explain replicaset # æ‰¹é‡åˆ é™¤ kc delete rs/replicaset-1 rs/replicaset-2 ç¼©æ”¾ pod çš„æ•°é‡\n1 kc scale rs/new-replica-set --replicas=5 è·å–ç¼–è¾‘æ–‡ä»¶ï¼Œä¿®æ”¹å‚æ•°\n1 kc edit rs/new-replica-set Deployment å®˜æ–¹æ–‡æ¡£\nä¸€ä¸ª Deployment ä¸º Pods å’Œ ReplicaSets æä¾›å£°æ˜å¼çš„æ›´æ–°èƒ½åŠ›ã€‚\nå¸¸ç”¨å‘½ä»¤\n1 2 3 4 5 6 # æŸ¥çœ‹éƒ¨ç½² kc get deploy # æŸ¥çœ‹é•œåƒ kc describe deploy/frontend-deployment | grep -i image # åˆ›å»ºæ–‡ä»¶ kc create deploy httpd-frontend --image=httpd:2.4-alpine --replicas=3 --dry-run=client -oyaml \u0026gt; httpd-frontend.yaml Namespace å®˜æ–¹æ–‡æ¡£\n1 2 3 4 5 6 7 8 9 10 # åˆ›å»ºåå­—ç©ºé—´ kc create ns dev-ns # æŸ¥çœ‹æœ‰å¤šå°‘åå­—ç©ºé—´ kc get ns --no-headers | wc -l # æŸ¥çœ‹ research ç©ºé—´ä¸‹æœ‰å¤šå°‘ Pods kc get po -n research # åœ¨ finance ç©ºé—´åˆ›å»ºé•œåƒ kc run redis --image=redis -n finance # æŸ¥çœ‹å“ªä¸ª pod å±äº blue ç©ºé—´ kc get po -A | grep blue é€šè¿‡é…ç½®æ–‡ä»¶æ¥åˆ›å»ºæˆ–ä¿®æ”¹åå­—ç©ºé—´\né€šè¿‡ DNS åç§°æ¥è®¿é—®\n1 2 db-service.dev.svc.cluster.local # \u0026lt;svc åç§°\u0026gt;.\u0026lt;åå­—ç©ºé—´\u0026gt;.svc.cluster.local é‡è¦çš„å‘½ä»¤ åˆ›å»º Pods ï¼ŒåŠ ä¸Š tier=db æ ‡ç­¾\n1 kc run redis --image=redis:alpine -l tier=db åœ¨é…ç½®æ–‡ä»¶ç¼–å†™æ ‡ç­¾\nè®¾ç½®ç«¯å£\n1 kc expose po/redis --name=redis-service --port=6379 port æœåŠ¡ç«¯å£ target-port å®¹å™¨ç«¯å£ type æœ‰å››ç§ ClusterIP(é»˜è®¤)ï¼ŒNodePort, LoadBalancer, ExternalName åˆ›å»º Pod çš„åŒæ—¶æš´éœ²ç«¯å£\n1 kubectl run httpd --image=httpd:alpine --port=80 --expose æ‰§è¡Œå‘½ä»¤å’Œå‚æ•° å®˜æ–¹æ–‡æ¡£\nPod åˆ›å»ºæ–‡ä»¶ä¸­ comamnd ä¸ Dockerfile ä¸­ ENTRYPOINT [\u0026quot;python\u0026quot;, \u0026quot;app.py\u0026quot;] å¯¹åº”\nPod åˆ›å»ºæ–‡ä»¶ä¸­ args: [\u0026quot;--color\u0026quot;, \u0026quot;pink\u0026quot;] ä¸ Dockerfile ä¸­CMD [\u0026quot;--color\u0026quot;, \u0026quot;red\u0026quot;] å¯¹åº”\n1 2 # åˆ›å»ºå®¹å™¨æ—¶ï¼Œä¿®æ”¹å‚æ•° kc run webapp-green --image=kodekloud/webapp-color -- \u0026#34;--color=green\u0026#34; ConfigMaps å®˜æ–¹æ–‡æ¡£\nConfigMap æ˜¯ä¸€ç§ API å¯¹è±¡ï¼Œç”¨æ¥å°†éæœºå¯†æ€§çš„æ•°æ®ä¿å­˜åˆ°é”®å€¼å¯¹ä¸­ã€‚\nConfigMap å°†ç¯å¢ƒé…ç½®ä¿¡æ¯å’Œ å®¹å™¨é•œåƒ è§£è€¦ï¼Œä¾¿äºåº”ç”¨é…ç½®çš„ä¿®æ”¹ã€‚\nè®¾ç½®ç¯å¢ƒå˜é‡\n1 2 3 4 5 6 7 8 apiVersion: v1 kind: Pod metadata: spec: containers: - env: - name: APP_COLOR value: green å¸¸ç”¨å‘½ä»¤\n1 2 3 4 5 6 # æŸ¥çœ‹æœ‰å¤šå°‘ configmap kc get cm # æŸ¥çœ‹è¯¦æƒ… kc describe cm/db-config # é€šè¿‡å‘½ä»¤åˆ›å»º configmap kc create cm webapp-config-map --from-literal=APP_COLOR=darkblue é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º configmap\n1 APP_COLOR=darkblue 1 kc create cm webapp-config-map --from-file=webapp-config-map.toml ä¸º Pod é…ç½® configmap\n1 2 3 4 5 6 7 8 apiVersion: v1 kind: Pod metadata: spec: containers: - envFrom: - configMapRef: name: webapp-config-map Secret å®˜æ–¹æ–‡æ¡£\nSecret æ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ä¾‹å¦‚å¯†ç ã€ä»¤ç‰Œæˆ–å¯†é’¥çš„å¯¹è±¡ã€‚ä½¿ç”¨ Secret æ„å‘³ç€ä½ ä¸éœ€è¦åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­åŒ…å«æœºå¯†æ•°æ®ã€‚Secret ç±»ä¼¼äº ConfigMap ä½†ä¸“é—¨ç”¨äºä¿å­˜æœºå¯†æ•°æ®ã€‚\n1 2 3 4 5 # åˆ›å»º é€šç”¨ç±»å‹ secret kc create secret generic \u0026lt;åç§°\u0026gt; --from-literal=DB_Host=sql01 # ä¾‹å­ kc create secret generic db-secret --from-literal=DB_Host=sql01 --from-literal=DB_User=root --from-literal=DB_Password=password123 ä¸º Pod é…ç½® secret ç¯å¢ƒå˜é‡\n1 2 3 4 5 6 7 8 apiVersion: v1 kind: Pod metadata: spec: containers: - envFrom: - secretRef: name: db-secret Security Context å®˜æ–¹æ–‡æ¡£\nå®‰å…¨ä¸Šä¸‹æ–‡å®šä¹‰ Pod æˆ– Container çš„ç‰¹æƒä¸è®¿é—®æ§åˆ¶è®¾ç½®ã€‚\n1 2 # åœ¨å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤ï¼ŒæŸ¥çœ‹å½“å‰æ˜¯å“ªä¸ªç”¨æˆ· kubectl exec \u0026lt;Pod åç§°\u0026gt; -- whoami é…ç½®ç³»ç»Ÿç”¨æˆ·\n1 2 3 4 5 6 7 apiVersion: v1 kind: Pod metadata: spec: securityContext: runAsUser: 1010 containers: Resource Limits å®˜æ–¹æ–‡æ¡£\nOOMKILLED é”™è¯¯è¡¨ç¤ºå†…å­˜ä¸è¶³\nä¿®æ”¹é…ç½®\nrequests èµ„æºè®¾å®šè¯·æ±‚å€¼ limit çº¦æŸå€¼ Kï¼ŒMï¼ŒGï¼ŒTï¼ŒPï¼ŒE #é€šå¸¸æ˜¯ä»¥1000ä¸ºæ¢ç®—æ ‡å‡†çš„ã€‚\nKiï¼ŒMiï¼ŒGiï¼ŒTiï¼ŒPiï¼ŒEi #é€šå¸¸æ˜¯ä»¥1024ä¸ºæ¢ç®—æ ‡å‡†çš„ã€‚\nK8S çš„ 1000 = CPU ä¸€ä¸ªæ ¸ã€‚å››æ ¸è¡¨ç¤º 4*1000\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 kind: Pod metadata: spec: containers: - resources: limits: memory: 20Mi cpu: requests: memory: 5Mi cpu: Service-Accounts å®˜æ–¹æ–‡æ¡£\nKubernetes åŒºåˆ†ç”¨æˆ·è´¦å·å’ŒæœåŠ¡è´¦å·çš„æ¦‚å¿µ\nç”¨æˆ·è´¦å·æ˜¯é’ˆå¯¹äººè€Œè¨€çš„ã€‚ æœåŠ¡è´¦å·æ˜¯é’ˆå¯¹è¿è¡Œåœ¨ Pod ä¸­çš„è¿›ç¨‹è€Œè¨€çš„ã€‚ ç”¨æˆ·è´¦å·æ˜¯å…¨å±€æ€§çš„ã€‚å…¶åç§°è·¨é›†ç¾¤ä¸­åå­—ç©ºé—´å”¯ä¸€çš„ã€‚æœåŠ¡è´¦å·æ˜¯åå­—ç©ºé—´ä½œç”¨åŸŸçš„ã€‚ é€šç”¨å‘½ä»¤\n1 2 3 4 # æŸ¥çœ‹æœ‰å¤šå°‘ service account kc get sa # åˆ›å»º kc create sa \u0026lt;åç§°\u0026gt; é…ç½®æ–‡ä»¶è‡ªåŠ¨è¯»å–æœåŠ¡è´¦å·\n1 2 3 4 5 6 apiVersion: v1 kind: Pod metadata: spec: serviceAccountName: dashboard-sa containers: Taints And Tolerations å®˜æ–¹æ–‡æ¡£\næ±¡ç‚¹å’Œå®¹å¿åº¦ç›¸äº’é…åˆï¼Œå¯ä»¥ç”¨æ¥é¿å… Pod è¢«åˆ†é…åˆ°ä¸åˆé€‚çš„èŠ‚ç‚¹ä¸Šã€‚ å¦‚æœä½ éœ€è¦æŸä¸ªèŠ‚ç‚¹ä»…ä¼šè¿è¡ŒæŸä¸€ç±» Podã€‚\né€šç”¨å‘½ä»¤\næ•ˆæœ\nNoScheduleï¼ŒKubernetes ä¸ä¼šå°† Pod åˆ†é…åˆ°è¯¥èŠ‚ç‚¹ã€‚ PreferNoScheduleï¼ŒKubernetes ä¼š å°è¯• ä¸å°† Pod åˆ†é…åˆ°è¯¥èŠ‚ç‚¹ NoExecuteï¼Œ Kubernetes ä¸ä¼šå°† Pod åˆ†é…åˆ°è¯¥èŠ‚ç‚¹ï¼Œå·²ç»å­˜åœ¨ä¼šé©±é€ã€‚ 1 2 3 4 5 6 # æŸ¥çœ‹èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹ kubectl describe node node01 | grep -A2 -i taints # ä¸º node01 èŠ‚ç‚¹åˆ›å»ºæ±¡ç‚¹ kc taint node node01 spray=mortein:NoSchedule # åˆ é™¤æ±¡ç‚¹ï¼Œé»˜è®¤åŠ  - å· kc taint node node01 spray=mortein:NoSchedule- é€šè¿‡å¯¹ Pods è®¾ç½®å®¹å¿ï¼Œå°† Pods åˆ†é…åˆ°æŒ‡å®šæ±¡ç‚¹çš„èŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 apiVersion: kind: metadata: spec: tolerations: - key: \u0026#34;spray\u0026#34; operator: \u0026#34;Equal\u0026#34; value: \u0026#34;mortein\u0026#34; effect: \u0026#34;NoSchedule\u0026#34; containers: Node Affinity èŠ‚ç‚¹äº²å’Œæ€§ å®˜æ–¹æ–‡æ¡£\næœ‰ä¸¤ç§ç±»å‹\nrequiredDuringSchedulingIgnoredDuringExecution ç¡¬éœ€æ±‚ï¼Œè°ƒåº¦åˆ°ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³çš„è§„åˆ™ preferredDuringSchedulingIgnoredDuringExecution è½¯éœ€æ±‚ï¼Œè°ƒåº¦å™¨å°è¯•æ‰§è¡Œï¼Œä½†ä¸èƒ½ä¿è¯è¾¾åˆ° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/e2e-az-name operator: In values: - e2e-az1 - e2e-az2 preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: another-node-label-key operator: In values: - another-node-label-value è§„åˆ™è¡¨ç¤º: Pod åªèƒ½æ”¾ç½®åœ¨å…·æœ‰æ ‡ç­¾é”®kubernetes.io/e2e-az-nameä¸”å€¼ä¸ºe2e-az1æˆ–e2e-az2çš„èŠ‚ç‚¹ä¸Šã€‚\nå¦å¤–ï¼Œåœ¨æ»¡è¶³è¿™äº›æ ‡å‡†çš„èŠ‚ç‚¹ä¸­ï¼Œå…·æœ‰æ ‡ç­¾ another-node-label-key=another-node-label-value çš„èŠ‚ç‚¹ä¼˜å…ˆä½¿ç”¨ã€‚\noperator çš„å¯é€‰å‚æ•°:\nIn NotIn Exists DoesNotExist Gt Lt ä¾æ®å¼ºåˆ¶çš„èŠ‚ç‚¹äº²å’Œæ€§è°ƒåº¦ Podï¼Œä¸‹æ–¹çš„é…ç½®æ„å‘³ç€ Pod åªä¼šè¢«è°ƒåº¦åˆ°å…·æœ‰ color=blue æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šã€‚å¦‚æœä½ éœ€è¦ Pod ä¼˜å…ˆæˆ–å¼ºåˆ¶è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ã€‚\nå·²ç»éƒ¨ç½²çš„ Pod ä¸ä¼šå¤„ç†ã€‚\n1 2 3 4 5 6 # æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çš„æ ‡ç­¾ kubectl get nodes --show-labels # ä¸ºèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾ kubectl label node node01 color=blue # åˆ é™¤æ ‡ç­¾ kc label node node01 color- 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: kind: metadata: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: color operator: In values: - blue containers: å°† Pod éƒ¨ç½²åˆ° master èŠ‚ç‚¹ä¸Š\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: kind: metadata: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: node-role.kubernetes.io/master operator: Exists containers: å­˜æ´»/å°±ç»ª/å¯åŠ¨æ¢æµ‹å™¨ å®˜æ–¹æ–‡æ¡£\nlivenessProbe å­˜æ´»æ¢æµ‹å™¨å¯ä»¥æ¢æµ‹åˆ°åº”ç”¨æ­»é”ï¼Œå¦‚æœåº”ç”¨å‘ç”Ÿå´©æºƒï¼ŒPod ä¼šé‡å¯ readinessProbe å°±ç»ªæ¢æµ‹å™¨å¯ä»¥çŸ¥é“å®¹å™¨ä½•æ—¶å‡†å¤‡å¥½æ¥å—è¯·æ±‚æµé‡ï¼Œå½“ä¸€ä¸ª Pod å†…çš„æ‰€æœ‰å®¹å™¨éƒ½å°±ç»ªæ—¶ï¼Œæ‰èƒ½è®¤ä¸ºè¯¥ Pod å°±ç»ªã€‚ è¿™ç§ä¿¡å·çš„ä¸€ä¸ªç”¨é€”å°±æ˜¯æ§åˆ¶å“ªä¸ª Pod ä½œä¸º Service çš„åç«¯ã€‚ è‹¥ Pod å°šæœªå°±ç»ªï¼Œä¼šè¢«ä» Service çš„è´Ÿè½½å‡è¡¡å™¨ä¸­å‰”é™¤ã€‚å½“åº”ç”¨ç¨‹åºå´©æºƒæ—¶ï¼Œå®¹å™¨ä¼šé‡æ–°å¯åŠ¨ã€‚åœ¨æ­¤æœŸé—´ï¼ŒæœåŠ¡å°†ç”¨æˆ·å¼•å¯¼è‡³å¯ç”¨çš„ PODã€‚ å¯åŠ¨æ¢æµ‹å™¨æ¥äº†è§£åº”ç”¨å®¹å™¨ä½•æ—¶å¯åŠ¨ã€‚å¯åŠ¨æ¢æµ‹å™¨å¯ä»¥ç”¨äºå¯¹æ…¢å¯åŠ¨å®¹å™¨è¿›è¡Œå­˜æ´»æ€§æ£€æµ‹ï¼Œé¿å…å®ƒä»¬åœ¨å¯åŠ¨è¿è¡Œä¹‹å‰å°±è¢«æ€æ‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Pod metadata: spec: containers: - name: liveness # http å­˜æ´»æ¢æµ‹ livenessProbe: httpGet: path: /healthz port: 8080 httpHeaders: - name: Custom-Header value: Awesome # æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰åº”è¯¥ç­‰å¾… 5 ç§’ initialDelaySeconds: 3 # æ¯éš” 3 ç§’æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢æµ‹ periodSeconds: 3 ä½¿ç”¨å¯åŠ¨æ¢æµ‹å™¨ä¿æŠ¤æ…¢å¯åŠ¨å®¹å™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 apiVersion: v1 kind: Pod metadata: spec: containers: - name: liveness ports: - name: liveness-port containerPort: 8080 hostPort: 8080 livenessProbe: httpGet: path: /healthz port: liveness-port failureThreshold: 1 # æ¢æµ‹å¤±è´¥æ—¶ï¼Œé‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤å€¼ 3 periodSeconds: 10 startupProbe: httpGet: path: /healthz port: liveness-port failureThreshold: 30 periodSeconds: 10 å¤šå®¹å™¨ Pod 1 2 # æŸ¥çœ‹ webapp-2 Pod ä¸­çš„ simple-webapp å®¹å™¨ kubectl logs webapp-2 -c simple-webapp æ€§èƒ½æ£€æŸ¥ 1 kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml 1 2 3 4 # æŸ¥çœ‹å„ä¸ª node æ€§èƒ½ kubectl top node # æŸ¥çœ‹å„ä¸ª pod æ€§èƒ½ kc top po æ›´æ–° 1 2 # æŸ¥çœ‹æ›´æ–°ç­–ç•¥ kc describe deploy/frontend | grep StrategyType é‡å»ºæ›´æ–° Recreate é‡å»ºæ›´æ–°ï¼Œä¼šç«‹å³åœæ­¢æ‰€æœ‰å®¹å™¨ï¼Œé‡æ–°åˆ›å»ºã€‚\næ»šåŠ¨æ›´æ–° ç”¨æˆ·å¸Œæœ›åº”ç”¨ç¨‹åºå§‹ç»ˆå¯ç”¨ï¼Œè€Œå¼€å‘äººå‘˜åˆ™éœ€è¦æ¯å¤©å¤šæ¬¡éƒ¨ç½²å®ƒä»¬çš„æ–°ç‰ˆæœ¬ã€‚åœ¨ Kubernetes ä¸­ï¼Œè¿™äº›æ˜¯é€šè¿‡æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updatesï¼‰å®Œæˆçš„ã€‚ æ»šåŠ¨æ›´æ–° å…è®¸é€šè¿‡ä½¿ç”¨æ–°çš„å®ä¾‹é€æ­¥æ›´æ–° Pod å®ä¾‹ï¼Œé›¶åœæœºè¿›è¡Œ Deployment æ›´æ–°ã€‚æ–°çš„ Pod å°†åœ¨å…·æœ‰å¯ç”¨èµ„æºçš„èŠ‚ç‚¹ä¸Šè¿›è¡Œè°ƒåº¦ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œæ›´æ–°æœŸé—´ä¸å¯ç”¨çš„ pod çš„æœ€å¤§å€¼å’Œå¯ä»¥åˆ›å»ºçš„æ–° pod æ•°éƒ½æ˜¯ 1ã€‚è¿™ä¸¤ä¸ªé€‰é¡¹éƒ½å¯ä»¥é…ç½®ä¸ºï¼ˆpodï¼‰æ•°å­—æˆ–ç™¾åˆ†æ¯”ã€‚ åœ¨ Kubernetes ä¸­ï¼Œæ›´æ–°æ˜¯ç»è¿‡ç‰ˆæœ¬æ§åˆ¶çš„ï¼Œä»»ä½• Deployment æ›´æ–°éƒ½å¯ä»¥æ¢å¤åˆ°ä»¥å‰çš„ï¼ˆç¨³å®šï¼‰ç‰ˆæœ¬ã€‚\nä¸åº”ç”¨ç¨‹åºæ‰©å±•ç±»ä¼¼ï¼Œå¦‚æœå…¬å¼€äº† Deploymentï¼ŒæœåŠ¡å°†åœ¨æ›´æ–°æœŸé—´ä»…å¯¹å¯ç”¨çš„ pod è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å¯ç”¨ Pod æ˜¯åº”ç”¨ç¨‹åºç”¨æˆ·å¯ç”¨çš„å®ä¾‹ã€‚\næ»šåŠ¨æ›´æ–°å…è®¸ä»¥ä¸‹æ“ä½œï¼š\nå°†åº”ç”¨ç¨‹åºä»ä¸€ä¸ªç¯å¢ƒæå‡åˆ°å¦ä¸€ä¸ªç¯å¢ƒï¼ˆé€šè¿‡å®¹å™¨é•œåƒæ›´æ–°ï¼‰ å›æ»šåˆ°ä»¥å‰çš„ç‰ˆæœ¬ æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜åº”ç”¨ç¨‹åºï¼Œæ— éœ€åœæœº kubectl set image æ›´æ–°é•œåƒ\n1 kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2 è·å–ç«¯å£å¹¶è®¾ç½®æˆç¯å¢ƒå˜é‡\n1 export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template=\u0026#39;{{(index .spec.ports 0).nodePort}}\u0026#39;) æ£€æŸ¥\n1 2 3 4 5 6 7 8 9 kubectl rollout status deployments/kubernetes-bootcamp # å›æ»š kubectl rollout undo deployments/kubernetes-bootcamp # é‡æ–°éƒ¨ç½² kubectl rollout restart deployments/kubernetes-bootcamp # æŸ¥çœ‹å†å²ç‰ˆæœ¬ kubectl rollout history deployments/kubernetes-bootcamp # å›åˆ°æŒ‡å®šçš„å†å²ç‰ˆæœ¬ kubectl rollout undo deploy/frontend --to-revision=2 RollingUpdate æ»šåŠ¨æ›´æ–°ï¼Œè®¾ç½® maxUnavailable å’Œ maxSurge æ§åˆ¶æ›´æ–°å®¹å™¨å¹…åº¦ã€‚\n1 2 3 4 5 strategy: rollingUpdate: maxSurge: 25% maxUnavailable: 25% type: RollingUpdate ä¿®æ”¹ strategy type ï¼Œä½¿ç”¨ kubectl edit å¯ä»¥ç›´æ¥ä¿®æ”¹ã€‚\nJobs And CronJob å¦‚ä½•åˆ—å‡ºéš¶å±æŸ job çš„æ‰€æœ‰ pods ?\n1 kubectl get pods --selector=job-name=pi --output=jsonpath=\u0026#39;{.items[*].metadata.name}\u0026#39; æ¨¡æ¿å…³é”®å­—\n1 2 3 4 5 6 7 8 spec: template: # æœ€å¤§å¤±è´¥æ¬¡æ•°ï¼Œè¾¾åˆ°æ¬¡æ•°åè§†ä¸º job å¤±è´¥ backoffLimit: 4 # æ§åˆ¶å¹¶è¡Œæ•°é‡(éè´Ÿæ•´æ•°)ï¼Œé»˜è®¤ä¸º 1ï¼Œè®¾ç½®ä¸º 0 æ—¶é—´ç›¸å½“äºæš‚åœä»»åŠ¡ parallelism: 3 # éœ€è¦å®Œæˆçš„æ•°é‡ completions: 1 Service ç½‘ç»œæœåŠ¡ 1 2 3 4 5 6 # æŸ¥çœ‹ï¼Œç¬¬ä¸€ä¸ª kubernetes æ˜¯ k8s å¯åŠ¨é»˜è®¤åˆ›å»ºçš„æœåŠ¡ kubectl get svc # åˆ›å»ºæ¨¡æ¿ kc create svc nodeport webapp-service --tcp 8080:8080 --node-port 30080 --dry-run=client -oyaml \u0026gt; s.yaml # å¯¹ç°æœ‰çš„éƒ¨ç½²åˆ›å»º svc kubectl expose -n ingress-space deployment ingress-controller --type=NodePort --port=80 --name=ingress --dry-run=client -o yaml \u0026gt; ingress.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 --- apiVersion: v1 kind: Service metadata: name: webapp-service spec: type: NodePort ports: - targetPort: 8080 # å®¹å™¨æ¥æ”¶æµé‡çš„ç«¯å£ port: 8080\t# ä¸»æœºä¸Šå…¶ä»– Pod é€šè¿‡è¯¥ç«¯å£è®¿é—® Service nodePort: 30080 # å¤–éƒ¨æµé‡è®¿é—®K8sçš„ä¸€ç§æ–¹å¼ï¼Œå³nodeIP:nodePort selector: name: simple-webapp Network Policy ç½‘ç»œç­–ç•¥ å¦‚æœä½ å¸Œæœ›åœ¨ IP åœ°å€æˆ–ç«¯å£å±‚é¢ï¼ˆOSI ç¬¬ 3 å±‚æˆ–ç¬¬ 4 å±‚ï¼‰æ§åˆ¶ç½‘ç»œæµé‡ï¼Œ åˆ™ä½ å¯ä»¥è€ƒè™‘ä¸ºé›†ç¾¤ä¸­ç‰¹å®šåº”ç”¨ä½¿ç”¨ Kubernetes ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰ã€‚\nå‰ç½®æ¡ä»¶ ç½‘ç»œç­–ç•¥é€šè¿‡ç½‘ç»œæ’ä»¶ æ¥å®ç°ã€‚è¦ä½¿ç”¨ç½‘ç»œç­–ç•¥ï¼Œä½ å¿…é¡»ä½¿ç”¨æ”¯æŒ NetworkPolicy çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆã€‚ åˆ›å»ºä¸€ä¸ª NetworkPolicy èµ„æºå¯¹è±¡è€Œæ²¡æœ‰æ§åˆ¶å™¨æ¥ä½¿å®ƒç”Ÿæ•ˆçš„è¯ï¼Œæ˜¯æ²¡æœ‰ä»»ä½•ä½œç”¨çš„ã€‚\nIngress å®˜æ–¹æ–‡æ¡£\nå¯ä»¥æä¾›è´Ÿè½½å‡è¡¡ã€SSL ç»ˆç»“å’ŒåŸºäºåç§°çš„è™šæ‹Ÿæ‰˜ç®¡\néœ€è¦å®‰è£…æ§åˆ¶å™¨\n1 2 3 4 # å®‰è£… ingress æ§åˆ¶å™¨ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.2.0/deploy/static/provider/cloud/deploy.yaml # æ£€æŸ¥ kubectl get pods --namespace=ingress-nginx Volume æŒä¹…åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 --- apiVersion: v1 kind: metadata: spec: containers: - name: nginx # å®¹å™¨å†…æŒ‚è½½çš„æ–‡ä»¶å¤¹ volumeMounts: - mountPath: /log name: log-volume volumes: # ä¸»æœºä¸Šçš„æ–‡ä»¶å¤¹ - name: log-volume hostPath: path: /var/log/webapp type: Directory PersistentVolume 1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 kind: PersistentVolume metadata: spec: accessModes: - ReadWriteOnce capacity: storage: 100Mi # ä½¿ç”¨èŠ‚ç‚¹æœ¬åœ°ç›®å½•å­˜å‚¨ï¼Œç”Ÿæˆç¯å¢ƒä¸è¦ä½¿ç”¨ hostPath: path: /tmp/data accessModes è¯´æ˜ ReadOnlyMany åªè¯» ReaedWriteOnce è¯»å†™ä¸€æ¬¡ ReadWriteMany è¯»å†™å¤šæ¬¡ Helm ubuntu å®‰è£… helm\n1 2 3 4 5 curl https://baltocdn.com/helm/signing.asc | sudo apt-key add - sudo apt-get install apt-transport-https --yes echo \u0026#34;deb https://baltocdn.com/helm/stable/debian/ all main\u0026#34; | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list sudo apt-get update sudo apt-get install helm å‚è€ƒ kubectl å®˜æ–¹æ–‡æ¡£ kubernets å®˜æ–¹å…¥é—¨æ•™ç¨‹ ","date":"2022-01-11T11:00:00Z","permalink":"https://blog.golang.space/p/kubernets-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/","title":"Kubernets æ ¸å¿ƒæ¦‚å¿µ"},{"content":"Hey hey æ˜¯ä¸€ä¸ªè½»é‡çº§å‘ web å‘é€è´Ÿè½½çš„å·¥å…·ã€‚\nå‚æ•° è¯´æ˜ -n è¯·æ±‚æ•°ï¼Œé»˜è®¤ 200 -c å¹¶å‘æ•°ï¼Œé»˜è®¤ 50ï¼Œä¸èƒ½å°äºè¯·æ±‚æ•°é‡ -q é€Ÿç‡é™åˆ¶ï¼Œä»¥æ¯ä¸ªå·¥ä½œè€…çš„æ¯ç§’æŸ¥è¯¢æ•° (QPS) ä¸ºå•ä½ -z è¯·æ±‚æ—¶é—´ï¼ŒæŒ‡å®šåå°†å¿½ç•¥è¯·æ±‚æ•°ã€‚ä¾‹å¦‚ : -z 10s -z 3m -o è¾“å‡ºç±»å‹ï¼Œä»…æ”¯æŒ cvs -m è¯·æ±‚æ–¹æ³• GET/POST/\u0026hellip;. -H è‡ªå®šä¹‰ HTTP headerï¼Œå¯é‡ç”¨ã€‚ä¾‹å¦‚: -H \u0026ldquo;Content-Type: application/json\u0026rdquo; -H \u0026ldquo;Accept: text/html\u0026rdquo; -t æ¯ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 20 -A HTTP accept header -a åŸºæœ¬èº«ä»½éªŒè¯ -D æ¥è‡ªæ–‡ä»¶çš„ HTTP request body ï¼Œä¾‹å¦‚ -D ./file.txt -d HTTP request body -T Content-type ï¼Œé»˜è®¤ \u0026ldquo;text/html\u0026rdquo; -x HTTP proxy -h2 å¯ç”¨ HTTP/2 -host HTTP Host header æ›´å¤šè§ github README.md ä¾‹å¦‚\n1 2 # GET è¯·æ±‚ï¼Œå¹¶å‘100ï¼Œè¯·æ±‚ 5 ç§’ hey -m GET -c 100 -z 5s \u0026#34;http://localhost:1323\u0026#34; web ç½‘ç«™çš„å‡ ä¸ªå¹¶å‘é‡çº§ æ¥æºäºç½‘ç»œï¼Œä»…ä¾›å‚è€ƒ\nQPS çº§åˆ« ä¸€èˆ¬ä¸¾æª \u0026lt;50 \u0026lt;10k äºº æ­£å¸¸å¼€å‘ 50~100 \u0026lt;30k äºº ä¼˜åŒ– DB ä¼˜åŒ–æ€§èƒ½ 300~800 \u0026lt;100k äºº è´Ÿè½½å‡è¡¡ / å¼‚åœ°ç¼“å­˜ ","date":"2022-01-05T00:00:00Z","permalink":"https://blog.golang.space/p/%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7/","title":"è½»é‡çº§å‹æµ‹å·¥å…·"},{"content":"æµ‹è¯• åœ¨åŒ…ç›®å½•å†…ï¼Œæ‰€æœ‰ä»¥_test.goä¸ºåç¼€åçš„æºæ–‡ä»¶åœ¨æ‰§è¡Œgo buildæ—¶ä¸ä¼šè¢«æ„å»ºæˆåŒ…çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬æ˜¯go testæµ‹è¯•çš„ä¸€éƒ¨åˆ†ã€‚\næµ‹è¯•æ–‡ä»¶å¯ä»¥æ”¾å…¶å®ƒæºæ–‡ä»¶åŒä¸€ä¸ªç›®å½•ã€‚\nå¦‚æœæµ‹è¯•é’ˆå¯¹çš„æ˜¯æœªå¯¼å‡ºçš„ APIï¼Œé‚£ä¹ˆæµ‹è¯•æ–‡ä»¶å’Œå…¶å®ƒæºä»£ç æ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ªåŒ… package exam å¦‚æœæµ‹è¯•æ˜¯ç”¨æˆ·ä½¿ç”¨è¿™å¥— API çš„æ–¹å¼ï¼Œå¯ä»¥å¯¹æµ‹è¯•æ–‡ä»¶çš„åŒ…ååŠ åç¼€ package exam_test åœ¨*_test.goæ–‡ä»¶ä¸­ï¼Œæœ‰ä¸‰ç§ç±»å‹çš„å‡½æ•°\næµ‹è¯•å‡½æ•° (Test) åŸºå‡†æµ‹è¯•å‡½æ•°ï¼ˆBenchï¼‰ ç¤ºä¾‹å‡½æ•° (Example) æµ‹è¯•å‡½æ•° ç”¨äºæµ‹è¯•ç¨‹åºçš„ä¸€äº›é€»è¾‘è¡Œä¸ºæ˜¯å¦æ­£ç¡®ï¼Œgo test å‘½ä»¤ä¼šè°ƒç”¨è¿™äº›æµ‹è¯•å‡½æ•°å¹¶æŠ¥å‘Šæµ‹è¯•ç»“æœã€‚\n1 2 3 import \u0026#34;testing\u0026#34; func TestFuncName(t *testing.T) { } å‚è€ƒä¸Šé¢çš„æ ¼å¼ï¼Œ ä»¥ Test ä¸ºå‡½æ•°åå‰ç¼€ï¼Œåé¢çš„FuncNameé¦–å­—æ¯å¿…é¡»å¤§å†™ï¼Œå‚æ•°ç±»å‹å¿…é¡»æ˜¯ *testing.Tã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 # æµ‹è¯•å…¨éƒ¨æ–‡ä»¶ go test -v # æµ‹è¯•å•ä¸ªæ–‡ä»¶ go test -v cal_test.go cal.go # æµ‹è¯•å•ä¸ªæ–¹æ³• go test -v \u0026lt;file_name.go\u0026gt; -run TestAddUpper # æµ‹è¯•ä»¥ French å’Œ Canal ä¸ºå‰ç¼€çš„å‡½æ•° go test -v -run=\u0026#34;French|Canal\u0026#34; # === RUN TestFrenchPalindrome # === RUN TestCanalPalindrome # æµ‹è¯•æ‰€æœ‰å­ç›®å½• go test -v ./... -v ç”¨äºæ‰“å°æ¯ä¸ªæµ‹è¯•å‡½æ•°çš„åå­—å’Œè¿è¡Œæ—¶é—´ -runå¯¹åº”ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œåªæœ‰æµ‹è¯•å‡½æ•°åè¢«å®ƒæ­£ç¡®åŒ¹é…çš„æµ‹è¯•å‡½æ•°æ‰ä¼šæ‰§è¡Œ -cover è¦†ç›–ç‡ -coverprofile ç”Ÿæˆè¦†ç›–è¯¦æƒ… 1 2 go test -coverprofile c.out go tool cover -html c.out [å‘½ä»¤è¡Œå·¥å…·å‚è€ƒå®˜ç½‘æ–‡æ¡£][https://pkg.go.dev/cmd/go]\nè¡¨æ ¼æµ‹è¯• å°†è¾“å…¥å’Œè¾“å‡ºå†™æˆè¡¨æ ¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func TestIsPalindrome(t *testing.T) { var tests = []struct { input string want bool }{ {\u0026#34;\u0026#34;, true}, {\u0026#34;a\u0026#34;, true}, {\u0026#34;aa\u0026#34;, true}, {\u0026#34;ab\u0026#34;, false}, {\u0026#34;kayak\u0026#34;, true}, {\u0026#34;detartrated\u0026#34;, true}, {\u0026#34;A man, a plan, a canal: Panama\u0026#34;, true}, {\u0026#34;Evil I did dwell; lewd did I live.\u0026#34;, true}, {\u0026#34;Able was I ere I saw Elba\u0026#34;, true}, {\u0026#34;Ã©tÃ©\u0026#34;, true}, {\u0026#34;Et se resservir, ivresse reste.\u0026#34;, true}, {\u0026#34;palindrome\u0026#34;, false}, // non-palindrome {\u0026#34;desserts\u0026#34;, false}, // semi-palindrome } for _, test := range tests { if got := IsPalindrome(test.input); got != test.want { t.Errorf(\u0026#34;IsPalindrome(%q) = %v\u0026#34;, test.input, got) } } } func IsPalindrome(str string) bool { // ... } æ¨¡æ‹Ÿ webserver åº”ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // mockServer æ¨¡æ‹ŸæœåŠ¡å™¨ func mockServer() *httptest.Server { var f http.HandlerFunc f = func(w http.ResponseWriter, r *http.Request) { w.WriteHeader(200) w.Header().Set(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;) fmt.Fprint(w, \u0026#34;welcome\u0026#34;) } return httptest.NewServer(f) } // TestNewRequest æ¨¡æ‹Ÿå‘èµ·è¯·æ±‚ func TestNewRequest(t *testing.T) { server := mockServer() defer server.Close() req := httptest.NewRequest(\u0026#34;GET\u0026#34;, server.URL, nil) w := httptest.NewRecorder() server.Config.Handler.ServeHTTP(w, req) require.EqualValues(t, w.Result().StatusCode, http.StatusOK) require.EqualValues(t, \u0026#34;welcome\u0026#34;, w.Body.String()) } ç¤ºä¾‹å‡½æ•° å±äºé€šè¿‡ godoc ç”Ÿæˆæ–‡æ¡£çš„ä¸€éƒ¨åˆ†ã€‚\nä»¥Exampleä¸ºå‡½æ•°åå‰ç¼€çš„å‡½æ•°ï¼Œæä¾›ä¸€ä¸ªç”±ç¼–è¯‘å™¨ä¿è¯æ­£ç¡®æ€§çš„ç¤ºä¾‹æ–‡æ¡£ã€‚å’Œæ™®é€šæµ‹è¯•çš„åŒºåˆ«ï¼Œç¤ºä¾‹å‡½æ•°æ²¡æœ‰å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ã€‚\nç¤ºä¾‹å‡½æ•°æœ‰ä¸‰ä¸ªç”¨å¤„ã€‚\nä½œä¸ºæ–‡æ¡£, æ ¹æ®ç¤ºä¾‹å‡½æ•°çš„åç¼€åéƒ¨åˆ†ï¼Œgodocè¿™ä¸ªwebæ–‡æ¡£æœåŠ¡å™¨ä¼šå°†ç¤ºä¾‹å‡½æ•°å…³è”åˆ°æŸä¸ªå…·ä½“å‡½æ•°æˆ–åŒ…æœ¬èº« åœ¨go testæ‰§è¡Œæµ‹è¯•çš„æ—¶å€™ä¹Ÿä¼šè¿è¡Œç¤ºä¾‹å‡½æ•°æµ‹è¯•ã€‚å¦‚æœç¤ºä¾‹å‡½æ•°å†…å«æœ‰ç±»ä¼¼ä¸Šé¢ä¾‹å­ä¸­çš„// Output:æ ¼å¼çš„æ³¨é‡Šï¼Œé‚£ä¹ˆæµ‹è¯•å·¥å…·ä¼šæ‰§è¡Œè¿™ä¸ªç¤ºä¾‹å‡½æ•°ï¼Œç„¶åæ£€æŸ¥ç¤ºä¾‹å‡½æ•°çš„æ ‡å‡†è¾“å‡ºä¸æ³¨é‡Šæ˜¯å¦åŒ¹é…ã€‚ æä¾›ä¸€ä¸ªçœŸå®çš„æ¼”ç»ƒåœº, åœ¨çº¿ç¼–è¾‘å’Œè¿è¡Œç¤ºä¾‹å‡½æ•° 1 2 3 4 5 6 7 func ExampleIsPalindrome() { fmt.Println(IsPalindrome(\u0026#34;A man, a plan, a canal: Panama\u0026#34;)) fmt.Println(IsPalindrome(\u0026#34;palindrome\u0026#34;)) // Output: // true // false } 1 2 # å®‰è£…æ–‡æ¡£ go get -u golang.org/x/tools/cmd/godoc å­æµ‹è¯•åŠå¹³è¡Œæ‰§è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func TestSubTest(t *testing.T) { data := []struct { name string result bool }{ {\u0026#34;123\u0026#34;, true}, {\u0026#34;246\u0026#34;, false}, } for _, v := range data { tf := func(t *testing.T) { t.Parallel() t.Log(v) } t.Run(v.name, tf) } } 1 2 # ä»…ä»…æƒ³æ‰§è¡Œåä¸º 246 çš„å­æµ‹è¯• go test -v -run SubTest/246 é»˜è®¤æƒ…å†µä¸‹ï¼Œgo test åœ¨ä¸åŒåŒ…ä¹‹é—´æ˜¯å¹¶è¡Œæ‰§è¡Œï¼Œåœ¨æ¯ä¸ªåŒ…å†…éƒ¨æ˜¯ä¸²è¡Œæ‰§è¡Œã€‚ä½¿ç”¨ t.Parallel()è®©å½“å‰å‡½æ•°å¼€å¯å¹¶è¡Œã€‚\nåŸºå‡†æµ‹è¯• fmt.Sprint å’Œ fmt.Sprintf å“ªä¸ªæ€§èƒ½æ›´ä½³å‘¢?\nä¸ºäº†ä¿è¯æµ‹è¯•ç»“æœå‡†ç¡®ï¼Œå¿…é¡»ä¿è¯ç”µè„‘æ²¡æœ‰æ‰§è¡Œå…¶å®ƒäº‹åŠ¡ã€‚å¦‚æœè¦æ‰§è¡Œé•¿æ—¶é—´çš„æµ‹è¯•ï¼Œä¸€å®šä¸è¦æ‰“å¼€æµè§ˆå™¨ä¸Šç½‘ï¼Œæˆ–å»çœ‹åœ¨çº¿è§†é¢‘ã€‚\nGo è¯­è¨€åš benchmark çš„æ—¶å€™ï¼Œä¼šè®©ç¼–è¯‘å™¨é‡æ–°ç¼–è¯‘ä»£ç ï¼Œç¼–è¯‘å™¨ä¼šæŠŠæ²¡æœ‰ç”¨å¤„çš„æ­»ä»£ç æ‹¿æ‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœç¼–è¯‘å™¨å‘ç°æŸä¸ªå‡½æ•°å¹¶æ²¡æœ‰ä¿®æ”¹ä»»ä½•å†…å®¹ï¼Œæˆ–è™½ç„¶è¿”å›äº†æŸä¸ªå€¼ï¼Œå´æ²¡æœ‰ä¿å­˜èµ·æ¥ï¼Œç¼–è¯‘å™¨å°±ä¼šè®¤è¯æ²¡å¿…è¦æµªè´¹æ—¶é—´å»è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå› ä¸ºå®ƒå¯¹ç¨‹åºçš„ç»“æœä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚\né€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ‰§è¡Œæµ‹è¯•ï¼Œ -runå¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™é‡Œå†™ none è¡¨ç¤ºä¸æ‰§è¡Œä»»ä½• Test å‡½æ•°ï¼Œä»…æ‰§è¡Œ benchmark å‡½æ•°ã€‚-bench æ ‡å¿—çš„æ­£åˆ™è¡¨è¾¾å¼å†™å‡º . è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ã€‚é€šè¿‡-benchtime è®¾ç½®æµ‹è¯•æ—¶é—´ä¸º 3 ç§’ã€‚\nbenchmark ä¹Ÿæœ‰å­æµ‹è¯•ï¼Œå­æµ‹è¯•çš„ä¸»è¦æ„ä¹‰å¹¶ä¸åœ¨äºå¹¶è¡Œï¼Œè€Œåœ¨äºå¯ä»¥æ›´åŠ ç»†è‡´åœ°æµ‹è¯„ã€‚\n1 2 # none æ²¡æœ‰ç‰¹æ®Šçš„æ„ä¹‰ï¼Œä»…ä»…ç”¨æ¥ç¡®ä¿æ²¡æœ‰ä»»ä½•å‡½æ•°ä¸å®ƒåŒ¹é… go test -run none -bench . -benchtime 3s -banchmem æµ‹è¯•ç»“æœå¤§æ¦‚é•¿è¿™æ ·ï¼Œåˆ†åˆ«è¡¨ç¤º\næµ‹è¯•å‡½æ•°å-CPU æ ¸å¿ƒæ•° æ‰§è¡Œæ¬¡æ•° æ‰§è¡Œæ—¶é—´(çº³ç§’)ï¼Œçœ‹å›¾ä¸­ï¼Œå°†å°æ•°ç‚¹å·¦ç§»6 ä½ï¼Œè¯¥æµ‹è¯•å¤§æ¦‚ 245 æ¯«ç§’ä¸€æ¬¡ å†…å­˜ åˆ†é…æ¬¡æ•° éªŒè¯æµ‹è¯„ç»“æœ æµ‹è¯„çš„ç»“æœï¼Œæ€»æ˜¯åº”è¯¥åœ¨è‡ªå·±æ‰€èƒ½ç†è§£çš„èŒƒå›´ä¹‹å†…ï¼Œå¦‚æœè·Ÿè‡ªå·±æƒ³çš„å·®å¤ªè¿œï¼Œé‚£ä¸€å®šè¦æŠŠå…¶ä¸­çš„é“ç†å¼„æ¸…æ¥šã€‚è¿™å¹¶ä¸æ„å‘³ç€ä»£ç å†™é”™äº†ï¼Œä½†è¿˜æ˜¯åº”è¯¥å°½é‡æƒ³åŠæ³•æ‹¿åˆ°å‡†ç¡®çš„æµ‹è¯„ç»“æœã€‚\næµ‹è¯•é©±åŠ¨å¼€å‘ æµ‹è¯•é©±åŠ¨å¼€å‘éœ€è¦ä½ åšä¸€äº›å°æ­¥éª¤ï¼Œæ¯ä¸€ä¸ªå®ç°éƒ½ä¼šæ„Ÿè§‰å¾®ä¸è¶³é“ã€‚çœŸæ­£çš„ä»·å€¼ä¸åœ¨äºæ­¥éª¤æœ¬èº«ï¼Œè€Œåœ¨äºæœ€ç»ˆäº§å“ï¼Œå³ä½¿åšäº†ä¸€ä¸ªå¾®ä¸è¶³é“çš„æ›´æ”¹ï¼Œè¿™è‚¯å®šä¼šèµ·ä½œç”¨ã€‚\nä¸‰ä¸ªæ­¥éª¤\nçº¢è‰²ï¼Œé€šå¸¸ç»ˆç«¯ä¼šçº¢è‰²æç¤ºé”™è¯¯ã€‚å…ˆç¼–å†™æµ‹è¯•ä»£ç ï¼Œç„¶åå®ç°ä¸šåŠ¡å‡½æ•°ï¼ŒæœŸé—´å¯èƒ½æ— æ³•é€šè¿‡æµ‹è¯•ã€‚ ç»¿è‰²ï¼Œé€šè¿‡ç»ˆç«¯ä¼šç»¿è‰²è¡¨ç¤ºæˆåŠŸã€‚å½“ä¸šåŠ¡å‡½æ•°é€šè¿‡æµ‹è¯•ä»£ç ã€‚ é‡æ„ï¼Œå†ä¸æ·»åŠ ä»»ä½•åŠŸèƒ½çš„æƒ…å†µä¸‹æ”¹è¿›å…¶ç»“æ„ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œæ‚¨çš„ä»£ç å°†å¾ˆå¿«é€€åŒ–ä¸ºç»è¿‡å……åˆ†æµ‹è¯•ä½†éš¾ä»¥ç†è§£çš„æ··ä¹±ã€‚ å¦‚ä½•åœ¨ä¸æ”¹å˜åŠŸèƒ½çš„æƒ…å†µä¸‹ä½¿è¿™æ®µä»£ç æ›´å¥½åœ°è¡¨è¾¾å…¶æ„å›¾ ( å¯ç†è§£æ€§ ) ï¼Ÿ è®¸å¤šé‡æ„ä¸ä»…æ¶‰åŠè¢«æµ‹ä»£ç ï¼Œè¿˜æ¶‰åŠæµ‹è¯•æœ¬èº«ã€‚æ‚¨éœ€è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´æ¥ä¿®å¤æµ‹è¯•è€Œä¸æ˜¯æ”¹è¿›ä»£ç ã€‚ å¦‚æœæ‚¨çš„è¢«æµ‹å•å…ƒæä¾›å¤šä¸ªåˆ†æ”¯ï¼Œåˆ™å€¼å¾—è€ƒè™‘æ‹†åˆ†æˆå¤šä¸ªå•å…ƒã€‚ go testå‘½ä»¤ä¼šéå†æ‰€æœ‰çš„*_test.goæ–‡ä»¶ä¸­ç¬¦åˆä¸Šè¿°å‘½åè§„åˆ™çš„å‡½æ•°ï¼Œç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„mainåŒ…ç”¨äºè°ƒç”¨ç›¸åº”çš„æµ‹è¯•å‡½æ•°ï¼Œæ¥ç€æ„å»ºå¹¶è¿è¡Œã€æŠ¥å‘Šæµ‹è¯•ç»“æœï¼Œæœ€åæ¸…ç†æµ‹è¯•ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶ã€‚\né¿å…è„†å¼±æµ‹è¯•ä»£ç çš„æ–¹æ³•æ˜¯åªæ£€æµ‹ä½ çœŸæ­£å…³å¿ƒçš„å±æ€§ã€‚ä¿æŒæµ‹è¯•ä»£ç çš„ç®€æ´å’Œå†…éƒ¨ç»“æ„çš„ç¨³å®šã€‚ç‰¹åˆ«æ˜¯å¯¹æ–­è¨€éƒ¨åˆ†è¦æœ‰æ‰€é€‰æ‹©ã€‚ä¸è¦å¯¹å­—ç¬¦ä¸²è¿›è¡Œå…¨å­—åŒ¹é…ï¼Œè€Œæ˜¯é’ˆå¯¹é‚£äº›åœ¨é¡¹ç›®çš„å‘å±•ä¸­æ˜¯æ¯”è¾ƒç¨³å®šä¸å˜çš„å­ä¸²ã€‚å¾ˆå¤šæ—¶å€™å€¼å¾—èŠ±åŠ›æ°”æ¥ç¼–å†™ä¸€ä¸ªä»å¤æ‚è¾“å‡ºä¸­æå–ç”¨äºæ–­è¨€çš„å¿…è¦ä¿¡æ¯çš„å‡½æ•°ï¼Œè™½ç„¶è¿™å¯èƒ½ä¼šå¸¦æ¥å¾ˆå¤šå‰æœŸçš„å·¥ä½œï¼Œä½†æ˜¯å®ƒå¯ä»¥å¸®åŠ©è¿…é€ŸåŠæ—¶ä¿®å¤å› ä¸ºé¡¹ç›®æ¼”åŒ–è€Œå¯¼è‡´çš„ä¸åˆé€»è¾‘çš„å¤±è´¥æµ‹è¯•ã€‚\n","date":"2021-11-25T15:00:00Z","permalink":"https://blog.golang.space/p/22.%E6%B5%8B%E8%AF%95/","title":"22.æµ‹è¯•"},{"content":"å…¬ç½‘éƒ¨ç½² K8s ç¯å¢ƒ\nä¸€å°è…¾è®¯äº‘è½»é‡åº”ç”¨æœåŠ¡å™¨ 2 æ ¸ 4G\nä¸€å°é˜¿é‡Œäº‘å…±äº«å‹æœåŠ¡å™¨ 1 æ ¸ 2G\nubuntu 18.04 ( CKA è®¤è¯ç¯å¢ƒçš„ç³»ç»Ÿ )\nè¶ç€åŒåäºŒæ´»åŠ¨ï¼ŒèŠ±äº† 74 å…¥æ‰‹è…¾è®¯äº‘è½»é‡åº”ç”¨æœåŠ¡å™¨ï¼Œç”¨äºæ­å»º k8s é›†ç¾¤ç¯å¢ƒ\nç¯å¢ƒå‡†å¤‡ 1 2 3 4 5 6 7 8 # æ°¸ä¹…å…³é—­äº¤æ¢åŒº sudo sed -i \u0026#39;s/.*swap.*/#\u0026amp;/\u0026#39; /etc/fstab # ä¿®æ”¹ä¸»æœºå # master èŠ‚ç‚¹æ‰§è¡Œ hostnamectl set-hostname master1 # node èŠ‚ç‚¹æ‰§è¡Œ hostnamectl set-hostname node1 å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡\n1 2 3 4 5 6 7 8 9 10 cat \u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/k8s.conf br_netfilter EOF cat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sudo sysctl --system å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¼€æ”¾ç›¸åº”ç«¯å£ï¼Œå¦‚æœä½¿ç”¨ flannel ç½‘ç»œæ’ä»¶ï¼Œéœ€è¦å¼€æ”¾ upd/8472 ç«¯å£\nå®‰è£…å·¥å…· å®‰è£… dockerï¼Œå›½å†…å»ºè®®è‡ªè¡Œä½¿ç”¨é•œåƒå®‰è£…ï¼Œä»¥ä¸‹ä¸ºdockerå®˜ç½‘æä¾›çš„å®‰è£…æ–¹å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 sudo apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg echo \\ \u0026#34;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \\ $(lsb_release -cs) stable\u0026#34; | sudo tee /etc/apt/sources.list.d/docker.list \u0026gt; /dev/null sudo apt-get update sudo apt-get install -f docker-ce docker-ce-cli containerd.io é…ç½® docker çš„ cgroupï¼Œè¦è·Ÿ kubelet ä½¿ç”¨çš„ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ kubelet è¿›ç¨‹ä¼šå¤±è´¥ã€‚\nsystemd æ˜¯ k8s é»˜è®¤é©±åŠ¨ã€‚\n1 2 3 4 5 6 7 cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt;EOF { \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], } EOF systemctl restart docker å®‰è£… kubeadm\nå›½å†…å®‰è£…\n1 2 3 4 5 6 7 8 9 10 11 12 cat \u0026lt;\u0026lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list deb http://mirrors.tuna.tsinghua.edu.cn/kubernetes/apt/ kubernetes-xenial main EOF sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys FEEA9169307EA071 sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 8B57C5C2836F4BEB sudo apt-get update # è‹¥é‡åˆ°ç§˜é’¥é—®é¢˜ï¼Œå‚è€ƒ https://www.cnblogs.com/reatual/p/14304675.html sudo apt-get install -y kubelet kubeadm kubectl systemctl enable --now kubelet ä¸º ip é…ç½®åˆ«å\n1 2 3 #echo \u0026#34;${ip} ${ä¸»æœºå}\u0026#34; \u0026gt;\u0026gt; /etc/hosts echo \u0026#34;${master1_ip} master1\u0026#34; \u0026gt;\u0026gt; /etc/hosts echo \u0026#34;${node1_ip} master2\u0026#34; \u0026gt;\u0026gt; /etc/hosts æå‰æ‹‰å–é•œåƒï¼Œé¿å…åœ¨åˆå§‹åŒ–æ—¶è¿‡ä¹…ç­‰å¾…\n1 kubeadm config images pull --image-repository=registry.aliyuncs.com/google_containers åˆ›å»ºè™šæ‹Ÿç½‘å¡\n1 sudo apt install ifupdown ä¸´æ—¶ç”Ÿæ•ˆ\n1 2 # sudo ifconfig eth0:1 ${å…¬ç½‘ IP} sudo ifconfig eth0:1 44.44.44.44 æ°¸ä¹…ç”Ÿæ•ˆ\n1 2 3 4 5 6 7 8 9 cat \u0026lt;\u0026lt;EOF | sudo tee /etc/network/interfaces auto eth0:1 iface eth0:1 inet static # address ${å…¬ç½‘ IP} address 44.44.44.44 netmask 255.255.255.0 EOF 150.158.141.120 1 sudo /etc/init.d/networking restart ä¿®æ”¹ kubelet å¯åŠ¨å‚æ•°\næ·»åŠ  kubelet çš„å¯åŠ¨å‚æ•°--node-ip=å…¬ç½‘IPï¼Œ æ¯ä¸ªä¸»æœºéƒ½è¦æ·»åŠ å¹¶æŒ‡å®šå¯¹åº”çš„å…¬ç½‘ ip\n1 sudo vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf master åˆå§‹åŒ–ï¼Œå¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œå¯ä»¥é‡ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 kubeadm init \\ --kubernetes-version v1.27.3 \\ --apiserver-advertise-address=192.168.0.58 \\ --image-repository=registry.aliyuncs.com/google_containers \\ --service-cidr=10.96.0.0/16 \\ --pod-network-cidr=10.244.0.0/16 # é‡ç½® kubeadm reset -f rm -rf /etc/cni/net.d rm -rf $HOME/.kube 1 2 3 4 5 6 7 8 9 10 # å½“ä½ çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯æ—¶ï¼Œåˆå§‹åŒ–æˆåŠŸ Your Kubernetes control-plane has initialized successfully! ... # æŒ‰æç¤ºï¼Œæ‰§è¡Œä»¥ä¸‹ä¸‰è¡Œ mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config ... # ç”¨äº worker èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ kubeadm join master1:6443 --token zqmjvh.5wij6n8j......... ä¿®æ”¹ kube-apiserver å‚æ•°\n- --bind-address=0.0.0.0\n1 sudo vi /etc/kubernetes/manifests/kube-apiserver.yaml å®‰è£… flannel ç½‘ç»œ ä¸‹è½½ flannel çš„ çš„ yaml é…ç½®æ–‡ä»¶\n1 wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml ä¿®æ”¹é…ç½®æ–‡ä»¶\n1 vim kube-flannel.yml åœ¨ 200 è¡Œå·¦å³\n1 2 3 4 5 6 7 8 9 args: - --public-ip=$(PUBLIC_IP) - --iface=eth0 env: - name: PUBLIC_IP valueFrom: fieldRef: fieldPath: status.podIP å¼€å§‹å®‰è£…ç½‘ç»œæ’ä»¶\n1 kubectl apply -f kube-flannel.yml K8s å¯ç”¨ ipvs å®‰è£…å·¥å…·ï¼Œæ–¹ä¾¿æ£€æŸ¥é…ç½®\n1 sudo apt-get install ipvsadm ubuntu æ°¸ä¹…å¯ç”¨ ipvs æ¨¡å—\n1 ls /lib/modules/$(uname -r)/kernel/net/netfilter/ipvs|grep -o \u0026#34;^[^.]*\u0026#34; \u0026gt;\u0026gt; /etc/modules ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ° modeï¼Œåé¢å‚æ•°ä¿®æ”¹ä¸º ipvs\n1 kubectl edit configmap kube-proxy -n kube-system åˆ é™¤æ‰€æœ‰çš„ kube-proxy çš„ podï¼Œå¹¶ç­‰å¾…è‡ªæ„ˆæ¢å¤\n1 $ kubectl delete pods `kubectl get pods -n kube-system | grep kube-proxy | awk \u0026#39;{print $1}\u0026#39;` -n kube-system é€šè¿‡ kubectl logs æ¥æŸ¥çœ‹å¯ç”¨ ipvs çš„æ—¥å¿—ï¼Œæ£€æŸ¥æ˜¯å¦æ­£å¸¸å¯ç”¨\nworker èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ å¦‚æœ token è¿‡æœŸï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ–°çš„åŠ å…¥å‘½ä»¤\n1 kubeadm token create --print-join-command åœ¨ worker èŠ‚ç‚¹æ‰§è¡Œï¼Œç­‰å¾…æ‰§è¡Œç»“æŸ\n1 kubeadm join........ åœ¨ master èŠ‚ç‚¹æ£€æŸ¥\n1 kubectl get nodes éƒ¨ç½² nginx æµ‹è¯• 1 vim nginx.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment spec: selector: matchLabels: app: nginx replicas: 2 # tells deployment to run 2 pods matching the template template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.21.4 ports: - containerPort: 80 1 kubectl apply -f nginx.yaml å¼€å¯æœåŠ¡\n1 vim nginx-svc.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: v1 kind: Service metadata: name: nginx-service spec: selector: app: nginx ports: - protocol: TCP port: 80 targetPort: 80 nodePort: 30080 type: NodePort 1 kubectl apply -f nginx-svc.yaml è®¿é—®ä»»æ„èŠ‚ç‚¹å…¬ç½‘ IP:30080ï¼ŒæŸ¥çœ‹æ˜¯å¦èƒ½å¤Ÿè¯·æ±‚åˆ° nginx ä¸»é¡µ\néƒ¨ç½² dashboard å›½å†…å¯èƒ½æ— æ³•è®¿é—®æ­¤é“¾æ¥\n1 wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml 1 kubectl apply -f recommended.yaml è®¾ç½®è®¿é—®ç«¯å£\n1 kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard æŸ¥çœ‹ç«¯å£\n1 kubectl get svc -A |grep kubernetes-dashboard å‚è€ƒ k8s å®˜æ–¹å®‰è£…æ–‡æ¡£\nå…¬ç½‘ç¯å¢ƒæ­å»º k8s é›†ç¾¤\nflannel\n","date":"2021-11-05T15:00:00Z","permalink":"https://blog.golang.space/p/%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2-k8s/","title":"å…¬ç½‘éƒ¨ç½² k8s"},{"content":"ä¿è¯æ¥å£æ•°æ®å®‰å…¨çš„æ–¹æ¡ˆ æ•°æ®åŠ å¯†ï¼Œé˜²æ­¢æ˜æ–‡ä¼ è¾“ ä¸éœ€è¦è§£å¯†ï¼Œåªéœ€è¦éªŒè¯æ˜¯å¦ç›¸åŒçš„\næ¯”å¦‚ç™»å½•æ—¶çš„å¯†ç ï¼Œå¯ä»¥åœ¨å‰ç«¯ç¼–ç æˆ MD5 ä¼ è¾“ã€‚MD5å…·æœ‰ä¸å¯é€†çš„æ€§è´¨ï¼Œéå¸¸é€‚åˆç”¨æ¥å­˜å‚¨è¿™äº›ã€‚\nä¸ºäº†é˜²æ­¢æ•°æ®åº“æ³„éœ²æš´éœ² MD5 å¯†ç ï¼Œæˆ–è€…å¸Œæœ›æ›´å®‰å…¨ï¼Œå¯ä»¥å¯¹ MD5 åŠ ç›ã€‚\næ¯”å¦‚ MD5( password + salt )ï¼Œsalt å¯ä»¥æ˜¯æ¯ä¸ªç”¨æˆ·å”¯ä¸€çš„ï¼Œé˜²æ­¢å¦‚æœæŸä¸ªç”¨æˆ·çš„å¯†ç è¢«ç©·ä¸¾ç ´è§£å‡ºæ¥äº†ï¼Œä¸èƒ½ä½¿ç”¨ç°æœ‰çš„æˆæœæ¥ç±»æ¨å…¶å®ƒç”¨æˆ·çš„å¯†ç ã€‚\néœ€è¦è§£å¯†ï¼Œä½¿ç”¨åŸæ¥çš„å‚æ•°\nä½¿ç”¨ AES å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œè¿™ä¸ªéœ€è¦æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å­˜å‚¨ç§˜é’¥ï¼Œå¦‚æœä¸ç”¨æš´éœ²å®¢æˆ·ç«¯ï¼Œè¿™ç§æ–¹æ¡ˆå¾ˆåˆé€‚ã€‚\nä½¿ç”¨ RSA éå¯¹ç§°åŠ å¯†ï¼Œä¼šç”Ÿæˆç§é’¥å’Œå…¬é’¥ã€‚\næ•°æ®åŠ ç­¾éªŒç­¾ åŠ ç­¾\nå®ƒå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«ç¯¡æ”¹ã€‚\nä½¿ç”¨ MD5/ShA-256 å¯¹åŸå§‹è¯·æ±‚æŠ¥æ–‡ç”Ÿæˆæ‘˜è¦ï¼Œä½¿ç”¨ç§é’¥å¯¹æ‘˜è¦åŠ å¯†ï¼Œå°±å¾—åˆ°äº†æŠ¥æ–‡å¯¹åº”çš„æ•°å­—ç­¾åã€‚\nå°† æŠ¥æ–‡åŸæ–‡å’Œç­¾å ä¸€èµ·å‘åˆ°æ¥æ”¶æ–¹ã€‚\néªŒç­¾\næ¥æ”¶æ–¹å¯¹åŸå§‹æ•°æ®ä»¥ç›¸åŒæ–¹æ³•å¤„ç†ï¼Œå¾—åˆ°æ‘˜è¦ï¼Œä½¿ç”¨å¯¹æ–¹æä¾›çš„å…¬é’¥å¯¹æ•°å­—ç­¾åè§£å¯†ï¼Œåˆ¤æ–­ä¸¤ä¸ªæ‘˜è¦æ˜¯å¦ç›¸åŒã€‚å°±å¯ä»¥å¾—çŸ¥æŠ¥æ–‡æœ‰æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ã€‚\ntoken æˆæƒè®¤è¯ éç™»å½•æ¥å£å¦‚ä½•è¯†åˆ«ç”¨æˆ·çš„èº«ä»½?\nå¯ä»¥åœ¨ç”¨æˆ·åå¯†ç ç™»å½•æ¥å£ä¸­è¿”å›å”¯ä¸€ tokenã€‚è¯·æ±‚å…¶å®ƒéœ€è¦æƒé™çš„æ¥å£å¿…é¡»å¸¦ä¸Šæ­¤ tokenï¼ŒæœåŠ¡ç«¯è§£æ token éªŒè¯èº«ä»½ï¼Œå¹¶æ£€æŸ¥ token æ˜¯å¦ è¿‡æœŸã€‚\næ­¤æ–¹å¼ä¹Ÿå¯ç”¨äºå”¯ä¸€è®¾å¤‡ç™»å½•ï¼Œæ¯ä¸ªç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•ç”Ÿæˆçš„ token è®°å½•åˆ° redis ç¼“å­˜ä¸­ï¼Œæ¯æ¬¡ç™»é™†éƒ½ä¼šè¦†ç›–æ‰æ—§çš„ã€‚æ¥å£è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯éªŒè¯å…¶ token æ˜¯å¦ä¸æœåŠ¡ç«¯çš„ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œå°±æç¤ºç”¨æˆ·é‡æ–°ç™»å½•ã€‚\nå¦å¤–å…³äºèº«ä»½éªŒè¯é”™è¯¯çš„çŠ¶æ€ç å‚è€ƒç½‘å€\ntoken ä¸å­˜åœ¨æˆ–è§£æå¤±è´¥ï¼Œtoken è¿‡æœŸç­‰è¿”å› 401 é”™è¯¯\ntoken éªŒè¯é€šè¿‡ï¼Œä½†å¯¹èµ„æºæ²¡æœ‰è®¿é—®çš„æƒé™ï¼Œè¿”å› 403 é”™è¯¯\næ—¶é—´æˆ³ timestamp è¶…æ—¶ æœ‰äº›æ”»å‡»è€…ï¼Œä¸å…³å¿ƒçœŸå®çš„æ•°æ®ï¼Œè€Œæ˜¯æŠ“åŒ…åè¿›è¡Œæ¶æ„è¯·æ±‚ï¼Œå¦‚ DOS æ”»å‡»ã€‚\nå¯ä»¥å¼•å…¥æ—¶é—´æˆ³ ï¼Œæ¥ä¿è¯æ¥å£å®‰å…¨ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚éƒ½å¸¦ä¸Šå½“å‰æ—¶é—´ï¼Œæ±‚æœåŠ¡ç«¯æ—¶é—´ä¸è¯·æ±‚æ—¶é—´çš„æ—¶é—´å·®ï¼Œå¤§äºä¸€å®šæ—¶é—´å¦‚ 2 åˆ†é’Ÿï¼Œåˆ™è®¤ä¸ºè¯·æ±‚æ— æ•ˆã€‚\nåªåŠ æ—¶é—´ï¼Œå¾ˆå®¹æ˜“ç ´è§£ï¼Œæ— éæ¯æ¬¡è¯·æ±‚æ—¶æ›´æ–°ä¸€ä¸‹æ—¶é—´ï¼Œå¯ä»¥åœ¨æ—¶é—´æˆ³çš„åŸºç¡€ä¸Šï¼Œä¸ã€Œæ•°æ®åŠ ç­¾éªŒç­¾ã€ç»“åˆã€‚\ntimestamp+nonce é˜²æ­¢é‡æ”¾æ”»å‡» nonce æŒ‡å”¯ä¸€çš„éšæœºå­—ç¬¦ä¸²ï¼Œåœ¨å®¢æˆ·ç«¯ç»´æŠ¤ä¸€ä¸ªéšæœºå­—ç¬¦ä¸² setï¼Œæ¯æ¬¡è¯·æ±‚ä½¿ç”¨ timestamp+nonceï¼Œnonce ä¸èƒ½é‡å¤ã€‚\næœåŠ¡ç«¯ä¹Ÿç»´æŠ¤ä¸€ä¸ªç›¸åŒçš„ setï¼Œå¦‚æœå‘ç°é‡å¤çš„ nonce å°±æ˜¯é‡å¤è¯·æ±‚ã€‚ å› ä¸ºæœ‰ timestamp ä»…æ¥æ”¶ 2åˆ†é’Ÿå†…çš„è¯·æ±‚ï¼Œæ‰€ä»¥æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¯ä»¥éƒ½åªç»´æŠ¤ 2åˆ†é’Ÿå†…çš„ nonce ï¼Œä»¥èŠ‚çœå†…å­˜ã€‚\né™æµ å¯ä»¥ä»ä»¥ä¸‹æ–¹é¢è€ƒè™‘\næ¯åˆ†é’Ÿå¯ä»¥æ¥æ”¶å¤šå°‘æ¬¡è¯·æ±‚ æœåŠ¡ç«¯æœ€å¤§èƒ½åŒæ—¶å¤„ç†å¤šå°‘è¯·æ±‚ æ¯ä¸ª IPï¼Œ 1 åˆ†é’Ÿå†…æœ€å¤šè¯·æ±‚æ¬¡æ•° é»‘åå• å¯¹äºé»‘åå•çš„ IPï¼Œè¿”å›é”™è¯¯ç \nå»ºè®®é»‘åå•åŠ ä¸Šæ—¶é—´é™åˆ¶ï¼Œå¯¹äºæ˜çŸ¥æ˜¯æ¶æ„çš„æ”»å‡»ï¼Œå¤šé•¿æ—¶é—´éƒ½å¯ä»¥\nå¯¹äºä¸ç¡®å®šï¼Œæ¨¡æ£±ä¸¤å¯ï¼Œæˆ–åªæ˜¯å°å°çš„è­¦å‘Šæƒ©ç½šï¼Œå¯ä»¥è®¾å®šæœ‰é™çš„æ—¶é—´ã€‚\nç™½åå• ä»…å…è®¸ç™½åå•å†…çš„ IP è®¿é—®\nå‚æ•°åˆæ³•æ€§æ•ˆéªŒ å¦‚æ‰‹æœºå·å’Œèº«ä»½è¯æ£€æµ‹é•¿åº¦ç­‰æ˜¯å¦åˆæ³•ã€‚\næšä¸¾å‚æ•°æ˜¯å¦åˆæ³•ã€‚\n","date":"2021-10-22T00:00:00Z","permalink":"https://blog.golang.space/p/%E4%BF%9D%E8%AF%81%E6%8E%A5%E5%8F%A3%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E7%9A%84%E6%96%B9%E6%A1%88/","title":"ä¿è¯æ¥å£æ•°æ®å®‰å…¨çš„æ–¹æ¡ˆ"},{"content":"é€šé“æ¨¡å¼ ä¸èƒ½ä»…é€šè¿‡å¢åŠ ç¼“å­˜åŒºæ¥æå‡æ€§èƒ½ï¼Œä¸è¦è®¤ä¸ºæŠŠç¼“å†²åŒºè®¾ç½®çš„éå¸¸å¤§å°±å¯ä»¥è§£å†³æ€§èƒ½é—®é¢˜ã€‚åº”è¯¥å°†ç¼“å†²åŒºå°½é‡è®¾ç½®çš„å°ä¸€äº›ï¼Œå°½é‡æŠŠå»¶è¿Ÿé™ä½ã€‚\nç¼“å†²åŒºå¤§å°ä¸èƒ½èƒ¡ä¹±è®¾ç½®æˆ 10000ï¼Œç¼“å†²åŒºä¸ä¸€å®šèƒ½å¤Ÿæå‡æ€§èƒ½!!ä¸è¦æŒ‡æœ›ç¼“å†²åŒºå¤§å°æ¥æå‡ç¨‹åºæ€§èƒ½ï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯é™ä½å‘é€ä¸æ¥æ”¶æ“ä½œå¯èƒ½äº§ç”Ÿçš„å»¶è¿Ÿï¼Œ\noption open close send ok no recive ok ok é¢å¯¹å¹¶å‘ä»£ç æ—¶ï¼Œå‡­å€Ÿæ‰“å°è¯­å¥ï¼Œæ²¡åŠæ³•åˆ¤æ–­å“ªä¸ªå‘ç”Ÿåœ¨å‰ã€‚å› ä¸ºæ‰“å°ä¸æ˜¯åŸå­æ“ä½œã€‚\né€šé“æ¨¡å¼ waitForTask - ä¸‰ä¸ªåŸºæœ¬æ¨¡å¼ä¹‹ä¸€ ç»ç†æŒ‡æ´¾ä»»åŠ¡ç»™å‘˜å·¥ï¼Œç»ç†å»åšåˆ«çš„äº‹æƒ…ï¼ŒåŒæ—¶éšæ—¶å¯ä»¥å«åœæˆ–ä¿®æ­£å‘˜å·¥çš„ä»»åŠ¡ã€‚\nå¯ä»¥å®ç° Pooling æ¨¡å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func waitForTask() { ch := make(chan string) go func() { p := \u0026lt;-ch fmt.Println(\u0026#34;recv\u0026#39;d signal : \u0026#34;, p) }() time.Sleep(500 * time.Millisecond) ch \u0026lt;- \u0026#34;paper\u0026#34; fmt.Println(\u0026#34;manager : sent signal\u0026#34;) time.Sleep(time.Second) fmt.Println(\u0026#34;-------------end-------------\u0026#34;) } waitForResult - ä¸‰ä¸ªåŸºæœ¬æ¨¡å¼ä¹‹ä¸€ ç»ç†ç­‰å¾…å‘˜å·¥å®Œæˆä»–çš„å·¥ä½œä»»åŠ¡ï¼Œå†ç»§ç»­å¾€ä¸‹èµ°ã€‚\nå¯ä»¥å®ç° Drop æ¨¡å¼å’Œ FanOut æ¨¡å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 func waitForResult() { ch := make(chan string) go func() { time.Sleep(500 * time.Millisecond) ch \u0026lt;- \u0026#34;paper\u0026#34; fmt.Println(\u0026#34;employee : sned signal\u0026#34;) }() p := \u0026lt;-ch fmt.Println(\u0026#34;manage : recv\u0026#39;d signal : \u0026#34;, p) time.Sleep(1 * time.Second) fmt.Println(\u0026#34;-------------end-------------\u0026#34;) } waitForFinished - ä¸‰ä¸ªåŸºæœ¬æ¨¡å¼ä¹‹ä¸€ å…¶å®ç”¨ waitGroup æ›´å¥½ï¼Œé€šè¿‡å®ƒå¯¹ goroutine ç¼–ç»„ä¼šæ›´åŠ æ¸…æ™°ã€‚\nç»ç†è¯·å‘˜å·¥åšäº‹ï¼Œå‘˜å·¥å·²ç»çŸ¥é“è‡ªå·±çš„ä»»åŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func waitForFinished() { ch := make(chan struct{}) go func() { time.Sleep(500 * time.Millisecond) close(ch) fmt.Println(\u0026#34;employee : sned signal\u0026#34;) }() _, ok := \u0026lt;-ch fmt.Println(\u0026#34;manage : recv\u0026#39;d signal : \u0026#34;, ok) time.Sleep(1 * time.Second) fmt.Println(\u0026#34;-------------end-------------\u0026#34;) } Pooling æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func pooling() { ch := make(chan string) const emps = 2 for i := 0; i \u0026lt; emps; i++ { go func(emp int) { for p := range ch { fmt.Printf(\u0026#34;employee %d : recv\u0026#39;d signal : %s\\n\u0026#34;, emp, p) } fmt.Printf(\u0026#34;employee %d : recv\u0026#39;d signal\\n\u0026#34;, emp) }(i) } const work = 10 for i := 0; i \u0026lt; work; i++ { ch \u0026lt;- \u0026#34;paper\u0026#34; + strconv.Itoa(i) fmt.Println(\u0026#34;manager : sent signal : \u0026#34;, i) } close(ch) fmt.Println(\u0026#34;manage : recv\u0026#39;d signal end \u0026#34;) time.Sleep(1 * time.Second) fmt.Println(\u0026#34;-------------end-------------\u0026#34;) } Fan out æ¨¡å¼ å¾ˆå±é™©ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºä¸­çš„ goroutine è¿…é€Ÿå¢é•¿\nå¯¹äºéš”ä¸€æ®µæ—¶é—´æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡ï¼Œå’Œå‘½ä»¤è¡Œå·¥å…·æ¥è¯´ï¼Œè¿™ç§æ¨¡å¼å¾ˆåˆé€‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // å…è®¸ä»»æ„æ•°é‡çš„ goroutine æ‰§è¡Œ func fanOut() { emps := 20 ch := make(chan string, emps) for i := 0; i \u0026lt; emps; i++ { go func(i int) { time.Sleep(200 * time.Millisecond) ch \u0026lt;- \u0026#34;paper\u0026#34; + strconv.Itoa(i) fmt.Println(\u0026#34;manager : sent signal : \u0026#34;, i) }(i) } for emps \u0026gt; 0 { p := \u0026lt;-ch fmt.Println(p) fmt.Println(\u0026#34;manage : recv\u0026#39;d signal : \u0026#34;, emps) emps-- } time.Sleep(2 * time.Second) fmt.Println(\u0026#34;-------------end-------------\u0026#34;) } fanoutSemaphore æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // é™åˆ¶åŒæ—¶æ‰§è¡Œçš„ goroutine æ•°é‡ func fanoutSemaphore() { emps := 20 ch := make(chan string, emps) const cap = 5 sem := make(chan struct{}, cap) for i := 0; i \u0026lt; emps; i++ { go func(i int) { sem \u0026lt;- struct{}{} { time.Sleep(200 * time.Millisecond) ch \u0026lt;- \u0026#34;paper\u0026#34; + strconv.Itoa(i) fmt.Println(\u0026#34;manager : sent signal : \u0026#34;, i) } \u0026lt;-sem }(i) } for emps \u0026gt; 0 { p := \u0026lt;-ch fmt.Println(p) fmt.Println(\u0026#34;manage : recv\u0026#39;d signal : \u0026#34;, emps) emps-- } } drop æ¨¡å¼ drop å°½å¿«å‘ç°æœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œå¹¶ä¸”é˜²æ­¢æ¶åŒ– æŠ½è±¡ç‚¹å°±æ˜¯å¾€æ°´æ¯æ³¨æ°´ï¼Œæ»¡äº†åï¼Œå°±è®©åæ¥çš„æ°´æº¢å‡ºå» è¿™ä¸ªæ¨¡å¼å¯ä»¥ç”¨æ¥æµ‹è¯•æ€§èƒ½çš„ç“¶é¢ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func drop() { const cap = 5 ch := make(chan string, cap) go func() { for p := range ch { fmt.Println(\u0026#34;employee : recv\u0026#39;d signal : \u0026#34;, p) } }() const work = 20 for i := 0; i \u0026lt; work; i++ { select { case ch \u0026lt;- \u0026#34;paper\u0026#34;: fmt.Println(\u0026#34;manager : sent signal : \u0026#34;, i) default: fmt.Println(\u0026#34;manager : dropped data : \u0026#34;, i) } } close(ch) fmt.Println(\u0026#34;manager sent shutdown signal\u0026#34;) } cancellation æ¨¡å¼ è¶…æ—¶æœºåˆ¶ï¼Œå¦‚æœæœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œåº”è¯¥ä½¿ç”¨ context åŒ…æ¥å®Œæˆã€‚\næ³¨æ„ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­è¦ä½¿ç”¨ æœ‰ç¼“å†²é€šé“ å¦åˆ™æœ‰å¯èƒ½ä¼šæ³„éœ²ï¼Œå‡è®¾ç°åœ¨ä½¿ç”¨æ— ç¼“å†²é€šé“ï¼Œè€Œä»»åŠ¡è¶…æ—¶ï¼Œä¸»ä»»åŠ¡ç»“æŸã€‚ è€Œå­ä»»åŠ¡è¿˜å¡åœ¨é‚£ï¼Œç­‰å¾… channel å‘é€è¿‡å»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func cancellation() { ch := make(chan string, 1) go func() { time.Sleep(time.Duration(rand.Intn(150)) * time.Millisecond) ch \u0026lt;- \u0026#34;paper\u0026#34; fmt.Println(\u0026#34;manager : sent signal \u0026#34;) }() tc := time.After(100 * time.Millisecond) select { case p := \u0026lt;-ch: fmt.Println(\u0026#34;manage : recv\u0026#39;d signal : \u0026#34;, p) case t := \u0026lt;-tc: fmt.Println(\u0026#34;manager : timedout :\u0026#34;, t) } time.Sleep(1 * time.Second) fmt.Println(\u0026#34;-------------end-------------\u0026#34;) } ä»£ç æ¡ˆä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // åŒæ—¶æœ€å¤šè¿è¡Œ 3 ä¸ª goroutine // éœ€è¦å¯åŠ¨å¤§é‡ goroutine æ‰§è¡Œä»»åŠ¡ func m(){ data := make([]int,50) // å‡è®¾è¦å¤„ç†çš„æ•°æ® ch := make(chan struct{},3) var wg sync.Wait for i:=0; i\u0026lt;len(data); i++{ wg.Add(1) ch \u0026lt;- struct{}{} go func(){ \u0026lt;- ch defer wg.Done() }() // ... } wg.Wait() close(ch) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // åŒæ—¶æœ€å¤šè¿è¡Œ 3 ä¸ª goroutine // ä»…ç”¨ 3 ä¸ªæ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¸éœ€è¦åˆ›å»ºæ›´å¤š goroutine func m(){ data := make([]int,50) // å‡è®¾è¦å¤„ç†çš„æ•°æ® ch := make(chan int,len(data)) for _, v:= range data{ ch \u0026lt;- v } close(ch) var wg sync.Wait for i:=0; i\u0026lt;3; i++{ go func(){ defer wg.Done() for v := ch { } }() } wg.Wait() } ","date":"2021-09-21T00:00:00Z","permalink":"https://blog.golang.space/p/channels-%E6%A8%A1%E5%BC%8F/","title":"Channels æ¨¡å¼"},{"content":"æ ˆå¸§ GMP ä¸­çš„ G å’Œ M éå¸¸åƒï¼Œä¹Ÿæœ‰ä¸€ä¸ªå†…å­˜æ ˆã€‚( M çš„å†…å­˜æ ˆæ˜¯æ“ä½œç³»ç»Ÿå±‚é¢çš„ï¼Œå¤§å°æ˜¯ 1M )\nä¸€ä¸ª G çš„æ ˆå¤§å°æ˜¯ 2KBï¼Œgoroutine è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œå®ƒä¼šä»æ ˆä¸­å–å‡ºä¸€äº›å†…å­˜ï¼Œæˆ‘ä»¬ç§°ä¸ºæ ˆå¸§å†…å­˜ã€‚\n1 2 3 4 5 6 7 8 9 10 func main{ a := 10 incr(a) fmt.Println(a) } func incr(i int) int { i++ return i } goroutine åªå¯¹å®ƒæ‰€æ“ä½œçš„æ ˆå¸§çš„å†…å­˜æœ‰ç›´æ¥çš„è®¿é—®æƒï¼Œæ„å‘³è€…æ‰€æœ‰çš„æ•°æ®éƒ½å¿…é¡»åœ¨è¿™é‡Œï¼Œæ¯”å¦‚å£°æ˜ä¸€ä¸ª int ç±»å‹çš„å˜é‡ï¼Œä¼šæœ‰ 4 ä¸ªå­—èŠ‚çš„å†…å­˜å°±åœ¨è¿™ä¸ªæ ˆå¸§å†…ã€‚å®ƒå¿…é¡»åœ¨è¿™ä¸ªæ ˆå¸§å†…ï¼Œå¦åˆ™ goroutine å°±ä¸èƒ½è®¿é—®å®ƒã€‚è¿™ä¸ªæ ˆå¸§ä¸€ä¸ªéå¸¸é‡è¦çš„ç›®çš„ï¼Œå®ƒåœ¨åˆ›é€ ä¸€ä¸ªæ²™ç›’ï¼Œä¸€ä¸ªéš”ç¦»å±‚ã€‚\nå‚è€ƒä¸Šé¢çš„ä»£ç è¿›è¡Œä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œæˆ‘æƒ³è®©ä½ æƒ³åˆ°çš„æ˜¯ï¼Œæ¯å½“è¿›è¡Œä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼ŒçœŸæ­£åœ¨åšçš„æ˜¯è·¨åŸŸäº†ä¸€ä¸ªç¨‹åºè¾¹ç•Œã€‚è·¨åŸŸè¿™ä¸ªç¨‹åºè¾¹ç•Œï¼Œæ„å‘³ç€å°†ç¦»å¼€å½“å‰çš„æ ˆå¸§å¹¶è¿›å…¥ä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ–°çš„æ ˆå¸§å†…è·å–æ•°æ®ï¼Œå¦‚ä¸Šé¢ç¨‹åºå°†å˜é‡ a çš„å€¼ä¼ é€’ç»™ incr å‡½æ•°ï¼Œå› ä¸º Go ä¸­çš„ä¸€åˆ‡éƒ½æ˜¯é€šè¿‡å€¼ä¼ é€’ï¼Œæ‰€ä»¥è¦åœ¨æ•°æ®ç©¿è¿‡ç¨‹åºè¾¹ç•Œæ—¶å¤åˆ¶ä¸€ä¸ªæ•°æ®çš„å‰¯æœ¬ã€‚\nä½ ä¼šå¬åˆ°ä¸‰ä¸ªæœ¯è¯­\næ•°æ®ï¼Œè¿™æ˜¯æˆ‘ä»¬å·¥ä½œçš„å¯¹è±¡ï¼Œæ•°æ®åŒ…å«ä¸¤ç§ç±»å‹ å€¼ï¼Œæ¯”å¦‚å˜é‡ a çš„æ•´æ•°å€¼ 10 å€¼åœ°å€ï¼ŒæŒ‡é’ˆ åœ¨å‡½æ•° incr ä¸­åšå‡ºçš„æ”¹å˜ï¼Œå¹¶æ²¡æœ‰å½±å“åˆ° main å‡½æ•°çš„å˜é‡ aï¼Œè¿™æ˜¯å‡½æ•°çš„éš”ç¦»æ€§ã€‚\nä¼˜ç‚¹æ˜¯ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œå˜é‡åœ¨\u0026quot;\u0026ldquo;æ²™ç›’\u0026quot;ä¸­æ”¹å˜ï¼Œä¸å½±å“æ‰§è¡Œç¯å¢ƒä¹‹å¤–çš„ä»»ä½•ä¸œè¥¿ï¼Œè¿™éå¸¸é‡è¦!\nç¼ºç‚¹æ˜¯åœ¨ç¨‹åºä¸­æœ‰å¤šä¸ªæ•°æ®å‰¯æœ¬ï¼Œå€¼ä¼ é€’æ˜¯æ²¡æœ‰æ•ˆç‡çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»£ç æ›´åŠ å¤æ‚ï¼Œç”šè‡³æ€§èƒ½é—®é¢˜ã€‚\n1 2 3 4 5 incr(\u0026amp;a) func incr(a *int) { // ... } è®°ä½è¿™å¥è¯ï¼Œåœ¨ Go ä¸­ä¸€åˆ‡éƒ½æ˜¯å€¼ä¼ é€’ã€‚æœ‰äººè¯´ä¸Šé¢çš„ä»£ç æ˜¯å¼•ç”¨ä¼ é€’ï¼Œå…¶å®ä¸æ˜¯çš„ã€‚\næŒ‰å€¼ä¼ é€’æ„å‘³ç€è·¨åŸŸç¨‹åºè¾¹ç•Œæ—¶ï¼Œä¼šå¯¹æ•°æ®è¿›è¡Œå¤åˆ¶ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨å¤åˆ¶å’Œä¼ é€’çš„æ•°æ®ï¼Œä¸æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªåœ°å€ã€‚ä¸ºäº†è®©ç¨‹åºèƒ½å¤Ÿè®¿é—®\u0026quot;æ²™ç›’\u0026quot;ä¹‹å¤–çš„ä¸œè¥¿ï¼Œå®ƒå¿…é¡»æ‰§è¡Œå¯¹åœ°å€çš„è¯»å–ã€‚goroutine åªæœ‰å¯¹æ ˆå¸§çš„ç›´æ¥å†…å­˜è®¿é—®ï¼Œå¦‚æœä½ æƒ³è®© goroutine èƒ½å¤Ÿè®¿é—®å…¶å®ƒå†…å­˜ï¼Œå¿…é¡»å°†è¯¥å†…å­˜ä½ç½®çš„åœ°å€åˆ†äº«ç»™å®ƒã€‚\nå¦‚æœå¤šä¸ª goroutine åŒæ—¶é€šè¿‡æŒ‡é’ˆå»è®¿é—®/ä¿®æ”¹å˜é‡ aï¼Œä¼šé€ æˆæ•°æ®ç«äº‰ã€‚å‡½æ•°å¼ç¼–ç¨‹è¯•å›¾é€šè¿‡å®Œå…¨ä¸ç»™ä½ æŒ‡é’ˆè¯­ä¹‰æ¥å‡å°‘å‰¯ä½œç”¨ï¼Œä½†æ˜¯å€¼è¯­ä¹‰çš„ä»£ä»·æ˜¯æ•°æ®çš„ä½æ•ˆç‡ã€‚åé¢æˆ‘ä»¬å°†è®¨è®ºä»€ä¹ˆæ—¶å€™ä½¿ç”¨æŒ‡é’ˆè¯­ä¹‰ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨å€¼è¯­ä¹‰ã€‚\nä¼˜ç‚¹æ˜¯è§£å†³äº†æ•ˆç‡é—®é¢˜ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥æ”¹å˜å®ƒã€‚ä»£ä»·æ˜¯å‰¯ä½œç”¨å’Œæ›´å¤šçš„å·¥ä½œ ï¼Œéœ€è¦ç¡®ä¿æˆ‘ä»¬æ²¡æœ‰ç ´åæ•°æ®ï¼Œæˆ–è€…äº‹æƒ…ä¸ä¼šåœ¨å¹•åè¢«æ”¹å˜ã€‚\næˆ‘ä»¬è¦å……åˆ†åˆ©ç”¨è¯­è¨€çš„å„ä¸ªæ–¹é¢ï¼Œæœ‰åŠ©äºå‡è½»å†…å­˜ç®¡ç†çš„è®¤çŸ¥è´Ÿæ‹…ã€‚\næ³¨æ„ : å½“ main å‡½æ•°è¿›è¡Œå¦ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ? å®ƒéœ€è¦å¦ä¸€ä¸ªæ ˆå¸§ï¼Œå®ƒä¼šæ¸…ç†æ‰æ´»åŠ¨å¸§ä»¥ä¸‹çš„å†…å­˜ï¼Œé‡å¤ä½¿ç”¨ã€‚\né€ƒé€¸ æˆ‘ä»¬é€šå¸¸ä¼šæœ‰ä¸€äº›å·¥å‚å‡½æ•°ï¼Œç”¨æ¥åˆ›å»ºç»“æ„ä½“å¯¹è±¡ã€‚æ³¨æ„ï¼Œåœ¨ Go ä¸­æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œå®ƒéšè—äº†æˆæœ¬ï¼Œæˆ‘ä»¬æ‰€æ‹¥æœ‰çš„æ˜¯æˆ‘ç§°ä¹‹ä¸ºå·¥å‚å‡½æ•°çš„ä¸œè¥¿ï¼Œå·¥å‚å‡½æ•°æ˜¯ä¸€ä¸ªå¯ä»¥åˆ›å»ºä¸€ä¸ªå€¼çš„å‡½æ•°ã€‚åˆå§‹åŒ–å®ƒï¼Œå¹¶è¿”å›ç»™è°ƒç”¨è€…ã€‚è¿™å¯¹äºå¯è¯»æ€§æ¥è¯´æ˜¯å¾ˆå¥½çš„ï¼Œå®ƒæ²¡æœ‰éšè—æˆæœ¬ã€‚æˆ‘ä»¬å¯ä»¥è¯»æ‡‚å®ƒï¼Œå¹¶ä¸”åœ¨ç»“æ„ä¸Šæœ‰åŠ©äºç®€åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func createUseV1() User { u := user{ name:\u0026#34;Bill\u0026#34;, } return u } func createUserV2() *User { u := user{ name:\u0026#34;Bill\u0026#34;, } return \u0026amp;u } åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„åˆ›å»ºç”¨æˆ·ï¼Œæ³¨æ„å®ƒä»¬çš„è¿”å›ç±»å‹ã€‚\ncreateUseV1 æ˜¯å€¼è¯­ä¹‰çš„ï¼Œå®ƒè¿”å›æ•°æ®çš„å‰¯æœ¬ï¼Œä¸ä¼šæœ‰ä»»ä½•å‰¯ä½œç”¨ã€‚\ncreateUserV2 æ˜¯æŒ‡é’ˆè¯­ä¹‰çš„ï¼Œè¿™æ¬¡ä¸æ˜¯åœ¨åˆ¶ä½œä¸€ä¸ªå€¼çš„å‰¯æœ¬ï¼Œè¦åšçš„æ˜¯æ‹·è´å€¼çš„åœ°å€ã€‚è¦çŸ¥é“æ ˆå¸§æ˜¯å¤ç”¨çš„ï¼Œè¿™å—å†…å­˜ç”¨å®Œå°±ä¼šä¸¢æ‰ã€‚æˆ‘ä»¬å¥½åƒå¼•ç”¨äº†ä¸€ä¸ªä¼šè¢«é”€æ¯çš„åœ°å€ï¼Œè¿™éå¸¸å¯æ€•ã€‚ä½†å®é™…ä¸Šï¼Œç¼–è¯‘å™¨éå¸¸å¼ºå¤§ï¼Œå®ƒèƒ½å¤Ÿè¿›è¡Œé™æ€ä»£ç åˆ†æï¼Œå°†ç¡®å®šä¸€ä¸ªå€¼æ˜¯å¦è¢«æ”¾åœ¨æ ˆä¸Šï¼Œè¿˜æ˜¯é€ƒé€¸åˆ°å †ä¸­ã€‚\nå……åˆ†åˆ©ç”¨æ ˆæ˜¯éå¸¸éå¸¸å¿«çš„ï¼Œæ ˆæ˜¯è‡ªæˆ‘æ¸…æ´çš„ã€‚è¿™æ„å‘³ç€ï¼Œåƒåœ¾å¤„ç†å™¨ç”šè‡³ä¸ä¼šä»‹å…¥ï¼Œç›´åˆ°ä¸€ä¸ªå€¼é€ƒå‡ºæ ˆï¼Œå¹¶åœ¨å †ä¸Šç»“æŸã€‚\nä¸ºä»€ä¹ˆæ ˆæ˜¯è‡ªæˆ‘æ¸…æ´çš„? å‚è€ƒä¸Šé¢ç»˜å›¾ï¼Œä»æ ˆå¸§è¿”å›åˆ°ä¸Šé¢æ—¶ï¼Œå†…å­˜ä¼šè¢«å•ç‹¬ç•™åœ¨æ ˆä¸­ï¼Œå¹¶åœ¨ä¸‹è¡Œæ—¶è¿›è¡Œæ¸…ç†ï¼Œæ‰€ä»¥åƒåœ¾å¤„ç†å™¨å¹¶ä¸éœ€è¦å‚ä¸ã€‚æ ˆå¯ä»¥ä¸ºæˆ‘ä»¬æä¾›å¤§é‡çš„æ€§èƒ½ï¼Œå› ä¸ºå†…å­˜æ˜¯å·²ç»åˆ†é…å¥½çš„ï¼Œè€Œä¸”å®ƒå¯ä»¥è‡ªæˆ‘æ¸…ç†ã€‚\næˆ‘ä»¬åº”è¯¥å°½åŠ›åˆ©ç”¨å€¼è¯­ä¹‰ï¼Œå¹¶å°†å€¼ä¿ç•™åœ¨æ ˆä¸­ï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºéš”ç¦»å’Œä¸å˜æ€§çš„å¸¦æ¥å‡å°‘å‰¯ä½œç”¨çš„å¥½å¤„ï¼Œè€Œä¸”åœ¨å¾ˆå¤šæƒ…å†µä¸‹è¿˜èƒ½å¸¦æ¥æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºä¸€æ—¦æœ‰ä¸œè¥¿è¢«åˆ†é…åˆ°å †ä¸Šï¼Œåƒåœ¾å¤„ç†å™¨å°±å¿…é¡»å‚ä¸è¿›æ¥ã€‚\nå¦å¤–ï¼ŒæŒ‡é’ˆåœ¨å¯è¯»æ€§ä¸Šï¼Œæœ‰ä¸€ä¸ªæŒ‡å¯¼åŸåˆ™ã€‚\nåœ¨æ„é€ è¿‡ç¨‹ä¸­ä½¿ç”¨æŒ‡é’ˆè¯­ä¹‰ï¼Œç°åœ¨æˆ‘ä»¬ä½¿è¿™æ®µä»£ç æ›´éš¾è¯»äº†ã€‚åœ¨æ„é€ è¿‡ç¨‹ä¸­ï¼Œä¸è¦ä½¿ç”¨æŒ‡é’ˆè¯­ä¹‰ï¼Œå¸Œæœ›ä½ åœ¨æ„é€ è¿‡ç¨‹ä¸­ä½¿ç”¨å€¼è¯­ä¹‰ï¼Œä»…åœ¨è°ƒç”¨å¤„ä½¿ç”¨æŒ‡é’ˆè¯­ä¹‰ã€‚é™¤éä½ æƒ³ç›´æ¥è¿”å›(return \u0026amp;user{})ã€‚\nå†æ¬¡æé†’ï¼Œå¦‚æœä½ å°†ä¸€ä¸ªå˜é‡çš„ç”Ÿå‘½ä½œä¸ºä¸€ä¸ªæŒ‡é’ˆå¼€å§‹ï¼Œä½ å°±ä¼šå¤±å»å¯è¯»æ€§ã€‚\n1 2 3 4 5 6 7 func createUserV2() *User { u := \u0026amp;user{ name:\u0026#34;Bill\u0026#34;, } return u } ç”Ÿæˆé€ƒé€¸åˆ†ææŠ¥å‘Š 1 go build -gcflags \u0026#34;-m -m\u0026#34; å½“ä½ åœ¨ go build ä¸­ä½¿ç”¨ gcflags æ—¶ï¼Œä½ å°†å¾—åˆ°çš„ä¸æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œæ˜¯é€ƒé€¸åˆ†ææŠ¥å‘Šã€‚\nå†…å­˜åˆ†é… å¦‚æœåœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¸çŸ¥é“ä¸€ä¸ªå€¼çš„å¤§å°ï¼Œå®ƒå¿…é¡»ç«‹å³åœ¨å †ä¸Šæ„å»ºï¼Œå› ä¸ºæ ˆå¸§ä¸æ˜¯åŠ¨æ€çš„ï¼Œéƒ½æ˜¯åœ¨ç¼–è¯‘æ—¶ç¡®å®šå°ºå¯¸ï¼Œæ‰€ä»¥ç¼–è¯‘æ—¶ä¸çŸ¥é“å€¼çš„å¤§å°ï¼Œå°±ä¸èƒ½æ”¾åœ¨æ ˆé‡Œã€‚\næˆ‘ä»¬çŸ¥é“ Go ä¸­çš„æ ˆæ˜¯éå¸¸éå¸¸å°çš„ï¼Œæ“ä½œç³»ç»Ÿçš„æ ˆå¤§çº¦æ˜¯ 1MBï¼Œè€Œ Go æ ˆæ˜¯ 2KBã€‚å¦‚æœæœ‰ä¸€ä¸ª goroutine è¿›è¡Œå¤§é‡çš„å‡½æ•°è°ƒç”¨ï¼Œå¹¶æœ€ç»ˆè€—å°½äº†æ ˆç©ºé—´ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢? Go æ‰€åšçš„æ˜¯å®ƒæœ‰è¿ç»­æ ˆï¼Œå®ƒä¼šåˆ†é…ä¸€ä¸ªæ›´å¤§çš„æ ˆï¼Œæ¯”åŸæ¥çš„æ ˆå¤§ 25%ï¼Œç„¶åï¼ŒæŠŠæ‰€æœ‰çš„æ ˆå¸§å¤è¿‡æ¥ã€‚\nåƒåœ¾å¤„ç†å™¨ ä¸€æ—¦åœ¨å †ä¸Šè¿›è¡Œäº†å†…å­˜åˆ†é…ï¼Œå®ƒå°±ä¼šåœç•™åœ¨é‚£é‡Œï¼Œç›´åˆ°è¢«å›æ”¶ã€‚\næˆ‘ä»¬æƒ³è¦çš„æ˜¯æœ€å°çš„å †ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨ã€‚é‚£ä¹ˆæ€æ ·æ‰èƒ½å¾—åˆ°æœ€å°çš„å †?\n","date":"2021-08-05T00:00:00Z","permalink":"https://blog.golang.space/p/%E6%A0%88%E5%B8%A7%E4%B8%8E%E9%80%83%E9%80%B8/","title":"æ ˆå¸§ä¸é€ƒé€¸"},{"content":"Postgres è¡¨åˆ†åŒº å½“ä¸€ä¸ªè¡¨éå¸¸å¤§æ—¶ï¼Œåˆ’åˆ†æ‰€å¸¦æ¥çš„å¥½å¤„æ˜¯éå¸¸å€¼å¾—çš„ã€‚ä¸€ä¸ªè¡¨ä½•ç§æƒ…å†µä¸‹ä¼šä»åˆ’åˆ†è·ç›Šå–å†³äºåº”ç”¨ï¼Œä¸€ä¸ªç»éªŒæ³•åˆ™æ˜¯å½“è¡¨çš„å°ºå¯¸è¶…è¿‡äº†æ•°æ®åº“æœåŠ¡å™¨ç‰©ç†å†…å­˜æ—¶ï¼Œåˆ’åˆ†ä¼šä¸ºè¡¨å¸¦æ¥å¥½å¤„ã€‚\nPostgreSQLå¯¹ä¸‹åˆ—åˆ†åŒºå½¢å¼æä¾›äº†å†…å»ºæ”¯æŒï¼š\nèŒƒå›´åˆ’åˆ†ï¼Œæ ¹æ®ä¸€ä¸ªå…³é”®åˆ—æˆ–ä¸€ç»„åˆ—åˆ’åˆ†ä¸ºâ€œèŒƒå›´â€ï¼Œä¾‹å¦‚æ—¥æœŸ åˆ—è¡¨åˆ’åˆ†ï¼Œæ˜¾å¼åœ°åˆ—å‡ºæ¯ä¸€ä¸ªåˆ†åŒºä¸­å‡ºç°çš„é”®å€¼æ¥åˆ’åˆ†è¡¨ å“ˆå¸Œåˆ†åŒºï¼Œä¸ºæ¯ä¸ªåˆ†åŒºæŒ‡å®šæ¨¡æ•°å’Œä½™æ•°æ¥å¯¹è¡¨è¿›è¡Œåˆ†åŒº æ— æ³•æŠŠä¸€ä¸ªå¸¸è§„è¡¨è½¬æ¢æˆåˆ†åŒºè¡¨ï¼Œåä¹‹äº¦ç„¶ã€‚ä¸è¿‡ï¼Œå¯ä»¥æŠŠä¸€ä¸ªåŒ…å«æ•°æ®çš„å¸¸è§„è¡¨æˆ–è€…åˆ†åŒºè¡¨ä½œä¸ºåˆ†åŒºåŠ å…¥åˆ°å¦ä¸€ä¸ªåˆ†åŒºè¡¨ï¼Œæˆ–è€…ä»åˆ†åŒºè¡¨ä¸­ç§»èµ°ä¸€ä¸ªåˆ†åŒºå¹¶ä¸”æŠŠå®ƒå˜æˆä¸€ä¸ªç‹¬ç«‹çš„è¡¨ã€‚\nå£°æ˜å¼åˆ†åŒº åœ¨ v10 ä¸­ï¼Œå¼•å…¥äº†æ–°çš„ä¸“ç”¨åˆ†åŒºè¯­æ³•ã€‚\nå‡å®šæˆ‘ä»¬æ­£åœ¨ä¸ºä¸€ä¸ªå¤§å‹çš„å†°æ¿€å‡Œå…¬å¸æ„å»ºæ•°æ®åº“ã€‚è¯¥å…¬å¸æ¯å¤©æµ‹é‡æœ€é«˜æ¸©åº¦ä»¥åŠæ¯ä¸ªåŒºåŸŸçš„å†°æ¿€å‡Œé”€å”®æƒ…å†µã€‚\n1 2 3 4 5 6 CREATE TABLE measurement ( city_id int not null, logdate date not null, peaktemp int, unitsales int ); æˆ‘ä»¬çŸ¥é“å¤§éƒ¨åˆ†æŸ¥è¯¢åªä¼šè®¿é—®ä¸Šå‘¨çš„ã€ä¸Šæœˆçš„æˆ–è€…ä¸Šå­£åº¦çš„æ•°æ®ï¼Œå› ä¸ºè¿™ä¸ªè¡¨çš„ä¸»è¦ç”¨é€”æ˜¯ä¸ºç®¡ç†å±‚å‡†å¤‡åœ¨çº¿æŠ¥å‘Šã€‚ä¸ºäº†å‡å°‘éœ€è¦è¢«å­˜æ”¾çš„æ—§æ•°æ®é‡ï¼Œæˆ‘ä»¬å†³å®šåªä¿ç•™æœ€è¿‘3å¹´çš„æ•°æ®ã€‚åœ¨æ¯ä¸ªæœˆçš„å¼€å§‹æˆ‘ä»¬å°†å»é™¤æ‰æœ€æ—©çš„é‚£ä¸ªæœˆçš„æ•°æ®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†åŒºæŠ€æœ¯æ¥å¸®åŠ©æˆ‘ä»¬æ»¡è¶³å¯¹measurementè¡¨çš„æ‰€æœ‰ä¸åŒéœ€æ±‚ã€‚\nè¦åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨å£°æ˜å¼åˆ†åŒºï¼Œå¯é‡‡ç”¨ä¸‹é¢çš„æ­¥éª¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 -- åˆ›å»ºè¡¨ CREATE TABLE measurement ( city_id int not null, logdate date not null, peaktemp int, unitsales int ) PARTITION BY RANGE (logdate); -- åˆ›å»ºåˆ†åŒº CREATE TABLE measurement_y2022m04 PARTITION OF measurement FOR VALUES FROM (\u0026#39;2022-04-01\u0026#39;) TO (\u0026#39;2022-05-01\u0026#39;); CREATE TABLE measurement_y2022m05 PARTITION OF measurement FOR VALUES FROM (\u0026#39;2022-05-01\u0026#39;) TO (\u0026#39;2022-06-01\u0026#39;); -- ä¸ºåˆ†åŒºè¡¨é”®åˆ—åˆ›å»ºç´¢å¼• -- è¿™ä¼šè‡ªåŠ¨åœ¨æ¯ä¸ªåˆ†åŒºä¸Šåˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œå¹¶ä¸”åæ¥åˆ›å»ºæˆ–è€…é™„ç€çš„ä»»ä½•åˆ†åŒºä¹Ÿå°†ä¼šåŒ…å«ç´¢å¼• CREATE INDEX ON measurement (logdate); -- æµ‹è¯•æ·»åŠ  INSERT INTO measurement VALUES(1,now(),27,99999); INSERT INTO measurement VALUES(2,\u0026#39;2022-05-13 20:26:42\u0026#39;,23,11111); INSERT INTO measurement VALUES(3,\u0026#39;2022-04-13 20:26:47\u0026#39;,21,33333); -- æ²¡æœ‰å¯¹åº”æ—¥æœŸçš„å­è¡¨ï¼Œä¼šå‡ºç°é”™è¯¯ INSERT INTO measurement VALUES(4,\u0026#39;2022-03-13 20:26:54\u0026#39;,25,33412); -- æµ‹è¯•æ›´æ–° UPDATE measurement SET peaktemp=18 WHERE city_id=3 åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¯ä¸ªæœˆåˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒºï¼Œå› æ­¤å†™ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨ç”Ÿæˆæ‰€éœ€çš„DDLä¼šæ›´å¥½ã€‚\nHash åˆ†åŒº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 -- hash åˆ†åŒº create table measurement( id int not null, logdata date not null, peaktemp int, unitsales int ) partition by hash (unitsales); -- åˆ›å»ºå­è¡¨ create table measurement_0 partition of measurement for values with (modulus 4, remainder 0); create table measurement_1 partition of measurement for values with (modulus 4, remainder 1); create table measurement_2 partition of measurement for values with (modulus 4, remainder 2); create table measurement_3 partition of measurement for values with (modulus 4, remainder 3); åˆ†åŒºç»´æŠ¤ ç§»é™¤æ—§æ•°æ®æœ€ç®€å•çš„é€‰æ‹©æ˜¯åˆ é™¤æ‰ä¸å†éœ€è¦çš„åˆ†åŒºï¼š\n1 DROP TABLE measurement_y2022m04; å¦ä¸€ç§é€šå¸¸æ›´å¥½çš„é€‰é¡¹æ˜¯æŠŠåˆ†åŒºä»åˆ†åŒºè¡¨ä¸­ç§»é™¤ï¼Œä½†æ˜¯ä¿ç•™å®ƒä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„è¡¨ï¼š\n1 ALTER TABLE measurement DETACH PARTITION measurement_y2022m04; é™åˆ¶\næ²¡æœ‰åŠæ³•åˆ›å»ºè·¨è¶Šæ‰€æœ‰åˆ†åŒºçš„æ’é™¤çº¦æŸï¼Œåªå¯èƒ½å•ä¸ªçº¦æŸæ¯ä¸ªå¶å­åˆ†åŒºã€‚ åˆ†åŒºè¡¨ä¸Šçš„æƒŸä¸€çº¦æŸå¿…é¡»åŒ…æ‹¬æ‰€æœ‰åˆ†åŒºé”®åˆ—ã€‚å­˜åœ¨æ­¤é™åˆ¶æ˜¯å› ä¸ºPostgreSQLåªèƒ½æ¯ä¸ªåˆ†åŒºä¸­åˆ†åˆ«å¼ºåˆ¶å®æ–½å”¯ä¸€æ€§ã€‚ åˆ†åŒºå‰ªæ åˆ†åŒºå‰ªææ˜¯ä¸€ç§æå‡å£°æ˜å¼åˆ†åŒºè¡¨æ€§èƒ½çš„æŸ¥è¯¢ä¼˜åŒ–æŠ€æœ¯ã€‚ä¾‹å¦‚\n1 2 SET enable_partition_pruning = on; -âˆ’ the default SELECT count(*) FROM measurement WHERE logdate \u0026gt;= DATE \u0026#39;2008-01-01\u0026#39;; å¦‚æœæ²¡æœ‰åˆ†åŒºå‰ªæï¼Œä¸Šé¢çš„æŸ¥è¯¢å°†ä¼šæ‰«æmeasurementè¡¨çš„æ¯ä¸€ä¸ªåˆ†åŒºã€‚å¦‚æœå¯ç”¨äº†åˆ†åŒºå‰ªæï¼Œè§„åˆ’å™¨å°†ä¼šæ£€æŸ¥æ¯ä¸ªåˆ†åŒºçš„å®šä¹‰å¹¶ä¸”æ£€éªŒè¯¥åˆ†åŒºæ˜¯å¦å› ä¸ºä¸åŒ…å«ç¬¦åˆæŸ¥è¯¢WHEREå­å¥çš„è¡Œè€Œæ— éœ€æ‰«æã€‚\nåˆ†åŒºå‰ªæä»…ç”±åˆ†åŒºé”®éšå¼å®šä¹‰çš„çº¦æŸæ‰€é©±åŠ¨ï¼Œè€Œä¸æ˜¯ç”±ç´¢å¼•çš„å­˜åœ¨é©±åŠ¨ã€‚å› æ­¤ï¼Œæ²¡æœ‰å¿…è¦åœ¨é”®åˆ—ä¸Šå®šä¹‰ç´¢å¼•ã€‚æ˜¯å¦éœ€è¦ä¸ºä¸€ä¸ªç»™å®šåˆ†åŒºåˆ›å»ºç´¢å¼•å–å†³äºé¢„æœŸçš„æŸ¥è¯¢æ‰«æè¯¥åˆ†åŒºæ—¶ä¼šæ‰«æå¤§éƒ¨åˆ†è¿˜æ˜¯å°éƒ¨åˆ†ã€‚åä¸€ç§æƒ…å†µä¸‹ç´¢å¼•çš„å¸®åŠ©ä¼šæ¯”å‰è€…å¤§ã€‚\næ—§çš„æ–¹æ³• ä» v8.1 å¼€å§‹ï¼ŒPostgres æä¾›çº¦æŸæ’é™¤çš„ä¼˜åŒ–å™¨åŠŸèƒ½å®ç°åŒºåˆ†\nä½¿ç”¨è¡¨ç»§æ‰¿å»ºç«‹è¡¨çš„å±‚æ¬¡ç»“æ„ï¼Œåœ¨æ¯ä¸ªå­è¡¨ä½¿ç”¨ check çº¦æŸæè¿°å…¶åˆ†åŒºèŒƒå›´ï¼Œå¹¶åœ¨çˆ¶è¡¨ä½¿ç”¨è§¦å‘å™¨æ‰§è¡Œæ•°æ®åˆ†é…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 create table measurement( id int not null, logdata date not null, peaktemp int, unitsales int ); create table measurement_y2020m01 (check (logdata \u0026gt;= \u0026#39;2020-02-1\u0026#39; AND logdata \u0026lt; \u0026#39;2020-02-01\u0026#39;) ) INHERITS (measurement) create table measurement_y2020m02 (check (logdata \u0026gt;= \u0026#39;2020-02-1\u0026#39; AND logdata \u0026lt; \u0026#39;2020-03-01\u0026#39;) ) INHERITS (measurement) åœ¨çˆ¶è¡¨å®šä¹‰è§¦å‘å™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 create trigger insert_measurement_trigger before insert on measurement for each row execute procedure measurement_insert_trigger(); create or replace function measurement_insert_trigger() returns trigger as $$ begin if (NEW.logdate \u0026gt;= DATE \u0026#39;2021-01-01\u0026#39; AND NEW.logdata \u0026lt; DATE \u0026#39;2020-02-01\u0026#39;) THEN INSERT INTO measurement_y2020m01 VALUES(NEW.*) ELSIF NEW.logdate \u0026gt;= DATE \u0026#39;2021-02-01\u0026#39; AND NEW.logdata \u0026lt; DATE \u0026#39;2020-03-01\u0026#39;) THEN INSERT INTO measurement_y2020m02 VALUES(NEW.*) ELSE RAISE EXCEPTION \u0026#39;Date out of range. fix the \u0026#39;; END IF; RETURN NULL: END; $$ LANGUAGE PLPGSQL; å‚è€ƒ PostgreSQL å®˜æ–¹æ–‡æ¡£\n","date":"2021-07-13T00:00:00Z","permalink":"https://blog.golang.space/p/%E8%A1%A8%E5%88%86%E5%8C%BA/","title":"è¡¨åˆ†åŒº"},{"content":"Go ç¼–ç è§„èŒƒ è½¬è½½äº Uber Go ç¼–ç è§„èŒƒä¸­æ–‡ç¿»è¯‘ï¼Œåœ¨å…¶åŸºç¡€ä¸Šåšäº†ä¸€äº›é€‚åˆæˆ‘çš„è¡¥å……ã€‚\nå»ºè®®æŸ¥çœ‹å®˜æ–¹ä»“åº“ï¼Œå¾ˆå¯èƒ½æ˜¯æœ€æ–°çš„ã€‚\næŒ‡å¯¼åŸåˆ™ æŒ‡å‘ interface çš„æŒ‡é’ˆ interface æºç \nè‹¥å­˜å‚¨çš„æ•°æ®æ˜¯æŒ‡é’ˆï¼Œåˆ™ç›´æ¥å­˜å‚¨ï¼Œè‹¥å­˜å‚¨çš„æ•°æ®æ˜¯å€¼ï¼Œåˆ™å­˜å‚¨æŒ‡å‘è¯¥å€¼çš„æŒ‡é’ˆã€‚\n1 2 3 4 5 6 type eface struct { // ç±»å‹æŒ‡é’ˆ _type *_type // æ•°æ®æŒ‡é’ˆ data unsafe.Pointer } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type F interface { f() } type S1 struct{} func (s S1) f() {} type S2 struct{} func (s *S2) f() {} // f1.f()æ— æ³•ä¿®æ”¹åº•å±‚æ•°æ® var f1 F = S1{} // f2.f() å¯ä»¥ä¿®æ”¹åº•å±‚æ•°æ®,ç»™æ¥å£å˜é‡f2èµ‹å€¼æ—¶ä½¿ç”¨çš„æ˜¯å¯¹è±¡æŒ‡é’ˆ var f2 F = \u0026amp;S2{} interface åˆç†æ€§éªŒè¯ è¿åæ¥å£åˆç†æ€§æ£€æŸ¥çš„åœºæ™¯ï¼Œéƒ½ä¼šç»ˆæ­¢ç¼–è¯‘ã€‚\nå¦‚æœæ¥å£ä¸åŒ¹é…ï¼Œé‚£ä¹ˆ var _ http.Handler = (*Handler)(nil) æ— æ³•ç¼–è¯‘é€šè¿‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Good type Handler struct { // ... } // ç”¨äºè§¦å‘ç¼–è¯‘æœŸçš„æ¥å£çš„åˆç†æ€§æ£€æŸ¥æœºåˆ¶ // å¦‚æœHandleræ²¡æœ‰å®ç°http.Handler,ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™ var _ http.Handler = (*Handler)(nil) func (h *Handler) ServeHTTP( w http.ResponseWriter, r *http.Request, ) { // ... } ä¸€èˆ¬å†™ New() å‡½æ•°ï¼Œæ•ˆæœç­‰åŒ\n1 2 3 func New() http.Handler { return \u0026amp;Handler{} } æ¥æ”¶å™¨ä¸æ¥å£ ä½¿ç”¨å€¼æ¥æ”¶å™¨çš„æ–¹æ³•æ—¢å¯ä»¥é€šè¿‡å€¼è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆè°ƒç”¨ã€‚\nå¸¦æŒ‡é’ˆæ¥æ”¶å™¨çš„æ–¹æ³•åªèƒ½é€šè¿‡æŒ‡é’ˆæˆ– addressable values è°ƒç”¨.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type S struct { data string } func (s S) Read() string { return s.data } func (s *S) Write(str string) { s.data = str } sVals := map[int]S{1: {\u0026#34;A\u0026#34;}} // ä½ åªèƒ½é€šè¿‡å€¼è°ƒç”¨ Read sVals[1].Read() // è¿™ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼š // sVals[1].Write(\u0026#34;test\u0026#34;) sPtrs := map[int]*S{1: {\u0026#34;A\u0026#34;}} // é€šè¿‡æŒ‡é’ˆæ—¢å¯ä»¥è°ƒç”¨ Readï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ Write æ–¹æ³• sPtrs[1].Read() sPtrs[1].Write(\u0026#34;test\u0026#34;) ç±»ä¼¼çš„,å³ä½¿æ–¹æ³•æœ‰äº†å€¼æ¥æ”¶å™¨,ä¹ŸåŒæ ·å¯ä»¥ç”¨æŒ‡é’ˆæ¥æ”¶å™¨æ¥æ»¡è¶³æ¥å£.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type F interface { f() } type S1 struct{} func (s S1) f() {} type S2 struct{} func (s *S2) f() {} s1Val := S1{} s1Ptr := \u0026amp;S1{} s2Val := S2{} s2Ptr := \u0026amp;S2{} var i F i = s1Val i = s1Ptr i = s2Ptr // ä¸‹é¢ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å› ä¸º s2Val æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œ S2 çš„ f æ–¹æ³•ä¸­æ²¡æœ‰ä½¿ç”¨å€¼æ¥æ”¶å™¨ // i = s2Val è¡¥å…… :\nä¸€ä¸ªç±»å‹å¯ä»¥æœ‰ä¸¤ç§æ¥æ”¶å™¨æ–¹æ³•é›†ï¼Œ å€¼æ¥æ”¶å™¨æ–¹æ³•é›†å’ŒæŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›† å€¼æ¥æ”¶å™¨æ–¹æ³•é›†æ˜¯æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†çš„å­é›†ï¼Œåä¹‹ä¸æ˜¯ è§„åˆ™ å€¼å¯¹è±¡åªå¯ä»¥ä½¿ç”¨å€¼æ¥æ”¶å™¨æ–¹æ³•é›† æŒ‡é’ˆå¯¹è±¡å¯ä»¥ä½¿ç”¨ å€¼æ¥æ”¶å™¨æ–¹æ³•é›† + æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›† æ¥æ”¶çš„å®ç° ç±»å‹å®ç°äº†æ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼Œå« åŒ¹é…/å®ç° å…·ä½“çš„è®²ï¼Œè¦ä¹ˆæ˜¯ç±»å‹çš„å€¼æ–¹æ³•é›†åŒ¹é…æ¥å£ï¼Œè¦ä¹ˆæ˜¯æŒ‡é’ˆæ–¹æ³•é›†åŒ¹é…æ¥å£ å…·ä½“çš„åŒ¹é…åˆ†ä¸¤ç§\nå€¼æ–¹æ³•é›†å’Œæ¥å£åŒ¹é… ç»™æ¥å£å˜é‡èµ‹å€¼çš„ä¸ç®¡æ˜¯å€¼è¿˜æ˜¯æŒ‡é’ˆå¯¹è±¡ï¼Œéƒ½å¯ä»¥ï¼Œå› ä¸ºéƒ½åŒ…å«å€¼æ–¹æ³•é›† æŒ‡é’ˆæ–¹æ³•é›†å’Œæ¥å£åŒ¹é… åªèƒ½å°†æŒ‡é’ˆå¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡ ( var i F = \u0026amp;S2{} )ï¼Œå› ä¸ºä»…æœ‰æŒ‡é’ˆæ–¹æ³•é›†ä¸æ¥å£åŒ¹é… å¦‚æœå°†å€¼å¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡ ( var i F = S2{} )ï¼Œä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™ åœ¨ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œ i = s2Val ä¼šæŠ¥é”™ï¼Œæ˜¯å› ä¸ºå…¶æ–¹æ³•éƒ½æ˜¯æŒ‡é’ˆæ–¹æ³•é›†ï¼Œä¸æ¥å£ä¸åŒ¹é…ã€‚å¯ä»¥è¿™æ ·æ“ä½œ i = \u0026amp;s2Val\né›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„ 1 2 // Bad mu := new(sync.Mutex) 1 2 // Good var mu sync.Mutex å¦‚æœä½ ä½¿ç”¨ç»“æ„ä½“æŒ‡é’ˆï¼Œmutex å¯ä»¥éæŒ‡é’ˆå½¢å¼ä½œä¸ºç»“æ„ä½“çš„ç»„æˆå­—æ®µï¼Œæˆ–è€…æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æ¥åµŒå…¥åˆ°ç»“æ„ä½“ä¸­ã€‚ å¦‚æœæ˜¯ç§æœ‰ç»“æ„ä½“ç±»å‹æˆ–æ˜¯è¦å®ç° Mutex æ¥å£çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå…¥ mutex çš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // ä¸ºç§æœ‰ç±»å‹æˆ–éœ€è¦å®ç°äº’æ–¥æ¥å£çš„ç±»å‹åµŒå…¥ã€‚ type smap struct { sync.Mutex // ä»…é€‚ç”¨äºéå¯¼å‡ºç±»å‹ data map[string]string } func newSMap() *smap { return \u0026amp;smap{ data: make(map[string]string), } } func (m *smap) Get(k string) string { m.Lock() defer m.Unlock() return m.data[k] } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // å¯¹äºå¯¼å‡ºçš„ç±»å‹ï¼Œè¯·ä½¿ç”¨ä¸“ç”¨å­—æ®µã€‚ type SMap struct { mu sync.Mutex // å¯¹äºå¯¼å‡ºç±»å‹ï¼Œè¯·ä½¿ç”¨ç§æœ‰é” data map[string]string } func NewSMap() *SMap { return \u0026amp;SMap{ data: make(map[string]string), } } func (m *SMap) Get(k string) string { m.mu.Lock() defer m.mu.Unlock() return m.data[k] } åœ¨è¾¹ç•Œå¤„æ‹·è´ Slices å’Œ Maps slices å’Œ maps åŒ…å«äº†æŒ‡å‘åº•å±‚æ•°æ®çš„æŒ‡é’ˆï¼Œå› æ­¤åœ¨éœ€è¦å¤åˆ¶å®ƒä»¬æ—¶è¦ç‰¹åˆ«æ³¨æ„ã€‚\næ¥æ”¶ Slices å’Œ Maps\nè¯·è®°ä½ï¼Œå½“ map æˆ– slice ä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥æ—¶ï¼Œå¦‚æœæ‚¨å­˜å‚¨äº†å¯¹å®ƒä»¬çš„å¼•ç”¨ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚\n1 2 3 4 5 6 7 8 9 10 // Bad func (d *Driver) SetTrips(trips []Trip) { d.trips = trips } trips := ... d1.SetTrips(trips) // ä½ æ˜¯è¦ä¿®æ”¹ d1.trips å—ï¼Ÿ trips[0] = ... 1 2 3 4 5 6 7 8 9 10 11 # Good func (d *Driver) SetTrips(trips []Trip) { d.trips = make([]Trip, len(trips)) copy(d.trips, trips) } trips := ... d1.SetTrips(trips) // è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ trips[0]ï¼Œä½†ä¸ä¼šå½±å“åˆ° d1.trips trips[0] = ... è¿”å› slices æˆ– maps\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // Bad type Stats struct { mu sync.Mutex counters map[string]int } // Snapshot è¿”å›å½“å‰çŠ¶æ€ã€‚ func (s *Stats) Snapshot() map[string]int { s.mu.Lock() defer s.mu.Unlock() return s.counters } // snapshot ä¸å†å—äº’æ–¥é”ä¿æŠ¤ // å› æ­¤å¯¹ snapshot çš„ä»»ä½•è®¿é—®éƒ½å°†å—åˆ°æ•°æ®ç«äº‰çš„å½±å“ // å½±å“ stats.counters snapshot := stats.Snapshot() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Good type Stats struct { mu sync.Mutex counters map[string]int } func (s *Stats) Snapshot() map[string]int { s.mu.Lock() defer s.mu.Unlock() result := make(map[string]int, len(s.counters)) for k, v := range s.counters { result[k] = v } return result } // snapshot ç°åœ¨æ˜¯ä¸€ä¸ªæ‹·è´ snapshot := stats.Snapshot() ä½¿ç”¨ defer é‡Šæ”¾èµ„æº ä½¿ç”¨ defer é‡Šæ”¾èµ„æºï¼Œè¯¸å¦‚æ–‡ä»¶å’Œé”ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Bad p.Lock() if p.count \u0026lt; 10 { p.Unlock() return p.count } p.count++ newCount := p.count p.Unlock() return newCount // å½“æœ‰å¤šä¸ª return åˆ†æ”¯æ—¶ï¼Œå¾ˆå®¹æ˜“é—å¿˜ unlock 1 2 3 4 5 6 7 8 9 10 11 12 // Good p.Lock() defer p.Unlock() if p.count \u0026lt; 10 { return p.count } p.count++ return p.count // æ›´å¯è¯» Defer çš„å¼€é”€éå¸¸å°ï¼Œåªæœ‰åœ¨æ‚¨å¯ä»¥è¯æ˜å‡½æ•°æ‰§è¡Œæ—¶é—´å¤„äºçº³ç§’çº§çš„ç¨‹åº¦æ—¶ï¼Œæ‰åº”é¿å…è¿™æ ·åšã€‚ä½¿ç”¨ defer æå‡å¯è¯»æ€§æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºä½¿ç”¨å®ƒä»¬çš„æˆæœ¬å¾®ä¸è¶³é“ã€‚å°¤å…¶é€‚ç”¨äºé‚£äº›ä¸ä»…ä»…æ˜¯ç®€å•å†…å­˜è®¿é—®çš„è¾ƒå¤§çš„æ–¹æ³•ï¼Œåœ¨è¿™äº›æ–¹æ³•ä¸­å…¶ä»–è®¡ç®—çš„èµ„æºæ¶ˆè€—è¿œè¶…è¿‡ deferã€‚\nChannel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ 1 2 3 // Bad // åº”è¯¥è¶³ä»¥æ»¡è¶³ä»»ä½•æƒ…å†µï¼ c := make(chan int, 64) 1 2 3 4 5 // Good // å¤§å°ï¼š1 c := make(chan int, 1) // æˆ–è€… // æ— ç¼“å†² channelï¼Œå¤§å°ä¸º 0 c := make(chan int) æšä¸¾ä» 1 å¼€å§‹ 1 2 3 4 5 6 7 8 9 10 // Bad type Operation int const ( Add Operation = iota Subtract Multiply ) // Add=0, Subtract=1, Multiply=2 1 2 3 4 5 6 7 8 9 10 // Good type Operation int const ( Add Operation = iota + 1 Subtract Multiply ) // Add=1, Subtract=2, Multiply=3 åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨é›¶å€¼æ˜¯æœ‰æ„ä¹‰çš„ï¼ˆæšä¸¾ä»é›¶å¼€å§‹ï¼‰ï¼Œä¾‹å¦‚ï¼Œå½“é›¶å€¼æ˜¯ç†æƒ³çš„é»˜è®¤è¡Œä¸ºæ—¶ã€‚\nä½¿ç”¨ time å¤„ç†æ—¶é—´ æ—¶é—´å¤„ç†å¾ˆå¤æ‚ã€‚å…³äºæ—¶é—´çš„é”™è¯¯å‡è®¾é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ã€‚\nä¸€å¤©æœ‰ 24 å°æ—¶ ä¸€å°æ—¶æœ‰ 60 åˆ†é’Ÿ ä¸€å‘¨æœ‰ä¸ƒå¤© ä¸€å¹´ 365 å¤© è¿˜æœ‰æ›´å¤š ä¾‹å¦‚ï¼Œ1 è¡¨ç¤ºåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ŠåŠ ä¸Š 24 å°æ—¶å¹¶ä¸æ€»æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥å†æ—¥ã€‚\nå› æ­¤ï¼Œåœ¨å¤„ç†æ—¶é—´æ—¶å§‹ç»ˆä½¿ç”¨ \u0026quot;time\u0026quot; åŒ…ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºä»¥æ›´å®‰å…¨ã€æ›´å‡†ç¡®çš„æ–¹å¼å¤„ç†è¿™äº›ä¸æ­£ç¡®çš„å‡è®¾ã€‚\nä½¿ç”¨ time.Time è¡¨è¾¾ç¬æ—¶æ—¶é—´\nåœ¨å¤„ç†æ—¶é—´çš„ç¬é—´æ—¶ä½¿ç”¨ time.Timeï¼Œåœ¨æ¯”è¾ƒã€æ·»åŠ æˆ–å‡å»æ—¶é—´æ—¶ä½¿ç”¨ time.Time ä¸­çš„æ–¹æ³•ã€‚\n1 2 3 4 // Bad func isActive(now, start, stop int) bool { return start \u0026lt;= now \u0026amp;\u0026amp; now \u0026lt; stop } 1 2 3 4 // Good func isActive(now, start, stop time.Time) bool { return (start.Before(now) || start.Equal(now)) \u0026amp;\u0026amp; now.Before(stop) } ä½¿ç”¨ time.Duration è¡¨è¾¾æ—¶é—´æ®µ\n1 2 3 4 5 6 7 8 // Bad func poll(delay int) { for { // ... time.Sleep(time.Duration(delay) * time.Millisecond) } } poll(10) // æ˜¯å‡ ç§’é’Ÿè¿˜æ˜¯å‡ æ¯«ç§’? 1 2 3 4 5 6 7 8 // Good func poll(delay time.Duration) { for { // ... time.Sleep(delay) } } poll(10*time.Second) å›åˆ°ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´ç¬é—´åŠ ä¸Š 24 å°æ—¶ï¼Œæˆ‘ä»¬ç”¨äºæ·»åŠ æ—¶é—´çš„æ–¹æ³•å–å†³äºæ„å›¾ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸‹ä¸€ä¸ªæ—¥å†æ—¥(å½“å‰å¤©çš„ä¸‹ä¸€å¤©)çš„åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Time.AddDateã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä¿è¯æŸä¸€æ—¶åˆ»æ¯”å‰ä¸€æ—¶åˆ»æ™š 24 å°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Time.Addã€‚\n1 2 newDay := t.AddDate(0 /* years */, 0 /* months */, 1 /* days */) maybeNewDay := t.Add(24 * time.Hour) å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ time.Time å’Œ time.Duration\nå°½å¯èƒ½åœ¨ä¸å¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’ä¸­ä½¿ç”¨ time.Duration å’Œ time.Time ä¾‹å¦‚ :\nCommand-line æ ‡å¿—: flag é€šè¿‡ time.ParseDuration æ”¯æŒ time.Duration JSON: encoding/json é€šè¿‡å…¶ UnmarshalJSON method æ–¹æ³•æ”¯æŒå°† time.Time ç¼–ç ä¸º RFC 3339 å­—ç¬¦ä¸² SQL: database/sql æ”¯æŒå°† DATETIME æˆ– TIMESTAMP åˆ—è½¬æ¢ä¸º time.Timeï¼Œå¦‚æœåº•å±‚é©±åŠ¨ç¨‹åºæ”¯æŒåˆ™è¿”å› YAML: gopkg.in/yaml.v2 æ”¯æŒå°† time.Time ä½œä¸º RFC 3339 å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡ time.ParseDuration æ”¯æŒ time.Durationã€‚ å½“ä¸èƒ½åœ¨è¿™äº›äº¤äº’ä¸­ä½¿ç”¨ time.Duration æ—¶ï¼Œè¯·ä½¿ç”¨ int æˆ– float64ï¼Œå¹¶åœ¨å­—æ®µåç§°ä¸­åŒ…å«å•ä½ã€‚\nä¾‹å¦‚ï¼Œç”±äº encoding/json ä¸æ”¯æŒ time.Durationï¼Œå› æ­¤è¯¥å•ä½åŒ…å«åœ¨å­—æ®µçš„åç§°ä¸­ã€‚\n1 2 3 4 5 // Bad // {\u0026#34;interval\u0026#34;: 2} type Config struct { Interval int `json:\u0026#34;interval\u0026#34;` } 1 2 3 4 5 // Good // {\u0026#34;intervalMillis\u0026#34;: 2000} type Config struct { IntervalMillis int `json:\u0026#34;intervalMillis\u0026#34;` } å½“åœ¨è¿™äº›äº¤äº’ä¸­ä¸èƒ½ä½¿ç”¨ time.Time æ—¶ï¼Œé™¤éè¾¾æˆä¸€è‡´ï¼Œå¦åˆ™ä½¿ç”¨ string å’Œ RFC 3339 ä¸­å®šä¹‰çš„æ ¼å¼æ—¶é—´æˆ³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTime.UnmarshalText ä½¿ç”¨æ­¤æ ¼å¼ï¼Œå¹¶å¯é€šè¿‡ time.RFC3339 åœ¨ Time.Format å’Œ time.Parse ä¸­ä½¿ç”¨ã€‚\nå°½ç®¡è¿™åœ¨å®è·µä¸­å¹¶ä¸æˆé—®é¢˜ï¼Œä½†è¯·è®°ä½ï¼Œ\u0026quot;time\u0026quot; åŒ…ä¸æ”¯æŒè§£æé—°ç§’æ—¶é—´æˆ³ï¼ˆ8728ï¼‰ï¼Œä¹Ÿä¸åœ¨è®¡ç®—ä¸­è€ƒè™‘é—°ç§’ï¼ˆ15190ï¼‰ã€‚å¦‚æœæ‚¨æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´ç¬é—´ï¼Œåˆ™å·®å¼‚å°†ä¸åŒ…æ‹¬è¿™ä¸¤ä¸ªç¬é—´ä¹‹é—´å¯èƒ½å‘ç”Ÿçš„é—°ç§’ã€‚\né”™è¯¯ç±»å‹ Go ä¸­æœ‰å¤šç§å£°æ˜é”™è¯¯ï¼ˆError) çš„é€‰é¡¹ï¼š\nerrors.New å¯¹äºç®€å•é™æ€å­—ç¬¦ä¸²çš„é”™è¯¯ fmt.Errorf ç”¨äºæ ¼å¼åŒ–çš„é”™è¯¯å­—ç¬¦ä¸² å®ç° Error() æ–¹æ³•çš„è‡ªå®šä¹‰ç±»å‹ ç”¨ \u0026quot;pkg/errors\u0026quot;.Wrap çš„ Wrapped errors è¿”å›é”™è¯¯æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å› ç´ ä»¥ç¡®å®šæœ€ä½³é€‰æ‹©ï¼š\nè¿™æ˜¯ä¸€ä¸ªä¸éœ€è¦é¢å¤–ä¿¡æ¯çš„ç®€å•é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œerrors.New è¶³å¤Ÿäº†ã€‚ å®¢æˆ·éœ€è¦æ£€æµ‹å¹¶å¤„ç†æ­¤é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹å¹¶å®ç°è¯¥ Error() æ–¹æ³•ã€‚ æ‚¨æ˜¯å¦æ­£åœ¨ä¼ æ’­ä¸‹æ¸¸å‡½æ•°è¿”å›çš„é”™è¯¯ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡åé¢æœ‰å…³é”™è¯¯åŒ…è£… section on error wrapping éƒ¨åˆ†çš„å†…å®¹ã€‚ å¦åˆ™ fmt.Errorf å°±å¯ä»¥äº†ã€‚ å¦‚æœå®¢æˆ·ç«¯éœ€è¦æ£€æµ‹é”™è¯¯ï¼Œå¹¶ä¸”æ‚¨å·²ä½¿ç”¨åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„é”™è¯¯ errors.Newï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªé”™è¯¯å˜é‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Bad // package foo func Open() error { return errors.New(\u0026#34;could not open\u0026#34;) } // package bar func use() { if err := foo.Open(); err != nil { if err.Error() == \u0026#34;could not open\u0026#34; { // handle } else { panic(\u0026#34;unknown error\u0026#34;) } } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // Good // package foo var ErrCouldNotOpen = errors.New(\u0026#34;could not open\u0026#34;) func Open() error { return ErrCouldNotOpen } // package bar if err := foo.Open(); err != nil { if errors.Is(err, foo.ErrCouldNotOpen) { // handle } else { panic(\u0026#34;unknown error\u0026#34;) } } å¦‚æœæ‚¨æœ‰å¯èƒ½éœ€è¦å®¢æˆ·ç«¯æ£€æµ‹çš„é”™è¯¯ï¼Œå¹¶ä¸”æƒ³å‘å…¶ä¸­æ·»åŠ æ›´å¤šä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œå®ƒä¸æ˜¯é™æ€å­—ç¬¦ä¸²ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Bad func open(file string) error { return fmt.Errorf(\u0026#34;file %q not found\u0026#34;, file) } func use() { if err := open(\u0026#34;testfile.txt\u0026#34;); err != nil { if strings.Contains(err.Error(), \u0026#34;not found\u0026#34;) { // handle } else { panic(\u0026#34;unknown error\u0026#34;) } } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Good type errNotFound struct { file string } func (e errNotFound) Error() string { return fmt.Sprintf(\u0026#34;file %q not found\u0026#34;, e.file) } func open(file string) error { return errNotFound{file: file} } func use() { if err := open(\u0026#34;testfile.txt\u0026#34;); err != nil { if _, ok := err.(errNotFound); ok { // handle } else { panic(\u0026#34;unknown error\u0026#34;) } } } ç›´æ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯ç±»å‹æ—¶è¦å°å¿ƒï¼Œå› ä¸ºå®ƒä»¬å·²æˆä¸ºç¨‹åºåŒ…å…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚æœ€å¥½å…¬å¼€åŒ¹é…å™¨åŠŸèƒ½ä»¥æ£€æŸ¥é”™è¯¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // package foo type errNotFound struct { file string } func (e errNotFound) Error() string { return fmt.Sprintf(\u0026#34;file %q not found\u0026#34;, e.file) } func IsNotFoundError(err error) bool { _, ok := err.(errNotFound) return ok } func Open(file string) error { return errNotFound{file: file} } // package bar if err := foo.Open(\u0026#34;foo\u0026#34;); err != nil { if foo.IsNotFoundError(err) { // handle } else { panic(\u0026#34;unknown error\u0026#34;) } } é”™è¯¯åŒ…è£… (Error Wrapping) ä¸€ä¸ªï¼ˆå‡½æ•°/æ–¹æ³•ï¼‰è°ƒç”¨å¤±è´¥æ—¶ï¼Œæœ‰ä¸‰ç§ä¸»è¦çš„é”™è¯¯ä¼ æ’­æ–¹å¼ï¼š\nå¦‚æœæ²¡æœ‰è¦æ·»åŠ çš„å…¶ä»–ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦ç»´æŠ¤åŸå§‹é”™è¯¯ç±»å‹ï¼Œåˆ™è¿”å›åŸå§‹é”™è¯¯ã€‚ æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨ \u0026quot;pkg/errors\u0026quot;.Wrap ä»¥ä¾¿é”™è¯¯æ¶ˆæ¯æä¾›æ›´å¤šä¸Šä¸‹æ–‡ ,\u0026quot;pkg/errors\u0026quot;.Cause å¯ç”¨äºæå–åŸå§‹é”™è¯¯ã€‚ å¦‚æœè°ƒç”¨è€…ä¸éœ€è¦æ£€æµ‹æˆ–å¤„ç†çš„ç‰¹å®šé”™è¯¯æƒ…å†µï¼Œä½¿ç”¨ fmt.Errorfã€‚ å»ºè®®åœ¨å¯èƒ½çš„åœ°æ–¹æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä»¥ä½¿æ‚¨è·å¾—è¯¸å¦‚â€œè°ƒç”¨æœåŠ¡ fooï¼šè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ›´æœ‰ç”¨çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯è¯¸å¦‚â€œè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ¨¡ç³Šé”™è¯¯ã€‚\nåœ¨å°†ä¸Šä¸‹æ–‡æ·»åŠ åˆ°è¿”å›çš„é”™è¯¯æ—¶ï¼Œè¯·é¿å…ä½¿ç”¨â€œfailed toâ€ä¹‹ç±»çš„çŸ­è¯­ä»¥ä¿æŒä¸Šä¸‹æ–‡ç®€æ´ï¼Œè¿™äº›çŸ­è¯­ä¼šé™ˆè¿°æ˜æ˜¾çš„å†…å®¹ï¼Œå¹¶éšç€é”™è¯¯åœ¨å †æ ˆä¸­çš„æ¸—é€è€Œé€æ¸å †ç§¯ï¼š\n1 2 3 4 5 6 // Bad s, err := store.New() if err != nil { return fmt.Errorf( \u0026#34;failed to create new store: %v\u0026#34;, err) } 1 2 3 4 5 6 // Good s, err := store.New() if err != nil { return fmt.Errorf( \u0026#34;new store: %v\u0026#34;, err) } ä½†æ˜¯ï¼Œä¸€æ—¦å°†é”™è¯¯å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼Œå°±åº”è¯¥æ˜ç¡®æ¶ˆæ¯æ˜¯é”™è¯¯æ¶ˆæ¯ï¼ˆä¾‹å¦‚ä½¿ç”¨erræ ‡è®°ï¼Œæˆ–åœ¨æ—¥å¿—ä¸­ä»¥â€Failedâ€ä¸ºå‰ç¼€ï¼‰ã€‚\nå¦è¯·å‚è§ Don\u0026rsquo;t just check errors, handle them gracefully. ä¸è¦åªæ˜¯æ£€æŸ¥é”™è¯¯ï¼Œè¦ä¼˜é›…åœ°å¤„ç†é”™è¯¯\nå¤„ç†ç±»å‹æ–­è¨€å¤±è´¥ type assertion çš„å•ä¸ªè¿”å›å€¼å½¢å¼é’ˆå¯¹ä¸æ­£ç¡®çš„ç±»å‹å°†äº§ç”Ÿ panicã€‚å› æ­¤ï¼Œè¯·å§‹ç»ˆä½¿ç”¨â€œcomma okâ€çš„æƒ¯ç”¨æ³•ã€‚\n1 2 // Bad t := i.(string) 1 2 3 4 5 // Good t, ok := i.(string) if !ok { // ä¼˜é›…åœ°å¤„ç†é”™è¯¯ } ä¸è¦ panic åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„ä»£ç å¿…é¡»é¿å…å‡ºç° panicã€‚panic æ˜¯ cascading failures çº§è”å¤±è´¥çš„ä¸»è¦æ ¹æº ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¯¥å‡½æ•°å¿…é¡»è¿”å›é”™è¯¯ï¼Œå¹¶å…è®¸è°ƒç”¨æ–¹å†³å®šå¦‚ä½•å¤„ç†å®ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 // Bad func run(args []string) { if len(args) == 0 { panic(\u0026#34;an argument is required\u0026#34;) } // ... } func main() { run(os.Args[1:]) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // Good func run(args []string) error { if len(args) == 0 { return errors.New(\u0026#34;an argument is required\u0026#34;) } // ... return nil } func main() { if err := run(os.Args[1:]); err != nil { fmt.Fprintln(os.Stderr, err) os.Exit(1) } } panic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ã€‚ä»…å½“å‘ç”Ÿä¸å¯æ¢å¤çš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼šnil å¼•ç”¨ï¼‰æ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚ç¨‹åºåˆå§‹åŒ–æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼šç¨‹åºå¯åŠ¨æ—¶åº”ä½¿ç¨‹åºä¸­æ­¢çš„ä¸è‰¯æƒ…å†µå¯èƒ½ä¼šå¼•èµ· panicã€‚\n1 var _statusTemplate = template.Must(template.New(\u0026#34;name\u0026#34;).Parse(\u0026#34;_statusHTML\u0026#34;)) å³ä½¿åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä¹Ÿä¼˜å…ˆä½¿ç”¨t.Fatalæˆ–è€…t.FailNowè€Œä¸æ˜¯ panic æ¥ç¡®ä¿å¤±è´¥è¢«æ ‡è®°ã€‚\n1 2 3 4 5 6 7 // Bad // func TestFoo(t *testing.T) f, err := ioutil.TempFile(\u0026#34;\u0026#34;, \u0026#34;test\u0026#34;) if err != nil { panic(\u0026#34;failed to set up test\u0026#34;) } 1 2 3 4 5 6 7 // Good // func TestFoo(t *testing.T) f, err := ioutil.TempFile(\u0026#34;\u0026#34;, \u0026#34;test\u0026#34;) if err != nil { t.Fatal(\u0026#34;failed to set up test\u0026#34;) } ä½¿ç”¨ go.uber.org/atomic ( ä»…æ‘˜å½•ï¼Œæ­¤æ¡ä¸ä¸€å®šé€‚åˆæˆ‘ä½¿ç”¨ )\nä½¿ç”¨ sync/atomic åŒ…çš„åŸå­æ“ä½œå¯¹åŸå§‹ç±»å‹ (int32, int64ç­‰ï¼‰è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå¾ˆå®¹æ˜“å¿˜è®°ä½¿ç”¨åŸå­æ“ä½œæ¥è¯»å–æˆ–ä¿®æ”¹å˜é‡ã€‚\ngo.uber.org/atomic é€šè¿‡éšè—åŸºç¡€ç±»å‹ä¸ºè¿™äº›æ“ä½œå¢åŠ äº†ç±»å‹å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ªæ–¹ä¾¿çš„atomic.Boolç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Bad type foo struct { running int32 // atomic } func (f* foo) start() { if atomic.SwapInt32(\u0026amp;f.running, 1) == 1 { // already runningâ€¦ return } // start the Foo } func (f *foo) isRunning() bool { return f.running == 1 // race! } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Good type foo struct { running atomic.Bool } func (f *foo) start() { if f.running.Swap(true) { // already runningâ€¦ return } // start the Foo } func (f *foo) isRunning() bool { return f.running.Load() } é¿å…å¯å˜å…¨å±€å˜é‡ ä½¿ç”¨é€‰æ‹©ä¾èµ–æ³¨å…¥æ–¹å¼é¿å…æ”¹å˜å…¨å±€å˜é‡ã€‚ æ—¢é€‚ç”¨äºå‡½æ•°æŒ‡é’ˆåˆé€‚ç”¨äºå…¶ä»–å€¼ç±»å‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Bad // sign.go var _timeNow = time.Now func sign(msg string) string { now := _timeNow() return signWithTime(msg, now) } // sign_test.go func TestSign(t *testing.T) { oldTimeNow := _timeNow _timeNow = func() time.Time { return someFixedTime } defer func() { _timeNow = oldTimeNow }() assert.Equal(t, want, sign(give)) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // Good // sign.go type signer struct { now func() time.Time } func newSigner() *signer { return \u0026amp;signer{ now: time.Now, } } func (s *signer) Sign(msg string) string { now := s.now() return signWithTime(msg, now) } // sign_test.go func TestSigner(t *testing.T) { s := newSigner() s.now = func() time.Time { return someFixedTime } assert.Equal(t, want, s.Sign(give)) } é¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹ è¿™äº›åµŒå…¥çš„ç±»å‹æ³„æ¼å®ç°ç»†èŠ‚ã€ç¦æ­¢ç±»å‹æ¼”åŒ–å’Œæ¨¡ç³Šçš„æ–‡æ¡£ã€‚\nå‡è®¾æ‚¨ä½¿ç”¨å…±äº«çš„ AbstractList å®ç°äº†å¤šç§åˆ—è¡¨ç±»å‹ï¼Œè¯·é¿å…åœ¨å…·ä½“çš„åˆ—è¡¨å®ç°ä¸­åµŒå…¥ AbstractListã€‚ ç›¸åï¼Œåªéœ€æ‰‹åŠ¨å°†æ–¹æ³•å†™å…¥å…·ä½“çš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å°†å§”æ‰˜ç»™æŠ½è±¡åˆ—è¡¨ã€‚\n1 2 3 4 5 6 7 8 9 type AbstractList struct {} // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *AbstractList) Add(e Entity) { // ... } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *AbstractList) Remove(e Entity) { // ... } 1 2 3 4 5 // Bad // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { *AbstractList } 1 2 3 4 5 6 7 8 9 10 11 12 13 // Good // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { list *AbstractList } // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *ConcreteList) Add(e Entity) { l.list.Add(e) } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *ConcreteList) Remove(e Entity) { l.list.Remove(e) } Go å…è®¸ ç±»å‹åµŒå…¥ ä½œä¸ºç»§æ‰¿å’Œç»„åˆä¹‹é—´çš„æŠ˜è¡·ã€‚ å¤–éƒ¨ç±»å‹è·å–åµŒå…¥ç±»å‹çš„æ–¹æ³•çš„éšå¼å‰¯æœ¬ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•å§”æ‰˜ç»™åµŒå…¥å®ä¾‹çš„åŒä¸€æ–¹æ³•ã€‚\nç»“æ„è¿˜è·å¾—ä¸ç±»å‹åŒåçš„å­—æ®µã€‚ æ‰€ä»¥ï¼Œå¦‚æœåµŒå…¥çš„ç±»å‹æ˜¯ publicï¼Œé‚£ä¹ˆå­—æ®µæ˜¯ publicã€‚ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼Œå¤–éƒ¨ç±»å‹çš„æ¯ä¸ªæœªæ¥ç‰ˆæœ¬éƒ½å¿…é¡»ä¿ç•™åµŒå…¥ç±»å‹ã€‚\nå¾ˆå°‘éœ€è¦åµŒå…¥ç±»å‹ã€‚ è¿™æ˜¯ä¸€ç§æ–¹ä¾¿ï¼Œå¯ä»¥å¸®åŠ©æ‚¨é¿å…ç¼–å†™å†—é•¿çš„å§”æ‰˜æ–¹æ³•ã€‚\nå³ä½¿åµŒå…¥å…¼å®¹çš„æŠ½è±¡åˆ—è¡¨ interfaceï¼Œè€Œä¸æ˜¯ç»“æ„ä½“ï¼Œè¿™å°†ä¸ºå¼€å‘äººå‘˜æä¾›æ›´å¤§çš„çµæ´»æ€§æ¥æ”¹å˜æœªæ¥ï¼Œä½†ä»ç„¶æ³„éœ²äº†å…·ä½“åˆ—è¡¨ä½¿ç”¨æŠ½è±¡å®ç°çš„ç»†èŠ‚ã€‚\n1 2 3 4 5 6 7 8 9 10 // Bad // AbstractList æ˜¯å„ç§å®ä½“åˆ—è¡¨çš„é€šç”¨å®ç°ã€‚ type AbstractList interface { Add(Entity) Remove(Entity) } // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { AbstractList } 1 2 3 4 5 6 7 8 9 10 11 12 13 // Good // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { list AbstractList } // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *ConcreteList) Add(e Entity) { l.list.Add(e) } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *ConcreteList) Remove(e Entity) { l.list.Remove(e) } æ— è®ºæ˜¯ä½¿ç”¨åµŒå…¥å¼ç»“æ„è¿˜æ˜¯ä½¿ç”¨åµŒå…¥å¼æ¥å£ï¼ŒåµŒå…¥å¼ç±»å‹éƒ½ä¼šé™åˆ¶ç±»å‹çš„æ¼”åŒ–.\nå‘åµŒå…¥å¼æ¥å£æ·»åŠ æ–¹æ³•æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ åˆ é™¤åµŒå…¥ç±»å‹æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ å³ä½¿ä½¿ç”¨æ»¡è¶³ç›¸åŒæ¥å£çš„æ›¿ä»£æ–¹æ³•æ›¿æ¢åµŒå…¥ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ å°½ç®¡ç¼–å†™è¿™äº›å§”æ‰˜æ–¹æ³•æ˜¯ä¹å‘³çš„ï¼Œä½†æ˜¯é¢å¤–çš„å·¥ä½œéšè—äº†å®ç°ç»†èŠ‚ï¼Œç•™ä¸‹äº†æ›´å¤šçš„æ›´æ”¹æœºä¼šï¼Œè¿˜æ¶ˆé™¤äº†åœ¨æ–‡æ¡£ä¸­å‘ç°å®Œæ•´åˆ—è¡¨æ¥å£çš„é—´æ¥æ€§æ“ä½œã€‚\né¿å…ä½¿ç”¨å†…ç½®åç§° Goè¯­è¨€è§„èŒƒlanguage specification æ¦‚è¿°äº†å‡ ä¸ªå†…ç½®çš„ï¼Œ ä¸åº”åœ¨Goé¡¹ç›®ä¸­ä½¿ç”¨çš„åç§°æ ‡è¯†predeclared identifiersã€‚\næ ¹æ®ä¸Šä¸‹æ–‡çš„ä¸åŒï¼Œå°†è¿™äº›æ ‡è¯†ç¬¦ä½œä¸ºåç§°é‡å¤ä½¿ç”¨ï¼Œ å°†åœ¨å½“å‰ä½œç”¨åŸŸï¼ˆæˆ–ä»»ä½•åµŒå¥—ä½œç”¨åŸŸï¼‰ä¸­éšè—åŸå§‹æ ‡è¯†ç¬¦ï¼Œæˆ–è€…æ··æ·†ä»£ç ã€‚ åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼›åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„ä»£ç å¯èƒ½ä¼šå¼•å…¥æ½œåœ¨çš„ã€éš¾ä»¥æ¢å¤çš„é”™è¯¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Bad var error string // `error` ä½œç”¨åŸŸéšå¼è¦†ç›– // or func handleErrorMessage(error string) { // `error` ä½œç”¨åŸŸéšå¼è¦†ç›– } type Foo struct { // è™½ç„¶è¿™äº›å­—æ®µåœ¨æŠ€æœ¯ä¸Šä¸æ„æˆé˜´å½±ï¼Œä½†`error`æˆ–`string`å­—ç¬¦ä¸²çš„é‡æ˜ å°„ç°åœ¨æ˜¯ä¸æ˜ç¡®çš„ã€‚ error error string string } func (f Foo) Error() error { // `error` å’Œ `f.error` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.error } func (f Foo) String() string { // `string` and `f.string` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.string } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // Good var errorMessage string // `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›– // or func handleErrorMessage(msg string) { // `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›– } type Foo struct { // `error` and `string` ç°åœ¨æ˜¯æ˜ç¡®çš„ã€‚ err error str string } func (f Foo) Error() error { return f.err } func (f Foo) String() string { return f.str } æ³¨æ„ï¼Œç¼–è¯‘å™¨åœ¨ä½¿ç”¨é¢„å…ˆåˆ†éš”çš„æ ‡è¯†ç¬¦æ—¶ä¸ä¼šç”Ÿæˆé”™è¯¯ï¼Œ ä½†æ˜¯è¯¸å¦‚go vetä¹‹ç±»çš„å·¥å…·ä¼šæ­£ç¡®åœ°æŒ‡å‡ºè¿™äº›å’Œå…¶ä»–æƒ…å†µä¸‹çš„éšå¼é—®é¢˜ã€‚\né¿å…ä½¿ç”¨ init() å°½å¯èƒ½é¿å…ä½¿ç”¨init()ã€‚å½“init()æ˜¯ä¸å¯é¿å…æˆ–å¯å–çš„ï¼Œä»£ç åº”å…ˆå°è¯•ï¼š\næ— è®ºç¨‹åºç¯å¢ƒæˆ–è°ƒç”¨å¦‚ä½•ï¼Œéƒ½è¦å®Œå…¨ç¡®å®šã€‚ é¿å…ä¾èµ–äºå…¶ä»–init()å‡½æ•°çš„é¡ºåºæˆ–å‰¯ä½œç”¨ã€‚è™½ç„¶init()é¡ºåºæ˜¯æ˜ç¡®çš„ï¼Œä½†ä»£ç å¯ä»¥æ›´æ”¹ï¼Œ å› æ­¤init()å‡½æ•°ä¹‹é—´çš„å…³ç³»å¯èƒ½ä¼šä½¿ä»£ç å˜å¾—è„†å¼±å’Œå®¹æ˜“å‡ºé”™ã€‚ é¿å…è®¿é—®æˆ–æ“ä½œå…¨å±€æˆ–ç¯å¢ƒçŠ¶æ€ï¼Œå¦‚æœºå™¨ä¿¡æ¯ã€ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€ç¨‹åºå‚æ•°/è¾“å…¥ç­‰ã€‚ é¿å…I/Oï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå’Œç³»ç»Ÿè°ƒç”¨ã€‚ ä¸èƒ½æ»¡è¶³è¿™äº›è¦æ±‚çš„ä»£ç å¯èƒ½å±äºè¦ä½œä¸ºmain()è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼ˆæˆ–ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­çš„å…¶ä»–åœ°æ–¹ï¼‰ï¼Œ æˆ–è€…ä½œä¸ºmain()æœ¬èº«çš„ä¸€éƒ¨åˆ†å†™å…¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‰“ç®—ç”±å…¶ä»–ç¨‹åºä½¿ç”¨çš„åº“åº”è¯¥ç‰¹åˆ«æ³¨æ„å®Œå…¨ç¡®å®šæ€§ï¼Œ è€Œä¸æ˜¯æ‰§è¡Œâ€œinit magicâ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // Bad type Foo struct { // ... } var _defaultFoo Foo func init() { _defaultFoo = Foo{ // ... } } type Config struct { // ... } var _config Config func init() { // Bad: åŸºäºå½“å‰ç›®å½• cwd, _ := os.Getwd() // Bad: I/O raw, _ := ioutil.ReadFile( path.Join(cwd, \u0026#34;config\u0026#34;, \u0026#34;config.yaml\u0026#34;), ) yaml.Unmarshal(raw, \u0026amp;_config) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Good var _defaultFoo = Foo{ // ... } // or, ä¸ºäº†æ›´å¥½çš„å¯æµ‹è¯•æ€§: var _defaultFoo = defaultFoo() func defaultFoo() Foo { return Foo{ // ... } } type Config struct { // ... } func loadConfig() Config { cwd, err := os.Getwd() // handle err raw, err := ioutil.ReadFile( path.Join(cwd, \u0026#34;config\u0026#34;, \u0026#34;config.yaml\u0026#34;), ) // handle err var config Config yaml.Unmarshal(raw, \u0026amp;config) return config } è€ƒè™‘åˆ°ä¸Šè¿°æƒ…å†µï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œinit()å¯èƒ½æ›´å¯å–æˆ–æ˜¯å¿…è¦çš„ï¼Œå¯èƒ½åŒ…æ‹¬ï¼š\nä¸èƒ½è¡¨ç¤ºä¸ºå•ä¸ªèµ‹å€¼çš„å¤æ‚è¡¨è¾¾å¼ã€‚ å¯æ’å…¥çš„é’©å­ï¼Œå¦‚database/sqlã€ç¼–ç ç±»å‹æ³¨å†Œè¡¨ç­‰ã€‚ å¯¹Google Cloud Functionså’Œå…¶ä»–å½¢å¼çš„ç¡®å®šæ€§é¢„è®¡ç®—çš„ä¼˜åŒ–ã€‚ è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡ è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡\nåœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨åˆå§‹åŒ–è¦è¿½åŠ çš„åˆ‡ç‰‡æ—¶ä¸ºmake()æä¾›ä¸€ä¸ªå®¹é‡å€¼ã€‚\n1 2 3 4 5 6 7 8 9 // Bad for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } // BenchmarkBad-4 100000000 2.48s 1 2 3 4 5 6 7 8 9 // Good for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0, size) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } // BenchmarkGood-4 100000000 0.21s ä¸»å‡½æ•°é€€å‡ºæ–¹å¼(Exit) Goç¨‹åºä½¿ç”¨os.Exit æˆ–è€… log.Fatal* ç«‹å³é€€å‡º (ä½¿ç”¨panicä¸æ˜¯é€€å‡ºç¨‹åºçš„å¥½æ–¹æ³•ï¼Œè¯· don\u0026rsquo;t panic.)\n**ä»…åœ¨mainï¼ˆï¼‰**ä¸­è°ƒç”¨å…¶ä¸­ä¸€ä¸ª os.Exit æˆ–è€… log.Fatal*ã€‚æ‰€æœ‰å…¶ä»–å‡½æ•°åº”å°†é”™è¯¯è¿”å›åˆ°ä¿¡å·å¤±è´¥ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Bad func main() { body := readFile(path) fmt.Println(body) } func readFile(path string) string { f, err := os.Open(path) if err != nil { log.Fatal(err) } b, err := ioutil.ReadAll(f) if err != nil { log.Fatal(err) } return string(b) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // Good func main() { body, err := readFile(path) if err != nil { log.Fatal(err) } fmt.Println(body) } func readFile(path string) (string, error) { f, err := os.Open(path) if err != nil { return \u0026#34;\u0026#34;, err } b, err := ioutil.ReadAll(f) if err != nil { return \u0026#34;\u0026#34;, err } return string(b), nil } åŸåˆ™ä¸Šï¼šé€€å‡ºçš„å…·æœ‰å¤šç§åŠŸèƒ½çš„ç¨‹åºå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š\nä¸æ˜æ˜¾çš„æ§åˆ¶æµï¼šä»»ä½•å‡½æ•°éƒ½å¯ä»¥é€€å‡ºç¨‹åºï¼Œå› æ­¤å¾ˆéš¾å¯¹æ§åˆ¶æµè¿›è¡Œæ¨ç†ã€‚ éš¾ä»¥æµ‹è¯•ï¼šé€€å‡ºç¨‹åºçš„å‡½æ•°ä¹Ÿå°†é€€å‡ºè°ƒç”¨å®ƒçš„æµ‹è¯•ã€‚è¿™ä½¿å¾—å‡½æ•°å¾ˆéš¾æµ‹è¯•ï¼Œå¹¶å¼•å…¥äº†è·³è¿‡ go test å°šæœªè¿è¡Œçš„å…¶ä»–æµ‹è¯•çš„é£é™©ã€‚ è·³è¿‡æ¸…ç†ï¼šå½“å‡½æ•°é€€å‡ºç¨‹åºæ—¶ï¼Œä¼šè·³è¿‡å·²ç»è¿›å…¥deferé˜Ÿåˆ—é‡Œçš„å‡½æ•°è°ƒç”¨ã€‚è¿™å¢åŠ äº†è·³è¿‡é‡è¦æ¸…ç†ä»»åŠ¡çš„é£é™©ã€‚ ä¸€æ¬¡æ€§é€€å‡º å¦‚æœå¯èƒ½çš„è¯ï¼Œä½ çš„mainï¼ˆï¼‰å‡½æ•°ä¸­æœ€å¤šä¸€æ¬¡ è°ƒç”¨ os.Exitæˆ–è€…log.Fatalã€‚å¦‚æœæœ‰å¤šä¸ªé”™è¯¯åœºæ™¯åœæ­¢ç¨‹åºæ‰§è¡Œï¼Œè¯·å°†è¯¥é€»è¾‘æ”¾åœ¨å•ç‹¬çš„å‡½æ•°ä¸‹å¹¶ä»ä¸­è¿”å›é”™è¯¯ã€‚ è¿™ä¼šç¼©çŸ­ main()å‡½æ•°ï¼Œå¹¶å°†æ‰€æœ‰å…³é”®ä¸šåŠ¡é€»è¾‘æ”¾å…¥ä¸€ä¸ªå•ç‹¬çš„ã€å¯æµ‹è¯•çš„å‡½æ•°ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // Bad package main func main() { args := os.Args[1:] if len(args) != 1 { log.Fatal(\u0026#34;missing file\u0026#34;) } name := args[0] f, err := os.Open(name) if err != nil { log.Fatal(err) } defer f.Close() // å¦‚æœæˆ‘ä»¬è°ƒç”¨log.Fatal åœ¨è¿™æ¡çº¿ä¹‹å // f.Close å°†ä¼šè¢«æ‰§è¡Œ. b, err := ioutil.ReadAll(f) if err != nil { log.Fatal(err) } // ... } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // Good package main func main() { if err := run(); err != nil { log.Fatal(err) } } func run() error { args := os.Args[1:] if len(args) != 1 { return errors.New(\u0026#34;missing file\u0026#34;) } name := args[0] f, err := os.Open(name) if err != nil { return err } defer f.Close() b, err := ioutil.ReadAll(f) if err != nil { return err } // ... } æ€§èƒ½ ä¼˜å…ˆä½¿ç”¨ strconv è€Œä¸æ˜¯ fmt å°†åŸè¯­è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ–ä»å­—ç¬¦ä¸²è½¬æ¢æ—¶ï¼Œstrconvé€Ÿåº¦æ¯”fmtå¿«ã€‚\n1 2 3 4 // Bad for i := 0; i \u0026lt; b.N; i++ { s := fmt.Sprint(rand.Int()) } 1 2 3 4 // Good for i := 0; i \u0026lt; b.N; i++ { s := strconv.Itoa(rand.Int()) } é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢ ä¸è¦åå¤ä»å›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceã€‚ç›¸åï¼Œè¯·æ‰§è¡Œä¸€æ¬¡è½¬æ¢å¹¶æ•è·ç»“æœã€‚\n1 2 3 4 5 6 // Bad for i := 0; i \u0026lt; b.N; i++ { w.Write([]byte(\u0026#34;Hello world\u0026#34;)) } // BenchmarkBad-4 50000000 22.2 ns/op 1 2 3 4 5 6 7 // Good data := []byte(\u0026#34;Hello world\u0026#34;) for i := 0; i \u0026lt; b.N; i++ { w.Write(data) } // BenchmarkGood-4 500000000 3.25 ns/op æŒ‡å®šå®¹å™¨å®¹é‡ å°½å¯èƒ½æŒ‡å®šå®¹å™¨å®¹é‡ï¼Œä»¥ä¾¿ä¸ºå®¹å™¨é¢„å…ˆåˆ†é…å†…å­˜ã€‚è¿™å°†åœ¨æ·»åŠ å…ƒç´ æ—¶æœ€å°åŒ–åç»­åˆ†é…ï¼ˆé€šè¿‡å¤åˆ¶å’Œè°ƒæ•´å®¹å™¨å¤§å°ï¼‰ã€‚\næŒ‡å®šMapå®¹é‡æç¤º åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨ make() åˆå§‹åŒ–çš„æ—¶å€™æä¾›å®¹é‡ä¿¡æ¯\n1 make(map[T1]T2, hint) å‘make()æä¾›å®¹é‡æç¤ºä¼šåœ¨åˆå§‹åŒ–æ—¶å°è¯•è°ƒæ•´mapçš„å¤§å°ï¼Œè¿™å°†å‡å°‘åœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ä¸ºmapé‡æ–°åˆ†é…å†…å­˜ã€‚\næ³¨æ„ï¼Œä¸slicesä¸åŒã€‚map capacityæç¤ºå¹¶ä¸ä¿è¯å®Œå…¨çš„æŠ¢å å¼åˆ†é…ï¼Œè€Œæ˜¯ç”¨äºä¼°è®¡æ‰€éœ€çš„hashmap bucketçš„æ•°é‡ã€‚ å› æ­¤ï¼Œåœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ï¼Œç”šè‡³åœ¨æŒ‡å®šmapå®¹é‡æ—¶ï¼Œä»å¯èƒ½å‘ç”Ÿåˆ†é…ã€‚\n1 2 3 4 5 6 7 8 9 // Bad m := make(map[string]os.FileInfo) files, _ := ioutil.ReadDir(\u0026#34;./files\u0026#34;) for _, f := range files { m[f.Name()] = f } // m æ˜¯åœ¨æ²¡æœ‰å¤§å°æç¤ºçš„æƒ…å†µä¸‹åˆ›å»ºçš„ï¼› åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å¤šåˆ†é…ã€‚ 1 2 3 4 5 6 7 8 9 10 // Good files, _ := ioutil.ReadDir(\u0026#34;./files\u0026#34;) m := make(map[string]os.FileInfo, len(files)) for _, f := range files { m[f.Name()] = f } // m æ˜¯æœ‰å¤§å°æç¤ºåˆ›å»ºçš„ï¼›åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å°‘çš„åˆ†é…ã€‚ æŒ‡å®šåˆ‡ç‰‡å®¹é‡ åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨make()åˆå§‹åŒ–åˆ‡ç‰‡æ—¶æä¾›å®¹é‡ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿½åŠ åˆ‡ç‰‡æ—¶ã€‚\n1 make([]T, length, capacity) ä¸mapsä¸åŒï¼Œslice capacityä¸æ˜¯ä¸€ä¸ªæç¤ºï¼šç¼–è¯‘å™¨å°†ä¸ºæä¾›ç»™make()çš„sliceçš„å®¹é‡åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œ è¿™æ„å‘³ç€åç»­çš„append()`æ“ä½œå°†å¯¼è‡´é›¶åˆ†é…ï¼ˆç›´åˆ°sliceçš„é•¿åº¦ä¸å®¹é‡åŒ¹é…ï¼Œåœ¨æ­¤ä¹‹åï¼Œä»»ä½•appendéƒ½å¯èƒ½è°ƒæ•´å¤§å°ä»¥å®¹çº³å…¶ä»–å…ƒç´ ï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 // Bad for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } // BenchmarkBad-4 100000000 2.48s 1 2 3 4 5 6 7 8 9 // Good for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0, size) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } // BenchmarkGood-4 100000000 0.21s è§„èŒƒ ä¸€è‡´æ€§ æœ¬æ–‡ä¸­æ¦‚è¿°çš„ä¸€äº›æ ‡å‡†éƒ½æ˜¯å®¢è§‚æ€§çš„è¯„ä¼°ï¼Œæ˜¯æ ¹æ®åœºæ™¯ã€ä¸Šä¸‹æ–‡ã€æˆ–è€…ä¸»è§‚æ€§çš„åˆ¤æ–­ï¼›\nä½†æ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œä¿æŒä¸€è‡´.\nä¸€è‡´æ€§çš„ä»£ç æ›´å®¹æ˜“ç»´æŠ¤ã€æ˜¯æ›´åˆç†çš„ã€éœ€è¦æ›´å°‘çš„å­¦ä¹ æˆæœ¬ã€å¹¶ä¸”éšç€æ–°çš„çº¦å®šå‡ºç°æˆ–è€…å‡ºç°é”™è¯¯åæ›´å®¹æ˜“è¿ç§»ã€æ›´æ–°ã€ä¿®å¤ bug\nç›¸åï¼Œåœ¨ä¸€ä¸ªä»£ç åº“ä¸­åŒ…å«å¤šä¸ªå®Œå…¨ä¸åŒæˆ–å†²çªçš„ä»£ç é£æ ¼ä¼šå¯¼è‡´ç»´æŠ¤æˆæœ¬å¼€é”€ã€ä¸ç¡®å®šæ€§å’Œè®¤çŸ¥åå·®ã€‚æ‰€æœ‰è¿™äº›éƒ½ä¼šç›´æ¥å¯¼è‡´é€Ÿåº¦é™ä½ã€ä»£ç å®¡æŸ¥ç—›è‹¦ã€è€Œä¸”å¢åŠ  bug æ•°é‡ã€‚\nå°†è¿™äº›æ ‡å‡†åº”ç”¨äºä»£ç åº“æ—¶ï¼Œå»ºè®®åœ¨ packageï¼ˆæˆ–æ›´å¤§ï¼‰çº§åˆ«è¿›è¡Œæ›´æ”¹ï¼Œå­åŒ…çº§åˆ«çš„åº”ç”¨ç¨‹åºé€šè¿‡å°†å¤šä¸ªæ ·å¼å¼•å…¥åˆ°åŒä¸€ä»£ç ä¸­ï¼Œè¿åäº†ä¸Šè¿°å…³æ³¨ç‚¹ã€‚\nç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ Go è¯­è¨€æ”¯æŒå°†ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ä¸ªç»„å†…ã€‚\n1 2 3 // Bad import \u0026#34;a\u0026#34; import \u0026#34;b\u0026#34; 1 2 3 4 5 // Good import ( \u0026#34;a\u0026#34; \u0026#34;b\u0026#34; ) è¿™åŒæ ·é€‚ç”¨äºå¸¸é‡ã€å˜é‡å’Œç±»å‹å£°æ˜ï¼š\n1 2 3 4 5 6 7 8 9 10 // Bad const a = 1 const b = 2 var a = 1 var b = 2 type Area float64 type Volume float64 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // Good const ( a = 1 b = 2 ) var ( a = 1 b = 2 ) type ( Area float64 Volume float64 ) ä»…å°†ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚ä¸è¦å°†ä¸ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚\n1 2 3 4 5 6 7 8 9 // Bad type Operation int const ( Add Operation = iota + 1 Subtract Multiply EnvVar = \u0026#34;MY_ENV\u0026#34; ) 1 2 3 4 5 6 7 8 9 10 // Good type Operation int const ( Add Operation = iota + 1 Subtract Multiply ) const EnvVar = \u0026#34;MY_ENV\u0026#34; åˆ†ç»„ä½¿ç”¨çš„ä½ç½®æ²¡æœ‰é™åˆ¶ï¼Œä¾‹å¦‚ï¼šä½ å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å®ƒä»¬ï¼š\n1 2 3 4 5 6 7 8 // Bad func f() string { var red = color.New(0xff0000) var green = color.New(0x00ff00) var blue = color.New(0x0000ff) ... } 1 2 3 4 5 6 7 8 9 10 // Good func f() string { var ( red = color.New(0xff0000) green = color.New(0x00ff00) blue = color.New(0x0000ff) ) ... } import åˆ†ç»„ å¯¼å…¥åº”è¯¥åˆ†ä¸ºä¸¤ç»„ï¼š\næ ‡å‡†åº“ å…¶ä»–åº“ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ goimports åº”ç”¨çš„åˆ†ç»„ã€‚\n1 2 3 4 5 6 7 // Bad import ( \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;go.uber.org/atomic\u0026#34; \u0026#34;golang.org/x/sync/errgroup\u0026#34; ) 1 2 3 4 5 6 7 8 // Good import ( \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;go.uber.org/atomic\u0026#34; \u0026#34;golang.org/x/sync/errgroup\u0026#34; ) åŒ…å å½“å‘½ååŒ…æ—¶ï¼Œè¯·æŒ‰ä¸‹é¢è§„åˆ™ç¡®å®šåç§°ï¼š\nå…¨éƒ¨å°å†™ã€‚æ²¡æœ‰å¤§å†™æˆ–ä¸‹åˆ’çº¿ã€‚ å¤§å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é‡å‘½åã€‚ ç®€çŸ­è€Œç®€æ´ã€‚è¯·è®°ä½ï¼Œåœ¨æ¯ä¸ªä½¿ç”¨çš„åœ°æ–¹éƒ½å®Œæ•´æ ‡è¯†äº†è¯¥åç§°ã€‚ ä¸ç”¨å¤æ•°ã€‚ä¾‹å¦‚net/urlï¼Œè€Œä¸æ˜¯net/urlsã€‚ ä¸è¦ç”¨â€œcommonâ€ï¼Œâ€œutilâ€ï¼Œâ€œsharedâ€æˆ–â€œlibâ€ã€‚è¿™äº›æ˜¯ä¸å¥½çš„ï¼Œä¿¡æ¯é‡ä¸è¶³çš„åç§°ã€‚ å¦è¯·å‚é˜… Package Names å’Œ Go åŒ…æ ·å¼æŒ‡å—.\nå‡½æ•°å æˆ‘ä»¬éµå¾ª Go ç¤¾åŒºå…³äºä½¿ç”¨ MixedCaps ä½œä¸ºå‡½æ•°å çš„çº¦å®šã€‚æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œä¸ºäº†å¯¹ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œåˆ†ç»„ï¼Œå‡½æ•°åå¯èƒ½åŒ…å«ä¸‹åˆ’çº¿ï¼Œå¦‚ï¼šTestMyFunction_WhatIsBeingTested.\nå¯¼å…¥åˆ«å å¦‚æœç¨‹åºåŒ…åç§°ä¸å¯¼å…¥è·¯å¾„çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸åŒ¹é…ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å¯¼å…¥åˆ«åã€‚\n1 2 3 4 5 6 import ( \u0026#34;net/http\u0026#34; client \u0026#34;example.com/client-go\u0026#34; trace \u0026#34;example.com/trace/v2\u0026#34; ) åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œé™¤éå¯¼å…¥ä¹‹é—´æœ‰ç›´æ¥å†²çªï¼Œå¦åˆ™åº”é¿å…å¯¼å…¥åˆ«åã€‚\n1 2 3 4 5 6 7 // Bad import ( \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; nettrace \u0026#34;golang.net/x/trace\u0026#34; ) 1 2 3 4 5 6 7 8 // Good import ( \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;runtime/trace\u0026#34; nettrace \u0026#34;golang.net/x/trace\u0026#34; ) å‡½æ•°åˆ†ç»„ä¸é¡ºåº å‡½æ•°åº”æŒ‰ç²—ç•¥çš„è°ƒç”¨é¡ºåºæ’åºã€‚ åŒä¸€æ–‡ä»¶ä¸­çš„å‡½æ•°åº”æŒ‰æ¥æ”¶è€…åˆ†ç»„ã€‚ å› æ­¤ï¼Œå¯¼å‡ºçš„å‡½æ•°åº”å…ˆå‡ºç°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨struct, const, varå®šä¹‰çš„åé¢ã€‚\nåœ¨å®šä¹‰ç±»å‹ä¹‹åï¼Œä½†åœ¨æ¥æ”¶è€…çš„å…¶ä½™æ–¹æ³•ä¹‹å‰ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€ä¸ª newXYZ()/NewXYZ()\nç”±äºå‡½æ•°æ˜¯æŒ‰æ¥æ”¶è€…åˆ†ç»„çš„ï¼Œå› æ­¤æ™®é€šå·¥å…·å‡½æ•°åº”åœ¨æ–‡ä»¶æœ«å°¾å‡ºç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Bad func (s *something) Cost() { return calcCost(s.weights) } type something struct{ ... } func calcCost(n []int) int {...} func (s *something) Stop() {...} func newSomething() *something { return \u0026amp;something{} } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Good type something struct{ ... } func newSomething() *something { return \u0026amp;something{} } func (s *something) Cost() { return calcCost(s.weights) } func (s *something) Stop() {...} func calcCost(n []int) int {...} å‡å°‘åµŒå¥— ä»£ç åº”é€šè¿‡å°½å¯èƒ½å…ˆå¤„ç†é”™è¯¯æƒ…å†µ/ç‰¹æ®Šæƒ…å†µå¹¶å°½æ—©è¿”å›æˆ–ç»§ç»­å¾ªç¯æ¥å‡å°‘åµŒå¥—ã€‚å‡å°‘åµŒå¥—å¤šä¸ªçº§åˆ«çš„ä»£ç çš„ä»£ç é‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 // Bad for _, v := range data { if v.F1 == 1 { v = process(v) if err := v.Call(); err == nil { v.Send() } else { return err } } else { log.Printf(\u0026#34;Invalid v: %v\u0026#34;, v) } } 1 2 3 4 5 6 7 8 9 10 11 12 13 // Good for _, v := range data { if v.F1 != 1 { log.Printf(\u0026#34;Invalid v: %v\u0026#34;, v) continue } v = process(v) if err := v.Call(); err != nil { return err } v.Send() } ä¸å¿…è¦çš„ else å¦‚æœåœ¨ if çš„ä¸¤ä¸ªåˆ†æ”¯ä¸­éƒ½è®¾ç½®äº†å˜é‡ï¼Œåˆ™å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºå•ä¸ª ifã€‚\n1 2 3 4 5 6 7 // Bad var a int if b { a = 100 } else { a = 10 } 1 2 3 4 5 // Good a := 10 if b { a = 100 } é¡¶å±‚å˜é‡å£°æ˜ åœ¨é¡¶å±‚ï¼Œä½¿ç”¨æ ‡å‡†varå…³é”®å­—ã€‚è¯·å‹¿æŒ‡å®šç±»å‹ï¼Œé™¤éå®ƒä¸è¡¨è¾¾å¼çš„ç±»å‹ä¸åŒã€‚\n1 2 3 4 // Bad var _s string = F() func F() string { return \u0026#34;A\u0026#34; } 1 2 3 4 5 6 // Good var _s = F() // ç”±äº F å·²ç»æ˜ç¡®äº†è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰å¿…è¦æ˜¾å¼æŒ‡å®š_s çš„ç±»å‹ // è¿˜æ˜¯é‚£ç§ç±»å‹ func F() string { return \u0026#34;A\u0026#34; } å¦‚æœè¡¨è¾¾å¼çš„ç±»å‹ä¸æ‰€éœ€çš„ç±»å‹ä¸å®Œå…¨åŒ¹é…ï¼Œè¯·æŒ‡å®šç±»å‹ã€‚\n1 2 3 4 5 6 7 8 type myError struct{} func (myError) Error() string { return \u0026#34;error\u0026#34; } func F() myError { return myError{} } var _e error = F() // F è¿”å›ä¸€ä¸ª myError ç±»å‹çš„å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¦ error ç±»å‹ å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨_ä½œä¸ºå‰ç¼€ åœ¨æœªå¯¼å‡ºçš„é¡¶çº§varså’Œconstsï¼Œ å‰é¢åŠ ä¸Šå‰ç¼€_ï¼Œä»¥ä½¿å®ƒä»¬åœ¨ä½¿ç”¨æ—¶æ˜ç¡®è¡¨ç¤ºå®ƒä»¬æ˜¯å…¨å±€ç¬¦å·ã€‚\nä¾‹å¤–ï¼šæœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œåº”ä»¥errå¼€å¤´ã€‚\nåŸºæœ¬ä¾æ®ï¼šé¡¶çº§å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸã€‚ä½¿ç”¨é€šç”¨åç§°å¯èƒ½å¾ˆå®¹æ˜“åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯çš„å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // Bad // foo.go const ( defaultPort = 8080 defaultUser = \u0026#34;user\u0026#34; ) // bar.go func Bar() { defaultPort := 9090 ... fmt.Println(\u0026#34;Default port\u0026#34;, defaultPort) // We will not see a compile error if the first line of // Bar() is deleted. } 1 2 3 4 5 6 7 // Good // foo.go const ( _defaultPort = 8080 _defaultUser = \u0026#34;user\u0026#34; ) ç»“æ„ä½“ä¸­çš„åµŒå…¥ åµŒå…¥å¼ç±»å‹ï¼ˆä¾‹å¦‚ mutexï¼‰åº”ä½äºç»“æ„ä½“å†…çš„å­—æ®µåˆ—è¡¨çš„é¡¶éƒ¨ï¼Œå¹¶ä¸”å¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œå°†åµŒå…¥å¼å­—æ®µä¸å¸¸è§„å­—æ®µåˆ†éš”å¼€ã€‚\n1 2 3 4 5 // Bad type Client struct { version int http.Client } 1 2 3 4 5 6 // Good type Client struct { http.Client version int } å†…åµŒåº”è¯¥æä¾›åˆ‡å®çš„å¥½å¤„ï¼Œæ¯”å¦‚ä»¥è¯­ä¹‰ä¸Šåˆé€‚çš„æ–¹å¼æ·»åŠ æˆ–å¢å¼ºåŠŸèƒ½ã€‚ å®ƒåº”è¯¥åœ¨å¯¹ç”¨æˆ·ä¸åˆ©å½±å“çš„æƒ…å†µä¸‹å®Œæˆè¿™é¡¹å·¥ä½œï¼ˆå¦è¯·å‚è§ï¼šé¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹Avoid Embedding Types in Public Structsï¼‰ã€‚\nåµŒå…¥ ä¸åº”è¯¥:\nçº¯ç²¹æ˜¯ä¸ºäº†ç¾è§‚æˆ–æ–¹ä¾¿ã€‚ ä½¿å¤–éƒ¨ç±»å‹æ›´éš¾æ„é€ æˆ–ä½¿ç”¨ã€‚ å½±å“å¤–éƒ¨ç±»å‹çš„é›¶å€¼ã€‚å¦‚æœå¤–éƒ¨ç±»å‹æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ï¼Œåˆ™åœ¨åµŒå…¥å†…éƒ¨ç±»å‹ä¹‹ååº”è¯¥ä»ç„¶æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ã€‚ ä½œä¸ºåµŒå…¥å†…éƒ¨ç±»å‹çš„å‰¯ä½œç”¨ï¼Œä»å¤–éƒ¨ç±»å‹å…¬å¼€ä¸ç›¸å…³çš„å‡½æ•°æˆ–å­—æ®µã€‚ å…¬å¼€æœªå¯¼å‡ºçš„ç±»å‹ã€‚ å½±å“å¤–éƒ¨ç±»å‹çš„å¤åˆ¶å½¢å¼ã€‚ æ›´æ”¹å¤–éƒ¨ç±»å‹çš„APIæˆ–ç±»å‹è¯­ä¹‰ã€‚ åµŒå…¥å†…éƒ¨ç±»å‹çš„éè§„èŒƒå½¢å¼ã€‚ å…¬å¼€å¤–éƒ¨ç±»å‹çš„å®ç°è¯¦ç»†ä¿¡æ¯ã€‚ å…è®¸ç”¨æˆ·è§‚å¯Ÿæˆ–æ§åˆ¶ç±»å‹å†…éƒ¨ã€‚ é€šè¿‡åŒ…è£…çš„æ–¹å¼æ”¹å˜å†…éƒ¨å‡½æ•°çš„ä¸€èˆ¬è¡Œä¸ºï¼Œè¿™ç§åŒ…è£…æ–¹å¼ä¼šç»™ç”¨æˆ·å¸¦æ¥ä¸€äº›æ„æ–™ä¹‹å¤–æƒ…å†µã€‚ ç®€å•åœ°è¯´ï¼Œæœ‰æ„è¯†åœ°å’Œæœ‰ç›®çš„åœ°åµŒå…¥ã€‚ä¸€ç§å¾ˆå¥½çš„æµ‹è¯•ä½“éªŒæ˜¯ï¼Œ \u0026ldquo;æ˜¯å¦æ‰€æœ‰è¿™äº›å¯¼å‡ºçš„å†…éƒ¨æ–¹æ³•/å­—æ®µéƒ½å°†ç›´æ¥æ·»åŠ åˆ°å¤–éƒ¨ç±»å‹\u0026rdquo; å¦‚æœç­”æ¡ˆæ˜¯someæˆ–noï¼Œä¸è¦åµŒå…¥å†…éƒ¨ç±»å‹-è€Œæ˜¯ä½¿ç”¨å­—æ®µã€‚\n1 2 3 4 5 6 // Bad type A struct { // Bad: A.Lock() and A.Unlock() ç°åœ¨å¯ç”¨ // ä¸æä¾›ä»»ä½•åŠŸèƒ½æ€§å¥½å¤„ï¼Œå¹¶å…è®¸ç”¨æˆ·æ§åˆ¶æœ‰å…³Açš„å†…éƒ¨ç»†èŠ‚ã€‚ sync.Mutex } 1 2 3 4 5 6 7 8 9 10 11 // Good type countingWriteCloser struct { // Good: Write() åœ¨å¤–å±‚æä¾›ç”¨äºç‰¹å®šç›®çš„ï¼Œ // å¹¶ä¸”å§”æ‰˜å·¥ä½œåˆ°å†…éƒ¨ç±»å‹çš„Write()ä¸­ã€‚ io.WriteCloser count int } func (w *countingWriteCloser) Write(bs []byte) (int, error) { w.count += len(bs) return w.WriteCloser.Write(bs) } 1 2 3 4 5 6 7 8 9 10 11 // Bad type Book struct { // Bad: æŒ‡é’ˆæ›´æ”¹é›¶å€¼çš„æœ‰ç”¨æ€§ io.ReadWriter // other fields } // later var b Book b.Read(...) // panic: nil pointer b.String() // panic: nil pointer b.Write(...) // panic: nil pointer 1 2 3 4 5 6 7 8 9 10 11 // Good type Book struct { // Good: æœ‰ç”¨çš„é›¶å€¼ bytes.Buffer // other fields } // later var b Book b.Read(...) // ok b.String() // ok b.Write(...) // ok 1 2 3 4 5 6 7 // Bad type Client struct { sync.Mutex sync.WaitGroup bytes.Buffer url.URL } 1 2 3 4 5 6 7 // Good type Client struct { mtx sync.Mutex wg sync.WaitGroup buf bytes.Buffer url url.URL } æœ¬åœ°å˜é‡å£°æ˜ å¦‚æœå°†å˜é‡æ˜ç¡®è®¾ç½®ä¸ºæŸä¸ªå€¼ï¼Œåˆ™åº”ä½¿ç”¨çŸ­å˜é‡å£°æ˜å½¢å¼ (:=)ã€‚\n1 2 // Bad var s = \u0026#34;foo\u0026#34; 1 2 // Good s := \u0026#34;foo\u0026#34; ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œvar ä½¿ç”¨å…³é”®å­—æ—¶é»˜è®¤å€¼ä¼šæ›´æ¸…æ™°ã€‚ä¾‹å¦‚ï¼Œå£°æ˜ç©ºåˆ‡ç‰‡ã€‚\n1 2 3 4 5 6 7 8 9 // Bad func f(list []int) { filtered := []int{} for _, v := range list { if v \u0026gt; 10 { filtered = append(filtered, v) } } } 1 2 3 4 5 6 7 8 9 // Good func f(list []int) { var filtered []int for _, v := range list { if v \u0026gt; 10 { filtered = append(filtered, v) } } } nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ slice nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é•¿åº¦ä¸º 0 çš„ sliceï¼Œè¿™æ„å‘³ç€ï¼Œ\næ‚¨ä¸åº”æ˜ç¡®è¿”å›é•¿åº¦ä¸ºé›¶çš„åˆ‡ç‰‡ã€‚åº”è¯¥è¿”å›nil æ¥ä»£æ›¿ã€‚ 1 2 3 4 // Bad if x == \u0026#34;\u0026#34; { return []int{} } 1 2 3 4 // Good if x == \u0026#34;\u0026#34; { return nil } è¦æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œè¯·å§‹ç»ˆä½¿ç”¨len(s) == 0ã€‚è€Œé nilã€‚ 1 2 3 4 // Bad func isEmpty(s []string) bool { return s == nil } 1 2 3 4 // Good func isEmpty(s []string) bool { return len(s) == 0 } é›¶å€¼åˆ‡ç‰‡ï¼ˆç”¨varå£°æ˜çš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨make()åˆ›å»ºã€‚ 1 2 3 4 5 6 7 8 9 10 11 // Bad nums := []int{} // or, nums := make([]int) if add1 { nums = append(nums, 1) } if add2 { nums = append(nums, 2) } 1 2 3 4 5 6 7 8 9 10 // Good var nums []int if add1 { nums = append(nums, 1) } if add2 { nums = append(nums, 2) } è®°ä½ï¼Œè™½ç„¶nilåˆ‡ç‰‡æ˜¯æœ‰æ•ˆçš„åˆ‡ç‰‡ï¼Œä½†å®ƒä¸ç­‰äºé•¿åº¦ä¸º0çš„åˆ‡ç‰‡ï¼ˆä¸€ä¸ªä¸ºnilï¼Œå¦ä¸€ä¸ªä¸æ˜¯ï¼‰ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚åºåˆ—åŒ–ï¼‰ï¼Œè¿™ä¸¤ä¸ªåˆ‡ç‰‡çš„å¤„ç†æ–¹å¼å¯èƒ½ä¸åŒã€‚\nç¼©å°å˜é‡ä½œç”¨åŸŸ å¦‚æœæœ‰å¯èƒ½ï¼Œå°½é‡ç¼©å°å˜é‡ä½œç”¨èŒƒå›´ã€‚é™¤éå®ƒä¸ å‡å°‘åµŒå¥—çš„è§„åˆ™å†²çªã€‚\n1 2 3 4 5 // Bad err := ioutil.WriteFile(name, data, 0644) if err != nil { return err } 1 2 3 4 // Good if err := ioutil.WriteFile(name, data, 0644); err != nil { return err } å¦‚æœéœ€è¦åœ¨ if ä¹‹å¤–ä½¿ç”¨å‡½æ•°è°ƒç”¨çš„ç»“æœï¼Œåˆ™ä¸åº”å°è¯•ç¼©å°èŒƒå›´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 // Bad if data, err := ioutil.ReadFile(name); err == nil { err = cfg.Decode(data) if err != nil { return err } fmt.Println(cfg) return nil } else { return err } 1 2 3 4 5 6 7 8 9 10 11 12 // Good data, err := ioutil.ReadFile(name) if err != nil { return err } if err := cfg.Decode(data); err != nil { return err } fmt.Println(cfg) return nil é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜ç¡®(Avoid Naked Parameters) å‡½æ•°è°ƒç”¨ä¸­çš„æ„ä¹‰ä¸æ˜ç¡®çš„å‚æ•°å¯èƒ½ä¼šæŸå®³å¯è¯»æ€§ã€‚å½“å‚æ•°åç§°çš„å«ä¹‰ä¸æ˜æ˜¾æ—¶ï¼Œè¯·ä¸ºå‚æ•°æ·»åŠ  C æ ·å¼æ³¨é‡Š (/* ... */)\n1 2 3 // Bad // func printInfo(name string, isLocal, done bool) printInfo(\u0026#34;foo\u0026#34;, true, true) 1 2 3 // Good // func printInfo(name string, isLocal, done bool) printInfo(\u0026#34;foo\u0026#34;, true /* isLocal */, true /* done */) å¯¹äºä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œè¿˜æœ‰ä¸€ç§æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯å°†ä¸Šé¢çš„ bool ç±»å‹æ¢æˆè‡ªå®šä¹‰ç±»å‹ã€‚å°†æ¥ï¼Œè¯¥å‚æ•°å¯ä»¥æ”¯æŒä¸ä»…ä»…å±€é™äºä¸¤ä¸ªçŠ¶æ€ï¼ˆtrue/falseï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type Region int const ( UnknownRegion Region = iota Local ) type Status int const ( StatusReady Status= iota + 1 StatusDone // Maybe we will have a StatusInProgress in the future. ) func printInfo(name string, region Region, status Status) ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œé¿å…è½¬ä¹‰ Go æ”¯æŒä½¿ç”¨ åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œä¹Ÿå°±æ˜¯ \u0026quot; ` \u0026quot; æ¥è¡¨ç¤ºåŸç”Ÿå­—ç¬¦ä¸²ï¼Œåœ¨éœ€è¦è½¬ä¹‰çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¥æ›¿æ¢ã€‚\nå¯ä»¥è·¨è¶Šå¤šè¡Œå¹¶åŒ…å«å¼•å·ã€‚ä½¿ç”¨è¿™äº›å­—ç¬¦ä¸²å¯ä»¥é¿å…æ›´éš¾é˜…è¯»çš„æ‰‹å·¥è½¬ä¹‰çš„å­—ç¬¦ä¸²ã€‚\n1 2 // Bad wantError := \u0026#34;unknown name:\\\u0026#34;test\\\u0026#34;\u0026#34; 1 2 // Good wantError := `unknown error:\u0026#34;test\u0026#34;` åˆå§‹åŒ–ç»“æ„ä½“ ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ åˆå§‹åŒ–ç»“æ„æ—¶ï¼Œå‡ ä¹åº”è¯¥å§‹ç»ˆæŒ‡å®šå­—æ®µåã€‚ç›®å‰ç”±go vetå¼ºåˆ¶æ‰§è¡Œã€‚\n1 2 // Bad k := User{\u0026#34;John\u0026#34;, \u0026#34;Doe\u0026#34;, true} 1 2 3 4 5 6 // Good k := User{ FirstName: \u0026#34;John\u0026#34;, LastName: \u0026#34;Doe\u0026#34;, Admin: true, } ä¾‹å¤–ï¼šå½“æœ‰3ä¸ªæˆ–æ›´å°‘çš„å­—æ®µæ—¶ï¼Œæµ‹è¯•è¡¨ä¸­çš„å­—æ®µåmayå¯ä»¥çœç•¥ã€‚\n1 2 3 4 5 6 7 tests := []struct{ op Operation want string }{ {Add, \u0026#34;add\u0026#34;}, {Subtract, \u0026#34;subtract\u0026#34;}, } çœç•¥ç»“æ„ä¸­çš„é›¶å€¼å­—æ®µ åˆå§‹åŒ–å…·æœ‰å­—æ®µåçš„ç»“æ„æ—¶ï¼Œé™¤éæä¾›æœ‰æ„ä¹‰çš„ä¸Šä¸‹æ–‡ï¼Œå¦åˆ™å¿½ç•¥å€¼ä¸ºé›¶çš„å­—æ®µã€‚ ä¹Ÿå°±æ˜¯ï¼Œè®©æˆ‘ä»¬è‡ªåŠ¨å°†è¿™äº›è®¾ç½®ä¸ºé›¶å€¼\n1 2 3 4 5 6 7 // Bad user := User{ FirstName: \u0026#34;John\u0026#34;, LastName: \u0026#34;Doe\u0026#34;, MiddleName: \u0026#34;\u0026#34;, Admin: false, } 1 2 3 4 5 // Good user := User{ FirstName: \u0026#34;John\u0026#34;, LastName: \u0026#34;Doe\u0026#34;, } è¿™æœ‰åŠ©äºé€šè¿‡çœç•¥è¯¥ä¸Šä¸‹æ–‡ä¸­çš„é»˜è®¤å€¼æ¥å‡å°‘é˜…è¯»çš„éšœç¢ã€‚åªæŒ‡å®šæœ‰æ„ä¹‰çš„å€¼ã€‚\nåœ¨å­—æ®µåæä¾›æœ‰æ„ä¹‰ä¸Šä¸‹æ–‡çš„åœ°æ–¹åŒ…å«é›¶å€¼ã€‚ä¾‹å¦‚ï¼Œè¡¨é©±åŠ¨æµ‹è¯• ä¸­çš„æµ‹è¯•ç”¨ä¾‹å¯ä»¥å—ç›Šäºå­—æ®µçš„åç§°ï¼Œå³ä½¿å®ƒä»¬æ˜¯é›¶å€¼çš„ã€‚\n1 2 3 4 5 6 7 tests := []struct{ give string want int }{ {give: \u0026#34;0\u0026#34;, want: 0}, // ... } å¯¹é›¶å€¼ç»“æ„ä½¿ç”¨ var å¦‚æœåœ¨å£°æ˜ä¸­çœç•¥äº†ç»“æ„çš„æ‰€æœ‰å­—æ®µï¼Œè¯·ä½¿ç”¨ var å£°æ˜ç»“æ„ã€‚\n1 2 // Bad user := User{} 1 2 // Good var user User è¿™å°†é›¶å€¼ç»“æ„ä¸é‚£äº›å…·æœ‰ç±»ä¼¼äºä¸º[åˆå§‹åŒ– Maps]åˆ›å»ºçš„,åŒºåˆ«äºéé›¶å€¼å­—æ®µçš„ç»“æ„åŒºåˆ†å¼€æ¥ï¼Œ å¹¶ä¸æˆ‘ä»¬æ›´å–œæ¬¢çš„declare empty slicesæ–¹å¼ç›¸åŒ¹é…ã€‚\nåˆå§‹åŒ– Struct å¼•ç”¨ åœ¨åˆå§‹åŒ–ç»“æ„å¼•ç”¨æ—¶ï¼Œè¯·ä½¿ç”¨\u0026amp;T{}ä»£æ›¿new(T)ï¼Œä»¥ä½¿å…¶ä¸ç»“æ„ä½“åˆå§‹åŒ–ä¸€è‡´ã€‚\n1 2 3 4 5 6 // Bad sval := T{Name: \u0026#34;foo\u0026#34;} // inconsistent sptr := new(T) sptr.Name = \u0026#34;bar\u0026#34; 1 2 3 4 // Good sval := T{Name: \u0026#34;foo\u0026#34;} sptr := \u0026amp;T{Name: \u0026#34;bar\u0026#34;} åˆå§‹åŒ– Maps å¯¹äºç©º map è¯·ä½¿ç”¨ make(..) åˆå§‹åŒ–ï¼Œ å¹¶ä¸” map æ˜¯é€šè¿‡ç¼–ç¨‹æ–¹å¼å¡«å……çš„ã€‚ è¿™ä½¿å¾— map åˆå§‹åŒ–åœ¨è¡¨ç°ä¸Šä¸åŒäºå£°æ˜ï¼Œå¹¶ä¸”å®ƒè¿˜å¯ä»¥æ–¹ä¾¿åœ°åœ¨ make åæ·»åŠ å¤§å°æç¤ºã€‚\n1 2 3 4 5 6 7 8 9 // Bad var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = map[T1]T2{} m2 map[T1]T2 ) // å£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥éå¸¸ç›¸ä¼¼çš„ã€‚ 1 2 3 4 5 6 7 8 9 // Good var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = make(map[T1]T2) m2 map[T1]T2 ) // å£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥å·®åˆ«éå¸¸å¤§ã€‚ åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œè¯·åœ¨åˆå§‹åŒ–æ—¶æä¾› map å®¹é‡å¤§å°ï¼Œè¯¦ç»†è¯·çœ‹ æŒ‡å®šMapå®¹é‡æç¤ºã€‚\nå¦å¤–ï¼Œå¦‚æœ map åŒ…å«å›ºå®šçš„å…ƒç´ åˆ—è¡¨ï¼Œåˆ™ä½¿ç”¨ map literals(map åˆå§‹åŒ–åˆ—è¡¨) åˆå§‹åŒ–æ˜ å°„ã€‚\n1 2 3 4 5 // Bad m := make(map[T1]T2, 3) m[k1] = v1 m[k2] = v2 m[k3] = v3 1 2 3 4 5 6 // Good m := map[T1]T2{ k1: v1, k2: v2, k3: v3, } åŸºæœ¬å‡†åˆ™æ˜¯ï¼šåœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨ map åˆå§‹åŒ–åˆ—è¡¨ æ¥æ·»åŠ ä¸€ç»„å›ºå®šçš„å…ƒç´ ã€‚å¦åˆ™ä½¿ç”¨ make (å¦‚æœå¯ä»¥ï¼Œè¯·å°½é‡æŒ‡å®š map å®¹é‡)ã€‚\nå­—ç¬¦ä¸² string format å¦‚æœä½ åœ¨å‡½æ•°å¤–å£°æ˜Printf-style å‡½æ•°çš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œè¯·å°†å…¶è®¾ç½®ä¸ºconstå¸¸é‡ã€‚\nè¿™æœ‰åŠ©äºgo vetå¯¹æ ¼å¼å­—ç¬¦ä¸²æ‰§è¡Œé™æ€åˆ†æã€‚\n1 2 3 // Bad msg := \u0026#34;unexpected values %v, %v\\n\u0026#34; fmt.Printf(msg, 1, 2) 1 2 3 // Good const msg = \u0026#34;unexpected values %v, %v\\n\u0026#34; fmt.Printf(msg, 1, 2) å‘½å Printf æ ·å¼çš„å‡½æ•° å£°æ˜Printf-style å‡½æ•°æ—¶ï¼Œè¯·ç¡®ä¿go vetå¯ä»¥æ£€æµ‹åˆ°å®ƒå¹¶æ£€æŸ¥æ ¼å¼å­—ç¬¦ä¸²ã€‚\nè¿™æ„å‘³ç€æ‚¨åº”å°½å¯èƒ½ä½¿ç”¨é¢„å®šä¹‰çš„Printf-style å‡½æ•°åç§°ã€‚go vetå°†é»˜è®¤æ£€æŸ¥è¿™äº›ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Printf ç³»åˆ—ã€‚\nå¦‚æœä¸èƒ½ä½¿ç”¨é¢„å®šä¹‰çš„åç§°ï¼Œè¯·ä»¥ f ç»“æŸé€‰æ‹©çš„åç§°ï¼šWrapfï¼Œè€Œä¸æ˜¯Wrapã€‚go vetå¯ä»¥è¦æ±‚æ£€æŸ¥ç‰¹å®šçš„ Printf æ ·å¼åç§°ï¼Œä½†åç§°å¿…é¡»ä»¥fç»“å°¾ã€‚\n1 $ go vet -printfuncs=wrapf,statusf å¦è¯·å‚é˜… go vet: Printf family check.\nç¼–ç¨‹æ¨¡å¼ è¡¨é©±åŠ¨æµ‹è¯• å½“æµ‹è¯•é€»è¾‘æ˜¯é‡å¤çš„æ—¶å€™ï¼Œé€šè¿‡ subtests ä½¿ç”¨ table é©±åŠ¨çš„æ–¹å¼ç¼–å†™ case ä»£ç çœ‹ä¸Šå»ä¼šæ›´ç®€æ´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Bad // func TestSplitHostPort(t *testing.T) host, port, err := net.SplitHostPort(\u0026#34;192.0.2.0:8000\u0026#34;) require.NoError(t, err) assert.Equal(t, \u0026#34;192.0.2.0\u0026#34;, host) assert.Equal(t, \u0026#34;8000\u0026#34;, port) host, port, err = net.SplitHostPort(\u0026#34;192.0.2.0:http\u0026#34;) require.NoError(t, err) assert.Equal(t, \u0026#34;192.0.2.0\u0026#34;, host) assert.Equal(t, \u0026#34;http\u0026#34;, port) host, port, err = net.SplitHostPort(\u0026#34;:8000\u0026#34;) require.NoError(t, err) assert.Equal(t, \u0026#34;\u0026#34;, host) assert.Equal(t, \u0026#34;8000\u0026#34;, port) host, port, err = net.SplitHostPort(\u0026#34;1:8\u0026#34;) require.NoError(t, err) assert.Equal(t, \u0026#34;1\u0026#34;, host) assert.Equal(t, \u0026#34;8\u0026#34;, port) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // Good // func TestSplitHostPort(t *testing.T) tests := []struct{ give string wantHost string wantPort string }{ { give: \u0026#34;192.0.2.0:8000\u0026#34;, wantHost: \u0026#34;192.0.2.0\u0026#34;, wantPort: \u0026#34;8000\u0026#34;, }, { give: \u0026#34;192.0.2.0:http\u0026#34;, wantHost: \u0026#34;192.0.2.0\u0026#34;, wantPort: \u0026#34;http\u0026#34;, }, { give: \u0026#34;:8000\u0026#34;, wantHost: \u0026#34;\u0026#34;, wantPort: \u0026#34;8000\u0026#34;, }, { give: \u0026#34;1:8\u0026#34;, wantHost: \u0026#34;1\u0026#34;, wantPort: \u0026#34;8\u0026#34;, }, } for _, tt := range tests { t.Run(tt.give, func(t *testing.T) { host, port, err := net.SplitHostPort(tt.give) require.NoError(t, err) assert.Equal(t, tt.wantHost, host) assert.Equal(t, tt.wantPort, port) }) } å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨ test table çš„æ–¹å¼åœ¨ä»£ç é€»è¾‘æ‰©å±•çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–°å¢ test caseï¼Œéƒ½ä¼šæ˜¾å¾—æ›´åŠ çš„æ¸…æ™°ã€‚\næˆ‘ä»¬éµå¾ªè¿™æ ·çš„çº¦å®šï¼šå°†ç»“æ„ä½“åˆ‡ç‰‡ç§°ä¸ºtestsã€‚ æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç§°ä¸ºttã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é¼“åŠ±ä½¿ç”¨giveå’Œwantå‰ç¼€è¯´æ˜æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥å’Œè¾“å‡ºå€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 tests := []struct{ give string wantHost string wantPort string }{ // ... } for _, tt := range tests { // ... } åŠŸèƒ½é€‰é¡¹ åŠŸèƒ½é€‰é¡¹æ˜¯ä¸€ç§æ¨¡å¼ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å£°æ˜ä¸€ä¸ªä¸é€æ˜ Option ç±»å‹ï¼Œè¯¥ç±»å‹åœ¨æŸäº›å†…éƒ¨ç»“æ„ä¸­è®°å½•ä¿¡æ¯ã€‚æ‚¨æ¥å—è¿™äº›é€‰é¡¹çš„å¯å˜ç¼–å·ï¼Œå¹¶æ ¹æ®å†…éƒ¨ç»“æ„ä¸Šçš„é€‰é¡¹è®°å½•çš„å…¨éƒ¨ä¿¡æ¯é‡‡å–è¡ŒåŠ¨ã€‚\nå°†æ­¤æ¨¡å¼ç”¨äºæ‚¨éœ€è¦æ‰©å±•çš„æ„é€ å‡½æ•°å’Œå…¶ä»–å…¬å…± API ä¸­çš„å¯é€‰å‚æ•°ï¼Œå°¤å…¶æ˜¯åœ¨è¿™äº›åŠŸèƒ½ä¸Šå·²ç»å…·æœ‰ä¸‰ä¸ªæˆ–æ›´å¤šå‚æ•°çš„æƒ…å†µä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Bad // package db func Open( addr string, cache bool, logger *zap.Logger ) (*Connection, error) { // ... } // å¿…é¡»å§‹ç»ˆæä¾›ç¼“å­˜å’Œè®°å½•å™¨å‚æ•°ï¼Œå³ä½¿ç”¨æˆ·å¸Œæœ›ä½¿ç”¨é»˜è®¤å€¼ã€‚ db.Open(addr, db.DefaultCache, zap.NewNop()) db.Open(addr, db.DefaultCache, log) db.Open(addr, false /* cache */, zap.NewNop()) db.Open(addr, false /* cache */, log) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // Good // package db type Option interface { // ... } func WithCache(c bool) Option { // ... } func WithLogger(log *zap.Logger) Option { // ... } // Open creates a connection. func Open( addr string, opts ...Option, ) (*Connection, error) { // ... } // åªæœ‰åœ¨éœ€è¦æ—¶æ‰æä¾›é€‰é¡¹ã€‚ db.Open(addr) db.Open(addr, db.WithLogger(log)) db.Open(addr, db.WithCache(false)) db.Open( addr, db.WithCache(false), db.WithLogger(log), ) æˆ‘ä»¬å»ºè®®å®ç°æ­¤æ¨¡å¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª Option æ¥å£ï¼Œè¯¥æ¥å£ä¿å­˜ä¸€ä¸ªæœªå¯¼å‡ºçš„æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªæœªå¯¼å‡ºçš„ options ç»“æ„ä¸Šè®°å½•é€‰é¡¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 type options struct { cache bool logger *zap.Logger } type Option interface { apply(*options) } type cacheOption bool func (c cacheOption) apply(opts *options) { opts.cache = bool(c) } func WithCache(c bool) Option { return cacheOption(c) } type loggerOption struct { Log *zap.Logger } func (l loggerOption) apply(opts *options) { opts.logger = l.Log } func WithLogger(log *zap.Logger) Option { return loggerOption{Log: log} } // Open creates a connection. func Open( addr string, opts ...Option, ) (*Connection, error) { options := options{ cache: defaultCache, logger: zap.NewNop(), } for _, o := range opts { o.apply(\u0026amp;options) } // ... } æ³¨æ„: è¿˜æœ‰ä¸€ç§ä½¿ç”¨é—­åŒ…å®ç°è¿™ä¸ªæ¨¡å¼çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡ä¸Šé¢çš„æ¨¡å¼ä¸ºä½œè€…æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå¹¶ä¸”æ›´å®¹æ˜“å¯¹ç”¨æˆ·è¿›è¡Œè°ƒè¯•å’Œæµ‹è¯•ã€‚ç‰¹åˆ«æ˜¯ï¼Œåœ¨ä¸å¯èƒ½è¿›è¡Œæ¯”è¾ƒçš„æƒ…å†µä¸‹å®ƒå…è®¸åœ¨æµ‹è¯•å’Œæ¨¡æ‹Ÿä¸­å¯¹é€‰é¡¹è¿›è¡Œæ¯”è¾ƒã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å…è®¸é€‰é¡¹å®ç°å…¶ä»–æ¥å£ï¼ŒåŒ…æ‹¬ fmt.Stringerï¼Œå…è®¸ç”¨æˆ·è¯»å–é€‰é¡¹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚\nè¿˜å¯ä»¥å‚è€ƒä¸‹é¢èµ„æ–™ï¼š\nSelf-referential functions and the design of options Functional options for friendly APIs Linting æ¯”ä»»ä½• \u0026ldquo;blessed\u0026rdquo; linter é›†æ›´é‡è¦çš„æ˜¯ï¼Œlintåœ¨ä¸€ä¸ªä»£ç åº“ä¸­å§‹ç»ˆä¿æŒä¸€è‡´ã€‚\næˆ‘ä»¬å»ºè®®è‡³å°‘ä½¿ç”¨ä»¥ä¸‹lintersï¼Œå› ä¸ºæˆ‘è®¤ä¸ºå®ƒä»¬æœ‰åŠ©äºå‘ç°æœ€å¸¸è§çš„é—®é¢˜ï¼Œå¹¶åœ¨ä¸éœ€è¦è§„å®šçš„æƒ…å†µä¸‹ä¸ºä»£ç è´¨é‡å»ºç«‹ä¸€ä¸ªé«˜æ ‡å‡†ï¼š\nerrcheck ä»¥ç¡®ä¿é”™è¯¯å¾—åˆ°å¤„ç† goimports æ ¼å¼åŒ–ä»£ç å’Œç®¡ç† imports golint æŒ‡å‡ºå¸¸è§çš„æ–‡ä½“é”™è¯¯ govet åˆ†æä»£ç ä¸­çš„å¸¸è§é”™è¯¯ staticcheck å„ç§é™æ€åˆ†ææ£€æŸ¥ Lint Runners æˆ‘ä»¬æ¨è golangci-lint ä½œä¸ºgo-to lintçš„è¿è¡Œç¨‹åºï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºå®ƒåœ¨è¾ƒå¤§çš„ä»£ç åº“ä¸­çš„æ€§èƒ½ä»¥åŠèƒ½å¤ŸåŒæ—¶é…ç½®å’Œä½¿ç”¨è®¸å¤šè§„èŒƒã€‚è¿™ä¸ªrepoæœ‰ä¸€ä¸ªç¤ºä¾‹é…ç½®æ–‡ä»¶.golangci.ymlå’Œæ¨èçš„linterè®¾ç½®ã€‚\ngolangci-lint æœ‰various-linterså¯ä¾›ä½¿ç”¨ã€‚å»ºè®®å°†ä¸Šè¿°lintersä½œä¸ºåŸºæœ¬setï¼Œæˆ‘ä»¬é¼“åŠ±å›¢é˜Ÿæ·»åŠ å¯¹ä»–ä»¬çš„é¡¹ç›®æœ‰æ„ä¹‰çš„ä»»ä½•é™„åŠ lintersã€‚\nvscode å¦‚ä½•é›†æˆ ?\nsettings.json\n1 2 \u0026#34;go.lintTool\u0026#34;: \u0026#34;golangci-lint\u0026#34;, \u0026#34;go.lintFlags\u0026#34;: [\u0026#34;--config=~/.golangci.yml\u0026#34;, \u0026#34;--fast\u0026#34;], é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º .golangci.yml æ–‡ä»¶ï¼Œé…ç½®è¯´æ˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # 2021-06-05 # ixugo # options for analysis running run: timeout: 1m # åˆ†æè¶…æ—¶æ—¶é—´ issues-exit-code: 1 # å‘ç°è‡³å°‘ä¸€ä¸ªé—®é¢˜æ—¶é€€å‡ºä»£ç  tests: true # æ˜¯å¦åŒ…å«æµ‹è¯•æ–‡ä»¶ modules-download-mode: readonly linters: enable: - errcheck # ä»¥ç¡®ä¿é”™è¯¯å¾—åˆ°å¤„ç† - goimports # æ ¼å¼åŒ–ä»£ç å’Œç®¡ç† imports - golint # æŒ‡å‡ºå¸¸è§çš„æ–‡ä½“é”™è¯¯ - govet # åˆ†æä»£ç ä¸­çš„å¸¸è§é”™è¯¯,ä¾‹å¦‚æ•°ä¸æ ¼å¼å­—ç¬¦ä¸²ä¸å¯¹é½çš„ Printf è°ƒç”¨ - staticcheck # å„ç§é™æ€åˆ†ææ£€æŸ¥ - deadcode # æœªä½¿ç”¨çš„ä»£ç  - unused # æœªä½¿ç”¨çš„å¸¸é‡/å˜é‡/å‡½æ•°/ç±»å‹ - varcheck # æœªä½¿ç”¨çš„å…¨å±€å˜é‡/å¸¸é‡ - funlen # æ£€æŸ¥é•¿å‡½æ•°ï¼Œé»˜è®¤ 60 è¡Œ 40 æ¡è¯­å¥ - nestif # æ·±åº¦åµŒå¥—çš„ if è¯­å¥ - unconvert # ä¸å¿…è¦çš„ç±»å‹è½¬æ¢ issues: exclude-use-default: false max-issues-per-linter: 0 max-same-issues: 0 ","date":"2021-06-24T00:00:00Z","permalink":"https://blog.golang.space/p/go-%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/","title":"Go ç¼–ç è§„èŒƒ"},{"content":"Go memory model åœ¨ç¨‹åºå¤„ç†æœŸé—´ä»å¤šä¸ª Go åç¨‹è®¿é—®å…±äº«å†…å­˜æ—¶ã€‚\nå¦‚æœä¸é˜…è¯»å†…å­˜æ¨¡å‹ï¼Œå¯èƒ½å¯¹ç¨‹åºä½œå‡ºé”™è¯¯çš„å‡è®¾ï¼Œè¿™ä¼šå¯¼è‡´ä½ çš„ä»£ç å‡ºé—®é¢˜ã€‚\nä¸è¦åœ¨å…±äº«å†…å­˜ä¸­é€šä¿¡ï¼Œè¦åœ¨é€šä¿¡ä¸­å…±äº«å†…å­˜ã€‚\nGo è¯­è¨€å¹¶å‘æ“ä½œ Goroutines\n1 go hello() // å¼€å¯ä¸€ä¸ªåç¨‹å»æ‰§è¡Œï¼Œä¸ç”¨ç­‰å¾…è¿”å› Channels\n1 2 3 ch := make(chan int, 1) ch \u0026lt;- 10 // å‘é€å€¼åˆ°é€šé“ _ \u0026lt;- ch\t// æ¥æ”¶å€¼ ä¾‹å¦‚\n**åˆ›å»ºä¸€ä¸ª goroutine **\n1 2 3 4 5 6 7 8 9 var a string func f(){ print(a) } func hello(){ a = \u0026#34;helloï¼Œworld\u0026#34; go f() } ä½¿ç”¨ channel\n1 2 3 4 5 6 7 8 9 10 11 12 var c = make(chan int,1) var a string func f(){ a = \u0026#34;hello , world\u0026#34; c \u0026lt;- 0 // æˆ–è€… close(c) } func main(){ go f() \u0026lt;- c // é˜»å¡ç­‰å¾… print(a) } ä½¿ç”¨ channel é™åˆ¶å‡½æ•°åŒæ—¶æ‰§è¡Œæ•°é‡\n1 2 3 4 5 6 7 8 9 10 11 var limit = make(chan int, 3) func main(){ func _,w := range work { go func(w func()){ limit \u0026lt;- 1 w() \u0026lt;-limit }(w) } select{} } ä½¿ç”¨ once ä¿è¯åœ¨å¤šä¸ª goroutine ä¸­ä»…åˆå§‹åŒ–ä¸€æ¬¡\n1 2 3 4 5 6 7 8 9 var a string var once sync.Once func main(){ once.Do(func(){ a = \u0026#34;hello, world\u0026#34; }) print(a) } ä¸é€‚ç”¨é” / ä½¿ç”¨é” / ä½¿ç”¨ channel ä¸‰è€…åŒºåˆ«\ninit åˆå§‹åŒ– å¦‚æœåŒ… X å¯¼å…¥åŒ… Yï¼Œåˆ™ Y çš„ init å‡½æ•°åœ¨è¿è¡Œ X çš„ init å‡½æ•°ä¹‹å‰ã€‚\nMain å‡½æ•°çš„å¼€å§‹æ˜¯åœ¨æ‰€æœ‰ init å‡½æ•°ä¹‹åã€‚\nå‚è€ƒ Go å®˜æ–¹å†…å­˜æ¨¡å‹æ–‡æ¡£\n","date":"2021-05-03T00:00:00Z","permalink":"https://blog.golang.space/p/go-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/","title":"Go å†…å­˜æ¨¡å‹"},{"content":" æ€è€ƒä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆ Go è¯­è¨€åªæä¾›äº† arrayï¼Œslice å’Œ map ç»™æˆ‘ä»¬ç”¨ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰æä¾› æ ˆï¼Œé˜Ÿåˆ—ï¼Œå †ç­‰?\næ€æ ·é«˜æ•ˆçš„å¤„ç†æ•°æ® ? æ€æ ·å†™å‡ºæ¸…æ™°æ˜“æ‡‚çš„ä»£ç ? æ€æ ·æ‰èƒ½æŠŠä»£ç æ‰€å¼•å‘çš„å¼€é”€ç»™å¼ºè°ƒå‡ºæ¥?\nCPU ç¼“å­˜ CPU ä¸€èˆ¬æœ‰ä¸‰çº§ç¼“å­˜å’Œä¸»å†…å­˜ã€‚l1 \u0026gt; l2 \u0026gt; l3 \u0026gt; ä¸»å†…å­˜ï¼Œè®¿é—®é€Ÿåº¦æ˜¯è¶Šæ¥è¶Šæ…¢çš„ï¼Œå†…å­˜ç©ºé—´æ˜¯è¶Šæ¥è¶Šå¤§ã€‚\nä¸€ä¸ªç¼“å­˜è¡Œçš„é•¿åº¦ï¼Œè®¿é—®ç¼“å­˜è¡Œä¸­çš„å…¶ä»–å…ƒç´ ï¼ŒåŸºæœ¬æ˜¯å…è´¹çš„ã€‚æ˜‚è´µçš„æ˜¯è®¿é—®ä¸€ä¸ªæ–°çš„ç¼“å­˜ï¼Œåªæœ‰æˆ‘ä»¬è®¿é—®æ›´å°‘çš„ç¼“å­˜è¡Œæ—¶ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¼šæ›´é«˜æ•ˆã€‚\nå½“ä¸‹çš„é«˜é€Ÿç¼“å­˜è¡Œæ˜¯ 32 æˆ– 64 å­—èŠ‚å®½ï¼Œå…·ä½“å–å†³äºç¡¬ä»¶ã€‚ç¡¬ä»¶å–œæ¬¢æ²¿ç€ç¼“å­˜çº¿çº¿æ€§éå†æ•°æ®å’ŒæŒ‡ä»¤ã€‚\nåˆ‡ç‰‡ï¼šç›´è¾¾ç¼“å­˜å‹å¥½çš„æ€§èƒ½\næ•°ç»„ åº”è¯¥åŸ¹å…»ä¸€ç§ç‰¹è´¨ï¼ŒçŸ¥é“è‡ªå·±æ­£åœ¨åšä»€ä¹ˆï¼Œææ¸…æ¥šä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œè¿™æ ·åšçš„é“ç†å’Œæ•ˆæœï¼Œè¿™æ ·å¯ä»¥åšå‡ºæ›´å¥½çš„è®¾è®¡å†³ç­–ã€‚\nGo è¯­è¨€ä¸­æ•°ç»„çš„å„ä¸ªå…ƒç´ åœ°å€æ˜¯è¿ç»­çš„ï¼Œæ›´ç¬¦åˆ CPU é¢„æµ‹ï¼Œä½¿ç”¨æ•°ç»„çš„ç¨‹åºä¼šæ›´å¿«ã€‚\nCPU æœ‰ä¸‰çº§ç¼“å­˜ï¼Œä¸ºäº†æ›´å¿«ï¼Œå½“ä½ è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå®ƒä¼šé¢„æµ‹ä½ æ¥ä¸‹æ¥è¦è¯»ä»€ä¹ˆï¼Œæå‰æ”¾å…¥ç¼“å­˜ä¸­ã€‚\n1 2 3 4 // æŒ‡é’ˆè¯­ä¹‰éå† for i := range arr { total += arr[i] } 1 2 3 4 // å€¼è¯­ä¹‰éå† for _,v := range arr{ total += v } åˆ‡ç‰‡ è¿™å°†æ˜¯ä½ çš„é¦–é€‰æ•°æ®ç»“æ„ã€‚é™¤éä½ çœŸèƒ½ç¡®å®šè‡ªå·±é‡åˆ°ç‰¹æ®Šæƒ…å†µï¼Œéœ€è¦ç”¨åˆ°é“¾è¡¨ç­‰ç»“æ„ï¼Œå¦åˆ™è¿˜æ˜¯åº”è¯¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨åˆ‡ç‰‡ã€‚è€Œä¸”è¦å°½å¯èƒ½ä½¿ç”¨ç”±å€¼æ„æˆçš„åˆ‡ç‰‡ï¼Œè€Œä¸æ˜¯ç”±æŒ‡é’ˆæ„æˆçš„åˆ‡ç‰‡ã€‚\nä½¿ç”¨ make åˆ›å»ºï¼Œè¿™æ˜¯ Go è¯­è¨€å†…ç½®å‡½æ•°ï¼Œè®©æˆ‘ä»¬å¯ä»¥åˆ›å»ºå‡º 3 ç§å¼•ç”¨ç±»å‹ã€‚\nç›®å‰æˆ‘ä»¬ç”¨åˆ°çš„ç±»å‹åˆ†é’Ÿä¸ºä¸¤ç§:\nå†…ç½®ç±»å‹ ç»“æ„ä½“ç±»å‹(ç”¨æˆ·è‡ªå®šä¹‰) å¼•ç”¨ç±»å‹ ( slice / map / channel / å‡½æ•° / æ¥å£ )ã€‚è¿™æ˜¯å¸¦æœ‰æŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼Œå¦‚æœå°†è¯¥ç±»å‹å˜é‡è®¾ç½®é›¶å€¼ï¼Œç›¸å½“äº nilï¼Œå¥½æ¯”æŒ‡é’ˆè®¾ç½®ä¸º nilã€‚å­—ç¬¦ä¸²å®é™…å¾ˆæ¥è¿‘äºå¼•ç”¨ç±»å‹ï¼Œä½†æ˜¯é›¶å€¼æ˜¯ç©ºä¸²ï¼Œè€Œä¸æ˜¯ nilï¼Œæ‰€ä»¥ä¸èƒ½å½’ç±»åˆ°å¼•ç”¨ç±»å‹ã€‚ slice è·Ÿ å­—ç¬¦ä¸²çš„ç»“æ„æœ‰ç‚¹åƒï¼Œä½†æ˜¯ slice æ¯” å­—ç¬¦ä¸²å¤šä¸€ä¸ª cap å­—æ®µï¼Œè¡¨ç¤ºåˆ‡ç‰‡å®¹é‡ã€‚\né•¿åº¦å’Œå®¹é‡æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢?\né•¿åº¦è¡¨ç¤ºä»å½“å‰ä½ç½®å¼€å§‹ï¼Œå¯èƒ½è®¿é—®å¤šå°‘ä¸ªå…ƒç´ ã€‚\nå®¹é‡è¡¨ç¤ºå°†æ¥æœ‰å¯èƒ½å¢åŠ åˆ°å¤šå°‘ä¸ªå…ƒç´ ï¼Œä¸ºè€ƒè™‘ä»¥åçš„æ‰©å……è€Œè®¾è®¡ã€‚\nå¦‚æœè®¿é—®è¶…è¿‡åˆ‡ç‰‡é•¿åº¦çš„å†…å®¹ï¼Œä¼šå‘ç”Ÿ runtime errorã€‚\n1 2 3 4 5 type slice struct{ array unsafe.Pointer len int cap int } è¿™ä¸ªç»“æ„ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼Œéå¸¸é«˜æ•ˆã€‚ æ•°ç»„ä¼šå°†æ¯ä¸€ä¸ªå…ƒç´ æ‹·è´ï¼Œè€Œåˆ‡ç‰‡åªä¼šæ‹·è´è¿™æ ·ä¸€ä¸ªç»“æ„ï¼Œå ç”¨ 24 å­—èŠ‚ã€‚åˆ‡ç‰‡æœ¬æ¥å°±åº”è¯¥é‡‡ç”¨å€¼è¯­ä¹‰æ“ä½œï¼Œæœ¬æ¥å°±åº”è¯¥ç•™åœ¨ä½¿ç”¨å®ƒçš„é‚£ä¸ªæ ˆé‡Œã€‚\n1 2 3 func inspectSlice(slice []string) { fmt.Printf(\u0026#34;length[%d] capacity[%d]\\n\u0026#34;, len(slice),cap(slice)) } åˆ‡ç‰‡ç»“æ„ä¸­ array æ˜¯æ•°ç»„æŒ‡é’ˆï¼Œæ„å‘³ç€é€šè¿‡ä¿®æ”¹åˆ‡ç‰‡ä¼šäº§ç”Ÿå‰¯ä½œç”¨ã€‚\nnil sliceï¼Œempty slice ä¸ nil Go è¯­è¨€å¯ä»¥é€šè¿‡ nil ä¸ empty æ¥è¡¨è¾¾å¼ä¸åŒçš„æ„æ€ ä½ å¯ä»¥è¿”å›é›¶å€¼åˆ‡ç‰‡æ¥è¡¨ç¤ºé”™è¯¯ empty åˆ‡ç‰‡å¯ä»¥è¡¨ç¤ºé¡ºåˆ©ï¼Œä½†æ˜¯æ²¡æœ‰æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func TestNilSlice(t *testing.T) { // å£°æ˜æœªèµ‹å€¼çš„é›¶å€¼åˆ‡ç‰‡ slice == nil var nilSlice []string require.Nil(t, nilSlice) // å£°æ˜èµ‹å€¼çš„ç©ºåˆ‡ç‰‡ slice != nil emptySlice := []string{} require.NotNil(t, emptySlice) require.Nil(t, nilSliceF()) require.NotNil(t, emptySliceF()) } func nilSliceF() []string { return nil } func emptySliceF() []string { return make([]string, 0) } é›¶åˆ†é…çš„ç©ºç™½ç»“æ„ä½“ å¯ä»¥æ ¹æ®è¿™æ ·çš„ç»“æ„ä½“ï¼Œåˆ›å»ºä¸Šç™¾ä¸‡ä¸ªå€¼ï¼Œä½†ä¸ä¼šå¼•å‘ä»»ä½•åˆ†é…ã€‚\nå› ä¸ºåœ¨è¿è¡Œæ—¶ç¯å¢ƒé‡Œé¢ï¼Œæœ‰ä¸€ä¸ª 8 å­—èŠ‚çš„å›ºå®šå€¼ï¼Œå®ƒå°±åƒä¸€ä¸ªå…¨å±€å˜é‡ä¸€æ ·ï¼Œå¯ä»¥è®©è¿™ç§ç©ºç™½çš„ç»“æ„ä½“å¼•ç”¨ã€‚æ‰€ä»¥æ— è®ºæœ‰å¤šå°‘ä¸ªç©ºç™½ç»“æ„ä½“ï¼Œå®ƒä»¬éƒ½å¯ä»¥æŒ‡å‘è¿™åŒä¸€ä¸ªåœ°å€ã€‚\næ¯”å¦‚ nil slice é‡Œé¢çš„æŒ‡é’ˆï¼Œå°±æ˜¯æŒ‡å‘è¿™ä¸ªç©ºç™½ç»“æ„ä½“ã€‚\n1 var emptyStruct struct{} æ‰©å®¹ å¦‚æœæå‰çŸ¥é“éœ€è¦å¤šå°‘å®¹é‡ï¼Œåœ¨åˆ›å»ºæ—¶æŒ‡å®šï¼Œè¿™èƒ½å‡å°‘éœ€è¦æ‰©å®¹æ—¶çš„å†…å­˜åˆ†é…ã€‚è¿™æ˜¯éå¸¸é«˜æ•ˆçš„!! å³æƒ³è¦å†™å‡ºé«˜æ•ˆçš„ä»£ç ï¼Œé¿å…ä½¿ç”¨ appendå‡½æ•°ï¼Œç›´æ¥æ“ä½œå¯¹åº”ä½ç½®çš„å…ƒç´ ã€‚\nä½†æœ‰å¯èƒ½æˆ‘ä»¬å¹¶ä¸çŸ¥é“åˆ°åº•éœ€è¦æ“ä½œå¤šå°‘æ•°æ®ï¼Œå¯èƒ½æ˜¯ 0 æˆ–æ›´å¤šï¼Œæ²¡åŠæ³•æå‰æŠŠæ•°ç»„åˆ†é…å‡ºæ¥ï¼Œå³ä¾¿åˆ†é…äº†ä¹Ÿå¯èƒ½æµªè´¹ã€‚ä¸ºäº†å°½é‡é™ä½ç¨‹åºæ¶ˆè€—çš„èµ„æºé‡ï¼Œæˆ‘ä»¬å¯èƒ½è¦ç¨å¾®æŸè€—ä¸€ç‚¹æ€§èƒ½ï¼Œè¿™æ ·åšï¼Œè·ŸçœŸæ­£æœ‰å¯èƒ½å½±å“æ€§èƒ½çš„åœ°æ–¹ç›¸æ¯”ï¼Œè¿™ç§æŸè€—ç®—ä¸äº†ä»€ä¹ˆã€‚è¿™æ—¶ï¼Œåªå¥½ä» nil slice å¼€å§‹ã€‚\n1 var data []string é€šè¿‡ append æ‰©å®¹ï¼Œå°†æ–°æ•°æ®æ·»åŠ åˆ°åˆ‡ç‰‡çš„å°¾éƒ¨ã€‚æ³¨æ„å…¶è°ƒç”¨æ–¹å¼ï¼Œè¿™ä¸ªå‡½æ•°çš„ API ç”¨çš„æ˜¯å€¼è¯­ä¹‰ï¼Œè¿™æ˜¯å¾ˆå¥½çš„è®¾è®¡ã€‚è¿™æ ·çš„ API å¯ä»¥å«åšé€šè¿‡ å€¼è¯­ä¹‰ è¿›è¡Œä¿®æ”¹çš„ APIã€‚å®ƒé€šè¿‡å¯¹æˆ‘ä»¬ä¼ å…¥çš„åˆ‡ç‰‡å€¼å¤åˆ¶ï¼Œåœ¨å‰¯æœ¬ä¸Šåšä¿®æ”¹ï¼Œå¹¶è¿”å›ã€‚è¿™å¾ˆé‡è¦ï¼Œå°†ä¿®æ”¹æ•ˆæœéš”ç¦»èµ·æ¥ï¼Œæ— å‰¯ä½œç”¨ã€‚è¿™æ˜¯ä¸€ç§ä¼˜é›…ï¼Œå®‰å…¨è€Œåˆæ¸…æ™°çš„åšæ³•ã€‚\n1 data = append(data, \u0026#34;value\u0026#34;) append ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å—?\nå¦‚æœèµ„æºä¸é‡Šæ”¾ï¼Œåœ¨å†…å­˜é‡Œæ»šé›ªçƒæ…¢æ…¢å¢å¤§ï¼Œè¿™å°±æ˜¯å†…å­˜æ³„æ¼äº†ã€‚å¯ä»¥é€šè¿‡ Go trace å·¥å…·æ£€æŸ¥ï¼Œæ£€æŸ¥ GC åå†…å­˜æ˜¯å¦å¹¶æ²¡æœ‰å‡å°‘ï¼Œè€Œæ˜¯å¢å¤§ã€‚\nå…¸å‹çš„å†…å­˜æ³„æ¼:\næ˜¯å¦æ¯ä¸ª goroutine æ— æ³•è‡ªè¡Œç»ˆæ­¢ï¼ŒæŒæœ‰çš„å¼•ç”¨æ— æ³•é‡Šæ”¾ã€‚ map åªæ·»åŠ æ•°æ®ï¼Œå› æœªæ¸…ç†è€Œä¸€ç›´è†¨èƒ€ã€‚ æŸäº› API ç”¨å®Œåéœ€è¦ä¸»åŠ¨ closeï¼Œä½†å´å¿˜è®°è°ƒç”¨ã€‚ append çš„è¿”å›å€¼æœªèµ‹ç»™å……å½“å‚æ•°çš„å˜é‡ï¼ŒåŸæœ‰æ”¯æŒç»“æ„çš„å¼•ç”¨æ•°é‡æœªæ¸…é›¶ã€‚ å½“åˆ‡ç‰‡çš„ len å’Œ cap ç›¸åŒæ—¶ï¼Œæ­¤æ—¶è°ƒç”¨ append ä¼šåˆ›å»ºä¸€ä¸ªå®¹é‡ç¿»å€çš„æ”¯æ’‘æ•°ç»„ï¼Œç„¶åå°†åŸæ•°ç»„å’Œå‚æ•°å¤åˆ¶è¿‡å»ï¼Œè®©åˆ‡ç‰‡çš„æŒ‡é’ˆæŒ‡å‘æ–°çš„æ•°ç»„ã€‚\næ‰©å®¹è§„åˆ™æ˜¯ä»€ä¹ˆ?\næŸ¥çœ‹æºç  ï¼Œæ³¨æ„è¦åŒºåˆ† 1.18 ç‰ˆæœ¬ å’Œ å°äºå…¶çš„ç‰ˆæœ¬\n1.18 å¼€å§‹\næ‰€éœ€å®¹é‡å¤§äºå®¹é‡ç¿»å€ï¼Œé¢„ä¼°å®¹é‡ç­‰äºæ‰€éœ€å®¹é‡ å¦åˆ™ \u0026lt; 256 æ—¶ï¼Œ2å€æ‰©å®¹ ä» 2 å€æ‰©å®¹åˆ° 1.25 å€å¹³æ»‘è¿‡åº¦æ‰©å®¹ï¼Œå…¬å¼: newcap += (newcap + 3*256) / 4 æœ€åï¼ŒåŒ¹é…å†…å­˜è§„æ ¼ï¼Œå…¬å¼ä¸º 8 * (2*x)ï¼Œx ä¸ºé€’å¢å˜é‡ã€‚ \u0026lt;= 1.17 ä»¥å‰æ˜¯ï¼Œä»…ä½œä¸ºäº†è§£ã€‚\næ‰€éœ€å®¹é‡å¤§äºå®¹é‡ç¿»å€ï¼Œé¢„ä¼°å®¹é‡ç­‰äºæ‰€éœ€å®¹é‡ å¦åˆ™ \u0026lt; 1024 æ—¶ï¼ŒåŒå€æ‰©å®¹ \u0026gt;= 1024 æ—¶ï¼Œ1.25 å€æ‰©å®¹ æœ€åï¼ŒåŒ¹é…å†…å­˜è§„æ ¼ã€‚ åˆ‡ç‰‡çš„é«˜æ•ˆæ“ä½œ 1 2 slice1 := make([]string,5,8) slice2 := slice1[2:2+2] // ä» 2 å¼€å§‹ï¼Œå–ä¸¤ä¸ªå€¼ ä¸Šé¢çš„å†™æ³•ï¼Œå¯ä»¥é«˜æ•ˆçš„åˆ›å»ºå‡ºæ–°çš„åˆ‡ç‰‡å€¼ï¼Œè€Œä¸”æ–°å€¼å’ŒåŸå€¼å¯ä»¥é«˜æ•ˆçš„å…±äº«åŒä¸€ä¸ªæ”¯æ’‘æ•°ç»„ã€‚è¿™æ„å‘³ç€éœ€è¦åˆ†é…åœ¨å †ä¸Šé¢çš„è‡³å¤šåªæœ‰åŸæ¥çš„é‚£ä¸ªæ”¯æ’‘æ•°ç»„ã€‚\næ³¨æ„ï¼Œé€šè¿‡ append å¯¹ slice2 æ·»åŠ å…ƒç´ ï¼Œä¼šå½±å“åˆ° slice1ã€‚å› ä¸ºä¸Šé¢æåˆ°çš„æ˜¯åŒä¸€ä¸ªæ”¯æ’‘æ•°ç»„ã€‚\n1 slice2 := slice1[2:4:4] // ä» 2 å¼€å§‹ï¼Œå–ä¸¤ä¸ªå€¼ã€‚å®¹é‡ä¸º 2ã€‚ åœ¨åˆ›å»ºæ–°åˆ‡ç‰‡å€¼æ—¶ï¼Œå¯ä»¥æŒ‡å®šå®¹é‡ä¸é•¿åº¦ç›¸ç­‰ï¼Œæ­¤æ—¶ä½¿ç”¨ append ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå¹¶å°†æ—§æ•°ç»„å€¼å¤åˆ¶è¿‡å»ï¼Œè¿™æ ·å°±æ¶ˆé™¤äº†ä¸Šé¢çš„å‰¯ä½œç”¨ã€‚ä¸‰ä¸‹æ ‡åˆ¶ä½œåˆ‡ç‰‡çš„æ–¹æ³•ï¼Œè®©ä½ æ—¢å¯ä»¥åœ¨å°¾éƒ¨è¿½åŠ å…ƒç´ ï¼ŒåŒæ—¶åˆä¸ä¼šå½±å“ä½¿ç”¨åŸæ¥é‚£ä¸ªæ”¯æŒæ•°ç»„çš„å…¶å®ƒåˆ‡ç‰‡ã€‚è¿™æ ·å½“ç„¶å¾ˆæ£’ï¼Œä½†æœ‰æ—¶å€™ï¼Œå¯èƒ½éœ€è¦è‡ªå·±å¤åˆ¶ï¼Œå½“ç„¶è¿˜æ˜¯åº”è¯¥å°½é‡å°‘ç”¨å¤åˆ¶æ“ä½œã€‚\nGo è¯­è¨€æä¾›äº†å†…ç½®å‡½æ•°copy ï¼Œå®ƒèƒ½å¤Ÿå°†æºåˆ‡ç‰‡ä¸­çš„å…ƒç´ å¤åˆ¶åˆ°ç›®æ ‡åˆ‡ç‰‡ã€‚\n1 2 slice3 := make([]string,len(slice1)) copy(slice3,slice1) å‡½æ•°å¼ç¼–ç¨‹ å¦‚æœä¸æ³¨æ„é˜²èŒƒå‰¯ä½œç”¨ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šäº§ç”Ÿæƒ³å½“å±é™©çš„ç»“æœã€‚é€šè¿‡æŒ‡é’ˆæ“çºµåˆ‡ç‰‡æ—¶ï¼Œä¿®æ”¹çš„æ˜¯åˆ‡ç‰‡çš„æ”¯æŒæ•°ç»„æ‰€åœ¨çš„å†…å­˜ï¼Œè¿™å½“ç„¶ä¼šè®©ç¨‹åºå†™èµ·æ¥å›°éš¾ä¸€äº›ã€‚å‡å¦‚ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹ï¼Œå°±ä¸ç”¨æ‹…å¿ƒè¿™ç§é—®é¢˜äº†ã€‚\nå‡½æ•°å¼ç¼–ç¨‹ï¼Œæ‰€æœ‰å†…å®¹éƒ½é€šè¿‡å€¼è¯­ä¹‰æ¥æ“çºµï¼Œæ¯ä¸€æ®µä»£ç æ¯ä¸€ä¸ªå‡½æ•°ï¼Œæ“çºµçš„éƒ½æ˜¯å®ƒè‡ªå·±çš„é‚£ä»½æ•°æ®ã€‚å¯æ˜¯è¿™æ ·ï¼Œå°±ä¸èƒ½æ ¹æ®éœ€è¦æŠŠç¨‹åºé€Ÿåº¦ä¼˜åŒ–åˆ°æœ€å¿«ï¼Œè¿™æç°äº† Go è¯­è¨€çš„ä¸€é¡¹ä¼˜åŠ¿ï¼Œå®ƒè®©æˆ‘ä»¬è‡ªå·±å†³å®šï¼Œæ˜¯æ“çºµæ•°å€¼è¿˜æ˜¯æŒ‡é’ˆã€‚\nå¿…é¡»æ³¨æ„ï¼Œé‡‡ç”¨æŒ‡é’ˆè¯­ä¹‰æ“ä½œï¼Œå¿…é¡»å½“å¿ƒè¿™ç§åšæ³•åœ¨ä¿®æ”¹æ•°æ®æ—¶ï¼Œæ˜¯å¦ä¼šå¼•å‘ä»€ä¹ˆé—®é¢˜ã€‚\n1 2 3 4 5 6 // Bad likes := make([]int,3) u1 := \u0026amp;likes[1] // æ§åˆ¶ u1 æŒ‡é’ˆæ¥ä¿®æ”¹æ•°æ® // å¦‚æœ likes å‘ç”Ÿ append æ‰©å®¹ï¼Œu1 ä¿®æ”¹æ˜¯æ—§æ•°æ®ï¼Œä¸”å› ä¸ºæ—§æ•°ç»„è¢«å¼•ç”¨ï¼Œè€Œæ— æ³•é‡Šæ”¾ã€‚ // å¿…é¡»åå¤æ£€æŸ¥è°ƒç”¨ append å‡½æ•°çš„åœ°æ–¹ï¼Œé¿å…æ”¯æ’‘æ•°ç»„å‘ç”Ÿæ›¿æ¢ï¼Œè¿›è€Œç»™ç¨‹åºå¸¦æ¥å‰¯ä½œç”¨ å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡ å­—ç¬¦ä¸²å½’æ ¹ç»“åº•è¿˜æ˜¯ç”±ä¸€ç³»åˆ—å­—èŠ‚ç»„æˆï¼Œæœ€åº•å±‚æ˜¯å­—èŠ‚ï¼Œä¸­é—´ä¸€å±‚å«åšä»£ç ç‚¹ï¼Œæ¯ä¸ªä»£ç ç‚¹éƒ½å¯ä»¥å½“åšä¸€ä¸ª 32 ä½(4 å­—èŠ‚)å€¼ï¼Œåœ¨ä»£ç ç‚¹ä¸Šæ–¹æ˜¯å­—ç¬¦å±‚ã€‚ä»£ç ç‚¹æœ‰å¯èƒ½1 ä¸ªå­—èŠ‚å°±èƒ½è¡¨ç¤ºï¼Œä¹Ÿå¯èƒ½éœ€è¦ 4 ä¸ªå­—èŠ‚æ‰èƒ½è¡¨ç¤ºã€‚\næ±‰å­—éœ€è¦ 3 ä¸ªå­—èŠ‚ è‹±æ–‡å­—æ¯éœ€è¦ 1 ä¸ªå­—èŠ‚ã€‚ å­—ç¬¦ä¸²å¯ä»¥ç”¨ for range æ¥éå†ï¼Œéå†çš„æ˜¯ä»£ç ç‚¹ï¼Œstring(v) å¯ä»¥å°†ä»£ç ç‚¹è½¬ä¸ºå­—ç¬¦ã€‚å€¼éå† v æ˜¯ rune ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å¹¶ä¸æ˜¯çœŸæ­£çš„ç±»å‹ï¼Œè€Œæ˜¯ int32 çš„åˆ«åï¼Œå®é™…ä¸Šï¼Œbyte ç±»å‹æ˜¯ uint8 çš„åˆ«åã€‚\nå¯¹å­—ç¬¦ä¸²åˆ‡ç‰‡æ“ä½œï¼Œè¦å°å¿ƒä¸åŒå­—ç¬¦çš„é•¿åº¦ã€‚å¯ä»¥è½¬ä¸º[]rune åˆ‡ç‰‡æ¥å¤„ç†ã€‚\nfor range for range æ˜¯å€¼è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯éå†æ‹·è´çš„å‰¯æœ¬ã€‚åœ¨éå†ä¸­æ“ä½œåˆ‡ç‰‡ä¸å½±å“éå†ã€‚è¿™æ ·çš„å†™æ³•ä¸€ä¸ªåˆ‡ç‰‡å‘ç”Ÿå˜åŒ–ï¼Œä¸ä¼šå½±å“åˆ°ä½¿ç”¨å¦ä¸€ä¸ªåˆ‡ç‰‡æ‰€æ¶‰åŠçš„ç¨‹åºã€‚\n1 2 3 4 // å€¼è¯­ä¹‰ï¼Œä¸å½±å“ for _,v := range slice1 { slice1 = slice1[:2] } æ˜¯æŒ‡é’ˆè¯­ä¹‰æ—¶ï¼Œå®ƒè®¿é—®çš„å°±æ˜¯åŸæ¥çš„åˆ‡ç‰‡ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ•°ç»„ä¸‹æ ‡æº¢å‡ºã€‚\n1 2 3 for i := range slice1{ slice1 = slice1[:2] } ","date":"2021-05-03T00:00:00Z","permalink":"https://blog.golang.space/p/go-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/","title":"Go å†…å­˜æ¨¡å‹"},{"content":"React Hook useState ä½¿ç”¨ useState å£°æ˜å˜é‡, åŠä¿®æ”¹çŠ¶æ€\n1 2 3 4 5 6 7 function ExampleWithManyStates() { // å£°æ˜å¤šä¸ª state å˜é‡ï¼ const [age, setAge] = useState(42); const [fruit, setFruit] = useState(\u0026#39;banana\u0026#39;); const [todos, setTodos] = useState([{ text: \u0026#39;Learn Hooks\u0026#39; }]); // ... } ä¸åˆ·æ–°çš„å¯¹è±¡åˆå¹¶\n1 Object.assign(obj,{\u0026#34;name\u0026#34;:\u0026#34;list\u0026#34;}) åˆ·æ–°çš„å¯¹è±¡åˆå¹¶\n1 setObj({...obj,name:\u0026#34;list\u0026#34;}) useEffect å‘Šè¯‰ React åœ¨å®Œæˆå¯¹ DOM çš„æ›´æ”¹åè¿è¡Œä½ çš„â€œå‰¯ä½œç”¨â€å‡½æ•°ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼ŒReact ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åè°ƒç”¨å‰¯ä½œç”¨å‡½æ•° â€”â€”åŒ…æ‹¬ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™ã€‚\n1 2 3 4 5 6 const [count, setCount] = useState(0); // ç›¸å½“äº componentDidMount å’Œ componentDidUpdate: useEffect(() =\u0026gt; { // ä½¿ç”¨æµè§ˆå™¨çš„ API æ›´æ–°é¡µé¢æ ‡é¢˜ document.title = `You clicked ${count} times`; }); ä»…ä»…æ‰§è¡Œç¬¬ä¸€æ¬¡ åŠ ä¸€ä¸ª ç©ºæ•°ç»„å³å¯\n1 useEffect(()=\u0026gt;{} , []) ä¸å†™æ•°ç»„ç›‘å¬æ‰€æœ‰çŠ¶æ€ å†™å…¥å‚æ•°, ç›‘å¬å‚æ•°çŠ¶æ€ ç©ºæ•°ç»„, ä»…é¦–æ¬¡æ¸²æŸ“æ‰§è¡Œ ç¬¬ä¸€ä¸ªå‚æ•°å‡½æ•°ä¸­åŠ è¿”å›å€¼, é”€æ¯æ—¶æ‰§è¡Œ 1 2 3 4 userEffect( ()=\u0026gt;{ // æ¸²æŸ“åæ‰§è¡Œ return ()=\u0026gt;{} } ) useRef è·å– dom å…ƒç´ \n1 2 3 4 5 6 const inputEl = useRef(null) \u0026lt;Input inputRef={inputEl} /\u0026gt; inputEl.current å½“å‰å…ƒç´  inputEl.current.value å€¼ useContext ä¸ createContext 1 2 3 4 5 const MyContext = createContext() \u0026lt;MyContext.Provider value={count}\u0026gt; \u0026lt;child\u0026gt;\u0026lt;/child\u0026gt; \u0026lt;/MyContext.Provider\u0026gt; çˆ¶ç»„ä»¶åˆ·æ–°ï¼Œå­ç»„ä»¶ä¸ä¼šåˆ·æ–°\né€šè¿‡å­ç»„ä»¶ç›‘å¬ props ï¼Œé‡æ–°åŠ è½½æ•°æ®ï¼Œè¾¾åˆ°åˆ·æ–°çš„ç›®çš„\n","date":"2021-04-10T15:00:00Z","permalink":"https://blog.golang.space/p/react-hook/","title":"React Hook"},{"content":"ä»å¼€æºé¡¹ç›®å­¦ä¹ ä¼˜é›…çš„å…³é—­ HTTP æœåŠ¡ æœåŠ¡å™¨éš¾å…é‡åˆ°é‡å¯ï¼Œå‡çº§ç­‰é—®é¢˜ã€‚\nå½“æœåŠ¡å™¨å…³é—­çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…æœåŠ¡çªç„¶ä¸­æ–­ï¼Œäº§ç”Ÿçš„ä¸å¯æ§å’Œå†—ä½™æ•°æ®ï¼Œéœ€è¦æœ‰ä»¥ä¸‹è€ƒè™‘ã€‚\næ‘˜æ‰æµé‡ï¼Œé€šè¿‡ç½‘å…³æˆ–è´Ÿè½½å‡è¡¡æ§åˆ¶ æœåŠ¡æ‹’ç»æ–°çš„è¯·æ±‚ ç­‰å¾…å¤„ç†ä¸­çš„è¯·æ±‚ç»“æŸ å¦‚æœä¸Šä¸€æ­¥è¶…æ—¶ï¼Œå¼ºåˆ¶å…³é—­ é‡Šæ”¾èµ„æº å…³é—­æœåŠ¡ å¼ºåˆ¶å…³é—­ï¼Œæ¯”å¦‚å¤šæ¬¡é€€å‡ºä¿¡å· å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 package httpserver import ( \u0026#34;context\u0026#34; \u0026#34;net\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) const ( defaultReadTimeout = 10 * time.Second defaultWriteTimeout = 10 * time.Second defaultAddr = \u0026#34;:8080\u0026#34; defaultShutdownTimeout = 3 * time.Second ) // Server HTTP æœåŠ¡ type Server struct { server *http.Server notify chan error shutdownTimeout time.Duration } // NewServer åˆå§‹åŒ–å¹¶å¯åŠ¨è·¯ç”± func NewServer(handler http.Handler, opts ...Option) *Server { httpSer := http.Server{ Addr: defaultAddr, Handler: handler, ReadTimeout: defaultReadTimeout, WriteTimeout: defaultWriteTimeout, } s := \u0026amp;Server{ server: \u0026amp;httpSer, notify: make(chan error, 1), shutdownTimeout: defaultShutdownTimeout, } for _, opt := range opts { opt(s) } go s.start() return s } func (s *Server) start() { s.notify \u0026lt;- s.server.ListenAndServe() close(s.notify) } // Notify . func (s *Server) Notify() \u0026lt;-chan error { return s.notify } // Shutdown å…³é—­æœåŠ¡ func (s *Server) Shutdown() error { ctx, cancel := context.WithTimeout(context.Background(), s.shutdownTimeout) defer cancel() return s.server.Shutdown(ctx) } // Option ä¿®æ”¹ server ç›¸å…³å‚æ•° type Option func(*Server) // Port ä¿®æ”¹ç«¯å£ func Port(v string) Option { return func(s *Server) { s.server.Addr = net.JoinHostPort(\u0026#34;\u0026#34;, v) } } ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main(){ handler := gin.New() server := httpserver.New(handler) interrupt := make(chan os.Signal, 1) signal.Notify(interrupt, os.Interrupt, syscall.SIGTERM) // ç­‰å¾…ä¿¡å· select { case s := \u0026lt;-interrupt: fmt.Println(\u0026#34;app - Run - signal: \u0026#34; + s.String()) case err = \u0026lt;-httpServer.Notify(): fmt.Printf(\u0026#34;app - Run - httpServer.Notify: %w\u0026#34;, err) } // å…³é—­ err = httpServer.Shutdown() if err != nil { fmt.Printf(\u0026#34;app - Run - httpServer.Shutdown: %w\u0026#34;, err) } } å‚è€ƒ go-clean-template\n","date":"2021-03-22T00:00:00Z","permalink":"https://blog.golang.space/p/%E4%BB%8E%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E4%BC%98%E9%9B%85%E7%9A%84%E5%85%B3%E9%97%AD-http-%E6%9C%8D%E5%8A%A1/","title":"ä»å¼€æºé¡¹ç›®å­¦ä¹ ä¼˜é›…çš„å…³é—­ HTTP æœåŠ¡"},{"content":"zerolog ä»€ä¹ˆæ˜¯ Zerolog ? zerolog åŒ…æä¾›äº†ä¸€ä¸ªä¸“é—¨ç”¨äº JSON è¾“å‡ºçš„ç®€å•å¿«é€Ÿçš„Loggerã€‚\nzerolog çš„ API æ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›å‡ºè‰²çš„ä½“éªŒå’Œä»¤äººæƒŠå¹çš„æ€§èƒ½ã€‚å…¶ç‹¬ç‰¹çš„é“¾å¼ API å…è®¸é€šè¿‡é¿å…å†…å­˜åˆ†é…å’Œåå°„æ¥å†™å…¥ JSON ( æˆ– CBOR ) æ—¥å¿—ã€‚\nuber çš„ zap åº“å¼€åˆ›äº†è¿™ç§æ–¹æ³•ï¼Œzerolog é€šè¿‡æ›´ç®€å•çš„åº”ç”¨ç¼–ç¨‹æ¥å£å’Œæ›´å¥½çš„æ€§èƒ½ï¼Œå°†è¿™ä¸€æ¦‚å¿µæå‡åˆ°äº†æ›´é«˜çš„å±‚æ¬¡ã€‚\nä½¿ç”¨ zerolog å®‰è£… 1 go get -u github.com/rs/zerolog/log Contextual Logger 1 2 3 4 5 6 7 8 9 func TestContextualLogger(t *testing.T) { log := zerolog.New(os.Stdout) log.Info().Str(\u0026#34;content\u0026#34;, \u0026#34;Hello world\u0026#34;).Int(\u0026#34;count\u0026#34;, 3).Msg(\u0026#34;TestContextualLogger\u0026#34;) // æ·»åŠ ä¸Šä¸‹æ–‡ (æ–‡ä»¶å/è¡Œå·/å­—ç¬¦ä¸²) log = log.With().Caller().Str(\u0026#34;foo\u0026#34;, \u0026#34;bar\u0026#34;).Logger() log.Info().Msg(\u0026#34;Hello wrold\u0026#34;) } è¾“å‡º\n1 2 // {\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;content\u0026#34;:\u0026#34;Hello world\u0026#34;,\u0026#34;count\u0026#34;:3,\u0026#34;message\u0026#34;:\u0026#34;TestContextualLogger\u0026#34;} // {\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;caller\u0026#34;:\u0026#34;log_example_test.go:29\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;Hello wrold\u0026#34;} ä¸ zap ç›¸åŒçš„æ˜¯ï¼Œéƒ½å®šä¹‰äº†å¼ºç±»å‹å­—æ®µï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æ”¯æŒå­—æ®µçš„å®Œæ•´åˆ—è¡¨ã€‚\nä¸ zap ä¸åŒçš„æ˜¯ï¼Œzerolog é‡‡ç”¨é“¾å¼è°ƒç”¨ã€‚\nå¤šçº§Logger zerolog æä¾›äº†ä» Trace åˆ° Panic ä¸ƒä¸ªçº§åˆ«\n1 2 3 4 5 6 7 8 // è®¾ç½®æ—¥å¿—çº§åˆ« zerolog.SetGlobalLevel(zerolog.WarnLevel) log.Trace().Msg(\u0026#34;Trace\u0026#34;) log.Debug().Msg(\u0026#34;Debug\u0026#34;) log.Info().Msg(\u0026#34;Info\u0026#34;) log.Warn().Msg(\u0026#34;Warn\u0026#34;) log.Error().Msg(\u0026#34;Error\u0026#34;) log.Log().Msg(\u0026#34;æ²¡æœ‰çº§åˆ«\u0026#34;) è¾“å‡º\n1 2 3 {\u0026#34;level\u0026#34;:\u0026#34;warn\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;Warn\u0026#34;} {\u0026#34;level\u0026#34;:\u0026#34;error\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;Error\u0026#34;} {\u0026#34;message\u0026#34;:\u0026#34;æ²¡æœ‰çº§åˆ«\u0026#34;} æ³¨æ„äº‹é¡¹ 1.zerolog ä¸ä¼šå¯¹é‡å¤çš„å­—æ®µåˆ é™¤\n1 2 3 4 logger := zerolog.New(os.Stderr).With().Timestamp().Logger() logger.Info(). Timestamp(). Msg(\u0026#34;dup\u0026#34;) è¾“å‡º\n1 {\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;time\u0026#34;:1494567715,\u0026#34;time\u0026#34;:1494567715,\u0026#34;message\u0026#34;:\u0026#34;dup\u0026#34;} 2.é“¾å¼è°ƒç”¨å¿…é¡»è°ƒç”¨ Msg æˆ– Msgfï¼ŒSend æ‰èƒ½è¾“å‡ºæ—¥å¿—ï¼ŒSend ç›¸å½“äºè°ƒç”¨ Msg(\u0026quot;\u0026quot;)\n3.ä¸€æ—¦è°ƒç”¨ Msg ï¼ŒEvent å°†ä¼šè¢«å¤„ç† ( æ”¾å›æ± ä¸­æˆ–ä¸¢æ‰ )ï¼Œä¸å…è®¸äºŒæ¬¡è°ƒç”¨ã€‚\näº†è§£æºç  æœ¬æ¬¡zerologçš„æºç åˆ†æåŸºäº zerolog 1.22.0 ç‰ˆæœ¬ï¼Œæºç åˆ†æè¾ƒé•¿ï¼Œå¸Œæœ›å¤§å®¶è€å¿ƒçœ‹å®Œã€‚å¸Œæœ›å¤§å®¶èƒ½æœ‰æ‰€æ”¶è·ã€‚\nçœ‹ä¸€ä¸‹ Logger ç»“æ„ä½“ Logger çš„å‚æ•° w ç±»å‹æ˜¯ LevelWriter æ¥å£ï¼Œç”¨äºå‘ç›®æ ‡è¾“å‡ºäº‹ä»¶ã€‚zerolog.New å‡½æ•°ç”¨æ¥åˆ›å»º Loggerï¼Œçœ‹ä¸‹æ–¹æºç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // ============ log.go === type Logger struct { w LevelWriter // è¾“å‡ºå¯¹è±¡ level Level // æ—¥å¿—çº§åˆ« sampler Sampler // é‡‡æ ·å™¨ context []byte // å­˜å‚¨ä¸Šä¸‹æ–‡ hooks []Hook stack bool } func New(w io.Writer) Logger { if w == nil { // ioutil.Discard æ‰€æœ‰æˆåŠŸæ‰§è¡Œçš„ Write æ“ä½œéƒ½ä¸ä¼šäº§ç”Ÿä»»ä½•å®é™…çš„æ•ˆæœ w = ioutil.Discard } lw, ok := w.(LevelWriter) // ä¼ å…¥çš„ä¸æ˜¯ LevelWriter ç±»å‹ï¼Œå°è£…æˆæ­¤ç±»å‹ if !ok { lw = levelWriterAdapter{w} } // é»˜è®¤è¾“å‡ºæ—¥å¿—çº§åˆ« TraceLevel return Logger{w: lw, level: TraceLevel} } debug äº†è§£è¾“å‡ºæ—¥å¿—æµç¨‹ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ç¬¬ä¸‰è¡Œæ‰“ä¸Šæ–­ç‚¹ã€‚\nä¸‹å›¾è¡¨ç¤ºè¯¥è¡Œä»£ç æ‰§è¡Œæµç¨‹ã€‚\nå¼€å§‹ debug\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // ============ log.go === // Info å¼€å§‹è®°å½•ä¸€æ¡ info çº§åˆ«çš„æ¶ˆæ¯ // ä½ å¿…é¡»åœ¨è¿”å›çš„ *Event ä¸Šè°ƒç”¨ Msg æ‰èƒ½å‘é€äº‹ä»¶ func (l *Logger) Info() *Event { return l.newEvent(InfoLevel, nil) } func (l *Logger) newEvent(level Level, done func(string)) *Event { // åˆ¤æ–­æ˜¯å¦åº”è¯¥è®°å½•çš„çº§åˆ« enabled := l.should(level) if !enabled { return nil } // åˆ›å»ºè®°å½•æ—¥å¿—çš„å¯¹è±¡ e := newEvent(l.w, level) // è®¾ç½® done å‡½æ•° e.done = done // è®¾ç½® hook å‡½æ•° e.ch = l.hooks // è®°å½•æ—¥å¿—çº§åˆ« if level != NoLevel \u0026amp;\u0026amp; LevelFieldName != \u0026#34;\u0026#34; { e.Str(LevelFieldName, LevelFieldMarshalFunc(level)) } // è®°å½•ä¸Šä¸‹æ–‡ if l.context != nil \u0026amp;\u0026amp; len(l.context) \u0026gt; 1 { e.buf = enc.AppendObjectData(e.buf, l.context) } // å †æ ˆè·Ÿè¸ª if l.stack { e.Stack() } return e } should å‡½æ•°ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦è®°å½•æœ¬æ¬¡æ¶ˆæ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 // ============ log.go === // should å¦‚æœåº”è¯¥è¢«è®°å½•ï¼Œåˆ™è¿”å› true func (l *Logger) should(lvl Level) bool { if lvl \u0026lt; l.level || lvl \u0026lt; GlobalLevel() { return false } // é‡‡æ ·åé¢è®² if l.sampler != nil \u0026amp;\u0026amp; !samplingDisabled() { return l.sampler.Sample(lvl) } return true } newEvent å‡½æ•°ä½¿ç”¨ sync.Pool è·å–Eventå¯¹è±¡ï¼Œå¹¶å°† Event å‚æ•°åˆå§‹åŒ–ï¼šæ—¥å¿—çº§åˆ«levelå’Œå†™å…¥å¯¹è±¡LevelWriterã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // ============ event.go === // è¡¨ç¤ºä¸€ä¸ªæ—¥å¿—äº‹ä»¶ type Event struct { buf []byte\t// æ¶ˆæ¯ w LevelWriter // å¾…å†™å…¥çš„ç›®æ ‡æ¥å£ level Level\t// æ—¥å¿—çº§åˆ« done func(msg string)\t// msg å‡½æ•°ç»“æŸäº‹ä»¶ stack bool // é”™è¯¯å †æ ˆè·Ÿè¸ª ch []Hook\t// hook å‡½æ•°ç»„ skipFrame int } func newEvent(w LevelWriter, level Level) *Event { e := eventPool.Get().(*Event) e.buf = e.buf[:0] e.ch = nil // åœ¨å¼€å§‹æ·»åŠ å·¦å¤§æ‹¬å· \u0026#39;{\u0026#39; e.buf = enc.AppendBeginMarker(e.buf) e.w = w e.level = level e.stack = false e.skipFrame = 0 return e } Str å‡½æ•°æ˜¯è´Ÿè´£å°†é”®å€¼å¯¹æ·»åŠ åˆ° bufï¼Œå­—ç¬¦ä¸²ç±»å‹æ·»åŠ åˆ° JSON æ ¼å¼ï¼Œæ¶‰åŠåˆ°ç‰¹æ®Šå­—ç¬¦ç¼–ç é—®é¢˜ï¼Œå¦‚æœæ˜¯ç‰¹æ®Šå­—ç¬¦ï¼Œè°ƒç”¨ appendStringComplex å‡½æ•°è§£å†³ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // ============ event.go === func (e *Event) Str(key, val string) *Event { if e == nil { return e } e.buf = enc.AppendString(enc.AppendKey(e.buf, key), val) return e } // ============ internal/json/base.go === type Encoder struct{} // æ·»åŠ ä¸€ä¸ªæ–° key func (e Encoder) AppendKey(dst []byte, key string) []byte { // éç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒåŠ ä¸ªé€—å· if dst[len(dst)-1] != \u0026#39;{\u0026#39; { dst = append(dst, \u0026#39;,\u0026#39;) } return append(e.AppendString(dst, key), \u0026#39;:\u0026#39;) } // === internal/json/string.go === func (Encoder) AppendString(dst []byte, s string) []byte { // åŒå¼•å·èµ· dst = append(dst, \u0026#39;\u0026#34;\u0026#39;) // éå†å­—ç¬¦ for i := 0; i \u0026lt; len(s); i++ { // æ£€æŸ¥å­—ç¬¦æ˜¯å¦éœ€è¦ç¼–ç  if !noEscapeTable[s[i]] { dst = appendStringComplex(dst, s, i) return append(dst, \u0026#39;\u0026#34;\u0026#39;) } } // ä¸éœ€è¦ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œæ·»åŠ åˆ° dst dst = append(dst, s...) // åŒå¼•å·æ”¶ return append(dst, \u0026#39;\u0026#34;\u0026#39;) } Int å‡½æ•°å°†é”®å€¼(intç±»å‹)å¯¹æ·»åŠ åˆ° bufï¼Œå†…éƒ¨è°ƒç”¨ strconv.AppendInt å‡½æ•°å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // ============ event.go === func (e *Event) Int(key string, i int) *Event { if e == nil { return e } e.buf = enc.AppendInt(enc.AppendKey(e.buf, key), i) return e } // === internal/json/types.go === func (Encoder) AppendInt(dst []byte, val int) []byte { // æ·»åŠ æ•´æ•° return strconv.AppendInt(dst, int64(val), 10) } Msg å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 // === event.go === // Msg æ˜¯å¯¹ msg çš„å°è£…è°ƒç”¨ï¼Œå½“æŒ‡é’ˆæ¥æ”¶å™¨ä¸º nil è¿”å› func (e *Event) Msg(msg string) { if e == nil { return } e.msg(msg) } // msg func (e *Event) msg(msg string) { // è¿è¡Œ hook for _, hook := range e.ch { hook.Run(e, e.level, msg) } // è®°å½•æ¶ˆæ¯ if msg != \u0026#34;\u0026#34; { e.buf = enc.AppendString(enc.AppendKey(e.buf, MessageFieldName), msg) } // åˆ¤æ–­ä¸ä¸º nilï¼Œåˆ™ä½¿ç”¨ defer è°ƒç”¨ done å‡½æ•° if e.done != nil { defer e.done(msg) } // å†™å…¥æ—¥å¿— if err := e.write(); err != nil { if ErrorHandler != nil { ErrorHandler(err) } else { fmt.Fprintf(os.Stderr, \u0026#34;zerolog: could not write event: %v\\n\u0026#34;, err) } } } // å†™å…¥æ—¥å¿— func (e *Event) write() (err error) { if e == nil { return nil } if e.level != Disabled { // å¤§æ‹¬å·æ”¶å°¾ e.buf = enc.AppendEndMarker(e.buf) // æ¢è¡Œ e.buf = enc.AppendLineBreak(e.buf) // å‘ç›®æ ‡å†™å…¥æ—¥å¿— if e.w != nil { // è¿™é‡Œä¼ é€’çš„æ—¥å¿—çº§åˆ«ï¼Œå‡½æ•°å†…å¹¶æ²¡æœ‰ä½¿ç”¨ _, err = e.w.WriteLevel(e.level, e.buf) } } // å°†å¯¹è±¡æ”¾å›æ± ä¸­ putEvent(e) return } // === writer.go === func (lw levelWriterAdapter) WriteLevel(l Level, p []byte) (n int, err error) { return lw.Write(p) } ä»¥ä¸Š debug è®©æˆ‘ä»¬å¯¹æ—¥å¿—è®°å½•æµç¨‹æœ‰äº†å¤§æ¦‚çš„è®¤è¯†ï¼Œæ¥ä¸‹æ¥æ‰©å……ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ã€‚\nä» zerolog å­¦ä¹ é¿å…å†…å­˜åˆ†é… æ¯ä¸€æ¡æ—¥å¿—éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª *Eventå¯¹è±¡ ï¼Œå½“å¤šä¸ª Goroutine æ“ä½œæ—¥å¿—ï¼Œå¯¼è‡´åˆ›å»ºçš„å¯¹è±¡æ•°ç›®å‰§å¢ï¼Œè¿›è€Œå¯¼è‡´ GC å‹åŠ›å¢å¤§ã€‚å½¢æˆ \u0026ldquo;å¹¶å‘å¤§ - å ç”¨å†…å­˜å¤§ - GC ç¼“æ…¢ - å¤„ç†å¹¶å‘èƒ½åŠ›é™ä½ - å¹¶å‘æ›´å¤§\u0026rdquo; è¿™æ ·çš„æ¶æ€§å¾ªç¯ã€‚åœ¨è¿™ä¸ªæ—¶å€™ï¼Œéœ€è¦æœ‰ä¸€ä¸ªå¯¹è±¡æ± ï¼Œç¨‹åºä¸å†è‡ªå·±å•ç‹¬åˆ›å»ºå¯¹è±¡ï¼Œè€Œæ˜¯ä»å¯¹è±¡æ± ä¸­è·å–ã€‚\nä½¿ç”¨ sync.Pool å¯ä»¥å°†æš‚æ—¶ä¸ç”¨çš„å¯¹è±¡ç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡éœ€è¦çš„æ—¶å€™ä»æ± ä¸­å–ï¼Œä¸ç”¨å†æ¬¡ç»è¿‡å†…å­˜åˆ†é…ã€‚\nä¸‹é¢ä»£ç ä¸­ putEvent å‡½æ•°ï¼Œå½“å¯¹è±¡ä¸­è®°å½•æ¶ˆæ¯çš„ buf ä¸è¶…è¿‡ 64KB æ—¶ï¼Œæ”¾å›æ± ä¸­ã€‚è¿™é‡Œæœ‰ä¸ªé“¾æ¥ï¼Œé€šè¿‡è¿™ä¸ª issue 23199äº†è§£åˆ°ä½¿ç”¨åŠ¨æ€å¢é•¿çš„ buffer ä¼šå¯¼è‡´å¤§é‡å†…å­˜è¢«å›ºå®šï¼Œåœ¨æ´»é”çš„æƒ…å†µä¸‹æ°¸è¿œä¸ä¼šé‡Šæ”¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 var eventPool = \u0026amp;sync.Pool{ New: func() interface{} { return \u0026amp;Event{ buf: make([]byte, 0, 500), } }, } func putEvent(e *Event) { // é€‰æ‹©å ç”¨è¾ƒå°å†…å­˜çš„ bufï¼Œå°†å¯¹è±¡æ”¾å›æ± ä¸­ // See https://golang.org/issue/23199 const maxSize = 1 \u0026lt;\u0026lt; 16 // 64KiB if cap(e.buf) \u0026gt; maxSize { return } eventPool.Put(e) } å­¦ä¹ æ—¥å¿—çº§åˆ« ä¸‹é¢ä»£ç ä¸­ï¼ŒåŒ…å«äº†æ—¥å¿—çº§åˆ«ç±»å‹çš„å®šä¹‰ï¼Œæ—¥å¿—çº§åˆ«å¯¹åº”çš„å­—ç¬¦ä¸²å€¼ï¼Œè·å–å­—ç¬¦ä¸²å€¼çš„æ–¹æ³•ä»¥åŠè§£æå­—ç¬¦ä¸²ä¸ºæ—¥å¿—çº§åˆ«ç±»å‹çš„æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 // ============= log.go === // æ—¥å¿—çº§åˆ«ç±»å‹ type Level int8 // å®šä¹‰æ‰€æœ‰æ—¥å¿—çº§åˆ« const ( DebugLevel Level = iota InfoLevel WarnLevel ErrorLevel FatalLevel PanicLevel NoLevel Disabled TraceLevel Level = -1 ) // è¿”å›å½“å‰çº§åˆ«çš„ value func (l Level) String() string { switch l { case TraceLevel: return LevelTraceValue case DebugLevel: return LevelDebugValue case InfoLevel: return LevelInfoValue case WarnLevel: return LevelWarnValue case ErrorLevel: return LevelErrorValue case FatalLevel: return LevelFatalValue case PanicLevel: return LevelPanicValue case Disabled: return \u0026#34;disabled\u0026#34; case NoLevel: return \u0026#34;\u0026#34; } return \u0026#34;\u0026#34; } // ParseLevel å°†çº§åˆ«å­—ç¬¦ä¸²è§£ææˆ zerolog level value // å½“å­—ç¬¦ä¸²ä¸åŒ¹é…ä»»ä½•å·²çŸ¥çº§åˆ«ï¼Œè¿”å›é”™è¯¯ func ParseLevel(levelStr string) (Level, error) { switch levelStr { case LevelFieldMarshalFunc(TraceLevel): return TraceLevel, nil case LevelFieldMarshalFunc(DebugLevel): return DebugLevel, nil case LevelFieldMarshalFunc(InfoLevel): return InfoLevel, nil case LevelFieldMarshalFunc(WarnLevel): return WarnLevel, nil case LevelFieldMarshalFunc(ErrorLevel): return ErrorLevel, nil case LevelFieldMarshalFunc(FatalLevel): return FatalLevel, nil case LevelFieldMarshalFunc(PanicLevel): return PanicLevel, nil case LevelFieldMarshalFunc(Disabled): return Disabled, nil case LevelFieldMarshalFunc(NoLevel): return NoLevel, nil } return NoLevel, fmt.Errorf(\u0026#34;Unknown Level String: \u0026#39;%s\u0026#39;, defaulting to NoLevel\u0026#34;, levelStr) } // ============= globals.go === var ( // ...... // çº§åˆ«å­—æ®µçš„ key åç§° LevelFieldName = \u0026#34;level\u0026#34; // å„ä¸ªçº§åˆ«çš„ value LevelTraceValue = \u0026#34;trace\u0026#34; LevelDebugValue = \u0026#34;debug\u0026#34; LevelInfoValue = \u0026#34;info\u0026#34; LevelWarnValue = \u0026#34;warn\u0026#34; LevelErrorValue = \u0026#34;error\u0026#34; LevelFatalValue = \u0026#34;fatal\u0026#34; LevelPanicValue = \u0026#34;panic\u0026#34; // è¿”å›å½¢å‚çº§åˆ«çš„ value LevelFieldMarshalFunc = func(l Level) string { return l.String() } // ...... ) å…¨å±€æ—¥å¿—çº§åˆ«å‚æ•°\nè¿™é‡Œä½¿ç”¨ atomic æ¥ä¿è¯åŸå­æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œå¤–ç•Œä¸ä¼šçœ‹åˆ°åªæ‰§è¡Œåˆ°ä¸€åŠçš„çŠ¶æ€ï¼ŒåŸå­æ“ä½œç”±åº•å±‚ç¡¬ä»¶æ”¯æŒï¼Œé€šå¸¸æ¯”é”æ›´æœ‰æ•ˆç‡ã€‚\natomic.StoreInt32 ç”¨äºå­˜å‚¨ int32 ç±»å‹çš„å€¼ã€‚\natomic.LoadInt32 ç”¨äºè¯»å– int32 ç±»å‹çš„å€¼ã€‚\nåœ¨æºç ä¸­ï¼Œåšçº§åˆ«åˆ¤æ–­æ—¶ï¼Œå¤šå¤„è°ƒç”¨ GlobalLevel ä»¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // ============= globals.go === var ( gLevel = new(int32) // ...... ) // SetGlobalLevel è®¾ç½®å…¨å±€æ—¥å¿—çº§åˆ« // è¦å…¨å±€ç¦ç”¨æ—¥å¿—ï¼Œå…¥å‚ä¸º Disabled func SetGlobalLevel(l Level) { atomic.StoreInt32(gLevel, int32(l)) } // è¿”å›å½“å‰å…¨å±€æ—¥å¿—çº§åˆ« func GlobalLevel() Level { return Level(atomic.LoadInt32(gLevel)) } å­¦ä¹ å¦‚ä½•å®ç° Hook é¦–å…ˆå®šä¹‰ Hook æ¥å£ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ª Run å‡½æ•°ï¼Œå…¥å‚åŒ…å« Eventï¼Œæ—¥å¿—çº§åˆ«*levelå’Œæ¶ˆæ¯ ( Msg å‡½æ•°çš„å‚æ•° )ã€‚\nç„¶åå®šä¹‰äº† LevelHook ç»“æ„ä½“ï¼Œç”¨äºä¸ºæ¯ä¸ªçº§åˆ«è®¾ç½® Hook ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 // ============= hook.go === // hook æ¥å£ type Hook interface { Run(e *Event, level Level, message string) } // HookFunc å‡½æ•°é€‚é…å™¨ type HookFunc func(e *Event, level Level, message string) // Run å®ç° Hook æ¥å£. func (h HookFunc) Run(e *Event, level Level, message string) { h(e, level, message) } // ä¸ºæ¯ä¸ªçº§åˆ«åº”ç”¨ä¸åŒçš„ hook type LevelHook struct { NoLevelHook, TraceHook, DebugHook, InfoHook, WarnHook, ErrorHook, FatalHook, PanicHook Hook } // Run å®ç° Hook æ¥å£ func (h LevelHook) Run(e *Event, level Level, message string) { switch level { case TraceLevel: if h.TraceHook != nil { h.TraceHook.Run(e, level, message) } case DebugLevel: if h.DebugHook != nil { h.DebugHook.Run(e, level, message) } case InfoLevel: if h.InfoHook != nil { h.InfoHook.Run(e, level, message) } case WarnLevel: if h.WarnHook != nil { h.WarnHook.Run(e, level, message) } case ErrorLevel: if h.ErrorHook != nil { h.ErrorHook.Run(e, level, message) } case FatalLevel: if h.FatalHook != nil { h.FatalHook.Run(e, level, message) } case PanicLevel: if h.PanicHook != nil { h.PanicHook.Run(e, level, message) } case NoLevel: if h.NoLevelHook != nil { h.NoLevelHook.Run(e, level, message) } } } // NewLevelHook åˆ›å»ºä¸€ä¸ª LevelHook func NewLevelHook() LevelHook { return LevelHook{} } åœ¨æºç ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨çš„?\nå®šä¹‰ PrintMsgHook ç»“æ„ä½“å¹¶å®ç° Hook æ¥å£ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™ log.Hook å‡½æ•°ï¼ŒLogger å†…éƒ¨çš„ hooks å‚æ•°ç”¨æ¥ä¿å­˜å¯¹è±¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // ä½¿ç”¨æ¡ˆä¾‹ type PrintMsgHook struct{} // å®ç° Hook æ¥å£ï¼Œç”¨æ¥å‘æ§åˆ¶å°è¾“å‡º msg func (p PrintMsgHook) Run(e *zerolog.Event, l zerolog.Level, msg string) { fmt.Println(msg) } func TestContextualLogger(t *testing.T) { log := zerolog.New(os.Stdout) log = log.Hook(PrintMsgHook{}) log.Info().Msg(\u0026#34;TestContextualLogger\u0026#34;) } æ·»åŠ  hook æºç å¦‚ä¸‹\n1 2 3 4 5 6 7 // ============ log.go === // Hook è¿”å›ä¸€ä¸ªå¸¦æœ‰ hook çš„ Logger func (l Logger) Hook(h Hook) Logger { l.hooks = append(l.hooks, h) return l } è¾“å‡ºæ—¥å¿—å¿…é¡»è°ƒç”¨ msg å‡½æ•°ï¼Œhook å°†åœ¨æ­¤å‡½æ•°çš„å¼€å¤´æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 // ============ event.go === // msg å‡½æ•°ç”¨æ¥è¿è¡Œ hook func (e *Event) msg(msg string) { for _, hook := range e.ch { hook.Run(e, e.level, msg) } // ....... // å†™å…¥æ—¥å¿—ï¼Œæ­¤å‡½æ•°ä¸Šé¢å·²ç»ä»‹ç»è¿‡ï¼Œæ­¤å¤„çœç•¥ // ....... } å­¦ä¹ å¦‚ä½•å¾—åˆ°è°ƒç”¨è€…å‡½æ•°å åœ¨çœ‹ zerolog æºç ä¹‹å‰ï¼Œéœ€è¦çŸ¥é“ä¸€äº›å…³äº runtime.Caller å‡½æ•°çš„å‰ç½®çŸ¥è¯†ï¼Œ\nruntime.Caller å¯ä»¥è·å–ç›¸å…³è°ƒç”¨ goroutine å †æ ˆä¸Šçš„å‡½æ•°è°ƒç”¨çš„æ–‡ä»¶å’Œè¡Œå·ä¿¡æ¯ã€‚\nå‚æ•°skip æ˜¯å †æ ˆå¸§çš„æ•°é‡ï¼Œå½“ skip=0 æ—¶ï¼Œè¾“å‡ºå½“å‰å‡½æ•°ä¿¡æ¯; å½“ skip=1 æ—¶ï¼Œè¾“å‡ºè°ƒç”¨æ ˆä¸Šä¸€å¸§ï¼Œå³è°ƒç”¨å‡½æ•°è€…çš„ä¿¡æ¯ã€‚\nè¿”å›å€¼ä¸º ç¨‹åºè®¡æ•°å™¨ï¼Œæ–‡ä»¶ä½ç½®ï¼Œè¡Œå·ï¼Œæ˜¯å¦èƒ½æ¢å¤ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 // ============ go@1.16.5 runtime/extern.go === func Caller(skip int) (pc uintptr, file string, line int, ok bool) { rpc := make([]uintptr, 1) n := callers(skip+1, rpc[:]) if n \u0026lt; 1 { return } frame, _ := CallersFrames(rpc).Next() return frame.PC, frame.File, frame.Line, frame.PC != 0 } å†çœ‹ zerolog æºç ï¼Œå®šä¹‰ callerHook ç»“æ„ä½“å¹¶å®ç°äº† Hook æ¥å£ï¼Œå®ç°å‡½æ•°ä¸­è°ƒç”¨äº†å‚æ•° *Event æä¾›çš„ caller å‡½æ•°ã€‚\nå…¶ä¸­å…¥å‚ä¸ºé¢„å®šä¹‰å‚æ•° CallerSkipFrameCount å’Œ contextCallerSkipFrameCount ï¼Œå€¼éƒ½ä¸º 2ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // ============ context.go === type callerHook struct { callerSkipFrameCount int } func newCallerHook(skipFrameCount int) callerHook { return callerHook{callerSkipFrameCount: skipFrameCount} } func (ch callerHook) Run(e *Event, level Level, msg string) { switch ch.callerSkipFrameCount { // useGlobalSkipFrameCount æ˜¯ int32 ç±»å‹æœ€å°å€¼ case useGlobalSkipFrameCount: // CallerSkipFrameCount é¢„å®šä¹‰å…¨å±€å˜é‡ï¼Œå€¼ä¸º 2 // contextCallerSkipFrameCount é¢„å®šä¹‰å˜é‡ï¼Œå€¼ä¸º 2 e.caller(CallerSkipFrameCount + contextCallerSkipFrameCount) default: e.caller(ch.callerSkipFrameCount + contextCallerSkipFrameCount) } } // useGlobalSkipFrameCount å€¼:-2147483648 const useGlobalSkipFrameCount = math.MinInt32 // åˆ›å»ºé»˜è®¤ callerHook var ch = newCallerHook(useGlobalSkipFrameCount) // Caller ä¸º Logger æ·»åŠ  hook ï¼Œè¯¥ hook ç”¨äºè®°å½•å‡½æ•°è°ƒç”¨è€…çš„ file:line func (c Context) Caller() Context { c.l = c.l.Hook(ch) return c } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // ============ event.go === func (e *Event) caller(skip int) *Event { if e == nil { return e } _, file, line, ok := runtime.Caller(skip + e.skipFrame) if !ok { return e } // CallerFieldNameæ˜¯é»˜è®¤çš„ key å // CallerMarshalFunc å‡½æ•°ç”¨äºæ‹¼æ¥ file:line e.buf = enc.AppendString(enc.AppendKey(e.buf, CallerFieldName), CallerMarshalFunc(file, line)) return e } ä»æ—¥å¿—é‡‡æ ·ä¸­å­¦ä¹  atomic è¿™ä¸ªä½¿ç”¨æ¡ˆä¾‹ä¸­ï¼ŒTestSample æ¯ç§’å…è®¸ è®°å½•5 æ¡æ¶ˆæ¯ï¼Œè¶…è¿‡åˆ™æ¯ 20 æ¡ä»…è®°å½•ä¸€æ¡\n1 2 3 4 5 6 7 8 9 10 func TestSample(t *testing.T) { sampled := log.Sample(\u0026amp;zerolog.BurstSampler{ Burst: 5, Period: 1 * time.Second, NextSampler: \u0026amp;zerolog.BasicSampler{N: 20}, }) for i := 0; i \u0026lt;= 50; i++ { sampled.Info().Msgf(\u0026#34;logged messages : %2d \u0026#34;, i) } } è¾“å‡ºç»“æœæœ¬æ¥åº”è¯¥è¾“å‡º 50 æ¡æ—¥å¿—ï¼Œä½¿ç”¨äº†é‡‡æ ·ï¼Œåœ¨ä¸€ç§’å†…è¾“å‡ºæœ€å¤§ 5 æ¡æ—¥å¿—ï¼Œå½“å¤§äº 5 æ¡åï¼Œæ¯ 20 æ¡æ—¥å¿—è¾“å‡ºä¸€æ¬¡ã€‚\né‡‡æ ·çš„æµç¨‹ç¤ºæ„å›¾å¦‚ä¸‹\nä¸‹æ–¹æ˜¯å®šä¹‰é‡‡æ ·æ¥å£åŠå®ç°å‡½æ•°çš„æºç ã€‚\nåœ¨ inc å‡½æ•°ä¸­ï¼Œä½¿ç”¨ atomic åŒ…å°†ç«äº‰çš„æ¥æ”¶å™¨å¯¹è±¡çš„å‚æ•°å˜æˆå±€éƒ¨å˜é‡ï¼Œæ˜¯å­¦ä¹  atomic å¾ˆå¥½çš„å®ä¾‹ã€‚å‡½æ•°è¯´æ˜éƒ½å†™åœ¨æ³¨é‡Šé‡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 // =========== sampler.go === // é‡‡æ ·å™¨æ¥å£ type Sampler interface { // å¦‚æœäº‹ä»¶æ˜¯æ ·æœ¬çš„ä¸€éƒ¨åˆ†è¿”å› true Sample(lvl Level) bool } // BasicSampler åŸºæœ¬é‡‡æ ·å™¨ // æ¯ N ä¸ªäº‹ä»¶å‘é€ä¸€æ¬¡ï¼Œä¸è€ƒè™‘æ—¥å¿—çº§åˆ« type BasicSampler struct { N counter uint32 } // å®ç°é‡‡æ ·å™¨æ¥å£ func (s *BasicSampler) Sample(lvl Level) bool { n := s.N if n == 1 { return true } c := atomic.AddUint32(\u0026amp;s.counter, 1) return c%n == 1 } type BurstSampler struct { // è°ƒç”¨ NextSampler ä¹‹å‰æ¯ä¸ªæ—¶é—´æ®µ(Period)è°ƒç”¨çš„æœ€å¤§äº‹ä»¶æ•°é‡ Burst uint32 // å¦‚æœä¸º 0ï¼Œåˆ™å§‹ç»ˆè°ƒç”¨ NextSampler Period time.Duration // é‡‡æ ·å™¨ NextSampler Sampler // ç”¨äºè®¡æ•°åœ¨ä¸€å®šæ—¶é—´å†…(Period)çš„è°ƒç”¨æ•°é‡ counter uint32 // æ—¶é—´æ®µçš„ç»“æŸæ—¶é—´(çº³ç§’)ï¼Œå³ å½“å‰æ—¶é—´+Period resetAt int64 } // å®ç° Sampler æ¥å£ func (s *BurstSampler) Sample(lvl Level) bool { // å½“è®¾ç½®äº† Burst å’Œ Periodï¼Œå¤§äºé›¶æ—¶é™åˆ¶ ä¸€å®šæ—¶é—´å†…çš„æœ€å¤§äº‹ä»¶æ•°é‡ if s.Burst \u0026gt; 0 \u0026amp;\u0026amp; s.Period \u0026gt; 0 { if s.inc() \u0026lt;= s.Burst { return true } } // æ²¡æœ‰é‡‡æ ·å™¨ï¼Œç»“æŸ if s.NextSampler == nil { return false } // è°ƒç”¨é‡‡æ ·å™¨ return s.NextSampler.Sample(lvl) } func (s *BurstSampler) inc() uint32 { // å½“å‰æ—¶é—´ (çº³ç§’) now := time.Now().UnixNano() // é‡ç½®æ—¶é—´ (çº³ç§’) resetAt := atomic.LoadInt64(\u0026amp;s.resetAt) var c uint32 // å½“å‰æ—¶é—´ \u0026gt; é‡ç½®æ—¶é—´ if now \u0026gt; resetAt { c = 1 // é‡ç½® s.counter ä¸º 1 atomic.StoreUint32(\u0026amp;s.counter, c) // è®¡ç®—ä¸‹ä¸€æ¬¡çš„é‡ç½®æ—¶é—´ newResetAt := now + s.Period.Nanoseconds() // æ¯”è¾ƒå‡½æ•°å¼€å¤´è·å–çš„é‡ç½®æ—¶é—´ä¸å­˜å‚¨çš„æ—¶é—´æ˜¯å¦ç›¸ç­‰ // ç›¸ç­‰æ—¶ï¼Œå°†ä¸‹ä¸€æ¬¡çš„é‡ç½®æ—¶é—´å­˜å‚¨åˆ° s.resetAtï¼Œå¹¶è¿”å› true reset := atomic.CompareAndSwapInt64(\u0026amp;s.resetAt, resetAt, newResetAt) if !reset { // åœ¨ä¸Šé¢æ¯”è¾ƒèµ‹å€¼é‚£ä¸€æ­¥æ²¡æœ‰æŠ¢åˆ°çš„ goroutine è®¡æ•°å™¨+1 c = atomic.AddUint32(\u0026amp;s.counter, 1) } } else { c = atomic.AddUint32(\u0026amp;s.counter, 1) } return c } åœ¨ä»£ç ä¸­å¦‚ä½•è°ƒç”¨çš„å‘¢?\nInfo å‡½æ•°åŠå…¶ä»–çº§åˆ«å‡½æ•°éƒ½ä¼šè°ƒç”¨ newEventï¼Œåœ¨è¯¥å‡½æ•°çš„å¼€å¤´ï¼Œ should å‡½æ•°ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è®°å½•çš„æ—¥å¿—çº§åˆ«å’Œé‡‡æ ·ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 // ============ log.go === // should å¦‚æœåº”è¯¥è¢«è®°å½•ï¼Œåˆ™è¿”å› true func (l *Logger) should(lvl Level) bool { if lvl \u0026lt; l.level || lvl \u0026lt; GlobalLevel() { return false } // å¦‚æœä½¿ç”¨äº†é‡‡æ ·ï¼Œåˆ™è°ƒç”¨é‡‡æ ·å‡½æ•°ï¼Œåˆ¤æ–­æœ¬æ¬¡äº‹ä»¶æ˜¯å¦è®°å½• if l.sampler != nil \u0026amp;\u0026amp; !samplingDisabled() { return l.sampler.Sample(lvl) } return true } Doc å…³äºæ›´å¤šzerologçš„ä½¿ç”¨å¯ä»¥å‚è€ƒ https://pkg.go.dev/github.com/rs/zerolog\næ¯”è¾ƒ è¯´æ˜ : ä»¥ä¸‹èµ„æ–™æ¥æºäº zerolog å®˜æ–¹ã€‚ä»æ€§èƒ½åˆ†æä¸Šzerologæ¯”zapå’Œå…¶ä»–loggeråº“æ›´èƒœä¸€ç­¹ï¼Œå…³äºzerologå’Œzapçš„ä½¿ç”¨ï¼Œgopherå¯æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯å…·ä½“è€ƒé‡ã€‚\nè®°å½• 10 ä¸ª KV å­—æ®µçš„æ¶ˆæ¯ :\nLibrary Time Bytes Allocated Objects Allocated zerolog 767 ns/op 552 B/op 6 allocs/op âš¡ zap 848 ns/op 704 B/op 2 allocs/op âš¡ zap (sugared) 1363 ns/op 1610 B/op 20 allocs/op go-kit 3614 ns/op 2895 B/op 66 allocs/op lion 5392 ns/op 5807 B/op 63 allocs/op logrus 5661 ns/op 6092 B/op 78 allocs/op apex/log 15332 ns/op 3832 B/op 65 allocs/op log15 20657 ns/op 5632 B/op 93 allocs/op ä½¿ç”¨ä¸€ä¸ªå·²ç»æœ‰ 10 ä¸ª KV å­—æ®µçš„ logger è®°å½•ä¸€æ¡æ¶ˆæ¯ :\nLibrary Time Bytes Allocated Objects Allocated zerolog 52 ns/op 0 B/op 0 allocs/op âš¡ zap 283 ns/op 0 B/op 0 allocs/op âš¡ zap (sugared) 337 ns/op 80 B/op 2 allocs/op lion 2702 ns/op 4074 B/op 38 allocs/op go-kit 3378 ns/op 3046 B/op 52 allocs/op logrus 4309 ns/op 4564 B/op 63 allocs/op apex/log 13456 ns/op 2898 B/op 51 allocs/op log15 14179 ns/op 2642 B/op 44 allocs/op è®°å½•ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰å­—æ®µæˆ– printf é£æ ¼çš„æ¨¡æ¿ :\nLibrary Time Bytes Allocated Objects Allocated zerolog 50 ns/op 0 B/op 0 allocs/op âš¡ zap 236 ns/op 0 B/op 0 allocs/op standard library 453 ns/op 80 B/op 2 allocs/op âš¡ zap (sugared) 337 ns/op 80 B/op 2 allocs/op go-kit 508 ns/op 656 B/op 13 allocs/op lion 771 ns/op 1224 B/op 10 allocs/op logrus 1244 ns/op 1505 B/op 27 allocs/op apex/log 2751 ns/op 584 B/op 11 allocs/op log15 5181 ns/op 1592 B/op 26 allocs/op ç›¸ä¼¼çš„åº“ logrus åŠŸèƒ½å¼ºå¤§\nzap éå¸¸å¿«é€Ÿï¼Œç»“æ„åŒ–ï¼Œåˆ†çº§\nå‚è€ƒèµ„æ–™ zerolog å®˜æ–¹æ–‡æ¡£\n","date":"2021-02-18T15:00:00Z","permalink":"https://blog.golang.space/p/%E4%BB%8E%E6%BA%90%E7%A0%81%E4%BA%86%E8%A7%A3-zerolog/","title":"ä»æºç äº†è§£ zerolog"},{"content":"æœ¬æ–‡ç¿»è¯‘è‡ª https://ioshellboy.medium.com/circuit-breakers-in-golang-1779da9b001ï¼Œç”±äºæœ¬äººç¿»è¯‘æ°´å¹³æœ‰é™ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„çƒ¦è¯·æŒ‡å‡ºã€‚\nGo ä¸­ä½¿ç”¨ç†”æ–­å™¨ å½“ä½ çœ‹åˆ° â€œç†”æ–­å™¨â€ è¿™ä¸ªæœ¯è¯­æ—¶ï¼Œä½ ä¼šæƒ³åˆ°ä»€ä¹ˆå‘¢?\nä»å›¾ç‰‡å­—é¢æ„æ€ç†è§£æ˜¯ä½¿ç”¨é”¤å­ç ´åäº†ä¸€ä¸ªç”µè·¯ã€‚\næˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šåœ¨è‡ªå·±å®¶é‡Œå®‰è£…ç†”æ–­å™¨ï¼Œä»¥é˜»æ­¢å¼‚å¸¸çš„ç”µæµä»ç”µç½‘æµå‘è‡ªå·±ä½å®…ã€‚åœ¨å¼€å§‹â€œå¾®æœåŠ¡çš„ç†”æ–­å™¨â€ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªå…¸å‹çš„ç†”æ–­å™¨è£…ç½®æœ‰ 2 ä¸ªä¸»è¦éƒ¨ä»¶:\nç”¨ç«çº¿ç´§ç´§åŒ…è£¹çš„è½¯é“èŠ¯ è§¦ä½“ã€‚åªè¦æ¥è§¦ç‚¹èƒ½å¤Ÿå½¢æˆä¸€ä¸ªè¿æ¥ç‚¹ï¼Œç”µæµå°±ä¼šä»å¤–éƒ¨ç”µæºæµå‘æˆ‘ä»¬çš„æˆ¿å­ã€‚ç›¸åï¼Œå¦‚æœè¿æ¥æ–­å¼€ï¼Œç”µæµå°±åœæ­¢æµåŠ¨ã€‚ å½“ç”µæµé€šè¿‡ç¼ ç»•åœ¨è½¯é“èŠ¯å‘¨å›´çš„å¯¼çº¿æ—¶ï¼Œè½¯é“èŠ¯å°±åƒä¸€å—ç”µç£é“ï¼Œå½“æµè¿‡å®ƒçš„ç”µæµé«˜äºé¢„æœŸçš„å®‰åŸ¹æ—¶ï¼Œç”µç£é“å°±ä¼šå˜å¾—å¼ºå¤§åˆ°è¶³ä»¥å¸å¼•é‚»è¿‘çš„è§¦ç‚¹ï¼Œä»è€Œå¯¼è‡´çŸ­è·¯ã€‚\næ‚¨ä¸€å®šåœ¨æƒ³ï¼Œè¿™ä¸å¾®æœåŠ¡æ¶æ„æœ‰ä»€ä¹ˆå…³ç³»ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™æ˜¯é«˜åº¦ç›¸å…³çš„ï¼Œæ­£å¦‚æˆ‘ä»¬å°†è¦çœ‹åˆ°çš„ï¼\nå¾®æœåŠ¡æ¶æ„ä¸­çš„çº§è”æ•…éšœ å¾®æœåŠ¡æ¶æ„å·²ç»å¾ˆå¥½åœ°å–ä»£äº†å•ä½“æ¶æ„ï¼Œä½†æ˜¯ä¸ºäº†ä½¿æˆ‘ä»¬çš„ç³»ç»Ÿå…·æœ‰é«˜åº¦çš„å¼¹æ€§ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è§£å†³ä¸€äº›å…³é”®é—®é¢˜ã€‚\nå¾®æœåŠ¡çš„ä¸€ä¸ªé—®é¢˜æ˜¯çº§è”æ•…éšœã€‚ä¸¾ä¸€ä¸ªä¾‹å­æ¥æ›´å¥½åœ°ç†è§£å®ƒã€‚\nåœ¨ä¸Šå›¾ä¸­ï¼Œå‚ä¸è€…è°ƒç”¨æˆ‘ä»¬çš„ä¸»æœåŠ¡ï¼Œå®ƒä¾èµ–äºä¸Šæ¸¸æœåŠ¡ãƒ¼ Aï¼ŒBï¼ŒCã€‚ç°åœ¨å‡å®šï¼ŒæœåŠ¡ A æ˜¯ä¸€ä¸ªè¯»å–é‡è¾ƒå¤§çš„ç³»ç»Ÿï¼Œå®ƒä¾èµ–äºæ•°æ®åº“ã€‚è¿™ä¸ªæ•°æ®åº“æœ‰å…¶è‡ªèº«çš„å±€é™æ€§ï¼Œå¹¶ä¸”åœ¨è¿‡è½½æ—¶ï¼Œå¯èƒ½å¯¼è‡´è¿æ¥é‡ç½®ã€‚è¿™ä¸ªé—®é¢˜ä¸ä»…ä¼šå½±å“æœåŠ¡ A çš„æ€§èƒ½ï¼Œè¿˜ä¼šå½±å“ä¸»æœåŠ¡ï¼Œå› ä¸ºgoroutineä¼šç»§ç»­ç­‰å¾…å®ƒï¼Œä»è€Œè®°å½•çº¿ç¨‹æ± ã€‚\nè¿™å°±æ˜¯äººä»¬æ‰€è¯´çš„â€œä¸€ä¸ªåè‹¹æœç³Ÿè¹‹äº†æ•´ä¸ªæ¡¶â€ï¼Œå–äº†ç³Ÿç³•çš„æœé…’çš„äººè‚¯å®šä¼šæœ‰åŒæ„Ÿã€‚ä¸‹é¢è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥éªŒè¯è¿™ä¸€ç‚¹ã€‚\nè®©æˆ‘ä»¬æ„å»ºä¸€ä¸ª Netflixisc åº”ç”¨ç¨‹åºã€‚å…¶ä¸­ä¸€ä¸ªå¾®æœåŠ¡è´Ÿè´£æä¾›feedé¡µé¢çš„ç”µå½±æœåŠ¡ã€‚æ­¤æœåŠ¡è¿˜ä¾èµ–äºæ¨èæœåŠ¡ä¸ºç”¨æˆ·æä¾›é€‚å½“çš„æ¨èã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Recommendation Service func main() { logGoroutines() http.HandleFunc(\u0026#34;/recommendations\u0026#34;, recoHandler) log.Fatal(http.ListenAndServe(\u0026#34;:9090\u0026#34;, nil)) } func logGoroutines() { ticker := time.NewTicker(500 * time.Millisecond) done := make(chan bool) go func() { for { select { case \u0026lt;-done: return case t := \u0026lt;-ticker.C: fmt.Printf(\u0026#34;\\n%v - %v\u0026#34;, t, runtime.NumGoroutine()) } } }() } func recoHandler(w http.ResponseWriter, r *http.Request) { a := `{\u0026#34;movies\u0026#34;: [\u0026#34;Few Angry Men\u0026#34;, \u0026#34;Pride \u0026amp; Prejudice\u0026#34;]}` w.Write([]byte(a)) } æ¨èæœåŠ¡æš´éœ²ä¸€ä¸ªè·¯ç”±æ¥å£ /recommendationsï¼Œå®ƒè¿”å›ä¸€ä¸ªæ¨èç”µå½±åˆ—è¡¨ï¼ŒåŒæ—¶æ¯ 500 æ¯«ç§’æ‰“å°ä¸€æ¬¡ goroutine çš„æ•°é‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 // Movies App type MovieResponse struct { Feed []string Recommendation []string } func main() { http.HandleFunc(\u0026#34;/movies\u0026#34;, fetchMoviesFeedHandler) log.Fatal(http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil)) } func fetchMoviesFeedHandler(w http.ResponseWriter, r *http.Request) { mr := MovieResponse{ Feed: []string{\u0026#34;Transformers\u0026#34;, \u0026#34;Fault in our stars\u0026#34;, \u0026#34;The Old Boy\u0026#34;}, } rms, err := fetchRecommendations() if err != nil { w.WriteHeader(500) } mr.Recommendation = rms bytes, err := json.Marshal(mr) if err != nil { w.WriteHeader(500) } w.Write(bytes) } func fetchRecommendations() ([]string, error) { resp, err := http.Get(\u0026#34;http://localhost:9090/recommendations\u0026#34;) if err != nil { return []string{}, err } defer resp.Body.Close() body, err := ioutil.ReadAll(resp.Body) if err != nil { return []string{}, err } var mvsr map[string]interface{} err = json.Unmarshal(body, \u0026amp;mvsr) if err != nil { return []string{}, err } mvsb, err := json.Marshal(mvsr[\u0026#34;movies\u0026#34;]) if err != nil { return []string{}, err } var mvs []string err = json.Unmarshal(mvsb, \u0026amp;mvs) if err != nil { return []string{}, err } return mvs, nil } ç”µå½±æœåŠ¡æš´éœ²ä¸€ä¸ªè·¯ç”± /moviesï¼Œå®ƒè¿”å›ç”µå½±åˆ—è¡¨å’Œæ¨èåˆ—è¡¨ã€‚ä¸ºäº†è·å–æ¨èï¼Œå®ƒåè¿‡æ¥è°ƒç”¨ä¸Šæ¸¸çš„æ¨èæœåŠ¡ã€‚\né€šè¿‡æ­¤è®¾ç½®ï¼Œè®©æˆ‘ä»¬ä»¥æ¯ç§’ 100 ä¸ªè¯·æ±‚çš„é€Ÿç‡è®¿é—®ç”µå½±æœåŠ¡ï¼ŒæŒç»­ 3 ç§’é’Ÿã€‚åœ¨ 99% çš„æ¯«ç§’èŒƒå›´å†…ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾— 100% çš„æˆåŠŸã€‚è¿™æ˜¯é¢„æœŸçš„ï¼Œå› ä¸ºåªæä¾›é™æ€æ•°æ®ã€‚\nç°åœ¨ï¼Œå‡è®¾æ¨èæœåŠ¡çš„å“åº”æ—¶é—´è¿‡é•¿ï¼Œå¹¶åœ¨ recoHandler æ·»åŠ 20ç§’çš„ç­‰å¾…æ—¶é—´ï¼Œç„¶åé‡æ–°è¿›è¡Œæµ‹è¯•ã€‚æˆåŠŸç‡ä¼šä¸‹é™ï¼Œè€Œå“åº”æ—¶é—´ä¹Ÿä¼šå¼€å§‹å—åˆ°å½±å“ã€‚æ­¤å¤–ï¼Œåœ¨æµ‹è¯•æœŸé—´é˜»å¡åœ¨æ¨èæœåŠ¡ä¸Šçš„ goroutine æ•°é‡å°†æ€¥å‰§å¢åŠ ã€‚\næ¨èæœåŠ¡çš„åœå·¥æ—¶é—´å½±å“äº†ç»ˆç«¯ç”¨æˆ·ï¼Œå› ä¸ºæœ¬æ¥å¯ä»¥æä¾›ç»™ä»–çš„ç”µå½±feedåˆ—è¡¨éƒ½æ²¡æœ‰æä¾›ã€‚è¿™æ­£æ˜¯çº§è”æ•…éšœå¯¹æˆ‘ä»¬çš„ç³»ç»Ÿé€ æˆçš„å½±å“ã€‚\nç”µè·¯ç†”æ–­å™¨çš„æ•‘æ´ ç†”æ–­å™¨æ˜¯ä¸€ä¸ªéå¸¸ç®€å•ä½†ç›¸å½“é‡è¦çš„æ¦‚å¿µï¼Œå› ä¸ºå®ƒå¯ä»¥è®©æˆ‘ä»¬ä¿æŒæœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚ç†”æ–­å™¨æœ‰ä¸‰ç§çŠ¶æ€:\nClosed State å…³é—­çŠ¶æ€\nå…³é—­çŠ¶æ€æ˜¯æŒ‡æ•°æ®é€šè¿‡çš„æ—¶å€™è¿æ¥å¤„å…³é—­çš„çŠ¶æ€ã€‚è¿™æ˜¯æˆ‘ä»¬çš„ç†æƒ³çŠ¶æ€ï¼Œå…¶ä¸­ä¸Šæ¸¸æœåŠ¡æ­£å¦‚é¢„æœŸçš„é‚£æ ·å·¥ä½œã€‚\nOpen State å¼€æ”¾çŠ¶æ€\næ‰“å¼€çŠ¶æ€æŒ‡çš„æ˜¯ç”±äºä¸Šæ¸¸æœåŠ¡æœªæŒ‰é¢„æœŸå“åº”è€Œå¯¼è‡´ç”µè·¯çŸ­è·¯çš„çŠ¶æ€ã€‚è¿™ç§çŸ­è·¯å¯ä»¥é¿å…ä¸Šæ¸¸æœåŠ¡åœ¨å·²ç»æŒ£æ‰çš„æƒ…å†µä¸‹ä¸å ªé‡è´Ÿã€‚æ­¤å¤–ï¼Œä¸‹æ¸¸æœåŠ¡çš„ä¸šåŠ¡é€»è¾‘å¯ä»¥æ›´å¿«åœ°è·å¾—ä¸Šæ¸¸å¯ç”¨æ€§çŠ¶æ€çš„åé¦ˆï¼Œè€Œæ— éœ€ç­‰å¾…ä¸Šæ¸¸çš„å“åº”ã€‚\nHalf Open State åŠå¼€çŠ¶æ€\nå¦‚æœç”µè·¯æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒåœ¨ä¸Šæ¸¸æœåŠ¡å†æ¬¡å¯ç”¨æ—¶ç«‹å³å…³é—­å®ƒã€‚è™½ç„¶ä½ å¯ä»¥é€šè¿‡æ‰‹åŠ¨å¹²é¢„æ¥å®ç°ï¼Œä½†é¦–é€‰çš„æ–¹æ³•åº”è¯¥æ˜¯åœ¨ç”µè·¯æœ€åä¸€æ¬¡æ‰“å¼€ï¼Œè®©ä¸€äº›è¯·æ±‚å»¶è¿Ÿä¹‹åé€šè¿‡ç”µè·¯ï¼Œ\nå¦‚æœè¿™äº›è¯·æ±‚è¯·æ±‚ä¸Šæ¸¸æœåŠ¡æˆåŠŸï¼Œæˆ‘ä»¬å°±å¯ä»¥å®‰å…¨åœ°æ¥é€šç”µè·¯ã€‚\nå¦ä¸€æ–¹é¢ï¼Œå¦‚æœè¿™äº›è¯·æ±‚å¤±è´¥ï¼Œç”µè·¯ä»ç„¶å¤„äºæ‰“å¼€çŠ¶æ€ã€‚\nç†”æ–­å™¨çš„çŠ¶æ€å›¾å¦‚ä¸‹:\nå¦‚æœç”µè·¯æ˜¯å…³é—­çš„ï¼Œå½“æ•…éšœè¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼Œåˆ™å¯ä»¥æ‰“å¼€\nå¦‚æœç”µè·¯æ˜¯æ‰“å¼€çš„ï¼Œåœ¨ä¸€æ®µç¡çœ æ—¶é—´å»¶è¿Ÿåï¼Œéƒ¨åˆ†æ‰“å¼€\nå¦‚æœç”µè·¯æ˜¯åŠå¼€çš„ï¼Œå®ƒå¯ä»¥\nå†æ¬¡æ‰“å¼€ï¼Œå¦‚æœå…è®¸é€šè¿‡çš„è¯·æ±‚ä¹Ÿå¤±è´¥äº†\nå…³é—­ï¼Œå¦‚æœå…è®¸é€šè¿‡çš„è¯·æ±‚æˆåŠŸå“åº”\nç†”æ–­å™¨åœ¨ Golang çš„åº”ç”¨ è™½ç„¶æœ‰å¤šä¸ªåº“å¯ä¾›é€‰æ‹©ï¼Œä½†æœ€å¸¸ç”¨çš„æ˜¯ hystixã€‚æ­£å¦‚æ–‡æ¡£å»ºè®®çš„é‚£æ ·ï¼Œhystrix æ˜¯ Netflix è®¾è®¡çš„ä¸€ä¸ªå»¶è¿Ÿå’Œå®¹é”™åº“ï¼Œç”¨äºéš”ç¦»è¿œç¨‹ç³»ç»Ÿã€æœåŠ¡å’Œç¬¬ä¸‰æ–¹åº“çš„è®¿é—®ï¼Œé˜»æ­¢çº§è”æ•…éšœï¼Œå¹¶åœ¨ä¸å¯é¿å…çš„æ•…éšœå‘ç”Ÿçš„å¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°æ¢å¤èƒ½åŠ›ã€‚\nHystrix ç†”æ–­å™¨çš„å®ç°å–å†³äºä»¥ä¸‹é…ç½®:\nè¶…æ—¶ ãƒ¼ ä¸Šæ¸¸æœåŠ¡å“åº”çš„ç­‰å¾…æ—¶é—´ æœ€å¤§å¹¶å‘è¯·æ±‚ ãƒ¼ ä¸Šæ¸¸æœåŠ¡å…è®¸è°ƒç”¨çš„æœ€å¤§å¹¶å‘ è¯·æ±‚å®¹é‡é˜ˆå€¼ ãƒ¼ åœ¨ç†”æ–­ä¹‹å‰çš„è¯·æ±‚æ•°ï¼Œæ–­è·¯å™¨åœ¨éœ€è¦æ›´æ”¹çŠ¶æ€æ—¶æ— æ³•è¯„ä¼°çš„è¯·æ±‚æ•°é‡ ç¡çœ çª—å£ ãƒ¼ å¼€æ”¾çŠ¶æ€ä¸åŠå¼€æ”¾çŠ¶æ€ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ è¯¯å·®ç™¾åˆ†æ¯”é˜ˆå€¼ãƒ¼ç”µè·¯çŸ­è·¯æ—¶çš„è¯¯å·®ç™¾åˆ†æ¯”é˜ˆå€¼ æ¥ä¸‹æ¥è®©æˆ‘ä»¬åœ¨ç”µå½±å’Œæ¨èç¤ºä¾‹ä¸­ä½¿ç”¨å®ƒï¼Œå¹¶åœ¨è·å–æ¨èæ—¶å®ç°ç†”æ–­å™¨æ¨¡å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 var downstreamErrCount int var circuitOpenErrCount int func main() { downstreamErrCount = 0 circuitOpenErrCount = 0 hystrix.ConfigureCommand(\u0026#34;recommendation\u0026#34;, hystrix.CommandConfig{ Timeout: 100, RequestVolumeThreshold: 25, ErrorPercentThreshold: 5, SleepWindow: 1000, }) http.HandleFunc(\u0026#34;/movies\u0026#34;, fetchMoviesFeedHandlerWithCircuitBreaker) log.Fatal(http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil)) } func fetchMoviesFeedHandlerWithCircuitBreaker(w http.ResponseWriter, r *http.Request) { mr := MovieResponse{ Feed: []string{\u0026#34;Transformers\u0026#34;, \u0026#34;Fault in our stars\u0026#34;, \u0026#34;The Old Boy\u0026#34;}, } // output := make(chan bool, 1) errors := hystrix.Go(\u0026#34;recommendation\u0026#34;, func() error { // talk to other services rms, err := fetchRecommendations() if err != nil { return err } mr.Recommendation = rms output \u0026lt;- true return nil }, func(err error) error { // å†™ä½ çš„fallback(å›é€€)é€»è¾‘ return nil }) select { case err := \u0026lt;-errors: if err == hystrix.ErrCircuitOpen { circuitOpenErrCount = circuitOpenErrCount + 1 } else { downstreamErrCount = downstreamErrCount + 1 } case _ = \u0026lt;-output: } bytes, err := json.Marshal(mr) if err != nil { w.WriteHeader(500) } fmt.Printf(\u0026#34;\\ndownstreamErrCount=%d, circuitOpenErrCount=%d\u0026#34;, downstreamErrCount, circuitOpenErrCount) w.Write(bytes) } ä½¿ç”¨ Hystrixï¼Œæ‚¨è¿˜å¯ä»¥åœ¨ç”µè·¯æ‰“å¼€æ—¶å®ç°å›é€€é€»è¾‘ã€‚è¿™ç§é€»è¾‘å¯èƒ½å› æƒ…å†µè€Œå¼‚ã€‚å¦‚æœç”µè·¯æ‰“å¼€ï¼Œåˆ™ä»ç¼“å­˜ä¸­è·å–ã€‚\nä½¿ç”¨è¿™ä¸ªæ›´æ–°çš„é€»è¾‘ï¼Œè®©æˆ‘ä»¬å°è¯•ä»¥æ¯ç§’100ä¸ªè¯·æ±‚çš„é€Ÿç‡é‡æ–°æ”»å‡» 3 ç§’é’Ÿã€‚\nå“‡! ï¼100% çš„æˆåŠŸç‡ï¼Œåœ¨æ‰“å¼€çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªæä¾› Feed å’Œè¿”å› 0ä¸ªæ¨èã€‚æ­¤å¤–ï¼Œç”±äºæ¯å½“ç”µè·¯çŸ­è·¯ï¼Œæˆ‘ä»¬ä¸å†è°ƒç”¨ä¸Šæ¸¸æœåŠ¡ï¼Œå› æ­¤æ¨èæœåŠ¡ä¸ä¼šä¸å ªé‡è´Ÿï¼Œé˜»å¡çš„ goroutine æ•°é‡ä¸ä¼šåƒä»¥å‰é‚£ä¹ˆå¤šã€‚\næƒ³äº†è§£æ›´å¤šï¼Ÿ æˆ‘çš„å»ºè®®:\nå…³äº Netflix Hystrix Hystrix æ˜¯æ€æ ·å·¥ä½œçš„ï¼Ÿ Hystrix bucketing ","date":"2021-02-03T12:00:00Z","image":"http://img.golang.space/shot-1626770277464.png","permalink":"https://blog.golang.space/p/circuit-breakers-in-golang/","title":"Circuit Breakers in Golang"},{"content":"æœ¬æ–‡ç¿»è¯‘è‡ª https://github.com/evrone/go-clean-templateï¼Œç”±äºæœ¬äººç¿»è¯‘æ°´å¹³æœ‰é™ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„çƒ¦è¯·æŒ‡å‡ºã€‚\nGo æ•´æ´æ¶æ„æ¨¡æ¿ã€‚ æ¦‚æ‹¬ æ¨¡æ¿çš„ä½œç”¨ :\nå¦‚ä½•ç»„ç»‡é¡¹ç›®å¹¶é˜²æ­¢å®ƒå˜æˆä¸€å¨æ„å¤§åˆ©é¢æ¡å¼çš„ä»£ç ã€‚ åœ¨å“ªé‡Œå­˜æ”¾ä¸šåŠ¡é€»è¾‘ï¼Œä½¿å…¶ä¿æŒç‹¬ç«‹ï¼Œæ•´æ´å’Œå¯æ‰©å±•ã€‚ å¦‚ä½•åœ¨å¾®æœåŠ¡æ‰©å±•æ—¶ä¸å¤±æ§ æ¨¡ç‰ˆä½¿ç”¨äº† Robert Martin ( ä¹Ÿå« Bob å”å” ) çš„åŸåˆ™ã€‚\nGo-clean-template æ­¤ä»“åº“ç”± Evrone åˆ›å»ºåŠç»´æŠ¤ã€‚\nç›®å½•å†…å®¹ å¿«é€Ÿå¼€å§‹ é¡¹ç›®ç»“æ„ ä¾èµ–æ³¨å…¥ æ•´æ´æ¶æ„ä¹‹é“ å¿«é€Ÿå¼€å§‹ æœ¬åœ°å¼€å‘\n1 2 3 4 # Postgres, RabbitMQ $ make compose-up # Run app with migrations $ make run é›†æˆæµ‹è¯• ( å¯ä»¥åœ¨ CI ä¸­è¿è¡Œ )\n1 2 # DB, app + migrations, integration tests $ make compose-up-integration-test é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 â”œâ”€â”€ cmd â”‚ â””â”€â”€ app â”‚ â””â”€â”€ main.go â”œâ”€â”€ config â”‚ â”œâ”€â”€ config.go â”‚ â””â”€â”€ config.yml â”œâ”€â”€ docs â”‚ â”œâ”€â”€ docs.go â”‚ â”œâ”€â”€ swagger.json â”‚ â””â”€â”€ swagger.yaml â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ integration-test â”‚ â”œâ”€â”€ Dockerfile â”‚ â””â”€â”€ integration_test.go â”œâ”€â”€ internal â”‚ â”œâ”€â”€ app â”‚ â”‚ â”œâ”€â”€ app.go â”‚ â”‚ â””â”€â”€ migrate.go â”‚ â”œâ”€â”€ delivery â”‚ â”‚ â”œâ”€â”€ amqp_rpc â”‚ â”‚ â”‚ â”œâ”€â”€ router.go â”‚ â”‚ â”‚ â””â”€â”€ translation.go â”‚ â”‚ â””â”€â”€ http â”‚ â”‚ â””â”€â”€ v1 â”‚ â”‚ â”œâ”€â”€ error.go â”‚ â”‚ â”œâ”€â”€ router.go â”‚ â”‚ â””â”€â”€ translation.go â”‚ â”œâ”€â”€ domain â”‚ â”‚ â””â”€â”€ translation.go â”‚ â””â”€â”€ service â”‚ â”œâ”€â”€ interfaces.go â”‚ â”œâ”€â”€ repo â”‚ â”‚ â””â”€â”€ translation_postgres.go â”‚ â”œâ”€â”€ translation.go â”‚ â””â”€â”€ webapi â”‚ â””â”€â”€ translation_google.go â”œâ”€â”€ migrations â”‚ â”œâ”€â”€ 20210221023242_migrate_name.down.sql â”‚ â””â”€â”€ 20210221023242_migrate_name.up.sql â””â”€â”€ pkg â”œâ”€â”€ httpserver â”‚ â”œâ”€â”€ options.go â”‚ â””â”€â”€ server.go â”œâ”€â”€ logger â”‚ â”œâ”€â”€ interface.go â”‚ â”œâ”€â”€ logger.go â”‚ â””â”€â”€ zap.go â”œâ”€â”€ postgres â”‚ â”œâ”€â”€ options.go â”‚ â””â”€â”€ postgres.go â””â”€â”€ rabbitmq â””â”€â”€ rmq_rpc â”œâ”€â”€ client â”‚ â”œâ”€â”€ client.go â”‚ â””â”€â”€ options.go â”œâ”€â”€ connection.go â”œâ”€â”€ errors.go â””â”€â”€ server â”œâ”€â”€ options.go â””â”€â”€ server.go cmd/app/main.go é…ç½®å’Œæ—¥å¿—å®ä¾‹çš„åˆå§‹åŒ–ï¼Œmain å‡½æ•°ä¸­è°ƒç”¨internal/app/app.go æ–‡ä»¶ä¸­ çš„ Run å‡½æ•°ï¼Œmain å‡½æ•°å°†ä¼šåœ¨æ­¤ \u0026ldquo;å»¶ç»­\u0026rdquo;ã€‚\nconfig é…ç½®ã€‚é¦–å…ˆè¯»å– config.ymlï¼Œç„¶åç”¨ç¯å¢ƒå˜é‡è¦†ç›–ç›¸åŒ¹é…çš„ yaml é…ç½®ã€‚é…ç½®çš„ç»“æ„ä½“åœ¨ config.go æ–‡ä»¶ä¸­ã€‚env-required: true ç»“æ„ä½“æ ‡ç­¾å¼ºåˆ¶æ‚¨æŒ‡å®šä¸€ä¸ªå€¼ ( åœ¨ yaml æˆ–åœ¨ç¯å¢ƒå˜é‡ä¸­ )ã€‚\nå¯¹äºé…ç½®è¯»å–ï¼Œæˆ‘ä»¬é€‰æ‹© cleanenv åº“ã€‚å®ƒåœ¨ GitHub ä¸Šæ²¡æœ‰å¾ˆå¤š starï¼Œä½†å¾ˆç®€å•ä¸”æ»¡è¶³æ‰€æœ‰çš„éœ€æ±‚ã€‚\nä» yaml ä¸­è¯»å–é…ç½®è¿èƒŒäº†12 è¦ç´ ï¼Œä½†åœ¨å®è·µä¸­ï¼Œå®ƒæ¯”ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–æ•´ä¸ªé…ç½®æ›´æ–¹ä¾¿ã€‚å‡è®¾é»˜è®¤å€¼å®šä¹‰åœ¨ yaml ä¸­ï¼Œæ•æ„Ÿçš„å˜é‡å®šä¹‰åœ¨ç¯å¢ƒå˜é‡ä¸­ã€‚\ndocs Swagger æ–‡æ¡£ã€‚å¯ä»¥ç”± swag åº“è‡ªåŠ¨ç”Ÿæˆã€‚è€Œä½ ä¸éœ€è¦è‡ªå·±æ”¹æ­£ä»»ä½•äº‹æƒ…ã€‚\nintegration-test é›†æˆæµ‹è¯•ã€‚å®ƒä»¬ä½œä¸ºå•ç‹¬çš„å®¹å™¨å¯åŠ¨ï¼Œç´§æŒ¨ç€åº”ç”¨ç¨‹åºå®¹å™¨ã€‚ä½¿ç”¨ go-hit æµ‹è¯• REST API éå¸¸æ–¹ä¾¿ã€‚\ninternal/app åœ¨ app.go æ–‡ä»¶ä¸­ä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ª Run å‡½æ•°ï¼Œå®ƒâ€œå»¶ç»­â€äº†mainå‡½æ•°ã€‚\nè¿™æ˜¯åˆ›å»ºæ‰€æœ‰ä¸»è¦å¯¹è±¡çš„åœ°æ–¹ã€‚ä¾èµ–æ³¨å…¥é€šè¿‡â€œ New\u0026hellip;â€æ„é€ å‡½æ•° ( å‚è§ä¾èµ–æ³¨å…¥ ) ã€‚è¿™ç§æŠ€æœ¯å…è®¸æˆ‘ä»¬ä½¿ç”¨ä¾èµ–æ³¨å…¥åŸåˆ™å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œåˆ†å±‚ï¼Œä½¿å¾—ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹äºå…¶ä»–å±‚ã€‚\næ¥ä¸‹æ¥ï¼Œä¸ºäº†ä¼˜é›…çš„å®Œæˆï¼Œæˆ‘ä»¬å¯åŠ¨æœåŠ¡å¹¶åœ¨selectä¸­ç­‰å¾…ç‰¹å®šçš„ä¿¡å·ã€‚å¦‚æœ app.go ä»£ç è¶Šæ¥è¶Šå¤šï¼Œå¯ä»¥å°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶ã€‚\nå¯¹äºå¤§é‡çš„æ³¨å…¥ï¼Œå¯ä»¥ä½¿ç”¨ wire åº“ ( wire æ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå·¥å…·ï¼Œå®ƒä½¿ç”¨ä¾èµ–æ³¨å…¥è‡ªåŠ¨è¿æ¥ç»„ä»¶)ã€‚\nmigrate.go æ–‡ä»¶ç”¨äºæ•°æ®åº“è‡ªåŠ¨è¿ç§»ã€‚å¦‚æœæŒ‡å®šäº† migrate æ ‡ç­¾çš„å‚æ•°ï¼Œåˆ™ä¼šåŒ…å«å®ƒã€‚ä¾‹å¦‚ :\n1 $ go run -tags migrate ./cmd/app internal/delivery æœåŠ¡çš„handlerå±‚ ( MVC æ§åˆ¶å™¨ )ã€‚æ¨¡æ¿å±•ç¤ºäº†ä¸¤ä¸ªæœåŠ¡:\nRPC ( RabbitMQ ç”¨äºä¼ é€’æ¶ˆæ¯ ) REST HTTP ( GIN æ¡†æ¶ ) æœåŠ¡çš„è·¯ç”±ä¹Ÿä»¥åŒæ ·çš„é£æ ¼ç¼–å†™ :\nHandlersæŒ‰ç…§åº”ç”¨é¢†åŸŸåˆ†ç»„ ( æŒ‰å…¬å…±åŸºç¡€ ) å¯¹äºæ¯ä¸ªç»„ï¼Œéƒ½åˆ›å»ºè‡ªå·±çš„è·¯ç”±ç»“æ„ï¼Œä»¥åŠå¤„ç†æ¥å£è·¯å¾„çš„æ–¹æ³• ä¸šåŠ¡é€»è¾‘çš„ç»“æ„è¢«æ³¨å…¥åˆ°è·¯ç”±ç»“æ„ä¸­ï¼Œç”±handlerså¤„ç†è°ƒç”¨ internal/delivery/http ç®€å•çš„ REST ç‰ˆæœ¬æ§åˆ¶ã€‚å¯¹äº v2ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ å…·æœ‰ç›¸åŒå†…å®¹çš„ http/v2 æ–‡ä»¶å¤¹ã€‚åœ¨ internal/app ç¨‹åºæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹è¡Œ :\n1 2 3 handler := gin.New() v1.NewRouter(handler, translationService) v2.NewRouter(handler, translationService) ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–çš„ HTTP æ¡†æ¶ç”šè‡³æ˜¯æ ‡å‡†çš„ net/http åº“æ¥ä»£æ›¿ Ginã€‚\nåœ¨ v1/router.go å’Œä¸Šé¢çš„ handler æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€äº›æ³¨é‡Šæ˜¯ç”¨ swagåº“æ¥ç”Ÿæˆ swagger æ–‡æ¡£çš„ã€‚\ninternal/domain ä¸šåŠ¡é€»è¾‘çš„å®ä½“ ( æ¨¡å‹ ) å¯ä»¥åœ¨ä»»ä½•å±‚ä¸­ä½¿ç”¨ã€‚ä¹Ÿå¯ä»¥æœ‰æ–¹æ³•ï¼Œä¾‹å¦‚ï¼Œç”¨äºéªŒè¯ã€‚\ninternal/service ä¸šåŠ¡é€»è¾‘\næ–¹æ³•æŒ‰åº”ç”¨é¢†åŸŸåˆ†ç»„ ( åœ¨å…¬å…±çš„åŸºç¡€ä¸Š ) æ¯ä¸ªç»„éƒ½æœ‰è‡ªå·±çš„ç»“æ„ ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªç»“æ„ Repositoriesã€ webapiã€ rpc å’Œå…¶ä»–ä¸šåŠ¡é€»è¾‘ç»“æ„è¢«æ³¨å…¥åˆ°ä¸šåŠ¡é€»è¾‘ç»“æ„ä¸­ ( è§ä¾èµ–æ³¨å…¥ )ã€‚\ninternal/service/repo repository æ˜¯ä¸šåŠ¡é€»è¾‘ä½¿ç”¨çš„æŠ½è±¡å­˜å‚¨ ( æ•°æ®åº“ )ã€‚\ninternal/service/webapi å®ƒæ˜¯ä¸šåŠ¡é€»è¾‘ä½¿ç”¨çš„æŠ½è±¡ web APIã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½æ˜¯ä¸šåŠ¡é€»è¾‘é€šè¿‡ REST API è®¿é—®çš„å¦ä¸€ä¸ªå¾®æœåŠ¡ã€‚åŒ…çš„åç§°æ ¹æ®ç”¨é€”è€Œå˜åŒ–ã€‚\npkg/rabbitmq RabbitMQ RPC æ¨¡å¼ :\nRabbitMQ å†…éƒ¨æ²¡æœ‰è·¯ç”± ä½¿ç”¨Exchange fanout å¹¿æ’­æ¨¡å¼ï¼Œå°†1 ä¸ªç‹¬ç«‹é˜Ÿåˆ—ç»‘å®šåˆ°å…¶ä¸­ï¼Œè¿™æ˜¯æœ€é«˜æ•ˆçš„é…ç½®ã€‚ é‡æ–°è¿æ¥æ–­å¼€ä¸¢å¤±çš„è¿æ¥ ä¾èµ–æ³¨å…¥ ä¸ºäº†æ¶ˆé™¤ä¸šåŠ¡é€»è¾‘å¯¹å¤–éƒ¨åŒ…çš„ä¾èµ–ï¼Œä½¿ç”¨äº†ä¾èµ–æ³¨å…¥ã€‚\nä¾‹å¦‚ï¼Œé€šè¿‡ NewService æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å°†ä¾èµ–æ³¨å…¥åˆ°ä¸šåŠ¡é€»è¾‘çš„ç»“æ„ä¸­ã€‚è¿™ä½¿å¾—ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹ ( ä¾¿äºç§»æ¤ )ã€‚æˆ‘ä»¬å¯ä»¥é‡å†™æ¥å£çš„å®ç°ï¼Œè€Œä¸éœ€è¦å¯¹ service åŒ…è¿›è¡Œæ›´æ”¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package service import ( // Nothing! ) type Repository interface { Get() } type Service struct { repo Repository } func NewService(r Repository) *Service{ return \u0026amp;Service{r} } func (s *Service) Do() { s.repo.Get() } å®ƒè¿˜å…è®¸æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆæ¨¡æ‹Ÿå‚æ•° ( ä¾‹å¦‚ä½¿ç”¨ mockery ) å’Œè½»æ¾åœ°ç¼–å†™å•å…ƒæµ‹è¯•ã€‚\næˆ‘ä»¬å¯ä»¥ä¸å—ç‰¹å®šå®ç°çš„çº¦æŸï¼Œæ¥å°†ä¸€ä¸ªç»„ä»¶æ›´æ”¹ä¸ºå¦ä¸€ä¸ªç»„ä»¶ã€‚å¦‚æœæ–°ç»„ä»¶å®ç°äº†è¯¥æ¥å£ï¼Œåˆ™ä¸šåŠ¡é€»è¾‘ä¸­ä¸éœ€è¦è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚\næ•´æ´æ¶æ„ä¹‹é“ å…³é”®ç‚¹ ç¨‹åºå‘˜åœ¨ç¼–å†™äº†å¤§é‡ä»£ç åæ‰æ„è¯†åˆ°åº”ç”¨ç¨‹åºçš„æœ€ä½³æ¶æ„ã€‚\nä¸€ä¸ªå¥½çš„æ¶æ„å…è®¸å°½å¯èƒ½æ¨è¿Ÿå†³ç­–ã€‚\nä¸»è¦åŸåˆ™ Dependency Inversion ( ä¸ SOLID ç›¸åŒ ) æ˜¯ä¾èµ–å€’ç½®çš„åŸåˆ™ã€‚ä¾èµ–å…³ç³»çš„æ–¹å‘æ˜¯ä»å¤–å±‚åˆ°å†…å±‚ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œä¸šåŠ¡é€»è¾‘å’Œå®ä½“ä»ç„¶ç‹¬ç«‹äºç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚\nå› æ­¤ï¼Œåº”ç”¨ç¨‹åºåˆ†ä¸ºå†…éƒ¨å’Œå¤–éƒ¨ä¸¤ä¸ªå±‚æ¬¡ :\nä¸šåŠ¡é€»è¾‘ ( ä½¿ç”¨ Go æ ‡å‡†åº“ ) å·¥å…· ( æ•°æ®åº“ã€å…¶ä»–æœåŠ¡ã€æ¶ˆæ¯ä»£ç†ã€ä»»ä½•å…¶ä»–åŒ…å’Œæ¡†æ¶ ) ä¸šåŠ¡é€»è¾‘çš„å†…å±‚åº”è¯¥æ˜¯æ•´æ´çš„ï¼Œå®ƒåº”è¯¥ :\næ²¡æœ‰ä»å¤–å±‚å¯¼å…¥çš„åŒ… åªä½¿ç”¨æ ‡å‡†åº“çš„åŠŸèƒ½ é€šè¿‡æ¥å£è°ƒç”¨å¤–å±‚ ! ä¸šåŠ¡é€»è¾‘å¯¹ Postgres æˆ–è¯¦ç»†çš„ web API ä¸€æ— æ‰€çŸ¥ã€‚ä¸šåŠ¡é€»è¾‘åº”è¯¥å…·æœ‰ä¸€ä¸ªç”¨äºå¤„ç†æŠ½è±¡æ•°æ®åº“æˆ–æŠ½è±¡ web API çš„æ¥å£ã€‚\nå¤–å±‚è¿˜æœ‰å…¶ä»–é™åˆ¶ :\nè¿™ä¸€å±‚çš„æ‰€æœ‰ç»„æˆéƒ¨åˆ†éƒ½ä¸çŸ¥é“å½¼æ­¤çš„å­˜åœ¨ã€‚å¦‚ä½•ä»ä¸€ä¸ªå·¥å…·è°ƒç”¨å¦ä¸€ä¸ªå·¥å…·ï¼Ÿä¸æ˜¯ç›´æ¥ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡å†…å±‚çš„ä¸šåŠ¡é€»è¾‘æ¥è°ƒç”¨ã€‚ å¯¹å†…å±‚çš„æ‰€æœ‰è°ƒç”¨éƒ½æ˜¯é€šè¿‡æ¥å£æ¥å®Œæˆçš„ æ•°æ®ä»¥ä¾¿äºä¸šåŠ¡é€»è¾‘çš„æ ¼å¼ä¼ è¾“ ( internal/domain ) ä¾‹å¦‚ï¼Œä½ éœ€è¦ä» HTTP ( æ§åˆ¶å™¨ ) è®¿é—®æ•°æ®åº“ã€‚HTTP å’Œæ•°æ®åº“éƒ½åœ¨å¤–å±‚ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯¹å½¼æ­¤ä¸€æ— æ‰€çŸ¥ã€‚å®ƒä»¬ä¹‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡ service ( ä¸šåŠ¡é€»è¾‘ ) è¿›è¡Œçš„ :\n1 2 3 4 HTTP \u0026gt; service service \u0026gt; repository (Postgres) service \u0026lt; repository (Postgres) HTTP \u0026lt; service ç¬¦å· \u0026gt; å’Œ \u0026lt; é€šè¿‡æ¥å£æ˜¾ç¤ºå±‚ä¸å±‚è¾¹ç•Œçš„äº¤é›†ï¼Œå¦‚å›¾æ‰€ç¤º :\næˆ–è€…æ›´å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ :\n1 2 3 4 5 6 7 8 9 10 HTTP \u0026gt; service service \u0026gt; repository service \u0026lt; repository service \u0026gt; webapi service \u0026lt; webapi service \u0026gt; RPC service \u0026lt; RPC service \u0026gt; repository service \u0026lt; repository HTTP \u0026lt; service å±‚çº§ æ•´æ´æ¶æ„çš„æœ¯è¯­\nå®ä½“æ˜¯ä¸šåŠ¡é€»è¾‘æ“ä½œçš„ç»“æ„ã€‚å®ƒä»¬ä½äº internal/domain æ–‡ä»¶å¤¹ä¸­ã€‚Domain æš—ç¤ºæˆ‘ä»¬åšæŒ DDD ( é¢†åŸŸé©±åŠ¨è®¾è®¡ ) çš„åŸåˆ™ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ˜¯æ­£ç¡®çš„ã€‚åœ¨ MVC æœ¯è¯­ä¸­ï¼Œå®ä½“å°±æ˜¯æ¨¡å‹ã€‚ ç”¨ä¾‹æ˜¯ä½äº internal/service ä¸­çš„ä¸šåŠ¡é€»è¾‘ã€‚ä»æ•´æ´æ¶æ„çš„è§’åº¦æ¥çœ‹ï¼Œè°ƒç”¨ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ service ä¸€è¯ä¸æ˜¯ä¹ æƒ¯çš„ç”¨æ³•ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªåŒ…åç§°æ¥è¯´ï¼Œä½¿ç”¨ä¸€ä¸ªå•è¯ ( service ) æ¯”ä½¿ç”¨ä¸¤ä¸ªå•è¯ ( use case ) æ›´æ–¹ä¾¿ã€‚ ä¸šåŠ¡é€»è¾‘ç›´æ¥äº¤äº’çš„å±‚é€šå¸¸ç§°ä¸ºåŸºç¡€è®¾æ–½å±‚ã€‚å®ƒä»¬å¯ä»¥æ˜¯å­˜å‚¨åº“ internal/service/repoã€web API internal/service/webapiã€ä»»ä½•pkgï¼Œä»¥åŠå…¶ä»–å¾®æœåŠ¡ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œ_ infrastructure åŒ…ä½äº internal/service ä¸­ã€‚\nä½ å¯ä»¥æ ¹æ®éœ€è¦å»é€‰æ‹©å¦‚ä½•è°ƒç”¨å…¥å£ç‚¹ã€‚é€‰é¡¹å¦‚ä¸‹ :\ndelivery (in our case) controllers transport gateways entrypoints primary input é™„åŠ å±‚ ç»å…¸ç‰ˆæœ¬çš„ æ•´æ´æ¶æ„ä¹‹é“ æ˜¯ä¸ºæ„å»ºå¤§å‹å•ä½“åº”ç”¨ç¨‹åºè€Œè®¾è®¡çš„ï¼Œå®ƒæœ‰4å±‚ã€‚\nåœ¨æœ€åˆçš„ç‰ˆæœ¬ä¸­ï¼Œå¤–å±‚è¢«åˆ†ä¸ºä¸¤ä¸ªä»¥ä¸Šçš„å±‚ï¼Œä¸¤å±‚ä¹‹é—´ä¹Ÿå­˜åœ¨ç›¸äº’ä¾èµ–å…³ç³»å€’ç½® ( å®šå‘å†…éƒ¨ )ï¼Œå¹¶é€šè¿‡æ¥å£è¿›è¡Œé€šä¿¡ã€‚\nåœ¨é€»è¾‘å¤æ‚çš„æƒ…å†µä¸‹ï¼Œå†…å±‚ä¹Ÿåˆ†ä¸ºä¸¤ä¸ª( æ¥å£åˆ†ç¦» )ã€‚\nå¤æ‚çš„å·¥å…·å¯ä»¥è¢«åˆ’åˆ†æˆæ›´å¤šçš„é™„åŠ å±‚ï¼Œä½†ä½ åº”è¯¥åœ¨ç¡®å®éœ€è¦æ—¶å†æ·»åŠ å±‚ã€‚\næ›¿ä»£æ–¹æ³• é™¤äº†æ•´æ´æ¶æ„ä¹‹é“ï¼Œæ´‹è‘±æ¶æ„å’Œå…­è¾¹å½¢æ¶æ„ ( ç«¯å£é€‚é…å™¨æ¨¡å¼ ) æ˜¯ç±»ä¼¼çš„ã€‚ä¸¤è€…éƒ½æ˜¯åŸºäºä¾èµ–å€’ç½®çš„åŸåˆ™ã€‚ç«¯å£å’Œé€‚é…å™¨æ¨¡å¼éå¸¸æ¥è¿‘äºæ•´æ´æ¶æ„ä¹‹é“ï¼Œå·®å¼‚ä¸»è¦åœ¨æœ¯è¯­ä¸Šã€‚\nç±»ä¼¼çš„é¡¹ç›® https://github.com/bxcodec/go-clean-arch https://github.com/zhashkevych/courses-backend æ‰©å±•é˜…è¯»é“¾æ¥ æ•´æ´æ¶æ„ä¹‹é“ 12 è¦ç´  ","date":"2021-02-01T12:00:00Z","image":"http://img.golang.space/shot-1629111300629.svg","permalink":"https://blog.golang.space/p/go-clean-template/","title":"go clean template"},{"content":"âš¡ZAP ç®€ä»‹ zap æ˜¯ä»€ä¹ˆ? âš¡ZAP æ˜¯uber å¼€æºçš„æä¾›å¿«é€Ÿï¼Œç»“æ„åŒ–ï¼Œé«˜æ€§èƒ½çš„æ—¥å¿—è®°å½•åŒ…ã€‚\nzap é«˜æ€§èƒ½ä½“ç°åœ¨å“ªé‡Œ? åœ¨ä»‹ç»zapåŒ…çš„ä¼˜åŒ–éƒ¨åˆ†ä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹zapæ—¥å¿—åº“çš„å·¥ä½œæµç¨‹å›¾\nå¤§å¤šæ•°æ—¥å¿—åº“æä¾›çš„æ–¹å¼æ˜¯åŸºäºåå°„çš„åºåˆ—åŒ–å’Œå­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Œè¿™ç§æ–¹å¼ä»£ä»·é«˜æ˜‚ï¼Œè€Œ Zap é‡‡å–ä¸åŒçš„æ–¹æ³•ã€‚\né¿å… interface{} ä½¿ç”¨å¼ºç±»å‹è®¾è®¡\nå°è£…å¼ºç±»å‹ï¼Œæ— åå°„\nä½¿ç”¨é›¶åˆ†é…å†…å­˜çš„ JSON ç¼–ç å™¨ï¼Œå°½å¯èƒ½é¿å…åºåˆ—åŒ–å¼€é”€ï¼Œå®ƒæ¯”å…¶ä»–ç»“æ„åŒ–æ—¥å¿—åŒ…å¿« 4 - 10 å€ã€‚\n1 2 3 4 5 logger.Info(\u0026#34;failed to fetch URL\u0026#34;, zap.String(\u0026#34;url\u0026#34;, \u0026#34;https://baidu.com\u0026#34;), zap.Int(\u0026#34;attempt\u0026#34;, 3), zap.Duration(\u0026#34;backoff\u0026#34;, time.Second), ) ä½¿ç”¨ sync.Pool ä»¥é¿å…è®°å½•æ¶ˆæ¯æ—¶çš„å†…å­˜åˆ†é… è¯¦æƒ…åœ¨ä¸‹æ–‡ zapcore æ¨¡å—ä»‹ç»ã€‚\nExample å®‰è£… 1 go get -u go.uber.org/zap Zap æä¾›äº†ä¸¤ç§ç±»å‹çš„ logger\nSugaredLogger Logger åœ¨æ€§èƒ½è‰¯å¥½ä½†ä¸æ˜¯å…³é”®çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ SugaredLoggerï¼Œå®ƒæ¯”å…¶ä»–ç»“æ„åŒ–çš„æ—¥å¿—åŒ…å¿« 4-10 å€ï¼Œå¹¶ä¸”æ”¯æŒç»“æ„åŒ–å’Œ printf é£æ ¼çš„APIsã€‚\nä¾‹ä¸€ è°ƒç”¨ NewProduction åˆ›å»ºloggerå¯¹è±¡ 1 2 3 4 5 6 7 8 func TestSugar(t *testing.T) { logger, _ := zap.NewProduction() // é»˜è®¤ logger ä¸ç¼“å†²ã€‚ // ä½†ç”±äºåº•å±‚ api å…è®¸ç¼“å†²ï¼Œæ‰€ä»¥åœ¨è¿›ç¨‹é€€å‡ºä¹‹å‰è°ƒç”¨ Sync æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚ defer logger.Sync() sugar := logger.Sugar() sugar.Infof(\u0026#34;Failed to fetch URL: %s\u0026#34;, \u0026#34;https://baidu.com\u0026#34;) } å¯¹æ€§èƒ½å’Œç±»å‹å®‰å…¨è¦æ±‚ä¸¥æ ¼çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ Logger ï¼Œå®ƒç”šè‡³æ¯”å‰è€…SugaredLoggeræ›´å¿«ï¼Œå†…å­˜åˆ†é…æ¬¡æ•°ä¹Ÿæ›´å°‘ï¼Œä½†å®ƒä»…æ”¯æŒå¼ºç±»å‹çš„ç»“æ„åŒ–æ—¥å¿—è®°å½•ã€‚\nä¾‹äºŒ è°ƒç”¨ NewDevelopment åˆ›å»ºloggerå¯¹è±¡ 1 2 3 4 5 6 7 8 9 10 func TestLogger(t *testing.T) { logger, _ := zap.NewDevelopment() defer logger.Sync() logger.Info(\u0026#34;failed to fetch URL\u0026#34;, // å¼ºç±»å‹å­—æ®µ zap.String(\u0026#34;url\u0026#34;, \u0026#34;https://baidu.com\u0026#34;), zap.Int(\u0026#34;attempt\u0026#34;, 3), zap.Duration(\u0026#34;backoff\u0026#34;, time.Second), ) } ä¸éœ€è¦ä¸ºæ•´ä¸ªåº”ç”¨ç¨‹åºå†³å®šé€‰æ‹©ä½¿ç”¨ Logger è¿˜æ˜¯ SugaredLogger ï¼Œä¸¤è€…ä¹‹é—´éƒ½å¯ä»¥è½»æ¾è½¬æ¢ã€‚\nä¾‹ä¸‰ Logger ä¸ SugaredLogger ç›¸äº’è½¬æ¢ 1 2 3 4 5 6 7 8 // åˆ›å»º logger logger := zap.NewExample() defer logger.Sync() // è½¬æ¢ SugaredLogger sugar := logger.Sugar() // è½¬æ¢ logger plain := sugar.Desugar() ä¾‹å›› è‡ªå®šä¹‰æ ¼å¼ è‡ªå®šä¹‰ä¸€ä¸ªæ—¥å¿—æ¶ˆæ¯æ ¼å¼ï¼Œå¸¦ç€é—®é¢˜çœ‹ä¸‹åˆ—ä»£ç ã€‚\ndebug çº§åˆ«çš„æ—¥å¿—æ‰“å°åˆ°æ§åˆ¶å°äº†å—? æœ€åçš„ error ä¼šæ‰“å°åˆ°æ§åˆ¶å°å— ? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package main import ( \u0026#34;os\u0026#34; \u0026#34;go.uber.org/zap\u0026#34; \u0026#34;go.uber.org/zap/zapcore\u0026#34; ) func NewCustomEncoderConfig() zapcore.EncoderConfig { return zapcore.EncoderConfig{ TimeKey: \u0026#34;ts\u0026#34;, LevelKey: \u0026#34;level\u0026#34;, NameKey: \u0026#34;logger\u0026#34;, CallerKey: \u0026#34;caller\u0026#34;, FunctionKey: zapcore.OmitKey, MessageKey: \u0026#34;msg\u0026#34;, StacktraceKey: \u0026#34;stacktrace\u0026#34;, LineEnding: zapcore.DefaultLineEnding, EncodeLevel: zapcore.CapitalColorLevelEncoder, EncodeTime: zapcore.TimeEncoderOfLayout(\u0026#34;2006-01-02 15:04:05\u0026#34;), EncodeDuration: zapcore.SecondsDurationEncoder, EncodeCaller: zapcore.ShortCallerEncoder, } } func main() { atom := zap.NewAtomicLevelAt(zap.DebugLevel) core := zapcore.NewCore( zapcore.NewConsoleEncoder(NewCustomEncoderConfig()), zapcore.NewMultiWriteSyncer(zapcore.AddSync(os.Stdout)), atom, ) logger := zap.New(core, zap.AddCaller(), zap.Development()) defer logger.Sync() // é…ç½® zap åŒ…çš„å…¨å±€å˜é‡ zap.ReplaceGlobals(logger) // è¿è¡Œæ—¶å®‰å…¨åœ°æ›´æ”¹ logger æ—¥è®°çº§åˆ« atom.SetLevel(zap.InfoLevel) sugar := logger.Sugar() // é—®é¢˜ 1: debug çº§åˆ«çš„æ—¥å¿—æ‰“å°åˆ°æ§åˆ¶å°äº†å—? sugar.Debug(\u0026#34;debug\u0026#34;) sugar.Info(\u0026#34;info\u0026#34;) sugar.Warn(\u0026#34;warn\u0026#34;) sugar.DPanic(\u0026#34;dPanic\u0026#34;) // é—®é¢˜ 2: æœ€åçš„ error ä¼šæ‰“å°åˆ°æ§åˆ¶å°å—? sugar.Error(\u0026#34;error\u0026#34;) } ç»“æœè§ä¸‹å›¾\né—®é¢˜ 1:\næ²¡æœ‰æ‰“å°ã€‚AtomicLevel æ˜¯åŸå­æ€§å¯æ›´æ”¹çš„åŠ¨æ€æ—¥å¿—çº§åˆ«ï¼Œé€šè¿‡è°ƒç”¨ atom.SetLevel æ›´æ”¹æ—¥å¿—çº§åˆ«ä¸º infoLevel ã€‚\né—®é¢˜ 2:\næ²¡æœ‰æ‰“å°ã€‚zap.Development() å¯ç”¨äº†å¼€å‘æ¨¡å¼ï¼Œåœ¨å¼€å‘æ¨¡å¼ä¸‹ DPanic å‡½æ•°ä¼šå¼•å‘ panicï¼Œæ‰€ä»¥æœ€åçš„ error ä¸ä¼šæ‰“å°åˆ°æ§åˆ¶å°ã€‚\næºç åˆ†æ æ­¤æ¬¡æºç åˆ†æåŸºäº Zap 1.16\nä¸Šå›¾ä»…è¡¨ç¤º zap å¯è°ƒç”¨ä¸¤ç§ loggerï¼Œæ²¡æœ‰è¡¨è¾¾ Logger ä¸ SugaredLogger çš„å…³ç³»ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼Œä½ ä¼šæ›´ç†è§£ã€‚\nLogger logger æä¾›å¿«é€Ÿï¼Œåˆ†çº§ï¼Œç»“æ„åŒ–çš„æ—¥å¿—è®°å½•ã€‚æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯å®‰å…¨çš„ï¼Œå†…å­˜åˆ†é…å¾ˆé‡è¦ï¼Œå› æ­¤å®ƒçš„ API æœ‰æ„åå‘äºæ€§èƒ½å’Œç±»å‹å®‰å…¨ã€‚\nzap@v1.16.0 - logger.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Logger struct { // å®ç°ç¼–ç å’Œè¾“å‡ºçš„æ¥å£ core zapcore.Core // è®°å½•å™¨å¼€å‘æ¨¡å¼ï¼ŒDPanic ç­‰çº§å°†è®°å½• panic development bool // å¼€å¯è®°å½•è°ƒç”¨è€…çš„è¡Œå·å’Œå‡½æ•°å addCaller bool\t// è‡´å‘½æ—¥å¿—é‡‡å–çš„æ“ä½œï¼Œé»˜è®¤å†™å…¥æ—¥å¿—å os.Exit() onFatal zapcore.CheckWriteAction name string\t// è®¾ç½®è®°å½•å™¨ç”Ÿæˆçš„é”™è¯¯ç›®çš„åœ° errorOutput zapcore.WriteSyncer // è®°å½• \u0026gt;= è¯¥æ—¥å¿—ç­‰çº§çš„å †æ ˆè¿½è¸ª addStack zapcore.LevelEnabler // é¿å…è®°å½•å™¨è®¤ä¸ºå°è£…å‡½æ•°ä¸ºè°ƒç”¨æ–¹ callerSkip int\t// é»˜è®¤ä¸ºç³»ç»Ÿæ—¶é—´ clock Clock\t} åœ¨ Example ä¸­åˆ†åˆ«ä½¿ç”¨äº† NewProduction å’Œ NewDevelopment ï¼Œæ¥ä¸‹æ¥ä»¥è¿™ä¸¤ä¸ªå‡½æ•°å¼€å§‹åˆ†æã€‚ä¸‹å›¾è¡¨ç¤º A å‡½æ•°è°ƒç”¨äº† B å‡½æ•°ï¼Œå…¶ä¸­ç®­å¤´è¡¨ç¤ºå‡½æ•°è°ƒç”¨å…³ç³»ã€‚å›¾ä¸­å‡½æ•°éƒ½ä¼šåˆ†æåˆ°ã€‚\nNewProduction\nä»ä¸‹é¢ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ­¤å‡½æ•°æ˜¯å¯¹ NewProductionConfig().Build(...) å°è£…çš„å¿«æ·æ–¹å¼ã€‚\nzap@v1.16.0 - logger.go\n1 2 3 func NewProduction(options ...Option) (*Logger, error) { return NewProductionConfig().Build(options...) } NewProductionConfig\nåœ¨ InfoLevel åŠæ›´é«˜çº§åˆ«ä¸Šå¯ç”¨äº†æ—¥å¿—è®°å½•ã€‚å®ƒä½¿ç”¨ JSON ç¼–ç å™¨ï¼Œå†™å…¥ stderrï¼Œå¯ç”¨é‡‡æ ·ã€‚\nzap@v1.16.0 - config.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func NewProductionConfig() Config { return Config{ // info æ—¥å¿—çº§åˆ« Level: NewAtomicLevelAt(InfoLevel), // éå¼€å‘æ¨¡å¼ Development: false, // é‡‡æ ·è®¾ç½® Sampling: \u0026amp;SamplingConfig{ Initial: 100, // ç›¸åŒæ—¥å¿—çº§åˆ«ä¸‹ç›¸åŒå†…å®¹æ¯ç§’æ—¥å¿—è¾“å‡ºæ•°é‡ Thereafter: 100, // è¶…è¿‡è¯¥æ•°é‡ï¼Œæ‰ä¼šå†æ¬¡è¾“å‡º }, // JSON ç¼–ç å™¨ Encoding: \u0026#34;json\u0026#34;, // åé¢ä»‹ç» EncoderConfig: NewProductionEncoderConfig(), // è¾“å‡ºåˆ° stderr OutputPaths: []string{\u0026#34;stderr\u0026#34;}, ErrorOutputPaths: []string{\u0026#34;stderr\u0026#34;}, } } Config ç»“æ„ä½“\né€šè¿‡ Config å¯ä»¥è®¾ç½®é€šç”¨çš„é…ç½®é¡¹ã€‚\nzap@v1.16.0 - config.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 type Config struct { // æ—¥å¿—çº§åˆ« Level AtomicLevel `json:\u0026#34;level\u0026#34; yaml:\u0026#34;level\u0026#34;` // å¼€å‘æ¨¡å¼ Development bool `json:\u0026#34;development\u0026#34; yaml:\u0026#34;development\u0026#34;` // åœæ­¢ä½¿ç”¨è°ƒç”¨æ–¹çš„å‡½æ•°å’Œè¡Œå· DisableCaller bool `json:\u0026#34;disableCaller\u0026#34; yaml:\u0026#34;disableCaller\u0026#34;` // å®Œå…¨åœæ­¢ä½¿ç”¨å †æ ˆè·Ÿè¸ªï¼Œé»˜è®¤ä¸º `\u0026gt;=WarnLevel` ä½¿ç”¨å †æ ˆè·Ÿè¸ª DisableStacktrace bool `json:\u0026#34;disableStacktrace\u0026#34; yaml:\u0026#34;disableStacktrace\u0026#34;` // é‡‡æ ·è®¾ç½®ç­–ç•¥ Sampling *SamplingConfig `json:\u0026#34;sampling\u0026#34; yaml:\u0026#34;sampling\u0026#34;` // è®°å½•å™¨çš„ç¼–ç ï¼Œæœ‰æ•ˆå€¼ä¸º \u0026#39;json\u0026#39; å’Œ \u0026#39;console\u0026#39; ä»¥åŠé€šè¿‡ `RegisterEncoder` æ³¨å†Œçš„æœ‰æ•ˆç¼–ç  Encoding string `json:\u0026#34;encoding\u0026#34; yaml:\u0026#34;encoding\u0026#34;` // ç¼–ç å™¨é€‰é¡¹ EncoderConfig zapcore.EncoderConfig `json:\u0026#34;encoderConfig\u0026#34; yaml:\u0026#34;encoderConfig\u0026#34;` // æ—¥å¿—çš„è¾“å‡ºè·¯å¾„ OutputPaths []string `json:\u0026#34;outputPaths\u0026#34; yaml:\u0026#34;outputPaths\u0026#34;` // zap å†…éƒ¨é”™è¯¯çš„è¾“å‡ºè·¯å¾„ ErrorOutputPaths []string `json:\u0026#34;errorOutputPaths\u0026#34; yaml:\u0026#34;errorOutputPaths\u0026#34;` // æ·»åŠ åˆ°æ ¹è®°å½•å™¨çš„å­—æ®µçš„é›†åˆ InitialFields map[string]interface{} `json:\u0026#34;initialFields\u0026#34; yaml:\u0026#34;initialFields\u0026#34;` } NewDevelopment\nä»ä¸‹é¢ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ­¤å‡½æ•°æ˜¯å¯¹ NewDevelopmentConfig().Build(...) å°è£…çš„å¿«æ·æ–¹å¼\nzap@v1.16.0 - logger.go\n1 2 3 func NewDevelopment(options ...Option) (*Logger, error) { return NewDevelopmentConfig().Build(options...) } NewDevelopmentConfig\næ­¤å‡½æ•°åœ¨ DebugLevel åŠæ›´é«˜ç‰ˆæœ¬ä¸Šå¯ç”¨æ—¥å¿—è®°å½•ï¼Œå®ƒä½¿ç”¨ console ç¼–ç å™¨ï¼Œå†™å…¥ stderrï¼Œç¦ç”¨é‡‡æ ·ã€‚\nzap@v1.16.0 - config.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func NewDevelopmentConfig() Config { return Config{ // debug ç­‰çº§ Level: NewAtomicLevelAt(DebugLevel), // å¼€å‘æ¨¡å¼ Development: true, // console ç¼–ç å™¨ Encoding: \u0026#34;console\u0026#34;, EncoderConfig: NewDevelopmentEncoderConfig(), // è¾“å‡ºåˆ° stderr OutputPaths: []string{\u0026#34;stderr\u0026#34;}, ErrorOutputPaths: []string{\u0026#34;stderr\u0026#34;}, } } NewProductionEncoderConfig å’Œ NewDevelopmentEncoderConfig éƒ½æ˜¯è¿”å›ç¼–ç å™¨é…ç½®ã€‚\nzap@v1.16.0 - config.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 type EncoderConfig struct { // è®¾ç½® ç¼–ç ä¸º JSON æ—¶çš„ KEY // å¦‚æœä¸ºç©ºï¼Œåˆ™çœç•¥ MessageKey string `json:\u0026#34;messageKey\u0026#34; yaml:\u0026#34;messageKey\u0026#34;` LevelKey string `json:\u0026#34;levelKey\u0026#34; yaml:\u0026#34;levelKey\u0026#34;` TimeKey string `json:\u0026#34;timeKey\u0026#34; yaml:\u0026#34;timeKey\u0026#34;` NameKey string `json:\u0026#34;nameKey\u0026#34; yaml:\u0026#34;nameKey\u0026#34;` CallerKey string `json:\u0026#34;callerKey\u0026#34; yaml:\u0026#34;callerKey\u0026#34;` FunctionKey string `json:\u0026#34;functionKey\u0026#34; yaml:\u0026#34;functionKey\u0026#34;` StacktraceKey string `json:\u0026#34;stacktraceKey\u0026#34; yaml:\u0026#34;stacktraceKey\u0026#34;` // é…ç½®è¡Œåˆ†éš”ç¬¦ LineEnding string `json:\u0026#34;lineEnding\u0026#34; yaml:\u0026#34;lineEnding\u0026#34;` // é…ç½®å¸¸è§å¤æ‚ç±»å‹çš„åŸºæœ¬è¡¨ç¤ºå½¢å¼ã€‚ EncodeLevel LevelEncoder `json:\u0026#34;levelEncoder\u0026#34; yaml:\u0026#34;levelEncoder\u0026#34;` EncodeTime TimeEncoder `json:\u0026#34;timeEncoder\u0026#34; yaml:\u0026#34;timeEncoder\u0026#34;` EncodeDuration DurationEncoder `json:\u0026#34;durationEncoder\u0026#34; yaml:\u0026#34;durationEncoder\u0026#34;` EncodeCaller CallerEncoder `json:\u0026#34;callerEncoder\u0026#34; yaml:\u0026#34;callerEncoder\u0026#34;` // æ—¥å¿—åç§°ï¼Œæ­¤å‚æ•°å¯é€‰ EncodeName NameEncoder `json:\u0026#34;nameEncoder\u0026#34; yaml:\u0026#34;nameEncoder\u0026#34;` // é…ç½® console ç¼–ç å™¨ä½¿ç”¨çš„å­—æ®µåˆ†éš”ç¬¦ï¼Œé»˜è®¤ tab ConsoleSeparator string `json:\u0026#34;consoleSeparator\u0026#34; yaml:\u0026#34;consoleSeparator\u0026#34;` } NewProductionEncoderConfig\nzap@v1.16.0 - config.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func NewProductionEncoderConfig() zapcore.EncoderConfig { return zapcore.EncoderConfig{ TimeKey: \u0026#34;ts\u0026#34;, LevelKey: \u0026#34;level\u0026#34;, NameKey: \u0026#34;logger\u0026#34;, CallerKey: \u0026#34;caller\u0026#34;, FunctionKey: zapcore.OmitKey, MessageKey: \u0026#34;msg\u0026#34;, StacktraceKey: \u0026#34;stacktrace\u0026#34;, // é»˜è®¤æ¢è¡Œç¬¦ \\n LineEnding: zapcore.DefaultLineEnding, // æ—¥å¿—ç­‰çº§åºåˆ—ä¸ºå°å†™å­—ç¬¦ä¸²ï¼Œå¦‚:InfoLevelè¢«åºåˆ—åŒ–ä¸º \u0026#34;info\u0026#34; EncodeLevel: zapcore.LowercaseLevelEncoder, // æ—¶é—´åºåˆ—åŒ–æˆæµ®ç‚¹ç§’æ•° EncodeTime: zapcore.EpochTimeEncoder, // æ—¶é—´åºåˆ—åŒ–ï¼ŒDurationä¸ºç»è¿‡çš„æµ®ç‚¹ç§’æ•° EncodeDuration: zapcore.SecondsDurationEncoder, // ä»¥ åŒ…å/æ–‡ä»¶å:è¡Œæ•° æ ¼å¼åºåˆ—åŒ– EncodeCaller: zapcore.ShortCallerEncoder, } } è¯¥é…ç½®ä¼šè¾“å‡ºå¦‚ä¸‹ç»“æœï¼Œæ­¤ç»“æœå‡ºå¤„å‚è§ Example ä¸­çš„ä¾‹ä¸€\n1 {\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;ts\u0026#34;:1620367988.461055,\u0026#34;caller\u0026#34;:\u0026#34;test/use_test.go:24\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;Failed to fetch URL: https://baidu.com\u0026#34;} NewDevelopmentEncoderConfig\nzap@v1.16.0 - config.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func NewDevelopmentEncoderConfig() zapcore.EncoderConfig { return zapcore.EncoderConfig{ // keys å€¼å¯ä»¥æ˜¯ä»»æ„éç©ºçš„å€¼ TimeKey: \u0026#34;T\u0026#34;, LevelKey: \u0026#34;L\u0026#34;, NameKey: \u0026#34;N\u0026#34;, CallerKey: \u0026#34;C\u0026#34;, FunctionKey: zapcore.OmitKey, MessageKey: \u0026#34;M\u0026#34;, StacktraceKey: \u0026#34;S\u0026#34;, // é»˜è®¤æ¢è¡Œç¬¦ \\n LineEnding: zapcore.DefaultLineEnding, // æ—¥å¿—ç­‰çº§åºåˆ—ä¸ºå¤§å†™å­—ç¬¦ä¸²ï¼Œå¦‚:InfoLevelè¢«åºåˆ—åŒ–ä¸º \u0026#34;INFO\u0026#34; EncodeLevel: zapcore.CapitalLevelEncoder, // æ—¶é—´æ ¼å¼åŒ–ä¸º ISO8601 æ ¼å¼ EncodeTime: zapcore.ISO8601TimeEncoder, EncodeDuration: zapcore.StringDurationEncoder, // // ä»¥ åŒ…å/æ–‡ä»¶å:è¡Œæ•° æ ¼å¼åºåˆ—åŒ– EncodeCaller: zapcore.ShortCallerEncoder, } } è¯¥é…ç½®ä¼šè¾“å‡ºå¦‚ä¸‹ç»“æœï¼Œæ­¤ç»“æœå‡ºå¤„å‚è§ Example ä¸­çš„ ä¾‹äºŒ\n1 2021-05-07T14:14:12.434+0800\tINFO\ttest/use_test.go:31\tfailed to fetch URL\t{\u0026#34;url\u0026#34;: \u0026#34;https://baidu.com\u0026#34;, \u0026#34;attempt\u0026#34;: 3, \u0026#34;backoff\u0026#34;: \u0026#34;1s\u0026#34;} NewProductionConfig å’Œ NewDevelopmentConfig è¿”å› config è°ƒç”¨ Build å‡½æ•°è¿”å› loggerï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°ã€‚\nzap@v1.16.0 - config.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func (cfg Config) Build(opts ...Option) (*Logger, error) { enc, err := cfg.buildEncoder() if err != nil { return nil, err } sink, errSink, err := cfg.openSinks() if err != nil { return nil, err } if cfg.Level == (AtomicLevel{}) { return nil, fmt.Errorf(\u0026#34;missing Level\u0026#34;) } log := New( zapcore.NewCore(enc, sink, cfg.Level), cfg.buildOptions(errSink)..., ) if len(opts) \u0026gt; 0 { log = log.WithOptions(opts...) } return log, nil } ä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé€šè¿‡è§£æ config çš„å‚æ•°ï¼Œè°ƒç”¨ New æ–¹æ³•æ¥åˆ›å»º Loggerã€‚åœ¨ Example ä¸­ä¾‹å››ï¼Œå°±æ˜¯è°ƒç”¨ New æ–¹æ³•æ¥è‡ªå®šä¹‰ Loggerã€‚\nSugaredLogger Logger ä½œä¸º SugaredLogger çš„å±æ€§ï¼Œè¿™ä¸ªå°è£…ä¼˜ç‚¹åœ¨äºä¸æ˜¯å¾ˆåœ¨ä¹æ€§èƒ½çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å¿«é€Ÿè°ƒç”¨Loggerã€‚æ‰€ä»¥åå­—ä¸ºåŠ äº†ç³–çš„ Loggerã€‚\nzap@v1.16.0 - logger.go\n1 2 3 type SugaredLogger struct { base *Logger } 1 2 3 zap.ReplaceGlobals(logger)\t// é‡æ–°é…ç½®å…¨å±€å˜é‡ zap.S().Info(\u0026#34;SugaredLogger\u0026#34;) // S è¿”å›å…¨å±€ SugaredLogger zap.L().Info(\u0026#34;logger\u0026#34;)\t// L è¿”å›å…¨å±€ logger ä¸Loggerä¸åŒï¼ŒSugaredLoggerä¸å¼ºåˆ¶æ—¥å¿—ç»“æ„åŒ–ã€‚æ‰€ä»¥å¯¹äºæ¯ä¸ªæ—¥å¿—çº§åˆ«ï¼Œéƒ½æä¾›äº†ä¸‰ç§æ–¹æ³•ã€‚\nzap@v1.16.0 - sugar.go\nä»¥ info çº§åˆ«ä¸ºä¾‹ï¼Œç›¸å…³çš„ä¸‰ç§æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Info ä½¿ç”¨ fmt.Sprint æ„é€ å’Œè®°å½•æ¶ˆæ¯ã€‚ func (s *SugaredLogger) Info(args ...interface{}) { s.log(InfoLevel, \u0026#34;\u0026#34;, args, nil) } // Infof ä½¿ç”¨ fmt.Sprintf è®°å½•æ¨¡æ¿æ¶ˆæ¯ã€‚ func (s *SugaredLogger) Infof(template string, args ...interface{}) { s.log(InfoLevel, template, args, nil) } // Infow è®°å½•å¸¦æœ‰å…¶ä»–ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯ func (s *SugaredLogger) Infow(msg string, keysAndValues ...interface{}) { s.log(InfoLevel, msg, nil, keysAndValues) } åœ¨ sugar.Infof(\u0026quot;...\u0026quot;) æ‰“ä¸Šæ–­ç‚¹ï¼Œä»è¿™å¼€å§‹è¿½è¸ªæºç ã€‚\nåœ¨è°ƒè¯•ä»£ç ä¹‹å‰ï¼Œå…ˆç»™å¤§å®¶çœ‹ä¸€ä¸‹SugaredLogger çš„ Infof å‡½æ•°çš„è°ƒç”¨çš„å¤§è‡´å·¥ä½œæµï¼Œå…¶ä¸­ä¸æ¶‰åŠé‡‡æ ·ç­‰ã€‚\nInfo , Infof, Infow ä¸‰ä¸ªå‡½æ•°éƒ½è°ƒç”¨äº† log å‡½æ•°ï¼Œlog å‡½æ•°ä»£ç å¦‚ä¸‹\nzap@v1.16.0 - sugar.go\n1 2 3 4 5 6 7 8 9 10 11 12 func (s *SugaredLogger) log(lvl zapcore.Level, template string, fmtArgs []interface{}, context []interface{}) { // åˆ¤æ–­æ˜¯å¦å¯ç”¨çš„æ—¥å¿—çº§åˆ« if lvl \u0026lt; DPanicLevel \u0026amp;\u0026amp; !s.base.Core().Enabled(lvl) { return } // å°†å‚æ•°åˆå¹¶åˆ°è¯­å¥ä¸­ msg := getMessage(template, fmtArgs) // Check å¯ä»¥å¸®åŠ©é¿å…åˆ†é…ä¸€ä¸ªåˆ†ç‰‡æ¥ä¿å­˜å­—æ®µã€‚ if ce := s.base.Check(lvl, msg); ce != nil { ce.Write(s.sweetenFields(context)...) } } å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° InfoLevel æ˜¯æ—¥å¿—çº§åˆ«ï¼Œå…¶æºç å¦‚ä¸‹\nzap@v1.16.0 - zapcore/level.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 const ( // Debug åº”æ˜¯å¤§é‡çš„ï¼Œä¸”é€šå¸¸åœ¨ç”Ÿäº§çŠ¶æ€ç¦ç”¨. DebugLevel = zapcore.DebugLevel // Info æ˜¯é»˜è®¤çš„è®°å½•ä¼˜å…ˆçº§. InfoLevel = zapcore.InfoLevel // Warn æ¯” info æ›´é‡è¦. WarnLevel = zapcore.WarnLevel // Error æ˜¯é«˜ä¼˜å…ˆçº§çš„,å¦‚æœç¨‹åºé¡ºåˆ©ä¸åº”è¯¥äº§ç”Ÿä»»ä½• err çº§åˆ«æ—¥å¿—. ErrorLevel = zapcore.ErrorLevel // DPanic ç‰¹åˆ«é‡å¤§çš„é”™è¯¯ï¼Œåœ¨å¼€å‘æ¨¡å¼ä¸‹å¼•èµ· panic. DPanicLevel = zapcore.DPanicLevel // Panic è®°å½•æ¶ˆæ¯åè°ƒç”¨ panic. PanicLevel = zapcore.PanicLevel // Fatal è®°å½•æ¶ˆæ¯åè°ƒç”¨ os.Exit(1). FatalLevel = zapcore.FatalLevel ) getMessage å‡½æ•°å¤„ç† template å’Œ fmtArgs å‚æ•°ï¼Œä¸»è¦ä¸ºä¸åŒçš„å‚æ•°é€‰æ‹©æœ€åˆé€‚çš„æ–¹å¼æ‹¼æ¥æ¶ˆæ¯\nzap@v1.16.0 - sugar.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func getMessage(template string, fmtArgs []interface{}) string { // æ²¡æœ‰å‚æ•°ç›´æ¥è¿”å› template if len(fmtArgs) == 0 { return template } // æ­¤å¤„è°ƒç”¨ Sprintf ä¼šä½¿ç”¨åå°„ if template != \u0026#34;\u0026#34; { return fmt.Sprintf(template, fmtArgs...) } // æ¶ˆæ¯ä¸ºç©ºå¹¶ä¸”æœ‰ä¸€ä¸ªå‚æ•°ï¼Œè¿”å›è¯¥å‚æ•° if len(fmtArgs) == 1 { if str, ok := fmtArgs[0].(string); ok { return str } } // è¿”å›æ‰€æœ‰ fmtArgs return fmt.Sprint(fmtArgs...) } å…³äº s.base.Check ï¼Œè¿™å°±éœ€è¦ä»‹ç»zapcore ï¼Œä¸‹é¢åˆ†æç›¸å…³æ¨¡å—ã€‚\nzapcore zapcoreåŒ… å®šä¹‰å¹¶å®ç°äº†æ„å»º zap çš„ä½çº§æ¥å£ã€‚é€šè¿‡æä¾›è¿™äº›æ¥å£çš„æ›¿ä»£å®ç°ï¼Œå¤–éƒ¨åŒ…å¯ä»¥æ‰©å±• zap çš„åŠŸèƒ½ã€‚\nzap@v1.16.0 - zapcore/core.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Core æ˜¯ä¸€ä¸ªæœ€å°çš„ã€å¿«é€Ÿçš„è®°å½•å™¨æ¥å£ã€‚ type Core interface { // æ¥å£ï¼Œå†³å®šä¸€ä¸ªæ—¥å¿—ç­‰çº§æ˜¯å¦å¯ç”¨ LevelEnabler // å‘ core æ·»åŠ æ ¸å¿ƒä¸Šä¸‹æ–‡ With([]Field) Core // æ£€æŸ¥æ˜¯å¦åº”è®°å½•æä¾›çš„æ¡ç›® // åœ¨è°ƒç”¨ write ä¹‹å‰å¿…é¡»å…ˆè°ƒç”¨ Check Check(Entry, *CheckedEntry) *CheckedEntry // å†™å…¥æ—¥å¿— Write(Entry, []Field) error // åŒæ­¥åˆ·æ–°ç¼“å­˜æ—¥å¿—(å¦‚æœæœ‰) Sync() error } Check å‡½æ•°æœ‰ä¸¤ä¸ªå…¥å‚ã€‚ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºä¸€æ¡å®Œæ•´çš„æ—¥å¿—æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º nil æ—¶ä¼šä» sync.Pool åˆ›å»ºçš„æ± ä¸­å–å‡º*CheckedEntry å¯¹è±¡å¤ç”¨ï¼Œé¿å…é‡æ–°åˆ†é…å†…å­˜ã€‚è¯¥å‡½æ•°å†…éƒ¨è°ƒç”¨ AddCore å®ç°è·å– *CheckedEntryå¯¹è±¡ï¼Œæœ€åè°ƒç”¨ Write å†™å…¥æ—¥å¿—æ¶ˆæ¯ã€‚\nç›¸å…³ä»£ç å…¨éƒ¨è´´åœ¨ä¸‹é¢ï¼Œæ›´å¤šä»‹ç»è¯·çœ‹ä»£ç ä¸­çš„æ³¨é‡Šã€‚\nzap@v1.16.0 - zapcore/entry.go\n1 2 3 4 5 6 7 8 9 // ä¸€ä¸ª entry è¡¨ç¤ºä¸€ä¸ªå®Œæ•´çš„æ—¥å¿—æ¶ˆæ¯ type Entry struct { Level Level Time time.Time LoggerName string Message string Caller EntryCaller Stack string } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 // ä½¿ç”¨ sync.Pool å¤ç”¨ä¸´æ—¶å¯¹è±¡ var ( _cePool = sync.Pool{New: func() interface{} { return \u0026amp;CheckedEntry{ cores: make([]Core, 4), } }} ) // ä»æ± ä¸­å–å‡º CheckedEntry å¹¶åˆå§‹åŒ–å€¼ func getCheckedEntry() *CheckedEntry { ce := _cePool.Get().(*CheckedEntry) ce.reset() return ce } // CheckedEntry æ˜¯ enter å’Œ cores é›†åˆã€‚ type CheckedEntry struct { Entry ErrorOutput WriteSyncer dirty bool // ç”¨äºæ£€æµ‹æ˜¯å¦é‡å¤ä½¿ç”¨å¯¹è±¡ should CheckWriteAction // ç»“æŸç¨‹åºçš„åŠ¨ä½œ cores []Core } // é‡ç½®å¯¹è±¡ func (ce *CheckedEntry) reset() { ce.Entry = Entry{} ce.ErrorOutput = nil ce.dirty = false ce.should = WriteThenNoop for i := range ce.cores { // ä¸è¦ä¿ç•™å¯¹ core çš„å¼•ç”¨!! ce.cores[i] = nil } ce.cores = ce.cores[:0] } // å°† entry å†™å…¥å­˜å‚¨çš„ cores // æœ€åå°† CheckedEntry æ·»åŠ åˆ°æ± ä¸­ func (ce *CheckedEntry) Write(fields ...Field) { if ce == nil { return } if ce.dirty { if ce.ErrorOutput != nil { // æ£€æŸ¥ CheckedEntry çš„ä¸å®‰å…¨é‡å¤ä½¿ç”¨ fmt.Fprintf(ce.ErrorOutput, \u0026#34;%v Unsafe CheckedEntry re-use near Entry %+v.\\n\u0026#34;, ce.Time, ce.Entry) ce.ErrorOutput.Sync() } return } ce.dirty = true var err error // å†™å…¥æ—¥å¿—æ¶ˆæ¯ for i := range ce.cores { err = multierr.Append(err, ce.cores[i].Write(ce.Entry, fields)) } // å¤„ç†å†…éƒ¨å‘ç”Ÿçš„é”™è¯¯ if ce.ErrorOutput != nil { if err != nil { fmt.Fprintf(ce.ErrorOutput, \u0026#34;%v write error: %v\\n\u0026#34;, ce.Time, err) ce.ErrorOutput.Sync() } } should, msg := ce.should, ce.Message // å°† CheckedEntry æ·»åŠ åˆ°æ± ä¸­ï¼Œä¸‹æ¬¡å¤ç”¨ putCheckedEntry(ce) // åˆ¤æ–­æ˜¯å¦éœ€è¦ panic æˆ–å…¶å®ƒæ–¹å¼ç»ˆæ­¢ç¨‹åº.. switch should { case WriteThenPanic: panic(msg) case WriteThenFatal: exit.Exit() case WriteThenGoexit: runtime.Goexit() } } func (ce *CheckedEntry) AddCore(ent Entry, core Core) *CheckedEntry { if ce == nil { // ä»æ± ä¸­å– CheckedEntryï¼Œå‡å°‘å†…å­˜åˆ†é… ce = getCheckedEntry() ce.Entry = ent } ce.cores = append(ce.cores, core) return ce } Doc https://pkg.go.dev/go.uber.org/zap\nQA è®¾è®¡é—®é¢˜ ä¸ºä»€ä¹ˆè¦åœ¨Loggeræ€§èƒ½ä¸ŠèŠ±è´¹è¿™ä¹ˆå¤šç²¾åŠ›å‘¢ï¼Ÿ å½“ç„¶ï¼Œå¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸ä¼šæ³¨æ„åˆ°Loggeræ…¢çš„å½±å“ï¼šå› ä¸ºå®ƒä»¬æ¯æ¬¡æ“ä½œä¼šéœ€è¦å‡ åæˆ–å‡ ç™¾æ¯«ç§’ï¼Œæ‰€ä»¥é¢å¤–çš„å‡ æ¯«ç§’å¾ˆæ— å…³ç´§è¦ã€‚\nå¦ä¸€æ–¹é¢ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—å¿«é€Ÿå¼€å‘å‘¢ï¼Ÿä¸å…¶ä»–æ—¥å¿—åŒ…ç›¸æ¯”SugaredLoggerçš„ä½¿ç”¨å¹¶ä¸éš¾ï¼ŒLoggerä½¿ç»“æ„åŒ–è®°å½•åœ¨å¯¹æ€§èƒ½è¦æ±‚ä¸¥æ ¼çš„ç¯å¢ƒä¸­æˆä¸ºå¯èƒ½ã€‚åœ¨ Go å¾®æœåŠ¡çš„æ¶æ„ä½“ç³»ä¸­ï¼Œä½¿æ¯ä¸ªåº”ç”¨ç¨‹åºç”šè‡³ç¨å¾®æ›´æœ‰æ•ˆåœ°åŠ é€Ÿæ‰§è¡Œã€‚\nä¸ºä»€ä¹ˆæ²¡æœ‰Loggerå’ŒSugaredLoggeræ¥å£ï¼Ÿ ä¸åƒç†Ÿæ‚‰çš„io.Writerå’Œhttp.Handlerã€Loggerå’ŒSugaredLoggeræ¥å£å°†åŒ…æ‹¬å¾ˆå¤šæ–¹æ³•ã€‚æ­£å¦‚ Rob Pike è°šè¯­æŒ‡å‡ºçš„ï¼Œ\u0026ldquo;The bigger the interface, the weaker the abstraction\u0026rdquo;(æ¥å£è¶Šå¤§ï¼ŒæŠ½è±¡è¶Šå¼±)ã€‚æ¥å£ä¹Ÿæ˜¯ä¸¥æ ¼çš„ï¼Œä»»ä½•æ›´æ”¹éƒ½éœ€è¦å‘å¸ƒä¸€ä¸ªæ–°çš„ä¸»ç‰ˆæœ¬ï¼Œå› ä¸ºå®ƒæ‰“ç ´äº†æ‰€æœ‰ç¬¬ä¸‰æ–¹å®ç°ã€‚\nLoggerå’ŒSugaredLoggeræˆä¸ºå…·ä½“ç±»å‹å¹¶ä¸ä¼šç‰ºç‰²å¤ªå¤šæŠ½è±¡ï¼Œè€Œä¸”å®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸å¼•å…¥ç ´åæ€§æ›´æ”¹çš„æƒ…å†µä¸‹æ·»åŠ æ–¹æ³•ã€‚æ‚¨çš„åº”ç”¨ç¨‹åºåº”è¯¥å®šä¹‰å¹¶ä¾èµ–åªåŒ…å«æ‚¨ä½¿ç”¨çš„æ–¹æ³•çš„æ¥å£ã€‚\nä¸ºä»€ä¹ˆæˆ‘çš„ä¸€äº›æ—¥å¿—ä¼šä¸¢å¤±ï¼Ÿ åœ¨å¯ç”¨æŠ½æ ·æ—¶ï¼Œé€šè¿‡zapæœ‰æ„åœ°åˆ é™¤æ—¥å¿—ã€‚ç”Ÿäº§é…ç½®(å¦‚NewProductionConfig()è¿”å›çš„é‚£æ ·)æ”¯æŒæŠ½æ ·ï¼Œè¿™å°†å¯¼è‡´åœ¨ä¸€ç§’é’Ÿå†…å¯¹é‡å¤æ—¥å¿—è¿›è¡ŒæŠ½æ ·ã€‚æœ‰å…³ä¸ºä»€ä¹ˆå¯ç”¨æŠ½æ ·çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§\u0026ldquo;ä¸ºä»€ä¹ˆä½¿ç”¨ç¤ºä¾‹åº”ç”¨æ—¥å¿—\u0026quot;ä¸­å¯ç”¨é‡‡æ ·.\nä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¤ºä¾‹åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Ÿ åº”ç”¨ç¨‹åºç»å¸¸ä¼šé‡åˆ°é”™è¯¯ï¼Œæ— è®ºæ˜¯å› ä¸ºé”™è¯¯è¿˜æ˜¯å› ä¸ºç”¨æˆ·ä½¿ç”¨é”™è¯¯ã€‚è®°å½•é”™è¯¯æ—¥å¿—é€šå¸¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œä½†å®ƒå¾ˆå®¹æ˜“ä½¿è¿™ç§ç³Ÿç³•çš„æƒ…å†µå˜å¾—æ›´ç³Ÿï¼šä¸ä»…æ‚¨çš„åº”ç”¨ç¨‹åºåº”å¯¹å¤§é‡é”™è¯¯ï¼Œå®ƒè¿˜èŠ±è´¹é¢å¤–çš„CPUå‘¨æœŸå’ŒI/Oè®°å½•è¿™äº›é”™è¯¯æ—¥å¿—ã€‚ç”±äºå†™å…¥é€šå¸¸æ˜¯åºåˆ—åŒ–çš„ï¼Œå› æ­¤åœ¨æœ€éœ€è¦æ—¶ï¼Œloggerä¼šé™åˆ¶ååé‡ã€‚\né‡‡æ ·é€šè¿‡åˆ é™¤é‡å¤çš„æ—¥å¿—æ¡ç›®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºä¼šè¾“å‡ºæ¯ä¸ªè®°å½•ã€‚ä½†æ˜¯ï¼Œå½“ç±»ä¼¼çš„è®°å½•æ¯ç§’è¾“å‡ºæ•°ç™¾æˆ–æ•°åƒæ¬¡æ—¶ï¼Œzap å¼€å§‹ä¸¢å¼ƒé‡å¤ä»¥ä¿å­˜ååé‡ã€‚\nä¸ºä»€ä¹ˆç»“æ„åŒ–çš„æ—¥å¿— API é™¤äº†æ¥å—å­—æ®µä¹‹å¤–è¿˜å¯ä»¥æ¥æ”¶æ¶ˆæ¯ï¼Ÿ ä¸»è§‚ä¸Šï¼Œæˆ‘ä»¬å‘ç°åœ¨ç»“æ„åŒ–ä¸Šä¸‹æ–‡ä¸­é™„å¸¦ä¸€ä¸ªç®€çŸ­çš„æè¿°æ˜¯æœ‰å¸®åŠ©çš„ã€‚è¿™åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¹¶ä¸å…³é”®ï¼Œä½†å®ƒä½¿è°ƒè¯•å’Œæ“ä½œä¸ç†Ÿæ‚‰çš„ç³»ç»Ÿæ›´åŠ å®¹æ˜“ã€‚\næ›´å…·ä½“åœ°è¯´ï¼Œzap çš„é‡‡æ ·ç®—æ³•ä½¿ç”¨æ¶ˆæ¯æ¥è¯†åˆ«é‡å¤çš„æ¡ç›®ã€‚æ ¹æ®æˆ‘ä»¬çš„ç»éªŒï¼Œè¿™æ˜¯ä¸€ä¸ªä»‹äºéšæœºæŠ½æ ·ï¼ˆé€šå¸¸åœ¨è°ƒè¯•æ—¶åˆ é™¤æ‚¨éœ€è¦çš„ç¡®åˆ‡æ¡ç›®ï¼‰å’Œå“ˆå¸Œå®Œæ•´æ¡ç›®ï¼ˆä»£ä»·é«˜ï¼‰ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´æ–¹æ³•ã€‚\nä¸ºä»€ä¹ˆè¦åŒ…æ‹¬å…¨å±€ loggersï¼Ÿ ç”±äºè®¸å¤šå…¶ä»–æ—¥å¿—åŒ…éƒ½åŒ…å«å…¨å±€å˜é‡loggerï¼Œè®¸å¤šåº”ç”¨ç¨‹åºæ²¡æœ‰è®¾è®¡æˆæ¥æ”¶loggerä½œä¸ºæ˜¾å¼å‚æ•°ã€‚æ›´æ”¹å‡½æ•°ç­¾åé€šå¸¸æ˜¯ä¸€ç§ç ´åæ€§çš„æ›´æ”¹ï¼Œå› æ­¤zapåŒ…å«å…¨å±€loggerä»¥ç®€åŒ–è¿ç§»ã€‚\nå°½å¯èƒ½é¿å…ä½¿ç”¨å®ƒä»¬ã€‚\nä¸ºä»€ä¹ˆåŒ…æ‹¬ä¸“ç”¨çš„Panicå’ŒFatalæ—¥å¿—çº§åˆ«ï¼Ÿ ä¸€èˆ¬æ¥è¯´ï¼Œåº”ç”¨ç¨‹åºä»£ç åº”ä¼˜é›…åœ°å¤„ç†é”™è¯¯ï¼Œè€Œä¸æ˜¯ä½¿ç”¨panicæˆ–os.Exitã€‚ä½†æ˜¯ï¼Œæ¯ä¸ªè§„åˆ™éƒ½æœ‰ä¾‹å¤–ï¼Œå½“é”™è¯¯ç¡®å®æ— æ³•æ¢å¤æ—¶ï¼Œå´©æºƒæ˜¯å¾ˆå¸¸è§çš„ã€‚ä¸ºäº†é¿å…ä¸¢å¤±ä»»ä½•ä¿¡æ¯ï¼ˆå°¤å…¶æ˜¯å´©æºƒçš„åŸå› ï¼‰ï¼Œè®°å½•å™¨å¿…é¡»åœ¨è¿›ç¨‹é€€å‡ºä¹‹å‰å†²æ´—ä»»ä½•ç¼“å†²æ¡ç›®ã€‚\nZap é€šè¿‡æä¾›åœ¨é€€å‡ºå‰è‡ªåŠ¨å†²æ´—çš„Panicå’ŒFatalè®°å½•æ–¹æ³•æ¥ä½¿è¿™ä¸€æ“ä½œå˜å¾—ç®€å•ã€‚å½“ç„¶ï¼Œè¿™å¹¶ä¸ä¿è¯æ—¥å¿—æ°¸è¿œä¸ä¼šä¸¢å¤±ï¼Œä½†å®ƒæ¶ˆé™¤äº†å¸¸è§çš„é”™è¯¯ã€‚\næœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… Uber-go/zap#207 ä¸­çš„è®¨è®ºã€‚\nä»€ä¹ˆæ˜¯DPanic? DPanicä»£è¡¨\u0026quot;panic in development.\u0026quot;ã€‚åœ¨developmentä¸­ï¼Œå®ƒä¼šæ‰“å°Panicçº§åˆ«çš„æ—¥å¿—ï¼šåä¹‹ï¼Œå®ƒå°†å‘ç”Ÿåœ¨Errorçº§åˆ«çš„æ—¥å¿—ï¼ŒDPanicæ›´åŠ å®¹æ˜“æ•è·å¯èƒ½ä½†å®é™…ä¸Šä¸åº”è¯¥å‘ç”Ÿçš„é”™è¯¯ï¼Œè€Œä¸æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­Panicã€‚\nå¦‚æœä½ æ›¾ç»å†™è¿‡è¿™æ ·çš„ä»£ç ï¼Œå°±å¯ä»¥ä½¿ç”¨DPanic:\n1 2 3 if err != nil { panic(fmt.Sprintf(\u0026#34;shouldn\u0026#39;t ever get here: %v\u0026#34;, err)) } å®‰è£…é—®é¢˜ é”™è¯¯expects import \u0026quot;go.uber.org/zap\u0026quot;æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ è¦ä¹ˆzapå®‰è£…é”™è¯¯ï¼Œè¦ä¹ˆæ‚¨å¼•ç”¨äº†ä»£ç ä¸­çš„é”™è¯¯åŒ…åã€‚\nZap çš„æºä»£ç æ‰˜ç®¡åœ¨ GitHub ä¸Šï¼Œä½† import pathæ˜¯ go.uber.org/zapï¼Œè®©æˆ‘ä»¬é¡¹ç›®ç»´æŠ¤è€…ï¼Œå¯ä»¥æ›´æ–¹ä¾¿åœ°è‡ªç”±ç§»åŠ¨æºä»£ç ã€‚æ‰€ä»¥åœ¨å®‰è£…å’Œä½¿ç”¨åŒ…æ—¶éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ã€‚\nå¦‚æœä½ éµå¾ªä¸¤ä¸ªç®€å•çš„è§„åˆ™ï¼Œå°±ä¼šæ­£å¸¸å·¥ä½œï¼šå®‰è£…zapgo get -u go.uber.org/zapå¹¶å§‹ç»ˆå¯¼å…¥å®ƒåœ¨ä½ çš„ä»£ç import \u0026quot;go.uber.org/zap\u0026quot;ï¼Œä»£ç ä¸åº”åŒ…å«ä»»ä½•å¯¹github.com/uber-go/zapçš„å¼•ç”¨.\nç”¨æ³•é—®é¢˜ Zapæ˜¯å¦æ”¯æŒæ—¥å¿—åˆ‡å‰²ï¼Ÿ Zap ä¸æ”¯æŒåˆ‡å‰²æ—¥å¿—æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬æ›´å–œæ¬¢å°†æ­¤äº¤ç»™å¤–éƒ¨ç¨‹åºï¼Œå¦‚logrotate.\nä½†æ˜¯ï¼Œæ—¥å¿—åˆ‡å‰²åŒ…å¾ˆå®¹æ˜“é›†æˆï¼Œå¦‚ gopkg.in/natefinch/lumberjack.v2 ä½œä¸ºzapcore.WriteSyncer.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // lumberjack.Logger is already safe for concurrent use, so we don\u0026#39;t need to // lock it. w := zapcore.AddSync(\u0026amp;lumberjack.Logger{ Filename: \u0026#34;/var/log/myapp/foo.log\u0026#34;, MaxSize: 500, // megabytes MaxBackups: 3, MaxAge: 28, // days }) core := zapcore.NewCore( zapcore.NewJSONEncoder(zap.NewProductionEncoderConfig()), w, zap.InfoLevel, ) logger := zap.New(core) æ’ä»¶ æˆ‘ä»¬å¾ˆå¸Œæœ›zap æœ¬èº«èƒ½æ»¡è¶³çš„æ¯ä¸€ä¸ªloggingéœ€æ±‚ï¼Œä½†æˆ‘ä»¬åªç†Ÿæ‚‰å°‘æ•°æ—¥å¿—æ‘„å…¥(log ingestion)ç³»ç»Ÿã€å‚æ•°è§£æ(flag-parsing)åŒ…ç­‰ã€‚æ‰€ä»¥æˆ‘ä»¬æ›´æ„¿æ„å‘å±• zap æ’ä»¶ç”Ÿæ€ç³»ç»Ÿã€‚\nä¸‹é¢æ‰©å±•åŒ…ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒä½¿ç”¨ï¼š\nåŒ… é›†æˆ github.com/tchap/zapext Sentry, syslog github.com/fgrosse/zaptest Ginkgo github.com/blendle/zapdriver Stackdriver github.com/moul/zapgorm Gorm æ€§èƒ½æ¯”è¾ƒ è¯´æ˜ : ä»¥ä¸‹èµ„æ–™æ¥æºäº zap å®˜æ–¹ï¼ŒZap æä¾›çš„åŸºå‡†æµ‹è¯•æ¸…æ¥šåœ°è¡¨æ˜ï¼Œzerologæ˜¯ä¸ Zap ç«äº‰æœ€æ¿€çƒˆçš„ã€‚zeroloè¿˜æä¾›ç»“æœéå¸¸ç›¸ä¼¼çš„åŸºå‡†æµ‹è¯•ï¼š\nè®°å½•ä¸€ä¸ª10ä¸ªkvå­—æ®µçš„æ¶ˆæ¯ï¼š\nåº“å æ¯æ¬¡è¿­ä»£è€—æ—¶ è€—æ—¶ç›¸æ¯”zap æ¯æ¬¡è¿­ä»£å†…å­˜åˆ†é…æ¬¡æ•° âš¡ zap 862 ns/op +0% 5 allocs/op âš¡ zap (sugared) 1250 ns/op +45% 11 allocs/op zerolog 4021 ns/op +366% 76 allocs/op go-kit 4542 ns/op +427% 105 allocs/op apex/log 26785 ns/op +3007% 115 allocs/op logrus 29501 ns/op +3322% 125 allocs/op log15 29906 ns/op +3369% 122 allocs/op ä½¿ç”¨ä¸€ä¸ªå·²ç»æœ‰10ä¸ªkvå­—æ®µçš„loggerè®°å½•ä¸€æ¡æ¶ˆæ¯ï¼š\nåº“å æ¯æ¬¡è¿­ä»£è€—æ—¶ è€—æ—¶ç›¸æ¯”zap æ¯æ¬¡è¿­ä»£å†…å­˜åˆ†é…æ¬¡æ•° âš¡ zap 126 ns/op +0% 0 allocs/op âš¡ zap (sugared) 187 ns/op +48% 2 allocs/op zerolog 88 ns/op -30% 0 allocs/op go-kit 5087 ns/op +3937% 103 allocs/op log15 18548 ns/op +14621% 73 allocs/op apex/log 26012 ns/op +20544% 104 allocs/op logrus 27236 ns/op +21516% 113 allocs/op è®°å½•ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰å­—æ®µæˆ–printfé£æ ¼çš„æ¨¡æ¿ï¼š\nåº“å æ¯æ¬¡è¿­ä»£è€—æ—¶ è€—æ—¶ç›¸æ¯”zap æ¯æ¬¡è¿­ä»£å†…å­˜åˆ†é…æ¬¡æ•° âš¡ zap 118 ns/op +0% 0 allocs/op âš¡ zap (sugared) 191 ns/op +62% 2 allocs/op zerolog 93 ns/op -21% 0 allocs/op go-kit 280 ns/op +137% 11 allocs/op standard library 499 ns/op +323% 2 allocs/op apex/log 1990 ns/op +1586% 10 allocs/op logrus 3129 ns/op +2552% 24 allocs/op log15 3887 ns/op +3194% 23 allocs/op ç›¸ä¼¼çš„åº“ logrus åŠŸèƒ½å¼ºå¤§\nzerolog æ€§èƒ½ç›¸å½“å¥½çš„æ—¥å¿—åº“\n","date":"2021-01-22T15:00:00Z","permalink":"https://blog.golang.space/p/%E4%BB%8E%E6%BA%90%E7%A0%81%E4%BA%86%E8%A7%A3-zap/","title":"ä»æºç äº†è§£ zap"},{"content":"MacOS 1 å¼€å¯\n1 flutter config --enable-macos-desktop 2 åˆ›å»º( æˆ–å·²æœ‰é¡¹ç›®æ·»åŠ  macOS )\n1 flutter create . # è¿™é‡Œçš„ . å·æ˜¯åœ¨å½“å‰æ–‡ä»¶å¤¹åˆ›å»º 3 è¿è¡Œ\n1 flutter run -d macOS 4 æ‰“åŒ…\n1 flutter build macos 5 åœ¨ vscode ä¸­åˆ›å»ºå¯åŠ¨é©±åŠ¨\n1 2 3 4 5 6 { \u0026#34;name\u0026#34;: \u0026#34;macOS\u0026#34;, \u0026#34;request\u0026#34;: \u0026#34;launch\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;dart\u0026#34;, \u0026#34;deviceId\u0026#34;: \u0026#34;macOS\u0026#34; }, å¼€å¯ç½‘ç»œæƒé™ iphone7\niOS 13 å 70%ï¼ŒiOS 12 å 23%ï¼ŒiOS 11 åŠä¹‹å‰ç‰ˆæœ¬å 7%ã€‚\n","date":"2020-12-10T00:00:00Z","permalink":"https://blog.golang.space/p/flutter-%E5%BC%80%E5%8F%91-mac-%E5%BA%94%E7%94%A8/","title":"Flutter å¼€å‘ Mac åº”ç”¨"},{"content":"Fontlab 7 ç®€è¦æ–‡æ¡£ è¯¥æ–‡æ¡£ä¸»è¦å¸®åŠ©æ‚¨å¿«é€Ÿäº†è§£è½¯ä»¶å¦‚ä½•æ“ä½œ\nå®˜æ–¹è‹±æ–‡æ‰‹å†Œ : https://help.fontlab.com/fontlab/7/manual/\n[toc]\næ‰“å¼€å­—ä½“ ä¿®æ”¹å­—ä½“ æ‚¨å¯ä»¥ä½¿ç”¨ contour - create countour controller è½®å»“ æè¾¹ æˆ–å…¶å®ƒä»»æ„æ–¹å¼å®ç°ç›¸åŒçš„åŠŸèƒ½, è¿™é‡Œä»…ä»…æä¾›ä¸€ç§ä½œä¸ºå‚è€ƒ\nå­—ä½“æ ‡è®°è¯´æ˜ é»‘çº¿ä¿®æ”¹æœªä¿å­˜ çº¢çº¿åç§°ä¸åˆæ ¼ å­—ä½“åŠ ç²—æ–¹æ³• èœå•æ é€‰æ‹© window - panels - brush, æ‰“å¼€ç”»ç¬”å·¥å…·çª—å£ ç¡®å®šå›¾å±‚é€‰æ‹©çš„æ˜¯å½“å‰æ–‡å­—, ç‚¹å‡» set, æ‹–åŠ¨ç¬”è§¦å¤§å°, å¯æ‹–åŠ¨ç®­å¤´æ›´æ”¹ç¬”è§¦æ–¹å‘, å®Œæˆ Expand æœ€é‡è¦çš„æ˜¯, ä½¿ç”¨ç”»ç¬”æè¾¹å¿…é¡»å¡«å……ç©ºç™½éƒ¨åˆ†! å¿«æ·é”® F ç‚¹å‡»æ–‡å­—å†…ç©ºç™½å¤„ , é¿å…å‡ºç°ç©ºå¿ƒå­— å°æŠ€å·§ : æŒ‰ç©ºæ ¼é”®å¯æŸ¥çœ‹å­—ä½“æ•ˆæœ å­—ä½“å‡ç»†æ–¹æ³• èœå•æ é€‰æ‹© window - panels - brush, æ‰“å¼€ç”»ç¬”å·¥å…·çª—å£ ç¡®å®šå›¾å±‚é€‰æ‹©çš„æ˜¯å½“å‰æ–‡å­—, ç‚¹å‡» set, æ‹–åŠ¨ç¬”è§¦å¤§å°, å¯æ‹–åŠ¨ç®­å¤´æ›´æ”¹ç¬”è§¦æ–¹å‘, å®Œæˆ Expand åŒå‡»å›¾å±‚ä¸­çš„å¤–æ¡†, å¿«æ·é”® delete åˆ é™¤ ä¿®æ”¹å­—ä½“ä¿¡æ¯ åœ¨å­—ä½“ä¸Šå³é”®é€‰æ‹©open glyph panel , ä¿®æ”¹ç¬¬ä¸€è¡Œ , å¿«æ·é”®enter ä¿å­˜ ä¿®æ”¹æŸä¸ªéƒ¨é¦– æ‰“å¼€å›¾å±‚, åŒå‡»æŸä¸ªéƒ¨é¦–, æ·»åŠ æ–°å›¾å±‚å³å¯ å…¶ä½™ä¿®æ”¹å‚ç…§ 2.1 2.2 è¿ç¬”ç¬”ç”»æ‹†åˆ† å¿«æ·é”® j é€‰æ‹©åˆ€å…·, åœ¨åˆé€‚ä½ç½®åˆ’ä¸€åˆ€, ç‚¹å‡»èŠ‚ç‚¹å‰²æ–­, å¿«æ·é”® a æŠŠå„è‡ªæ¥å£é‡æ–°è¿æ¥ ä¿å­˜ä¸º TTF èœå•æ  File - Export Font As... é€‰æ‹© OpenType TT, ä¿®æ”¹ä¿å­˜ä½ç½®ç­‰ä¿¡æ¯, Exportæ ¹æ®æ–‡ä»¶å¤§å°ç¨ç­‰æ—¶é•¿\n","date":"2020-10-22T00:00:00Z","image":"http://img.golang.space/1598929158698-image-20200901105918160.png","permalink":"https://blog.golang.space/p/fontlab-7-%E7%AE%80%E8%A6%81%E6%96%87%E6%A1%A3/","title":"Fontlab 7 ç®€è¦æ–‡æ¡£"},{"content":"Flutter æ’ä»¶ 1 flutter create -t plugin flutter_plugin_demo 1 åŸç”Ÿæ’ä»¶(è°ƒç”¨ java æˆ–å…¶å®ƒè¯­è¨€) é€šè¿‡ android studio åˆ›å»º, åŒ…å« java å’Œ ios é€‰æ‹© flutter plugin , çº¯ dart é€‰æ‹© flutter package ,\nåœ¨ pubspec.yaml ä¸­å£°æ˜å…¼å®¹å¹³å°\n1 2 3 4 5 6 7 8 9 10 11 12 plugin: platforms: android: package: com.example.flutter_plugin_test pluginClass: FlutterPluginTestPlugin ios: pluginClass: FlutterPluginTestPlugin macos: pluginClass: FlutterPluginTestPlugin web: pluginClass: FlutterPluginTestPlugin fileName: flutter_plugin_test.dart åœ¨ é¡¹ç›®å.dart ä¸­åˆ›å»ºæ–¹æ³•\nè°ƒç”¨è¯¥æ–¹æ³• è¿›å…¥å®‰å“åº•å±‚ç›®å½•, ä½¿ç”¨ java å®ç°æ•°æ® å‚è€ƒ\nhttps://book.flutterchina.club/chapter12/develop_plugin.html\n2 çº¯ dart åº“ å‚è€ƒ\nhttps://book.flutterchina.club/chapter12/develop_package.html\nåˆ›å»º flutter package ä¿®æ”¹ pubspec.yaml åŒ…ç›¸å…³ä¿¡æ¯, è¾“å…¥ flutter pub publish --dry-run æµ‹è¯•æ˜¯å¦åˆæ ¼ å‘å¸ƒè§ 3 æ­å»ºç§æœ‰ä»“åº“\n3 æ­å»ºç§æœ‰ä»“åº“ å®‰è£… dart 1 2 brew tap dart-lang/dart brew install dart æ­å»ºç¯å¢ƒ 1 2 3 4 git clone https://github.com/dart-lang/pub_server.git cd pub_server pub get dart example/example.dart -d /tmp/package-db å°†é¡¹ç›®å‘å¸ƒ 1 flutter packages pub publish --server=http://localhost:8080 è°·æ­ŒéªŒè¯ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åœ°å€, ç™»å½•è°·æ­Œè´¦æˆ·å³å¯\nå‚è€ƒ:\nå®˜æ–¹æä¾›å¿«é€Ÿæ­å»ºä»“åº“ https://github.com/dart-archive/pub_server\nå¦‚ä½•ä¸Šä¼ æ’ä»¶ https://ejin66.github.io/2019/04/11/flutter_private_pub.html\n","date":"2020-08-04T00:00:00Z","permalink":"https://blog.golang.space/p/flutter-%E5%BC%80%E5%8F%91%E6%8F%92%E4%BB%B6/","title":"Flutter å¼€å‘æ’ä»¶"},{"content":"å·¥ä½œæµ æœ‰ 4 ç§å¸¸ç”¨å·¥ä½œæµ\né›†ä¸­å¼ åŠŸèƒ½åˆ†æ”¯ Git Flow Forking é›†ä¸­å¼ æœ¬åœ°ä¿®æ”¹åç›´æ¥æäº¤åˆ°è¿œç¨‹ masterï¼Œæœ‰å†²çªè§£å†³å†²çªã€‚\nå›¢é˜Ÿä¸å»ºè®®ä½¿ç”¨ï¼Œä»£ç æ··ä¹±ï¼Œå®¹æ˜“å‡ºé—®é¢˜ã€‚\nåŠŸèƒ½åˆ†æ”¯ åŠŸèƒ½åˆ†æ”¯å·¥ä½œæµåŸºäºé›†ä¸­å¼å·¥ä½œæµæ¼”è¿›è€Œæ¥ã€‚é€‚åˆå¼€å‘å›¢é˜Ÿç›¸å¯¹å›ºå®šï¼Œè§„æ¨¡è¾ƒå°çš„é¡¹ç›®ã€‚\nå¼€å‘æ–°åŠŸèƒ½æ—¶ï¼ŒåŸºäº master åˆ†æ”¯åˆ›å»ºä¸€ä¸ªä¸´æ—¶åŠŸèƒ½åˆ†æ”¯ï¼Œåœ¨åˆ†æ”¯ä¸Šå¼€å‘ï¼Œå¼€å‘å®Œæˆååˆå¹¶åˆ° masterã€‚\nä»…åœ¨æœ€åä¸€æ­¥åˆå¹¶åˆ° master åˆ†æ”¯ï¼Œä½¿æäº¤å†å²æ›´ç®€æ´ ä¸åŒçš„åŠŸèƒ½åˆ†é…ç»™ä¸åŒçš„å¼€å‘äººå‘˜ï¼Œé¿å…å†²çª å…·ä½“æµç¨‹ åŸºäº master åˆ›å»ºåŠŸèƒ½åˆ†æ”¯\n1 git checkout -b feature/xxx åœ¨åˆ†æ”¯å¼€å‘ï¼Œæ¨é€åˆ°è¿œç¨‹\n1 2 3 git add xxx.go git commit -m \u0026#34;add xxx\u0026#34; git push origin feature/xxx åˆ›å»º PR\nä»£ç ç®¡ç†å‘˜å¯¹ä»£ç åš Code Reviewï¼Œå®¡æŸ¥å®Œæˆåˆå¹¶åˆ° master\nmerge æœ‰ä¸‰ç§æ–¹æ³•\nCreate a merge commitï¼Œgit merge --no-ffï¼Œæ‰€æœ‰ commit åˆå¹¶æˆä¸€ä¸ªï¼Œæ·»åŠ åˆ° masterã€‚è¯¥å‘½ä»¤æ˜¯æŒ‡å¼ºè¡Œå…³é—­ fast-forwardï¼Œä½†ä¼šä¿å­˜ç‰¹æ€§åˆ†æ”¯å†å²ï¼Œæ¨èè¿™ç§ã€‚ Squash and mergeï¼Œgit merge --squashï¼Œå°†ä¸å¿…è¦çš„åˆ†æ”¯ä¸Šå…¶ commit å‹ç¼©åˆå¹¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤æ·»åŠ åˆ° masterã€‚ Rebase and mergeï¼Œgit rebaseï¼Œå°†åˆ†æ”¯æ‰€æœ‰ commit ä¾æ¬¡æ·»åŠ åˆ° masterï¼Œå±äº fast_forwardæ–¹å¼åˆå¹¶ã€‚ Git Flow Git Flow å·¥ä½œæµæ˜¯ä¸€ä¸ªéå¸¸æˆç†Ÿçš„æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯éå¼€æºé¡¹ç›®ä¸­æœ€å¸¸ç”¨åˆ°çš„å·¥ä½œæµã€‚é€‚åˆå¤§å‹çš„é¡¹ç›®æˆ–è€…è¿­ä»£é€Ÿåº¦å¿«çš„é¡¹ç›®ã€‚\n5 ç§åˆ†æ”¯\nåˆ†æ”¯å æè¿° master å‘å¸ƒçŠ¶æ€ï¼Œç¦æ­¢å¼€å‘ï¼Œæ¯æ¬¡åˆå¹¶ hotfix/release è¦æ‰“ç‰ˆæœ¬æ ‡ç­¾ develop æœ€æ–°ä»£ç ï¼Œç¦æ­¢å¼€å‘ feature ç ”å‘åŠŸèƒ½åˆ†æ”¯ï¼ŒåŸºäº developï¼Œå¼€å‘å®Œæˆååˆå¹¶åˆ° develop å¹¶åˆ é™¤è¯¥åˆ†æ”¯ release é¢„å‘å¸ƒåˆ†æ”¯ï¼ŒåŸºäº developï¼Œé€šè¿‡æµ‹è¯•ååˆå¹¶åˆ° master å’Œ developï¼Œå¹¶åˆ é™¤è¯¥åˆ†æ”¯ hotfix ç»´æŠ¤é˜¶æ®µåˆ†æ”¯ï¼Œç´§æ€¥ bug ä¿®å¤ï¼ŒåŸºäº master åˆ†æ”¯åˆ›å»ºï¼Œå®Œæˆååˆå¹¶åˆ° master å’Œ develop å¹¶åˆ é™¤ Forking å¼€æºé¡¹ç›®ä¸­ï¼Œæœ€å¸¸ç”¨åˆ°çš„æ˜¯ Forking å·¥ä½œæµã€‚\nå‡è®¾å¼€å‘è€… A æ‹¥æœ‰ä¸€ä¸ªè¿œç¨‹ä»“åº“ï¼Œå¦‚æœå¼€å‘è€… B ä¹Ÿæƒ³å‚ä¸ A é¡¹ç›®çš„å¼€å‘ï¼ŒB å¯ä»¥ fork ä¸€ä»½ A çš„è¿œç¨‹ä»“åº“åˆ°è‡ªå·±çš„ GitHub è´¦å·ä¸‹ï¼Œåœ¨è‡ªå·±çš„ä»“åº“ä¸­ä¿®æ”¹ï¼Œå®Œæˆåå‘ A çš„ä»“åº“æäº¤ PRã€‚\nå…·ä½“æµç¨‹ fork ä»“åº“\nå…‹éš†ä»“åº“\n1 2 3 4 5 git clone https://github.com/xxx/kitx cd kitx git remote add upstream https://github.com/ixugo/kitx # ç¦æ­¢æ¨é€åˆ° upstream ï¼Œå®é™…ä¸Šä¸€èˆ¬ä¹Ÿæ²¡æœ‰æƒé™ï¼Œå› ä¸ºé‚£å¹¶ä¸æ˜¯ä½ çš„ä»“åº“ git remote set-url --push upstream no_pus åˆ›å»ºåŠŸèƒ½åˆ†æ”¯\n1 2 3 4 5 # è¦åŒæ­¥ master æœ€æ–°çŠ¶æ€ git fetch upstream git checkout master \u0026amp;\u0026amp; git rebase upstream/master # åˆ›å»ºåˆ†æ”¯ git checkout -b feature/files å®Œæˆå¼€å‘ï¼Œæäº¤\n1 2 3 4 5 6 7 # åœ¨ç‰¹æ€§åˆ†æ”¯ï¼ŒåŒæ­¥è¿œç¨‹ä»“åº“æœ€æ–°çŠ¶æ€ git fetch upstream \u0026amp;\u0026amp; git rebase upstream/master # æäº¤ä»£ç  git add file.go git commit -m \u0026#34;xxx åŠŸèƒ½\u0026#34; # æ¨é€åˆ°è‡ªå·±çš„è¿œç¨‹ä»“åº“ git push origin feature/files åœ¨ github è‡ªå·±çš„ä»“åº“é‚£ï¼Œåˆ›å»º Pull requestã€‚\nå‚è€ƒ Go è¯­è¨€é¡¹ç›®å¼€å‘å®æˆ˜\nA successful Git branching model\nGitã€GitHubã€GitLab Flowï¼Œå‚»å‚»åˆ†ä¸æ¸…ï¼Ÿä¸€å›¾çœ‹æ‡‚å„ç§åˆ†æ”¯ç®¡ç†æ¨¡å‹\nGit flow å¼€å‘æŒ‡å—\ngitflow æ˜¯ä»€ä¹ˆï¼Œæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ\nGithub å®˜æ–¹æ–‡æ¡£ pull requests æµç¨‹\n","date":"2020-07-22T15:00:00Z","permalink":"https://blog.golang.space/p/git-%E5%B7%A5%E4%BD%9C%E6%B5%81/","title":"Git å·¥ä½œæµ"},{"content":"1. åˆ›å»ºé¡¹ç›® https://umijs.org/zh-CN/docs/getting-started\n1 2 3 4 5 6 7 8 9 10 11 # åˆ›å»ºç›®å½• mkdir myapp \u0026amp;\u0026amp; cd myapp # åˆ›å»º umijs@3.x æ¡†æ¶ yarn create @umijs/umi-app # å®‰è£…ä¾èµ– yarn # å¯åŠ¨é¡¹ç›® yarn start # åˆ›å»ºæœ¬åœ°é…ç½® echo \u0026#34;import { defineConfig } from \u0026#39;umi\u0026#39;;\u0026#34; \u0026gt; .umirc.local.ts 2. ä½¿ç”¨ recoil çŠ¶æ€ç®¡ç†åº“ https://recoiljs.org/docs/introduction/getting-started\n1 yarn add recoil ä½¿ç”¨ RecoilRoot åŒ…è£¹\n1 2 3 4 5 6 7 8 9 10 11 import React from \u0026#39;react\u0026#39;; import { RecoilRoot } from \u0026#39;recoil\u0026#39;; import styles from \u0026#39;./index.less\u0026#39;; export default function IndexPage() { return ( \u0026lt;RecoilRoot\u0026gt; \u0026lt;h1 className={styles.title}\u0026gt;Page index\u0026lt;/h1\u0026gt; \u0026lt;/RecoilRoot\u0026gt; ); } 3. å®‰è£… UI æ¡†æ¶ 1 2 3 yarn add semantic-ui-react semantic-ui-css # åœ¨æ–‡ä»¶ä¸­å¯¼å…¥ css import \u0026#39;semantic-ui-css/semantic.min.css\u0026#39; 4. ä¸‹æ‹‰åˆ·æ–°, ä¸Šå•¦åŠ è½½ https://github.com/ankeetmaini/react-infinite-scroll-component\nhttps://codesandbox.io/s/yk7637p62z?file=/src/index.js:309-322\n1 2 yarn add react-infinite-scroll-component import InfiniteScroll from \u0026#39;react-infinite-scroll-component\u0026#39;; å…¶å®ƒ( æœªä½¿ç”¨è¿‡, ä»…åœ¨æ­¤æ’ä»¶æ— æ³•ä½¿ç”¨æ—¶,æä¾›æ›´å¤šé€‰æ‹© )\nhttps://github.com/makotot/react-scrollspy\nhttps://github.com/caseywebdev/react-list\nhttps://github.com/danbovey/react-infinite-scroller\n5. ä¸Šä¼ å›¾ç‰‡å‹ç¼© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 \u0026lt;Form.Input id=\u0026#34;title\u0026#34; type=\u0026#34;file\u0026#34; multiple error={imageError} accept=\u0026#34;image/*\u0026#34; onChange={(e, data) =\u0026gt; { if (!e.target.files) { return; } if (e.target.files.length \u0026gt; 9) { setImageError(\u0026#39;å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 9 å¼ \u0026#39;); return; } setImageError(undefined); for (let index = 0; index \u0026lt; e.target.files.length; index++) { const reader = new FileReader(); // å›¾ç‰‡åŠ è½½å¥½æ‰§è¡Œ reader.onload = function (ev) { // var imgFile = ev \u0026amp;\u0026amp; ev.target \u0026amp;\u0026amp; ev.target.result; //æˆ–e.targetéƒ½æ˜¯ä¸€æ ·çš„ function setVal(params: any) { if (e \u0026amp;\u0026amp; e.target \u0026amp;\u0026amp; e.target.files) { setImageFiles([ ...imageFiles, { name: e.target.files[index].name, img: String(params), }, ]); } } // å‹ç¼©å›¾ç‰‡å¹¶å°†å›¾ç‰‡å¡å…¥æ•°ç»„ dealImage(String(imgFile), (v: any) =\u0026gt; { setVal(v); }); }; // è¯»å–å›¾ç‰‡ reader.readAsDataURL(e.target.files[index]); } console.log(imageFiles); }} placeholder=\u0026#34;è¯·è¾“å…¥ç´è°±åœ°å€\u0026#34; // onChange={handleChange} /\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // é€šè¿‡canvaså‹ç¼©base64å›¾ç‰‡ function dealImage(base64: any, callback: any, w: number = 1000) { const newImage = new Image(); const quality = 0.9; // å‹ç¼©ç³»æ•°0-1ä¹‹é—´ newImage.src = base64; // newImage.setAttribute(\u0026#39;crossOrigin\u0026#39;, \u0026#39;Anonymous\u0026#39;); // urlä¸ºå¤–åŸŸæ—¶éœ€è¦ let imgWidth; let imgHeight; newImage.onload = function () { // @ts-ignore imgWidth = this.width; // @ts-ignore imgHeight = this.height; const canvas = document.createElement(\u0026#39;canvas\u0026#39;); const ctx = canvas.getContext(\u0026#39;2d\u0026#39;) as any; if (Math.max(imgWidth, imgHeight) \u0026gt; w) { if (imgWidth \u0026gt; imgHeight) { canvas.width = w; canvas.height = (w * imgHeight) / imgWidth; } else { canvas.height = w; canvas.width = (w * imgWidth) / imgHeight; } } else { canvas.width = imgWidth; canvas.height = imgHeight; } ctx.clearRect(0, 0, canvas.width, canvas.height); // @ts-ignore ctx.drawImage(this, 0, 0, canvas.width, canvas.height); const newBase64 = canvas.toDataURL(\u0026#39;image/jpeg\u0026#39;, quality); callback(newBase64); }; } 6. toast 1 yarn add react-hot-toast 7 . éƒ¨ç½² å¦‚æœæ˜¯åœ¨éæ ¹ç›®å½•ä¸‹ï¼Œå¢åŠ  base å±æ€§ç”¨äºè¯†åˆ«è·¯ç”±ï¼Œå¢åŠ  publicPath å±æ€§ç”¨äºè¯†åˆ«é™æ€æ–‡ä»¶åœ°å€ã€‚\n","date":"2020-07-15T15:00:00Z","permalink":"https://blog.golang.space/p/%E4%BD%BF%E7%94%A8-umi.js-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE/","title":"ä½¿ç”¨ umi.js åˆ›å»ºé¡¹ç›®"},{"content":"Go å‡½æ•°å¼ç¼–ç¨‹ æ ¸å¿ƒæ¦‚å¿µ\nçº¯å‡½æ•° å‡½æ•°å¤åˆ é¿å…å…±äº«çŠ¶æ€ é¿å…æ”¹å˜çŠ¶æ€ é¿å…å‰¯ä½œç”¨ è¯´æ˜ çº¯å‡½æ•°\nç›¸åŒçš„è¾“å…¥æ€»æ˜¯è¿”å›ç›¸åŒçš„è¾“å‡º ä¸äº§ç”Ÿå‰¯ä½œç”¨ ä¸ä¾èµ–äºå¤–éƒ¨çŠ¶æ€ 1 2 3 4 5 6 7 8 9 // éå‡½æ•°å¼ num1,num2 := 2,3 sum := num1 + num2 // å‡½æ•°å¼ func add (n1, n2 int) int { return n1 + n2 } sum1 := add(2, 3) å…±äº«çŠ¶æ€\nä»»æ„å˜é‡/å¯¹è±¡æˆ–è€…å†…å­˜ç©ºé—´å­˜åœ¨äºå…±äº«ä½œç”¨åŸŸï¼Œå‡½æ•°å¼ç¼–ç¨‹é¿å…å…±äº«çŠ¶æ€\né¿å…æ”¹å˜çŠ¶æ€\nå‡½æ•°å¼ç¼–ç¨‹åªè¿”å›æ–°çš„å€¼ï¼Œä¸ä¿®æ”¹å˜é‡\nå‰¯ä½œç”¨\nåŒ…æ‹¬\næ”¹å˜ä»»ä½•å¤–éƒ¨å˜é‡æˆ–å¯¹è±¡å±æ€§ å†™å…¥æ–‡ä»¶ å‘ç½‘ç»œè¯·æ±‚ åœ¨å±å¹•è°ƒç”¨è¾“å‡º è°ƒç”¨å¦ä¸€ä¸ªæœ‰å‰¯ä½œç”¨å¾—å¾ˆå±€æ•° å£°æ˜å¼ä¸å‘½ä»¤å¼\nå‘½ä»¤å¼: å¤§é‡ä»£ç æè¿°æ¥è¾¾æˆæœŸæœ›ç»“æœï¼Œ How to do å£°æ˜å¼: æŠ½è±¡æ§åˆ¶æµè¿‡ç¨‹ï¼Œå¤§é‡ä»£ç æè¿°æ•°æ®æµï¼ŒWhat to do 1 2 3 4 5 6 // å‘½ä»¤å¼ list := []int{1,2,3,4,5} list2 := make([]int,len(list)) for i,v := range list{ list2[i] = v*2 } 1 // å£°æ˜å¼ æŸ¯é‡ŒåŒ–\næŸ¯é‡ŒåŒ–æ˜¯å°†ä¸€ä¸ªå¤šå‚æ•°å‡½æ•°è½¬æ¢æˆå¤šä¸ªå•å‚æ•°å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // æŸ¯é‡ŒåŒ–ä¹‹å‰ func add(x, y int) int { return x + y } add(1, 2) // 3 // æŸ¯é‡ŒåŒ–ä¹‹å func addX(y) func (x) int { return function (x) int { return x + y } } addX(2)(1) // 3 ","date":"2020-05-22T15:00:00Z","permalink":"https://blog.golang.space/p/go-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/","title":"Go å‡½æ•°å¼ç¼–ç¨‹"},{"content":"API design * è¡¨ç¤ºå¿…é¡»éµå®ˆï¼Œæ²¡æœ‰åˆ™ä¸ºå»ºè®® è¯·æ±‚ æä¾›ç”¨äºè‡ªæ£€çš„è¯·æ±‚ ID åœ¨æ¯ä¸ª API å“åº”ä¸­åŒ…å«ä¸€ä¸ª Request_ID æ ‡å¤´ï¼Œå¹¶é‡‡ç”¨ UUID å€¼å¡«å……ã€‚é€šè¿‡åœ¨å®¢æˆ·æœºã€æœåŠ¡å™¨å’Œä»»ä½•åå°æœåŠ¡ä¸Šè®°å½•è¿™äº›å€¼ï¼Œå®ƒæä¾›äº†ä¸€ç§è·Ÿè¸ªã€è¯Šæ–­å’Œè°ƒè¯•è¯·æ±‚çš„æœºåˆ¶ã€‚\n*åœ¨è¯·æ±‚ä½“ä¸­æ¥æ”¶åºåˆ—åŒ–çš„ JSON åœ¨ PUT/PATCH/POST è¯·æ±‚ä½“æ¥æ”¶åºåˆ—åŒ–çš„ JSONï¼Œè€Œä¸æ˜¯è¡¨å•ç¼–ç \nä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 curl -X POST https://service.com/apps \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{\u0026#34;name\u0026#34;: \u0026#34;demoapp\u0026#34;}\u0026#39; { \u0026#34;id\u0026#34;: \u0026#34;01234567-89ab-cdef-0123-456789abcdef\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;demoapp\u0026#34;, \u0026#34;owner\u0026#34;: { \u0026#34;email\u0026#34;: \u0026#34;username@example.com\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;01234567-89ab-cdef-0123-456789abcdef\u0026#34; }, ... } *REST API èµ„æºå\nèµ„æºåä½¿ç”¨å¤æ•°ç‰ˆæœ¬ï¼Œé™¤éæ‰€æ¶‰åŠçš„èµ„æºæ˜¯ç³»ç»Ÿä¸­çš„å•ä¾‹\n1 2 /user\t# Bad /users # Good Request Method\nèµ„æº POST GET PUT DELETE /users åˆ›å»ºæ–°å®¢æˆ· æ£€ç´¢æ‰€æœ‰å®¢æˆ· æ‰¹é‡æ›´æ–°å®¢æˆ· åˆ é™¤æ‰€æœ‰å®¢æˆ· /users/:id - æ£€ç´¢æŒ‡å®šå®¢æˆ· æ›´æ–°æŒ‡å®šå®¢æˆ· åˆ é™¤æŒ‡å®šå®¢æˆ· POST åˆ›å»ºèµ„æºï¼Œä¸åº”å…·æœ‰ä¸ç›¸å…³çš„å‰¯ä½œç”¨ PUT æ›´æ–°èµ„æºï¼Œè¯¥è¯·æ±‚å¿…é¡»æ˜¯å¹‚ç­‰çš„ã€‚ GET è·å–èµ„æº DELETE åˆ é™¤èµ„æº é¿å…å®ç°çç¢çš„ POST / PUT / DELETE æ“ä½œã€‚\nåœ¨å®é™… API å¼€å‘ä¸­ï¼Œæœ‰äº›æ“ä½œå¯èƒ½ä¸èƒ½å¾ˆå¥½çš„æ˜ å°„ä¸º REST èµ„æºï¼Œå¦‚ç¦è¨€æŸç”¨æˆ·ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹åšæ³•:\nå°†æ“ä½œå˜ä¸ºèµ„æºçš„å±æ€§ï¼Œ /users/id?active=falseï¼Œç¼ºç‚¹æ˜¯ä¸€ä¸ªæ¥å£è¦å¤„ç†å¤šç§å‚æ•°ç»„åˆï¼Œå°½å¯èƒ½å°†å±æ€§ç›¸å…³çš„æ”¾åœ¨ä¸€èµ·ï¼Œä¸ç„¶å»ºè®®æ–°å¢ä¸€ä¸ªæ¥å£ã€‚ ä¸‹çº§èµ„æº /users/id/activeï¼Œé€šè¿‡ä¸åŒçš„è¯·æ±‚æ–¹å¼å†³å®šå¢åˆ ï¼Œä¼˜ç‚¹æ˜¯æ¥å£ä½œç”¨æ˜æ™°ï¼Œç¼ºç‚¹æ˜¯æ¥å£æ•°é‡ä¼šå¾ˆå¤§ï¼Œæˆ‘è®¤ä¸ºï¼Œæ¥å£æ˜æ™°æ›´é‡è¦ã€‚ ä»¥ä¸Šä¸èƒ½è§£å†³ï¼Œæœ‰æ—¶å¯ä»¥æ‰“ç ´è§„èŒƒï¼Œå¦‚ç™»å½•å°±/login åˆ†é¡µ / è¿‡æ»¤ / æ’åº / æœç´¢ å¦‚ /users åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ï¼Œéœ€è¦æä¾›åˆ†é¡µåŠŸèƒ½ã€‚\næ»šåŠ¨ç¿»é¡µï¼Œå¯ä»¥ä½¿ç”¨ /users?limit=10\u0026amp;since=10000 ï¼Œsince æ˜¯å‰ä¸€é¡µæœ€åä¸€æ¡æ•°æ®çš„ ID æˆ–åºå·ã€‚\nè·³è½¬åˆ†é¡µï¼Œå¯ä»¥ä½¿ç”¨ /users?limit=10\u0026amp;page=1ï¼Œpage è¡¨ç¤ºç¬¬å‡ é¡µ\nè¿‡æ»¤å±æ€§ï¼Œå¦‚æœç”¨æˆ·ä¸éœ€è¦èµ„æºçš„å…¨éƒ¨å±æ€§ï¼Œå¯ä»¥åœ¨ uri å‚æ•°ä¸­æŒ‡å®šéœ€è¦å“ªäº›ï¼Œ/users?fields=email,username,address\næ’åºï¼Œ/users?sort=age descï¼Œ/users?sort=id,age desc ï¼Œæ³¨æ„ id ï¼Œage descåº”è¯¥ä¸ä¾‹å­ä¸­ç­‰ä»·ï¼Œå¤šä½™çš„ç©ºæ ¼å¯ä»¥å¿½ç•¥\næœç´¢ï¼Œ/users?key=zhangsan\nå…³äºåˆ†é¡µçš„è¡¥å……\né»˜è®¤ limit = 20 ï¼Œ limit \u0026lt; 100ï¼Œè¦æŒ‡å®šä¸Šé™é˜²æ­¢æ‹’ç»æœåŠ¡æ”»å‡»\n1 2 3 4 type Response struct{ Data any // åˆ†é¡µæ•°æ® Next string // ä¸‹ä¸€é¡µçš„ sinceï¼Œåœ¨è¯·æ±‚ä¸‹ä¸€é¡µæ—¶åº”è¯¥å¸¦ä¸Šè¿™ä¸ªå‚æ•° } é‡å¤è¯·æ±‚ æœåŠ¡ç«¯èƒ½å¤Ÿé€šè¿‡æ­¤IDæ¥æ£€æµ‹è¯·æ±‚æ˜¯å¦é‡å¤ï¼Œä¿è¯è¯·æ±‚åªè¢«å¤„ç†ä¸€æ¬¡ã€‚\n1 2 3 // ç”¨äºæ£€æµ‹å†—ä½™è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†ç¬¦ // è¿™ä¸ªå­—æ®µåº”è¯¥å‘½åä¸º `request_id` string request_id = ...; å¼‚æ­¥æ“ä½œ\næœ‰æ—¶ï¼ŒPOSTã€PUTã€PATCH æˆ– DELETE æ“ä½œå¯èƒ½éœ€è¦å¤„ç†æ“ä½œéœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½å®Œæˆã€‚ å¦‚æœéœ€è¦ç­‰å¾…è¯¥æ“ä½œå®Œæˆåæ‰èƒ½å‘å®¢æˆ·ç«¯å‘é€å“åº”ï¼Œå¯èƒ½ä¼šé€ æˆä¸å¯æ¥å—çš„å»¶è¿Ÿã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·è€ƒè™‘å°†è¯¥æ“ä½œè®¾ç½®ä¸ºå¼‚æ­¥æ“ä½œã€‚\nåº”å…¬å¼€ä¸€ä¸ªå¯è¿”å›å¼‚æ­¥è¯·æ±‚çŠ¶æ€çš„ç»ˆç»“ç‚¹ï¼Œä½¿å®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡è½®è¯¢çŠ¶æ€ç»ˆç»“ç‚¹æ¥ç›‘è§†çŠ¶æ€ã€‚\nå¼‚æ­¥è¯·æ±‚\n1 2 3 4 5 6 7 GET /service/restart çŠ¶æ€ç  : 201 { \u0026#34;url\u0026#34; : \u0026#34;/service/status\u0026#34; } é€šè¿‡è®¿é—® URL å¯ä»¥çŸ¥é“å½“å‰å¼‚æ­¥æ‰§è¡Œçš„çŠ¶æ€\nAction æ˜ç¡®ä»¥è¡ŒåŠ¨å‰ç¼€è¯¦ç»†è¯´æ˜\n1 /resources/:resource/actions/:action ä¾‹å¦‚åœæ­¢æŸä¸€ç‰¹å®šçš„è¿è¡Œ:\n1 /runs/{run_id}/actions/stop å¯¹é›†åˆçš„æ“ä½œä¹Ÿåº”è¯¥æœ€å°åŒ–ã€‚å¦‚æœéœ€è¦ï¼Œåº”è¯¥ä½¿ç”¨ä¸€ä¸ªé¡¶çº§çš„åŠ¨ä½œå»¶é•¿æ¥é¿å…åç§°ç©ºé—´å†²çªï¼Œå¹¶æ¸…æ¥šåœ°æ˜¾ç¤ºåŠ¨ä½œçš„èŒƒå›´:\n1 /actions/:action/resources ä¾‹å¦‚é‡å¯æ‰€æœ‰æœåŠ¡å™¨\n1 /actions/restart/servers *ä¸€è‡´çš„è·¯å¾„æ ¼å¼ ä½¿ç”¨å°å†™å’Œç ´æŠ˜å·åˆ†éš”çš„è·¯å¾„å\n1 2 service-api.com/users service-api.com/app-setups æœ€å°åŒ–è·¯å¾„åµŒå¥—ï¼Œä¼˜å…ˆåœ¨èµ„æºçš„çˆ¶è·¯å¾„ä¸Šå®šä½èµ„æºæ¥é™åˆ¶åµŒå¥—æ·±åº¦\né¿å…è¶…è¿‡ 2 å±‚çš„èµ„æºåµŒå¥—ï¼Œå»ºè®®å°†å…¶å®ƒèµ„æº è½¬æ¢ä¸º?å‚æ•°ï¼Œ\n1 2 # Bad /orgs/{org_id}/apps/{app_id}/dynos/{dyno_id} 1 2 3 4 5 6 # Good /orgs/{org_id} /orgs/{org_id}/apps /apps/{app_id} /apps/{app_id}/dynos /dynos/{dyno_id} å“åº” *è¿”å›é€‚å½“çš„çŠ¶æ€ä»£ç  200 OK è¯·æ±‚æˆåŠŸ 400 Bad Request è¯·æ±‚å‚æ•°æœ‰è¯¯ 401 Unauthorized ç”¨æˆ·èº«ä»½æœªéªŒè¯ 403 Forbidden ç”¨æˆ·æ²¡æœ‰è®¿é—®è¯¥èµ„æºæƒé™ 500 Internal Server Error æœåŠ¡å™¨å¼‚å¸¸ å“åº”æä¾›å…¨éƒ¨èµ„æº åœ¨å“åº”ä¸­å°½å¯èƒ½æä¾›å®Œæ•´çš„èµ„æºè¡¨ç¤º(å³åŒ…å«æ‰€æœ‰å±æ€§çš„å¯¹è±¡)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 $ curl -X DELETE \\ https://service.com/apps/1f9b/domains/0fd4 HTTP/1.1 200 OK Content-Type: application/json;charset=utf-8 ... { \u0026#34;created_at\u0026#34;: \u0026#34;2012-01-01T12:00:00Z\u0026#34;, \u0026#34;hostname\u0026#34;: \u0026#34;subdomain.example.com\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;01234567-89ab-cdef-0123-456789abcdef\u0026#34;, \u0026#34;updated_at\u0026#34;: \u0026#34;2012-01-01T12:00:00Z\u0026#34; } æä¾›èµ„æº UUID é»˜è®¤æƒ…å†µä¸‹ä¸ºæ¯ä¸ªèµ„æºæä¾›ä¸€ä¸ª id å±æ€§ã€‚é™¤éæœ‰å……åˆ†çš„ç†ç”±ï¼Œå¦åˆ™è¯·ä½¿ç”¨ uuidã€‚\n1 \u0026#34;id\u0026#34;: \u0026#34;01234567-89ab-cdef-0123-456789abcdef\u0026#34; æä¾›æ ‡å‡†æ—¶é—´æˆ³ åªæ¥å—å’Œè¿”å› UTC ( ä¸–ç•Œæ ‡å‡†æ—¶é—´ )æ—¶é—´ã€‚ä»¥ ISO8601æ ¼å¼å‘ˆç°æ—¶é—´ã€‚\n1 2 3 4 5 6 { // ... \u0026#34;created_at\u0026#34;: \u0026#34;2012-01-01T12:00:00Z\u0026#34;, \u0026#34;updated_at\u0026#34;: \u0026#34;2012-01-01T13:00:00Z\u0026#34;, // ... } *æä¾›æ ‡å‡†çš„å“åº”ç±»å‹ å½“ä¸º null æ—¶ï¼Œå¯ä»¥å¿½ç•¥è¯¥å‚æ•°\nå­—ç¬¦ä¸² string || null å¸ƒå°” false || true æ•°å­— number || null ï¼Œæ³¨æ„:ä¸€äº› JSON è§£æå™¨å°†è¿”å›ç²¾åº¦è¶…è¿‡15ä½çš„æ•°å­—ä½œä¸ºå­—ç¬¦ä¸²ã€‚ æ•°ç»„ [] ï¼Œ æ²¡æœ‰å€¼æ—¶è¿”å›ç©ºæ•°ç»„ å¯¹è±¡ object || null *ä½¿ç”¨åµŒå¥—å¯¹è±¡åºåˆ—åŒ– 1 2 3 4 5 6 # Bad { \u0026#34;name\u0026#34;: \u0026#34;service-production\u0026#34;, \u0026#34;owner_id\u0026#34;: \u0026#34;5d8201b0...\u0026#34;, // ... } 1 2 3 4 5 6 7 8 # Good { \u0026#34;name\u0026#34;: \u0026#34;service-production\u0026#34;, \u0026#34;owner\u0026#34;: { \u0026#34;id\u0026#34;: \u0026#34;5d8201b0...\u0026#34; }, // ... } è¿™ç§æ–¹æ³•å¯ä»¥åœ¨ä¸æ”¹å˜å“åº”ç»“æ„æˆ–å¼•å…¥æ›´å¤šé¡¶çº§å“åº”å­—æ®µçš„æƒ…å†µä¸‹å†…è”æ›´å¤šå…³äºç›¸å…³èµ„æºçš„ä¿¡æ¯ï¼Œä¾‹å¦‚:\n1 2 3 4 5 6 7 8 { \u0026#34;name\u0026#34;: \u0026#34;service-production\u0026#34;, \u0026#34;owner\u0026#34;: { \u0026#34;id\u0026#34;: \u0026#34;5d8201b0...\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;alice@heroku.com\u0026#34; }, // ... } æ³¨æ„è¦ä¸ºå­é›†æä¾›å”¯ä¸€å€¼ï¼Œé¿å…ä¸ä¸€è‡´å’Œæ··æ·†ï¼Œå¦‚ id å­—æ®µ\n*ç”Ÿæˆç»“æ„åŒ–é”™è¯¯ å¯¹é”™è¯¯ç”Ÿæˆä¸€è‡´çš„ï¼Œç»“æ„åŒ–çš„å“åº”ã€‚\nåŒ…æ‹¬ä¸€ä¸ªæœºå™¨å¯è¯»çš„é”™è¯¯ IDï¼Œå¯ä»¥é€šè¿‡è¯¥ ID åˆ¤æ–­å‡ºå“ªç±»é”™è¯¯ï¼Œå­—æ®µç”¨ code è¡¨ç¤ºã€‚ åŒ…æ‹¬ä¸€ä¸ªç”¨æˆ·å¯è¯»çš„é”™è¯¯æ¶ˆæ¯ï¼Œä»¥åŠé”™è¯¯è¯¦æƒ…ï¼Œå¦‚æœ‰éœ€è¦å¯ä»¥å¢åŠ URL ï¼Œå‘å®¢æˆ·ç«¯æç¤ºå¦‚ä½•è§£å†³é”™è¯¯çš„åœ°å€ã€‚ http çš„çŠ¶æ€ç ä¸è¦ä½¿ç”¨å¤ªå¤šï¼Œå»ºè®®éœ€è¦ä»¥ä¸‹3ä¸ª\n200 - è¯·æ±‚æˆåŠŸ 400 - å‘ç”Ÿé”™è¯¯ 401 - æœªç™»å½•æˆ–èº«ä»½ä»¤ç‰Œè¿‡æœŸ å¯¼è‡´çš„èº«ä»½éªŒè¯å¤±è´¥ ç»è¿‡æ›´å¤šçš„å®éªŒä¸å­¦ä¹ ï¼Œè®¤ä¸º è‹±æ–‡é”™è¯¯ç  æ¯” æ•°å­—é”™è¯¯ç  æ›´é€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼Œä»¥ä¸‹æ–¹æ¡ˆä»…ä¾›äº†è§£\nCode è®¾è®¡è§„èŒƒï¼Œçº¯æ•°å­—è¡¨ç¤ºï¼Œå¦‚10101ï¼Œ1 å¼€å¤´çš„é€šç”¨æ¨¡å—é€‚åˆæ‰€æœ‰é¡¹ç›®ï¼Œå…¶å®ƒæ•°å­—å¼€å¤´çš„ä¸šåŠ¡é”™è¯¯é’ˆå¯¹ä¸šåŠ¡è®¾è®¡ã€‚\n1ï¼Œé€šç”¨ 01ï¼Œèµ„æºæ¨¡å— 01ï¼Œé”™è¯¯ç åºå·ï¼Œæ¯”å¦‚è¯¥åºå·è¡¨ç¤ºè¯·æ±‚é¢‘ç¹ æœåŠ¡ æ¨¡å— è¯´æ˜ 1 01 é€šç”¨ - åŸºæœ¬é”™è¯¯ 1 02 é€šç”¨ - æ•°æ®åº“ç±»é”™è¯¯ 1 03 é€šç”¨ - è®¤è¯æˆæƒç±»é”™è¯¯ 1 04 é€šç”¨ - ç¼–è§£ç ç±»é”™è¯¯ 2 01 ç”¨æˆ·æœåŠ¡ - å†å²ç™»å½•æ¨¡å— HTTP çŠ¶æ€ç  é”™è¯¯ç  è¯´æ˜ 200 0 å®é™…ä¸Šä¹Ÿæ— éœ€è¿”å› codeï¼Œæ­£å¸¸è¿”å›ä¸šåŠ¡æ•°æ®å³å¯ 400 10101 æœªçŸ¥é”™è¯¯ 400 10102 è¯·æ±‚å‚æ•°æœ‰è¯¯ 400 10201 SQL è¯­æ³•é”™è¯¯ 401 10301 token éªŒè¯å¤±è´¥ 400 10302 æ“ä½œäº†ä¸å±äºè‡ªå·±çš„èµ„æº 400 10401 json ç¼–è§£ç å‡ºé”™ 400 20101 è®°å½•ç”¨æˆ·ç™»å½•å‡ºé”™ é”™è¯¯ä¿¡æ¯è§„èŒƒ å¯¹å¤–æš´éœ²çš„é”™è¯¯è¦ç®€ä»‹ï¼Œèƒ½å‡†ç¡®è¯´æ˜é—®é¢˜ é”™è¯¯è¯´æ˜ï¼Œåº”è¯¥æ˜¯è¯¥æ€ä¹ˆåšï¼Œè€Œä¸æ˜¯å“ªé‡Œé”™äº†ã€‚ é”™è¯¯ä¸­ä¸èƒ½å‡ºç°æ•æ„Ÿçš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ•°æ®åº“çš„é”™è¯¯æç¤ºï¼Œç”¨æˆ·æŸæŸèµ„æºæç¤º 1 2 3 4 5 6 7 HTTP/1.1 400 Bad Requests { \u0026#34;code\u0026#34;: 10101, \u0026#34;msg\u0026#34;: \u0026#34;Account reached its API rate limit.\u0026#34;, \u0026#34;details\u0026#34;: [] } é€Ÿç‡é™åˆ¶ é€Ÿç‡é™åˆ¶æ¥è‡ªå®¢æˆ·çš„è¯·æ±‚ï¼Œä»¥ä¿æŠ¤æœåŠ¡çš„å¥åº·å’Œç»´æŠ¤å…¶ä»–å®¢æˆ·çš„é«˜æœåŠ¡è´¨é‡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•æ¥é‡åŒ–è¯·æ±‚é™åˆ¶ã€‚å¯ä»¥åœ¨ RateLimit-Remaining response header ä¸­è¿”å›æ¯ä¸ªè¯·æ±‚çš„è¯·æ±‚æ ‡è®°çš„å‰©ä½™æ•°é‡ã€‚\nåœ¨æ‰€æœ‰å›å¤ä¸­ä¿æŒ JSON çš„ç®€åŒ– é¢å¤–çš„ç©ºç™½ä¸ºè¯·æ±‚å¢åŠ äº†ä¸å¿…è¦çš„å“åº”å¤§å°ï¼Œæœ€å¥½å°½é‡å‡å°‘ JSON å“åº”ã€‚\n1 2 3 4 5 # Bad { \u0026#34;beta\u0026#34;: false, \u0026#34;email\u0026#34;: \u0026#34;alice@heroku.com\u0026#34; } 1 2 # Good {\u0026#34;beta\u0026#34;:false,\u0026#34;email\u0026#34;:\u0026#34;alice@heroku.com\u0026#34;} å¯¹äºé¡¹ç›®è¦æ±‚ æä¾›å›¢é˜Ÿå¯è¯»çš„æ–‡æ¡£\næä¾›å¯æ‰§è¡Œçš„ç¤ºä¾‹\nå‚è€ƒ Google API è®¾è®¡æŒ‡å—\näº†è§£æ›´å¤š RESTful API è®¾è®¡ Heroku RESTful API Design\nMicrosoft RESTful API è®¾è®¡\nGithub RESTful API è®¾è®¡\n","date":"2020-05-21T00:00:00Z","permalink":"https://blog.golang.space/p/restful-api-%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%97/","title":"RESTful API è®¾è®¡æŒ‡å—"},{"content":"Redis å‚è€ƒæ–‡æ¡£ :ã€€http://redisdoc.com/\n[toc]\nä¸€ linux çš„ç¯å¢ƒè½¯ä»¶å®‰è£… 1 2 3 4 5 6 # å®‰è£… æœåŠ¡å™¨ç«¯ sudo apt-get install redis-server # æ£€æŸ¥æœåŠ¡å™¨ç³»ç»Ÿè¿›ç¨‹ ps -agx | grep redis # é€šè¿‡å‘½ä»¤è¡Œè®¿é—® redis-cli å°è¯•æ“ä½œ\nè§£å†³ä¸­æ–‡ä¹±ç , å¯åŠ¨æ—¶åŠ å‚æ•° --raw\n1 redis-cli --raw # å¯è§£å†³éƒ¨åˆ†äº¤äº’ç¯å¢ƒä¸­å‡ºç°çš„ä¸­æ–‡ä¹±ç é—®é¢˜ redis å®‰è£…å®Œæ¯•, é»˜è®¤æœ‰ 16 ä¸ªæ•°æ®åº“, åˆå§‹é»˜è®¤ä½¿ç”¨ 0 å·åº“, ç¼–å· 0,1,2\u0026hellip;15\n1 2 3 4 5 6 7 8 9 10 # å°è¯•ç‰›åˆ€ set key1 value # å¢åŠ ä¸€æ¡è®°å½• # å¦‚æœ value æ˜¯æ•°å­—ç±»å‹,å¯ä»¥è‡ªå¢ INCR key1 # å³+1æ“ä½œ get key1 # è·å–å¯¹åº”çš„å€¼ select 1 # åˆ‡æ¢æ•°æ®åº“ keys * # æŸ¥çœ‹å½“å‰åº“æ‰€æœ‰ key dbsize # æŸ¥çœ‹å½“å‰ key-val æ•°é‡ flushdb # æ¸…ç©ºå½“å‰æ•°æ®åº“çš„key-val flushall # æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“çš„key-val 2. åŸºç¡€çŸ¥è¯† ä¸€èˆ¬ç”µå•†åœºæ™¯è§£å†³æ–¹æ¡ˆ\né€‚ç”¨åœºæ™¯\nredis å­˜å‚¨çš„æ˜¯ key,value æ ¼å¼æ•°æ®\nå…¶ä¸­çš„ key éƒ½æ˜¯å­—ç¬¦ä¸², value æœ‰ ==5== å¤§æ•°æ®ç±»å‹\nå­—ç¬¦ä¸²ç±»å‹\nå“ˆå¸Œç±»å‹ hash:map\nåˆ—è¡¨ç±»å‹ list: linkedlistæ ¼å¼,æ”¯æŒé‡å¤å…ƒç´ \né›†åˆç±»å‹ set : ä¸å…è®¸é‡å¤å…ƒç´ ä¸”æ— åº\næœ‰åºé›†åˆç±»å‹ sortedset: ä¸å…è®¸é‡å¤å…ƒç´ ,ä¸”å…ƒç´ æœ‰åº\n2.1. ä½¿ç”¨ help äº†è§£å‘½ä»¤ 1 help incr 2.2. string ç±»å‹ å•ä¸ªæ“ä½œ\n1 2 3 4 5 set key value # set å¦‚æœkeyå­˜åœ¨åˆ™ä¿®æ”¹, ä¸åœ¨åˆ™æ·»åŠ  get key # get è·å– del key # del åˆ é™¤ strlen key # è·å–å­—ç¬¦ä¸²é•¿åº¦ append key value # å­˜å‚¨åˆ™è¿½åŠ ï¼Œå¦åˆ™æ–°å»ºï¼Œè¿”å›è¿½åŠ åçš„é•¿åº¦ å¤šä¸ªæ“ä½œ\n1 2 mset mess1 åŒ—äº¬ mess2 å¤©å®‰é—¨ # mset åŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ª key-value mget mess1 mess2 # mget åŒæ—¶è·å–å¤šä¸ªå€¼ æ‰©å±•æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # å¢ incr key\t# +1ï¼Œè¿”å›+1 åçš„å€¼ incrby key increment\t# +increment incrbyfloat key increment\t# æµ®ç‚¹æ“ä½œ # å‡ decr key\t# -1 decrby key increment\t# -increment # æœ‰æ•ˆæ—¶é—´ setex message 10 åŒ—äº¬å¤©å®‰é—¨ # setex(set with expire) è®¾ç½®æœ‰æ•ˆæ—¶é—´ä¸º 10 ç§’ psetex key 10 æ•…å®« # è®¾ç½®æœ‰æ•ˆæœŸ 10 æ¯«ç§’ # ä»…å½“å€¼ä¸å­˜åœ¨æ—¶ï¼Œå†™å…¥ setnx key 13 æ“ä½œæ³¨æ„äº‹é¡¹\nåº”ç”¨åœºæ™¯\n2.3. hash ç±»å‹ å¯¹ä¸€ç³»åˆ—æ•°æ®ç¼–ç»„ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œå…¸å‹åº”ç”¨å­˜å‚¨å¯¹è±¡ä¿¡æ¯ åº•å±‚ä½¿ç”¨ å“ˆå¸Œè¡¨ç»“æ„å®ç°æ•°æ®å­˜å‚¨ å•ä¸ªæ“ä½œ\n1 2 3 4 5 6 hset key age 15 # json æ˜¯è¿™æ ·è¡¨ç¤º { \u0026#34;mess\u0026#34;: { \u0026#34;age\u0026#34;:15 } } hset key name lucy # json æ˜¯è¿™æ ·è¡¨ç¤º { \u0026#34;mess\u0026#34;: { \u0026#34;age\u0026#34;:\u0026#34;15\u0026#34;, \u0026#34;name\u0026#34;:\u0026#34;locy\u0026#34; } } hget key field # è·å– hdel key field1 [field2] # åˆ é™¤ hgetall key # è·å–æ‰€æœ‰çš„é”®å€¼å¯¹ å¤šä¸ªæ“ä½œ\n1 2 3 4 5 6 7 8 # æ·»åŠ /ä¿®æ”¹ hmset key field1 value1 field2 value2 # è·å– hmget key field1 field2 # è·å–è¡¨ä¸­å­—æ®µæ•°é‡ hlen key # æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­—æ®µ hexists key field æ‰©å±•æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 # è·å–æ‰€æœ‰ key æˆ– value hkeys key hvals key # è®¾ç½®æŒ‡å®šå­—æ®µçš„æ•°å€¼å¢åŠ æŒ‡å®šèŒƒå›´çš„å€¼ hincrby key field increment hincrbyfloat key field increment # ä»…ä»…å½“å­—æ®µä¸å­˜åœ¨æ—¶è®¾ç½®è¯¥å€¼ hsetnx key age 11 æ³¨æ„äº‹é¡¹\nåº”ç”¨åœºæ™¯\n3 list ç±»å‹ redis åˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨, æŒ‰ç…§æ’å…¥é¡ºåºæ’åº, å¯ä»¥æ·»åŠ å…ƒç´ åˆ°å¤´éƒ¨æˆ–è€…å°¾éƒ¨ (å³ é˜Ÿåˆ—)\nè¯¥ç±»å‹åº•å±‚å®ç°æ˜¯åŒå‘é“¾è¡¨\n1 2 3 4 5 6 7 8 9 10 # æ·»åŠ  lpush key value # å·¦è¾¹æ·»åŠ  rpush key value # å³è¾¹æ·»åŠ  # è·å– lrange key start end # èŒƒå›´è·å– lrange key 0 -1 # è·å–æ‰€æœ‰å…ƒç´  # åˆ é™¤ lpop key # å¼¹å‡ºåˆ—è¡¨å·¦è¾¹ä¸€ä¸ªå…ƒç´ å¹¶è¿”å› rpop key # å¼¹å‡ºåˆ—è¡¨å·¦è¾¹ä¸€ä¸ªå…ƒç´ å¹¶è¿”å› brpop key 5 # å¼¹å‡ºå…ƒç´ , è‹¥æ˜¯æ²¡æœ‰,æœ€å¤šç­‰å¾…5ç§’ æ‰©å±•æ“ä½œ\n1 2 3 4 5 6 7 # è§„å®šæ—¶é—´å†…è·å–å¹¶ç§»é™¤å…ƒç´  # é˜»å¡ä»é“¾è¡¨è·å–æ•°æ®ï¼Œå½“é“¾è¡¨ä¸ºç©ºæ—¶ã€‚ç­‰å¾…æœ€å¤§æ—¶é—´å†…ï¼Œå…¥å€¼å°±å–å‡ºæ¥ blpop key1 [key2] timeout brpop key1 [key2] timeout # ç§»é™¤æŒ‡å®šæ•°æ® lrem key count value åº”ç”¨åœºæ™¯\n4 set ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # å­˜å‚¨ sadd key member1 [member2] # è·å– SMEMBERS key # è·å– set é›†åˆä¸­æ‰€æœ‰å…ƒç´  # åˆ é™¤ SREM key member1 [member2] # åˆ é™¤ set é›†åˆä¸­çš„æŸä¸ªå…ƒç´  # è·å–é›†åˆæ•°æ®æ€»é‡ scard key # åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«æŒ‡å®šæ•°æ® sismember key member # éšæœºè·å–é›†åˆä¸­æŒ‡å®šçš„æ•°é‡çš„æ•°æ® srandmember key [count] # éšæœºå°†æ•°æ®ç§»é™¤é›†åˆ spop key é€‚åˆåº”ç”¨äºéšæœºæ¨èç±»ä¿¡æ¯æ£€ç´¢ï¼Œçƒ­ç‚¹æ­Œå•æ¨è/çƒ­ç‚¹æ–°é—»æ¨è/çƒ­å–å•†å“/å¤§ V æ¨è/\næ³¨æ„äº‹é¡¹\nset ç±»å‹ä¸å…è®¸æ•°æ®é‡å¤ï¼Œå¦‚æœæ·»åŠ çš„æ•°æ®åœ¨ set ä¸­å·²å­˜åœ¨ï¼Œå°†åªä¿ç•™ä¸€ä»½ set è™½ç„¶ä¸ hash çš„å­˜å‚¨ç»“æ„ç›¸åŒï¼Œä½†æ˜¯æ— æ³•å¯ç”¨ hash ä¸­å­˜å‚¨å€¼çš„ç©ºé—´ åº”ç”¨åœºæ™¯\nä¾èµ– set é›†åˆæ•°æ®ä¸é‡å¤çš„ç‰¹å¾ æ ¹æ®ç”¨æˆ· ID è·å–ç”¨æˆ·æ‰€æœ‰è§’è‰² æ ¹æ®ç”¨æˆ·æ‰€æœ‰è§’è‰²è·å–ç”¨æˆ·æ‰€æœ‰æ“ä½œæƒé™ æ ¹æ®ç”¨æˆ·æ‰€æœ‰è§’è‰²è·å–ç”¨æˆ·çš„æ‰€æœ‰æ•°æ® 5 æœ‰åºé›†åˆ ( sorted_set ) æœ‰åº/ä¸å…è®¸é‡å¤/Stringç±»å‹\næ¯ä¸ªå…ƒç´ éƒ½å…³è”ä¸€ä¸ª double ç±»å‹çš„æ•°, æ ¹æ®æ­¤æ•°æ’åº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # æ·»åŠ  ZADD key score value [score2 value2] # è·å– zrange key start end zrange key 0 -1 withscores # æ˜¾ç¤ºæ•°æ®åŒæ—¶æ˜¾ç¤ºåˆ†æ•° zrange key 0 -1 # è·å–å…¨éƒ¨æ•°æ® zrevrange key start stop # å€’åº # åˆ é™¤ zrem key value # æŒ‰æ¡ä»¶è·å–æ•°æ® zrangebyscore key min max [withscores] [limit] zrevrangebyscore key max min [withscores] # æŒ‰æ¡ä»¶åˆ é™¤æ•°æ® zremrangebyrank key start stop zremrangebyscore key min max # è·å–é›†åˆæ•°æ®æ€»é‡ zcard key zcount key min max # é›†åˆäº¤/å¹¶æ“ä½œ zinterstore destination numkeys key [key ...] zunionstore destination numkeys key [key ...] # é€‚åˆåšåŠ¨æ€æ’è¡Œæ¦œ æ³¨æ„:\nmin ä¸ max ç”¨äºé™å®šæœç´¢æŸ¥è¯¢çš„æ¡ä»¶ start ä¸ stop ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºç´¢å¼•ï¼Œè¡¨ç¤ºå¼€å§‹å’Œç»“æŸç´¢å¼• offset ä¸ count ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºæŸ¥è¯¢ç»“æœï¼Œè¡¨ç¤ºå¼€å§‹ä½ç½®å’Œæ•°æ®æ€»é‡ é€šç”¨å‘½ä»¤ 1 2 3 4 keys * # æŸ¥è¯¢æ‰€æœ‰çš„é”®(å¯åŒ¹é…æ­£åˆ™) type key # æŸ¥è¯¢å€¼çš„ç±»å‹ del key # åˆ é™¤æŒ‡å®šçš„ key and value EXPIRE mess 10 // è®¾ç½® é”®ä¸º mess çš„å…ƒç´  æœ‰æ•ˆæ—¶é—´ä¸º 10 ç§’ æŒä¹…åŒ– redis æ˜¯ä¸€ä¸ªå†…å­˜æ•°æ®åº“, å½“ redis æœåŠ¡å™¨é‡å¯, æˆ–è€…ç”µè„‘é‡å¯, æ•°æ®ä¼šä¸¢å¤±, å¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–ä¿å­˜åˆ°ç¡¬ç›˜ä¸Š\nredis æŒä¹…åŒ–æœºåˆ¶( åˆ†åˆ«ä»¥ reb å’Œ aof ç»“å°¾ ):\nRDB é»˜è®¤æ–¹å¼, ä¸éœ€è¦è¿›è¡Œé…ç½® åœ¨ä¸€å®šé—´éš”æ—¶é—´ä¸­,æ£€æµ‹ key çš„å˜åŒ–æƒ…å†µ, ç„¶åæŒä¹…åŒ–æ•°æ®( è§å›¾1 å›¾2) AOF æ—¥å¿—è®°å½•çš„æ–¹å¼, å¯ä»¥è®°å½•æ¯ä¸€æ¡å‘½ä»¤çš„æ“ä½œ, å¯ä»¥æ¯ä¸€æ¬¡å‘½ä»¤æ“ä½œå¥½æŒä¹…åŒ–æ•°æ® ( å›¾3 å›¾4) å³æ¯ä¸€æ¬¡æ“ä½œéƒ½å†™å…¥æ–‡ä»¶ Go ä½¿ç”¨ Redis å¯¼å…¥ç¬¬ä¸‰æ–¹åŒ… : \u0026quot;github.com/garyburd/redigo/redis\u0026quot;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 // // Author: leafsoar // Date: 2017-05-04 16:29:03 // package redic import ( \u0026#34;time\u0026#34; \u0026#34;github.com/garyburd/redigo/redis\u0026#34; ) // Client å®¢æˆ·ç«¯ type Client struct { pool *redis.Pool } // NewRedisClient åˆ›å»ºå®¢æˆ·ç«¯ func NewRedisClient(addr string) *Client { ret := \u0026amp;Client{ pool: \u0026amp;redis.Pool{ MaxIdle: 3, MaxActive: 1000, IdleTimeout: time.Second * 180, Dial: func() (redis.Conn, error) { // fmt.Println(\u0026#34;new redis conn ...\u0026#34;) c, err := redis.Dial(\u0026#34;tcp\u0026#34;, addr) if err != nil { return nil, err } _, _ = c.Do(\u0026#34;select\u0026#34;, 0) return c, nil }, }, } return ret } // Close å…³é—­æ‰€æœ‰é“¾æ¥ func (c *Client) Close() { c.pool.Close() } func (c *Client) do(commandName string, args ...interface{}) (reply interface{}, err error) { rc := c.pool.Get() reply, err = rc.Do(commandName, args...) _ = rc.Close() return } // Do æ“ä½œ func (c *Client) Do(commandName string, args ...interface{}) (reply interface{}, err error) { return c.do(commandName, args...) } // Set è®¾ç½®å€¼ func (c *Client) Set(key, value string) (err error) { _, err = c.do(\u0026#34;SET\u0026#34;, key, value) return } // Expire å¤±æ•ˆ func (c *Client) Expire(key string, second int) (err error) { _, err = c.do(\u0026#34;EXPIRE\u0026#34;, key, second) return err } // Get è·å–å€¼ func (c *Client) Get(key string) (string, error) { return redis.String(c.do(\u0026#34;GET\u0026#34;, key)) } // Del åˆ é™¤ func (c *Client) Del(key string) (err error) { _, err = c.do(\u0026#34;DEL\u0026#34;, key) return err } // Push é˜Ÿåˆ— func (c *Client) Push(key string, value interface{}) (err error) { _, err = c.do(\u0026#34;lpush\u0026#34;, key, value) return } // Pop é»˜è®¤ä¸º list çš„ brpop æ“ä½œ func (c *Client) Pop(key string, fn func(string, error)) { for { func() { time.Sleep(time.Millisecond * 800) rc := c.pool.Get() defer func() { _ = rc.Close() }() for { ret, err := redis.Strings(rc.Do(\u0026#34;brpop\u0026#34;, key, 5)) if err == redis.ErrNil { return } else if err != nil { fn(\u0026#34;\u0026#34;, err) return } fn(ret[1], nil) } }() } } // PopByte é»˜è®¤ä¸º list çš„ brpop æ“ä½œ func (c *Client) PopByte(key string, fn func([]byte, error)) { for { func() { time.Sleep(time.Millisecond * 800) rc := c.pool.Get() defer func() { _ = rc.Close() }() for { ret, err := redis.ByteSlices(rc.Do(\u0026#34;brpop\u0026#34;, key, 5)) if err == redis.ErrNil { return } else if err != nil { fn(nil, err) return } fn(ret[1], nil) } }() } } ä¸€ è¿æ¥æ±  äºŒ å­—ç¬¦ä¸² set/get incr è®¡æ•°å™¨ ç”¨äºé˜²æ­¢è¡¨å•é‡å¤æäº¤ç­‰é—®é¢˜\nç±»ä¼¼æ•ˆæœçš„æœ‰ singleFight ï¼Œå…¶é—´éš”æ—¶é—´ä¸ºæ‰§è¡Œå®Œå½“å‰å‡½æ•°\nè®¡æ•°å™¨å¯ä»¥é€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ¥å»¶é•¿æäº¤é—´éš”ï¼Œä¸€èˆ¬ 1 / 2 å³å¯\n1 2 3 4 5 6 7 8 9 10 11 r, err := uc.Do(\u0026#34;incr\u0026#34;, \u0026#34;123\u0026#34;) if err != nil { fmt.Println(err) } k, _ := r.Result() // ä¸šåŠ¡ if k.(int64) \u0026gt; 1 { return } uc.Do(\u0026#34;EXPIRE\u0026#34;, \u0026#34;123\u0026#34;, 2) fmt.Println(\u0026#34;å¼€å§‹ä¸šåŠ¡\u0026#34;, id) å°è£…è®¡æ•°å™¨\næ­¤å°è£…å¹¶æœªå®ç°å¹‚ç­‰ï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func Incr(k string, s int, fn func() (interface{}, error)) (interface{}, error) { r, err := uc.Do(\u0026#34;incr\u0026#34;, k) if err != nil { return nil, err } count, _ := r.Result() if count.(int64) != 1 { return nil, nil } _, err = uc.Do(\u0026#34;expire\u0026#34;, s) if err != nil { return nil, err } return fn() } æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func TestDemo(t *testing.T) { if uc == nil { return } var wg sync.WaitGroup for i := 0; i \u0026lt; 1000; i++ { wg.Add(1) go func(i int) { defer wg.Done() Incr(\u0026#34;123\u0026#34;, 2, func() (interface{}, error) { fmt.Println(\u0026#34;123\u0026#34;) return nil, nil }) }(i) } wg.Wait() } ","date":"2020-05-15T00:00:00Z","permalink":"https://blog.golang.space/p/redis-%E5%9F%BA%E7%A1%80/","title":"Redis åŸºç¡€"},{"content":"è®¾ç½®è‡ªå¢ ID éšæœºæ­¥é•¿ï¼Œæ­¤æ–¹å¼ä½¿ç”¨è§¦å‘å™¨å®ç°ï¼Œæ¯æ¬¡è·å–è‡ªå¢ id åï¼Œå†éšæœºå¤šè·å–å‡ ä¸ªè‡ªå¢å€¼æ‰”æ‰ã€‚\nä»¥ä¸‹ä»…ä»…æ˜¯ä»æ•°æ®åº“çš„è§’åº¦è€ƒè™‘å¦‚ä½•è§£å†³é—®é¢˜ï¼Œå¹¶ä¸æ˜¯æœ€ä¼˜è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿä¸æ¨èä½¿ç”¨ã€‚\nä¼˜ç‚¹ èµ„æºæ¶ˆè€—å° ç”¨æˆ·æ— æ³•é€šè¿‡æ³¨å†Œæ–°è´¦å·è·å–è‡ªå¢ ID æ¥çŒœæµ‹æ•°æ®æ€»é‡ ( ä½¿ç”¨å›ºå®šæ­¥é•¿ï¼Œä¹Ÿå®¹æ˜“è¢«ç”¨æˆ·å‘ç°è§„å¾‹ ) é¿å…çˆ¬è™«è‡ªå¢ï¼Œæ‹‰å–å¤§é‡ç”¨æˆ·æ•°æ® ( é€šè¿‡ç½‘å…³è®¾ç½®ï¼Œåˆ¤æ–­ç›¸åŒ ip è¿ç»­æ‰“ç©ºï¼Œå° IP åœ°å€ ) å½“ä½ éœ€è¦æ›´å®‰å…¨ï¼Œæˆ–è‡ªå¢ ID å·²ä¸æ»¡è¶³ä½ çš„éœ€æ±‚æ—¶ï¼Œåº”è¯¥è€ƒè™‘ é›ªèŠ± ID å’Œ UUIDã€‚\næ–¹æ³• åˆ›å»ºè¡¨\n1 2 3 CREATE TABLE test ( id SERIAL -- ä¸»é”®ã€‚è‡ªå¢åºåˆ—ï¼Œé»˜è®¤ååºåˆ—å test_id_seq ) è®¾ç½®åºåˆ—å¼€å§‹å€¼ï¼Œå»ºè®® 6 ä½æ•°å¼€å§‹\næˆ–è€…ä» ä»»æ„è‡ªç„¶æ•° å¼€å§‹ï¼Œå»ºè®®é¢„ç•™ä¸€å®šçš„ä½ç½®ï¼Œç”¨äºæ•°æ®åº“ç®¡ç†å‘˜å¡å…¥é»˜è®¤æ•°æ®ã€‚\n1 SELECT setval(\u0026#39;test_id_seq\u0026#39;,100000,FALSE) æŸ¥è¯¢ä¸€ä¸‹ï¼Œä¸‹ä¸€ä¸ª ID æ˜¯ä¸æ˜¯è®¾å®šçš„å€¼\n1 SELECT nextval(\u0026#39;test_id_seq\u0026#39;::regclass) è®¾ç½®è§¦å‘å™¨å‡½æ•°ï¼Œå½“ä½ çš„ä¸»é”®åå¹¶é id æ—¶ï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹å‡½æ•°å†… id ä¸ºä½ çš„ä¸»é”®å\næ‰§è¡Œæ­¤å‡½æ•°ä¼šéšæœºæ‰”æ‰ 1-9 ä¸ªè‡ªå¢æ•°å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 CREATE OR REPLACE FUNCTION seq_func() RETURNS TRIGGER AS $body$ DECLARE -- è·å–éšæœºæ•° r INTEGER := (random()*8)::INTEGER+1; t INTEGER := 1; -- è·å–åºåˆ—å seq_name VARCHAR := pg_get_serial_sequence(TG_TABLE_NAME,\u0026#39;id\u0026#39;); BEGIN -- raise notice \u0026#39;name:%s\u0026#39;,seq_name; WHILE t\u0026lt;=r LOOP PERFORM nextval(seq_name::regclass); t=t+1; END LOOP; RETURN NEW; END; $body$ LANGUAGE plpgsql; åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨æ’å…¥æ•°æ®å®Œæˆåæ‰§è¡Œã€‚ æ­¤å¤„åŠ äº†ä¸€ä¸ªæ¡ä»¶ï¼Œå½“æ’å…¥ ID å°äºåºåˆ—è‡ªå¢èµ·å§‹å€¼æ—¶ï¼Œä¸è§¦å‘ã€‚å°äºè‡ªå¢èµ·å§‹å€¼æ—¶ï¼Œä¸€èˆ¬ä¸ºæ•°æ®åº“ç®¡ç†å‘˜æ‰‹åŠ¨æ’å…¥é»˜è®¤æ•°æ®ã€‚\nsql å†…çš„ 1000000 éœ€è¦ä¿®æ”¹ä¸ºèµ·å§‹å€¼ã€‚\n1 2 3 4 5 6 7 8 9 -- åˆ›å»ºè§¦å‘å™¨ CREATE TRIGGER test_id_seq_insert_trigger AFTER INSERT ON test FOR EACH ROW WHEN (NEW.id \u0026gt; 100000) EXECUTE FUNCTION seq_func(); -- åˆ é™¤è§¦å‘å™¨ DROP TRIGGER IF EXISTS test_id_seq_insert ON test; å¦‚æœæœ‰å¤šä¸ªè¡¨ï¼Œä»…éœ€è¦æ”¹åŠ¨ è§¦å‘å™¨åç§° åŠ è¡¨å\n1 2 3 4 5 6 7 8 9 10 11 12 13 -- åˆ›å»ºç¬¬äºŒå¼ è¡¨ create table example( id SERIAL ) -- è®¾ç½®åºåˆ—èµ·å§‹å€¼ï¼Œæ³¨æ„æ­¤å¤„å·²æ›´æ¢ åºåˆ—åç§° SELECT setval(\u0026#39;temp_id_seq\u0026#39;,100000,FALSE) -- è®¾ç½®è§¦å‘å™¨ï¼Œæ³¨æ„æ­¤å¤„å·²æ›´æ¢ è§¦å‘å™¨å å’Œ è¡¨å CREATE TRIGGER example_id_seq_insert_trigger AFTER INSERT ON example FOR EACH ROW WHEN (NEW.id \u0026gt; 100000) EXECUTE FUNCTION seq_func(); -- ç›¸å…³æµ‹è¯•ï¼Œæ£€æŸ¥æ˜¯å¦è®¾ç½®æˆåŠŸ å¹¶å‘æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func TestInsertTest(t *testing.T) { var ( wg sync.WaitGroup ids = make([]int, 100) ) // å¹¶å‘æ’å…¥ 100 æ¡æ•°æ®ï¼Œè·å– 100 ä¸ªè‡ªå¢ ID for i := 0; i \u0026lt; 100; i++ { wg.Add(1) go func(i int) { defer wg.Done() r := new(Test) r.K = strconv.Itoa(i) _, err := db.InsertOne(r) if err != nil { require.NoError(t, err) } ids[i] = r.ID }(i) } wg.Wait() // æ’åºåï¼Œè¾“å‡º sort.Ints(ids) for _, v := range ids { fmt.Println(\u0026#34;id : \u0026#34;, v) } } ç»“æœ\n1 2 3 4 5 6 7 8 9 10 11 12 13 id : 1000000 id : 1000001 id : 1000011 id : 1000012 id : 1000013 id : 1000014 id : 1000019 id : 1000036 id : 1000048 id : 1000057 id : 1000068 id : 1000069 ...... ","date":"2020-05-01T12:00:00Z","permalink":"https://blog.golang.space/p/%E5%BA%8F%E5%88%97%E8%87%AA%E5%A2%9E%E6%AD%A5%E9%95%BF/","title":"åºåˆ—è‡ªå¢æ­¥é•¿"},{"content":"React å¼€å‘åŸºç¡€ 1.0 å—æ§ç»„ä»¶ 1.1 çˆ¶ç»„ä»¶å‘å­ç»„ä»¶å•å‘ä¼ å€¼ 1 2 3 renderSquare(i) { return \u0026lt;Square value={i}/\u0026gt;; } å­ç»„ä»¶ Square\n1 2 3 4 5 class Square extends React.Component { render() { return \u0026lt;button className=\u0026#34;square\u0026#34;\u0026gt;{this.props.value}\u0026lt;/button\u0026gt;; } } è¯´æ˜: çˆ¶ç»„ä»¶ä½¿ç”¨å±æ€§æ–¹å¼ä¼ å€¼è¿‡å», å­ç»„ä»¶ç›´æ¥ props æ¥æ”¶\n1.2 å­ç»„ä»¶å‘çˆ¶ç»„ä»¶ä¼ å€¼ å­ç»„ä»¶é€šè¿‡ props è°ƒç”¨ çˆ¶ç±»çš„æ–¹æ³•, å°†æ•°æ®é€šè¿‡æ–¹æ³•å‚æ•°ä¼ é€’è¿‡å»\n1 2 3 \u0026lt;button className=\u0026#34;square\u0026#34; onClick={() =\u0026gt; this.props.onClick.bind(this, this.state.value)}\u0026gt; {this.props.value} \u0026lt;/button\u0026gt; çˆ¶ç»„ä»¶, è°ƒç”¨å­ç»„ä»¶æ—¶ä¼ é€’å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 renderSquare(i) { return ( \u0026lt;Square value={this.state.squares[i]} onClick={() =\u0026gt; this.handleClick(i)} /\u0026gt; ); handleClick(i) { const squares = this.state.squares.slice(); squares[i] = \u0026#39;X\u0026#39;; this.setState({squares: squares}); } æ³¨æ„åœ¨ handleClick æ–¹æ³•ä¸­è°ƒç”¨äº† slice æ–¹æ³•è¿›è¡Œæ•°ç»„èµ‹å€¼, ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš, è€Œä¸æ˜¯åœ¨åŸæ•°ç»„ä¸­æ”¹å˜å‘¢?\nä¸ç›´æ¥åœ¨æºæ•°æ®ä¸Šä¿®æ”¹, å¯ä»¥è·Ÿè¸ªåˆ°æ•°æ®çš„æ”¹å˜ , åŒæ—¶ç¡®å®šäº†\n1.2 å‡½æ•°ç»„ä»¶\n1 2 3 4 5 6 7 function Square(props) { return ( \u0026lt;button className=\u0026#34;square\u0026#34; onClick={props.onClick}\u0026gt; {props.value} \u0026lt;/button\u0026gt; ); } 1.2 å¦‚ä½•é˜»æ­¢é»˜è®¤è¡Œä¸º 1 2 3 4 5 6 7 8 9 10 11 12 function ActionLink() { function handleClick(e) { e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º console.log(\u0026#39;The link was clicked.\u0026#39;); } return ( \u0026lt;a href=\u0026#34;#\u0026#34; onClick={handleClick}\u0026gt; Click me \u0026lt;/a\u0026gt; ); } 1.3 å‡½æ•°äº‹ä»¶ç»‘å®š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 class Toggle extends React.Component { constructor(props) { super(props); this.state = { isToggleOn: true }; // ä¸ºäº†åœ¨å›è°ƒä¸­ä½¿ç”¨ `this`ï¼Œè¿™ä¸ªç»‘å®šæ˜¯å¿…ä¸å¯å°‘çš„ this.handleClick = this.handleClick.bind(this); } handleClick() { this.setState(state =\u0026gt; ({ isToggleOn: !state.isToggleOn })); } render() { return \u0026lt;button onClick={this.handleClick}\u0026gt;{this.state.isToggleOn ? \u0026#39;ON\u0026#39; : \u0026#39;OFF\u0026#39;}\u0026lt;/button\u0026gt;; } } é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœä½ æ²¡æœ‰åœ¨æ–¹æ³•åé¢æ·»åŠ  ()ï¼Œä¾‹å¦‚ onClick={this.handleClick}ï¼Œä½ åº”è¯¥ä¸ºè¿™ä¸ªæ–¹æ³•ç»‘å®š thisã€‚\nå‘äº‹ä»¶å¤„ç†ç¨‹åºä¼ é€’å‚æ•°, ä¸¤ç§æ–¹å¼ç­‰ä»·\n1 2 \u0026lt;button onClick={(e) =\u0026gt; this.deleteRow(id, e)}\u0026gt;Delete Row\u0026lt;/button\u0026gt; // æ˜¾å¼ä¼ é€’ \u0026lt;button onClick={this.deleteRow.bind(this, id)}\u0026gt;Delete Row\u0026lt;/button\u0026gt; // éšå¼ä¼ é€’ 1.4 ä½¿ç”¨æ¡ä»¶è¿ç®—ç¬¦æ¡ä»¶æ¸²æŸ“ 1.4.1 IF 1 2 3 4 5 6 7 function Greeting(props) { const isLoggedIn = props.isLoggedIn; if (isLoggedIn) { return \u0026lt;UserGreeting /\u0026gt;; } return \u0026lt;GuestGreeting /\u0026gt;; } 1.4.2 \u0026amp;\u0026amp; 1 2 3 4 5 6 7 8 9 function Mailbox(props) { const unreadMessages = props.unreadMessages; return ( \u0026lt;div\u0026gt; \u0026lt;h1\u0026gt;Hello!\u0026lt;/h1\u0026gt; {unreadMessages.length \u0026gt; 0 \u0026amp;\u0026amp; \u0026lt;h2\u0026gt;You have {unreadMessages.length} unread messages.\u0026lt;/h2\u0026gt;} \u0026lt;/div\u0026gt; ); } 1.4.3 é˜»æ­¢æ¸²æŸ“ return 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 function WarningBanner(props) { if (!props.warn) { return null; } return \u0026lt;div className=\u0026#34;warning\u0026#34;\u0026gt;Warning!\u0026lt;/div\u0026gt;; } class Page extends React.Component { constructor(props) { super(props); this.state = { showWarning: true }; this.handleToggleClick = this.handleToggleClick.bind(this); } handleToggleClick() { this.setState(state =\u0026gt; ({ showWarning: !state.showWarning })); } render() { return ( \u0026lt;div\u0026gt; \u0026lt;WarningBanner warn={this.state.showWarning} /\u0026gt; \u0026lt;button onClick={this.handleToggleClick}\u0026gt;{this.state.showWarning ? \u0026#39;Hide\u0026#39; : \u0026#39;Show\u0026#39;}\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; ); } } 1.5 ç”Ÿå‘½å‘¨æœŸ 1 2 3 componentDidMount(){} // æ¸²æŸ“å componentDidUpdate(){} // æ›´æ–°æ—¶ componentWillUnmount(){} // é”€æ¯æ—¶ 1.6 åˆ—è¡¨ åˆ—è¡¨éœ€è¦åˆ¶å®š key å€¼, key å”¯ä¸€. å½“ä¸æŒ‡å®šæ—¶é»˜è®¤ä»¥ä¸‹æ ‡ä½œä¸º key , ä¼šå‡ºç°è­¦å‘Šæç¤º\nkey åº”åœ¨æ•°ç»„ä¸Šä¸‹æ–‡ä¸­æŒ‡å®š\n1 2 3 4 5 6 7 8 9 10 11 12 13 function ListItem(props) { // æ­£ç¡®ï¼è¿™é‡Œä¸éœ€è¦æŒ‡å®š keyï¼š return \u0026lt;li\u0026gt;{props.value}\u0026lt;/li\u0026gt;; } function NumberList(props) { const numbers = props.numbers; const listItems = numbers.map(number =\u0026gt; ( // æ­£ç¡®ï¼key åº”è¯¥åœ¨æ•°ç»„çš„ä¸Šä¸‹æ–‡ä¸­è¢«æŒ‡å®š \u0026lt;ListItem key={number.toString()} value={number} /\u0026gt; )); return \u0026lt;ul\u0026gt;{listItems}\u0026lt;/ul\u0026gt;; } 1.7 è¡¨å•-å—æ§ç»„ä»¶ https://zh-hans.reactjs.org/docs/forms.html\n1.7.1 input 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 class NameForm extends React.Component { constructor(props) { super(props); this.state = { value: \u0026#39;\u0026#39; }; this.handleChange = this.handleChange.bind(this); this.handleSubmit = this.handleSubmit.bind(this); } handleChange(event) { this.setState({ value: event.target.value }); } handleSubmit(event) { alert(\u0026#39;æäº¤çš„åå­—: \u0026#39; + this.state.value); event.preventDefault(); } render() { return ( \u0026lt;form onSubmit={this.handleSubmit}\u0026gt; \u0026lt;label\u0026gt; åå­—: \u0026lt;input type=\u0026#34;text\u0026#34; value={this.state.value} onChange={this.handleChange} /\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;æäº¤\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; ); } } 1.7.2 textarea 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 class EssayForm extends React.Component { constructor(props) { super(props); this.state = { value: \u0026#39;è¯·æ’°å†™ä¸€ç¯‡å…³äºä½ å–œæ¬¢çš„ DOM å…ƒç´ çš„æ–‡ç« .\u0026#39; }; this.handleChange = this.handleChange.bind(this); this.handleSubmit = this.handleSubmit.bind(this); } handleChange(event) { this.setState({ value: event.target.value }); } handleSubmit(event) { alert(\u0026#39;æäº¤çš„æ–‡ç« : \u0026#39; + this.state.value); event.preventDefault(); } render() { return ( \u0026lt;form onSubmit={this.handleSubmit}\u0026gt; \u0026lt;label\u0026gt; æ–‡ç« : \u0026lt;textarea value={this.state.value} onChange={this.handleChange} /\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;æäº¤\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; ); } } 1.7.3 select 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 class FlavorForm extends React.Component { constructor(props) { super(props); this.state = { value: \u0026#39;coconut\u0026#39; }; this.handleChange = this.handleChange.bind(this); this.handleSubmit = this.handleSubmit.bind(this); } handleChange(event) { this.setState({ value: event.target.value }); } handleSubmit(event) { alert(\u0026#39;ä½ å–œæ¬¢çš„é£å‘³æ˜¯: \u0026#39; + this.state.value); event.preventDefault(); } render() { return ( \u0026lt;form onSubmit={this.handleSubmit}\u0026gt; \u0026lt;label\u0026gt; é€‰æ‹©ä½ å–œæ¬¢çš„é£å‘³: \u0026lt;select value={this.state.value} onChange={this.handleChange}\u0026gt; \u0026lt;option value=\u0026#34;grapefruit\u0026#34;\u0026gt;è‘¡è„æŸš\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;lime\u0026#34;\u0026gt;é…¸æ©™\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;coconut\u0026#34;\u0026gt;æ¤°å­\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;mango\u0026#34;\u0026gt;èŠ’æœ\u0026lt;/option\u0026gt; \u0026lt;/select\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;æäº¤\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; ); } } 1.8 çº¦å®š: è‡ªå®šä¹‰ç»„ä»¶ä»¥å¤§å†™å­—æ¯å¼€å¤´ react è®¤ä¸ºå°å†™çš„ tag æ˜¯åŸç”Ÿ dom èŠ‚ç‚¹ å¤§å†™å­—æ¯å¼€å¤´ä¸ºè‡ªå®šä¹‰ç»„ä»¶\n1.9 ç”Ÿå‘½å‘¨æœŸ getDerivedStateFromProp é€‚åˆè¡¨å•åˆå§‹åŒ– componentDidMount é€‚åˆèµ„æºåŠ è½½, å‘èµ· ajax è¯·æ±‚ componeWillUnmount ç»„ä»¶ç§»é™¤æ—¶è°ƒç”¨, é‡Šæ”¾èµ„æº getSnapshotBeforeUpdate render ä¹‹å‰è°ƒç”¨, è·å– render ä¹‹å‰çš„çŠ¶æ€ componentDidUpdate ui æ›´æ–°æ—¶è¢«è°ƒç”¨, é¡µé¢éœ€è¦ prop å˜åŒ–æ—¶é‡æ–°è·å–æ•°æ® showldComponentUpdate æ€§èƒ½ä¼˜åŒ– 1.9.1 demo æ¥äº†æ–°æ¶ˆæ¯ä¿è¯ä½ç½®ä¸å˜ æ–°æ•°æ®ä¼šé‡æ–°æ¸²æŸ“ç•Œé¢, å°±ä¼šå¯¼è‡´é«˜åº¦ä¸æ–­å¢åŠ , æ»šåŠ¨æ¡æ ¹æ®æ¶ˆæ¯å˜åŒ–, åœ¨ render ä¹‹å‰è·å–é«˜åº¦, æ›´æ–°æ—¶åŠ ä¸Šå·®å€¼\n2 HOOK 1 2 3 4 5 6 7 8 9 10 import React,{useState} from \u0026#39;react\u0026#39;; const [count,setCount] = useState(0); render(){ return ( \u0026lt;h2\u0026gt;{count} \u0026lt;/h2\u0026gt; \u0026lt;buttton onClick={ ()=\u0026gt;setCount(count+1) }\u0026gt; change\u0026lt;/button\u0026gt; ); } ANT 1.0 å®‰è£… 1 2 3 4 5 npm create umi // é€‰æ‹©æ¨¡æ¿ app // ç©ºæ ¼é€‰æ‹©åŠŸèƒ½, npm install npm run start Typescript è¯­æ³• 1.0 å®‰è£… 1 sudo npm i typescript -g 1.3 å‡½æ•°äº‹ä»¶ç»‘å®š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 class Toggle extends React.Component { constructor(props) { super(props); this.state = { isToggleOn: true }; // ä¸ºäº†åœ¨å›è°ƒä¸­ä½¿ç”¨ `this`ï¼Œè¿™ä¸ªç»‘å®šæ˜¯å¿…ä¸å¯å°‘çš„ this.handleClick = this.handleClick.bind(this); } handleClick() { this.setState(state =\u0026gt; ({ isToggleOn: !state.isToggleOn })); } render() { return \u0026lt;button onClick={this.handleClick}\u0026gt;{this.state.isToggleOn ? \u0026#39;ON\u0026#39; : \u0026#39;OFF\u0026#39;}\u0026lt;/button\u0026gt;; } } é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœä½ æ²¡æœ‰åœ¨æ–¹æ³•åé¢æ·»åŠ  ()ï¼Œä¾‹å¦‚ onClick={this.handleClick}ï¼Œä½ åº”è¯¥ä¸ºè¿™ä¸ªæ–¹æ³•ç»‘å®š thisã€‚\nå‘äº‹ä»¶å¤„ç†ç¨‹åºä¼ é€’å‚æ•°, ä¸¤ç§æ–¹å¼ç­‰ä»·\n1 2 \u0026lt;button onClick={(e) =\u0026gt; this.deleteRow(id, e)}\u0026gt;Delete Row\u0026lt;/button\u0026gt; // æ˜¾å¼ä¼ é€’ \u0026lt;button onClick={this.deleteRow.bind(this, id)}\u0026gt;Delete Row\u0026lt;/button\u0026gt; // éšå¼ä¼ é€’ 1.4 ä½¿ç”¨æ¡ä»¶è¿ç®—ç¬¦æ¡ä»¶æ¸²æŸ“ 1.4.1 IF 1 2 3 4 5 6 7 function Greeting(props) { const isLoggedIn = props.isLoggedIn; if (isLoggedIn) { return \u0026lt;UserGreeting /\u0026gt;; } return \u0026lt;GuestGreeting /\u0026gt;; } 1.4.2 \u0026amp;\u0026amp; 1 2 3 4 5 6 7 8 9 function Mailbox(props) { const unreadMessages = props.unreadMessages; return ( \u0026lt;div\u0026gt; \u0026lt;h1\u0026gt;Hello!\u0026lt;/h1\u0026gt; {unreadMessages.length \u0026gt; 0 \u0026amp;\u0026amp; \u0026lt;h2\u0026gt;You have {unreadMessages.length} unread messages.\u0026lt;/h2\u0026gt;} \u0026lt;/div\u0026gt; ); } 1.4.3 é˜»æ­¢æ¸²æŸ“ return 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 function WarningBanner(props) { if (!props.warn) { return null; } return \u0026lt;div className=\u0026#34;warning\u0026#34;\u0026gt;Warning!\u0026lt;/div\u0026gt;; } class Page extends React.Component { constructor(props) { super(props); this.state = { showWarning: true }; this.handleToggleClick = this.handleToggleClick.bind(this); } handleToggleClick() { this.setState(state =\u0026gt; ({ showWarning: !state.showWarning })); } render() { return ( \u0026lt;div\u0026gt; \u0026lt;WarningBanner warn={this.state.showWarning} /\u0026gt; \u0026lt;button onClick={this.handleToggleClick}\u0026gt;{this.state.showWarning ? \u0026#39;Hide\u0026#39; : \u0026#39;Show\u0026#39;}\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; ); } } 1.5 ç”Ÿå‘½å‘¨æœŸ 1 2 3 componentDidMount(){} // æ¸²æŸ“å componentDidUpdate(){} // æ›´æ–°æ—¶ componentWillUnmount(){} // é”€æ¯æ—¶ 1.6 åˆ—è¡¨ åˆ—è¡¨éœ€è¦åˆ¶å®š key å€¼, key å”¯ä¸€. å½“ä¸æŒ‡å®šæ—¶é»˜è®¤ä»¥ä¸‹æ ‡ä½œä¸º key , ä¼šå‡ºç°è­¦å‘Šæç¤º\nkey åº”åœ¨æ•°ç»„ä¸Šä¸‹æ–‡ä¸­æŒ‡å®š\n1 2 3 4 5 6 7 8 9 10 11 12 13 function ListItem(props) { // æ­£ç¡®ï¼è¿™é‡Œä¸éœ€è¦æŒ‡å®š keyï¼š return \u0026lt;li\u0026gt;{props.value}\u0026lt;/li\u0026gt;; } function NumberList(props) { const numbers = props.numbers; const listItems = numbers.map(number =\u0026gt; ( // æ­£ç¡®ï¼key åº”è¯¥åœ¨æ•°ç»„çš„ä¸Šä¸‹æ–‡ä¸­è¢«æŒ‡å®š \u0026lt;ListItem key={number.toString()} value={number} /\u0026gt; )); return \u0026lt;ul\u0026gt;{listItems}\u0026lt;/ul\u0026gt;; } 1.7 è¡¨å•-å—æ§ç»„ä»¶ https://zh-hans.reactjs.org/docs/forms.html\n1.7.1 input 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 class NameForm extends React.Component { constructor(props) { super(props); this.state = { value: \u0026#39;\u0026#39; }; this.handleChange = this.handleChange.bind(this); this.handleSubmit = this.handleSubmit.bind(this); } handleChange(event) { this.setState({ value: event.target.value }); } handleSubmit(event) { alert(\u0026#39;æäº¤çš„åå­—: \u0026#39; + this.state.value); event.preventDefault(); } render() { return ( \u0026lt;form onSubmit={this.handleSubmit}\u0026gt; \u0026lt;label\u0026gt; åå­—: \u0026lt;input type=\u0026#34;text\u0026#34; value={this.state.value} onChange={this.handleChange} /\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;æäº¤\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; ); } } 1.7.2 textarea 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 class EssayForm extends React.Component { constructor(props) { super(props); this.state = { value: \u0026#39;è¯·æ’°å†™ä¸€ç¯‡å…³äºä½ å–œæ¬¢çš„ DOM å…ƒç´ çš„æ–‡ç« .\u0026#39; }; this.handleChange = this.handleChange.bind(this); this.handleSubmit = this.handleSubmit.bind(this); } handleChange(event) { this.setState({ value: event.target.value }); } handleSubmit(event) { alert(\u0026#39;æäº¤çš„æ–‡ç« : \u0026#39; + this.state.value); event.preventDefault(); } render() { return ( \u0026lt;form onSubmit={this.handleSubmit}\u0026gt; \u0026lt;label\u0026gt; æ–‡ç« : \u0026lt;textarea value={this.state.value} onChange={this.handleChange} /\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;æäº¤\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; ); } } 1.7.3 select 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 class FlavorForm extends React.Component { constructor(props) { super(props); this.state = { value: \u0026#39;coconut\u0026#39; }; this.handleChange = this.handleChange.bind(this); this.handleSubmit = this.handleSubmit.bind(this); } handleChange(event) { this.setState({ value: event.target.value }); } handleSubmit(event) { alert(\u0026#39;ä½ å–œæ¬¢çš„é£å‘³æ˜¯: \u0026#39; + this.state.value); event.preventDefault(); } render() { return ( \u0026lt;form onSubmit={this.handleSubmit}\u0026gt; \u0026lt;label\u0026gt; é€‰æ‹©ä½ å–œæ¬¢çš„é£å‘³: \u0026lt;select value={this.state.value} onChange={this.handleChange}\u0026gt; \u0026lt;option value=\u0026#34;grapefruit\u0026#34;\u0026gt;è‘¡è„æŸš\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;lime\u0026#34;\u0026gt;é…¸æ©™\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;coconut\u0026#34;\u0026gt;æ¤°å­\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;mango\u0026#34;\u0026gt;èŠ’æœ\u0026lt;/option\u0026gt; \u0026lt;/select\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;æäº¤\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; ); } } Redux æ•°æ®ç®¡ç† state æ•°æ® store ä»“åº“ action ä¿®æ”¹ state reducer è§¦å‘ action è¿›è¡Œä¿®æ”¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // project \u0026gt; index.js import { createStore } from \u0026#39;redux\u0026#39;; const counterReducer = (state = 0, action) =\u0026gt; { switch (action.type) { case \u0026#39;INCREMENT\u0026#39;: return state + 1; default: return state; } }; const store = createStore(counterReducer); console.log(store.getState()); // æŒ‡æ´¾åŠ¨ä½œ store.dispatch({ type: \u0026#39;INCREMENT\u0026#39; }); åœ¨ reducer ä¸­ä¸å»ºè®®ä¿®æ”¹æºæ•°æ®, ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¤åˆ¶æ•°æ®\n1 let newState = JSON.parse(JSON.stringify(state)); demo\n1 åˆ›å»º store å­˜æ”¾åº”ç”¨çŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 // src -\u0026gt; store -\u0026gt; index.js import { createStore } from \u0026#39;redux\u0026#39;; import reducer from \u0026#39;./reducer\u0026#39;; // åˆ›å»º Redux store æ¥å­˜æ”¾åº”ç”¨çš„çŠ¶æ€ã€‚ // API æ˜¯ { subscribe, dispatch, getState }ã€‚ const store = createStore(reducer, window.__REDUX_DEVTOOLS_EXTENSION__ \u0026amp;\u0026amp; window.__REDUX_DEVTOOLS_EXTENSION__()); // å¯ä»¥æ‰‹åŠ¨è®¢é˜…æ›´æ–°ï¼Œä¹Ÿå¯ä»¥äº‹ä»¶ç»‘å®šåˆ°è§†å›¾å±‚ã€‚ store.subscribe(() =\u0026gt; console.log(store.getState())); export default store; 2 åˆ›å»º reducer\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // src -\u0026gt; store -\u0026gt; reducer.js import * as types from \u0026#39;./action\u0026#39;; const defaultState = { inputValue: \u0026#39;Write Something\u0026#39;, list: [\u0026#39;æ—©ä¸Š 8 ç‚¹æ™¨ä¼š, åˆ†é…ä»Šå¤©çš„ä»»åŠ¡1\u0026#39;, \u0026#39;æ—©ä¸Š 8 ç‚¹æ™¨ä¼š, åˆ†é…ä»Šå¤©çš„ä»»åŠ¡2\u0026#39;, \u0026#39;æ—©ä¸Š 8 ç‚¹æ™¨ä¼š, åˆ†é…ä»Šå¤©çš„ä»»åŠ¡3\u0026#39;] }; export default (state = defaultState, action) =\u0026gt; { switch (action.type) { case types.CHANGEINPUT: console.log(\u0026#39;action\u0026#39;, action); console.log(\u0026#39;state\u0026#39;, state); return Object.assign({}, state, { inputValue: action.value }); default: return state; } }; 3 åˆ›å»º actionTypes\n1 2 // src -\u0026gt; store -\u0026gt; actionTypes.js export const CHANGEINPUT = \u0026#39;CHANGEINPUT\u0026#39;; 4 åˆ›å»º actionCreates.js\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import * as types from \u0026#39;./actionTypes\u0026#39;; export const ChangeInputAction = val =\u0026gt; ({ type: types.CHANGE_INPUT, val }); export const AddListTile = () =\u0026gt; ({ type: types.ADD_LIST_TILE }); export const DeleteItem = index =\u0026gt; ({ type: types.DELETE_ITEM, index }); ç»„ä»¶ ui ä¸ä¸šåŠ¡é€»è¾‘æ‹†åˆ† åˆ›å»ºä¸šåŠ¡é€»è¾‘ä¸ç»„ä»¶ ui, ä½¿ç”¨ ä¸šåŠ¡é€»è¾‘é¡µé¢è°ƒç”¨ ç»„ä»¶\nä½¿ç”¨æ— çŠ¶æ€ç»„ä»¶æœ‰æ›´å¥½çš„æ€§èƒ½, æ— çŠ¶æ€ç»„ä»¶å­˜æ”¾ ui\nå¼‚æ­¥è¯·æ±‚ 1 2 3 4 5 6 7 yarn add axios import axios from \u0026#39;axios\u0026#39; axios.get(\u0026#39;\u0026#39;).then(()=\u0026gt;{ console.log }) ","date":"2020-04-10T15:00:00Z","permalink":"https://blog.golang.space/p/react-%E5%9F%BA%E7%A1%80/","title":"React åŸºç¡€"},{"content":"åˆ†ææºç ä¸­çš„ä¾èµ–å˜åŒ–ï¼Œè‡ªåŠ¨å¢åˆ ä¾èµ–ã€‚\nå¦‚æœå­˜åœ¨ vendor ç›®å½•ï¼Œåœ¨ä¿®æ”¹ä¾èµ–åï¼Œå¿…é¡»æ›´æ–° vendorã€‚\n1 2 go mod tidy go mod vendor æŸ¥è¯¢ logrus çš„æ‰€æœ‰å‘å¸ƒç‰ˆæœ¬\n1 go list -m -versions github.com/sirupsen/logrus é€šå¸¸æœ‰æŒ‡å®šæŸä¸ªç‰ˆæœ¬çš„éœ€è¦ï¼Œæ¯”å¦‚å‡çº§åå‘ç°å­˜åœ¨æŸäº›é—®é¢˜ï¼Œéœ€è¦ä½¿ç”¨æ›´æ–°ä¹‹å‰çš„ç‰ˆæœ¬\n1 go get github.com/sirupsen/logrus@v1.7.0 å½“ä¾èµ–çš„ä¸»ç‰ˆæœ¬å·ä¸º 0 æˆ– 1 çš„æ—¶å€™ï¼Œåœ¨ Go ä»£ç ä¸­æ·»åŠ å¯¼å…¥è·¯å¾„ä¸éœ€è¦åŠ ç‰ˆæœ¬å·ã€‚\n1 2 3 4 5 6 # import github.com/user/repo/v0 import github.com/user/repoimport # github.com/user/repo/v1 import github.com/user/repo # ä¸»ç‰ˆæœ¬å· \u0026gt;1 çš„æƒ…å†µ import github.com/user/repo/v2/xxx ","date":"2020-03-21T15:00:00Z","permalink":"https://blog.golang.space/p/go-module/","title":"Go Module"},{"content":"nginx 1. é…ç½®æ–‡ä»¶è¯­æ³• æ¯æ¡æŒ‡ä»¤ä»¥;ç»“å°¾ , æŒ‡ä»¤ä¸å‚æ•°é—´ä»¥ç©ºæ ¼ç¬¦å·åˆ†éš”; æ—¶é—´å•ä½ : s m h d w M y yyyy-MM-dd hh:mm:ss æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ localtion ~* \\.(jpg | png | jpeg)$ {} ç©ºé—´å•ä½ : ä¸å†™å•ä½é»˜è®¤æ˜¯ byte ; kb,mb,gb, åˆ†åˆ«ç”¨ k m g è¡¨ç¤º å¸¸ç”¨å˜é‡\n1 $binary_remote_addr // è¿œç«¯åœ°å€ 2. nginx å‘½ä»¤è¡Œ é‡è½½é…ç½®æ–‡ä»¶ - ä¸åœæ­¢æœåŠ¡\n1 nginx -s reload æ—¥è‡³åˆ‡å‰²\næ‰‹åŠ¨åˆ‡å‰²\n1 2 mv access.log access.log.back nginx -s reopen 3. é…ç½®é™æ€æœåŠ¡å™¨ é…ç½®æ–‡ä»¶ç»“æ„\n1 vim conf.d/default.conf server åŒ…å«åœ¨ http ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 http { gzip on;\t# å¼€å¯å‹ç¼© gzip_min_length 1k; # å°äºå¤šå°‘å°±ä¸åœ¨å‹ç¼© gzip_comp_level 2; # å‹ç¼©çº§åˆ« gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml; server { listen 8080; #ç›‘å¬ç«¯å£ server_name\tdomain.org; # åŸŸå access_log\tlogs/domain.access.log main; # æ—¥å¿— location / { alias lib/; # æ‰€æœ‰çš„è¯·æ±‚éƒ½å»è®¿é—® lib/ æ–‡ä»¶ä¸‹ # åå‘ä»£ç† proxy_set_header Host $host;\tproxy_set_header X-Real-IP $remote_addr; # ä¼ é€’ç”¨æˆ· IP proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # ç”¨äºä¼ é€’æ‰€æœ‰ ip proxy_redirect off; proxy_pass http://127.0.0.1:8089 } } } http æ ¸å¿ƒæ¨¡å—æ–‡æ¡£\nX-Forwarded-For ä¼šè®°å½•æ¯æ¬¡è·³è½¬çš„ IP, æ¯ä¸€æ¬¡åå‘ä»£ç†éƒ½ä¼šè®°å½• IP åˆ°æ•°ç»„å¤´éƒ¨\nX-Real-IP ç”¨æˆ·çš„å…¬ç½‘ IP\nserver å— listen ç«¯å£ç›‘å¬\n1 2 listen 8080; listen 127.0.0.1:8080; # åªèƒ½æœ¬æœºçš„è¿›ç¨‹è®¿é—® å¯ä»¥ç›‘å¬ç«¯å£ , æˆ–è€… ip\nserver_name åŸŸå\n1 2 3 4 5 server_name blog.golang.space; server_name blog.golang.space test.golang.space;# å¯ä»¥é…ç½®å¤šä¸ªåŸŸå server_name *.golang.space; # æ‰€æœ‰å­åŸŸå server_name .golang.space; # ä¸»åŸŸååŠå­åŸŸåéƒ½åŒ…å« server_name_in_redirect off; # on/off , on è¡¨ç¤ºä¼šé‡å®šå‘åˆ°ä¸»åŸŸå(ç¬¬ä¸€ä¸ªå‚æ•°) åŒ¹é…é¡ºåº\nç²¾ç¡®åŒ¹é… *åœ¨å‰çš„æ³›åŸŸå *åœ¨åçš„æ³›åŸŸå æ–‡ä»¶é¡ºåºåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ default server ç¬¬ä¸€ä¸ª listen æŒ‡å®š default **rewrite ** é‡å®šå‘\n1 2 rewrite regex replacement [flag] rewrite ^/(.*) http://golang.space/$1 permanent; flag\nlast ç”¨ replacement URI æ–°çš„åŒ¹é…\nbreak æŒ‡ä»¤åœæ­¢\nredirect 302 ä¸´æ—¶é‡å®šå‘\npermanent 301 æ°¸ä¹…é‡å®šå‘\nlocation è·¯å¾„åŒ¹é…\nä»£ç å®ä¾‹ä»¥ä¼˜å…ˆçº§æ’åº\n1 2 3 4 5 location = /xxx {}\t# ç²¾å‡†åŒ¹é… location ^~ /images/ {} # åŒ¹é…ä»¥ /images/ è·¯å¾„ location ~ /xxx {}\t# æ­£åˆ™åŒ¹é…æ‰€æœ‰ /xxx å¼€å¤´è·¯å¾„ location ~* \\.(gif|jpg|png)${} # åŒ¹é… gif..ç»“å°¾çš„è·¯å¾„ location / {}\t# ä¼˜å…ˆçº§æœ€ä½ï¼ŒåŒ¹é…æ‰€æœ‰ ä¼˜å…ˆçº§\n= \u0026gt;\t/x/y\t\u0026gt;\t^~\t\u0026gt;\t~ /~*\t\u0026gt;\t/x \u0026gt;\t/\n3 ssl https è‡ªåŠ¨åˆ›å»º å®‰è£…\n1 apt-get install python2-certbot-nginx æ‰§è¡Œ\n1 certbot --nginx --nginx-server-root=/user/local/conf/ -d blog.golang.space æŒ‡å®š nginx é…ç½®æ–‡ä»¶, è·å–è¯ä¹¦å¹¶éƒ¨ç½²\nå¸¸ç”¨å…³é”®å­— alias åˆ†é…æŒ‡å®šä½ç½®çš„è·¯å¾„ 1 2 3 location /i/ { alias /spool/w3/images/; } è®¿é—® \\i\\top.gif æ—¶, å®é™… nginx è®¿é—®è·¯å¾„ /spool/w3/images/top.gif\nç‰¹å¾\nå¿…é¡»ä»¥ / ç»“å°¾ åªèƒ½åœ¨ location å—ä¸­ ä¼šæ›¿æ¢æ‰ç›‘å¬çš„è·¯å¾„ , å¦‚ä¸Šé¢çš„ /i/ åœ¨æ­£åˆ™åŒ¹é…ä¸­ , å¿…é¡»æ•æ‰è¦åŒ¹é…çš„å†…å®¹ ( æ­¤å¤„è¿˜æœªç†è§£å¦‚ä½•ä½¿ç”¨ ) root æŒ‡å®šè¯·é—®æ–‡æ¡£æ ¹ç›®å½• 1 2 3 location /i/ { root /spool/w3; } è®¿é—® /i/top.gif æ—¶, å®é™… nginx è®¿é—®è·¯å¾„ /spool/w3/i/top.gif\nç‰¹å¾\nç»“å°¾æœ‰æ²¡æœ‰ / æ— æ‰€è°“ å¯ä»¥åœ¨ http , server, location, if ç­‰å¤šä¸ªå—ä¸­ä½¿ç”¨ å®é™…è®¿é—®è·¯å¾„æ˜¯ root + path index ç¡®å®šåˆå§‹é¡µ ä¸»è¦ç”¨äºè®¿é—®æ ¹ç›®å½•æ—¶ , æ–‡ä»¶å¤¹ç›®å½•æ—¶è¿”å›é¡µé¢\n1 2 3 location / { index index.html; } å½“è®¿é—® / çš„æ—¶å€™ , æ²¡æœ‰æŒ‡å®šä»»ä½•æ–‡ä»¶, ä¼šé»˜è®¤å»è®¿é—® index.html;\nç‰¹å¾\nè¿™é‡Œå¹¶ä¸æ˜¯ç›´æ¥æŒ‡å®šç›®å½•ä¸‹ index.html æ–‡ä»¶, è€Œæ˜¯å‘èµ·ä¸€ä¸ªå†…éƒ¨è¯·æ±‚åˆ° /index.html , æ„å‘³ç€å¯ä»¥åŠ ä¸€ä¸ªæ­£åˆ™åŒ¹é…, å¦‚ location ~ \\.html${ root /data/www } , å°†çœŸå®è¯·æ±‚åœ°å€è®¾ç½®ä¸º /data/www/index.html try_files å°è¯•æŸ¥æ‰¾æ–‡ä»¶ 1 2 3 location / { try_files $uri $uri/ /index.html; } è¯·æ±‚åœ°å€ : http://location/example , å˜é‡ $uri å°±æ˜¯ /example\næ­¤å¤„å…ˆå»æŸ¥æ‰¾è¿™ä¸ªæ–‡ä»¶, æ²¡æœ‰æ‰¾åˆ°å°±æ‰¾ç›®å½•, è¿˜æ˜¯æ²¡æœ‰å°±è½¬åˆ° http://location/index.html\n4. æŒ‡ä»¤çš„ç»§æ‰¿è§„åˆ™ å­å—ç»§æ‰¿çˆ¶å— å­å—å­˜åœ¨åˆ™è¦†ç›–çˆ¶å— éå¯¹ç§°åŠ å¯† å¯¹ç§°åŠ å¯† å‚è€ƒ https://juejin.im/post/6844903944267759624\n","date":"2020-03-15T15:00:00Z","permalink":"https://blog.golang.space/p/nginx-%E5%85%A5%E9%97%A8/","title":"nginx å…¥é—¨"},{"content":"Dart å…¥é—¨åˆ°æ‘”é—¨è€Œå» [toc]\nä¸€åˆ‡çš†å¯¹è±¡, null éƒ½æ˜¯å¯¹è±¡ , å…¨éƒ¨ç»§æ‰¿äº Object\næ¦‚è§ˆ Dart æ˜¯ä¸€é—¨å¼ºç±»å‹è¯­è¨€, ä½†æ˜¯å¯ä»¥ä½¿ç”¨ var and dynamic , å‰è€…ç”¨æ¥è‡ªåŠ¨è¯†åˆ«ç±»å‹, åè€…æ ‡è®°ä¸ºä¸ç¡®å®šç±»å‹ ;\næ”¯æŒæ³›å‹ : List\u0026lt;int\u0026gt;\næ ‡è¯†ç¬¦ä»¥ä¸‹åˆ’çº¿å¼€å¤´è¡¨ç¤ºç§æœ‰: _private\nAssert( boolean ) æ–¹æ³•å¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­è¿›è¡Œåˆ¤æ–­, boolean æ˜¯ false æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸\nè¯­æ³•åŸºç¡€ 1. å…¥å£å‡½æ•° ç¨‹åºæ‰§è¡Œçš„å…¥å£å‡½æ•°, æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ª main\n2. å­—ç¬¦ä¸²è¾“å‡ºæ–¹å¼ 1 2 3 4 5 6 7 8 9 String str = \u0026#34;123\u0026#34;; print(\u0026#34;è¯¥å­—ç¬¦ä¸²æ˜¯ $str\u0026#34;); // å¦‚æœæ˜¯å¯¹è±¡ print(\u0026#34;è¯¥å¯¹è±¡çš„ xx å­—æ®µæ˜¯ ${obj.xx}\u0026#34;); // å¤šè¡Œå­—ç¬¦ä¸² var str = \u0026#34;\u0026#34;\u0026#34;123 123 123 321\u0026#34;\u0026#34;\u0026#34;; ä½¿ç”¨ r å‰ç¼€å¯ä»¥ä½¿ç‰¹æ®Šå­—ç¬¦ä½œä¸ºæ™®é€šå­—ç¬¦ä¸²\n3. å†…ç½®ç±»å‹ numbers strings booleans lists sets maps runes symbols numbers åŒ…å« int å’Œ double\n3.1 list å€¼å¯ä»¥é‡å¤, ç±»å‹å¯ä»¥ä¸åŒ ä½¿ç”¨ list.add() æ·»åŠ å¯¹è±¡ list.lenght è·å–é•¿åº¦\n3.2 set å€¼ä¸å¯ä»¥é‡å¤, ç±»å‹å¿…é¡»ç›¸åŒ set.addAll() åŒç±»å‹é›†åˆæ·»åŠ ç°æœ‰é›†åˆ\n3.3 map 1 2 3 var git = {\u0026#34;h\u0026#34;:1}; git[\u0026#34;k\u0026#34;] = 2; // æ·»åŠ  var result = git[\u0026#34;h\u0026#34;]; // å–, å¦‚æœæ²¡æœ‰åˆ™ä¸º null, git å¿…é¡»å­˜åœ¨ 4. è¿ç®—ç¬¦ is è¡¨ç¤ºåˆ¤æ–­, as è¡¨ç¤ºè½¬æ¢\n1 2 3 4 5 6 7 8 print(\u0026#34;string\u0026#34; is String); // true , è¡¨ç¤º å‰è€…æ˜¯å­—ç¬¦ä¸²ç±»å‹ print(\u0026#34;1\u0026#34; as String); // 1, å¦‚æœ \u0026#34;1\u0026#34; æ˜¯ string ç±»å‹æ­£å¸¸è¾“å‡º, å¦åˆ™æŠ¥é”™ // å¸¸ç”¨åœ¨ if+is åˆ¤æ–­ç±»å‹, ä½¿ç”¨ä¸€ä¸ª as å³å¯å®Œæˆ if(emp is UserModel){ emp.name = \u0026#34;\u0026#34;; } // -\u0026gt; (emp as UserModel).name = \u0026#34;\u0026#34; // å¦‚æœ emp ä¸º null,æˆ–è€…ä¸æ˜¯ UserModel å¯¹è±¡,ç¬¬ä¸€æ®µä»£ç ä¸åšä»»ä½•äº‹, ç¬¬äºŒæ®µä»£ç æŠ¥é”™ ??= èµ‹å€¼æ“ä½œç¬¦ kk ??= \u0026quot;123\u0026quot; å¦‚æœ kk ä¸º null, åˆ™ kk = \u0026ldquo;123\u0026rdquo; , å¦åˆ™ kk=kk, å¸¸ç”¨äºæ ·å¼ä¸­å¡«å……æ•°æ®\n:: çº§è”ç¬¦å· é€šè¿‡çº§è”ç¬¦å·å¯ä»¥å¿«é€Ÿæ“ä½œåŒä¸€å¯¹è±¡, emp.name=\u0026quot;123\u0026quot;::age=15::sex=\u0026quot;ç”·\u0026quot;\n?. æ¡ä»¶æˆå‘˜è®¿é—®ç¬¦å·\n1 var name = emp?.name // å¦‚æœ emp ä¸ºç©º, åˆ™ name ä¸ºç©º ä»¥ä¸Šç¬¦å·ç»„åˆå¸¸ç”¨åœºæ™¯\nä» api è·å–æ•°æ®æ—¶\n1 2 var name = data[\u0026#34;name\u0026#34;] ...Text(name??=\u0026#34;ç”¨æˆ·å\u0026#34;) 1 2 3 4 5 // Valid compile-time constants as of Dart 2.5. const Object i = 3; // Where i is a const Object with an int value... const list = [i as int]; // Use a typecast. const map = {if (i is int) i: \u0026#34;int\u0026#34;}; // Use is and collection if. const set = {if (list is List\u0026lt;int\u0026gt;) ...list}; // ...and a spread. 5. é—­åŒ… åœ¨å‡½æ•°ä¸­åµŒå¥—åŒ¿åå‡½æ•°å¹¶è¿”å›, å°±ä¼šå½¢æˆé—­åŒ…, ä»¥å›¾ç‰‡ä¸ºä¾‹, å˜é‡ n ä¼šé€’å¢\n6 ç±»çš„æ„é€ å‡½æ•° å¸¸é‡å¯¹è±¡\n6.1 è®¿é—®å™¨å’Œå­˜å‚¨å™¨ get set 7 å·¥å‚æ„é€ æ–¹æ³• 8 ä»¿çœŸå‡½æ•° è®©ç±»å‘æ–¹æ³•ä¸€æ ·è°ƒç”¨\n9 ç»§æ‰¿ æ–¹æ³•å’Œå˜é‡é‡å†™\nå­ç±»é‡å†™çˆ¶ç±»æ„é€ æ–¹æ³•\n### 10 æŠ½è±¡ç±» 11 æ¥å£ 11 æ··åˆ è¢«æ··åˆçš„ç±»ä¸èƒ½æœ‰ æ˜¾ç¤ºæ„é€ æ–¹æ³• å®ç°å¤šç»§æ‰¿çš„ä¸€ç§æ–¹å¼\n12 æšä¸¾ 13 æ³›å‹çº¦æŸå‡½æ•° ç±»æ³›å‹\nå¼‚æ­¥æ–¹æ³• ä½¿ç”¨ future ä½¿ç”¨ async å’Œ await å¤šè¯·æ±‚å¹¶å‘æ‰§è¡Œ é“¾å¼è¯·æ±‚æ‰§è¡Œ\nä¸‰ç§åº“ æµ åˆ›å»ºä¸€ä¸ªæµæ§åˆ¶å™¨, ç›‘å¬æµ, å¦‚æœå‘ç°æ·»åŠ æ•°æ®, å°±è¾“å‡º\nsink æ’å…¥\nstream å¼¹å‡º\nå€¼ä¼ é€’ä¸å¼•ç”¨ä¼ é€’ åŸºç¡€æ•°æ®ç±»å‹éƒ½æ˜¯å€¼ä¼ é€’\nstring int bool double å¯¹è±¡éƒ½æ˜¯å¼•ç”¨ä¼ é€’\nset map class ","date":"2020-03-10T00:00:00Z","permalink":"https://blog.golang.space/p/dart-%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80/","title":"Dart è¯­æ³•åŸºç¡€"},{"content":"Docker image é•œåƒ, ç›¸å½“äºç±» container å®¹å™¨, ç›¸å½“äºå¯¹è±¡ repository ä»“åº“, é›†ä¸­å­˜å‚¨é•œåƒ tag æ ‡ç­¾, ç‰ˆæœ¬å· é›¶ å®‰è£… docker\nhttps://docs.docker.com/engine/install/ubuntu/ å®˜æ–¹æ–‡æ¡£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 sudo apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg echo \\ \u0026#34;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \\ $(lsb_release -cs) stable\u0026#34; | sudo tee /etc/apt/sources.list.d/docker.list \u0026gt; /dev/null sudo apt-get update sudo apt-get install docker-ce docker-ce-cli containerd.io ä¸€ é‡ç”¨å‘½ä»¤ å¸®åŠ©å‘½ä»¤\ndocker info åˆ—å‡ºå½“å‰docker çš„æ‰€æœ‰ä¿¡æ¯ docker --help å¸®åŠ© é•œåƒå‘½ä»¤\ndocker images åˆ—å‡ºæœ¬åœ°æ‰€æœ‰é•œåƒ\n-a æ‰€æœ‰\n-q å…¨éƒ¨é•œåƒ id\n\u0026ndash;digests æ‘˜è¦è¯´æ˜\n\u0026ndash;no-true åˆ—å‡ºå®Œæ•´ä¿¡æ¯,æ¯”å¦‚é•¿ id\ndocker search {image} æœç´¢é•œåƒ\n-s ç‚¹èµæ•°æ’åº docker search -s 30 ubuntu // åˆ—å‡º30ä»¥ä¸Šç‚¹èµçš„ubuntu é•œåƒ\n\u0026ndash;no-trunc å®Œæ•´ä¿¡æ¯\n\u0026ndash;automated åªåˆ—å‡ºautomated build é•œåƒ\ndocker pull {image[:tag]} ä¸‹è½½é•œåƒ\ndocker rmi {image} åˆ é™¤æŸä¸ªé•œåƒ\n-f å¼ºåˆ¶åˆ é™¤, å½“æœ‰å®¹å™¨åœ¨è¿è¡Œæ—¶éœ€è¦å¼ºåˆ¶åˆ é™¤æ‰èƒ½åˆ é™¤é•œåƒ\nå‚æ•°å¯ä»¥æ˜¯ é•œåƒid, ä¹Ÿå¯ä»¥æ˜¯å”¯ä¸€é•œåƒå, å¤šä¸ªé•œåƒä»¥ç©ºæ ¼åˆ†å‰²\nåˆ é™¤å…¨éƒ¨ docker rmi -f ${docker images -qa}\nå®¹å™¨å‘½ä»¤\ndocker run [option] {image} [command] [ARG...] è¿è¡Œé•œåƒ\n-name åå­—\n-d åå°è¿è¡Œ\n-i äº¤äº’è¿è¡Œ,ä¸ -t ä¸€åŒä½¿ç”¨\n-t åˆ†é…ä¼ªç»ˆç«¯\n-P éšæœºç«¯å£æ˜ å°„\n-p æŒ‡å®šç«¯å£æ˜ å°„ 8888:8080 å¯¹å¤–æš´éœ²ç«¯å£, å†…éƒ¨ç«¯å£\ndocker psæŸ¥çœ‹å®¹å™¨\nä»…ä»…æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨\n-a æŸ¥çœ‹æ‰€æœ‰å®¹å™¨,æ­£åœ¨è¿è¡Œ+å†å²è¿è¡Œ\n\u0026gt; -l æ˜¾ç¤ºæœ€è¿‘åˆ›å»º \u0026gt; \u0026gt; -n æ˜¾ç¤ºæœ€è¿‘ n ä¸ªå®¹å™¨ \u0026gt; \u0026gt; -q é™é»˜æ¨¡å¼, åªæ˜¾ç¤ºå®¹å™¨ç¼–å· \u0026gt; \u0026gt; --no-trunc ä¸æˆªæ–­è¾“å‡º(å®Œæ•´ä¿¡æ¯) é€€å‡ºå®¹å™¨\nexit å®¹å™¨åœæ­¢é€€å‡º ctrl+p+q å®¹å™¨ä¸åœæ­¢é€€å‡º docker startå¯åŠ¨å®¹å™¨\ndocker restart é‡å¯å®¹å™¨\nåœæ­¢å®¹å™¨\ndocker stop è½¯åœæ­¢ docker kill å¼ºåˆ¶ docker rm åˆ é™¤å®¹å™¨\nä¸€æ¬¡æ€§åˆ é™¤å¤šä¸ª\ndocker ps -aq | xargs docker rm\n==å®ˆæŠ¤è¿›ç¨‹== ä»¥åå°æ–¹å¼å¯åŠ¨å®¹å™¨,\ndocker å®¹å™¨åå°è¿è¡Œ, å¿…é¡»æœ‰ä¸€ä¸ªå‰å°è¿›ç¨‹\næŸ¥çœ‹å®¹å™¨æ—¥å¿—\n1 docker logs -ft --tail 3 3757f -t åŠ å…¥æ—¶é—´\n-f è·Ÿéšæœ€æ–°çš„æ—¥å¿—\n\u0026ndash;tail n æ˜¾ç¤ºæœ€å n æ¡\næŸ¥çœ‹å®¹å™¨å†…è¿›ç¨‹\n1 docker top 501d8 æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç»†èŠ‚\n1 docker inspect 501d8 è¿›å…¥å®¹å™¨\ndocker exec -it å®¹å™¨id /bin/bash è¿›å…¥å¹¶å¯ä»¥å¯åŠ¨æ–°è¿›ç¨‹, æœ«å°¾åŠ å‘½ä»¤å¯ä»¥è¹­è¹­ä¸è¿›å» é‡æ–°è¿›å…¥ docker attach å®¹å™¨id ç›´æ¥è¿›å…¥,ä¸ä¼šå¯åŠ¨æ–°è¿›ç¨‹ docker cpæ‹·è´\n1 2 docker cp å®¹å™¨id:/home/demo.go ~/Desktop/demo.go // å®¹å™¨å†…æ‹·è´åˆ°å®¿ä¸»æœº docker cp ~/Desktop/demo.go å®¹å™¨id:/home/demo.go // å®¿ä¸»æœºæ‹·è´åˆ°å®¹å™¨ å¦‚æœä¸æŒ‡å®šé•œåƒçš„ç‰ˆæœ¬, é»˜è®¤æœ€æ–°ç‰ˆ, :latest, ä½¿ç”¨ {image}:{tag} æ¥æŒ‡å®šç‰ˆæœ¬\näºŒ è¡¥å…… æäº¤å®¹å™¨å‰¯æœ¬ä½¿ä¹‹å»ºç«‹æ–°é•œåƒ\ndocker commit\ndocker commit -m=\u0026ldquo;æè¿°ä¿¡æ¯\u0026rdquo; -a=\u0026ldquo;ä½œè€…\u0026rdquo; å®¹å™¨id è¦åˆ›å»ºçš„ç›®æ ‡é•œåƒå:[æ ‡ç­¾å]\n1 docker commit -a=\u0026#34;breeze\u0026#34; -m=\u0026#34;delete tomcat docs\u0026#34; 614 breeze/tomcat:0.1 æ‰“åŒ…æˆå‹ç¼©åŒ…\n1 2 3 docker save -o adc.tar \u0026lt;é•œåƒå\u0026gt; # åŠ è½½é•œåƒ docker load -i adc.tar ä¸‰ å®¹å™¨æ•°æ®å· ç›®çš„æ˜¯è§£å†³ æŒä¹…åŒ–ä¸æ•°æ®å…±äº«, æ²¡æœ‰ç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºç›®å½•\n1 docker run -it -v /å®¿ä¸»æœºç»å¯¹è·¯å¾„:/å®¹å™¨å†…ç›®å½• é•œåƒå æ·»åŠ æƒé™ :ro read only , ä»…ä»…å¯è¯»\n1 docker run -it -v /å®¿ä¸»æœºç»å¯¹è·¯å¾„:/å®¹å™¨å†…ç›®å½•:ro é•œåƒå å¼€å¯å¤šä¸ªå®¹å™¨å·\n1 docker run -it -v /host1:/volume1 -v /host2:/volume2 centos é€šè¿‡ docker inspect æŸ¥çœ‹é•œåƒä¿¡æ¯, å…³é”®å­— volumes è¡¨ç¤ºæ•°æ®å·, true è¡¨ç¤ºå¯ä½¿ç”¨\nå…±äº«æ•°æ® \u0026ndash;volumes-from\næ–°å»ºå®¹å™¨,å¹¶å…±äº«å‰ä¸€ä¸ªå®¹å™¨çš„æ•°æ®å·\n1 docker run -it --name dc02 ---volumes-from dc01 breeze/centos å›› Dockerfile dockerfile ç”¨æ¥æ„å»º docker é•œåƒçš„æ„å»ºæ–‡ä»¶, ç”±ä¸€ç³»åˆ—å‘½ä»¤å’Œå‚æ•°æ„æˆçš„è„šæœ¬\nå¦‚ä½•ç”¨?\né€šè¿‡ dockerfile åˆ›å»ºé•œåƒ\n1 docker build -f /mydocker/dockerfile -t breeze/centos . æ³¨æ„åé¢æœ‰ä¸ª . , å³åœ¨å½“å‰ç›®å½•ç”Ÿæˆ\nè¯´æ˜\næ¯æ¡ä¿ç•™å­—æŒ‡ä»¤éƒ½å¿…é¡»ä¸ºå¤§å†™å­—æ¯ä¸”åé¢è¦è·Ÿéšè‡³å°‘ä¸€ä¸ªå‚æ•° æŒ‡ä»¤ä»ä¸Šåˆ°ä¸‹, é¡ºåºæ‰§è¡Œ æ¯æ¡æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒå±‚, å¹¶å¯¹é•œåƒè¿›è¡Œæäº¤ æŒ‡ä»¤\nFROM åŸºç¡€é•œåƒ, å½“å‰é•œåƒåŸºäºå“ªä¸ªé•œåƒ MAINTAINER é•œåƒç»´æŠ¤è€…çš„å§“åå’Œé‚®ç®± iXugo xx@golang.space RUN å®¹å™¨æ„å»ºæ—¶éœ€è¦è¿è¡Œçš„å‘½ä»¤ EXPOSE å½“å‰å®¹å™¨å¯¹å¤–æš´éœ²å‡ºçš„ç«¯å£ WORKDIR åˆ¶å®šåˆ›å»ºå®¹å™¨å, ç»ˆç«¯é»˜è®¤ç™»å½•çš„å·¥ä½œç›®å½• ENV æ„å»ºé•œåƒè¿‡ç¨‹ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ ADD å°†å®¿ä¸»æœºç›®å½•ä¸‹çš„æ–‡ä»¶æ‹·è´è¿›é•œåƒä¸”è‡ªåŠ¨å¤„ç† url å’Œè§£å‹ tar å‹ç¼©åŒ… COPY ç±»ä¼¼ add, æ‹·è´æ–‡ä»¶å’Œç›®å½•åˆ°é•œåƒä¸­ VOLUME å®¹å™¨æ•°æ®å·, æ•°æ®ä¿å­˜å’ŒæŒä¹…åŒ–å·¥ä½œ CMD æŒ‡å®šä¸€ä¸ªå®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤, å¯ä»¥æœ‰å¤šä¸ª, ä½†åªæ‰§è¡Œä¸€ä¸ª ENTRYPOINT æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ ONBUILD æ„å»ºä¸€ä¸ªè¢«ç»§æ‰¿çš„ dockerfile æ—¶è¿è¡Œå‘½ä»¤, çˆ¶é•œåƒè¢«å­ç»§æ‰¿å çˆ¶é•œåƒçš„ onbuild è¢«è§¦å‘, åŸºç¡€é•œåƒ scratch å…±äº«ç½‘ç»œ \u0026ndash;net=host é‚£äº›å‘ å®¹å™¨å†…æ—¶é—´ä¸å®¿ä¸»æœºæ—¶é—´ç›¸å·® 8 å°æ—¶\n1 docker cp /etc/localtime 41c:/etc/localtime ä½¿ç”¨æ•°æ®å·, æŒ‚è½½ä¸»æœºç›®å½• docker è®¿é—®å‡ºç°error\næç¤ºä¸ºï¼šã€€cannot open directory : Permission denied\nè§£å†³ã€€ï¼šã€€åœ¨æŒ‚è½½ç›®å½•æ—¶å¢åŠ å‚æ•°ã€€\u0026ndash;privileged=true\né…ç½®åŠ é€Ÿåœ°å€ 1 mac 1 https://xobyp2t2.mirror.aliyuncs.com 2 ubuntu é€šè¿‡ä¿®æ”¹daemoné…ç½®æ–‡ä»¶/etc/docker/daemon.jsonæ¥ä½¿ç”¨åŠ é€Ÿå™¨\n1 2 3 4 5 6 7 8 sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://xobyp2t2.mirror.aliyuncs.com\u0026#34;] } EOF sudo systemctl daemon-reload sudo systemctl restart docker docker å¸¸ç”¨è½¯ä»¶ä»¬ å®‰è£… ctop æ€§èƒ½ç›‘æ§\n1 2 3 wget https://github.com/bcicen/ctop/releases/download/v0.7.1/ctop-0.7.1-linux-amd64 -O /usr/local/bin/ctop chmod +x /usr/local/bin/ctop 1 mysql 8.0 è¿è¡Œå®ä¾‹\n1 2 docker run --name first-mysql -p 3308:3306 -e MYSQL_ROOT_PASSWORD=123456 -d mysql docker run --name second-mysql -p 3307:3306 -e MYSQL_ROOT_PASSWORD=123456 -d mysql ä½¿ç”¨ docker éƒ¨ç½² mysql é›†ç¾¤\n1 mysql -h127.0.0.1 -uroot -P3308 -p123456 1 mysql -h127.0.0.1 -uroot -P3307 -p123456 1\n1 show master status; æ— æ³•ç™»é™†\nsudo apt install gnupg2 pass\n","date":"2020-03-05T10:00:00Z","permalink":"https://blog.golang.space/p/docker-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","title":"Docker å­¦ä¹ ç¬”è®°"},{"content":"PostgreSQL [toc]\n1. å®‰è£… 1.1. linux å‘½ä»¤è¡Œå®‰è£… 1 2 3 sudo apt-get install postgresql su - postgres psql linux æœåŠ¡ç®¡ç†å‘½ä»¤ service\n1 2 3 service postgresql status // æŸ¥çœ‹çŠ¶æ€ service postgresql stop // åœæ­¢ service postgresql start // å¼€å§‹ 1.2. ä½¿ç”¨ docker-compose 1 2 mkdir plv8 \u0026amp;\u0026amp; cd plv8 vim docker-compose.yml 1 2 3 4 5 6 7 8 9 10 11 postgres: restart: always image: ionx/postgres-plv8:12.2 environment: - POSTGRES_PASSWORD=123456789 - TZ=Asia/Shanghai volumes: - $PWD/data:/var/lib/postgresql/data - /etc/localtime:/etc/localtime ports: - \u0026#34;8001:5432\u0026#34; # ç«¯å£æ˜ å°„ postgresql.conf é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 listen_addresses = \u0026#39;*\u0026#39; # ç›‘å¬ IP åœ°å€, è‹¥æ˜¯ localhost è¡¨ç¤ºä»…æœ¬åœ°å¯ä»¥è¿æ¥ port = 5432 # æ•°æ®åº“ç«¯å£ logging_collector = on # æ—¥å¿—æ”¶é›† log_directory = \u0026#39;log\u0026#39; # æ—¥å¿—ç›®å½• shared_buffers = 128MB # å…±äº«å†…å­˜å¤§å°, æœ‰è¶³å¤Ÿå†…å­˜æ—¶, å¯ä»¥è®¾ç½®å¤§ä¸€äº› work_mem = 4M # å• sql æ‰§è¡Œæ—¶, æ’åº,hash join ä½¿ç”¨çš„å†…å­˜ æ—¥å¿—æ–¹æ¡ˆ 1 æ¯å¤©æ–°ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶\n1 2 3 4 log_filename = \u0026#39;postgresql-%Y-%m-%d_%H%M%S.log\u0026#39; log_truncate_on_rotation = on\tlog_rotation_age = 1d\t# å¾ªç¯ log_rotation_size = 0\tæ—¥å¿—æ–¹æ¡ˆ 2 å†™æ»¡ä¸€å®šå¤§å°, å¦‚ 10m åˆ™åˆ‡æ¢æ—¥å¿—\n1 2 3 4 log_filename = \u0026#39;postgresql-%Y-%m-%d_%H%M%S.log\u0026#39; log_truncate_on_rotation = off\tlog_rotation_age = 0\tlog_rotation_size = 10M\tæ—¥å¿—æ–¹æ¡ˆ 3 ä¿ç•™ 7 å¤©æ—¥å¿—, å¾ªç¯è¦†ç›–\n1 2 3 4 log_filename = \u0026#39;postgresql-%a.log\u0026#39; log_truncate_on_rotation = on log_rotation_age = 1d\tlog_rotation_size = 0\t2. SQL ç®€å•æä¸€ä¸‹ SQL åŒºåˆ† DQL (æŸ¥è¯¢), DML(æ’å…¥/æ›´æ–°/åˆ é™¤æ•°æ®) , DDL(åˆ›å»º/ä¿®æ”¹/åˆ é™¤è¡¨)\n2.1. DDL åˆ›å»ºè¡¨\n1 2 3 4 create table \u0026lt;tab_name\u0026gt; ( col_name integer age integer ); åˆ é™¤è¡¨\n1 drop table \u0026lt;tab_name\u0026gt; 2.2. DML æ’å…¥æ•°æ®\n1 Insert INTO \u0026lt;tab_name\u0026gt; VALUES(2); æŒ‡å®šåˆ—æ’å…¥æ•°æ®\n1 Insert INTO \u0026lt;tab_name\u0026gt;(age) VALUES(17); æ›´æ–°è¯­å¥ , ä¸è®¾ç½®æ¡ä»¶ä¼šæ›´æ–°è¡¨ä¸­æ‰€æœ‰æ•°æ®\n1 update \u0026lt;tab_name\u0026gt; SET age = 18; æ›´æ–°å¤šæ¡ä¸”è®¾ç½® where æ¡ä»¶\n1 update \u0026lt;tab_name\u0026gt; SET col_name = 1,age=19 WHERE age=18; DELETE FROM åˆ é™¤ , å½“æ²¡æœ‰ where å…³é”®è¯æ—¶, è¡¨ç¤ºåˆ é™¤æ•´ä¸ªè¡¨,\n1 DELETE FROM \u0026lt;tab_name\u0026gt; WHERE age = 19; 2.3. DQL æ’åº order by 1 SELECT * FROM \u0026lt;tab_name\u0026gt; ORDER BY age DESC,col_name; åˆ†ç»„æŸ¥è¯¢ group by éœ€è¦ä½¿ç”¨èšåˆå‡½æ•°\n1 SELECT age,count(id) FROM \u0026lt;tab_name\u0026gt; GROUP BY age; 2.4. å…¶å®ƒ SQL è¯­å¥ union ä¸¤å¼ è¡¨æŸ¥è¯¢çš„æ•°æ®æ•´åˆåˆ°ä¸€èµ·\nunion é‡å¤çš„æ•°æ®ä¼šåˆå¹¶ä¸ºä¸€æ¡ union all ä¸åˆå¹¶é‡å¤æ•°æ® 1 2 3 SELECT * FROM \u0026lt;tab_name\u0026gt; WHERE age = 18 UNION SELECT * FROM \u0026lt;tab_name\u0026gt; WHERE col_name \u0026gt;= 2 åˆ é™¤è¡¨\ntruncate table ä¸¢å¼ƒæ—§è¡¨, åˆ›å»ºæ–°è¡¨, é‡å»ºç´¢å¼• delete from ä¸€æ¡æ¡åˆ é™¤æ•°æ® 3. PSQL 3.1. ä½¿ç”¨æ–¹æ³• 1 2 3 4 5 6 \\l # åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ \\c \u0026lt;database\u0026gt;\t# è¿æ¥æ•°æ®åº“ \\d # æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„è¡¨/åºåˆ—/è§†å›¾/ç´¢å¼• \\d+ # å±•ç¤ºæ›´å¤šä¿¡æ¯ \\d \u0026lt;table\u0026gt; # æ˜¾ç¤ºè¡¨ç»“æ„ \\q # é€€å‡º æ•°æ®åº“å®‰è£…å¥½å, æœ‰ä¸‰ä¸ªæ•°æ®åº“\npostgre é»˜è®¤æ•°æ®åº“ template0 æœ€ç®€åŒ–æ¨¡æ¿æ•°æ®åº“ template1 ç”¨æˆ·æ–°å»ºæ•°æ®åº“æ—¶, é»˜è®¤ä» template1 å…‹éš†, é€šå¸¸å¯ä»¥å®šåˆ¶ template1 çš„å†…å®¹ , ä½¿ç”¨ PSQL è¿æ¥æ•°æ®åº“\n1 psql -h \u0026lt;ip\u0026gt; -p \u0026lt;5432\u0026gt; [æ•°æ®åº“åç§°] [ç”¨æˆ·åç§°] 3.2. å¸¸ç”¨å‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 \\dt # åˆ—å‡ºè¡¨ \\di # åˆ—å‡ºç´¢å¼• \\ds # åˆ—å‡ºåºåˆ— \\dv # åˆ—å‡ºè§†å›¾ \\df # åˆ—å‡ºå‡½æ•° \\dn # åˆ—å‡º schema \\db # åˆ—å‡ºè¡¨ç©ºé—´ \\du # åˆ—å‡ºç”¨æˆ· \\z # åˆ—å‡ºè¡¨çš„æƒé™åˆ†é… \\i \u0026lt;æ–‡ä»¶å\u0026gt; # æ‰§è¡Œå¤–éƒ¨æ–‡ä»¶ SQL \\? # å‘½ä»¤æç¤º \\timing on # åˆ—å‡º sql æ‰§è¡Œæ—¶é—´ 3.3. äº‹åŠ¡ 1 2 3 4 5 begin; -- dml commit; -- æˆ–è€… rollback; 4. æ•°æ®ç±»å‹ 4.1. è¡¨æ ¼ ç±»å‹ è¯´æ˜ å…¶å®ƒæ•°æ®åº“å¯¹æ¯” å¸ƒå°” boolean ä¸ mysql ç±»å‹ç›¸åŒ, ä¸€å­—èŠ‚ æ•´å‹ smallint 2 å­—èŠ‚ int 4 å­—èŠ‚ bigint 8 å­—èŠ‚ æµ®ç‚¹ real å’Œ double precision money 8 å­—èŠ‚çš„è´§å¸ç±»å‹ numeric(m,n) 10 è¿›åˆ¶ç²¾ç¡®ç±»å‹ å­—ç¬¦ç±»å‹ varchar(n) å˜é•¿å­—ç¬¦ char(n) å®šé•¿, ä¸è¶³è¡¥ç©ºæ ¼ text é•¿å˜æ–‡æœ¬,æ— é™åˆ¶ Postgresql çš„ varchar æœ€å¤§å¯å­˜å‚¨ 1G mysql çš„ varchar æœ€å¤§å¯å­˜å‚¨ 64kb äºŒè¿›åˆ¶ bytea å¯¹åº” mysql çš„ blob å’Œ longblob äºŒè¿›åˆ¶ä½ä¸² bit(n) bit varying(n) æ—  æ—¥æœŸ date å¹´æœˆæ—¥ time æ—¶åˆ†ç§’ timestamp å¹´æœˆæ—¥æ—¶åˆ†ç§’ ç½‘ç»œåœ°å€ cidr 7-19å­—èŠ‚, ç½‘ç»œåœ°å€ inet 7-19å­—èŠ‚, ç½‘ç»œæˆ–ä¸»æœºåœ°å€macaddr 6 å­—èŠ‚, ä»¥å¤ªç½‘ mac åœ°å€ æ—  æ•°ç»„ç±»å‹ æšä¸¾ç±»å‹ ç•¥ å‡ ä½•ç±»å‹ ç•¥ å¤åˆç±»å‹ ç±»ä¼¼ç»“æ„ä½“ xml json json å’Œ jsonb range èŒƒå›´ç±»å‹ å…¶å®ƒç±»å‹ ä¸å¥½åˆ†ç±»çš„ç±»å‹, å¦‚ UUID 4.2. ç±»å‹è½¬æ¢ æ–¹æ³•ä¸€ æ ‡å‡† SQL è½¬æ¢å‡½æ•° CAST\n1 select cast(\u0026#39;5\u0026#39; as int),cast(\u0026#39;2014-07-17\u0026#39; as date); æ–¹æ³•äºŒ psql åŒå†’å·è½¬æ¢\n1 select \u0026#39;5\u0026#39;::int 4.3. boolean ç±»å‹ ä½¿ç”¨ boolean ç±»å‹, å¯ä»¥çº¦æŸéç©º, è®¾ç½®é»˜è®¤å€¼, é¿å… SQLæŸ¥è¯¢æ—¶è¿˜éœ€è¦åˆ¤æ–­ç©ºçš„æƒ…å†µ\n4.4. å¸ƒå°”ç±»å‹æ“ä½œç¬¦ AND\na,b éƒ½æ˜¯ null ä¸º null a,b éƒ½æ˜¯ true, ä¸º true, å¦åˆ™ false OR\nå­˜åœ¨ true åˆ™ä¸º true , è‹¥ a,b éƒ½æ˜¯ false ,å­˜åœ¨ null åˆ™ä¸º null NOT\nnot null = null not true = false not false = true IS\nå¸ƒå°”ç±»å‹ä½¿ç”¨ is æ¯”è¾ƒ\n4.5. å­—ç¬¦ä¸²å‡½æ•°ä¸æ“ä½œç¬¦ æ‹¼æ¥å­—ç¬¦ä¸²\n1 \u0026#39;Post\u0026#39; || \u0026#39;greSQL\u0026#39; # PostgreSQL æ±‚å­—ç¬¦ä¸²é•¿åº¦\n1 char_length(\u0026#39;post\u0026#39;) # 4 4.6. äºŒè¿›åˆ¶ç±»å‹ é€‚åˆå­˜å‚¨å›¾ç‰‡/è§†é¢‘/æ–‡ä»¶ç±»å‹\n4.7. æ—¶é—´ç±»å‹ SELECT LOCALTIMESTAMP(0) - interval \u0026lsquo;15 day\u0026rsquo;\nextract æå–æ—¶é—´ä¸­çš„å­åŸŸ, å¦‚å¹´/æœˆ/æ—¥/æ—¶/åˆ†/ç§’\n4.8. æšä¸¾ç±»å‹ åˆ›å»ºæšä¸¾, æ’å…¥æ—¶å¦‚æœä¸æ˜¯æšä¸¾ä¸­å­˜åœ¨çš„å­—ç¬¦ä¸², åˆ™æŠ¥é”™\nè¯¥ç±»å‹å¤§å°å†™æ•æ„Ÿ, Sun != sun\n1 create type week as ENUM (\u0026#39;Sun\u0026#39;,\u0026#39;Mon\u0026#39;,\u0026#39;Tues\u0026#39;,\u0026#39;Wed\u0026#39;,\u0026#39;Thur\u0026#39;,\u0026#39;Fri\u0026#39;,\u0026#39;Sat\u0026#39;) æŸ¥è¯¢æ‰€æœ‰æšä¸¾ç±»å‹\n1 \\dT 4.9. json ç±»å‹ json ç±»å‹ä¿ç•™ç©ºæ ¼/æ ¼å¼/é¡ºåº\njsonb ç±»å‹å­˜å…¥æ—¶ä¼šè½¬æ¢äºŒè¿›åˆ¶, å–ç”¨æ—¶ä¸ç”¨å†æ¬¡è½¬æ¢, æ›´é«˜æ•ˆ; ä¸”ä¸ä¼šä¿ç•™ç©ºæ ¼/æ ¼å¼/é¡ºåºç­‰\næ“ä½œç¬¦\næ“ä½œç¬¦ æè¿° -\u0026gt; ä¸‹æ ‡å–æ•°ç»„å…ƒç´  [1,2,3]::json-\u0026gt;1 key å–å­å¯¹è±¡ {\u0026ldquo;a\u0026rdquo;:12,\u0026ldquo;b\u0026rdquo;:13}::json-\u0026gt;\u0026lsquo;a\u0026rsquo; -\u0026gt;\u0026gt; åŒä¸Š, å–å‡ºæ¥çš„ç»“æœæ˜¯ text ç±»å‹ #\u0026gt; å–åµŒå¥—å¯¹è±¡ {\u0026ldquo;a\u0026rdquo;:{\u0026ldquo;b\u0026rdquo;:{\u0026ldquo;c\u0026rdquo;:1}}} :: json #\u0026gt; \u0026lsquo;{a,b}\u0026rsquo; #\u0026gt;\u0026gt; åŒä¸Š, å–å‡ºæ¥çš„ç»“æœæ˜¯ text ç±»å‹ æœ‰ä¸€äº›æ“ä½œç¬¦ä»…å¯ç”¨äº jsonb\næ“ä½œç¬¦ æ¼”ç¤º è¯´æ˜ = jsonb \u0026lsquo;[1,2]\u0026rsquo; = jsonb \u0026lsquo;[1,2]\u0026rsquo; @\u0026gt; jsonb \u0026lsquo;[1,2]\u0026rsquo; @\u0026gt; jsonb \u0026lsquo;[1]\u0026rsquo; å·¦è¾¹å¯¹è±¡æ˜¯å¦åŒ…å«å³è¾¹å¯¹è±¡ \u0026lt;@ \u0026hellip; ? Jsonb \u0026lsquo;{\u0026ldquo;a\u0026rdquo;:1,\u0026ldquo;b\u0026rdquo;:1}\u0026rsquo; ? \u0026lsquo;a\u0026rsquo; a æ˜¯å¦å­˜åœ¨äºå¯¹è±¡çš„ key æˆ–å­—ç¬¦ä¸²ç±»å‹å…ƒç´ ä¸­ `? ` Jsonb \u0026lsquo;{\u0026ldquo;a\u0026rdquo;:1,\u0026ldquo;b\u0026rdquo;:1}\u0026rsquo; ?| array[\u0026lsquo;a\u0026rsquo;,\u0026lsquo;b\u0026rsquo;] ?\u0026amp; Jsonb \u0026lsquo;{\u0026ldquo;a\u0026rdquo;:1,\u0026ldquo;b\u0026rdquo;:1}\u0026rsquo; ?| array[\u0026lsquo;a\u0026rsquo;,\u0026lsquo;b\u0026rsquo;] æ•°ç»„ä¸­çš„å†…å®¹æ˜¯å¦éƒ½åœ¨ json ä¸­ 4.9.1. jsonb ç±»å‹åˆ›å»ºç´¢å¼• 1 create index idx_name ON table_name USING gin (index_col) 5. é€»è¾‘ç»“æ„ç®¡ç† ä¿®æ”¹æ•°æ®åº“æœ€å¤§è¿æ¥æ•°\n1 alter database testdb01 connection limit 10; ä¿®æ”¹è¡¨å\n1 alter table posts rename to postsNew åˆ é™¤æ•°æ®åº“\n1 drop databse [if exists] name; 5.1. åˆ›å»ºæ¨¡å¼ schema æ˜¯æ•°æ®åº“çš„æ¦‚å¿µ, å¯ä»¥ç†è§£ä¸ºå‘½åç©ºé—´æˆ–ç›®å½•;\nåˆ›å»ºæ¨¡å¼\n1 create schema schema_name [authorization username]; åˆ é™¤æ¨¡å¼\n1 drop schema schema_name; ä¿®æ”¹æ‰€æœ‰è€…\n1 alter schema name owner to new_owner; ä¿®æ”¹æ¨¡å¼å\n1 alter schema name rename to new_name; å¸¸ç”¨å‡½æ•° NULLIF ä¸¤ä¸ªå‚æ•°ç›¸ç­‰æ—¶ï¼Œè¿”å›ç©ºå€¼ï¼Œå¦åˆ™è¿”å› v1\n1 NULLIF(v1,v2) COALESCE è¿”å›ç¬¬ä¸€ä¸ªéæ§å‚æ•°çš„å€¼ï¼Œæ‰€æœ‰å‚æ•°éƒ½ä¸ºç©ºæ—¶è¿”å›ç©º\n1 COALESCE(v1,[,...]) CASE æ¡ä»¶è¡¨è¾¾å¼\n1 2 3 4 5 CASE WHEN \u0026lt;æ¡ä»¶\u0026gt; THEN \u0026lt;ç»“æœ\u0026gt; [WHEN ...] ELSE \u0026lt;ç»“æœ\u0026gt; END ","date":"2020-02-23T12:00:00Z","permalink":"https://blog.golang.space/p/postgresql-%E5%9F%BA%E7%A1%80/","title":"PostgreSQL åŸºç¡€"},{"content":"ä»€ä¹ˆæ˜¯ SingleFlight? åº”å¯¹å¹¶å‘çš„åˆ©å™¨! å¸¸ç”¨åœºæ™¯æœ‰: ç¼“å­˜ç©¿é€\n100 ä¸ªå¹¶å‘ï¼Œæ™®é€šçš„åŠ é”æ–¹å¼ä¼šå¯¼è‡´é˜Ÿåˆ—æ‰§è¡Œã€‚\nè€Œ SingleFlight ä¼šç¼“å­˜ä¸€ç¬é—´çš„å¹¶å‘è¯·æ±‚å‡½æ•°è¿”å›å€¼ã€‚ç¬¬ 1 ä¸ªè®¿é—®çš„å‡½æ•°å»æ‰§è¡Œï¼Œå…¶ä½™ 99 ä¸ªè¿›å…¥åç¨‹ç­‰å¾…ï¼Œå½“ç¬¬ä¸€ä¸ªå‡½æ•°æ‰§è¡Œç»“æœå‡ºæ¥ï¼Œå‰©ä¸‹ 99 ä¸ªç›´æ¥è¿”å›è¯¥ç»“æœã€‚æœ€ååˆ é™¤ map ä¸­ç¼“å­˜çš„ç»“æœã€‚\nå¦‚ä½•ä½¿ç”¨ SingleFlight? 1 2 3 4 5 6 func TestSingleFlight(t *testing.T){ var g singleflight.Group g.Do(\u0026#34;key\u0026#34;,func() (interface{}, error){ return \u0026#34;test\u0026#34;,nil }) } çœ‹çœ‹æºç  singleflight\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package singleflight import \u0026#34;sync\u0026#34; type call struct { wg sync.WaitGroup // é˜»å¡å¹¶å‘å‡½æ•°è¯·æ±‚ val interface{}\t// å‡½æ•°è¿”å›å€¼ err error\t// å‡½æ•°è¿”å›å€¼ } // ä¸€ç±»å·¥ä½œ type Group struct { mu sync.Mutex m map[string]*call // å»¶è¿Ÿåˆå§‹åŒ–,ç”¨äºä¸´æ—¶å­˜å‚¨å‡½æ•° } // åˆ¤æ–­ key æ˜¯å¦ç¬¬ä¸€æ¬¡è°ƒç”¨ // æ˜¯åˆ™è°ƒç”¨å‡½æ•°è·å–ç»“æœ // ä¸æ˜¯, åˆ™é˜»å¡åœ¨ c.wg.Wait() ç­‰å¾…å‡½æ•°è¿”å›å€¼ func (g *Group) Do(key string, fn func() (interface{}, error)) (interface{}, error) { g.mu.Lock() // åˆ›å»º map if g.m == nil { g.m = make(map[string]*call) } // å¦‚æœå·²ç»æœ‰è¿™ä¸ªå‡½æ•°äº†, åˆ™è¿›å…¥å¹¶è§£é”, è®©å…¶å®ƒåç¨‹å…¨éƒ¨è¿›å…¥ // ç­‰å¾…å‡½æ•°è¿”å›å€¼ï¼Œæ³¨æ„ map çš„å€¼æ˜¯æŒ‡é’ˆ if c, ok := g.m[key]; ok { g.mu.Unlock() // ç­‰å¾…å‡½æ•°æ‰§è¡Œç»“æœ c.wg.Wait() return c.val, c.err } // åˆå§‹åŒ– call,å†™å…¥ map åè§£é” c := new(call) c.wg.Add(1) g.m[key] = c g.mu.Unlock() // æ‰§è¡Œå‡½æ•° c.val, c.err = fn() // å·²ç»è·å–ç»“æœ, åè¿›æ¥çš„åç¨‹éƒ½å¯ä»¥è¿”å›äº† c.wg.Done() // group ä»…ä»…æ˜¯æ‰§è¡Œå‡½æ•°æ—¶çš„ä¸´æ—¶å­˜å‚¨ç©ºé—´ // æ“ä½œç»“æŸå, åˆ é™¤å†…å®¹ g.mu.Lock() delete(g.m, key) g.mu.Unlock() return c.val, c.err } ","date":"2020-01-22T15:00:00Z","permalink":"https://blog.golang.space/p/singleflight/","title":"singleflight"},{"content":"atomic 1. åŸºç¡€çŸ¥è¯† 1.1. æ¦‚å¿µ åŸå­æ€§ï¼šä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œåœ¨CPUçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸è¢«ä¸­æ–­çš„ç‰¹æ€§ï¼Œç§°ä¸ºåŸå­æ€§ã€‚è¿™äº›æ“ä½œå¯¹å¤–è¡¨ç°æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œä»–ä»¬è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œå¤–ç•Œä¸ä¼šçœ‹åˆ°ä»–ä»¬åªæ‰§è¡Œåˆ°ä¸€åŠçš„çŠ¶æ€ã€‚\nåŸå­æ“ä½œï¼šè¿›è¡Œè¿‡ç¨‹ä¸­ä¸èƒ½è¢«ä¸­æ–­çš„æ“ä½œï¼ŒåŸå­æ“ä½œç”±åº•å±‚ç¡¬ä»¶æ”¯æŒï¼Œè€Œé”åˆ™æ˜¯ç”±æ“ä½œç³»ç»Ÿæä¾›çš„APIå®ç°ï¼Œè‹¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼Œå‰è€…é€šå¸¸ä¼šæ›´æœ‰æ•ˆç‡\n1.2. ä»‹ç» atomicåŒ…æä¾›äº†åº•å±‚çš„åŸå­çº§å†…å­˜æ“ä½œï¼Œå¯¹äºåŒæ­¥ç®—æ³•çš„å®ç°å¾ˆæœ‰ç”¨ã€‚\nè¿™äº›å‡½æ•°å¿…é¡»è°¨æ…åœ°ä¿è¯æ­£ç¡®ä½¿ç”¨ã€‚é™¤äº†æŸäº›ç‰¹æ®Šçš„åº•å±‚åº”ç”¨ï¼Œä½¿ç”¨é€šé“æˆ–è€…syncåŒ…çš„å‡½æ•°/ç±»å‹å®ç°åŒæ­¥æ›´å¥½ã€‚\nåº”é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ï¼Œè€Œä¸é€šè¿‡å…±äº«å†…å­˜å®ç°é€šä¿¡ã€‚\nè¢«SwapTç³»åˆ—å‡½æ•°å®ç°çš„äº¤æ¢æ“ä½œï¼Œåœ¨åŸå­æ€§ä¸Šç­‰ä»·äºï¼š\n1 2 3 old = *addr *addr = new return old CompareAndSwapTç³»åˆ—å‡½æ•°å®ç°çš„æ¯”è¾ƒ-äº¤æ¢æ“ä½œï¼Œåœ¨åŸå­æ€§ä¸Šç­‰ä»·äºï¼š\n1 2 3 4 5 if *addr == old { *addr = new return true } return false AddT ç³»åˆ—å‡½æ•°å®ç°åŠ æ³•æ“ä½œï¼Œåœ¨åŸå­æ€§ä¸Šç­‰ä»·äºï¼š\n1 2 *addr += delta return *addr LoadTå’ŒStoreTç³»åˆ—å‡½æ•°å®ç°çš„åŠ è½½å’Œä¿æŒæ“ä½œï¼Œåœ¨åŸå­æ€§ä¸Šç­‰ä»·äºï¼š\u0026ldquo;return *addr\u0026quot;å’Œ\u0026rdquo;*addr = val\u0026quot;ã€‚\n1.3. ç±»å‹ä¸å‡½æ•° atomicåŒ…ä¸­æ”¯æŒå…­ç§ç±»å‹\nint32 uint32 int64 uint64 uintptr unsafe.Pointer å¯¹äºæ¯ä¸€ç§ç±»å‹ï¼Œæä¾›äº†äº”ç±»åŸå­æ“ä½œï¼š\nLoadXXX(addr): åŸå­æ€§çš„è·å–*addrçš„å€¼ï¼Œç­‰ä»·äºï¼š\n1 return *addr StoreXXX(addr, val): åŸå­æ€§çš„å°†valçš„å€¼ä¿å­˜åˆ°*addrï¼Œç­‰ä»·äºï¼š\n1 addr = val AddXXX(addr, delta): åŸå­æ€§çš„å°†deltaçš„å€¼æ·»åŠ åˆ°*addrå¹¶è¿”å›æ–°å€¼ï¼ˆunsafe.Pointerä¸æ”¯æŒï¼‰ï¼Œç­‰ä»·äºï¼š\n1 2 *addr += delta return *addr SwapXXX(addr, new) old: åŸå­æ€§çš„å°†newçš„å€¼ä¿å­˜åˆ°*addrå¹¶è¿”å›æ—§å€¼ï¼Œç­‰ä»·äºï¼š\n1 2 3 old = *addr *addr = new return old CompareAndSwapXXX(addr, old, new) bool: åŸå­æ€§çš„æ¯”è¾ƒ*addrå’Œoldï¼Œå¦‚æœç›¸åŒåˆ™å°†newèµ‹å€¼ç»™*addrå¹¶è¿”å›trueï¼Œç­‰ä»·äºï¼š\n1 2 3 4 5 if *addr == old { *addr = new return true } return false 1.4. æ”¯æŒä»»æ„ç±»å‹çš„ atomic.Value Goè¯­è¨€åœ¨1.4ç‰ˆæœ¬çš„æ—¶å€™å‘sync/atomicåŒ…ä¸­æ·»åŠ äº†æ–°çš„ç±»å‹Valueï¼Œæ­¤ç±»å‹ç›¸å½“äºä¸€ä¸ªå®¹å™¨ï¼Œè¢«ç”¨æ¥\u0026quot;åŸå­åœ°\u0026quot;å­˜å‚¨ï¼ˆStoreï¼‰å’ŒåŠ è½½ä»»æ„ç±»å‹çš„å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func TestGosched(t *testing.T) { done := false var v atomic.Value v.Store(done) go func() { v.Store(true) }() for !v.Load().(bool) { } println(\u0026#34;done !\u0026#34;) } 2. ä½¿ç”¨æ¡ˆä¾‹ 2.1. atomic.AddInt32 å¤šä¸ª goroutine ä»¤ count é€’å¢ï¼Œåœ¨æ²¡æœ‰ä»»ä½•ä¿æŠ¤æªæ–½æƒ…å†µä¸‹ï¼Œä¼šå‘ç”Ÿ data raceã€‚æ­¤å¤„ä½¿ç”¨ atomic.AddInt32 æ¥ä¿è¯åŸå­æ€§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 func TestAtomicAddInt32(t *testing.T) { var count int32 var wg sync.WaitGroup for i := 0; i \u0026lt; 100; i++ { wg.Add(1) go func() { defer wg.Done() atomic.AddInt32(\u0026amp;count, 1) }() } wg.Wait() fmt.Println(\u0026#34;count: \u0026#34;, count) } 2.2. atomic.Value 3. æ³¨æ„äº‹é¡¹ 4. æºç æµ…æ 4.1. Value go@1.16.5\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 // æä¾›åŸå­çš„åŠ è½½å’Œå­˜å‚¨ // é›¶å€¼ä¸º nil // è°ƒç”¨ Store åï¼Œç¦æ­¢å¤åˆ¶ Value // ç¬¬ä¸€æ¬¡ä½¿ç”¨åï¼Œç¦æ­¢å¤åˆ¶ type Value struct { v interface{} } // ifaceWords æ˜¯ interface{} å†…éƒ¨è¡¨ç¤º type ifaceWords struct { typ unsafe.Pointer // åŸå§‹ç±»å‹ data unsafe.Pointer\t// å€¼ } // è¿”å›æœ€è¿‘ Store è®¾ç½®çš„å€¼ // å¦‚æœæ²¡æœ‰è°ƒç”¨ Store åˆ™è¿”å› nil func (v *Value) Load() (x interface{}) { vp := (*ifaceWords)(unsafe.Pointer(v)) typ := LoadPointer(\u0026amp;vp.typ) if typ == nil || uintptr(typ) == ^uintptr(0) { // ç¬¬ä¸€æ¬¡å­˜å‚¨æ²¡æœ‰å®Œæˆ return nil } data := LoadPointer(\u0026amp;vp.data) xp := (*ifaceWords)(unsafe.Pointer(\u0026amp;x)) xp.typ = typ xp.data = data return } // Store å°† Value çš„å€¼è®¾ç½®ä¸º x // æ‰€æœ‰ Store è°ƒç”¨å¿…é¡»ä½¿ç”¨ç›¸åŒç±»å‹çš„å€¼ // ç±»å‹ä¸ä¸€è‡´ä¼šå‘ç”Ÿ panicï¼Œ Store(nil) ä¹Ÿæ˜¯å¦‚æ­¤ func (v *Value) Store(x interface{}) { if x == nil { panic(\u0026#34;sync/atomic: store of nil value into Value\u0026#34;) } // å°† V å’Œ x è½¬æ¢ä¸º ifaceWords ç±»å‹ï¼Œè¿™æ ·ä¸‹ä¸€æ­¥æ–¹ä¾¿è·å–åŸå§‹ç±»å‹å’Œå€¼ vp := (*ifaceWords)(unsafe.Pointer(v)) xp := (*ifaceWords)(unsafe.Pointer(\u0026amp;x)) for { // ç°æœ‰çš„å€¼ typ := LoadPointer(\u0026amp;vp.typ) // å¦‚æœ typ = nil åˆ™è¡¨ç¤ºç¬¬ä¸€æ¬¡ Store if typ == nil { // å¼€å§‹ç¬¬ä¸€æ¬¡å­˜å‚¨ runtime_procPin() if !CompareAndSwapPointer(\u0026amp;vp.typ, nil, unsafe.Pointer(^uintptr(0))) { runtime_procUnpin() continue } // Complete first store. StorePointer(\u0026amp;vp.data, xp.data) StorePointer(\u0026amp;vp.typ, xp.typ) runtime_procUnpin() return } if uintptr(typ) == ^uintptr(0) { // å¦‚æœtypä¸º^uintptr(0)è¯´æ˜ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æ²¡æœ‰å®Œæˆï¼Œç»§ç»­å¾ªç¯ç­‰å¾… continue } // ç±»å‹ä¸ä¸€è‡´ï¼Œpanic if typ != xp.typ { panic(\u0026#34;sync/atomic: store of inconsistently typed value into Value\u0026#34;) } // è¦†ç›–æ•°æ® StorePointer(\u0026amp;vp.data, xp.data) return } } // ç¦ç”¨/å¯ç”¨ æŠ¢å , åœ¨ runtime å®ç° func runtime_procPin() func runtime_procUnpin() runtime_procPin å¯ä»¥å°†ä¸€ä¸ª Goroutine å ç”¨å½“å‰ä½¿ç”¨çš„ Pï¼Œä¸å…è®¸å…¶ä»–çš„ Gouroutine æŠ¢å ï¼Œruntime_procUnpin é‡Šæ”¾ã€‚\n","date":"2020-01-05T15:00:00Z","permalink":"https://blog.golang.space/p/24.atomic/","title":"24.atomic"},{"content":"åå°„ è¯·è¿œç¦»reflectå’ŒunsafeåŒ…ï¼Œé™¤éä½ ç¡®å®éœ€è¦å®ƒä»¬ã€‚åŸå› æœ‰ä¸‰\nåŸºäºåå°„çš„ä»£ç æ˜¯æ¯”è¾ƒè„†å¼±çš„ã€‚åå°„åœ¨çœŸæ­£è¿è¡Œä»£ç æ—¶æ‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸, å¯èƒ½æ˜¯å†™å®Œä»£ç å¾ˆä¹…ä»¥å, è€Œä¸”ç¨‹åºä¹Ÿå¯èƒ½è¿è¡Œäº†å¾ˆé•¿çš„æ—¶é—´ã€‚ å³ä½¿å¯¹åº”ç±»å‹æä¾›äº†ç›¸åŒæ–‡æ¡£ï¼Œä½†æ˜¯åå°„çš„æ“ä½œä¸èƒ½åšé™æ€ç±»å‹æ£€æŸ¥ï¼Œè€Œä¸”å¤§é‡åå°„çš„ä»£ç é€šå¸¸éš¾ä»¥ç†è§£ã€‚æ€»æ˜¯éœ€è¦å°å¿ƒç¿¼ç¿¼åœ°ä¸ºæ¯ä¸ªå¯¼å‡ºçš„ç±»å‹å’Œå…¶å®ƒæ¥å—interface{}æˆ–reflect.Valueç±»å‹å‚æ•°çš„å‡½æ•°ç»´æŠ¤è¯´æ˜æ–‡æ¡£ã€‚ åŸºäºåå°„çš„ä»£ç é€šå¸¸æ¯”æ­£å¸¸çš„ä»£ç è¿è¡Œé€Ÿåº¦æ…¢ä¸€åˆ°ä¸¤ä¸ªæ•°é‡çº§ã€‚å¯¹äºä¸€ä¸ªå…¸å‹çš„é¡¹ç›®ï¼Œå¤§éƒ¨åˆ†å‡½æ•°çš„æ€§èƒ½å’Œç¨‹åºçš„æ•´ä½“æ€§èƒ½å…³ç³»ä¸å¤§ï¼Œæ‰€ä»¥å½“åå°„èƒ½ä½¿ç¨‹åºæ›´åŠ æ¸…æ™°çš„æ—¶å€™å¯ä»¥è€ƒè™‘ä½¿ç”¨ã€‚æµ‹è¯•æ˜¯ä¸€ä¸ªç‰¹åˆ«é€‚åˆä½¿ç”¨åå°„çš„åœºæ™¯ï¼Œå› ä¸ºæ¯ä¸ªæµ‹è¯•çš„æ•°æ®é›†éƒ½å¾ˆå°ã€‚ä½†æ˜¯å¯¹äºæ€§èƒ½å…³é”®è·¯å¾„çš„å‡½æ•°ï¼Œæœ€å¥½é¿å…ä½¿ç”¨åå°„ã€‚ Goè¯­è¨€æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ›´æ–°å˜é‡å’Œæ£€æŸ¥å®ƒä»¬çš„å€¼ã€è°ƒç”¨å®ƒä»¬çš„æ–¹æ³•å’Œå®ƒä»¬æ”¯æŒçš„å†…åœ¨æ“ä½œï¼Œè€Œä¸éœ€è¦åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“è¿™äº›å˜é‡çš„å…·ä½“ç±»å‹ã€‚è¿™ç§æœºåˆ¶è¢«ç§°ä¸ºåå°„ã€‚\n1. ä¸ºä»€ä¹ˆéœ€è¦åå°„? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Sprint è¿™æ˜¯ä»¿çš„ fmt åŒ…çš„åŒåå‡½æ•°,åŠŸèƒ½ä¸å…¨, ä¸”å¦‚æœè¾“å…¥ map/array ç­‰ç±»å‹ // åˆ†æ”¯è¿˜éœ€è¦è¡¥å……è¿™äº›ä»£ç ,è‹¥æ˜¯éœ€è¦å¯¼å…¥çš„ç»„åˆç±»å‹,å°†ä¼šäº§ç”Ÿä¾èµ– // æ‰€ä»¥éœ€è¦åå°„ func Sprint(x interface{}) string { type stringer interface { String() string } switch x := x.(type) { case stringer: return x.String() case string: return x case int: return strconv.Itoa(x) case bool: if x { return \u0026#34;true\u0026#34; } return \u0026#34;false\u0026#34; default: // array, chan, func, map, pointer, slice, struct return \u0026#34;???\u0026#34; } } 2. å¦‚ä½•ä½¿ç”¨? 2.1. TypeOf å‡½æ•° reflect.TypeOf æ¥å—ä»»æ„çš„ interface{} ç±»å‹ï¼Œå¹¶ä»¥ reflect.Type å½¢å¼è¿”å›å…¶åŠ¨æ€ç±»å‹\n1 2 3 t := reflect.TypeOf(3) // a reflect.Type fmt.Println(t.String()) // \u0026#34;int\u0026#34; fmt.Println(t) // \u0026#34;int\u0026#34; å› ä¸º reflect.TypeOf è¿”å›çš„æ˜¯ä¸€ä¸ªåŠ¨æ€ç±»å‹çš„æ¥å£å€¼ï¼Œå®ƒæ€»æ˜¯è¿”å›å…·ä½“çš„ç±»å‹ã€‚\n1 2 var w io.Writer = os.Stdout fmt.Println(reflect.TypeOf(w)) // \u0026#34;*os.File\u0026#34; fmt.Printf æä¾›äº†ä¸€ä¸ªç¼©å†™ %T å‚æ•°ï¼Œå†…éƒ¨ä½¿ç”¨ reflect.TypeOf æ¥è¾“å‡º\n1 fmt.Printf(\u0026#34;%T\\n\u0026#34;, 3) // \u0026#34;int\u0026#34; 2.2. ValueOf å’Œ reflect.Type ç±»ä¼¼ï¼Œreflect.Value ä¹Ÿæ»¡è¶³ fmt.Stringer æ¥å£ï¼Œä½†æ˜¯é™¤é Value æŒæœ‰çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¦åˆ™ String æ–¹æ³•åªè¿”å›å…¶ç±»å‹ã€‚è€Œä½¿ç”¨ fmt åŒ…çš„ %v æ ‡å¿—å‚æ•°ä¼šå¯¹ reflect.Values ç‰¹æ®Šå¤„ç†ã€‚\n1 2 3 4 v := reflect.ValueOf(3) // a reflect.Value fmt.Println(v) // \u0026#34;3\u0026#34; fmt.Printf(\u0026#34;%v\\n\u0026#34;, v) // \u0026#34;3\u0026#34; fmt.Println(v.String()) // note :\u0026#34;\u0026lt;int Value\u0026gt;\u0026#34; å¦‚ä½•åˆ¤æ–­ç±»å‹?\n1 2 t := v.Type() // a reflect.Type fmt.Println(t.String()) // \u0026#34;int\u0026#34; å¦‚ä½•è·å–å¯¹è±¡?\nå®ƒè¿”å›ä¸€ä¸ª interface{} ç±»å‹ï¼Œè£…è½½ç€ä¸ reflect.Value ç›¸åŒçš„å…·ä½“å€¼\n1 2 3 4 v := reflect.ValueOf(3) // a reflect.Value x := v.Interface() // an interface{} i := x.(int) // an int fmt.Printf(\u0026#34;%d\\n\u0026#34;, i) // \u0026#34;3\u0026#34; 2.3. ä½¿ç”¨åå°„åˆ¤æ–­ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func formatAtom(v reflect.Value) string { switch v.Kind() { case reflect.Invalid: // ç©ºçš„ reflect.Value çš„ kind å³ä¸º Invalid return \u0026#34;Invalid\u0026#34; case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64: return strconv.FormatInt(v.Int(), 10) case reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64, reflect.Uintptr: return strconv.FormatUint(v.Uint(), 10) case reflect.Bool: return strconv.FormatBool(v.Bool()) case reflect.String: // å°†å­—ç¬¦ä¸² s è½¬æ¢ä¸ºâ€œåŒå¼•å·â€å¼•èµ·æ¥çš„å­—ç¬¦ä¸² return strconv.Quote(v.String()) case reflect.Chan, reflect.Func, reflect.Ptr, reflect.Slice, reflect.Map: return v.Type().String() + \u0026#34; 0x\u0026#34; + strconv.FormatUint(uint64(v.Pointer()), 16) default: return v.Type().String() + \u0026#34; value\u0026#34; } } 2.4. è°ƒç”¨æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 //------------- ä½¿ç”¨åå°„è°ƒç”¨å¯¹è±¡æ–¹æ³• ----------------- type Employee struct { EmployeeID string Name string `format:\u0026#34;normal\u0026#34;` Age int } func (e *Employee)UpdateAge(newVal int ) { e.Age = newVal } type Customer struct { CookieId string Name string Age int } func TestInvokeByName(t *testing.T){ e := \u0026amp;Employee{\u0026#34;1\u0026#34;,\u0026#34;Mike\u0026#34;,30} //t.Log(\u0026#34;Name:value(%[1]v), Type(%[1]T)\u0026#34;,reflect.ValueOf(*e).FieldByName(\u0026#34;Name\u0026#34;), //\treflect.ValueOf(*e).FieldByName(\u0026#34;Age\u0026#34;)) if nameField,ok:=reflect.TypeOf(*e).FieldByName(\u0026#34;name\u0026#34;); ok { t.Error(\u0026#34;Failed to get `name` field.\u0026#34;) }else{ t.Log(\u0026#34;Tag:format\u0026#34;, nameField.Tag.Get(\u0026#34;format\u0026#34;)) } // è°ƒç”¨æ–¹æ³• reflect.ValueOf(e).MethodByName(\u0026#34;UpdateAge\u0026#34;).Call([]reflect.Value{reflect.ValueOf(1)}) t.Log(\u0026#34;update age:\u0026#34;,e) } æ·±åº¦æ¯”è¾ƒ map ä¸èƒ½ç›´æ¥ä½¿ç”¨ç­‰äºæ¯”è¾ƒ, å¯ä»¥ä½¿ç”¨ åå°„çš„ reflect.DeepEqual(s1,s2) è¿›è¡Œæ¯”è¾ƒ, ä¹Ÿé€‚ç”¨äºåˆ‡ç‰‡\n","date":"2019-12-01T15:00:00Z","permalink":"https://blog.golang.space/p/23.%E5%8F%8D%E5%B0%84/","title":"23.åå°„"},{"content":"åŒ…å’Œå·¥å…· æŸ¥çœ‹æ ‡å‡†åŒ…æ•°é‡\n1 go list std | wc -l æ£€ç´¢åŒ…åœ°å€\nå‰è¨€ ç‰¹æ€§ : å¿«\nGoè¯­è¨€çš„é—ªç”µèˆ¬çš„ç¼–è¯‘é€Ÿåº¦ä¸»è¦å¾—ç›Šäºä¸‰ä¸ªè¯­è¨€ç‰¹æ€§ã€‚\nå¯¼åŒ…åœ¨æ–‡ä»¶å¼€å¤´æ˜¾ç¤ºå£°æ˜ ç¦æ­¢åŒ…ç¯è£…ä¾èµ– , å½¢æˆæœ‰å‘æ— ç¯å›¾ è®°å½•åŒ…çš„ä¾èµ–å…³ç³», æ— éœ€éå†æ‰€æœ‰ä¾èµ–æ–‡ä»¶ ( è§£å†³é‡å¤ä¾èµ– ) main åŒ…\nåå­—ä¸ºmainçš„åŒ…æ˜¯ç»™go build æ„å»ºå‘½ä»¤ä¸€ä¸ªä¿¡æ¯ï¼Œè¿™ä¸ªåŒ…ç¼–è¯‘å®Œä¹‹åå¿…é¡»è°ƒç”¨è¿æ¥å™¨ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºã€‚\n_test.go ä¸ºåç¼€çš„åŒ…\n_ å’Œ . å¼€å¤´çš„æºæ–‡ä»¶ä¼šè¢«æ„å»ºå·¥å…·å¿½ç•¥\næ‰€æœ‰ä»¥_testä¸ºåç¼€åŒ…åçš„æµ‹è¯•å¤–éƒ¨æ‰©å±•åŒ…éƒ½ç”±go testå‘½ä»¤ç‹¬ç«‹ç¼–è¯‘\n1. åŒ… 1.1. å¯¼å…¥åŒ… åœ¨åŒ…å£°æ˜è¯­å¥å , æ·»åŠ å¯¼åŒ…å£°æ˜ , å¯ä»¥ä½¿ç”¨åœ†æ‹¬å·åŒæ—¶å¯¼å…¥å¤šä¸ª åŒ…ä¹‹é—´å¯æ·»åŠ ç©ºè¡Œåˆ†ç»„, æ¯ä¸ªåˆ†ç»„çš„å¯¼å…¥é¡ºåºä¼šè¢« gofmt æ ¼å¼åŒ–æˆå­—æ¯é¡ºåº å¾ªç¯ä¾èµ–æ„å»ºå·¥å…·ä¼šæŠ¥é”™ æœ¬åœ°åŒ–å¯¼å…¥\n1 2 import . \u0026#34;strings\u0026#34; Swap(1,3) åˆ«åå¯¼å…¥ ç”¨äºè§£å†³åŒ…é‡å, æˆ–é•¿åŒ…å\n1 2 import st \u0026#34;strings\u0026#34; st.Swap(1,3) åŒ¿åå¯¼å…¥ å®ƒä¼šè®¡ç®—åŒ…çº§å˜é‡çš„åˆå§‹åŒ–è¡¨è¾¾å¼å’Œæ‰§è¡Œå¯¼å…¥åŒ…çš„initåˆå§‹åŒ–å‡½æ•°\n1 import _ \u0026#34;strings\u0026#34; 1.2. åŒ…å åŒ…åä¸€èˆ¬é‡‡ç”¨å•æ•°çš„å½¢å¼ã€‚æ ‡å‡†åº“çš„bytesã€errorså’Œstringsä½¿ç”¨äº†å¤æ•°å½¢å¼ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…å’Œé¢„å®šä¹‰çš„ç±»å‹å†²çªï¼ŒåŒæ ·è¿˜æœ‰go/typesæ˜¯ä¸ºäº†é¿å…å’Œtypeå…³é”®å­—å†²çªã€‚\nå¦‚æœä½ è®¡åˆ’åˆ†äº«æˆ–å‘å¸ƒåŒ…ï¼Œé‚£ä¹ˆå¯¼å…¥è·¯å¾„æœ€å¥½æ˜¯å…¨çƒå”¯ä¸€çš„ã€‚ä¸ºäº†é¿å…å†²çªï¼Œæ‰€æœ‰éæ ‡å‡†åº“åŒ…çš„å¯¼å…¥è·¯å¾„å»ºè®®ä»¥æ‰€åœ¨ç»„ç»‡çš„äº’è”ç½‘åŸŸåä¸ºå‰ç¼€ï¼›è€Œä¸”è¿™æ ·ä¹Ÿæœ‰åˆ©äºåŒ…çš„æ£€ç´¢ã€‚\n1.3. internal å†…éƒ¨åŒ… ä¸€ä¸ªinternalåŒ…åªèƒ½è¢«å’Œinternalç›®å½•æœ‰åŒä¸€ä¸ªçˆ¶ç›®å½•çš„åŒ…æ‰€å¯¼å…¥ã€‚\nä¾‹å¦‚ï¼Œ\n1 2 3 4 5 6 7 net/http/internal/chunked // å¯ä»¥å¯¼å…¥ net/http/httputil net/http // ä¸èƒ½å¯¼å…¥ net/url net/http/internal/chunkedå†…éƒ¨åŒ…åªèƒ½è¢«net/http/httputilæˆ–net/httpåŒ…å¯¼å…¥ï¼Œä½†æ˜¯ä¸èƒ½è¢«net/urlåŒ…å¯¼å…¥ã€‚ä¸è¿‡net/urlåŒ…å´å¯ä»¥å¯¼å…¥net/http/httputilåŒ…ã€‚\n1.4. go list æŸ¥è¯¢åŒ… åˆ—å‡ºå·¥ä½œåŒºæ‰€æœ‰åŒ…\n1 go list ... ç‰¹å®šå­ç›®å½•ä¸‹æ‰€æœ‰åŒ…\n1 go list gopl.io/ch3/... æŸä¸ªä¸»é¢˜ç›¸å…³åŒ…\n1 go list ...xml... åŒ…çš„å…ƒä¿¡æ¯\n1 go list -json hash å‘½ä»¤è¡Œå‚æ•°-fåˆ™å…è®¸ç”¨æˆ·ä½¿ç”¨text/templateåŒ…çš„æ¨¡æ¿è¯­è¨€å®šä¹‰è¾“å‡ºæ–‡æœ¬çš„æ ¼å¼ã€‚\n1 go list -f \u0026#34;{{join .Deps \\\u0026#34; \\\u0026#34;}}\u0026#34; strconv æŸ¥è¯¢å“ªäº› go æºæ–‡ä»¶å‚ä¸ç¼–è¯‘\n1 go list -f={{.GoFiles}} fmt æŸ¥è¯¢å“ªäº› Go æµ‹è¯•æºæ–‡ä»¶å‚ä¸ç¼–è¯‘\n1 go list -f={{.TestGoFiles}} fmt 1.5. å¦‚ä½•ç»™å·²æœ‰çš„åŒ…æ·»åŠ æ–¹æ³•( å®ç°ç»§æ‰¿æƒ³è¦åšçš„äº‹æƒ… ) å®šä¹‰åˆ«å\n1 2 3 4 5 6 // å®šä¹‰åˆ«å type alias []int func (a alias) IsEmpty(){ // ... } ä½¿ç”¨ç»„åˆ å°†å·²æœ‰ç»“æ„ç»„åˆåˆ°æ–°çš„ç»“æ„ä¸­\n1 2 3 4 5 type myFunc struct { myint *[]int } // ... å¯¼åŒ…æ–¹å¼\n1 import . XXX é‚£ä¹ˆå°±ä¼šè®©è¿™ä¸ªâ€œXXXâ€åŒ…ä¸­å…¬å¼€çš„ç¨‹åºå®ä½“ï¼Œè¢«å½“å‰æºç æ–‡ä»¶ä¸­çš„ä»£ç ï¼Œè§†ä¸ºå½“å‰ä»£ç åŒ…ä¸­çš„ç¨‹åºå®ä½“ã€‚\n2. å·¥å…· 1 go help # æŸ¥çœ‹æ›´å¤šå¸®åŠ© 2.1. ä¸‹è½½åŒ… 1 go get ... Goè¯­è¨€å·¥å…·ç®±çš„goå‘½ä»¤åŒæ—¶è®¡ç®—å¹¶ä¸‹è½½æ‰€ä¾èµ–çš„æ¯ä¸ªåŒ…\nä¸€æ—¦go getå‘½ä»¤ä¸‹è½½äº†åŒ…ï¼Œç„¶åå°±æ˜¯å®‰è£…åŒ…æˆ–åŒ…å¯¹åº”çš„å¯æ‰§è¡Œçš„ç¨‹åºã€‚\nå¦‚æœæŒ‡å®š-uå‘½ä»¤è¡Œæ ‡å¿—å‚æ•°ï¼Œgo getå‘½ä»¤å°†ç¡®ä¿æ‰€æœ‰çš„åŒ…å’Œä¾èµ–çš„åŒ…çš„ç‰ˆæœ¬éƒ½æ˜¯æœ€æ–°çš„ï¼Œç„¶åé‡æ–°ç¼–è¯‘å’Œå®‰è£…å®ƒä»¬ã€‚å¦‚æœä¸åŒ…å«è¯¥æ ‡å¿—å‚æ•°çš„è¯ï¼Œè€Œä¸”å¦‚æœåŒ…å·²ç»åœ¨æœ¬åœ°å­˜åœ¨ï¼Œé‚£ä¹ˆä»£ç å°†ä¸ä¼šè¢«è‡ªåŠ¨æ›´æ–°ã€‚\n2.2. æ„å»ºåŒ… go buildå‘½ä»¤ç¼–è¯‘å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šçš„æ¯ä¸ªåŒ…ã€‚å¦‚æœåŒ…æ˜¯ä¸€ä¸ªåº“ï¼Œåˆ™å¿½ç•¥è¾“å‡ºç»“æœï¼›è¿™å¯ä»¥ç”¨äºæ£€æµ‹åŒ…æ˜¯å¯ä»¥æ­£ç¡®ç¼–è¯‘çš„ã€‚å¦‚æœåŒ…çš„åå­—æ˜¯mainï¼Œgo buildå°†è°ƒç”¨é“¾æ¥å™¨åœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼›ä»¥å¯¼å…¥è·¯å¾„çš„æœ€åä¸€æ®µä½œä¸ºå¯æ‰§è¡Œç¨‹åºçš„åå­—ã€‚\né’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿæˆ–CPUçš„äº¤å‰æ„å»ºä¹Ÿæ˜¯å¾ˆç®€å•çš„ã€‚åªéœ€è¦è®¾ç½®å¥½ç›®æ ‡å¯¹åº”çš„GOOSå’ŒGOARCHï¼Œç„¶åè¿è¡Œæ„å»ºå‘½ä»¤å³å¯ã€‚\n1 2 3 4 5 6 # ç¼–è¯‘æˆ linux å¯æ‰§è¡Œ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go # ç¼–è¯‘æˆ Windows å¯æ‰§è¡Œ CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build main.go # ç¼–è¯‘æˆ Mac å¯æ‰§è¡Œ CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build main.go CGO_ENABLED CGO å·¥å…·, äº¤å‰ç¼–è¯‘ä¸èƒ½ä½¿ç”¨\nGOOS : ç›®æ ‡å¹³å°\nmac å¯¹åº” darwin linux å¯¹åº” linux windows å¯¹åº” windows GOARCH ï¼šç›®æ ‡å¹³å°çš„ä½“ç³»æ¶æ„\n386 ä¹Ÿç§° x86 å¯¹åº” 32ä½æ“ä½œç³»ç»Ÿ amd64 ä¹Ÿç§° x64 å¯¹åº” 64ä½æ“ä½œç³»ç»Ÿ arm 2.3. æ³¨é‡Šçš„æŠ€å·§ 1 2 // +build ignore package temp åœ¨ åŒ…å£°æ˜å‰é¢åŠ å…¥æ­¤è¡Œ, è¡¨ç¤ºä¸ç¼–è¯‘è¿™ä¸ªæ–‡ä»¶\n1 // +build linux darwin æ„å»ºè¿‡ç¨‹æ§åˆ¶\n1 go doc go/build # æ›´å¤šæŸ¥çœ‹æ–‡æ¡£ 3. æ–‡æ¡£ å¦‚æœæ³¨é‡Šåç´§è·Ÿç€åŒ…å£°æ˜è¯­å¥ï¼Œé‚£æ³¨é‡Šå¯¹åº”æ•´ä¸ªåŒ…çš„æ–‡æ¡£ã€‚\nGoè¯­è¨€ä¸­çš„æ–‡æ¡£æ³¨é‡Šä¸€èˆ¬æ˜¯å®Œæ•´çš„å¥å­ï¼Œç¬¬ä¸€è¡Œé€šå¸¸æ˜¯æ‘˜è¦è¯´æ˜ï¼Œä»¥è¢«æ³¨é‡Šè€…çš„åå­—å¼€å¤´ã€‚æ³¨é‡Šä¸­å‡½æ•°çš„å‚æ•°æˆ–å…¶å®ƒçš„æ ‡è¯†ç¬¦å¹¶ä¸éœ€è¦é¢å¤–çš„å¼•å·æˆ–å…¶å®ƒæ ‡è®°æ³¨æ˜ã€‚\n3.1. å‘½ä»¤ åœ¨å‘½ä»¤è¡ŒæŸ¥çœ‹\ngo doc åé¢å¯ä»¥è·ŸåŒ…å/æˆå‘˜å/æ–¹æ³•å\n1 2 go doc time go doc time.Since åœ¨ç½‘é¡µæŸ¥çœ‹\n1 2 go get golang.org/x/tools/cmd/godoc # éœ€è¦å…ˆå®‰è£… godoc -http :8080 å®˜æ–¹æ–‡æ¡£åœ°å€\n","date":"2019-11-24T15:00:00Z","permalink":"https://blog.golang.space/p/21.%E5%8C%85%E5%92%8C%E5%B7%A5%E5%85%B7/","title":"21.åŒ…å’Œå·¥å…·"},{"content":"å…±äº«å˜é‡çš„å¹¶å‘ ä¸€ä¸ªå‡½æ•°åœ¨å¹¶å‘è°ƒç”¨æ—¶æ²¡æ³•å·¥ä½œçš„åŸå› å¤ªå¤šäº†ï¼Œæ¯”å¦‚æ­»é”ï¼ˆdeadlockï¼‰ã€æ´»é”ï¼ˆlivelockï¼‰å’Œé¥¿æ­»ï¼ˆresource starvationï¼‰ã€‚æˆ‘ä»¬æ²¡æœ‰ç©ºå»è®¨è®ºæ‰€æœ‰çš„é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬åªèšç„¦åœ¨ç«äº‰æ¡ä»¶ä¸Šã€‚\næ— è®ºä»»ä½•æ—¶å€™ï¼Œåªè¦æœ‰ä¸¤ä¸ª goroutine å¹¶å‘è®¿é—®åŒä¸€å˜é‡ï¼Œä¸”è‡³å°‘å…¶ä¸­çš„ä¸€ä¸ªæ˜¯å†™æ“ä½œçš„æ—¶å€™å°±ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ã€‚\næ•°æ®ç«äº‰ä¼šåœ¨ä¸¤ä¸ªä»¥ä¸Šçš„goroutineå¹¶å‘è®¿é—®ç›¸åŒçš„å˜é‡ä¸”è‡³å°‘å…¶ä¸­ä¸€ä¸ªä¸ºå†™æ“ä½œæ—¶å‘ç”Ÿã€‚æ ¹æ®ä¸Šè¿°å®šä¹‰ï¼Œæœ‰ä¸‰ç§æ–¹å¼å¯ä»¥é¿å…æ•°æ®ç«äº‰:\n1. ä¸è¦å»å†™å˜é‡\nä½¿ç”¨ map åˆ¤æ–­æ˜¯å¦æœ‰æ”¹å˜é‡\n2. é¿å…ä»å¤šä¸ª gorontine è®¿é—®å˜é‡\nä¸è¦ä½¿ç”¨å…±äº«æ•°æ®æ¥é€šä¿¡ï¼›ä½¿ç”¨é€šä¿¡æ¥å…±äº«æ•°æ® , ä»…ä½¿ç”¨ä¸€ä¸ª gorontine è®¿é—®å˜é‡, æä¾›å¯¹ä¸€ä¸ªæŒ‡å®šçš„å˜é‡é€šè¿‡channelæ¥è¯·æ±‚çš„goroutineå«åšè¿™ä¸ªå˜é‡çš„monitorï¼ˆç›‘æ§ï¼‰goroutineã€‚\nä¾‹å¦‚:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package bank import ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;testing\u0026#34; ) var deposits = make(chan int) // æ±‡æ¬¾ var balances = make(chan int) // ä½™é¢ // Deposit å­˜æ¬¾ func Deposit(amount int) { deposits \u0026lt;- amount } // Balance ä½™é¢ func Balance() int { return \u0026lt;-balances } type draw struct { amount int succeed chan bool } var withdraws = make(chan draw) // å–æ¬¾ // Withdraw å–æ¬¾ func Withdraw(amount int) bool { succeed := make(chan bool) withdraws \u0026lt;- draw{amount, succeed} return \u0026lt;-succeed } func teller() { var balance int for { select { case amount := \u0026lt;-deposits: // å­˜æ¬¾ balance += amount case balances \u0026lt;- balance: // ä½™é¢ case draw := \u0026lt;-withdraws: if draw.amount \u0026lt;= balance { balance -= draw.amount draw.succeed \u0026lt;- true } else { draw.succeed \u0026lt;- false } } } } func init() { go teller() } func TestTeller(t *testing.T) { var wg sync.WaitGroup for i := 0; i \u0026lt; 10; i++ { wg.Add(1) go func(i int) { defer wg.Done() Deposit(100 * i) }(i) } for i := 0; i \u0026lt; 4; i++ { wg.Add(1) go func(i int) { defer wg.Done() flag := Withdraw(2000 * i) if !flag { fmt.Println(\u0026#34;ä½™é¢ä¸è¶³\u0026#34;) } }(i) } wg.Wait() fmt.Println(Balance()) fmt.Println(\u0026#34;end\u0026#34;) } // ç»ƒä¹  9.1ï¼š ç»™bank1ç¨‹åºæ·»åŠ ä¸€ä¸ªWithdraw(amount int)å–æ¬¾å‡½æ•°ã€‚å…¶è¿”å›ç»“æœåº”è¯¥è¦è¡¨æ˜äº‹åŠ¡æ˜¯æˆåŠŸäº†è¿˜æ˜¯å› ä¸ºæ²¡æœ‰è¶³å¤Ÿèµ„é‡‘å¤±è´¥äº†ã€‚è¿™æ¡æ¶ˆæ¯ä¼šè¢«å‘é€ç»™monitorçš„goroutineï¼Œä¸”æ¶ˆæ¯éœ€è¦åŒ…å«å–æ¬¾çš„é¢åº¦å’Œä¸€ä¸ªæ–°çš„channelï¼Œè¿™ä¸ªæ–°channelä¼šè¢«monitor goroutineæ¥æŠŠbooleanç»“æœå‘å›ç»™Withdrawã€‚ å³ä½¿å½“ä¸€ä¸ªå˜é‡æ— æ³•åœ¨å…¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…è¢«ç»‘å®šåˆ°ä¸€ä¸ªç‹¬ç«‹çš„goroutineï¼Œç»‘å®šä¾ç„¶æ˜¯å¹¶å‘é—®é¢˜çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚\nä¾‹å¦‚åœ¨ä¸€æ¡æµæ°´çº¿ä¸Šçš„goroutineä¹‹é—´å…±äº«å˜é‡æ˜¯å¾ˆæ™®éçš„è¡Œä¸ºï¼Œåœ¨è¿™ä¸¤è€…é—´ä¼šé€šè¿‡channelæ¥ä¼ è¾“åœ°å€ä¿¡æ¯ã€‚å¦‚æœæµæ°´çº¿çš„æ¯ä¸€ä¸ªé˜¶æ®µéƒ½èƒ½å¤Ÿé¿å…åœ¨å°†å˜é‡ä¼ é€åˆ°ä¸‹ä¸€é˜¶æ®µåå†å»è®¿é—®å®ƒï¼Œé‚£ä¹ˆå¯¹è¿™ä¸ªå˜é‡çš„æ‰€æœ‰è®¿é—®å°±æ˜¯çº¿æ€§çš„ã€‚å…¶æ•ˆæœæ˜¯å˜é‡ä¼šè¢«ç»‘å®šåˆ°æµæ°´çº¿çš„ä¸€ä¸ªé˜¶æ®µï¼Œä¼ é€å®Œä¹‹åè¢«ç»‘å®šåˆ°ä¸‹ä¸€ä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™ç§è§„åˆ™æœ‰æ—¶è¢«ç§°ä¸ºä¸²è¡Œç»‘å®šã€‚\nä¸‹é¢çš„ä¾‹å­ä¸­ï¼ŒCakesä¼šè¢«ä¸¥æ ¼åœ°é¡ºåºè®¿é—®ï¼Œå…ˆæ˜¯baker gorouineï¼Œç„¶åæ˜¯icer gorouineï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type Cake struct{ state string } func baker(cooked chan\u0026lt;- *Cake) { for { cake := new(Cake) cake.state = \u0026#34;cooked\u0026#34; cooked \u0026lt;- cake // baker never touches this cake again } } func icer(iced chan\u0026lt;- *Cake, cooked \u0026lt;-chan *Cake) { for cake := range cooked { cake.state = \u0026#34;iced\u0026#34; iced \u0026lt;- cake // icer never touches this cake again } } 3. äº’æ–¥é” å…è®¸å¾ˆå¤š goruntine è®¿é—®, ä½†æ˜¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè®¿é—®\n3.1. äºŒå…ƒä¿¡å·é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 var ( sema = make(chan struct{}, 1) // äºŒå…ƒä¿¡å·é‡ balance int ) func Deposit(amount int) { sema \u0026lt;- struct{}{} // acquire token balance = balance + amount \u0026lt;-sema // release token } func Balance() int { sema \u0026lt;- struct{}{} // acquire token b := balance \u0026lt;-sema // release token return b } 3.2. sync.Mutex ï¼ˆ1ï¼‰ä½¿ç”¨Lock()åŠ é”ï¼ŒUnlock()è§£é”ï¼›\nï¼ˆ2ï¼‰å¯¹æœªè§£é”çš„ Mutex ä½¿ç”¨ Lock() ä¼šé˜»å¡ï¼›\nï¼ˆ3ï¼‰å¯¹æœªä¸Šé”çš„ Mutex ä½¿ç”¨ Unlock() ä¼šå¯¼è‡´ panic å¼‚å¸¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import \u0026#34;sync\u0026#34; var ( mu sync.Mutex // guards balance balance int ) func Deposit(amount int) { mu.Lock() balance = balance + amount mu.Unlock() } func Balance() int { mu.Lock() b := balance mu.Unlock() return b } deferè°ƒç”¨åªä¼šæ¯”æ˜¾å¼åœ°è°ƒç”¨Unlockæˆæœ¬é«˜é‚£ä¹ˆä¸€ç‚¹ç‚¹ï¼Œä¸è¿‡å´åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¿è¯äº†ä»£ç çš„æ•´æ´æ€§ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹å¯¹äºå¹¶å‘ç¨‹åºæ¥è¯´ï¼Œä»£ç çš„æ•´æ´æ€§æ¯”è¿‡åº¦çš„ä¼˜åŒ–æ›´é‡è¦ã€‚å¦‚æœå¯èƒ½çš„è¯å°½é‡ä½¿ç”¨deferæ¥å°†ä¸´ç•ŒåŒºæ‰©å±•åˆ°å‡½æ•°çš„ç»“æŸã€‚\n1 2 3 4 5 func Balance() int { mu.Lock() defer mu.Unlock() return balance } æ³¨æ„: æ²¡æ³•å¯¹ä¸€ä¸ªå·²ç»é”ä¸Šçš„mutexæ¥å†æ¬¡ä¸Šé”â€”â€”è¿™ä¼šå¯¼è‡´ç¨‹åºæ­»é”ï¼Œæ²¡æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œä¼šæ°¸è¿œé˜»å¡ä¸‹å»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 // âŒ é”™è¯¯ç¤ºä¾‹ // æ­¤å‡½æ•°å¹¶éåŸå­æ“ä½œ,é‡åˆ°å¹¶å‘æ—¶, ä¼šå‡ºç°å¼‚å¸¸ func Withdraw(amount int) bool { // mu.Lock() // defer mu.Unlock() Deposit(-amount) if Balance() \u0026lt; 0 { Deposit(amount) return false // insufficient funds } return true } ä¸€ä¸ªé€šç”¨è§£å†³åŠæ³•æ˜¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // ä¸å®‰å…¨çš„çš„å­˜æ¬¾æ“ä½œ func deposit(amount int) { balance += amount } // å®‰å…¨çš„å­˜æ¬¾æ“ä½œ func Deposit(amount int) { mu.Lock() defer mu.Unlock() deposit(amount) } // å®‰å…¨çš„å–æ¬¾æ“ä½œ func Withdraw(amount int) bool { mu.Lock() defer mu.Unlock() deposit(-amount) if balance \u0026lt; 0 { deposit(amount) return false // insufficient funds } return true } 4. è¯»å†™é” å¤šè¯»å•å†™ ç‰¹ç‚¹ï¼šè¯»å…±äº«ï¼Œå†™ç‹¬å ï¼Œå†™ä¼˜å…ˆ\n1 2 3 4 5 6 7 var mu sync.RWMutex var balance int func Balance() int { mu.RLock() // readers lock defer mu.RUnlock() return balance } 1 2 3 4 5 func (rw *RWMutex) Lock() // é”è¯»å†™ func (rw *RWMutex) RLock()\t// é”å®šä¸ºè¯»å–çŠ¶æ€, ç¦æ­¢å†™å…¥ func (rw *RWMutex) RLocker() Locker // è¿”å›äº’æ–¥é” func (rw *RWMutex) RUnlock()\t// è§£è¯»å†™é” func (rw *RWMutex) Unlock()\t// è§£äº’æ–¥é” ï¼ˆ1ï¼‰RWMutexæ˜¯å•å†™å¤šè¯»é”ï¼Œè¯¥é”å¯ä»¥åŠ å¤šä¸ªè¯»é”æˆ–è€…ä¸€ä¸ªå†™é”ï¼›\nï¼ˆ2ï¼‰è¯»é”å ç”¨çš„æƒ…å†µä¸‹ä¼šé˜»æ­¢å†™ï¼Œä¸ä¼šé˜»æ­¢è¯»ï¼Œå¤šä¸ª goroutine å¯ä»¥åŒæ—¶è·å–è¯»é”ï¼›\nï¼ˆ3ï¼‰å†™é”ä¼šé˜»æ­¢å…¶ä»– goroutineï¼ˆæ— è®ºè¯»å’Œå†™ï¼‰è¿›æ¥ï¼Œæ•´ä¸ªé”ç”±è¯¥ goroutine ç‹¬å ï¼›\nï¼ˆ4ï¼‰é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚\nå†…å­˜åŒæ­¥ è¿™ä¸ªæœ‰ç‚¹å¤æ‚\nç›´æ¥æ€»ç»“\nå¯èƒ½çš„è¯ï¼Œå°†å˜é‡é™å®šåœ¨goroutineå†…éƒ¨ï¼›å¦‚æœæ˜¯å¤šä¸ªgoroutineéƒ½éœ€è¦è®¿é—®çš„å˜é‡ï¼Œä½¿ç”¨äº’æ–¥æ¡ä»¶æ¥è®¿é—®ã€‚\nå› ä¸ºèµ‹å€¼å’Œæ‰“å°æŒ‡å‘ä¸åŒçš„å˜é‡ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šæ–­å®šä¸¤æ¡è¯­å¥çš„é¡ºåºä¸ä¼šå½±å“æ‰§è¡Œç»“æœï¼Œå¹¶ä¸”ä¼šäº¤æ¢ä¸¤ä¸ªè¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚å¦‚æœä¸¤ä¸ªgoroutineåœ¨ä¸åŒçš„CPUä¸Šæ‰§è¡Œï¼Œæ¯ä¸€ä¸ªæ ¸å¿ƒæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œè¿™æ ·ä¸€ä¸ªgoroutineçš„å†™å…¥å¯¹äºå…¶å®ƒgoroutineçš„Printï¼Œåœ¨ä¸»å­˜åŒæ­¥ä¹‹å‰å°±æ˜¯ä¸å¯è§çš„äº†ã€‚\n1 2 3 4 5 var x, y int go func() { x = 1 // A1 fmt.Print(\u0026#34;y:\u0026#34;, y, \u0026#34; \u0026#34;) // A2 }() sync.Once ä»…æ‰§è¡Œä¸€æ¬¡ äº’æ–¥é”çš„å•ä¾‹\n1 2 3 4 5 6 7 8 func Icon(name string) image.Image { mu.Lock() defer mu.Unlock() if icons == nil { loadIcons() } return icons[name] } ä½¿ç”¨äº’æ–¥è®¿é—®iconsçš„ä»£ä»·å°±æ˜¯æ²¡æœ‰åŠæ³•å¯¹è¯¥å˜é‡è¿›è¡Œå¹¶å‘è®¿é—®ï¼Œå³ä½¿å˜é‡å·²ç»è¢«åˆå§‹åŒ–å®Œæ¯•ä¸”å†ä¹Ÿä¸ä¼šè¿›è¡Œå˜åŠ¨ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªå…è®¸å¤šè¯»çš„é”ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 var mu sync.RWMutex // guards icons var icons map[string]image.Image // Concurrency-safe. func Icon(name string) image.Image { mu.RLock() if icons != nil { icon := icons[name] mu.RUnlock() return icon } mu.RUnlock() // acquire an exclusive lock mu.Lock() if icons == nil { // NOTE: must recheck for nil loadIcons() } icon := icons[name] mu.Unlock() return icon } ä¸Šé¢çš„ä»£ç å¤ªå¤æ‚äº†, å†ç®€åŒ–ä¸€ä¸‹\n1 2 3 4 5 6 7 var loadIconsOnce sync.Once var icons map[string]image.Image // Concurrency-safe. func Icon(name string) image.Image { loadIconsOnce.Do(loadIcons) return icons[name] } ç«äº‰æ£€æŸ¥å™¨ åªè¦åœ¨go buildï¼Œgo runæˆ–è€…go testå‘½ä»¤åé¢åŠ ä¸Š-raceçš„flag\nç«äº‰æ£€æŸ¥å™¨ä¼šæ£€æŸ¥è¿™äº›äº‹ä»¶ï¼Œä¼šå¯»æ‰¾åœ¨å“ªä¸€ä¸ªgoroutineä¸­å‡ºç°äº†è¿™æ ·çš„caseï¼Œä¾‹å¦‚å…¶è¯»æˆ–è€…å†™äº†ä¸€ä¸ªå…±äº«å˜é‡ï¼Œè¿™ä¸ªå…±äº«å˜é‡æ˜¯è¢«å¦ä¸€ä¸ªgoroutineåœ¨æ²¡æœ‰è¿›è¡Œå¹²é¢„åŒæ­¥æ“ä½œä¾¿ç›´æ¥å†™å…¥çš„ã€‚\n1 go test -run=TestConcurrent -race -v gopl.io/ch9/memo1 å¹¶å‘çš„éé˜»å¡ç¼“å†² ä¸€ä¸ª http è¯·æ±‚çš„ä¾‹å­ , å‡½æ•°è°ƒç”¨å¼€é”€æ¯”è¾ƒå¤§\n1 2 3 4 5 6 7 8 func httpGetBody(url string) (interface{}, error) { resp, err := http.Get(url) if err != nil { return nil, err } defer resp.Body.Close() return ioutil.ReadAll(resp.Body) } ç¬¬ä¸€ä¸ªç‰ˆæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package memo type Memo struct{ f Func cache map[string]result } type Func func(key string) (interface{},error) type result struct{ value interface{} err error } // æ„é€  func New(f Func) *Memo { return \u0026amp;Memo{ f:f, cache:make(map[string]result) } } // éçº¿ç¨‹å®‰å…¨ func (memo *Memo) Get(key string) (interface{},err){ res, ok := memo.cache[key] if !ok{ res.value,res.err = memo.f(key) memo.cache[key] = res } return res.value,res.err } ç¬¬äºŒä¸ªç‰ˆæœ¬\nå¹¶å‘ã€ä¸é‡å¤ã€æ— é˜»å¡çš„cacheå°±å®Œæˆäº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 type result struct { value interface{} err error } type entry struct{ res reuslt ready chan struct{} // res æ•°æ®å‡†å¤‡å¥½åå…³é—­ } func New(f Func) *Memo { return \u0026amp;Memo{f:f,cache:make(map[string]*entry)} } func Memo struct{ f Func mu sync.Mutex cache map[string]*entry } func (memo *Memo) Get(key string) (value interface{}) { // è·å–äº’æ–¥é”æ¥ä¿æŠ¤å…±äº«å˜é‡cache map memo.mu.lock() e := memo.cache[key] if e==nil{ // æ’å…¥ä¸€ä¸ªæ–°æ¡ç›®ï¼Œé‡Šæ”¾äº’æ–¥é” e = \u0026amp;entry{ready: make(chan struct{})} memo.cache[key] = e memo.mu.Unlock() e.res.value, e.res.err = memo.f(key) close(e.ready) // å–åˆ°å€¼,é€šçŸ¥å…³é—­ }else{ memo.mu.Unlock() \u0026lt;- e.ready // ç­‰å¾…æ‹¿å€¼ } return e.res.value,e.res.err } ç¬¬ä¸‰ä¸ªç‰ˆæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 type request struct { key string response chan\u0026lt;- result // the client wants a single result } type Memo struct{ requests chan request } func New(f Func) *Memo { memo := \u0026amp;Memo{requests: make(chan request)} go memo.server(f) return memo } func (memo *Memo) Get(key string) (interface{}, error) { response := make(chan result) memo.requests \u0026lt;- request{key, response} res := \u0026lt;-response return res.value, res.err } func (memo *Memo) Close() { close(memo.requests) } func (memo *Memo) server(f Func){ cache := make(map[string]*entry) for req := range memo.requests{ e := cache[req.key] if e ==nil{ e = \u0026amp;entry{ready:make(chan struct{})} cache[req.key] = e go e.call(f,req.key) // è·å–æ•°æ® } go e.deliver(req.response) // ç›‘å¬æ•°æ® } } // è·å–æ•°æ® func (e *entry) call(f Func, key string){ e.res.value,e.res.err = f(key) close(e.ready) } // é˜»å¡ç›´åˆ°å…³é—­,ç„¶åè¿”å›ç»“æœ func (e *entry) deliver(response chan\u0026lt;- result){ \u0026lt;-e.ready response \u0026lt;- e.res } Goroutines å’Œçº¿ç¨‹ æ¯ä¸ª os çº¿ç¨‹éƒ½æœ‰å›ºå®šå¤§å°çš„å†…å­˜å—( ä¸€èˆ¬ 2MB ) åšæ ˆ, ç”¨æ¥å­˜å‚¨è°ƒç”¨æˆ–æŒ‚èµ·çš„å‡½æ•°å†…éƒ¨å˜é‡ , è‹¥æ˜¯åˆ›å»ºæˆç™¾ä¸Šåƒéå¸¸æµªè´¹å†…å­˜ç©ºé—´ ;\nè€Œ Goroutine ä¼šä»¥å¾ˆå°çš„æ ˆå¼€å§‹ç”Ÿå‘½å‘¨æœŸ ( ä¸€èˆ¬ 2KB ) , ç©ºé—´æ˜¯åŠ¨æ€ä¼¸ç¼© , æœ€å¤§å€¼å¯è¾¾åˆ° 1GB,\nOS çº¿ç¨‹ä¼šè¢«æ“ä½œç³»ç»Ÿå†…æ ¸è°ƒåº¦ , è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ , å…¶å±€éƒ¨æ€§å¾ˆå·®, éœ€è¦å‡ æ¬¡å†…å­˜è®¿é—®\nè€Œ Go çš„è¿è¡ŒåŒ…å«äº†è‡ªå·±çš„è°ƒåº¦å™¨ , ä½¿ç”¨ M:N , n å’Œ os çº¿ç¨‹æ“ä½œ M ä¸ª goroutine\nGOMAXPROCS ç¯å¢ƒå˜é‡å†³å®šæœ‰å¤šå°‘ä¸ªos çº¿ç¨‹åŒæ—¶æ‰§è¡Œ Go ä»£ç , é»˜è®¤å€¼æ˜¯æœºå™¨ CPU æ ¸å¿ƒæ•° , é˜»å¡/ä¼‘çœ ä¸éœ€è¦å¯¹åº” os çº¿ç¨‹, I/O,ç³»ç»Ÿè°ƒç”¨,é go è¯­è¨€å‡½æ•°éœ€è¦å¯¹åº” OS çº¿ç¨‹, GOMAXPROCS ä¸ä¼šè®¡ç®—è¿™å‡ ç§æƒ…å†µ , è¿è¡Œæ—¶ä½¿ç”¨ runtime.GOMAXPROCS ä¿®æ”¹\n","date":"2019-11-21T18:00:00Z","permalink":"https://blog.golang.space/p/20.%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F%E7%9A%84%E5%B9%B6%E5%8F%91/","title":"20.å…±äº«å˜é‡çš„å¹¶å‘"},{"content":"channels channel æ˜¯ä¸€ä¸ªé€šä¿¡æœºåˆ¶ï¼Œå®ƒå¯ä»¥è®©ä¸€ä¸ª goroutine é€šè¿‡å®ƒç»™å¦ä¸€ä¸ªgoroutine å‘é€å€¼ä¿¡æ¯ã€‚\nchannel æ˜¯çº¿ç¨‹å®‰å…¨çš„, å¤šä¸ªåç¨‹æ“ä½œåŒä¸€ç®¡é“, ä¸ä¼šå‘ç”Ÿèµ„æºäº‰æŠ¢\n[toc]\n1. åŸºç¡€çŸ¥è¯† 1.1. åˆ›å»º channel channel çš„é›¶å€¼ä¹Ÿæ˜¯ nil , å’Œ map ç±»ä¼¼ï¼Œchannel ä¹Ÿå¯¹åº”ä¸€ä¸ªmakeåˆ›å»ºçš„åº•å±‚æ•°æ®ç»“æ„çš„å¼•ç”¨ã€‚å½“æˆ‘ä»¬å¤åˆ¶ä¸€ä¸ª channel æˆ–ç”¨äºå‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼Œæˆ‘ä»¬åªæ˜¯æ‹·è´äº†ä¸€ä¸ª channel å¼•ç”¨ï¼Œå› æ­¤è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…å°†å¼•ç”¨åŒä¸€ä¸ªchannelå¯¹è±¡ã€‚\n1 2 ch := make(chan int) // æ— ç¼“å­˜ ch2 := make(chan int,1) // æœ‰ç¼“å†² 1.2. è¯»å†™æ“ä½œ 1 2 3 ch \u0026lt;- x // å‘é€ x := \u0026lt;-ch // æ¥æ”¶ \u0026lt;-ch // æ¥æ”¶,ä¸¢å¼ƒç»“æœ 1.3. å…³é—­ å…³é—­channelï¼Œéšåå¯¹è¯¥ channel çš„ä»»ä½•å‘é€éƒ½å°†å¯¼è‡´panicå¼‚å¸¸;\nå¯¹ä¸€ä¸ªå·²ç»è¢«closeè¿‡çš„ channel è¿›è¡Œæ¥æ”¶æ“ä½œä¾ç„¶å¯ä»¥æ¥å—åˆ°ä¹‹å‰å·²ç»æˆåŠŸå‘é€çš„æ•°æ®ï¼›å¦‚æœchannelä¸­å·²ç»æ²¡æœ‰æ•°æ®çš„è¯å°†äº§ç”Ÿä¸€ä¸ªé›¶å€¼çš„æ•°æ®ã€‚\n1 2 3 close(ch) result, ok := \u0026lt;- ch ç¬¬äºŒä¸ªç»“æœæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼okï¼Œtureè¡¨ç¤ºæˆåŠŸä»channelsæ¥æ”¶åˆ°å€¼ï¼Œfalseè¡¨ç¤ºchannelså·²ç»è¢«å…³é—­å¹¶ä¸”é‡Œé¢æ²¡æœ‰å€¼å¯æ¥æ”¶ã€‚\nè¯•å›¾é‡å¤å…³é—­ä¸€ä¸ªchannelå°†å¯¼è‡´panicå¼‚å¸¸ï¼Œè¯•å›¾å…³é—­ä¸€ä¸ªnilå€¼çš„channelä¹Ÿå°†å¯¼è‡´panicå¼‚å¸¸ã€‚å…³é—­ä¸€ä¸ªchannelsè¿˜ä¼šè§¦å‘ä¸€ä¸ªå¹¿æ’­æœºåˆ¶;\nä¸ç®¡ä¸€ä¸ªchannelæ˜¯å¦è¢«å…³é—­ï¼Œå½“å®ƒæ²¡æœ‰è¢«å¼•ç”¨æ—¶å°†ä¼šè¢«Goè¯­è¨€çš„åƒåœ¾è‡ªåŠ¨å›æ”¶å™¨å›æ”¶ã€‚\n1.4. æ¯”è¾ƒ ä¸¤ä¸ªç›¸åŒç±»å‹çš„channelå¯ä»¥ä½¿ç”¨ == è¿ç®—ç¬¦æ¯”è¾ƒ\nå¦‚æœä¸¤ä¸ª channel å¼•ç”¨çš„æ˜¯ç›¸åŒçš„å¯¹è±¡ï¼Œé‚£ä¹ˆæ¯”è¾ƒçš„ç»“æœä¸ºçœŸã€‚ä¸€ä¸ª channel ä¹Ÿå¯ä»¥å’Œnilè¿›è¡Œæ¯”è¾ƒã€‚\n1 2 3 4 5 ch := make(chan int) ch1 := make(chan int) ch2 := ch fmt.Printf(\u0026#34;%v\u0026#34; , ch==ch2) // false fmt.Printf(\u0026#34;%v\u0026#34;, ch==ch2) // true å¼•ç”¨ç›¸åŒå¯¹è±¡ 1.5. channel çš„ä¸¤ç§ç±»å‹ æ— ç¼“å­˜\n1 2 3 ch := make(chan int) // æ— ç¼“å­˜ ch1 := make(chan int, 0) // æ— ç¼“å­˜ \u0026lt;-ch // æ¥æ”¶ : é˜»å¡, ä¼šç­‰å¾…å‘é€ 1 ch \u0026lt;- 5 // å‘é€: é˜»å¡, ä¼šç­‰å¾…æ¥æ”¶ Channelsçš„å‘é€æ“ä½œå°†å¯¼è‡´å‘é€è€…goroutineé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ªgoroutineåœ¨ç›¸åŒçš„Channelsä¸Šæ‰§è¡Œæ¥æ”¶æ“ä½œ;\nå½“å‘é€çš„å€¼é€šè¿‡ChannelsæˆåŠŸä¼ è¾“ä¹‹åï¼Œä¸¤ä¸ªgoroutineå¯ä»¥ç»§ç»­æ‰§è¡Œåé¢çš„è¯­å¥ã€‚åä¹‹ï¼Œå¦‚æœæ¥æ”¶æ“ä½œå…ˆå‘ç”Ÿï¼Œé‚£ä¹ˆæ¥æ”¶è€…goroutineä¹Ÿå°†é˜»å¡ï¼Œç›´åˆ°æœ‰å¦ä¸€ä¸ªgoroutineåœ¨ç›¸åŒçš„Channelsä¸Šæ‰§è¡Œå‘é€æ“ä½œã€‚\næœ‰ç¼“å­˜\nå¸¦ç¼“å­˜çš„Channelå†…éƒ¨æŒæœ‰ä¸€ä¸ªå…ƒç´ é˜Ÿåˆ—ã€‚é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡æ˜¯åœ¨è°ƒç”¨makeå‡½æ•°åˆ›å»ºchannelæ—¶é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šçš„ã€‚å‘ç¼“å­˜Channelçš„å‘é€æ“ä½œå°±æ˜¯å‘å†…éƒ¨ç¼“å­˜é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥å…ƒç´ ï¼Œæ¥æ”¶æ“ä½œåˆ™æ˜¯ä»é˜Ÿåˆ—çš„å¤´éƒ¨åˆ é™¤å…ƒç´ ã€‚\n1 2 3 ch := make(chan int, 1) ch1 := make(chan int, 3) ch \u0026lt;- 5 // å‘é€: é˜Ÿåˆ—å·²æ»¡åˆ™é˜»å¡ 1 \u0026lt;-ch // æ¥æ”¶: é˜Ÿåˆ—ä¸ºç©ºåˆ™é˜»å¡ 1.6. å•å‘ channel 1 func foo(ch chan\u0026lt;- int) \u0026lt;-chan int åœ¨è¿™ä¸ªå‡½æ•°ä¸­ , å‚æ•°æ˜¯å•å‘å‘é€channel , è¿”å›å€¼æ˜¯å•å‘æ¥æ”¶channel\nç±»å‹chan\u0026lt;- int è¡¨ç¤ºä¸€ä¸ªåªå‘é€intçš„channelï¼Œåªèƒ½å‘é€ä¸èƒ½æ¥æ”¶\nç±»å‹\u0026lt;-chan intè¡¨ç¤ºä¸€ä¸ªåªæ¥æ”¶intçš„channelï¼Œåªèƒ½æ¥æ”¶ä¸èƒ½å‘é€ã€‚\nä¼šåœ¨ç¼–è¯‘é˜¶æ®µè‡ªåŠ¨è½¬æ¢å•å‘ç±»å‹\næ³¨æ„ : å…³é—­æ“ä½œåªç”¨äºæ–­è¨€ä¸å†å‘channelå‘é€æ–°çš„æ•°æ®ï¼Œæ‰€ä»¥åªæœ‰åœ¨å‘é€è€…æ‰€åœ¨çš„goroutineæ‰ä¼šè°ƒç”¨closeå‡½æ•°ï¼Œå› æ­¤å¯¹ä¸€ä¸ªåªæ¥æ”¶çš„channelè°ƒç”¨closeå°†æ˜¯ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚\n2. ä½¿ç”¨æ¡ˆä¾‹ 2.1. æ¨¡æ‹Ÿé•œåƒç‚¹è¯·æ±‚ , è·å–æœ€å¿«çš„ 1 2 3 4 5 6 7 8 func mirroredQuery() string { responses := make(chan string, 3) go func() { responses \u0026lt;- request(\u0026#34;asia.gopl.io\u0026#34;) }() go func() { responses \u0026lt;- request(\u0026#34;europe.gopl.io\u0026#34;) }() go func() { responses \u0026lt;- request(\u0026#34;americas.gopl.io\u0026#34;) }() return \u0026lt;-responses // return the quickest response } func request(hostname string) (response string) { /* ... */ } 2.2. select å¤šè·¯å¤ç”¨ åœ¨selectè¯­å¥ä¸­æ“ä½œnilçš„channelæ°¸è¿œéƒ½ä¸ä¼šè¢«selectåˆ° å¤šä¸ª case åŒæ—¶å°±ç»ª, select ä¼šéšæœºé€‰æ‹©æ‰§è¡Œ break åªèƒ½è·³å‡º select 1 2 3 4 5 6 7 // å¤–å±‚å¥—ä¸ª for å¾ªç¯, å¯ç”¨äºè½®è¯¢ç›‘å¬ select { case \u0026lt;-abort: fmt.Printf(\u0026#34;Launch aborted!\\n\u0026#34;) default: // do nothing } 2.3. è¶…æ—¶æ§åˆ¶ 1 2 3 4 5 6 select { case \u0026lt;- ch: //... case \u0026lt;- time.After(10*time.Second) // ... } 2.4. for..range\u0026hellip; éå† ä½¿ç”¨range æ¥æ“ä½œchannel , å½“ channel å…³é—­æ—¶, å–å®Œæ‰€æœ‰æ•°æ®è‡ªåŠ¨ç»“æŸå¾ªç¯\n1 2 for ch := range chs { } 2.5. é€šçŸ¥æ‰€æœ‰ goroutine é€€å‡º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // ä»ç»ˆç«¯æ¥æ”¶ä»»æ„é”®ç›˜è¾“å…¥, å…³é—­ channel go func() { os.Stdin.Read(make([]byte, 1)) // read a single byte close(done) }() // è½®è¯¢é€€å‡ºçŠ¶æ€ å·¥å…·å‡½æ•° var done = make(chan struct{}) func cancelled() bool { select { case \u0026lt;-done: return true default: return false } } go func(){ // åœ¨æ‰€æœ‰å‡½æ•°å¤´éƒ¨åšè½®è¯¢åˆ¤æ–­ if cancelled() { return } }() 2.6. å®šæ—¶å™¨ 1 2 3 4 5 6 7 8 9 10 func main() { fmt.Println(\u0026#34;Commencing countdown.\u0026#34;) // å®šæ—¶å™¨ tick := time.Tick(1 * time.Second) for countdown := 10; countdown \u0026gt; 0; countdown-- { fmt.Println(countdown) \u0026lt;-tick launch() } Tickå‡½æ•°æŒºæ–¹ä¾¿ï¼Œä½†æ˜¯åªæœ‰å½“ç¨‹åºæ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½éœ€è¦è¿™ä¸ªæ—¶é—´æ—¶æˆ‘ä»¬ä½¿ç”¨å®ƒæ‰æ¯”è¾ƒåˆé€‚ã€‚å¦åˆ™çš„è¯ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä¸‹é¢çš„è¿™ç§æ¨¡å¼ï¼š\n1 2 3 ticker := time.NewTicker(1 * time.Second) \u0026lt;-ticker.C ticker.Stop() 3. æ³¨æ„é¿å‘ 3.1. goroutine æ³„éœ² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func makeThumbnails4(filenames []string) error { errors := make(chan error) for _, f := range filenames { go func(f string) { _, err := thumbnail.ImageFile(f) errors \u0026lt;- err }(f) } for range filenames { if err := \u0026lt;-errors; err != nil { return err // NOTE: incorrect: goroutine leak! } } return nil } å½“å®ƒé‡åˆ°ç¬¬ä¸€ä¸ªénilçš„erroræ—¶ä¼šç›´æ¥å°†errorè¿”å›åˆ°è°ƒç”¨æ–¹ï¼Œä½¿å¾—æ²¡æœ‰ä¸€ä¸ªgoroutineå»æ’ç©ºerrors channelã€‚è¿™æ ·å‰©ä¸‹çš„worker goroutineåœ¨å‘è¿™ä¸ªchannelä¸­å‘é€å€¼æ—¶ï¼Œéƒ½ä¼šæ°¸è¿œåœ°é˜»å¡ä¸‹å»ï¼Œå¹¶ä¸”æ°¸è¿œéƒ½ä¸ä¼šé€€å‡ºã€‚è¿™ç§æƒ…å†µå«åšgoroutineæ³„éœ²ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªç¨‹åºå¡ä½æˆ–è€…è·‘å‡ºout of memoryçš„é”™è¯¯ã€‚\næœ€ç®€å•çš„è§£å†³åŠæ³•å°±æ˜¯ç”¨ä¸€ä¸ªå…·æœ‰åˆé€‚å¤§å°çš„buffered channelï¼Œè¿™æ ·è¿™äº›worker goroutineå‘channelä¸­å‘é€é”™è¯¯æ—¶å°±ä¸ä¼šè¢«é˜»å¡ã€‚\nsync.WaitGroup\n1 2 3 4 5 var wg sync.WaitGroup wg.Add(1) // åŠ å…¥ wg.Done() // å®Œæˆ wg.Wait() // ç­‰å¾… ç®€å•ä½¿ç”¨å°±æ˜¯åœ¨åˆ›å»ºä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™wg.Add(1), ä»»åŠ¡å®Œæˆçš„æ—¶å€™ä½¿ç”¨wg.Done()æ¥å°†ä»»åŠ¡å‡ä¸€ã€‚ä½¿ç”¨wg.Wait()æ¥é˜»å¡ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func makeThumbnails6(filenames \u0026lt;-chan string) int64 { sizes := make(chan int64) var wg sync.WaitGroup // number of working goroutines for f := range filenames { wg.Add(1) // worker go func(f string) { defer wg.Done() thumb, err := thumbnail.ImageFile(f) if err != nil { log.Println(err) return } info, _ := os.Stat(thumb) // OK to ignore error sizes \u0026lt;- info.Size() }(f) } // closer go func() { wg.Wait() close(sizes) }() var total int64 for size := range sizes { total += size } return total } åˆ¤æ–­ channel æ˜¯å¦å…³é—­\næ¥çœ‹çœ‹æºç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type hchan struct { qcount uint // é˜Ÿåˆ—ä¸­æœ‰å¤šå°‘æ•°æ® dataqsiz uint // ç¯å½¢é˜Ÿåˆ—æœ‰å¤šå¤§ buf unsafe.Pointer // æŒ‡å‘å¤§å°ä¸º dataqsiz çš„æ•°ç»„ elemsize uint16\t// å…ƒç´ å¤§å°\tclosed uint32\t// æ˜¯å¦å…³é—­ elemtype *_type // å‘é€ä»€ä¹ˆç±»å‹ *_type æŒ‡é’ˆæ˜¯è¿è¡Œæ—¶çš„ç±»å‹ç³»ç»Ÿ sendx uint // é˜Ÿåˆ—å¤´, å‘é€ç´¢å¼• recvx uint // é˜Ÿåˆ—å°¾, æ¥å—ç´¢å¼• recvq waitq // recv ç­‰å¾…åˆ—è¡¨ ( \u0026lt;- chan ) sendq waitq // send ç­‰å¾…åˆ—è¡¨ ( ch\u0026lt;- ) // ä¿æŠ¤ hchan æ‰€æœ‰å­—æ®µ,ä»¥åŠåœ¨æ­¤ channel ä¸Šé˜»å¡ sudog çš„ä¸€äº›å­—æ®µ lock mutex } è­¦å‘Š\nå…³é—­ä¸€ä¸ªå·²å…³é—­çš„ channel ä¼šå¯¼è‡´ panic\nå‘å·²ç»å…³é—­çš„ channel å‘é€æ•°æ®ä¼šå¯¼è‡´ panic\nå‘å·²ç»å…³é—­çš„ channel è¯»å–æ•°æ®ä¸ä¼šå¯¼è‡´ panic ï¼Œä½†è¯»å–çš„å€¼ä¸º Channel ç¼“å­˜æ•°æ®çš„é›¶å€¼ï¼Œå¯ä»¥é€šè¿‡æ¥å—è¯­å¥ç¬¬äºŒä¸ªè¿”å›å€¼æ¥æ£€æŸ¥ Channel æ˜¯å¦å…³é—­ï¼š\n1 2 3 4 v, ok := \u0026lt;- ch if !ok { ... // Channel å·²ç»å…³é—­ } ","date":"2019-11-18T11:00:00Z","permalink":"https://blog.golang.space/p/19.channels/","title":"19.Channels"},{"content":"Goroutines ç¬¬ä¸€ä¸ªå°ä¾‹å­\nä¸»å‡½æ•°è¿”å›æ—¶ï¼Œæ‰€æœ‰çš„goroutineéƒ½ä¼šè¢«ç›´æ¥æ‰“æ–­ï¼Œç¨‹åºé€€å‡ºã€‚\né™¤äº†ä»ä¸»å‡½æ•°é€€å‡ºæˆ–è€…ç›´æ¥ç»ˆæ­¢ç¨‹åºä¹‹å¤–ï¼Œæ²¡æœ‰å…¶å®ƒçš„ç¼–ç¨‹æ–¹æ³•èƒ½å¤Ÿè®©ä¸€ä¸ªgoroutineæ¥æ‰“æ–­å¦ä¸€ä¸ªçš„æ‰§è¡Œï¼Œä½†æ˜¯ä¹‹åå¯ä»¥çœ‹åˆ°ä¸€ç§æ–¹å¼æ¥å®ç°è¿™ä¸ªç›®çš„ï¼Œé€šè¿‡goroutineä¹‹é—´çš„é€šä¿¡æ¥è®©ä¸€ä¸ªgoroutineè¯·æ±‚å…¶å®ƒçš„goroutineï¼Œå¹¶è®©è¢«è¯·æ±‚çš„goroutineè‡ªè¡Œç»“æŸæ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;time\u0026#34; ) func main() { go spinner(100 * time.Millisecond) const n = 45 fibN := fib(n) // slow fmt.Printf(\u0026#34;\\rFibonacci(%d) = %d\\n\u0026#34;, n, fibN) } func spinner(delay time.Duration) { for { for _, r := range `-\\|/` { fmt.Printf(\u0026#34;\\r%c\u0026#34;, r) time.Sleep(delay) } } } func fib(x int) int { if x \u0026lt; 2 { return x } return fib(x-1) + fib(x-2) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func T1() { go T2() fmt.Println(\u0026#34;t1\u0026#34;) } func T2() { fmt.Println(\u0026#34;t2\u0026#34;) } func Test1(t *testing.T) { var wg sync.WaitGroup wg.Add(1) go func() { defer wg.Done() T1() }() wg.Wait() fmt.Println(\u0026#34;t3\u0026#34;) } èµ„æºå…±äº«å¹¶å‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func TestCounterThreadSafe2(t *testing.T) { var mut sync.Mutex var wg sync.WaitGroup counter := 0 for i := 0; i \u0026lt; 5000; i++ { wg.Add(1) go func() { mut.Lock() defer wg.Done() defer mut.Unlock() counter++ }() } wg.Wait() t.Logf(\u0026#34;counter = %d\u0026#34;, counter) } å‚æ•°ç«äº‰\nåŒ¿åå‡½æ•°ä¸­çš„å¾ªç¯å˜é‡å¿«ç…§é—®é¢˜ã€‚ä¸Šé¢è¿™ä¸ªå•ç‹¬çš„å˜é‡fæ˜¯è¢«æ‰€æœ‰çš„åŒ¿åå‡½æ•°å€¼æ‰€å…±äº«ï¼Œä¸”ä¼šè¢«è¿ç»­çš„å¾ªç¯è¿­ä»£æ‰€æ›´æ–°çš„ã€‚å½“æ–°çš„goroutineå¼€å§‹æ‰§è¡Œå­—é¢å‡½æ•°æ—¶ï¼Œforå¾ªç¯å¯èƒ½å·²ç»æ›´æ–°äº†få¹¶ä¸”å¼€å§‹äº†å¦ä¸€è½®çš„è¿­ä»£æˆ–è€…ï¼ˆæ›´æœ‰å¯èƒ½çš„ï¼‰å·²ç»ç»“æŸäº†æ•´ä¸ªå¾ªç¯ï¼Œæ‰€ä»¥å½“è¿™äº›goroutineå¼€å§‹è¯»å–fçš„å€¼æ—¶ï¼Œå®ƒä»¬æ‰€çœ‹åˆ°çš„å€¼å·²ç»æ˜¯sliceçš„æœ€åä¸€ä¸ªå…ƒç´ äº†ã€‚æ˜¾å¼åœ°æ·»åŠ è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿ä½¿ç”¨çš„fæ˜¯å½“goè¯­å¥æ‰§è¡Œæ—¶çš„â€œå½“å‰â€é‚£ä¸ªfã€‚\n1 2 3 4 5 6 for _, f := range filenames { go func() { thumbnail.ImageFile(f) // NOTE: incorrect! // ... }() } æ­£ç¡®çš„åšæ³•\n1 2 3 4 5 6 for _, f := range filenames { go func(f string) { thumbnail.ImageFile(f) // NOTE: incorrect! // ... }(f) } GMP è°ƒåº¦å™¨ goroutine åç¨‹ machine æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸»çº¿ç¨‹, ç‰©ç†çº¿ç¨‹ processor å¤„ç†å™¨æŠ½è±¡ï¼Œè´Ÿè´£è¡”æ¥ M å’Œ G çš„è°ƒåº¦ä¸Šä¸‹æ–‡ï¼Œå°†ç­‰å¾…çš„ G å’Œ M å¯¹æ¥ã€‚P å†³å®šäº†å¹¶è¡Œä»»åŠ¡çš„æ•°é‡ï¼Œå¯é€šè¿‡ runtine.GOMAXPROCS æ¥è®¾å®šï¼Œé»˜è®¤è®¾ç½®æ˜¯å¯ç”¨æ ¸å¿ƒæ•°ã€‚ è°ƒåº¦æµç¨‹\ngo func()åˆ›å»º å…¥ å±€éƒ¨é˜Ÿåˆ— å±€éƒ¨å·²å…¥å…¨å±€é˜Ÿåˆ— M è·å– G è‹¥ m1 çš„ P æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºåˆ™ä¸­å…¨å±€è·å– è‹¥ä¸ºç©º, ä»å…¶å®ƒ MP ç»„åˆä¸­å·å– G è°ƒåº¦ æ‰§è¡Œ è‹¥å‘ç”Ÿé˜»å¡ åˆ›å»ºä¸€ä¸ªM æˆ–ä» ä¼‘çœ é˜Ÿåˆ—å–ä¸€ä¸ª æ¥ç®¡å½“å‰æ­£åœ¨é˜»å¡ G çš„P æ—¶é—´ç‰‡è¶…æ—¶è¿”å› å‚è€ƒ Goï¼šg0ï¼Œç‰¹æ®Šçš„ Goroutine\n","date":"2019-11-15T19:00:00Z","permalink":"https://blog.golang.space/p/18.goroutine/","title":"18.Goroutine"},{"content":"æ¥å£ æ¥å£åªæœ‰å½“æœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å…·ä½“ç±»å‹å¿…é¡»ä»¥ç›¸åŒçš„æ–¹å¼è¿›è¡Œå¤„ç†æ—¶æ‰éœ€è¦ã€‚\nå½“ä¸€ä¸ªæ¥å£åªè¢«ä¸€ä¸ªå•ä¸€çš„å…·ä½“ç±»å‹å®ç°æ—¶æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå°±æ˜¯ç”±äºå®ƒçš„ä¾èµ–ï¼Œè¿™ä¸ªå…·ä½“ç±»å‹ä¸èƒ½å’Œè¿™ä¸ªæ¥å£å­˜åœ¨åœ¨ä¸€ä¸ªç›¸åŒçš„åŒ…ä¸­ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ¥å£æ˜¯è§£è€¦è¿™ä¸¤ä¸ªåŒ…çš„ä¸€ä¸ªå¥½æ–¹å¼ã€‚\nä½¿ç”¨ %T æ‰“å°æ¥å£çš„åŠ¨æ€ç±»å‹\n1 2 var w io.Writer fmt.Printf(\u0026#34;%T\\n\u0026#34;, w) // \u0026#34;\u0026lt;nil\u0026gt;\u0026#34; ä¸€ä¸ªä¸åŒ…å«ä»»ä½•å€¼çš„nilæ¥å£å€¼å’Œä¸€ä¸ªåˆšå¥½åŒ…å«nilæŒ‡é’ˆçš„æ¥å£å€¼æ˜¯ä¸åŒçš„ã€‚\nä¸€ä¸ªåŒ…å«nilæŒ‡é’ˆçš„æ¥å£ä¸æ˜¯nilæ¥å£ å®¹æ˜“éš¾åˆ°ç¨‹åºå‘˜çš„é™·é˜±\næ¥å£ç±»å‹åŒ…å« type å’Œ value ä¸¤ä¸ªå‚æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 const debug = true func TestInterface(t *testing.T){ var buf *bytes.Buffer if debug { buf = new(bytes.Buffer) } f(buf) } f(out io.Writer){ // å‡½æ•°è¢«è°ƒç”¨ , out å‚æ•°èµ‹å€¼ä¸€ä¸ªæŒ‡é’ˆ // æ­¤æ—¶ out æ˜¯ä¸ä¸º nil çš„, ä½†å…¶å€¼, æŒ‡é’ˆå¯èƒ½ä¸º nil // æ‰€ä»¥æ°¸è¿œä¸º true if out != nil{ // å¯¹ nilæŒ‡é’ˆè°ƒç”¨æ–¹æ³•,panic å¼‚å¸¸ out.Write([]byte(\u0026#34;done!\\n\u0026#34;)) } } sort æä¾›äº†ä¸€ä¸ªæ’åºæ¥å£\n1 2 3 4 5 6 7 package sort type Interface interface { Len() int\t// é•¿åº¦ Less(i, j int) bool // æ¯”è¾ƒ,i,j æ˜¯åˆ—è¡¨ç´¢å¼• Swap(i, j int)\t// äº¤æ¢ } ä¸ºäº†å¯¹åºåˆ—è¿›è¡Œæ’åºï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå®ç°äº†è¿™ä¸‰ä¸ªæ–¹æ³•çš„ç±»å‹ï¼Œç„¶åå¯¹è¿™ä¸ªç±»å‹çš„ä¸€ä¸ªå®ä¾‹åº”ç”¨sort.Sortå‡½æ•°ã€‚\nå¦‚\n1 2 3 4 5 6 type StringSlice []string func (p StringSlice) Len() int { return len(p) } func (p StringSlice) Less(i, j int) bool { return p[i] \u0026lt; p[j] } func (p StringSlice) Swap(i, j int) { p[i], p[j] = p[j], p[i] } sort.Sort(StringSlice(names)) sortåŒ…æä¾›äº†StringSliceç±»å‹ï¼Œä¹Ÿæä¾›äº†Stringså‡½æ•°èƒ½è®©ä¸Šé¢è¿™äº›è°ƒç”¨ç®€åŒ–æˆsort.Strings(names)ã€‚\nsortå‡½æ•°ä¼šäº¤æ¢å¾ˆå¤šå¯¹å…ƒç´ ï¼Œæ‰€ä»¥å¦‚æœæ¯ä¸ªå…ƒç´ éƒ½æ˜¯æŒ‡é’ˆè€Œä¸æ˜¯Trackç±»å‹ä¼šæ›´å¿«ï¼ŒæŒ‡é’ˆæ˜¯ä¸€ä¸ªæœºå™¨å­—ç é•¿åº¦è€ŒTrackç±»å‹å¯èƒ½æ˜¯å…«ä¸ªæˆ–æ›´å¤šã€‚\nè§£ææ—¶é—´\n1 time.ParseDuration(\u0026#34;3m38s\u0026#34;) text/tabwriteråŒ…æ¥ç”Ÿæˆä¸€ä¸ªåˆ—æ•´é½å¯¹é½å’Œéš”å¼€çš„è¡¨æ ¼\nsort.Reverseå‡½æ•°å€¼å¾—è¿›è¡Œæ›´è¿‘ä¸€æ­¥çš„å­¦ä¹ \n**http.handler ** æ¥å£\n1 2 3 4 5 6 7 package http type Handler interface { ServeHTTP(w ResponseWriter, r *Request) } func ListenAndServe(address string, h Handler) error å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func main() { db := database{\u0026#34;shoes\u0026#34;: 50, \u0026#34;socks\u0026#34;: 5} log.Fatal(http.ListenAndServe(\u0026#34;localhost:8000\u0026#34;, db)) } type dollars float32 func (d dollars) String() string { return fmt.Sprintf(\u0026#34;$%.2f\u0026#34;, d) } type database map[string]dollars func (db database) ServeHTTP(w http.ResponseWriter, req *http.Request) { for item, price := range db { fmt.Fprintf(w, \u0026#34;%s: %s\\n\u0026#34;, item, price) } } è·¯ç”±è¯·æ±‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func (db database) ServeHTTP(w http.ResponseWriter, req *http.Request) { switch req.URL.Path { case \u0026#34;/list\u0026#34;: for item, price := range db { fmt.Fprintf(w, \u0026#34;%s: %s\\n\u0026#34;, item, price) } case \u0026#34;/price\u0026#34;: // è§£æ form å‚æ•° // request.ParseForm() // mobile := request.Form.Get(\u0026#34;mobile\u0026#34;) // è§£æ url ä¸­çš„ query å‚æ•° item := req.URL.Query().Get(\u0026#34;item\u0026#34;) price, ok := db[item] if !ok { w.WriteHeader(http.StatusNotFound) // 404 fmt.Fprintf(w, \u0026#34;no such item: %q\\n\u0026#34;, item) return } fmt.Fprintf(w, \u0026#34;%s\\n\u0026#34;, price) default: // ä¹Ÿå¯ä»¥ä½¿ç”¨ // msg := fmt.Sprintf(\u0026#34;no such page: %s\\n\u0026#34;, req.URL) // http.Error(w, msg, http.StatusNotFound) // 404 w.WriteHeader(http.StatusNotFound) // 404 fmt.Fprintf(w, \u0026#34;no such page: %s\\n\u0026#34;, req.URL) } } net/httpåŒ…æä¾›äº†ä¸€ä¸ªè¯·æ±‚å¤šè·¯å™¨ServeMuxæ¥ç®€åŒ–URLå’Œhandlersçš„è”ç³»ã€‚ä¸€ä¸ªServeMuxå°†ä¸€æ‰¹http.Handlerèšé›†åˆ°ä¸€ä¸ªå•ä¸€çš„http.Handlerä¸­ã€‚\nåœ¨ä¸€ä¸ªé¡¹ç›®æ—©æœŸä½¿ç”¨æ¡†æ¶æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œä½†æ˜¯å®ƒä»¬å¸¦æ¥é¢å¤–çš„å¤æ‚åº¦ä¼šä½¿é•¿æœŸçš„ç»´æŠ¤æ›´åŠ å›°éš¾ã€‚\nç›´æ¥ä½¿ç”¨æ¡†æ¶, ä¹Ÿä¸æ˜“äºåº•å±‚å­¦ä¹ \nServeMux è¯·æ±‚å¤šè·¯å™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func main() { db := database{\u0026#34;shoes\u0026#34;: 50, \u0026#34;socks\u0026#34;: 5} mux := http.NewServeMux() mux.Handle(\u0026#34;/list\u0026#34;, http.HandlerFunc(db.list)) mux.Handle(\u0026#34;/price\u0026#34;, http.HandlerFunc(db.price)) // ç®€åŒ– // mux.HandleFunc(\u0026#34;/list\u0026#34;, db.list) log.Fatal(http.ListenAndServe(\u0026#34;localhost:8000\u0026#34;, mux)) } type database map[string]dollars func (db database) list(w http.ResponseWriter, req *http.Request) { for item, price := range db { fmt.Fprintf(w, \u0026#34;%s: %s\\n\u0026#34;, item, price) } } func (db database) price(w http.ResponseWriter, req *http.Request) { item := req.URL.Query().Get(\u0026#34;item\u0026#34;) price, ok := db[item] if !ok { w.WriteHeader(http.StatusNotFound) // 404 fmt.Fprintf(w, \u0026#34;no such item: %q\\n\u0026#34;, item) return } fmt.Fprintf(w, \u0026#34;%s\\n\u0026#34;, price) } net/httpåŒ…æä¾›äº†ä¸€ä¸ªå…¨å±€çš„ServeMuxå®ä¾‹DefaultServerMuxå’ŒåŒ…çº§åˆ«çš„http.Handleå’Œhttp.HandleFuncå‡½æ•°ã€‚\n1 2 3 4 5 6 func main() { db := database{\u0026#34;shoes\u0026#34;: 50, \u0026#34;socks\u0026#34;: 5} http.HandleFunc(\u0026#34;/list\u0026#34;, db.list) http.HandleFunc(\u0026#34;/price\u0026#34;, db.price) log.Fatal(http.ListenAndServe(\u0026#34;localhost:8000\u0026#34;, nil)) } webæœåŠ¡å™¨åœ¨ä¸€ä¸ªæ–°çš„åç¨‹ä¸­è°ƒç”¨æ¯ä¸€ä¸ªhandlerï¼Œæ‰€ä»¥å½“handlerè·å–å…¶å®ƒåç¨‹æˆ–è€…è¿™ä¸ªhandleræœ¬èº«çš„å…¶å®ƒè¯·æ±‚ä¹Ÿå¯ä»¥è®¿é—®åˆ°å˜é‡æ—¶ï¼Œä¸€å®šè¦ä½¿ç”¨é¢„é˜²æªæ–½ï¼Œæ¯”å¦‚é”æœºåˆ¶ã€‚\nerror æ¥å£\n1 2 3 4 5 6 7 package errors func New(text string) error { return \u0026amp;errorString{text} } type errorString struct { text string } func (e *errorString) Error() string { return e.text } **ç±»å‹æ–­è¨€ ** x.(T)\nå…·ä½“ç±»å‹çš„ç±»å‹æ–­è¨€ä»å®ƒçš„æ“ä½œå¯¹è±¡ä¸­è·å¾—å…·ä½“çš„å€¼ã€‚å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œæ¥ä¸‹æ¥è¿™ä¸ªæ“ä½œä¼šæŠ›å‡ºpanic\nç¬¬äºŒä¸ªç»“æœè¡¨ç¤ºæ˜¯å¦æ–­è¨€æˆåŠŸ\n1 2 3 var w io.Writer = os.Stdout f, ok := w.(*os.File) // success: ok, f == os.Stdout b, ok := w.(*bytes.Buffer) // failure: !ok, b == nil å¸¸å¸¸ä¸ä¼šæ–°å£°æ˜ä¸€ä¸ªå…¶ä»–åå­—çš„å˜é‡, è€Œæ˜¯\n1 2 3 4 // è¿™é‡Œå¹¶æ²¡æœ‰å¯¹ w é‡æ–°èµ‹å€¼, è€Œæ˜¯åˆ›å»ºä¸€ä¸ªå±€éƒ¨ w å˜é‡ if w, ok := w.(*os.File); ok { // ...use w... } i/o æœ‰ä¸‰ç§ç»å¸¸å‡ºç°çš„é”™è¯¯, os åŒ…æä¾›äº†ä¸‰ä¸ªå¸®åŠ©å‡½æ•°\n1 2 3 func IsExist(err error) bool // æ–‡ä»¶æ˜¯å¦å­˜åœ¨ func IsNotExist(err error) bool\t// æ–‡ä»¶ä¸å­˜åœ¨ func IsPermission(err error) bool // æƒé™æ‹’ç» ä¸€ä¸ªæ›´å¯é çš„æ–¹å¼æ˜¯ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„ç±»å‹æ¥æè¿°ç»“æ„åŒ–çš„é”™è¯¯ã€‚osåŒ…ä¸­å®šä¹‰äº†ä¸€ä¸ªPathErrorç±»å‹æ¥æè¿°åœ¨æ–‡ä»¶è·¯å¾„æ“ä½œä¸­æ¶‰åŠåˆ°çš„å¤±è´¥ï¼ŒåƒOpenæˆ–è€…Deleteæ“ä½œï¼›å¹¶ä¸”å®šä¹‰äº†ä¸€ä¸ªå«LinkErrorçš„å˜ä½“æ¥æè¿°æ¶‰åŠåˆ°ä¸¤ä¸ªæ–‡ä»¶è·¯å¾„çš„æ“ä½œï¼ŒåƒSymlinkå’ŒRenameã€‚è¿™ä¸‹é¢æ˜¯os.PathErrorï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 package os // PathError records an error and the operation and file path that caused it. type PathError struct { Op string Path string Err error } func (e *PathError) Error() string { return e.Op + \u0026#34; \u0026#34; + e.Path + \u0026#34;: \u0026#34; + e.Err.Error() } é”™è¯¯å¦‚ä¸‹\n1 2 3 4 5 _, err := os.Open(\u0026#34;/no/such/file\u0026#34;) fmt.Println(err) // \u0026#34;open /no/such/file: No such file or directory\u0026#34; fmt.Printf(\u0026#34;%#v\\n\u0026#34;, err) // Output: // \u0026amp;os.PathError{Op:\u0026#34;open\u0026#34;, Path:\u0026#34;/no/such/file\u0026#34;, Err:0x2} é€šè¿‡ç±»å‹æ–­è¨€é€‰æ‹©è¡Œä¸º\nåœ¨å‡½æ•°ä¸­å®šä¹‰æ¥å£ , åˆ¤æ–­ä¼ å…¥çš„å‚æ•°æ˜¯å¦å®ç°äº†è¯¥æ¥å£\næ ‡å‡†åº“ä¸­ io.WriteString å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // writeString writes s to w. // If w has a WriteString method, it is invoked instead of w.Write. func writeString(w io.Writer, s string) (n int, err error) { type stringWriter interface { WriteString(string) (n int, err error) } if sw, ok := w.(stringWriter); ok { return sw.WriteString(s) // avoid a copy } return w.Write([]byte(s)) // allocate temporary copy } func writeHeader(w io.Writer, contentType string) error { if _, err := writeString(w, \u0026#34;Content-Type: \u0026#34;); err != nil { return err } if _, err := writeString(w, contentType); err != nil { return err } // ... } switch è¿˜å¯ä»¥è¿™æ ·æ“ä½œ\n1 switch x := x.(type) { /* ... */ } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func sqlQuote(x interface{}) string { switch x := x.(type) { case nil: return \u0026#34;NULL\u0026#34; case int, uint: return fmt.Sprintf(\u0026#34;%d\u0026#34;, x) // x has type interface{} here. case bool: if x { return \u0026#34;TRUE\u0026#34; } return \u0026#34;FALSE\u0026#34; case string: return sqlQuoteString(x) // (not shown) default: panic(fmt.Sprintf(\u0026#34;unexpected type %T: %v\u0026#34;, x, x)) } } ","date":"2019-11-12T16:00:00Z","permalink":"https://blog.golang.space/p/17.%E6%8E%A5%E5%8F%A3/","title":"17.æ¥å£"},{"content":"è·Ÿç»“æ„ä½“ç»‘å®šçš„å‡½æ•°, ç§°ä¸ºæ–¹æ³•\n1 2 3 4 type fire struct{} func (f fire) Play(){ } Java ä¸­å¯¹è±¡é‡Œä½¿ç”¨ this , python å¯¹è±¡é‡Œä½¿ç”¨ self , è€Œ golang å»ºè®®å¯ä»¥ä½¿ç”¨å…¶ç±»å‹çš„ç¬¬ä¸€ä¸ªå­—æ¯ï¼Œæ¯”å¦‚è¿™é‡Œä½¿ç”¨äº†Pointçš„é¦–å­—æ¯pã€‚å¯ä»¥ä»»æ„é€‰æ‹©å˜é‡å\næ–¹æ³•ä¸èƒ½ä¸ç»“æ„ä½“çš„å±æ€§é‡å, ç¼–è¯‘å™¨ä¼šæŠ¥é”™\nå½“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä¼šå¯¹å…¶æ¯ä¸€ä¸ªå‚æ•°å€¼è¿›è¡Œæ‹·è´ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°éœ€è¦æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œæˆ–è€…å‡½æ•°çš„å…¶ä¸­ä¸€ä¸ªå‚æ•°å®åœ¨å¤ªå¤§æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿé¿å…è¿›è¡Œè¿™ç§é»˜è®¤çš„æ‹·è´ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°æŒ‡é’ˆäº†ã€‚å¯¹åº”åˆ°æˆ‘ä»¬è¿™é‡Œç”¨æ¥æ›´æ–°æ¥æ”¶å™¨çš„å¯¹è±¡çš„æ–¹æ³•ï¼Œå½“è¿™ä¸ªæ¥å—è€…å˜é‡æœ¬èº«æ¯”è¾ƒå¤§æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å…¶æŒ‡é’ˆè€Œä¸æ˜¯å¯¹è±¡æ¥å£°æ˜æ–¹æ³•\n1 2 3 4 func (p *Point) ScaleBy(factor float64) { p.X *= factor p.Y *= factor } åœ¨ç°å®çš„ç¨‹åºé‡Œï¼Œä¸€èˆ¬ä¼šçº¦å®šå¦‚æœPointè¿™ä¸ªç±»æœ‰ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºæ¥æ”¶å™¨çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ‰€æœ‰Pointçš„æ–¹æ³•éƒ½å¿…é¡»æœ‰ä¸€ä¸ªæŒ‡é’ˆæ¥æ”¶å™¨,å³ä½¿æ˜¯é‚£äº›å¹¶ä¸éœ€è¦è¿™ä¸ªæŒ‡é’ˆæ¥æ”¶å™¨çš„å‡½æ•°ã€‚\nåœ¨å£°æ˜æ–¹æ³•æ—¶ï¼Œå¦‚æœä¸€ä¸ªç±»å‹åæœ¬èº«æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„è¯ï¼Œæ˜¯ä¸å…è®¸å…¶å‡ºç°åœ¨æ¥æ”¶å™¨ä¸­çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\n1 2 type P *int func (P) f() { /* ... */ } // compile error: invalid receiver type å¦‚æœæ–¹æ³•ä½¿ç”¨æŒ‡é’ˆä½œä¸ºæ¥æ”¶å™¨, é‚£ä¹ˆè¦æä¾›ä¸€ä¸ªè¯¥ç±»å‹çš„æŒ‡é’ˆè¿›è¡Œè°ƒç”¨æ–¹æ³•, å¹¸è¿çš„æ˜¯ , å¦‚æœæ¥æ”¶å™¨ p æ˜¯point ç±»å‹å˜é‡ , ç¼–è¯‘å™¨ä¼šéšå¼çš„ç”¨ \u0026amp;p.ScaleBy(2) æ–¹å¼è°ƒç”¨, å¦‚æœæ¥æ”¶å™¨ p æ˜¯å˜é‡, æ–¹æ³•çš„æ¥æ”¶å™¨æ˜¯æŒ‡é’ˆ, åˆ™ä¼šéšå¼çš„ç”¨ *p å»è°ƒç”¨\n1 p.ScaleBy(2) æˆ‘ä»¬ä¸èƒ½é€šè¿‡ä¸€ä¸ªæ— æ³•å–åˆ°åœ°å€çš„æ¥æ”¶å™¨æ¥è°ƒç”¨æŒ‡é’ˆæ–¹æ³•ï¼Œæ¯”å¦‚ä¸´æ—¶å˜é‡çš„å†…å­˜åœ°å€å°±æ— æ³•è·å–å¾—åˆ°\n1 Point{1, 2}.ScaleBy(2) // ç¼–è¯‘é”™è¯¯ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª*Pointè¿™æ ·çš„æ¥æ”¶å™¨æ¥è°ƒç”¨Pointçš„æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ°å€æ¥æ‰¾åˆ°è¿™ä¸ªå˜é‡ï¼Œåªè¦ç”¨è§£å¼•ç”¨ç¬¦å·*æ¥å–åˆ°è¯¥å˜é‡å³å¯ã€‚ç¼–è¯‘å™¨åœ¨è¿™é‡Œä¹Ÿä¼šç»™æˆ‘ä»¬éšå¼åœ°æ’å…¥*è¿™ä¸ªæ“ä½œç¬¦ï¼Œæ‰€ä»¥ä¸‹é¢è¿™ä¸¤ç§å†™æ³•ç­‰ä»·çš„ï¼š\n1 2 pptr.Distance(q) (*pptr).Distance(q) å£°æ˜ method æ—¶, å¦‚ä½•é€‰æ‹©ä½¿ç”¨ å€¼ç±»å‹è¿˜æ˜¯æŒ‡é’ˆç±»å‹çš„receiver , éœ€è¦è€ƒè™‘æ”¹å˜é‡çš„å¤§å°, ä½¿ç”¨å€¼ç±»å‹ä¼šæ‹·è´å¯¹è±¡ , å˜é‡è¿‡å¤§æ—¶ä¼šå ç”¨è¾ƒå¤šå†…å­˜ , ä½¿ç”¨æŒ‡é’ˆç±»å‹å¯ä»¥ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡\nnil æ˜¯åˆæ³•çš„æ¥æ”¶å™¨ç±»å‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 // An IntList is a linked list of integers. // A nil *IntList represents the empty list. type IntList struct { Value int Tail *IntList } // Sum returns the sum of the list elements. func (list *IntList) Sum() int { if list == nil { return 0 } return list.Value + list.Tail.Sum() } ç”±äºurl.Valuesæ˜¯ä¸€ä¸ªmapç±»å‹ï¼Œå¹¶ä¸”é—´æ¥å¼•ç”¨äº†å…¶key/valueå¯¹ï¼Œå› æ­¤url.Values.Addå¯¹è¿™ä¸ªmapé‡Œçš„å…ƒç´ åšä»»ä½•çš„æ›´æ–°ã€åˆ é™¤æ“ä½œå¯¹è°ƒç”¨æ–¹éƒ½æ˜¯å¯è§çš„ã€‚\nå®é™…ä¸Šï¼Œå°±åƒåœ¨æ™®é€šå‡½æ•°ä¸­ä¸€æ ·ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡å¼•ç”¨æ¥æ“ä½œå†…éƒ¨å€¼ï¼Œä½†åœ¨æ–¹æ³•æƒ³è¦ä¿®æ”¹å¼•ç”¨æœ¬èº«æ—¶æ˜¯ä¸ä¼šå½±å“åŸå§‹å€¼çš„ï¼Œæ¯”å¦‚æŠŠä»–ç½®æ¢ä¸ºnilï¼Œæˆ–è€…è®©è¿™ä¸ªå¼•ç”¨æŒ‡å‘äº†å…¶å®ƒçš„å¯¹è±¡ï¼Œè°ƒç”¨æ–¹éƒ½ä¸ä¼šå—å½±å“ã€‚\næ³¨æ„, è¿™é‡ŒæŒ‡çš„æ˜¯ä¿®æ”¹å¼•ç”¨æœ¬èº«, è€Œéå¼•ç”¨æŒ‡å‘çš„åœ°å€\n1 2 var kit *int func (k *kit) reset(){ k=nil} // é€‰æ‹©å™¨æ˜¯å€¼æ‹·è´,ä¸å½±å“å¯¹è±¡æœ¬èº« åµŒå…¥ç»“æ„ä½“ , åŒ¿åå±æ€§\n1 2 3 4 5 6 type Point struct{ X, Y float64 } type ColoredPoint struct { Point Color color.RGBA } å¯¹äºPointä¸­çš„æ–¹æ³•æˆ‘ä»¬ä¹Ÿæœ‰ç±»ä¼¼çš„ç”¨æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠColoredPointç±»å‹å½“ä½œæ¥æ”¶å™¨æ¥è°ƒç”¨Pointé‡Œçš„æ–¹æ³•ï¼Œå³ä½¿ColoredPointé‡Œæ²¡æœ‰å£°æ˜è¿™äº›æ–¹æ³•,å½“ç„¶äº†ï¼Œåœ¨Pointç±»çš„æ–¹æ³•é‡Œï¼Œä½ æ˜¯è®¿é—®ä¸åˆ°ColoredPointçš„ä»»ä½•å­—æ®µçš„ã€‚\nå°æŠ€å·§\nå°†åŒ…çº§åˆ«å˜é‡, syncå’Œ mapping æ”¾åˆ°struct å†…\n1 2 3 4 5 6 var cache = struct { sync.Mutex // name Mutex mapping map[string]string\t// name Mapping }{ mapping: make(map[string]string), } **æ–¹æ³•å€¼ä¸å»¶æ—¶æ‰§è¡Œ **AfterFunc\n1 2 3 4 type Rocket struct { /* ... */ } func (r *Rocket) Launch() { /* ... */ } r := new(Rocket) time.AfterFunc(10 * time.Second, func() { r.Launch() }) ç›´æ¥ç”¨ æ–¹æ³•\u0026quot;å€¼\u0026quot;ä¼ å…¥ , çœæ‰äº†ä¸Šé¢ä¾‹å­é‡Œçš„åŒ¿åå‡½æ•°ã€‚\n1 time.AfterFunc(10 * time.Second, r.Launch) æ–¹æ³•è¡¨è¾¾å¼\nå½“Tæ˜¯ä¸€ä¸ªç±»å‹æ—¶ï¼Œæ–¹æ³•è¡¨è¾¾å¼å¯èƒ½ä¼šå†™ä½œT.fæˆ–è€…(*T).fï¼Œä¼šè¿”å›ä¸€ä¸ªå‡½æ•°â€œå€¼â€ï¼Œè¿™ç§å‡½æ•°ä¼šå°†å…¶ç¬¬ä¸€ä¸ªå‚æ•°ç”¨ä½œæ¥æ”¶å™¨ï¼Œæ‰€ä»¥å¯ä»¥ç”¨é€šå¸¸ï¼ˆè¯‘æ³¨ï¼šä¸å†™é€‰æ‹©å™¨ï¼‰çš„æ–¹å¼æ¥å¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 p := Point{1, 2} q := Point{4, 6} distance := Point.Distance // method expression fmt.Println(distance(p, q)) // \u0026#34;5\u0026#34; fmt.Printf(\u0026#34;%T\\n\u0026#34;, distance) // \u0026#34;func(Point, Point) float64\u0026#34; scale := (*Point).ScaleBy scale(\u0026amp;p, 2) fmt.Println(p) // \u0026#34;{2 4}\u0026#34; fmt.Printf(\u0026#34;%T\\n\u0026#34;, scale) // \u0026#34;func(*Point, float64)\u0026#34; å½“ä½ æ ¹æ®ä¸€ä¸ªå˜é‡æ¥å†³å®šè°ƒç”¨åŒä¸€ä¸ªç±»å‹çš„å“ªä¸ªå‡½æ•°æ—¶ï¼Œæ–¹æ³•è¡¨è¾¾å¼å°±æ˜¾å¾—å¾ˆæœ‰ç”¨äº†ã€‚ä½ å¯ä»¥æ ¹æ®é€‰æ‹©æ¥è°ƒç”¨æ¥æ”¶å™¨å„ä¸ç›¸åŒçš„æ–¹æ³•ã€‚\nç¤ºä¾‹ set\nGoè¯­è¨€é‡Œçš„ set ä¸€èˆ¬ä¼šç”¨map[T]boolè¿™ç§å½¢å¼æ¥è¡¨ç¤º , ç”¨mapç±»å‹æ¥è¡¨ç¤ºè™½ç„¶éå¸¸çµæ´»ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä»¥ä¸€ç§æ›´å¥½çš„å½¢å¼æ¥è¡¨ç¤ºå®ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // An IntSet is a set of small non-negative integers. // Its zero value represents the empty set. type IntSet struct { words []uint64 } //\tset ä¸­æ˜¯å¦åŒ…å« x func (s *IntSet) Has(x int) bool { word, bit := x/64, uint(x%64) return word \u0026lt; len(s.words) \u0026amp;\u0026amp; s.words[word]\u0026amp;(1\u0026lt;\u0026lt;bit) != 0 } // å°† x æ·»åŠ åˆ° set func (s *IntSet) Add(x int) { // æ¯ä¸€ä¸ªå­—éƒ½æœ‰64ä¸ªäºŒè¿›åˆ¶ä½,ç”¨ x/64çš„å•†ä½œä¸ºå­—çš„ä¸‹æ ‡ // ç”¨x%64å¾—åˆ°çš„å€¼ä½œä¸ºè¿™ä¸ªå­—å†…çš„bitçš„æ‰€åœ¨ä½ç½® word, bit := x/64, uint(x%64) for word \u0026gt;= len(s.words) { s.words = append(s.words, 0) } s.words[word] |= 1 \u0026lt;\u0026lt; bit } // UnionWith sets s to the union of s and t. func (s *IntSet) UnionWith(t *IntSet) { for i, tword := range t.words { if i \u0026lt; len(s.words) { s.words[i] |= tword } else { s.words = append(s.words, tword) } } } x çš„ string æ–¹æ³•é€‰æ‹©å™¨æ˜¯æŒ‡é’ˆ , ç¬¬ä¸€ä¸ªå–å€æ‰“å°æ­£å¸¸ ç¬¬äºŒä¸ªç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åŠ ä¸Š \u0026amp;x.string() ç¬¬ä¸‰ä¸ªæ˜¯å¯¹è±¡, æ²¡æœ‰ç»‘å®šè¦ string æ–¹æ³•, 1 2 3 fmt.Println(\u0026amp;x) // \u0026#34;{1 9 42 144}\u0026#34; fmt.Println(x.String()) // \u0026#34;{1 9 42 144}\u0026#34; fmt.Println(x) // \u0026#34;{[4398046511618 0 65536]}\u0026#34; ","date":"2019-11-09T11:00:00Z","permalink":"https://blog.golang.space/p/16.%E6%96%B9%E6%B3%95/","title":"16.æ–¹æ³•"},{"content":"recover ä»…åœ¨ defer è°ƒç”¨ä¸­ä½¿ç”¨ è·å– panic çš„ å€¼ å¦‚æœæ— æ³•å¤„ç†, å¯é‡æ–° panic é€šå¸¸æ¥è¯´ï¼Œä¸åº”è¯¥å¯¹panicå¼‚å¸¸åšä»»ä½•å¤„ç†ï¼Œä½†æœ‰æ—¶ï¼Œä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥ä»å¼‚å¸¸ä¸­æ¢å¤ï¼Œè‡³å°‘æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºå´©æºƒå‰ï¼Œåšä¸€äº›æ“ä½œã€‚\nåœ¨æœªå‘ç”Ÿpanicæ—¶è°ƒç”¨recoverï¼Œrecoverä¼šè¿”å›nilã€‚\nä¸åŠ åŒºåˆ†çš„æ¢å¤æ‰€æœ‰çš„panicå¼‚å¸¸ï¼Œä¸æ˜¯å¯å–çš„åšæ³•ï¼›è™½ç„¶æŠŠå¯¹panicçš„å¤„ç†éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåŒ…ä¸‹ï¼Œæœ‰åŠ©äºç®€åŒ–å¯¹å¤æ‚å’Œä¸å¯ä»¥é¢„æ–™é—®é¢˜çš„å¤„ç†ï¼Œä½†ä½œä¸ºè¢«å¹¿æ³›éµå®ˆçš„è§„èŒƒï¼Œä½ ä¸åº”è¯¥è¯•å›¾å»æ¢å¤å…¶ä»–åŒ…å¼•èµ·çš„panicã€‚\n1 2 3 4 5 6 7 8 9 defer func() { switch p := recover(); p { case nil: // æ²¡æœ‰å¼‚å¸¸ case bailout{}: // å‘ç°å¼‚å¸¸ err = fmt.Errorf(\u0026#34;multiple title elements\u0026#34;) default: panic(p) //æœªçŸ¥å¼‚å¸¸ } }() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func tryRecover(){ defer func(){ r := recover() if err,ok := r.(error); ok { fmt.Println(\u0026#34;error occurred:\u0026#34;,err) }else{ panic(r) } }() panic(errors.New(\u0026#34;this is an error\u0026#34;)) } func main(){ tryRecover() } ","date":"2019-11-08T18:00:00Z","permalink":"https://blog.golang.space/p/15.recover/","title":"15.recover"},{"content":"panic ç”¨äºä¸å¯ç”¨æ¢å¤çš„ä¸¥é‡é”™è¯¯\npanic é€€å‡ºå‰ä¼šæ‰§è¡Œ defer æŒ‡å®šå†…å®¹\nå½“panicå¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œç¨‹åºä¼šä¸­æ–­è¿è¡Œï¼Œå¹¶ç«‹å³æ‰§è¡Œåœ¨è¯¥goroutineä¸­è¢«å»¶è¿Ÿçš„å‡½æ•°ï¼ˆdefer æœºåˆ¶ï¼‰, éšåï¼Œç¨‹åºå´©æºƒå¹¶è¾“å‡ºæ—¥å¿—ä¿¡æ¯ã€‚\nè€ƒè™‘regexp.Compileå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆæœ‰æ•ˆçš„å¯åŒ¹é…æ ¼å¼ã€‚å½“è¾“å…¥çš„æ­£åˆ™è¡¨è¾¾å¼ä¸åˆæ³•æ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚å½“è°ƒç”¨è€…æ˜ç¡®çš„çŸ¥é“æ­£ç¡®çš„è¾“å…¥ä¸ä¼šå¼•èµ·å‡½æ•°é”™è¯¯æ—¶ï¼Œè¦æ±‚è°ƒç”¨è€…æ£€æŸ¥è¿™ä¸ªé”™è¯¯æ˜¯ä¸å¿…è¦å’Œç´¯èµ˜çš„ã€‚æˆ‘ä»¬åº”è¯¥å‡è®¾å‡½æ•°çš„è¾“å…¥ä¸€ç›´åˆæ³•ï¼Œå°±å¦‚å‰é¢çš„æ–­è¨€ä¸€æ ·ï¼šå½“è°ƒç”¨è€…è¾“å…¥äº†ä¸åº”è¯¥å‡ºç°çš„è¾“å…¥æ—¶ï¼Œè§¦å‘panicå¼‚å¸¸ã€‚\nè¾“å‡ºå †æ ˆä¿¡æ¯\n1 2 3 4 5 6 7 8 9 func main() { defer printStack() f(3) } func printStack() { var buf [4096]byte n := runtime.Stack(buf[:], false) os.Stdout.Write(buf[:n]) } æ­£åˆ™\nregexp.MustCompile æ£€æŸ¥è¾“å…¥çš„åˆæ³•æ€§\n1 var httpSchemeRE = regexp.MustCompile(`^https?:`) //\u0026#34;http:\u0026#34; or \u0026#34;https:\u0026#34; ","date":"2019-11-07T18:00:00Z","permalink":"https://blog.golang.space/p/14.panic/","title":"14.panic"},{"content":"defer os.Exit é€€å‡ºæ—¶ä¸ä¼šè°ƒç”¨ defer æŒ‡å®šçš„å‡½æ•° os.Exit é€€å‡ºæ—¶ä¸è¾“å‡ºå½“å‰è°ƒç”¨æ ˆä¿¡æ¯ deferè¯­å¥ç»å¸¸è¢«ç”¨äºå¤„ç†æˆå¯¹çš„æ“ä½œï¼Œå¦‚æ‰“å¼€ã€å…³é—­ã€è¿æ¥ã€æ–­å¼€è¿æ¥ã€åŠ é”ã€é‡Šæ”¾é”ã€‚é€šè¿‡deferæœºåˆ¶ï¼Œä¸è®ºå‡½æ•°é€»è¾‘å¤šå¤æ‚ï¼Œéƒ½èƒ½ä¿è¯åœ¨ä»»ä½•æ‰§è¡Œè·¯å¾„ä¸‹ï¼Œèµ„æºè¢«é‡Šæ”¾ã€‚\ndefer æ‰§è¡Œæ—¶é—´ : returnè¯­å¥æ›´æ–°è¿”å›å€¼å˜é‡ä¹‹åï¼Œå‡½æ•°è¿”å›ä¹‹å‰\nè‹¥deferè¯­å¥ä¸­åµŒå¥—äº†å¤šå±‚å‡½æ•°è°ƒç”¨ï¼Œåªæ˜¯æœ€åä¸€å±‚å‡½æ•°è°ƒç”¨æ‰å»¶åæ‰§è¡Œdefer un(trace(\u0026quot;b\u0026quot;)) ä¼šä¼˜å…ˆæ‰§è¡Œ trace(\u0026quot;B\u0026quot;)\nè‹¥é‡åˆ° panic , å…ˆæ‰§è¡Œ defer , å† panic\nå¤šä¸ª defer , ä¼šæŒ‰æ³¨å†Œçš„å…ˆåé¡ºåº, é€†åºæ‰§è¡Œ, ç±»å‹æ ˆ,åè¿›åå‡º, é€’å½’æ˜¯æ­£åº\nä¸€ä¸ªå‡½æ•°æ§åˆ¶å‡ºå…¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 func bigSlowOperation() { defer trace(\u0026#34;bigSlowOperation\u0026#34;)() // don\u0026#39;t forget the extra parentheses // ...lots of workâ€¦ time.Sleep(10 * time.Second) // simulate slow operation by sleeping } func trace(msg string) func() { start := time.Now() log.Printf(\u0026#34;enter %s\u0026#34;, msg) return func() { log.Printf(\u0026#34;exit %s (%s)\u0026#34;, msg,time.Since(start)) } } æ›´æ”¹è¿”å›å€¼\n1 2 3 4 5 func triple(x int) (result int) { defer func() { result += x }() return double(x) } fmt.Println(triple(4)) // \u0026#34;12\u0026#34; path.Base æå–è·¯å¾„æœ€åä¸€æ®µ, å¯èƒ½ä¸º /\nå‚è€ƒ Golangä¹‹è½»æ¾åŒ–è§£deferçš„æ¸©æŸ”é™·é˜±\n","date":"2019-11-06T11:00:00Z","permalink":"https://blog.golang.space/p/13.defer/","title":"13.defer"},{"content":"error å¯é¢„çŸ¥çš„é”™è¯¯\næœ‰äº›é¢„æ–™ä¸­çš„é”™è¯¯ , ä¼šä½œä¸ºå‡½æ•°çš„ç¬¬äºŒä¸ªè¿”å›å€¼ , å¯ä»¥ä½¿ç”¨ fmt.Errorf('%v',err) å°è£…é”™è¯¯, ä½¿ç”¨ Unwrap æ¥è·å–ä¸Šä¸€å±‚çš„é”™è¯¯\nç”±äºé”™è¯¯ä¿¡æ¯ç»å¸¸æ˜¯ä»¥é“¾å¼ç»„åˆåœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥é”™è¯¯ä¿¡æ¯ä¸­åº”é¿å…å¤§å†™å’Œæ¢è¡Œç¬¦ã€‚\nä¸å¯é¢„çŸ¥çš„ , å¶ç„¶çš„\nä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©æ˜¯é‡æ–°å°è¯•å¤±è´¥çš„æ“ä½œã€‚åœ¨é‡è¯•æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶é‡è¯•çš„æ—¶é—´é—´éš”æˆ–é‡è¯•çš„æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™åˆ¶çš„é‡è¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 func WaitForServer(url string) error { const timeout = 1 * time.Minute deadline := time.Now().Add(timeout) for tries := 0; time.Now().Before(deadline); tries++ { _, err := http.Head(url) if err == nil { return nil // success } log.Printf(\u0026#34;server not responding (%s);retryingâ€¦\u0026#34;, err) time.Sleep(time.Second \u0026lt;\u0026lt; uint(tries)) // exponential back-off } return fmt.Errorf(\u0026#34;server %s failed to respond after %s\u0026#34;, url, timeout) } å½“ä½ æƒ³å¿½ç•¥æŸä¸ªé”™è¯¯æ—¶ , åº”è¯¥æ¸…æ™°çš„å†™ä¸‹æ„å›¾\nGoä¸­å¤§éƒ¨åˆ†å‡½æ•°çš„ä»£ç ç»“æ„å‡ ä¹ç›¸åŒï¼Œé¦–å…ˆæ˜¯ä¸€ç³»åˆ—çš„åˆå§‹æ£€æŸ¥ï¼Œé˜²æ­¢é”™è¯¯å‘ç”Ÿï¼Œä¹‹åæ˜¯å‡½æ•°çš„å®é™…é€»è¾‘ã€‚\nåœ¨Goä¸­ï¼Œé”™è¯¯å¤„ç†æœ‰ä¸€å¥—ç‹¬ç‰¹çš„ç¼–ç é£æ ¼ã€‚æ£€æŸ¥æŸä¸ªå­å‡½æ•°æ˜¯å¦å¤±è´¥åï¼Œæˆ‘ä»¬é€šå¸¸å°†å¤„ç†å¤±è´¥çš„é€»è¾‘ä»£ç æ”¾åœ¨å¤„ç†æˆåŠŸçš„ä»£ç ä¹‹å‰ã€‚å¦‚æœæŸä¸ªé”™è¯¯ä¼šå¯¼è‡´å‡½æ•°è¿”å›ï¼Œé‚£ä¹ˆæˆåŠŸæ—¶çš„é€»è¾‘ä»£ç ä¸åº”æ”¾åœ¨elseè¯­å¥å—ä¸­ï¼Œè€Œåº”ç›´æ¥æ”¾åœ¨å‡½æ•°ä½“ä¸­ã€‚\næ–‡ä»¶ç»“å°¾é”™è¯¯ EOF\nioåŒ…ä¿è¯ä»»ä½•ç”±æ–‡ä»¶ç»“æŸå¼•èµ·çš„è¯»å–å¤±è´¥éƒ½è¿”å›åŒä¸€ä¸ªé”™è¯¯â€”â€”io.EOF\næºç \n1 2 3 type error interface{ Error() string } ","date":"2019-11-05T15:00:00Z","permalink":"https://blog.golang.space/p/12.error/","title":"12.error"},{"content":"å‡½æ•° å‡½æ•°å£°æ˜\n1 2 func f(i, j, k int, s, t string) { /* ... */ } func f(i int, j int, k int, s string, t string) { /* ... */ } å‡½æ•°ç­¾å\nå‡½æ•°çš„ç±»å‹è¢«ç§°ä¸ºå‡½æ•°çš„ç­¾åã€‚å¦‚æœä¸¤ä¸ªå‡½æ•°å½¢å¼å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨ä¸­çš„å˜é‡ç±»å‹ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°è¢«è®¤ä¸ºæœ‰ç›¸åŒçš„ç±»å‹æˆ–ç­¾åã€‚\nå‡½æ•°è¿”å›å€¼\nå¯ä»¥è¿”å›å¤šä¸ªå€¼ ä¸éœ€è¦çš„å€¼å¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿æ¥æ”¶ è¿”å›çš„æ˜¯å€¼ç±»å‹å˜é‡, åˆ†é…åœ¨æ ˆä¸Š, è¿”å›çš„æ˜¯å¼•ç”¨ç±»å‹åˆ†é…åœ¨å †ä¸Š, å½“ä¸å†éœ€è¦æ—¶, gc è‡ªåŠ¨å›æ”¶\nå¦‚æœä¸€ä¸ªå‡½æ•°æ‰€æœ‰çš„è¿”å›å€¼éƒ½æœ‰æ˜¾å¼çš„å˜é‡åï¼Œé‚£ä¹ˆè¯¥å‡½æ•°çš„returnè¯­å¥å¯ä»¥çœç•¥æ“ä½œæ•°ã€‚è¿™ç§°ä¹‹ä¸ºbare returnã€‚\nè¿™æ ·ä¼šä½¿ä»£ç ä¸æ˜“ç†è§£ , ä¸å®œè¿‡åº¦ä½¿ç”¨\n1 2 3 4 func sub(x, y int) (z int) { z = x - y; return // æ­¤å¤„ç­‰ä»·äº return z } å®å‚é€šè¿‡å€¼çš„æ–¹å¼ä¼ é€’ï¼ŒåŒ…æ‹¬å¼•ç”¨ç±»å‹, ä¹Ÿæ˜¯å€¼ä¼ é€’ , å› æ­¤å‡½æ•°çš„å½¢å‚æ˜¯å®å‚çš„æ‹·è´ã€‚\nå¦‚æœå®å‚æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¦‚æŒ‡é’ˆï¼Œslice(åˆ‡ç‰‡)ã€mapã€functionã€channelç­‰ç±»å‹ï¼Œå®å‚å¯èƒ½ä¼šç”±äºå‡½æ•°çš„é—´æ¥å¼•ç”¨è¢«ä¿®æ”¹ã€‚\nå¯èƒ½ä¼šå¶å°”é‡åˆ°æ²¡æœ‰å‡½æ•°ä½“çš„å‡½æ•°å£°æ˜ï¼Œè¿™è¡¨ç¤ºè¯¥å‡½æ•°ä¸æ˜¯ä»¥Goå®ç°çš„ã€‚\né€’å½’\ngolang.org/x/net/html\nhtml.Parseå‡½æ•°è¯»å…¥ä¸€ç»„bytesè§£æåï¼Œè¿”å›html.Nodeç±»å‹çš„HTMLé¡µé¢æ ‘çŠ¶ç»“æ„æ ¹èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 doc, _ := html.Parse(os.Stdin) visit(nil, doc) func visit(links []string, n *html.Node) []string { if n.Type == html.ElementNode \u0026amp;\u0026amp; n.Data == \u0026#34;a\u0026#34; { for _, a := range n.Attr { if a.Key == \u0026#34;href\u0026#34; { links = append(links, a.Val) } } } for c := n.FirstChild; c != nil; c = c.NextSibling { links = visit(links, c) } return links } å¤šè¿”å›å€¼\n1 2 3 links, err := findLinks(url) // ä¹Ÿå¯ä»¥ä½¿ç”¨ - å¿½ç•¥ _, err := findLinks(url) æœ‰äº›é¢„æ–™ä¸­çš„é”™è¯¯ , ä¼šä½œä¸ºå‡½æ•°çš„ç¬¬äºŒä¸ªè¿”å›å€¼ , å¯ä»¥ä½¿ç”¨ fmt.Errorf('%v',err) å°è£…é”™è¯¯, ä½¿ç”¨ Unwrap æ¥è·å–ä¸Šä¸€å±‚çš„é”™è¯¯\nå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘\nå‡½æ•°å¯ä»¥èµ‹å€¼ , æœ‰ç±»å‹\nå‡½æ•°çš„é›¶å€¼æ˜¯ nil , è°ƒç”¨é›¶å€¼å‡½æ•°ä¼šå¼•èµ· panic å¼‚å¸¸\nå‡½æ•°å€¼å¯ä»¥ä¸ nil æ¯”è¾ƒ, ä½†æ˜¯ä¸èƒ½ç›¸äº’æ¯”è¾ƒ , ä¸”ä¸èƒ½ä½œä¸º map çš„ key\nstrings.Mapå¯¹å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦è°ƒç”¨add1å‡½æ•°ï¼Œå¹¶å°†æ¯ä¸ªadd1å‡½æ•°çš„è¿”å›å€¼ç»„æˆä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²è¿”å›ç»™è°ƒç”¨è€…ã€‚\n1 2 3 4 5 func add1(r rune) rune { return r + 1 } fmt.Println(strings.Map(add1, \u0026#34;HAL-9000\u0026#34;)) // \u0026#34;IBM.:111\u0026#34; fmt.Println(strings.Map(add1, \u0026#34;VMS\u0026#34;)) // \u0026#34;WNT\u0026#34; fmt.Println(strings.Map(add1, \u0026#34;Admix\u0026#34;)) // \u0026#34;Benjy\u0026#34; åŒ¿åå‡½æ•°\n1 strings.Map(func(r rune) rune { return r + 1 }, \u0026#34;HAL-9000\u0026#34;) é—­åŒ…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func squares() func() int { var x int return func() int { x++ return x * x } } func TestSquares(t *testing.T) { f := squares() fmt.Println(f()) // \u0026#34;1\u0026#34; fmt.Println(f()) // \u0026#34;4\u0026#34; fmt.Println(f()) // \u0026#34;9\u0026#34; fmt.Println(f()) // \u0026#34;16\u0026#34; } å¯å˜å‚æ•°åˆ—è¡¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // å¤šè¿”å›å€¼ è¿™é‡Œçš„å‡½æ•°è¿”å›å€¼ (q,r int) \u0026lt;=\u0026gt; (int,int) func returnDoubleValue(a,b int) (q, r int){ return a/b,a*b } q, _ := returnDoubleValue(3,9) // å‡½æ•°ä¸ºå½¢å‚, ä¹Ÿå¯ä»¥è¿”å›å‡½æ•° func apply(op func(int,int) int, a,b int) int { return op(a,b) } /// ... å¯å˜å‚æ•°åˆ—è¡¨ func sum(numbers ...int) int { s := 0 for i:= range numbers { s += numbers[i] } return s } fmt.Println(sum(1,2,3,4,5)) main å‡½æ•°\nå¿…é¡»æ˜¯ main åŒ… å¿…é¡»æ˜¯ main æ–¹æ³• æ–‡ä»¶åä¸ä¸€å®šæ˜¯ main.go Go ä¸­ main å‡½æ•°ä¸æ”¯æŒä»»ä½•è¿”å›å€¼ é€šè¿‡ os.Exit æ¥è¿”å›çŠ¶æ€, è¿”å›çš„å€¼ èŒƒå›´ -1 ~ 255 ,é™¤äº† 0 , å…¶ä½™çŠ¶æ€ç éƒ½æ˜¯ 1 åœ¨ç¨‹åºä¸­ç›´æ¥é€šè¿‡ os.Args è·å–å‘½ä»¤è¡Œå‚æ•° ","date":"2019-11-05T11:00:00Z","permalink":"https://blog.golang.space/p/11.%E5%87%BD%E6%95%B0/","title":"11.å‡½æ•°"},{"content":"golang è¯­è¨€æ ‡å‡†åº“ encoding/json ç»“æ„ä½“slice è½¬ JSON å«ç¼–ç»„\nç¼–ç æ—¶ , é€šè¿‡åå°„æŠ€æœ¯ , åªæœ‰å¯¼å‡º(é¦–å­—æ¯å¤§å†™)çš„æˆå‘˜æ‰ä¼šè¢«ç¼–ç \né€šé“ã€å¤æ•°ã€å‡½æ•°ç±»å‹çš„å€¼ä¸èƒ½ç¼–ç è¿›jsonã€‚\njson.Marshal ç¼–ç \nè¿”å›æ²¡æœ‰ç©ºæ ¼çš„ç´§å‡‘å­—èŠ‚æ•°ç»„\n1 data, err := json.Marshal(movies) json.MarshalIndent æ ¼å¼åŒ–ç¼–ç \nè¿”å›åŒ…å«ç©ºæ ¼çš„æ ¼å¼åŒ–å­—èŠ‚æ•°ç»„\nå‚æ•° 2 : æ¯ä¸€è¡Œçš„è¾“å‡ºå‰ç¼€\nå‚æ•° 3 : å±‚çº§ç¼©è¿›\n1 data, err := json.MarshalIndent(movies, \u0026#34;\u0026#34;, \u0026#34; \u0026#34;) **Unmarshal ** è§£ç \né¦–å…ˆå¤„ç†jsonæ•°æ®æ˜¯jsonå­—é¢å€¼nullçš„æƒ…å†µã€‚æ­¤æ—¶ï¼Œå‡½æ•°å°†æŒ‡é’ˆè®¾ä¸ºnilï¼›å¦åˆ™ï¼Œå‡½æ•°å°†jsonæ•°æ®è§£ç å†™å…¥æŒ‡é’ˆæŒ‡å‘çš„å€¼ï¼›å¦‚æœæŒ‡é’ˆæœ¬èº«æ˜¯nilï¼Œå‡½æ•°ä¼šå…ˆç”³è¯·ä¸€ä¸ªå€¼å¹¶ä½¿æŒ‡é’ˆæŒ‡å‘å®ƒã€‚\n1 2 3 4 var titles []struct{ Title string } if err := json.Unmarshal(data, \u0026amp;titles); err != nil { log.Fatalf(\u0026#34;JSON unmarshaling failed: %s\u0026#34;, err) } ç»“æ„ä½“ä¸­åªæœ‰Titleæˆå‘˜ã€‚é€šè¿‡å®šä¹‰åˆé€‚çš„Goè¯­è¨€æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ€§åœ°è§£ç JSONä¸­æ„Ÿå…´è¶£çš„æˆå‘˜ã€‚\nDecoder æµè§£ç å™¨\nè¿˜æœ‰ Encoder æµç¼–ç å™¨\n1 2 3 4 5 6 7 8 9 10 11 12 type IssuesSearchResult struct { TotalCount int `json:\u0026#34;total_count\u0026#34;` Items []*Issue } var result IssuesSearchResult // å‘èµ·ç½‘ç»œè¯·æ±‚, æ‹¿åˆ° resp.body // æ­¤å¤„å¯¹æµè§£ç  , ä¹Ÿå¯ä»¥ä½¿ç”¨ ioutil.ReadALL æ¥è¯»å–æµæ•°æ® if err := json.NewDecoder(resp.Body).Decode(\u0026amp;result); err != nil { resp.Body.Close() return nil, err } tag\nTagå¯ä»¥æ˜¯ä»»æ„çš„å­—ç¬¦ä¸²é¢å€¼ , é€šå¸¸æ˜¯ä¸€ç³»åˆ—ç”¨ç©ºæ ¼åˆ†éš”çš„key:\u0026ldquo;value\u0026quot;é”®å€¼å¯¹åºåˆ—ï¼›\njsonå¼€å¤´é”®åå¯¹åº”çš„å€¼ç”¨äºæ§åˆ¶encoding/jsonåŒ…çš„ç¼–ç å’Œè§£ç çš„è¡Œä¸º\njson:\u0026quot;color\u0026quot; ç¼–ç åçš„åå­—ä¸º color\njson:\u0026quot;,omitempty\u0026quot; åå­—ä¸ºå˜é‡å, è¯¥ç±»å‹è‹¥ä¸ºé›¶å€¼ æˆ– nil, ä¸ä¼šè¢«ç¼–ç \njson:\u0026quot;-\u0026quot; å¿½ç•¥, ä¸ä¼šè¢«ç¼–ç \njson:\u0026quot;,string\u0026quot; ç¼–ç æ—¶ä¸ºå­—ç¬¦ä¸², ä»…é€‚ç”¨äºå˜é‡ä¸º å­—ç¬¦ä¸²ã€æµ®ç‚¹æ•°ã€æ•´æ•°ç±»å‹çš„å­—æ®µ\nomitempty :\n1 2 3 4 type movies struct{ Year int `json:\u0026#34;released\u0026#34;` Color bool `json:\u0026#34;color,omitempty\u0026#34;` } åŒ¿åç»“æ„ä½“ç¼–ç \n1 2 3 4 5 6 7 8 9 type Page struct { Color int Size int } type Book struct { Page Size int } book ä¸­ Size ä¸ page ä¸­ Size å‘½åå†²çª, page çš„ Size ä¸ä¼šè¢«ç¼–ç  ç¼–ç å{\u0026quot;Color\u0026quot;:255,\u0026quot;Size\u0026quot;:12} å¯¹ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰æ“ä½œ url.QueryEscape\nåœ¨ URL ä¸­åŠ å…¥æŸ¥è¯¢å‚æ•°, é¿å… ? \u0026amp; ç­‰æ­§ä¹‰ , å¯ä»¥å…ˆä½¿ç”¨ url.QueryEscape è½¬ä¹‰\n1 2 q := url.QueryEscape(strings.Join(terms, \u0026#34; \u0026#34;)) resp, err := http.Get(IssuesURL + \u0026#34;?q=\u0026#34; + q) Jsonååºåˆ—åŒ–æ•°å­—åˆ°interface{}ç±»å‹çš„å€¼ä¸­ï¼Œé»˜è®¤è§£æä¸ºfloat64ç±»å‹ï¼Œåœ¨ä½¿ç”¨æ—¶è¦æ³¨æ„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 var data = []byte(`{\u0026#34;status\u0026#34;: 200}`) var result map[string]interface{} if err := json.Unmarshal(data, \u0026amp;result); err != nil { fmt.Println(\u0026#34;error:\u0026#34;, err) return } //var status = result[\u0026#34;status\u0026#34;].(int) //error: panic: interface conversion: interface is float64, not int var status = uint64(result[\u0026#34;status\u0026#34;].(float64)) //ok fmt.Println(\u0026#34;status value:\u0026#34;,status) ","date":"2019-11-04T14:00:00Z","permalink":"https://blog.golang.space/p/10.json/","title":"10.json"},{"content":"ç»“æ„ä½“ è‡ªå®šä¹‰ç±»å‹ã€‚\nå®šä¹‰ç»“æ„ä½“ 1 2 3 4 5 6 7 8 type Employee struct { ID int Name string Address string DoB time.Time } var dilbert Employee ç»“æ„ä½“ç±»å‹çš„é›¶å€¼æ˜¯æ¯ä¸ªæˆå‘˜éƒ½æ˜¯é›¶å€¼ã€‚\nä½¿ç”¨ . æ“ä½œç¬¦å¯ä»¥å¯¹æ¯ä¸ªæˆå‘˜èµ‹å€¼ , å–åœ°å€\næŒ‡é’ˆä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ . æ“ä½œç¬¦, ç›¸å½“äº (*p).param\nå¦‚æœç»“æ„ä½“æˆå‘˜åå­—æ˜¯ä»¥å¤§å†™å­—æ¯å¼€å¤´çš„ï¼Œé‚£ä¹ˆè¯¥æˆå‘˜å°±æ˜¯å¯¼å‡ºçš„ï¼›å¯ä»¥è¢« json åºåˆ—åŒ–\nä¸€ä¸ªèšåˆçš„å€¼ , ä¸èƒ½åŒ…å«å®ƒæœ¬èº«, åŒæ ·é€‚ç”¨äºæ•°ç»„, æ‰€ä»¥ a ç»“æ„ä½“ä¸èƒ½åµŒå¥— a ç»“æ„ä½“ , ä½†å¯ä»¥åŒ…å« *a , è¿™æ ·å¯ä»¥åˆ›å»ºé€’å½’çš„æ•°æ®ç»“æ„, æ¯”å¦‚é“¾è¡¨å’Œæ ‘\nä¾‹é¢˜ ä½¿ç”¨äºŒå‰æ ‘æ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 type tree struct { value int left, right *tree } // Sort sorts values in place. func Sort(values []int) { var root *tree for _, v := range values { root = add(root, v) } appendValues(values[:0], root) } // appendValues appends the elements of t to values in order // and returns the resulting slice. func appendValues(values []int, t *tree) []int { if t != nil { values = appendValues(values, t.left) values = append(values, t.value) values = appendValues(values, t.right) } return values } func add(t *tree, value int) *tree { if t == nil { // Equivalent to return \u0026amp;tree{value: value}. t = new(tree) t.value = value return t } if value \u0026lt; t.value { t.left = add(t.left, value) } else { t.right = add(t.right, value) } return t } åŒ¿åç»“æ„ä½“å˜é‡ä¸ç±»å‹è½¬æ¢ è¿™äº›å­—é¢æ„ä¹‰ä¸Šçš„ç±»å‹çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œæ¯”å¦‚ï¼Œåœ¨ä¸€ä¸ªç½‘ç»œ API ä¸Šè¿›è¡Œååºåˆ—åŒ–ï¼Œä½ éœ€è¦ä¸€äº›ç±»å‹ä¿¡æ¯ï¼Œä½†æ˜¯ç»™å®ƒå‘½åä¸ä¸€å®šå¥½ï¼Œå› ä¸ºè¿™åªéœ€è¦åœ¨è¿™ä¸€ä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œè€Œæˆ‘ä»¬ä¸æƒ³ç»™åªåœ¨ä¸€ä¸ªåœ°æ–¹ä½¿ç”¨çš„ä¸œè¥¿å‘½åï¼Œé‚£å°†æ˜¯ä¸€ç§æ±¡æŸ“ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func main(){ // å£°æ˜åä¸º e1 çš„å˜é‡ var e1 struct{ flag bool counter int64 } e2 := struct{ flag bool counter int64 }{ flag: true, counter: 4, } // ... } bill å’Œ alice çš„å­—æ®µç›¸åŒã€‚èµ‹å€¼ä¸ä¼šåšéšå¼ç±»å‹è½¬æ¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 type bill struct{ flag bool counter int64 } type alice struct{ flag bool counter int64 } func TestSameStruct(t *testing.T) { b := bill{counter: 11} a := alice{counter: 22} // å¼ºåˆ¶ç±»å‹è½¬æ¢ a = alice(b) t.Log(a, b) c := struct { flag bool counter int64 }{ counter: 33, } // æ— åºç±»å‹è½¬æ¢ a = c t.Log(a, c) } ç»“æ„ä½“å­—é¢å€¼ æŒ‰å®šä¹‰é¡ºåºèµ‹å€¼, é€šå¸¸ç”¨äºåŒ…å†…æˆ–è¾ƒå°çš„ç»“æ„ä½“,\n1 2 type Point struct{ X, Y int } p := Point{1, 2} æ›´å¸¸ç”¨çš„å†™æ³• , é¡ºåºä¸é‡è¦ , æœªèµ‹å€¼çš„æˆå‘˜é»˜è®¤é›¶å€¼\n1 anim := gif.GIF{LoopCount: nframes} ä½œä¸ºå‡½æ•°å‚æ•° ç»“æ„ä½“å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ã€‚\nè€ƒè™‘æ•ˆç‡çš„è¯, å¯ä»¥è€ƒè™‘ä½¿ç”¨æŒ‡é’ˆä¼ å…¥å’Œè¿”å›\n1 2 3 func Bonus(e *Employee, percent int) int { return e.Salary * percent / 100 } åœ¨ Go è¯­è¨€ä¸­, æ‰€æœ‰çš„å‡½æ•°å‚æ•°éƒ½æ˜¯å€¼æ‹·è´ , å‡½æ•°å‚æ•°ä¸å†æ˜¯å‡½æ•°è°ƒç”¨æ—¶çš„åŸå§‹å˜é‡\nç»“æ„ä½“æ¯”è¾ƒ å¦‚æœæ‰€æœ‰æˆå‘˜å¯ä»¥æ¯”è¾ƒ, åˆ™ç›¸åŒç±»å‹çš„ç»“æ„ä½“å¯ä»¥ä½¿ç”¨ == æˆ– != æ¯”è¾ƒ\næ³¨æ„, æ¯ä¸ªç»“æ„ä½“éƒ½æ˜¯ä¸åŒç±»å‹, å“ªæ€•æˆå‘˜å±æ€§ä¸€æ ·;\nå¯æ¯”è¾ƒçš„ç»“æ„ä½“ç±»å‹å’Œå…¶ä»–å¯æ¯”è¾ƒçš„ç±»å‹ä¸€æ ·ï¼Œå¯ä»¥ç”¨äºmapçš„keyç±»å‹ã€‚\nä¸å¯æ¯”è¾ƒç±»å‹ : since map function\nå½“ç»“æ„ä½“ä¸­åŒ…å« slice æˆ– map æ—¶, å¯ä»¥ä½¿ç”¨ reflect.DeepEaual æ¯”è¾ƒ\nç»“æ„ä½“åµŒå¥— å’Œ åŒ¿åæˆå‘˜ åŒ¿åæˆå‘˜çš„æ•°æ®ç±»å‹å¿…é¡»æ˜¯å‘½åçš„ç±»å‹æˆ–æŒ‡å‘ä¸€ä¸ªå‘½åçš„ç±»å‹çš„æŒ‡é’ˆã€‚\nåŒ¿åæˆå‘˜å¯ä»¥ç›´æ¥è®¿é—®å…¶å¶å­å±æ€§åŠæ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 type Point struct{ x, y int } type Circle struct { Point Radius int } var c Circle c.x=8 c.y=8 c.Radius=5 fmt.Printf(\u0026#34;%#v\\n\u0026#34;, c) // # å¯ä»¥è¾“å‡º åŒ…å/ç»“æ„ä½“å/æˆå‘˜å ä¸èƒ½åŒæ—¶åŒ…å«ä¸¤ä¸ªç±»å‹ç›¸åŒçš„åŒ¿åæˆå‘˜, è¿™ä¼šå¯¼è‡´å‘½åå†²çª\nåŒ¿åæˆå‘˜ åºåˆ—åŒ– Aç»“æ„ä½“æˆå‘˜åä¸åŒ¿åç»“æ„ä½“çš„æˆå‘˜åå‡ºç°å†²çª , åˆ™ä»…åºåˆ—åŒ– Aç»“æ„ä½“æˆå‘˜ åºåˆ—åŒ–ååŒ¿åç»“æ„ä½“çš„æˆå‘˜ä¸ A ç»“æ„ä½“æˆå‘˜æ˜¯åŒçº§ ä»¥ä¸Šä¸¤ç‚¹è¯¦æƒ…è§ json é‚£ç¯‡æ–‡ç« \nå†…å­˜å¯¹é½ å†…å­˜å¯¹é½æ˜¯ä¸ºäº†ä½¿è¯»å†™å°½å¯èƒ½æé«˜å†…å­˜çš„æ•ˆç‡ã€‚\nå¦‚æœä¸åšå†…å­˜å¯¹é½ï¼Œä¸€ä¸ªç±»å‹è¶Šè¿‡äº†ä¸¤ä¸ªè¾¹ç•Œï¼Œé‚£ä¹ˆéœ€è¦ä¸€åˆ°ä¸¤ä¸ªæ“ä½œæ¥å†™å®ƒï¼Œè¿™å¹¶ä¸é«˜æ•ˆã€‚\nç¼–è¯‘å™¨ä¼šå°†ä¸åŒçš„ç±»å‹åˆ†é…åˆ°åˆé€‚çš„å†…å­˜ï¼Œä½¿å®ƒä»¬æ€»æ˜¯è½åœ¨è¾¹ç•Œå†…ã€‚\næ¯”å¦‚ç°åœ¨æœ‰ boolï¼Œint16ï¼Œint32 ä¸‰ç§ç±»å‹ã€‚\n1 2 3 4 5 type T struct{ a bool b int16 c int32 } a å ç”¨ 1 ä¸ªå­—èŠ‚ï¼Œb å ç”¨ 2 ä¸ªå­—èŠ‚ï¼Œc å ç”¨ 4 ä¸ªå­—èŠ‚ã€‚\nä¸ºäº†å¯¹é½è¾¹ç•Œï¼Œå†…å­˜å¿…é¡»æ˜¯ 2 çš„å€æ•°ï¼Œå³ a å ç”¨ 2 ä¸ªå­—èŠ‚ï¼Œå¤šçš„ä¸€ä¸ªå­—èŠ‚ä¼šè‡ªåŠ¨å¡«å……è·³è¿‡ã€‚\n2+2+4 = 8ï¼Œå­—æ®µ a ä¼šå¡«å…… 1 ä¸ªå­—èŠ‚\nå¦‚æœ b æ˜¯ int 32 ç±»å‹å‘¢?\n4+4+4 = 12ï¼Œå†…å­˜å¿…é¡»æ˜¯ 4 çš„å€æ•°ï¼Œå­—æ®µ a ä¼šå¡«å…… 3 ä¸ªå­—èŠ‚\nå¦‚æœ b æ˜¯ int64 ç±»å‹å‘¢?\n8+8+8ï¼Œå†…å­˜å¿…é¡»æ˜¯ 8 çš„å€æ•°ï¼Œå­—æ®µ a ä¼šå¡«å…… 7 ä¸ªå­—èŠ‚ï¼Œå­—æ®µ c ä¼šå¡«å…… 4 ä¸ªå­—èŠ‚\n**é€šè¿‡è°ƒæ•´å­—æ®µé¡ºåºï¼Œå¯ä»¥ä¼˜åŒ–å†…å­˜ï¼Œä¸ºä»€ä¹ˆè¯­è¨€ä¸èƒ½ä¸ºä½ åšè¿™ä¸ªå†…å­˜å¯¹é½? **\nä½ å¯ä»¥æ§åˆ¶ä½ çš„å†…å­˜å¸ƒå±€ï¼Œæ ¹æ®éœ€è¦ä½¿ä»–ä»¬å˜å¾—æ›´å‡†ç¡®ï¼Œè¯­è¨€çš„å·¥ä½œä¸æ˜¯åœ¨èƒŒåè¯•å›¾é¢„å…ˆä¸ºä½ ä¼˜åŒ–ä¸œè¥¿ã€‚\næ³¨æ„: é™¤éæœ‰ä¸€ä¸ªåŸºå‡†ï¼Œè¡¨æ˜å› æ­¤å ç”¨äº†å¤ªå¤šå†…å­˜ï¼Œæ‰åº”è¯¥ä¼˜åŒ–è¿™ä¸ªç»“æ„ä»¥å‡å°‘å¡«å……ã€‚å¦åˆ™ï¼Œå°†è¯­ä¹‰ä¸Šç›¸åŒçš„å­—æ®µæ”¾åœ¨ä¸€èµ·ï¼Œå¯è¯»æ€§æ›´é‡è¦ã€‚\n","date":"2019-11-04T12:00:00Z","permalink":"https://blog.golang.space/p/9.%E7%BB%93%E6%9E%84%E4%BD%93/","title":"9.ç»“æ„ä½“"},{"content":"[toc]\nmap 1. åŸºç¡€çŸ¥è¯† 1.1. å£°æ˜æ–¹å¼ åŒºåˆ†: æ•°ç»„å®šä¹‰äº†é•¿åº¦, å°±ä¼šè‡ªåŠ¨åˆå§‹åŒ–, map make æ—¶å®šä¹‰äº†é•¿åº¦, ä¹Ÿæ˜¯ 0\næ— è®º map æ˜¯å¦åˆå§‹åŒ–, éƒ½å¯ä»¥ä½¿ç”¨ len è¿›è¡Œåˆ¤æ–­é•¿åº¦\nä»…ä»…å£°æ˜ä¸€ä¸ª map , æ²¡æœ‰åˆå§‹åŒ–, æ˜¯ nil map , ä¸èƒ½ä½¿ç”¨\n1 2 3 4 5 6 7 m := map[string]string{ \u0026#34;name\u0026#34;:\u0026#34;ccmouse\u0026#34;, \u0026#34;course\u0026#34;:\u0026#34;golang\u0026#34;, } m2 := make(map[string]int) // m2 == {} å³ len(m2) == 0 var m3 map[string]int // m3 == nil ä¹Ÿå¯ä»¥ len(m3) == 0 æ³¨æ„ä¸èƒ½å¯¹ map ä¸­çš„å…ƒç´ è¿›è¡Œå–å€ , mapçš„keyå¿…é¡»æ˜¯å¯æ¯”è¾ƒçš„ç±»å‹\nç¦æ­¢å¯¹mapå…ƒç´ å–å€çš„åŸå› æ˜¯mapå¯èƒ½éšç€å…ƒç´ æ•°é‡çš„å¢é•¿è€Œé‡æ–°åˆ†é…æ›´å¤§çš„å†…å­˜ç©ºé—´ï¼Œä»è€Œå¯èƒ½å¯¼è‡´ä¹‹å‰çš„åœ°å€æ— æ•ˆã€‚\n1 _ = \u0026amp;ages[\u0026#34;bob\u0026#34;] // âŒ ä¸èƒ½ç›´æ¥æ›´æ–° map ä¸­ struct çš„å…ƒç´ å­—æ®µå€¼ï¼Œæ³¨æ„ : array å’Œ slice æ˜¯å¯ä»¥çš„ç›´æ¥æ›´æ–°çš„ã€‚\n1 m[\u0026#34;x\u0026#34;].name = \u0026#34;Jerry\u0026#34; // âŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 type data struct { name string } func TestData(t *testing.T) { m := map[string]data{ \u0026#34;x\u0026#34;: {\u0026#34;Tom\u0026#34;}, } r := m[\u0026#34;x\u0026#34;] r.name = \u0026#34;Jerry\u0026#34; m[\u0026#34;x\u0026#34;] = r fmt.Println(m) } 1.2. éå†æ•°æ® Mapçš„è¿­ä»£é¡ºåºæ˜¯ä¸ç¡®å®šçš„, åœ¨å®è·µä¸­ï¼Œéå†çš„é¡ºåºæ˜¯éšæœºçš„ï¼Œæ¯ä¸€æ¬¡éå†çš„é¡ºåºéƒ½ä¸ç›¸åŒã€‚è¿™æ˜¯æ•…æ„çš„ï¼Œæ¯æ¬¡éƒ½ä½¿ç”¨éšæœºçš„éå†é¡ºåºå¯ä»¥å¼ºåˆ¶è¦æ±‚ç¨‹åºä¸ä¼šä¾èµ–å…·ä½“çš„å“ˆå¸Œå‡½æ•°å®ç°ã€‚å¦‚æœè¦æŒ‰é¡ºåºéå†key/valueå¯¹ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¾å¼åœ°å¯¹keyè¿›è¡Œæ’åºï¼Œå¯ä»¥ä½¿ç”¨sortåŒ…çš„Stringså‡½æ•°å¯¹å­—ç¬¦ä¸²sliceè¿›è¡Œæ’åºã€‚\n1 2 3 4 5 m1 := map[string]string{\u0026#34;1\u0026#34;:\u0026#34;2\u0026#34;} for k,v:=range m1 { t.Log(k,\u0026#34; \u0026gt;\u0026gt;\u0026gt; \u0026#34;,v) } å¦‚æœæƒ³è¦æ’åº, å¯ä»¥å¯¹ key æ’åº\n1 2 3 4 5 6 7 8 9 10 import \u0026#34;sort\u0026#34; var names []string for name := range ages { names = append(names, name) } sort.Strings(names) for _, name := range names { fmt.Printf(\u0026#34;%s\\t%d\\n\u0026#34;, name, ages[name]) } å› ä¸ºæˆ‘ä»¬ä¸€å¼€å§‹å°±çŸ¥é“namesçš„æœ€ç»ˆå¤§å°ï¼Œå› æ­¤ç»™sliceåˆ†é…ä¸€ä¸ªåˆé€‚çš„å¤§å°å°†ä¼šæ›´æœ‰æ•ˆã€‚ä¼šé¿å… append æ—¶æµªè´¹å†…å­˜\n1 names := make([]string, 0, len(ages)) 1.3. map ä¸º nil åšæ“ä½œ mapä¸Šçš„å¤§éƒ¨åˆ†æ“ä½œï¼ŒåŒ…æ‹¬æŸ¥æ‰¾ã€åˆ é™¤ã€lenå’Œrangeå¾ªç¯éƒ½å¯ä»¥å®‰å…¨å·¥ä½œåœ¨nilå€¼çš„mapä¸Šï¼Œå®ƒä»¬çš„è¡Œä¸ºå’Œä¸€ä¸ªç©ºçš„mapç±»ä¼¼ã€‚ä½†æ˜¯å‘ä¸€ä¸ªnilå€¼çš„mapå­˜å…¥å…ƒç´ å°†å¯¼è‡´ä¸€ä¸ªpanicå¼‚å¸¸ , åœ¨å‘mapå­˜æ•°æ®å‰å¿…é¡»å…ˆåˆ›å»ºmap, å³åˆ†é…å†…å­˜ç©ºé—´ã€‚\nè®¿é—®ä¸å­˜åœ¨çš„ key\n1 2 m1 := map[int]int{} // ç©º map t.Log(m1[1]) // è®¿é—®ä¸å­˜åœ¨çš„ key è¿”å›çš„ç»“æœæ˜¯é›¶å€¼ , å½“è®¿é—®çš„ key ä¸å­˜åœ¨, ä¼šè¿”å› value å¯¹åº”ç±»å‹çš„é›¶å€¼\nå¦‚æœ value ç±»å‹æ˜¯ int, èµ‹å€¼åæ˜¯ 0 å€¼, ä¸å­˜åœ¨æ—¶ ä¹Ÿæ˜¯ 0 å€¼, å¦‚ä½•åˆ¤æ–­?\nkey å­˜åœ¨, åˆ™ ok ä¸º ture, ä¸å­˜åœ¨ false\n1 2 3 if value, ok:=m1[3]; ok { t.Logf( \u0026#34; key 3 is = %d\u0026#34;,value) } å’Œsliceä¸€æ ·ï¼Œmapä¹‹é—´ä¹Ÿä¸èƒ½è¿›è¡Œç›¸ç­‰æ¯”è¾ƒï¼›å”¯ä¸€çš„ä¾‹å¤–æ˜¯å’Œnilè¿›è¡Œæ¯”è¾ƒã€‚\nåˆ é™¤æŸä¸ª key\nä½¿ç”¨ delete , ä¼ å…¥ map å’Œ key å‚æ•°\n1 2 m1 := map[int]int{1:1,2:4,3:9,4:16} delete(m1,1) map çš„ key\nmap ä½¿ç”¨å“ˆå¸Œè¡¨, å¿…é¡» key æ¯”è¾ƒç›¸ç­‰\né™¤äº† slice, map, function çš„å†…å»ºç±»å‹éƒ½å¯ä»¥ä½œä¸º key\nå¦‚æœæƒ³ç”¨ slice, å¯ä»¥å®šä¹‰ä¸€ä¸ªå‡½æ•°è·å– slice çš„å­—ç¬¦ä¸² , ä½œä¸º map çš„ key\nstruct ç±»å‹ä¸åŒ…å«ä»¥ä¸Šå­—æ®µ(slice,map), ä¹Ÿå¯ä»¥ä½œä¸º key\nä½œä¸ºå‡½æ•°å‚æ•°\nä¼ é€’æ—¶æ‹·è´åœ°å€, æ‰€ä»¥æœ‰ä¼ å¼•ç”¨çš„æ•ˆæœ\nset\nå†…ç½®é›†åˆæ²¡æœ‰ set å®ç°, å¯ä»¥ä½¿ç”¨ map[type]bool\n1 set := map[string]bool 2. ä½¿ç”¨æ¡ˆä¾‹ 2.1. å¯»æ‰¾æœ€é•¿ä¸å«æœ‰é‡å¤å­—ç¬¦çš„å­ä¸² front æŒ‡é’ˆä» 0 å¼€å§‹, å¦‚æœæ²¡æœ‰é‡åˆ°é‡å¤çš„å­—ç¬¦, å°±åœæ­¢ç§»åŠ¨, éå†åé¢çš„å­—ç¬¦, é€šè¿‡ å½“å‰é•¿åº¦-front è·å–æœ€é•¿å­ä¸²\nå¦‚æœå½“å‰éå†çš„å­—ç¬¦åœ¨ front åé¢å‡ºç°è¿‡, front å°±ç§»åŠ¨åˆ°ä¸Šä¸€æ¬¡å‡ºç°ä½ç½®+1\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func TestSelectLongOfNotRepeatingSubStr(t *testing.T) { str := \u0026#34;abcabcdabacd\u0026#34; m1 := make(map[rune]int,len(str)) front :=0 // å¤´æŒ‡é’ˆ maxLen :=0 // æœ€å¤§å­ä¸²é•¿åº¦ for i,ch := range []rune(str) { // å¦‚æœå½“å‰å­—ç¬¦åœ¨ front åé¢å‡ºç°è¿‡ä¸€æ¬¡ if back,ok := m1[ch]; ok \u0026amp;\u0026amp; back \u0026gt;= front { // å¢åŠ  front ä½ç½®, å½“å‰éå†åˆ°çš„å­—ç¬¦åä¸€ä¸ªä½ç½® front = back +1 } maxLen = i-front+1 // æ›´æ–°ä½ç½® m1[ch] = i } t.Log(maxLen) } 3. æ³¨æ„ 4. äº†è§£æºç  ç»“æ„ä½“ runtime/map.go/hmap\n1 2 3 4 5 6 7 8 9 10 11 12 type hmap struct{ count int // é”®å€¼å¯¹æ•°é‡ flags uint8 B\tuint8\t// æ¡¶çš„æ•°ç›®æ˜¯ 2 çš„å¤šå°‘æ¬¡å¹‚ noverflow uint8 hash0 uint32 buckets unsafe.Pointer // æ¡¶åœ¨å“ªé‡Œ oldbuckets unsafe.Pointer // ç”¨äºæ‰©å®¹é˜¶æ®µä¿å­˜æ—§æ¡¶åœ¨å“ªå„¿ nevacuate uintptr // å³å°†è¿ç§»çš„æ—§æ¡¶ç¼–å· extra *mapextra } Golangçš„mapä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œå¯ä»¥æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œä¹Ÿå³bucketï¼Œè€Œæ¯ä¸ªbucketå°±ä¿å­˜äº†mapä¸­çš„ä¸€ä¸ªæˆ–ä¸€ç»„é”®å€¼å¯¹ã€‚\nä¸‹å›¾å±•ç¤ºä¸€ä¸ªæ‹¥æœ‰4ä¸ªbucketçš„mapï¼š\nbucketæ•°æ®ç»“æ„ 1 2 3 4 5 type bmap struct { tophash [8]uint8 //å­˜å‚¨å“ˆå¸Œå€¼çš„é«˜8ä½ data byte[1] //key valueæ•°æ®:key/key/key/.../value/value/value... overflow *bmap //æº¢å‡ºbucketçš„åœ°å€ } æ¯ä¸ªbucketå¯ä»¥å­˜å‚¨8ä¸ªé”®å€¼å¯¹ã€‚\ntophashæ˜¯ä¸ªé•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œå“ˆå¸Œå€¼ç›¸åŒçš„é”®ï¼ˆå‡†ç¡®çš„è¯´æ˜¯å“ˆå¸Œå€¼ä½ä½ç›¸åŒçš„é”®ï¼‰å­˜å…¥å½“å‰bucketæ—¶ä¼šå°†å“ˆå¸Œå€¼çš„é«˜ä½å­˜å‚¨åœ¨è¯¥æ•°ç»„ä¸­ï¼Œä»¥æ–¹ä¾¿åç»­åŒ¹é…ã€‚ dataåŒºå­˜æ”¾çš„æ˜¯key-valueæ•°æ®ï¼Œå­˜æ”¾é¡ºåºæ˜¯key/key/key/â€¦value/value/valueï¼Œå¦‚æ­¤å­˜æ”¾æ˜¯ä¸ºäº†èŠ‚çœå­—èŠ‚å¯¹é½å¸¦æ¥çš„ç©ºé—´æµªè´¹ã€‚ overflow æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªbucketï¼Œæ®æ­¤å°†æ‰€æœ‰å†²çªçš„é”®è¿æ¥èµ·æ¥ã€‚ ä¸‹å›¾å±•ç¤ºbucketå­˜æ”¾8ä¸ªkey-valueå¯¹ï¼š\nå“ˆå¸Œå†²çª å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«å“ˆå¸Œåˆ°äº†åŒä¸€ä¸ªbucketæ—¶ï¼Œæˆ‘ä»¬ç§°è¿™äº›é”®å‘ç”Ÿäº†å†²çªã€‚Goä½¿ç”¨é“¾åœ°å€æ³•æ¥è§£å†³é”®å†²çªã€‚ç”±äºæ¯ä¸ªbucketå¯ä»¥å­˜æ”¾8ä¸ªé”®å€¼å¯¹ï¼Œæ‰€ä»¥åŒä¸€ä¸ªbucketå­˜æ”¾è¶…è¿‡8ä¸ªé”®å€¼å¯¹æ—¶å°±ä¼šå†åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œç”¨ç±»ä¼¼é“¾è¡¨çš„æ–¹å¼å°†bucketè¿æ¥èµ·æ¥ã€‚\nä¸‹å›¾å±•ç¤ºäº§ç”Ÿå†²çªåçš„mapï¼š\nbucketæ•°æ®ç»“æ„æŒ‡ç¤ºä¸‹ä¸€ä¸ªbucketçš„æŒ‡é’ˆç§°ä¸ºoverflow bucketï¼Œæ„ä¸ºå½“å‰bucketç››ä¸ä¸‹è€Œæº¢å‡ºçš„éƒ¨åˆ†ã€‚äº‹å®ä¸Šå“ˆå¸Œå†²çªå¹¶ä¸æ˜¯å¥½äº‹æƒ…ï¼Œå®ƒé™ä½äº†å­˜å–æ•ˆç‡ï¼Œå¥½çš„å“ˆå¸Œç®—æ³•å¯ä»¥ä¿è¯å“ˆå¸Œå€¼çš„éšæœºæ€§ï¼Œä½†å†²çªè¿‡å¤šä¹Ÿæ˜¯è¦æ§åˆ¶çš„ï¼Œåé¢ä¼šå†è¯¦ç»†ä»‹ç»ã€‚\nè´Ÿè½½å› å­ è´Ÿè½½å› å­ç”¨äºè¡¡é‡ä¸€ä¸ªå“ˆå¸Œè¡¨å†²çªæƒ…å†µï¼Œå…¬å¼ä¸ºï¼š\n1 è´Ÿè½½å› å­ = é”®æ•°é‡/bucketæ•°é‡ å“ˆå¸Œè¡¨éœ€è¦å°†è´Ÿè½½å› å­æ§åˆ¶åœ¨åˆé€‚çš„å¤§å°ï¼Œè¶…è¿‡å…¶é˜€å€¼éœ€è¦è¿›è¡Œrehashï¼Œä¹Ÿå³é”®å€¼å¯¹é‡æ–°ç»„ç»‡ï¼š\nå“ˆå¸Œå› å­è¿‡å°ï¼Œè¯´æ˜ç©ºé—´åˆ©ç”¨ç‡ä½ å“ˆå¸Œå› å­è¿‡å¤§ï¼Œè¯´æ˜å†²çªä¸¥é‡ï¼Œå­˜å–æ•ˆç‡ä½ æ¯ä¸ªå“ˆå¸Œè¡¨çš„å®ç°å¯¹è´Ÿè½½å› å­å®¹å¿ç¨‹åº¦ä¸åŒï¼Œæ¯”å¦‚Rediså®ç°ä¸­è´Ÿè½½å› å­å¤§äº1æ—¶å°±ä¼šè§¦å‘rehashï¼Œè€ŒGoåˆ™åœ¨åœ¨è´Ÿè½½å› å­è¾¾åˆ°6.5æ—¶æ‰ä¼šè§¦å‘rehashï¼Œå› ä¸ºRedisçš„æ¯ä¸ªbucketåªèƒ½å­˜1ä¸ªé”®å€¼å¯¹ï¼Œè€ŒGoçš„bucketå¯èƒ½å­˜8ä¸ªé”®å€¼å¯¹ï¼Œæ‰€ä»¥Goå¯ä»¥å®¹å¿æ›´é«˜çš„è´Ÿè½½å› å­ã€‚\næ¸è¿›å¼æ‰©å®¹ ä¸ºäº†ä¿è¯è®¿é—®æ•ˆç‡ï¼Œå½“æ–°å…ƒç´ å°†è¦æ·»åŠ è¿›mapæ—¶ï¼Œéƒ½ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œæ‰©å®¹å®é™…ä¸Šæ˜¯ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ‰‹æ®µã€‚è§¦å‘æ‰©å®¹çš„æ¡ä»¶æœ‰äºŒä¸ªï¼š\nè´Ÿè½½å› å­ \u0026gt; 6.5æ—¶ï¼Œä¹Ÿå³å¹³å‡æ¯ä¸ªbucketå­˜å‚¨çš„é”®å€¼å¯¹è¾¾åˆ°6.5ä¸ªã€‚ overflowæ•°é‡ \u0026gt; 2^15æ—¶ï¼Œä¹Ÿå³overflowæ•°é‡è¶…è¿‡32768æ—¶ã€‚ å¢é‡æ‰©å®¹ å½“è´Ÿè½½å› å­è¿‡å¤§æ—¶ï¼Œå°±æ–°å»ºä¸€ä¸ªbucketï¼Œæ–°çš„bucketé•¿åº¦æ˜¯åŸæ¥çš„2å€ï¼Œç„¶åæ—§bucketæ•°æ®æ¬è¿åˆ°æ–°çš„bucketã€‚è€ƒè™‘åˆ°å¦‚æœmapå­˜å‚¨äº†æ•°ä»¥äº¿è®¡çš„key-valueï¼Œä¸€æ¬¡æ€§æ¬è¿å°†ä¼šé€ æˆæ¯”è¾ƒå¤§çš„å»¶æ—¶ï¼ŒGoé‡‡ç”¨é€æ­¥æ¬è¿ç­–ç•¥ï¼Œå³æ¯æ¬¡è®¿é—®mapæ—¶éƒ½ä¼šè§¦å‘ä¸€æ¬¡æ¬è¿ï¼Œæ¯æ¬¡æ¬è¿2ä¸ªé”®å€¼å¯¹ã€‚\nä¸‹å›¾å±•ç¤ºäº†åŒ…å«ä¸€ä¸ªbucketæ»¡è½½çš„map(ä¸ºäº†æè¿°æ–¹ä¾¿ï¼Œå›¾ä¸­bucketçœç•¥äº†valueåŒºåŸŸ):\nå½“å‰mapå­˜å‚¨äº†7ä¸ªé”®å€¼å¯¹ï¼Œåªæœ‰1ä¸ªbucketã€‚æ­¤åœ°è´Ÿè½½å› å­ä¸º7ã€‚å†æ¬¡æ’å…¥æ•°æ®æ—¶å°†ä¼šè§¦å‘æ‰©å®¹æ“ä½œï¼Œæ‰©å®¹ä¹‹åå†å°†æ–°æ’å…¥é”®å†™å…¥æ–°çš„bucketã€‚\nå½“ç¬¬8ä¸ªé”®å€¼å¯¹æ’å…¥æ—¶ï¼Œå°†ä¼šè§¦å‘æ‰©å®¹ï¼Œæ‰©å®¹åç¤ºæ„å›¾å¦‚ä¸‹ï¼š\nhmapæ•°æ®ç»“æ„ä¸­oldbucketsæˆå‘˜æŒ‡èº«åŸbucketï¼Œè€ŒbucketsæŒ‡å‘äº†æ–°ç”³è¯·çš„bucketã€‚æ–°çš„é”®å€¼å¯¹è¢«æ’å…¥æ–°çš„bucketä¸­ã€‚åç»­å¯¹mapçš„è®¿é—®æ“ä½œä¼šè§¦å‘è¿ç§»ï¼Œå°†oldbucketsä¸­çš„é”®å€¼å¯¹é€æ­¥çš„æ¬è¿è¿‡æ¥ã€‚å½“oldbucketsä¸­çš„é”®å€¼å¯¹å…¨éƒ¨æ¬è¿å®Œæ¯•åï¼Œåˆ é™¤oldbucketsã€‚\næ¬è¿å®Œæˆåçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\næ•°æ®æ¬è¿è¿‡ç¨‹ä¸­åŸbucketä¸­çš„é”®å€¼å¯¹å°†å­˜åœ¨äºæ–°bucketçš„å‰é¢ï¼Œæ–°æ’å…¥çš„é”®å€¼å¯¹å°†å­˜åœ¨äºæ–°bucketçš„åé¢ã€‚å®é™…æ¬è¿è¿‡ç¨‹ä¸­æ¯”è¾ƒå¤æ‚ï¼Œå°†åœ¨åç»­æºç åˆ†æä¸­è¯¦ç»†ä»‹ç»ã€‚\nç­‰é‡æ‰©å®¹ æ‰€è°“ç­‰é‡æ‰©å®¹ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯æ‰©å¤§å®¹é‡ï¼Œbucketsæ•°é‡ä¸å˜ï¼Œé‡æ–°åšä¸€éç±»ä¼¼å¢é‡æ‰©å®¹çš„æ¬è¿åŠ¨ä½œï¼ŒæŠŠæ¾æ•£çš„é”®å€¼å¯¹é‡æ–°æ’åˆ—ä¸€æ¬¡ï¼Œä»¥ä½¿bucketçš„ä½¿ç”¨ç‡æ›´é«˜ï¼Œè¿›è€Œä¿è¯æ›´å¿«çš„å­˜å–ã€‚åœ¨æç«¯åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚ä¸æ–­çš„å¢åˆ ï¼Œè€Œé”®å€¼å¯¹æ­£å¥½é›†ä¸­åœ¨ä¸€å°éƒ¨åˆ†çš„bucketï¼Œè¿™æ ·ä¼šé€ æˆoverflowçš„bucketæ•°é‡å¢å¤šï¼Œä½†è´Ÿè½½å› å­åˆä¸é«˜ï¼Œä»è€Œæ— æ³•æ‰§è¡Œå¢é‡æ¬è¿çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä¸Šå›¾å¯è§ï¼Œoverflowçš„bucktä¸­å¤§éƒ¨åˆ†æ˜¯ç©ºçš„ï¼Œè®¿é—®æ•ˆç‡ä¼šå¾ˆå·®ã€‚æ­¤æ—¶è¿›è¡Œä¸€æ¬¡ç­‰é‡æ‰©å®¹ï¼Œå³bucketsæ•°é‡ä¸å˜ï¼Œç»è¿‡é‡æ–°ç»„ç»‡åoverflowçš„bucketæ•°é‡ä¼šå‡å°‘ï¼Œå³èŠ‚çœäº†ç©ºé—´åˆä¼šæé«˜è®¿é—®æ•ˆç‡ã€‚\næŸ¥æ‰¾è¿‡ç¨‹ æŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š\nè·Ÿæ®keyå€¼ç®—å‡ºå“ˆå¸Œå€¼ å–å“ˆå¸Œå€¼ä½ä½ä¸hmpa.Bå–æ¨¡ç¡®å®šbucketä½ç½® å–å“ˆå¸Œå€¼é«˜ä½åœ¨tophashæ•°ç»„ä¸­æŸ¥è¯¢ å¦‚æœtophash[i]ä¸­å­˜å‚¨å€¼ä¹Ÿå“ˆå¸Œå€¼ç›¸ç­‰ï¼Œåˆ™å»æ‰¾åˆ°è¯¥bucketä¸­çš„keyå€¼è¿›è¡Œæ¯”è¾ƒ å½“å‰bucketæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ç»§ç»­ä»ä¸‹ä¸ªoverflowçš„bucketä¸­æŸ¥æ‰¾ã€‚ å¦‚æœå½“å‰å¤„äºæ¬è¿è¿‡ç¨‹ï¼Œåˆ™ä¼˜å…ˆä»oldbucketsæŸ¥æ‰¾ æ³¨ï¼šå¦‚æœæŸ¥æ‰¾ä¸åˆ°ï¼Œä¹Ÿä¸ä¼šè¿”å›ç©ºå€¼ï¼Œè€Œæ˜¯è¿”å›ç›¸åº”ç±»å‹çš„0å€¼ã€‚\næ’å…¥è¿‡ç¨‹ æ–°å‘˜ç´ æ’å…¥è¿‡ç¨‹å¦‚ä¸‹ï¼š\nè·Ÿæ®keyå€¼ç®—å‡ºå“ˆå¸Œå€¼ å–å“ˆå¸Œå€¼ä½ä½ä¸hmap.Bå–æ¨¡ç¡®å®šbucketä½ç½® æŸ¥æ‰¾è¯¥keyæ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥æ›´æ–°å€¼ å¦‚æœæ²¡æ‰¾åˆ°å°†keyï¼Œå°†keyæ’å…¥ ","date":"2019-11-04T11:00:00Z","permalink":"https://blog.golang.space/p/8.map/","title":"8.map"},{"content":"1. æ•°ç»„ array æ•°ç»„æ˜¯å®šé•¿çš„ï¼Œé•¿åº¦ä¸€æ—¦å®šä¹‰ï¼Œä¸èƒ½æ›´æ”¹ã€‚\n1.1. å¦‚ä½•å£°æ˜? å£°æ˜æ•°ç»„ï¼Œæ³¨æ„è¦æŒ‡å®šé•¿åº¦ã€‚å¦‚æœæœªæŒ‡å®šé•¿åº¦å¯ä½¿ç”¨çœç•¥å·ï¼Œå°†ä¼šæŒ‰é•¿åº¦åˆå§‹åŒ–å€¼çš„ä¸ªæ•°è¿›è¡Œè®¡ç®—ã€‚\n1 2 3 var a [3]int v := [...]int{1,2,3} q := [3]int{1, 2, 3, 4} // ç¼–è¯‘é”™è¯¯: cannot assign [4]int to [3]int å¤šç»´æ•°ç»„åˆå§‹åŒ–\n1 var grid [4][5]int{{1,2},{4,5}} æŒ‡å®šç´¢å¼•åˆå§‹åŒ–\n1 v1 := [...]string{1:\u0026#34;1\u0026#34;,5:\u0026#34;5\u0026#34;,9:\u0026#34;9\u0026#34;} 1.2. é›¶å€¼ æ•°ç»„æ˜¯å€¼ç±»å‹\nå£°æ˜æ•°ç»„åä¸èµ‹å€¼ï¼Œåˆ™æ¯ä¸ªå…ƒç´ éƒ½è¢«åˆå§‹åŒ–é›¶å€¼ï¼Œæ¯”å¦‚ int ç±»å‹ä¼šåˆå§‹åŒ–ä¸º 0ã€‚\n1.3. ç‰¹æ€§ Go è¯­è¨€ä¸­æ•°ç»„åœ¨åˆå§‹åŒ–ä¹‹åå¤§å°å°±æ— æ³•æ”¹å˜ï¼Œå­˜å‚¨å…ƒç´ ç±»å‹ç›¸åŒã€ä½†æ˜¯å¤§å°ä¸åŒçš„æ•°ç»„ç±»å‹åœ¨ Go è¯­è¨€çœ‹æ¥ä¹Ÿæ˜¯å®Œå…¨ä¸åŒçš„ï¼Œåªæœ‰ä¸¤ä¸ªæ¡ä»¶éƒ½ç›¸åŒæ‰æ˜¯åŒä¸€ä¸ªç±»å‹ã€‚\n1 2 3 var a1 [3]int var a2 [5]int fmt.Printf(\u0026#34;%T != %T\u0026#34;, a1, a2) ä¸¤ç§ä¸åŒçš„ä¼˜åŒ– cmd/compile/internal/gc.anylit\nå½“å…ƒç´ æ•°é‡å°äºæˆ–è€…ç­‰äº 4 ä¸ªæ—¶ï¼Œä¼šç›´æ¥å°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åœ¨æ ˆä¸Šï¼› å½“å…ƒç´ æ•°é‡å¤§äº 4 ä¸ªæ—¶ï¼Œä¼šå°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åˆ°é™æ€åŒºå¹¶åœ¨è¿è¡Œæ—¶å–å‡ºï¼› 1.4. å…ƒç´ æ¯”è¾ƒ éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶\nå¦‚æœæ•°ç»„çš„å…ƒç´ ç±»å‹å¯æ¯”è¾ƒï¼Œåˆ™æ•°ç»„ä¹Ÿå¯ä»¥æ¯”è¾ƒ ç»´æ•°ç›¸åŒï¼Œå«æœ‰å…ƒç´ ä¸ªæ•°ç›¸åŒ 1.5. éå†æ•°ç»„ 1 2 3 for i,v := range arr { fmt.Println(i,v) } 1.6. ä½œä¸ºå‡½æ•°å‚æ•° è°ƒç”¨ func instance(arr [5]int ) ä¼šæ‹·è´æ•°ç»„\nå‡½æ•°å‚æ•°å˜é‡æ¥æ”¶çš„æ˜¯ä¸€ä¸ªå¤åˆ¶çš„å‰¯æœ¬ï¼Œå¹¶ä¸æ˜¯åŸå§‹è°ƒç”¨çš„å˜é‡ã€‚å› ä¸ºå‡½æ•°å‚æ•°ä¼ é€’çš„æœºåˆ¶å¯¼è‡´ä¼ é€’å¤§çš„æ•°ç»„ç±»å‹å°†æ˜¯ä½æ•ˆçš„ï¼Œå¹¶ä¸”å¯¹æ•°ç»„å‚æ•°çš„ä»»ä½•çš„ä¿®æ”¹éƒ½æ˜¯å‘ç”Ÿåœ¨å¤åˆ¶çš„æ•°ç»„ä¸Šï¼Œå¹¶ä¸èƒ½ç›´æ¥ä¿®æ”¹è°ƒç”¨æ—¶åŸå§‹çš„æ•°ç»„å˜é‡ã€‚\n1.7. ç¼–è¯‘åˆå§‹åŒ– ç¼–è¯‘å™¨ä¼šåœ¨è´Ÿè´£åˆå§‹åŒ–å­—é¢é‡çš„ cmd/compile/internal/gc.anylit å‡½æ•°ä¸­åšä¸¤ç§ä¸åŒçš„ä¼˜åŒ–ï¼š\nå½“å…ƒç´ æ•°é‡å°äºæˆ–è€…ç­‰äº 4 ä¸ªæ—¶ï¼Œä¼šç›´æ¥å°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åœ¨æ ˆä¸Šï¼› å½“å…ƒç´ æ•°é‡å¤§äº 4 ä¸ªæ—¶ï¼Œä¼šå°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åˆ°é™æ€åŒºå¹¶åœ¨è¿è¡Œæ—¶å–å‡ºæ‹·è´åˆ°æ ˆä¸Šï¼› 2. åˆ‡ç‰‡ slice åˆ‡ç‰‡ slice æœ¬èº«æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œæ˜¯å¯¹åº•å±‚ array çš„ä¸€ä¸ª view\n2.1. å¦‚ä½•å£°æ˜? å£°æ˜ä¸º nil çš„ç©ºåˆ‡ç‰‡ï¼Œåº•å±‚æ•°ç»„æŒ‡é’ˆ = nilï¼Œä½œä¸ºå‡½æ•°çš„å®å‚ä¹Ÿæ˜¯ nil, å¯ä»¥æ±‚é•¿åº¦,ç»“æœä¸º 0\næ³¨æ„ç©ºåˆ‡ç‰‡å¯ä»¥ append å¢åŠ å…ƒç´ ï¼Œå¯ä»¥åŠ¨æ€æ‰©å±•å†…å­˜ã€‚åŒæ ·ä¸º nil çš„map ä¸è¡Œï¼Œå¯¹ç©º map å¢åŠ é”®å€¼å¯¹ä¼š panicã€‚\n1 var arr []int 1 2 s2 := []int{} // ç©ºåˆ‡ç‰‡,åˆ›å»ºäº†é•¿åº¦å’Œå®¹é‡éƒ½æ˜¯0çš„åº•å±‚æ•°ç»„ s3 := arr[0:2:cap(arr)] // len=2; cap=cap(arr) å£°æ˜ len=10, cap=32 çš„ sliceï¼Œä¼šåˆå§‹åŒ– 10 ä¸ªé›¶å€¼\n1 s1 := make([]int, 10 , 32) // ç±»å‹,len, cap 2.2. å–å†…å®¹ å¤šä¸ªsliceä¹‹é—´å¯ä»¥å…±äº«åº•å±‚çš„æ•°æ®ï¼Œå¹¶ä¸”å¼•ç”¨çš„æ•°ç»„éƒ¨åˆ†åŒºé—´å¯èƒ½é‡å ã€‚\n1 2 3 4 5 arr := []int{0,1,2,3,4,5,6,7,8,9} s := arr[2:6] // s = [2,3,4,5] s := arr[:6] // s = [0,1,2,3,4,5] s := arr[6:] // s = [6,7,8,9] s := arr[:] // 0,1,2,3,4,5,6,7,8,9 åˆ‡ç‰‡æ“ä½œè¶…å‡ºcap(s)çš„ä¸Šé™å°†å¯¼è‡´ä¸€ä¸ªpanicå¼‚å¸¸ï¼Œä½†æ˜¯è¶…å‡ºlen(s)åˆ™æ˜¯æ„å‘³ç€æ‰©å±•äº†slice\n1 2 3 4 5 func TestSlice(t *testing.T) { arr := make([]int, 5, 9) fmt.Println(arr[5]) // error fmt.Println(arr[4:7]) // æ‰©å±• } x[m:n]åˆ‡ç‰‡æ“ä½œå¯¹äºå­—ç¬¦ä¸²åˆ™ç”Ÿæˆä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œå¦‚æœxæ˜¯[]byteçš„è¯åˆ™ç”Ÿæˆä¸€ä¸ªæ–°çš„[]byteã€‚\n2.3. æ‹¼æ¥ slice \u0026hellip; å¯å˜å‚æ•°åˆ—è¡¨, åœ¨å‡½æ•°ä¸­å¯ä»¥ value ...int ç”¨æ¥è§£æåˆ—è¡¨, åœ¨ä¼ é€’å‚æ•°ä¸­ä½¿ç”¨ arr\u0026hellip; å¯ä»¥å°†æ•°ç»„è§£ææˆå‚æ•°åˆ—è¡¨\n1 s1 = append(s1[:3], s2[4:]...) 2.4. å¦‚ä½•åˆ é™¤å…ƒç´ ? åˆ é™¤ä¸­é—´çš„å…ƒç´ \n1 2 3 4 arr := []int{1, 2, 3, 4} i := 1 fmt.Println(append(arr[0:i], arr[i+1:]...)) fmt.Println(arr[:i+copy(arr[i:], arr[i+1:])]) 2.5. ä½œä¸ºå‡½æ•°å‚æ•° å› ä¸ºsliceå€¼åŒ…å«æŒ‡å‘ç¬¬ä¸€ä¸ªsliceå…ƒç´ çš„æŒ‡é’ˆ ( åé¢ä»‹ç» slice çš„æºç )ï¼Œå› æ­¤å‘å‡½æ•°ä¼ é€’sliceå°†å…è®¸åœ¨å‡½æ•°å†…éƒ¨ä¿®æ”¹åº•å±‚æ•°ç»„çš„å…ƒç´ ã€‚\nå¤åˆ¶ä¸€ä¸ªsliceåªæ˜¯å¯¹åº•å±‚çš„æ•°ç»„åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ slice åˆ«å\n1 2 3 4 5 6 7 8 9 func change(arr []int){ arr[0] = 100 } func main(){ arr := [5]int{1,2,3,4,5} change(arr[:]) // arr = 100,2,3,4,5 } Go è¯­è¨€åªæœ‰å€¼ä¼ é€’\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func TestSlice2(t *testing.T) { s1 := make([]int, 0, 10) // Go è¯­è¨€åªæœ‰å€¼ä¼ é€’ appendFunc := func(s []int) { s = append(s, 10, 20, 30) fmt.Println(s) } fmt.Println(s1) appendFunc(s1) fmt.Println(s1) fmt.Println(s1[:10]) } // ç»“æœ // [] // [10 20 30] // [] // [10 20 30 0 0 0 0 0 0 0] åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåˆ‡ç‰‡å€¼ä¼ é€’è¿‡å»ï¼Œä½¿ç”¨ append ä¿®æ”¹ï¼Œæ”¹å˜äº†å‡½æ•°å…¥å‚ s çš„ len å’Œ capï¼Œä½†æ²¡æœ‰æ”¹å˜ s1 çš„ len å’Œ capã€‚\n3. ä¸¤è€…åŒºåˆ« æ•°ç»„éœ€è¦æŒ‡å®šé•¿åº¦ æ•°ç»„çš„é•¿åº¦æ˜¯å›ºå®šçš„, åˆ‡ç‰‡æ˜¯å¯å˜çš„ ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œæ•°ç»„æ˜¯å€¼æ‹·è´ï¼Œåˆ‡ç‰‡\u0026hellip;.. 4. çœ‹çœ‹ slice çš„ç»“æ„ è¯‘æœŸé—´çš„åˆ‡ç‰‡æ˜¯ cmd/compile/internal/types.Slice ç±»å‹çš„ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶åˆ‡ç‰‡å¯ä»¥ç”±å¦‚ä¸‹çš„ reflect.SliceHeader ç»“æ„ä½“è¡¨ç¤º\n1 2 3 4 5 6 7 8 9 10 11 12 13 // go@1.16.5 runtime/slice.go type slice struct { array unsafe.Pointer // åº•å±‚æ•°ç»„ len int\tcap int } // reflect/value.go SliceHeader æ˜¯slice åœ¨è¿è¡Œæ—¶çš„è¡¨ç¤º type SliceHeader struct { Data uintptr // è¿ç»­ç©ºé—´ Len int // åˆ‡ç‰‡é•¿åº¦ Cap int // å®¹é‡ } ä¸€ä¸ª slice ç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼šæŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡ã€‚\næŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªsliceå…ƒç´ å¯¹åº”çš„åº•å±‚æ•°ç»„å…ƒç´ çš„åœ°å€ï¼Œè¦æ³¨æ„çš„æ˜¯sliceçš„ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶ä¸ä¸€å®šå°±æ˜¯æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚\né•¿åº¦å¯¹åº”sliceä¸­å…ƒç´ çš„æ•°ç›®ï¼›é•¿åº¦ä¸èƒ½è¶…è¿‡å®¹é‡ï¼Œå®¹é‡ä¸€èˆ¬æ˜¯ä»sliceçš„å¼€å§‹ä½ç½®åˆ°åº•å±‚æ•°æ®çš„ç»“å°¾ä½ç½®ã€‚\nå†…ç½®çš„lenå’Œcapå‡½æ•°åˆ†åˆ«è¿”å›sliceçš„é•¿åº¦å’Œå®¹é‡ã€‚\nslice ä¸èƒ½ç›´æ¥ä½¿ç”¨ == != æ¯”è¾ƒ\nåº•å±‚æ•°ç»„æ˜¯å¯ä»¥è¢«å¤šä¸ª slice åŒæ—¶æŒ‡å‘çš„ï¼Œå› æ­¤å¯¹ä¸€ä¸ª slice çš„å…ƒç´ è¿›è¡Œæ“ä½œæ˜¯æœ‰å¯èƒ½å½±å“åˆ°å…¶ä»– slice çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main import \u0026#34;fmt\u0026#34; func main() { slice := []int{0, 1, 2, 3, 4, 5, 6, 7, 8, 9} s1 := slice[2:5] // 2,3,4 s2 := s1[2:6:7] // 4,5,6,7 // æ³¨æ„è¿™ä¸ª7è¡¨ç¤ºæ˜¯2-\u0026gt;7 ä¹Ÿå°±æ˜¯å®¹é‡å¼€å§‹å’Œç»“æŸä½ç½® s2 = append(s2, 100) // 4,5,6,7,100 s2 = append(s2, 200) // 4,5,6,7,100,200 s1[2] = 20 // 2,3,20 fmt.Println(s1) // 2,3,20 fmt.Println(s2) // 4,5,6,7,100,200 fmt.Println(slice) // 0,1,2,3,20,5,6,7,100,9 } 5. å®ä¾‹ å¾ªç¯\nä¸€ç§å°†sliceå…ƒç´ å¾ªç¯å‘å·¦æ—‹è½¬nä¸ªå…ƒç´ çš„æ–¹æ³•æ˜¯ä¸‰æ¬¡è°ƒç”¨reverseåè½¬å‡½æ•°ï¼Œç¬¬ä¸€æ¬¡æ˜¯åè½¬å¼€å¤´çš„nä¸ªå…ƒç´ ï¼Œç„¶åæ˜¯åè½¬å‰©ä¸‹çš„å…ƒç´ ï¼Œæœ€åæ˜¯åè½¬æ•´ä¸ªsliceçš„å…ƒç´ ã€‚ï¼ˆå¦‚æœæ˜¯å‘å³å¾ªç¯æ—‹è½¬ï¼Œåˆ™å°†ç¬¬ä¸‰ä¸ªå‡½æ•°è°ƒç”¨ç§»åˆ°ç¬¬ä¸€ä¸ªè°ƒç”¨ä½ç½®å°±å¯ä»¥äº†ã€‚ï¼‰\n1 2 3 4 5 6 s := []int{0, 1, 2, 3, 4, 5} // Rotate s left by two positions. reverse(s[:2]) reverse(s[2:]) reverse(s) fmt.Println(s) // \u0026#34;[2 3 4 5 0 1]\u0026#34; æ‰©å±•ç”¨æ³•\ns1 å¯¹ arr å–å€¼, s2 å¯¹ s1 å–å€¼\u0026quot;ä¸‹æ ‡è¶Šç•Œ\u0026quot;, ä½† slice æ˜¯ view è§†å›¾, å®é™…å–å€¼æ˜¯å¯¹åŸæ•°ç»„æ“ä½œ, è¿˜æ˜¯ä¼šå¾—åˆ°æ­£ç¡®çš„å€¼, s2 ä¸­çš„ 3:5 ä¸­ 3 çš„ä½ç½®æ˜¯ç›¸å¯¹äº s1\nå³ slice å¯ä»¥å‘åæ‰©å±•, ä¸èƒ½è¶Šç•Œ, ä¸èƒ½å‘å‰æ‰©å±•\n1 2 3 s1 = arr[2:6] s2 = s1[3:5] // å³ s1[2] = s2[0] , å¯¹åˆ‡ç‰‡ä½¿ç”¨append\nå‡½æ•°åŸå‹\n1 2 // go@1.16.5 buitltin/builtin.go func append(slice []Type, elems ...Type) []Type è™½ç„¶åœ¨æ‰©å®¹çš„æ—¶å€™ Go è¯­è¨€ä¸€å®šä¼šç”Ÿæˆæ–°çš„åº•å±‚æ•°ç»„ï¼Œä½†æ˜¯å®ƒä¹ŸåŒæ—¶ç”Ÿæˆäº†æ–°çš„åˆ‡ç‰‡ã€‚å®ƒæ˜¯æŠŠæ–°çš„åˆ‡ç‰‡ä½œä¸ºäº†æ–°åº•å±‚æ•°ç»„çš„çª—å£ï¼Œè€Œæ²¡æœ‰å¯¹åŸåˆ‡ç‰‡åŠå…¶åº•å±‚æ•°ç»„åšä»»ä½•æ”¹åŠ¨ã€‚\nè¯·è®°ä½ï¼Œåœ¨æ— éœ€æ‰©å®¹æ—¶ï¼Œappendå‡½æ•°è¿”å›çš„æ˜¯æŒ‡å‘åŸåº•å±‚æ•°ç»„çš„æ–°åˆ‡ç‰‡ï¼Œè€Œåœ¨éœ€è¦æ‰©å®¹æ—¶ï¼Œappendå‡½æ•°è¿”å›çš„æ˜¯æŒ‡å‘æ–°åº•å±‚æ•°ç»„çš„æ–°åˆ‡ç‰‡ã€‚æ‰€ä»¥ï¼Œä¸¥æ ¼æ¥è®²ï¼Œâ€œæ‰©å®¹â€è¿™ä¸ªè¯ç”¨åœ¨è¿™é‡Œè™½ç„¶å½¢è±¡ä½†å¹¶ä¸åˆé€‚ã€‚\né¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œåªè¦æ–°é•¿åº¦ä¸ä¼šè¶…è¿‡åˆ‡ç‰‡çš„åŸå®¹é‡ï¼Œé‚£ä¹ˆä½¿ç”¨appendå‡½æ•°å¯¹å…¶è¿½åŠ å…ƒç´ çš„æ—¶å€™å°±ä¸ä¼šå¼•èµ·æ‰©å®¹ã€‚è¿™åªä¼šä½¿ç´§é‚»åˆ‡ç‰‡çª—å£å³è¾¹çš„ï¼ˆåº•å±‚æ•°ç»„ä¸­çš„ï¼‰å…ƒç´ è¢«æ–°çš„å…ƒç´ æ›¿æ¢æ‰\n1 2 3 4 5 6 // s1 = [2,3,4,5] s1 = s1.append(s1,100) // s1 = [2,3,4,5,100] // arr = [0,1,2,3,4,5,100,7,8,9] // å½“ æ·»åŠ åçš„ cap \u0026lt; åŸæ•°ç»„ cap æ—¶, åœ¨åŸæ•°ç»„ä¸Šè¿›è¡Œæ›¿æ¢ // æ·»åŠ åçš„ cap \u0026gt; æºæ•°ç»„ cap æ—¶, go å°†æ–°åˆ†é…ä¸€ä¸ªæ•°ç»„ æ‰©å®¹è§„åˆ™\nGo 1.18 å¯¹è§„åˆ™åšäº†ä¼˜åŒ–ï¼Œä»¥ä¸‹è§„åˆ™ä»…é€‚ç”¨äº \u0026lt;= 1.17 çš„ç‰ˆæœ¬ï¼Œè¯¦ç»†è¯·è§æœ€æ–°çš„ç¬”è®°ã€‚\né¢„ä¼°æ‰©å®¹åçš„å®¹é‡ oldCap * 2 \u0026lt; cap åˆ™ newCap = cap å¦åˆ™ oldLen \u0026lt; 1024 ç¿»å€æ‰©å®¹ï¼Œå³ newCap = oldCap*2 oldLen \u0026gt;= 1024ï¼Œæ‰©å®¹ 1/4ï¼Œå³ newCap = oldCap*1.25 æœ€åï¼Œè¿›è¡Œå†…å­˜å¯¹é½ éœ€è¦å¤šå¤§å†…å­˜?\nå†…å­˜ç®¡ç†æ¨¡å—ä¼šæå‰ç”³è¯·å†…å­˜ï¼Œåˆ†æˆä¸åŒè§„æ ¼ç®¡ç†èµ·æ¥ã€‚\n1 2 3 4 5 6 7 // go@1.16.5 runtime/sizeclasses.go // è¿™ä¸ªå€¼å–çš„æ˜¯ 8* (2,x) ï¼Œx ä¸ºé€’å¢å˜é‡ var class_to_size = [_NumSizeClasses]uint16{0, 8, 16, 24, 32, 48, 64, 80, 96, 112, 128, 144, 160, 176, 192, 208, 224, 240, 256, 288, 320, 352, 384, 416, 448, 480, 512, 576, 640, 704, 768, 896, 1024, 1152, 1280, 1408, 1536, 1792, 2048, 2304, 2688, 3072, 3200, 3456, 4096, 4864, 5376, 6144, 6528, 6784, 6912, 8192, 9472, 9728, 10240, 10880, 12288, 13568, 14336, 16384, 18432, 19072, 20480, 21760, 24576, 27264, 28672, 32768} var size_to_class8 = [smallSizeMax/smallSizeDiv + 1]uint8{0, 1, 2, 3, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 22, 22, 22, 22, 23, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 25, 26, 26, 26, 26, 27, 27, 27, 27, 27, 27, 27, 27, 28, 28, 28, 28, 28, 28, 28, 28, 29, 29, 29, 29, 29, 29, 29, 29, 30, 30, 30, 30, 30, 30, 30, 30, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32} ä¾‹å¦‚é€šè¿‡ append çš„å¾—åˆ° []int{1,2,3,4,5} ä¸€å…±æ˜¯ 5*8=40 å­—èŠ‚ï¼ŒæŸ¥è¡¨å¯çŸ¥æœ€è¿‘æ¥ 40 çš„å€¼æ˜¯ 48ï¼Œå³å ç”¨å†…å­˜ 48 å­—èŠ‚ï¼Œcap=6ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // go@1.16.5 runtine/slice.go // growslice å¤„ç†è¿½åŠ æœŸé—´çš„åˆ‡ç‰‡å¢é•¿ func growslice(et *_type, old slice, cap int) slice { // ...... // å¦‚æœæ‰©å®¹çš„æ•°æ®ï¼Œè¶…è¿‡ç°æœ‰ cap çš„ä¸¤å€ï¼Œåˆ™ä½¿ç”¨æ‰©å®¹æ•°æ®çš„é•¿åº¦ newcap := old.cap doublecap := newcap + newcap if cap \u0026gt; doublecap { newcap = cap } else { // å°äº 1024 æ—¶ï¼Œ2 å€é€’å¢ if old.cap \u0026lt; 1024 { newcap = doublecap } else { // é˜²æ­¢æº¢å‡º å’Œ æ— é™å¾ªç¯ for 0 \u0026lt; newcap \u0026amp;\u0026amp; newcap \u0026lt; cap { newcap += newcap / 4 } if newcap \u0026lt;= 0 { newcap = cap } } } var overflow bool var lenmem, newlenmem, capmem uintptr switch { case et.size == 1: lenmem = uintptr(old.len) newlenmem = uintptr(cap) capmem = roundupsize(uintptr(newcap)) overflow = uintptr(newcap) \u0026gt; maxAlloc newcap = int(capmem) case et.size == sys.PtrSize: lenmem = uintptr(old.len) * sys.PtrSize newlenmem = uintptr(cap) * sys.PtrSize capmem = roundupsize(uintptr(newcap) * sys.PtrSize) overflow = uintptr(newcap) \u0026gt; maxAlloc/sys.PtrSize newcap = int(capmem / sys.PtrSize) case isPowerOfTwo(et.size): var shift uintptr if sys.PtrSize == 8 { shift = uintptr(sys.Ctz64(uint64(et.size))) \u0026amp; 63 } else { shift = uintptr(sys.Ctz32(uint32(et.size))) \u0026amp; 31 } lenmem = uintptr(old.len) \u0026lt;\u0026lt; shift newlenmem = uintptr(cap) \u0026lt;\u0026lt; shift capmem = roundupsize(uintptr(newcap) \u0026lt;\u0026lt; shift) overflow = uintptr(newcap) \u0026gt; (maxAlloc \u0026gt;\u0026gt; shift) newcap = int(capmem \u0026gt;\u0026gt; shift) default: lenmem = uintptr(old.len) * et.size newlenmem = uintptr(cap) * et.size capmem, overflow = math.MulUintptr(et.size, uintptr(newcap)) capmem = roundupsize(capmem) newcap = int(capmem / et.size) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // go@1.16.5\truntime/msize.go // å†…å­˜å¯¹é½å‡½æ•° func roundupsize(size uintptr) uintptr { if size \u0026lt; _MaxSmallSize { if size \u0026lt;= smallSizeMax-8 { return uintptr(class_to_size[size_to_class8[divRoundUp(size, smallSizeDiv)]]) } else { return uintptr(class_to_size[size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)]]) } } if size+_PageSize \u0026lt; size { return size } return alignUp(size, _PageSize) } // go@1.16.5\truntime/stubs.go func divRoundUp(n, a uintptr) uintptr { // a is generally a power of two. This will get inlined and // the compiler will optimize the division. return (n + a - 1) / a } ä¾ç„¶ç”¨ä¸Šé¢çš„ä¾‹å­ï¼Œclass_to_size[size_to_class8[ n+a-1 ]] ï¼Œå¾—å‡º 48\n1 2 3 4 5 6 7 8 9 10 11 12 13 // ä¾‹é¢˜ func main() { s := []int{5} s = append(s, 7) s = append(s, 9) // s 5,7,9 x := append(s, 11) // x 5,7,9,11 y := append(s, 12) // x 5,7,9,12 fmt.Println(s, x, y) } æ•°ç»„åè½¬\n1 2 3 4 5 func reverse(s []int) { for i, j := 0, len(s)-1; i \u0026lt; j; i++,j-- { s[i], s[j] = s[j], s[i] } } bytes.Equal åˆ‡ç‰‡æ¯”è¾ƒ, bytes æä¾›äº† []byte ç±»å‹çš„æ¯”è¾ƒ , è‹¥æ˜¯å…¶å®ƒç±»å‹, è‡ªå·±å°è£…å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 func equal(x, y []string) bool { if len(x) != len(y) { return false } for i := range x { if x[i] != y[i] { return false } } return true } ","date":"2019-11-03T17:00:00Z","permalink":"https://blog.golang.space/p/7.%E6%95%B0%E7%BB%84%E5%92%8C%E5%88%87%E7%89%87/","title":"7.æ•°ç»„å’Œåˆ‡ç‰‡"},{"content":"å¾ªç¯ 1 2 for initialization; condition; post { } æ— é™å¾ªç¯\n1 for {} æ¡ä»¶å¾ªç¯\n1 for condition {} éå†æ•°ç»„ , i æ˜¯ä¸‹æ ‡\n1 2 for i := range arr{ } éå†æ•°ç»„, ä¸‹æ ‡å’Œå€¼\n1 2 for index,value := range arr{ } rangeçš„è¯­æ³•è¦æ±‚ï¼Œè¦å¤„ç†å…ƒç´ ï¼Œå¿…é¡»å¤„ç†ç´¢å¼•ã€‚ä¼šæ‹·è´ä¸€ä¸ªæ–°çš„å˜é‡ value , å¯¹ value åšä¿®æ”¹ä¸ä¼šå½±å“ arr\nåœ¨ for å¤šé‡å¾ªç¯ä¸­å¯ä»¥ä½¿ç”¨ break end è·³å‡ºæœ€å¤–å±‚å¾ªç¯, è¿™é‡Œçš„ eng æ˜¯å…³é”®å­—, æœ‰ç‚¹åƒæ˜¯ goto è¯­å¥ä¸€æ ·\nè·³å‡ºå¹¶ç»“æŸåµŒå¥—å¾ªç¯\n1 2 3 4 5 6 7 8 9 10 11 end: for i := 0; i \u0026lt; 5; i++ { for i := 0; i \u0026lt; 10; i++ { if i == 2 { break end } fmt.Printf(\u0026#34;%d\\n\u0026#34;, i) } } fmt.Println(\u0026#34;end\u0026#34;) } ç»“æœ\n1 2 3 0 1 end if è¯­å¥ ä¸å…¶ä»–è¯­è¨€çš„ä½¿ç”¨åŒºåˆ«, ä¸åŠ æ‹¬å·\n1 2 3 4 5 6 7 8 9 10 11 // å¦‚æœå½“å‰æ–‡ä»¶å¤¹ä¸‹æœ‰ abcd.txt æ–‡ä»¶, å°±æ–‡ä»¶è¾“å‡ºå†…å®¹ // å¦åˆ™è¾“å…¥é”™è¯¯ä¿¡æ¯ func main(){ const filename = \u0026#34;abcd.txt\u0026#34; // è¿”å› []byte å’Œ é”™è¯¯ä¿¡æ¯, å˜é‡ä½œç”¨åŸŸåœ¨ if è¯­å¥å†… if contents ,err := ioutil.ReadFile(filename);err != nil { fmt.Println(err) }else{ fmt.Printf(\u0026#34;%s\\n\u0026#34;, contents) } } switch switch ä¼šè‡ªåŠ¨ break, é™¤éä½¿ç”¨å…³é”®å­— fallthrough switch åé¢å¯ä»¥ä¸åŠ è¡¨è¾¾å¼, å°†è¡¨è¾¾å¼æ”¾åœ¨ case åé¢, é€»è¾‘ç­‰åŒ if else å•ä¸ª case ä¸­, å¯ä»¥å‡ºç°å¤šä¸ªç»“æœ, ä½¿ç”¨ é€—å·åˆ†éš” ","date":"2019-11-03T12:00:00Z","permalink":"https://blog.golang.space/p/6.%E6%9D%A1%E4%BB%B6/","title":"6.æ¡ä»¶"},{"content":"åŒ…å’Œæ–‡ä»¶ Go æ–‡ä»¶ä¸­çš„å†…éƒ¨ä¿¡æ¯, æ ¹æ®æ˜¯å¦å¤§å†™å­—æ¯å¼€å¤´åˆ¤æ–­æ˜¯å¦å¯¼å‡º\n1 2 var Str string // å…¶ä»–ç±»å¯¼å…¥åŒ…åå¯ä»¥è°ƒç”¨ var str string // åŒ…å†…å¯è°ƒç”¨ æŒ‰ç…§æƒ¯ä¾‹ï¼Œä¸€ä¸ªåŒ…çš„åå­—å’ŒåŒ…çš„å¯¼å…¥è·¯å¾„çš„æœ€åä¸€ä¸ªå­—æ®µç›¸åŒï¼Œä¾‹å¦‚gopl.io/ch2/tempconvåŒ…çš„åå­—ä¸€èˆ¬æ˜¯tempconvã€‚\nå¦‚æœå¯¼å…¥äº†ä¸€ä¸ªåŒ…ï¼Œä½†æ˜¯åˆæ²¡æœ‰ä½¿ç”¨è¯¥åŒ…å°†è¢«å½“ä½œä¸€ä¸ªç¼–è¯‘é”™è¯¯å¤„ç†ã€‚è¿™ç§å¼ºåˆ¶è§„åˆ™å¯ä»¥æœ‰æ•ˆå‡å°‘ä¸å¿…è¦çš„ä¾èµ–\nä½¿ç”¨ golang.org/x/tools/cmd/goimports è‡ªåŠ¨æ·»åŠ åˆ é™¤å¯¼å…¥åŒ…\nåŒ…çš„åˆå§‹åŒ– åŒ…çš„åˆå§‹åŒ–é¦–å…ˆæ˜¯è§£å†³åŒ…çº§å˜é‡çš„ä¾èµ–é¡ºåºï¼Œç„¶åæŒ‰ç…§åŒ…çº§å˜é‡å£°æ˜å‡ºç°çš„é¡ºåºä¾æ¬¡åˆå§‹åŒ–ï¼š\n1 2 3 4 5 var a = b + c // a ç¬¬ä¸‰ä¸ªåˆå§‹åŒ–, ä¸º 3 var b = f() // b ç¬¬äºŒä¸ªåˆå§‹åŒ–, ä¸º 2, é€šè¿‡è°ƒç”¨ f (ä¾èµ–c) var c = 1 // c ç¬¬ä¸€ä¸ªåˆå§‹åŒ–, ä¸º 1 func f() int { return c + 1 } å¦‚æœåŒ…ä¸­å«æœ‰å¤šä¸ª.goæºæ–‡ä»¶ï¼Œå®ƒä»¬å°†æŒ‰ç…§å‘ç»™ç¼–è¯‘å™¨çš„é¡ºåºè¿›è¡Œåˆå§‹åŒ–ï¼ŒGoè¯­è¨€çš„æ„å»ºå·¥å…·é¦–å…ˆä¼šå°†.goæ–‡ä»¶æ ¹æ®æ–‡ä»¶åæ’åºï¼Œç„¶åä¾æ¬¡è°ƒç”¨ç¼–è¯‘å™¨ç¼–è¯‘ã€‚\ninit å‡½æ•°ç‰¹ç‚¹ init ä¼˜å…ˆäº main è‡ªåŠ¨æ‰§è¡Œ , ä¸èƒ½è¢«å…¶å®ƒå‡½æ•°è°ƒç”¨ æ¯ä¸ªåŒ…å¯ä»¥æœ‰å¤šä¸ª init å‡½æ•° å¯¼å…¥åŒ…å‰ç¼€åŠ ä¸Š _ ä»…æ‰§è¡Œ è¯¥åŒ…çš„ å…¨å±€å˜é‡åˆå§‹åŒ–å’Œ init æ— å‚æ•°å£°æ˜å’Œç»“æœå£°æ˜ åœ¨æ¯ä¸ªæ–‡ä»¶ä¸­çš„initåˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶æŒ‰ç…§å®ƒä»¬å£°æ˜çš„é¡ºåºè¢«è‡ªåŠ¨è°ƒç”¨ã€‚ æ³¨ : ç¨‹åºä¸åº”è¯¥ä¾èµ–å„ä¸ªåŒ…çš„ init çš„æ‰§è¡Œé¡ºåº\ninit å¸¸ç”¨ç”¨é€” å®ç°åŒ…çº§å˜é‡å¤æ‚åˆå§‹åŒ–ï¼Œæ³¨: å°½é‡ä¸è¦ä½¿ç”¨ init å‡½æ•°æ¥åˆå§‹åŒ–åŒ…çº§å˜é‡ï¼Œå¦‚æ— å¿…è¦ï¼Œä¸è¦ä½¿ç”¨ init å‡½æ•°ï¼Œå‡å°‘ä»£ç å¤æ‚æ€§ã€‚\n1 2 3 4 5 6 7 8 var ProjectDebug = false func init(){ e := os.Getenv(\u0026#34;PROJECT_DEBUG\u0026#34;) if strings.Contains(e, \u0026#34;http2debug=1\u0026#34;) { ProjectDebug = true } } æ³¨å†Œæ¨¡å¼\nåˆ©ç”¨ _ å¯¼å…¥ï¼Œä¼šä½¿å¯¼å…¥çš„ä¾èµ–åˆå§‹åŒ–ï¼Œå¦‚ pg åŒ…ä¸­å®ç°çš„é©±åŠ¨æ³¨å†Œã€‚\né€šè¿‡åœ¨ init å‡½æ•°ä¸­æ³¨å†Œè‡ªå·±çš„å®ç°çš„æ¨¡å¼ï¼Œæœ‰æ•ˆé™ä½äº† Go åŒ…å¯¹å¤–çš„ç›´æ¥æš´éœ²ã€‚\n1 import _ \u0026#34;github.com/lib/pq\u0026#34; Go ç¨‹åºåˆå§‹åŒ–æµç¨‹ åˆå§‹åŒ–å¯¼å…¥çš„åŒ… , æ²¡æœ‰ä¾èµ–çš„åŒ…ä¼˜å…ˆåˆå§‹åŒ– åˆå§‹åŒ–æœ‰ä¾èµ–çš„åŒ… åˆå§‹åŒ–æ²¡æœ‰ä¾èµ–çš„å¸¸é‡ , å˜é‡ åˆå§‹åŒ–æœ‰ä¾èµ–çš„å¸¸é‡ , å˜é‡ æ‰§è¡Œ init å‡½æ•° æ‰§è¡Œ main å‡½æ•° ä½œç”¨åŸŸ å½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªåå­—å¼•ç”¨æ—¶ï¼Œå®ƒä¼šå¯¹å…¶å®šä¹‰è¿›è¡ŒæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ä»æœ€å†…å±‚çš„è¯æ³•åŸŸå‘å…¨å±€çš„ä½œç”¨åŸŸè¿›è¡Œã€‚å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™æŠ¥å‘Šâ€œæœªå£°æ˜çš„åå­—â€è¿™æ ·çš„é”™è¯¯ã€‚å¦‚æœè¯¥åå­—åœ¨å†…éƒ¨å’Œå¤–éƒ¨çš„å—åˆ†åˆ«å£°æ˜è¿‡ï¼Œåˆ™å†…éƒ¨å—çš„å£°æ˜é¦–å…ˆè¢«æ‰¾åˆ°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†…éƒ¨å£°æ˜å±è”½äº†å¤–éƒ¨åŒåçš„å£°æ˜ï¼Œè®©å¤–éƒ¨çš„å£°æ˜çš„åå­—æ— æ³•è¢«è®¿é—®\nfor å¾ªç¯æœ‰æ˜¾ç¤ºè¯æ³•åŸŸå’Œéšå¼è¯æ³•åŸŸ , æ˜¾ç¤ºè¯æ³•åŸŸæ˜¯èŠ±æ‹¬å·é‡Œä»£ç å— , éšå¼è¯æ³•åŸŸæ˜¯ i:=0 åˆå§‹åŒ–\nå’Œforå¾ªç¯ç±»ä¼¼ï¼Œifå’Œswitchè¯­å¥ä¹Ÿä¼šåœ¨æ¡ä»¶éƒ¨åˆ†åˆ›å»ºéšå¼è¯æ³•åŸŸï¼Œè¿˜æœ‰å®ƒä»¬å¯¹åº”çš„æ‰§è¡Œä½“è¯æ³•åŸŸã€‚\nswitchè¯­å¥çš„æ¯ä¸ªåˆ†æ”¯ä¹Ÿæœ‰ç±»ä¼¼çš„è¯æ³•åŸŸè§„åˆ™ï¼šæ¡ä»¶éƒ¨åˆ†ä¸ºä¸€ä¸ªéšå¼è¯æ³•åŸŸï¼Œç„¶åæ˜¯æ¯ä¸ªåˆ†æ”¯çš„è¯æ³•åŸŸã€‚\n1 2 3 4 5 6 7 8 if x := f(); x == 0 { fmt.Println(x) } else if y := g(x); x == y { fmt.Println(x, y) } else { fmt.Println(x, y) } fmt.Println(x, y) // compile error: x and y are not visible here ä¸€ä¸ªé”™è¯¯çš„æ¼”ç¤º\n1 2 3 4 5 if f, err := os.Open(fname); err != nil { // compile error: unused: f return err } f.ReadByte() // compile error: undefined f f.Close() // compile e ä½ å¯ä»¥è¿™æ ·å¹², ä½†æ˜¯ä¸æ¨è\n1 2 3 4 5 6 7 if f, err := os.Open(fname); err != nil { return err } else { // f and err are visible here too f.ReadByte() f.Close() } å¯¹äºå˜é‡çš„åˆå§‹åŒ– , å¦‚æœè¦å¤„ç†é”™è¯¯ , ä¸å»ºè®®ç›´æ¥å£°æ˜èµ‹å€¼ , è€Œæ˜¯è¿™æ ·åš\n1 2 3 4 5 6 7 8 9 var cwd string // è¿™é‡Œçš„ä¼šåˆ›å»ºå±€éƒ¨å˜é‡, å¹¶æ²¡æœ‰å¯¹åŒ…å˜é‡ cwd èµ‹å€¼ func init() { cwd, err := os.Getwd() // compile error: unused: cwd if err != nil { log.Fatalf(\u0026#34;os.Getwd failed: %v\u0026#34;, err) } } ä¸å»ºè®®çš„\nvar cwd,_ = os.GetWd()\næ­£ç¡®çš„åšæ³•\n1 2 3 4 5 6 7 8 9 var cwd string func init() { var err error cwd, err = os.Getwd() if err != nil { log.Fatalf(\u0026#34;os.Getwd failed: %v\u0026#34;, err) } } ","date":"2019-11-03T11:00:00Z","permalink":"https://blog.golang.space/p/5.%E5%8C%85%E5%92%8C%E6%96%87%E4%BB%B6/","title":"5.åŒ…å’Œæ–‡ä»¶"},{"content":"å­—ç¬¦ä¸² 1. åŸºç¡€çŸ¥è¯† 1.1. ç¼–ç æ–¹å¼ Go è¯­è¨€é»˜è®¤ç¼–ç æ–¹å¼æ˜¯ UTF-8ã€‚\n8 ä¸ª bit è¡¨ç¤ºä¸€ä¸ª byte (å­—èŠ‚) :\n0000 0000 è¡¨ç¤º æ•°å­— 0ã€‚ 1111 1111 è¡¨ç¤ºæ•°å­— 255ã€‚ unicode æ˜¯å®šé•¿ç¼–ç ï¼Œè¡¨ç¤ºå¦‚ä¸‹\nå­—ç¬¦ ç¼–ç  e 0000 0000 0000 0000 0000 0000 0110 0101 ä¸– 0000 0000 0000 0000 0100 1110 0001 0111 ç”±äº unicode å ç”¨è¾ƒå¤šç©ºé—´ï¼Œäºæ˜¯æœ‰äº† å˜é•¿ç¼–ç ï¼Œè¿™å°±æ˜¯ UTF-8\nç¼–å· ç¼–ç æ¨¡æ¿ è¯´æ˜ [0,127] 0??? ???? è¡¨ç¤º 1 ä¸ª byte [128,2047] 110? ???? 10?? ???? è¡¨ç¤º 2 ä¸ª byte [2048,65535] 1110 ???? 10?? ???? 10?? ???? è¡¨ç¤º 3 ä¸ª byte é€šè¿‡å»æ‰æ ‡è¯†ä½ï¼Œè·å¾—äºŒè¿›åˆ¶\nå­—ç¬¦ åè¿›åˆ¶ äºŒè¿›åˆ¶ UTF-8 ç¼–ç  e 101 0110 0101 0110 0101 ä¸– 19990 0100 1110 0001 0110 1110 0100 1011 1000 1001 0110 1.2. ä¸å¯ä¿®æ”¹ 1 2 3 s := \u0026#34;left foot\u0026#34; t := s s += \u0026#34;, right foot\u0026#34; è¿™å¹¶ä¸ä¼šå¯¼è‡´åŸå§‹çš„å­—ç¬¦ä¸²å€¼è¢«æ”¹å˜ï¼Œä½†æ˜¯å˜é‡så°†å› ä¸º+=è¯­å¥æŒæœ‰ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å€¼ï¼Œä½†æ˜¯tä¾ç„¶æ˜¯åŒ…å«åŸå…ˆçš„å­—ç¬¦ä¸²å€¼ã€‚\nå­—ç¬¦ä¸²æ˜¯ä¸å¯ä¿®æ”¹çš„ï¼Œç¼–è¯‘å™¨ä¼šå°†å­—ç¬¦ä¸²å†…å®¹åˆ†é…åˆ°åªè¯»å†…å­˜æ®µã€‚éœ€è¦ä¿®æ”¹åˆ™é‡æ–°èµ‹å€¼ï¼ŒæŒ‡é’ˆæ²¡æœ‰ä¿®æ”¹åŸæ¥çš„å†…å­˜ï¼Œè€Œæ˜¯åˆ›å»ºäº†æ–°çš„å†…å­˜ã€‚\n1 2 // Bad s[0]=\u0026#39;a\u0026#39; 1 2 // Good s = \u0026#34;abc\u0026#34; 2. ä½¿ç”¨æ¡ˆä¾‹ 2.1. è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ len() å‡½æ•°ç”¨äºæ±‚é•¿åº¦ï¼Œå­—ç¬¦ä¸²æ˜¯ä»¥ UTF-8 æ ¼å¼è¿›è¡Œå­˜å‚¨çš„ï¼Œlen() è·å–çš„æ˜¯å­—èŠ‚æ•°ç»„é•¿åº¦\né‡åˆ°ä¸­æ–‡æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•å¤„ç†\n1 2 3 utf8.RuneCountInString(str) // æŒ‰ utf8 ç¼–ç  len([]rune(\u0026#34;å­—ç¬¦ä¸²\u0026#34;))\t2.2. å­—ç¬¦ä¸²éå† 1 2 3 for i,v := range []rune(str) { fmt.Printf(\u0026#34;(%d,%c)\\n\u0026#34;,idx, val) } 2.3.å­—ç¬¦ä¸²æ‹¼æ¥ å­—ç¬¦ä¸²åº•å±‚æ˜¯ä¸å¯ä¿®æ”¹çš„æ•°ç»„ï¼Œè‹¥ä½¿ç”¨ + æ‹¼æ¥åˆ™ä¼šåˆ›å»ºæ–°çš„å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ›´èŠ‚çœå†…å­˜\n1 2 3 4 5 6 func TestStringsBuuilder(t *testing.T) { var a strings.Builder a.WriteString(\u0026#34;hello,\u0026#34;) a.WriteString(\u0026#34;world\u0026#34;) fmt.Printf(a.String()) } 1 2 3 4 5 func TestBytesBuffer(t *testing.T) { var buf bytes.Buffer buf.WriteString(\u0026#34;hello,\u0026#34;) fmt.Printf(buf.String()) } 2.4. å­—ç¬¦ä¸²å’Œæ•°å­—çš„è½¬æ¢ å°†ä¸€ä¸ªæ•´æ•°è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œä¸€ç§æ–¹æ³•æ˜¯ç”¨fmt.Sprintfè¿”å›ä¸€ä¸ªæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼›å¦ä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨strconv.Itoa(â€œæ•´æ•°åˆ°ASCIIâ€)ï¼š\nfmt.Sprintf ä¼šç”¨åˆ°åå°„ã€‚\nstrconv.Itoa æ•ˆç‡æ›´é«˜ã€‚\n1 2 3 x := 123 y := fmt.Sprintf(\u0026#34;%d\u0026#34;, x) fmt.Println(y, strconv.Itoa(x)) // \u0026#34;123 123\u0026#34; 2.5. æ›´å¤š æ£€æŸ¥å­—ç¬¦ä¸²å‰ç¼€\n1 2 3 func HasPrefix(s, prefix string) bool { return len(s) \u0026gt;= len(prefix) \u0026amp;\u0026amp; s[:len(prefix)] == prefix } åç¼€\n1 2 3 func HasSuffix(s, suffix string) bool { return len(s) \u0026gt;= len(suffix) \u0026amp;\u0026amp; s[len(s)-len(suffix):] == suffix } åŒ…å«å­ä¸²æµ‹è¯•\n1 2 3 4 5 6 7 8 func Contains(s, substr string) bool { for i := 0; i \u0026lt; len(s); i++ { if HasPrefix(s[i:], substr) { return true } } return false } ä½¿ç”¨ utf8 åŒ…\n1 2 3 4 5 import \u0026#34;unicode/utf8\u0026#34; s := \u0026#34;Hello, ä¸–ç•Œ\u0026#34; fmt.Println(len(s)) // \u0026#34;13\u0026#34; å­—èŠ‚é•¿åº¦ fmt.Println(utf8.RuneCountInString(s)) // \u0026#34;9\u0026#34; å­—ç¬¦é•¿åº¦ 3. æ³¨æ„ containers å’Œ æ­£åˆ™è¡¨è¾¾å¼ å“ªä¸ªæ€§èƒ½é«˜??\næ ‡å‡†åº“ä¸­æœ‰å››ä¸ªåŒ…å¯¹å­—ç¬¦ä¸²å¤„ç†å°¤ä¸ºé‡è¦ï¼šbytesã€stringsã€strconvå’ŒunicodeåŒ…ã€‚stringsåŒ…æä¾›äº†è®¸å¤šå¦‚å­—ç¬¦ä¸²çš„æŸ¥è¯¢ã€æ›¿æ¢ã€æ¯”è¾ƒã€æˆªæ–­ã€æ‹†åˆ†å’Œåˆå¹¶ç­‰åŠŸèƒ½ã€‚\nbytesåŒ…ä¹Ÿæä¾›äº†å¾ˆå¤šç±»ä¼¼åŠŸèƒ½çš„å‡½æ•°ï¼Œä½†æ˜¯é’ˆå¯¹å’Œå­—ç¬¦ä¸²æœ‰ç€ç›¸åŒç»“æ„çš„[]byteç±»å‹ã€‚å› ä¸ºå­—ç¬¦ä¸²æ˜¯åªè¯»çš„ï¼Œå› æ­¤é€æ­¥æ„å»ºå­—ç¬¦ä¸²ä¼šå¯¼è‡´å¾ˆå¤šåˆ†é…å’Œå¤åˆ¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨bytes.Bufferç±»å‹å°†ä¼šæ›´æœ‰æ•ˆ\nstrconvåŒ…æä¾›äº†å¸ƒå°”å‹ã€æ•´å‹æ•°ã€æµ®ç‚¹æ•°å’Œå¯¹åº”å­—ç¬¦ä¸²çš„ç›¸äº’è½¬æ¢ï¼Œè¿˜æä¾›äº†åŒå¼•å·è½¬ä¹‰ç›¸å…³çš„è½¬æ¢ã€‚\npathå’Œpath/filepathåŒ…æä¾›äº†å…³äºæ–‡ä»¶è·¯å¾„åæ›´ä¸€èˆ¬çš„å‡½æ•°æ“ä½œã€‚ä½¿ç”¨æ–œæ åˆ†éš”è·¯å¾„å¯ä»¥åœ¨ä»»ä½•æ“ä½œç³»ç»Ÿä¸Šå·¥ä½œã€‚\nstrings åŒ…çš„å‡½æ•°\n1 2 3 4 5 6 func Contains(s, substr string) bool func Count(s, sep string) int func Fields(s string) []string func HasPrefix(s, prefix string) bool func Index(s, sep string) int func Join(a []string, sep string) string bytes åŒ…\n1 2 3 4 5 6 func Contains(b, subslice []byte) bool func Count(s, sep []byte) int func Fields(s []byte) [][]byte func HasPrefix(s, prefix []byte) bool func Index(s, sep []byte) int func Join(s [][]byte, sep []byte) []byte å½“å‘bytes.Bufferæ·»åŠ ä»»æ„å­—ç¬¦çš„UTF8ç¼–ç æ—¶ï¼Œæœ€å¥½ä½¿ç”¨bytes.Bufferçš„WriteRuneæ–¹æ³•ï¼Œä½†æ˜¯WriteByteæ–¹æ³•å¯¹äºå†™å…¥ç±»ä¼¼\u0026rsquo;[\u0026lsquo;å’Œ\u0026rsquo;]\u0026lsquo;ç­‰ASCIIå­—ç¬¦åˆ™ä¼šæ›´åŠ æœ‰æ•ˆã€‚\nå†™å…¥æ—¶ , å°½é‡é¿å… å¼ºåˆ¶ç±»å‹è½¬æ¢, è¿™ä¼šæ‹·è´æ•°æ®, æµªè´¹å†…å­˜\n4. äº†è§£æºç  Goè¯­è¨€å­—ç¬¦ä¸²çš„åº•å±‚ç»“æ„åœ¨reflect.StringHeaderä¸­å®šä¹‰ã€‚\n1 2 3 4 type StringHeader struct { Data uintptr // èµ·å§‹åœ°å€ Len int\t// byte é•¿åº¦ } ","date":"2019-11-02T12:00:00Z","permalink":"https://blog.golang.space/p/4.1.%E5%AD%97%E7%AC%A6%E4%B8%B2/","title":"4.1.å­—ç¬¦ä¸²"},{"content":"å…ƒç»„èµ‹å€¼ 1 2 3 4 5 a,b := b,a // å®ç°å˜é‡äº¤æ¢ i, j, k = 2, 3, 5 // èµ‹å€¼ q, w, e = 2, \u0026#39;3\u0026#39;, true // ä¸åŒç±»å‹èµ‹å€¼ _, err = io.Copy(dst, src) // ä¸¢å¼ƒå­—èŠ‚æ•° _, ok = x.(T) // åªæ£€æµ‹ç±»å‹ï¼Œå¿½ç•¥å…·ä½“å€¼ æœ€å¤§å…¬çº¦æ•°\n1 2 3 4 5 6 func gcd(x, y int) int { for y != 0 { x, y = y, x%y } return x } æ–æ³¢é‚£å¥‘æ•°åˆ—\n1 2 3 4 5 6 7 func fib(n int) int { x, y := 0, 1 for i := 0; i \u0026lt; n; i++ { x, y = y, x+y } return x } 1 2 3 4 5 6 v = m[key] // mapæŸ¥æ‰¾ï¼Œå¤±è´¥æ—¶è¿”å›é›¶å€¼ v = x.(T) // typeæ–­è¨€ï¼Œå¤±è´¥æ—¶panicå¼‚å¸¸ v = \u0026lt;-ch // ç®¡é“æ¥æ”¶ï¼Œå¤±è´¥æ—¶è¿”å›é›¶å€¼ï¼ˆé˜»å¡ä¸ç®—æ˜¯å¤±è´¥ï¼‰ v, ok = m[key] // map lookup v, ok = x.(T) // type assertion v, ok = \u0026lt;-ch // channel receive ç›®å‰æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡çš„ç±»å‹ï¼Œå®ƒçš„è§„åˆ™æ˜¯ç®€å•çš„ï¼šç±»å‹å¿…é¡»å®Œå…¨åŒ¹é…ï¼Œnilå¯ä»¥èµ‹å€¼ç»™ä»»ä½•æŒ‡é’ˆæˆ–å¼•ç”¨ç±»å‹çš„å˜é‡ã€‚\nå¯¹äºä¸¤ä¸ªå€¼æ˜¯å¦å¯ä»¥ç”¨==æˆ–!=è¿›è¡Œç›¸ç­‰æ¯”è¾ƒçš„èƒ½åŠ›ä¹Ÿå’Œå¯èµ‹å€¼èƒ½åŠ›æœ‰å…³ç³»ï¼šå¯¹äºä»»ä½•ç±»å‹çš„å€¼çš„ç›¸ç­‰æ¯”è¾ƒï¼Œç¬¬äºŒä¸ªå€¼å¿…é¡»æ˜¯å¯¹ç¬¬ä¸€ä¸ªå€¼ç±»å‹å¯¹åº”çš„å˜é‡æ˜¯å¯èµ‹å€¼çš„ï¼Œåä¹‹äº¦ç„¶ã€‚\nç±»å‹ 1 type ç±»å‹åå­— åº•å±‚ç±»å‹ ç±»å‹å£°æ˜è¯­å¥ä¸€èˆ¬å‡ºç°åœ¨åŒ…ä¸€çº§ï¼Œå› æ­¤å¦‚æœæ–°åˆ›å»ºçš„ç±»å‹åå­—çš„é¦–å­—ç¬¦å¤§å†™ï¼Œåˆ™åœ¨åŒ…å¤–éƒ¨ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Package tempconv performs Celsius and Fahrenheit temperature computations. package tempconv import \u0026#34;fmt\u0026#34; type Celsius float64 // æ‘„æ°æ¸©åº¦ type Fahrenheit float64 // åæ°æ¸©åº¦ const ( AbsoluteZeroC Celsius = -273.15 // ç»å¯¹é›¶åº¦ FreezingC Celsius = 0 // ç»“å†°ç‚¹æ¸©åº¦ BoilingC Celsius = 100 // æ²¸æ°´æ¸©åº¦ ) func CToF(c Celsius) Fahrenheit { return Fahrenheit(c*9/5 + 32) } func FToC(f Fahrenheit) Celsius { return Celsius((f - 32) * 5 / 9) } å®ƒä»¬æ˜¯ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå› æ­¤å®ƒä»¬ä¸å¯ä»¥è¢«ç›¸äº’æ¯”è¾ƒæˆ–æ··åœ¨ä¸€ä¸ªè¡¨è¾¾å¼è¿ç®—ã€‚\nåªæœ‰å½“ä¸¤ä¸ªç±»å‹çš„åº•å±‚åŸºç¡€ç±»å‹ç›¸åŒæ—¶ï¼Œæ‰å…è®¸ç±»å‹å¼ºåˆ¶è½¬æ¢\nåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶ä¸ä¼šå‘ç”Ÿè½¬æ¢å¤±è´¥çš„é”™è¯¯ï¼ˆè¯‘æ³¨: é”™è¯¯åªä¼šå‘ç”Ÿåœ¨ç¼–è¯‘é˜¶æ®µï¼‰\næ•´æ•°é™¤ä»¥æ•´æ•°ï¼Œåœ°æ¿é™¤æ³•ï¼Œå³ç»“æœä»…ä¿ç•™æ•´æ•°\nä»»æ„å‚æ•°å¸¦å°æ•°ç‚¹ï¼Œåˆ™ç»“æœå°±æ˜¯æµ®ç‚¹ç±»å‹\nå†…å»ºç±»å‹\nå¤æ•°\ncomplex64å’Œcomplex128ï¼Œåˆ†åˆ«å¯¹åº”float32å’Œfloat64ä¸¤ç§æµ®ç‚¹æ•°ç²¾åº¦ã€‚å†…ç½®çš„complexå‡½æ•°ç”¨äºæ„å»ºå¤æ•°ï¼Œå†…å»ºçš„realå’Œimagå‡½æ•°åˆ†åˆ«è¿”å›å¤æ•°çš„å®éƒ¨å’Œè™šéƒ¨ï¼š\n1 2 3 4 5 var x complex128 = complex(1, 2) // 1+2i var y complex128 = complex(3, 4) // 3+4i fmt.Println(x*y) // \u0026#34;(-5+10i)\u0026#34; fmt.Println(real(x*y)) // \u0026#34;-5\u0026#34; fmt.Println(imag(x*y)) // \u0026#34;10\u0026#34; æ ¼å¼åŒ–\n1 2 3 4 5 6 7 8 9 10 %c # å­—ç¬¦ %q # å•å¼•å·å­—ç¬¦ %d # æ•°å­— %o #å…«è¿›åˆ¶ %x # åå…­è¿›åˆ¶ %g # ç´§å‡‘å½¢å¼æµ®ç‚¹ , å»ºè®®ä½¿ç”¨ %f %f # æµ®ç‚¹, å¯ä»¥ %8.3f, æ•´æ•°éƒ¨åˆ† 8 ä½, å°æ•°ç‚¹å 3 ä½ %e # å¸¦æŒ‡æ•° %+v # ç»“æ„ä½“åï¼Œå‚æ•°åå’Œå€¼ %#v # åŒ…åï¼Œç»“æ„ä½“åï¼Œå‚æ•°åå’Œå€¼ 1 2 3 fmt.Printf(\u0026#34;%d %[1]x %#[1]x %#[1]X\\n\u0026#34;, x) // Output: // 3735928559 deadbeef 0xdeadbeef 0XDEADBEEF %ä¹‹åçš„[1]å‰¯è¯å‘Šè¯‰Printfå‡½æ•°å†æ¬¡ä½¿ç”¨ç¬¬ä¸€ä¸ªæ“ä½œæ•°ã€‚ç¬¬äºŒï¼Œ%åçš„#å‰¯è¯å‘Šè¯‰Printfåœ¨ç”¨%oã€%xæˆ–%Xè¾“å‡ºæ—¶ç”Ÿæˆ0ã€0xæˆ–0Xå‰ç¼€ã€‚\næŒ‡ä»¤ä¿®é¥°ç¬¦\n% d å¦‚æœè¾“å‡ºçš„æ•°å­—ä¸ºè´Ÿï¼Œåˆ™åœ¨å…¶å‰é¢åŠ ä¸Šä¸€ä¸ªå‡å·\u0026quot;-\u0026quot;ã€‚å¦‚æœè¾“å‡ºçš„æ˜¯æ•´æ•°ï¼Œåˆ™åœ¨å‰é¢åŠ ä¸€ä¸ªç©ºæ ¼ã€‚ä½¿ç”¨ %x æˆ–è€… %X æ ¼å¼åŒ–æŒ‡ä»¤è¾“å‡ºæ—¶ï¼Œä¼šåœ¨ç»“æœä¹‹é—´æ·»åŠ ä¸€ä¸ªç©ºæ ¼ã€‚ä¾‹å¦‚ fmt.Printf(\u0026quot;% X\u0026quot;, \u0026ldquo;å®\u0026rdquo;)è¾“å‡º E5 AE 9E %#o ä»¥ 0 å¼€å§‹çš„å…«è¿›åˆ¶æ•°æ® %#x ä»¥ 0x å¼€å§‹çš„åå…­è¿›åˆ¶æ•°æ® + åœ¨æ•°å€¼å‰é¢è¾“å‡º+å·æˆ–è€…-å·ï¼Œä¸ºå­—ç¬¦ä¸²è¾“å‡º ASCII å­—ç¬¦ï¼ˆé ASCII å­—ç¬¦ä¼šè¢«è½¬ä¹‰ï¼‰ï¼Œä¸ºç»“æ„ä½“è¾“å‡ºå…¶å­—æ®µå - å°†å€¼å‘å·¦å¯¹é½ï¼ˆé»˜è®¤å³å¯¹é½ï¼‰ 0 ä»¥æ•°å­— 0 è¿›è¡Œå¡«å…… å¸¸é‡\nå¸¸é‡è¡¨è¾¾å¼çš„å€¼åœ¨ç¼–è¯‘æœŸè®¡ç®—ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡ŒæœŸã€‚æ¯ç§å¸¸é‡çš„æ½œåœ¨ç±»å‹éƒ½æ˜¯åŸºç¡€ç±»å‹ï¼šbooleanã€stringæˆ–æ•°å­—ã€‚æŒ‡é’ˆ , ç»“æ„ä½“ , æ¥å£ éƒ½ä¸æ˜¯å¸¸é‡\n1 2 3 4 5 6 7 const err = errors.New(\u0026#34;error\u0026#34;) // âŒ const filename string = \u0026#34;abc.txt\u0026#34; // æˆ–è€… const ( filename string = \u0026#34;t.txt\u0026#34; ) Go è¯­è¨€é¢„å®šä¹‰äº† true , false iota å¸¸é‡\niota å¸¸é‡ç”Ÿæˆå™¨\nåœ¨constå…³é”®å­—å‡ºç°æ—¶è¢«é‡ç½®ä¸º 0ï¼Œåœ¨ä¸‹ä¸€ä¸ª const å‡ºç°ä¹‹å‰ï¼Œæ¯å‡ºç°ä¸€æ¬¡ iota,å…¶æ‰€ä»£è¡¨çš„æ•°å­—è‡ªåŠ¨åŠ  1ã€‚\n1 2 3 4 5 6 7 const ( a = iota //a == 0 b = iota //b ==1 c = iota //c == 2 ) const d = iota //d==0,å› ä¸ºconstçš„å‡ºç°ï¼Œiotaè¢«é‡ç½®ä¸º0 çœ‹é¢˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 const ( c = 0 d = iota // 1 e // 2 f = \u0026#34;hello\u0026#34; // hello // nothing g // hello h = iota // 5 i // 6 j = 0 // 0 k // 0 l, m = iota, iota // 9 9 n, o // 10 10 p = iota + 1 // iota+1 = 12 q // iota+1 = 13 _ // iota+1 = 14 r = iota * iota // iota = 14 14*14=196 s // iota*iota = 15*15 t = r // å»ºè®®ä¸è¦è¿™ä¹ˆåš u // v = 1 \u0026lt;\u0026lt; iota // 1 \u0026lt;\u0026lt; 18 w // 1 \u0026lt;\u0026lt; 19 x = iota * 0.01 // 0.20 y float32 = iota * 0.01 // 0.21 z // 0.22 ) ä¸åŒ const å®šä¹‰å—äº’ä¸å¹²æ‰° æ‰€æœ‰æ³¨é‡Šè¡Œå’Œç©ºè¡Œå…¨éƒ¨å¿½ç•¥( _ æ˜¯å¿½ç•¥å˜é‡, ä½†æ˜¯ç®—åšä¸€è¡Œ) æ²¡æœ‰è¡¨è¾¾å¼çš„å¸¸é‡å®šä¹‰å¤ç”¨ä¸Šä¸€è¡Œ ä»ç¬¬ä¸€è¡Œå¼€å§‹, iota é€è¡Œ+1, å“ªæ€•ç¬¬ä¸€è¡Œä¸æ˜¯ iota, ä¹Ÿä»ç¬¬ä¸€è¡Œç®— æ›¿æ¢æ‰€æœ‰ iota å¦‚æœæ˜¯æ‰¹é‡å£°æ˜çš„å¸¸é‡ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªå¤–å…¶å®ƒçš„å¸¸é‡å³è¾¹çš„åˆå§‹åŒ–è¡¨è¾¾å¼éƒ½å¯ä»¥çœç•¥ï¼Œå¦‚æœçœç•¥åˆå§‹åŒ–è¡¨è¾¾å¼åˆ™è¡¨ç¤ºä½¿ç”¨å‰é¢å¸¸é‡çš„åˆå§‹åŒ–è¡¨è¾¾å¼å†™æ³•ï¼Œå¯¹åº”çš„å¸¸é‡ç±»å‹ä¹Ÿä¸€æ ·çš„ã€‚\n1 2 3 4 5 6 7 8 const ( a = 1 b c = 2 d ) fmt.Println(a, b, c, d) // \u0026#34;1 1 2 2\u0026#34; Goè¯­è¨€çš„å¸¸é‡æœ‰ä¸ªä¸åŒå¯»å¸¸ä¹‹å¤„ã€‚è™½ç„¶ä¸€ä¸ªå¸¸é‡å¯ä»¥æœ‰ä»»æ„ä¸€ä¸ªç¡®å®šçš„åŸºç¡€ç±»å‹ï¼Œä¾‹å¦‚intæˆ–float64\nç¼–è¯‘å™¨ä¸ºè¿™äº›æ²¡æœ‰æ˜ç¡®åŸºç¡€ç±»å‹çš„æ•°å­—å¸¸é‡æä¾›æ¯”åŸºç¡€ç±»å‹æ›´é«˜ç²¾åº¦çš„ç®—æœ¯è¿ç®—ï¼›ä½ å¯ä»¥è®¤ä¸ºè‡³å°‘æœ‰256bitçš„è¿ç®—ç²¾åº¦ã€‚è¿™é‡Œæœ‰å…­ç§æœªæ˜ç¡®ç±»å‹çš„å¸¸é‡ç±»å‹ï¼Œåˆ†åˆ«æ˜¯æ— ç±»å‹çš„å¸ƒå°”å‹ã€æ— ç±»å‹çš„æ•´æ•°ã€æ— ç±»å‹çš„å­—ç¬¦ã€æ— ç±»å‹çš„æµ®ç‚¹æ•°ã€æ— ç±»å‹çš„å¤æ•°ã€æ— ç±»å‹çš„å­—ç¬¦ä¸²ã€‚\nåªæœ‰å¸¸é‡å¯ä»¥æ˜¯æ— ç±»å‹çš„ã€‚å½“ä¸€ä¸ªæ— ç±»å‹çš„å¸¸é‡è¢«èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå°±åƒä¸‹é¢çš„ç¬¬ä¸€è¡Œè¯­å¥ï¼Œæˆ–è€…å‡ºç°åœ¨æœ‰æ˜ç¡®ç±»å‹çš„å˜é‡å£°æ˜çš„å³è¾¹ï¼Œå¦‚ä¸‹é¢çš„å…¶ä½™ä¸‰è¡Œè¯­å¥ï¼Œæ— ç±»å‹çš„å¸¸é‡å°†ä¼šè¢«éšå¼è½¬æ¢ä¸ºå¯¹åº”çš„ç±»å‹ï¼Œå¦‚æœè½¬æ¢åˆæ³•çš„è¯ã€‚\n1 2 3 4 5 6 7 8 9 10 var f float64 = 3 + 0i // untyped complex -\u0026gt; float64 f = 2 // untyped integer -\u0026gt; float64 f = 1e123 // untyped floating-point -\u0026gt; float64 f = \u0026#39;a\u0026#39; // untyped rune -\u0026gt; float64 // ç›¸å½“äº var f float64 = float64(3 + 0i) f = float64(2) f = float64(1e123) f = float64(\u0026#39;a\u0026#39;) 1 2 3 4 5 6 7 8 9 10 11 12 a := 12 // é»˜è®¤é•¿åº¦ 8,å³ç±»å‹ int64 fmt.Println(\u0026#34;length of a: \u0026#34;, unsafe.Sizeof(a)) var b int = 12 // æ ¹æ®æœºå™¨è‡ªåŠ¨,32 or 64 fmt.Println(\u0026#34;length of b(int): \u0026#34;, unsafe.Sizeof(b)) var c int8 = 12 // 0-255 1 ä¸ªå­—èŠ‚ fmt.Println(\u0026#34;length of c(int8): \u0026#34;, unsafe.Sizeof(c)) var d int16 = 12 // 0-65535 2 ä¸ªå­—èŠ‚ fmt.Println(\u0026#34;length of d(int16): \u0026#34;, unsafe.Sizeof(d)) var e int32 = 12 // å››ä¸ªå­—èŠ‚ fmt.Println(\u0026#34;length of e(int32): \u0026#34;, unsafe.Sizeof(e)) var f int64 = 12 fmt.Println(\u0026#34;length of f(int64): \u0026#34;, unsafe.Sizeof(f)) ","date":"2019-11-02T11:00:00Z","permalink":"https://blog.golang.space/p/4.%E8%B5%8B%E5%80%BC%E4%B8%8E%E7%B1%BB%E5%9E%8B/","title":"4.èµ‹å€¼ä¸ç±»å‹"},{"content":"æŒ‡é’ˆ ä»»ä½•æŒ‡é’ˆçš„é›¶å€¼éƒ½æ˜¯ nil\n1. åŸºç¡€å†…å®¹ 1.1. æŒ‡é’ˆçš„åŸºæœ¬ç”¨æ³• æŒ‡é’ˆä¸èƒ½è¿ç®—ï¼ŒGo è¯­è¨€åªæœ‰å€¼ä¼ é€’ä¸€ç§æ–¹å¼ï¼Œå¼•ç”¨ç±»å‹ï¼Œä¹Ÿä¼šæ‹·è´å¼•ç”¨çš„åœ°å€\n1 2 3 4 var a int = 2 var pa *int = \u0026amp;a *pa = 3 fmt.Println(a) 1.2. æŒ‡é’ˆç›¸ç­‰çš„æ¡ä»¶ éƒ½æ˜¯ nil æŒ‡å‘åŒä¸€ä¸ªå˜é‡ åœ¨ Go è¯­è¨€ä¸­ï¼Œè¿”å›å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„åœ°å€ä¹Ÿæ˜¯å®‰å…¨çš„\n1.3.new é¢„å®šä¹‰å‡½æ•° new(T) å°†åˆ›å»ºä¸€ä¸ª T ç±»å‹çš„åŒ¿åå˜é‡ï¼Œåˆå§‹åŒ–T ç±»å‹é›¶å€¼ï¼Œè¿”å›å˜é‡åœ°å€ï¼Œç±»å‹æ˜¯ *T\nnew æ˜¯é¢„å®šä¹‰å‡½æ•°ï¼Œå¹¶éå…³é”®å­—ï¼Œå¯ä»¥æ›´æ”¹ç±»å‹ï¼Œå£°æ˜ä¸ºå˜é‡ç­‰æ“ä½œï¼Œä½†ä¸å»ºè®®è¿™æ ·å¹²!\n1 2 3 4 p := new(int) // p, *int ç±»å‹, æŒ‡å‘åŒ¿åçš„ int å˜é‡ fmt.Println(*p) // \u0026#34;0\u0026#34; *p = 2 // è®¾ç½® int åŒ¿åå˜é‡çš„å€¼ä¸º 2 fmt.Println(*p) // \u0026#34;2\u0026#34; struct{}å’Œ[0]intæ˜¯å¤§å°ä¸º 0 çš„ç±»å‹ï¼Œ(è¯·è°¨æ…ä½¿ç”¨å¤§å°ä¸º0çš„ç±»å‹ï¼Œå› ä¸ºè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´Goè¯­è¨€çš„è‡ªåŠ¨åƒåœ¾å›æ”¶å™¨æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œå…·ä½“è¯·æŸ¥çœ‹runtime.SetFinalizerå‡½æ•°ç›¸å…³æ–‡æ¡£ï¼‰ã€‚\n1.4.å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ åŒ…çº§åˆ«çš„å˜é‡ï¼Œç”Ÿå‘½å‘¨æœŸå’Œç¨‹åºçš„è¿è¡Œå‘¨æœŸä¸€è‡´\nå‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼éƒ½æ˜¯å±€éƒ¨å˜é‡ï¼Œåœ¨å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™åˆ›å»ºï¼Œå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸ(æ ˆå¸§)ç»“æŸé”€æ¯\nGolang è¯­è¨€çš„è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œè¿™é‡Œé¿å¼€å®ç°ç»†èŠ‚ï¼Œè¯´ä¸€ä¸‹æ€è·¯ :\nä»æ¯ä¸ªåŒ…çº§çš„å˜é‡å’Œæ¯ä¸ªå½“å‰è¿è¡Œå‡½æ•°çš„æ¯ä¸€ä¸ªå±€éƒ¨å˜é‡å¼€å§‹ï¼Œé€šè¿‡æŒ‡é’ˆæˆ–å¼•ç”¨çš„è®¿é—®è·¯å¾„éå†ï¼Œæ˜¯å¦å¯ä»¥æ‰¾åˆ°è¯¥å˜é‡ã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„è®¿é—®è·¯å¾„ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥å˜é‡æ˜¯ä¸å¯è¾¾çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯å¦å­˜åœ¨å¹¶ä¸ä¼šå½±å“ç¨‹åºåç»­çš„è®¡ç®—ç»“æœã€‚\nå› ä¸ºä¸€ä¸ªå˜é‡çš„æœ‰æ•ˆå‘¨æœŸåªå–å†³äºæ˜¯å¦å¯è¾¾ï¼Œå› æ­¤ä¸€ä¸ªå¾ªç¯è¿­ä»£å†…éƒ¨çš„å±€éƒ¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½è¶…å‡ºå…¶å±€éƒ¨ä½œç”¨åŸŸã€‚åŒæ—¶ï¼Œå±€éƒ¨å˜é‡å¯èƒ½åœ¨å‡½æ•°è¿”å›ä¹‹åä¾ç„¶å­˜åœ¨ã€‚\nç¼–è¯‘å™¨ä¼šè‡ªåŠ¨é€‰æ‹©åœ¨æ ˆä¸Šè¿˜æ˜¯åœ¨å †ä¸Šåˆ†é…å±€éƒ¨å˜é‡çš„å­˜å‚¨ç©ºé—´ï¼Œé€‰æ‹©å¹¶ä¸æ˜¯ç”±ç”¨varè¿˜æ˜¯newå£°æ˜å˜é‡çš„æ–¹å¼å†³å®š\n1 2 3 4 5 6 7 8 9 10 11 12 var global *int func f() { var x int x = 1 global = \u0026amp;x // å †ä¸Š, å› ä¸ºåŒ…çº§åˆ«è¿˜åœ¨å¼•ç”¨, ä» f å‡½æ•°ä¸­é€ƒé€¸äº† } func g() { y := new(int) // å¤–éƒ¨æ²¡æœ‰å¼•ç”¨, ç¼–è¾‘å™¨å¯ä»¥é€‰æ‹©æ ˆæˆ–å †ä¸Šåˆ†é…, *y = 1 } å…¶å®åœ¨ä»»ä½•æ—¶å€™ï¼Œä½ å¹¶ä¸éœ€ä¸ºäº†ç¼–å†™æ­£ç¡®çš„ä»£ç è€Œè¦è€ƒè™‘å˜é‡çš„é€ƒé€¸è¡Œä¸ºï¼Œè¦è®°ä½çš„æ˜¯ï¼Œé€ƒé€¸çš„å˜é‡éœ€è¦é¢å¤–åˆ†é…å†…å­˜ï¼ŒåŒæ—¶å¯¹æ€§èƒ½çš„ä¼˜åŒ–å¯èƒ½ä¼šäº§ç”Ÿç»†å¾®çš„å½±å“ã€‚\nå¦‚æœå°†æŒ‡å‘çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„æŒ‡é’ˆä¿å­˜åˆ°å…·æœ‰é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ä¸­ï¼Œç‰¹åˆ«æ˜¯ä¿å­˜åˆ°å…¨å±€å˜é‡æ—¶ï¼Œä¼šé˜»æ­¢å¯¹çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„åƒåœ¾å›æ”¶ï¼ˆä»è€Œå¯èƒ½å½±å“ç¨‹åºçš„æ€§èƒ½ï¼‰ã€‚\n2. ä½¿ç”¨æ¡ˆä¾‹ 2.1. ä½¿ç”¨æŒ‡é’ˆå®ç° Echo å‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Echo4 prints its command-line arguments. package main import ( \u0026#34;flag\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;strings\u0026#34; ) // åˆ›å»ºå¸ƒå°”å˜é‡ , å‚æ•° : å‘½ä»¤è¡Œå‚æ•°,é»˜è®¤å€¼,æè¿°ä¿¡æ¯ var n = flag.Bool(\u0026#34;n\u0026#34;, false, \u0026#34;omit trailing newline\u0026#34;) var sep = flag.String(\u0026#34;s\u0026#34;, \u0026#34; \u0026#34;, \u0026#34;separator\u0026#34;) func main() { // è·å–å‚æ•°ä¹‹å‰å¿…é¡»è§£æ flag.Parse() // flag.Args() æ™®é€šå‘½ä»¤è¡Œå‚æ•° fmt.Print(strings.Join(flag.Args(), *sep)) if !*n { fmt.Println() } } 2.2. ä½¿ç”¨æŒ‡é’ˆæ¥äº¤æ¢å˜é‡ 1 2 3 4 5 6 7 8 9 func swap(a,b *int){ *a,*b = *b,*a } func main(){ var a,b int = 2,4 swap(\u0026amp;a,\u0026amp;b) fmt.Println(a,b) } 1 2 var a *int unsafe.Sizeof(a) // å¯¹æŒ‡é’ˆæ±‚å¤§å°, 64ä½ç³»ç»Ÿ=8 è¦æ”¹å˜å†…å®¹å¿…é¡»ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€… ç»“æ„è¿‡å¤§ä¹Ÿè€ƒè™‘ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…( é¿å…å¤§é‡æ‹·è´æµªè´¹æ€§èƒ½ ) ä¸€è‡´æ€§: å¦‚æœ‰æŒ‡é’ˆæ¥æ”¶è€…, éƒ½ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€… ( çº¯å±ä¸ºæ–¹ä¾¿ ) ","date":"2019-11-01T13:00:00Z","permalink":"https://blog.golang.space/p/3.%E6%8C%87%E9%92%88/","title":"3.æŒ‡é’ˆ"},{"content":"å˜é‡ Golang æœ‰å››ç§å£°æ˜\n1 2 3 4 var\t// å£°æ˜å˜é‡ const\t// å£°æ˜å¸¸é‡ type\t// å£°æ˜ç±»å‹ func\t// å£°æ˜å‡½æ•° 1. åŸºç¡€å†…å®¹ 1.1. å˜é‡çš„åŸºæœ¬ç”¨æ³• 1 2 3 var {variable} {type} = {è¡¨è¾¾å¼} // å…¶ä¸­ç±»å‹ æˆ–è¡¨è¾¾å¼å¯ä»¥çœç•¥ä¸€ä¸ª var {variable} = {è¡¨è¾¾å¼} var {variable} {type} è¡¨è¾¾å¼çœç•¥æ—¶ï¼Œå°†åˆå§‹åŒ–é›¶å€¼\n1 2 3 4 5 6 // å„ä¸ªç±»å‹çš„é›¶å€¼ var INT int = 0 var STRING string = \u0026#34;\u0026#34; var BOOL bool = false var INTERFACE interface{} = nil // å¼•ç”¨ç±»å‹(slice,map,chan,func,point,interface{}) é›¶å€¼éƒ½æ˜¯ nil Goå¼€å‘è€…åº”è¯¥è®©èšåˆç±»å‹çš„é›¶å€¼ä¹Ÿå…·æœ‰æ„ä¹‰ï¼Œå¯ä»¥ä¿è¯ä»»ä½•ç±»å‹å˜é‡æ€»æœ‰åˆç†æœ‰æ•ˆçš„é›¶å€¼çŠ¶æ€ã€‚\n1.2. å¤šå‚æ•°å£°æ˜ 1 2 var i,j,k int // int,int,int var b,f,s = true,2.3,\u0026#34;four\u0026#34; // bool,float64,string åœ¨åŒ…çº§åˆ«å£°æ˜çš„å˜é‡ä¼šåœ¨ main å…¥å£å‡½æ•°ä¹‹å‰å®Œæˆåˆå§‹åŒ– å±€éƒ¨å˜é‡å°†åœ¨å£°æ˜è¯­å¥è¢«æ‰§è¡Œåˆ°çš„æ—¶å€™å®Œæˆåˆå§‹åŒ– 1.3. ç®€çŸ­å£°æ˜å˜é‡ æ­¤æ–¹å¼å¹¿æ³›ç”¨äºå±€éƒ¨å˜é‡å£°æ˜å’Œåˆå§‹åŒ–ã€‚\né‚£ä¹ˆä»€ä¹ˆæ—¶å€™ç”¨ var ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç®€çŸ­å£°æ˜? å»ºè®®\nåˆå§‹åŒ–é›¶å€¼æ—¶ï¼Œç”¨ varã€‚å› ä¸ºé€šå¸¸ var æ¯” := æ›´é†’ç›®ï¼Œæ›´æ˜“è¾¨è®¤å£°æ˜å˜é‡ã€‚ éé›¶å€¼ï¼Œä½¿ç”¨ := 1 2 3 4 5 6 7 8 t := 0.0 str := \u0026#34;hello\u0026#34; freq := rand.Float64() * 3.0 i,j := 0,1\t// äº¤äº’ a,b çš„å€¼ a := 10 b := 20 a,b = b,a // a=20, b=10 æ³¨æ„\nåŒ…çº§åˆ«å˜é‡ ä¸ å±€åŸŸå˜é‡çš„åŒºåˆ†ï¼ŒåŒ…çº§åˆ«å®šä¹‰çš„å˜é‡ï¼Œåœ¨å‡½æ•°å†…ä½¿ç”¨ := æ—¶ï¼Œä¼šåœ¨å‡½æ•°å†…å£°æ˜æ–°å˜é‡\nåŒºåˆ† := ã€Œå£°æ˜è¯­å¥ã€ ä¸ = ã€Œèµ‹å€¼è¯­å¥ã€\nå½“ := å·¦ä¾§çš„å˜é‡å·²ç»å­˜åœ¨æ—¶ , ç¼–è¯‘æŠ¥é”™ , æœ‰å¤šä¸ªè¿”å›å€¼ä¸”æŸä¸€ä¸ªå˜é‡å­˜åœ¨ , åˆ™èµ‹å€¼å­˜åœ¨å˜é‡ï¼Œåˆ›å»ºæ–°å˜é‡\n1 2 3 var k int k,err := function() // k å·²ç»å­˜åœ¨, æ­¤å¤„èµ‹å€¼ç»™ k å¹¶åˆ›å»º err å˜é‡ k := 10 // ç¼–è¯‘å™¨æŠ¥é”™,è‡³å°‘éœ€è¦ä¸€ä¸ªå£°æ˜çš„æ–°å˜é‡æ‰èƒ½ä½¿ç”¨ := 1.4. å¼ºåˆ¶ç±»å‹è½¬æ¢ ç±»å‹è½¬æ¢ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å†…å­˜æˆæœ¬ï¼Œä½†æ˜¯æˆ‘ä»¬å®å¯å®‰å…¨ä¹Ÿä¸åæ‚”ã€‚\nå¯ä»¥ä½¿ç”¨ unsafe åŒ…æ¥åšä¸€äº›è½¬æ¢ï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸€ä¸ªå­—èŠ‚çš„åå·®å°±ä¼šé‡åˆ°çœŸæ­£çš„é—®é¢˜ã€‚\n1 2 3 var a,b int = 3,5 var c float64 = a // âŒ é”™è¯¯ç¤ºèŒƒ var d float64 = float64(a) 1.5. int ç±»å‹åœ¨ä¸åŒæ¶æ„ä¸‹ åœ¨ amd64 æ¶æ„ä¸‹ï¼Œè¡¨ç¤º 64 ä½ï¼Œ8 å­—èŠ‚(byte)\nåœ¨ amd32 æ¶æ„ä¸‹ï¼Œè¡¨ç¤º 32 ä½ï¼Œ4 å­—èŠ‚(byte)\n","date":"2019-11-01T12:00:00Z","permalink":"https://blog.golang.space/p/2.%E5%8F%98%E9%87%8F/","title":"2.å˜é‡"},{"content":"åå­—å¾ˆé‡è¦ èµ·åè¦æœ‰å¯è¯»æ€§, å¥½å˜é‡åçš„ç‰¹ç‚¹æ˜¯\nä¸€è‡´ (å®¹æ˜“çŒœæµ‹) ç®€çŸ­ (æ˜“äºè¾“å‡º) å‡†å¤‡ (æ˜“äºç†è§£) é€šå¸¸æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªåå­—çš„ä½œç”¨åŸŸæ¯”è¾ƒå¤§ï¼Œç”Ÿå‘½å‘¨æœŸä¹Ÿæ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆç”¨é•¿çš„åå­—å°†ä¼šæ›´æœ‰æ„ä¹‰ã€‚ä½†æ˜¯å±€éƒ¨å˜é‡è¿˜æ˜¯å‚è€ƒä»¥ä¸Šä¸‰ç‚¹\n1. é¡¹ç›®ç›®å½•å ä½¿ç”¨ä¸­åˆ’çº¿ç»„åˆ\n1 2 # BAD blog_server 1 2 # GOOD blog-server 2. åŒ…å ä½¿ç”¨ bytes.Buffer and strings.Readerï¼Œè€Œæ²¡æœ‰ bytes.ByteBuffer and strings.StringReader å¯¼å‡ºçš„è½¯ä»¶åŒ…åè¦æœ‰æ„ä¹‰, é¿å… util ï¼Œcommon ç­‰ é¿å…ä½¿ç”¨å¤§å†™å­—æ¯, ä¸”ä¸è¦æœ‰é‡å¤çš„å•è¯ 1 2 3 4 5 6 7 # BAD import ( \u0026#34;MyUtils\u0026#34; \u0026#34;blog_server\u0026#34; \u0026#34;blog-server\u0026#34; \u0026#34;blog server\u0026#34; ) 1 2 3 4 5 # GOOD import ( \u0026#34;cmd5\u0026#34; \u0026#34;blog\u0026#34; ) 3. æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹å æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åå»ºè®®ä½¿ç”¨ è›‡å½¢å‘½åï¼Œä¸€äº›ç³»ç»Ÿå¹¶ä¸ä¼šå¯¹æ–‡ä»¶ååŒºåˆ†å¤§å°å†™\n1 2 # BAD buildTest.go 1 2 # GOOD build_test.go é¿å…å’Œä¿ç•™ç‰¹å®šç”¨æ³•çš„åç¼€å†²çª\n1 2 # æµ‹è¯•æ–‡ä»¶ _test.go 1 2 3 # ç³»ç»Ÿç›¸å…³ _386.goã€_amd64.goã€_arm.goã€_arm64.goã€_android.goã€_darwin.goã€_dragonfly.goã€_freebsd.goã€_linux.goã€_nacl.goã€_netbsd.goã€_openbsd.goã€_plan9.goã€_solaris.goã€_windows.goã€_android_386.goã€_android_amd64.goã€_android_arm.goã€_android_arm64.goã€_darwin_386.goã€_darwin_amd64.goã€_darwin_arm.goã€_darwin_arm64.goã€_dragonfly_amd64.goã€_freebsd_386.goã€_freebsd_amd64.goã€_freebsd_arm.goã€_linux_386.goã€_linux_amd64.goã€_linux_arm.goã€_linux_arm64.goã€_linux_mips64.goã€_linux_mips64le.goã€_linux_ppc64.goã€_linux_ppc64le.goã€_linux_s390x.goã€_nacl_386.goã€_nacl_amd64p32.goã€_nacl_arm.goã€_netbsd_386.goã€_netbsd_amd64.goã€_netbsd_arm.goã€_openbsd_386.goã€_openbsd_amd64.goã€_openbsd_arm.goã€_plan9_386.goã€_plan9_amd64.goã€_plan9_arm.goã€_solaris_amd64.goã€_windows_386.go _windows_amd64.go 4. å¸¸é‡ ä½¿ç”¨å¤§å°å†™æ··æ’çš„é©¼å³°å‘½åï¼Œä¸å…è®¸å‡ºç°ä¸‹åˆ’çº¿ å­—æ¯ç¼©ç•¥è¯åº”å…¨å¤§å†™ , åƒASCIIå’ŒHTMLè¿™æ ·çš„ç¼©ç•¥è¯åˆ™é¿å…ä½¿ç”¨å¤§å°å†™æ··åˆçš„å†™æ³•ï¼Œå®ƒä»¬å¯èƒ½è¢«ç§°ä¸ºhtmlEscapeã€HTMLEscapeæˆ–escapeHTMLï¼Œä½†ä¸ä¼šæ˜¯escapeHtmlã€‚ 1 2 3 # BAD BLOG_SERVER escapeHtml 1 2 3 # GOOD BlogServer escapeHTML æŒ‰ç…§åŠŸèƒ½æ¥åŒºåˆ†ï¼Œè€Œéæ‰€æœ‰ç±»å‹éƒ½åˆ†åœ¨ä¸€ç»„ï¼Œå…¬å…±å¸¸é‡ç½®äºç§æœ‰å¸¸é‡ä¹‹å‰\n1 2 3 4 5 6 7 8 9 10 # BAD const ( # é”™è¯¯ : ç§æœ‰å¸¸é‡åº”å†™å…¬æœ‰å¸¸é‡åé¢ blog = \u0026#34;BLOG\u0026#34; Page=1 # ç”¨äºåˆ†é¡µ Limit=10 Page404 = \u0026#34;404\u0026#34; # æ ‡è®° ... ) 1 2 3 4 5 6 7 8 9 10 11 12 # GOOD const ( # åˆ†é¡µ Page = 1 Limit = 10 # æ ‡è®° Page404 = \u0026#34;404\u0026#34; # ç§æœ‰å¸¸é‡ blog = \u0026#34;BLOG\u0026#34; ) 5. å˜é‡ ä½¿ç”¨å¤§å°å†™æ··æ’çš„é©¼å³°å‘½åï¼Œä¸å…è®¸å‡ºç°ä¸‹åˆ’çº¿\nå±€éƒ¨å˜é‡ç®€çŸ­\nç”¨ i æ¯” index æ›´åˆé€‚ ç”¨ r æ¯” reader æ›´åˆé€‚ è‹¥ä¸º bool ç±»å‹, åº”ä»¥ hasï¼Œis ï¼Œcanï¼Œallow å¼€å¤´ è€ƒè™‘ä¸Šä¸‹æ–‡, é¿å…ä½¿ç”¨å†—ä½™åç§°\nGood code\n1 2 3 4 5 6 7 8 9 10 11 12 13 func RuneCount(b []byte) int { count := 0 for i := 0; i \u0026lt; len(b); { if b[i] \u0026lt; RuneSelf { i++ } else { _, n := DecodeRune(b[i:]) i += n } count++ } return count } å…¨å±€å˜é‡\nå˜é‡é•¿åº¦åº”ä¸ä½œç”¨åŸŸç›¸å…³ï¼Œä½œç”¨åŸŸè¶Šå°ï¼Œåˆ™ä½¿ç”¨ç®€çŸ­çš„å•å­—æ¯\nä½œç”¨åŸŸè¶Šå¤§ï¼Œå¯å®šä¹‰å®Œæ•´å•è¯æˆ–æœ‰æ„ä¹‰çš„å¥å­\n6. ç»“æ„ä½“ å»ºè®®é‡‡ç”¨åè¯\n7. æ¥å£ ä»…æŒ‡å®šä¸€ç§æ–¹æ³•çš„æ¥å£é€šå¸¸åœ¨å‡½æ•°ååé™„åŠ  erï¼Œå°½ç®¡å¯èƒ½ä¸æ˜¯æ­£ç¡®çš„è‹±è¯­\n1 2 3 4 5 6 7 8 type Reader interface { Read(p []byte) (n int, err error) } type Execer interface { Exec(query string, args []Value) (Result, error) } 8. å‡½æ•° å‡½æ•°ååŠ›æ±‚ç²¾ç®€å‡†ç¡®ï¼Œå¹¶é‡‡ç”¨åŠ¨è¯\nå‡½æ•°å‚æ•°\nç±»å‹æ˜¯æè¿°æ€§çš„, åº”è¯¥ç®€çŸ­\n1 2 func AfterFunc(d Duration, f func()) *Timer func Escape(w io.Writer, s []byte) å‡½æ•°åæ˜ç¡®ï¼Œç±»å‹ä¸æ˜ç¡®ï¼Œå‚æ•°åç§°å¯ä½¿ç”¨å•è¯ç¼©ç•¥\n1 func Unix(secï¼Œnsec int64) time å‚è€ƒ å¦‚ä½•å–åå­— ? CodeReviewComments Effective Go ","date":"2019-11-01T11:00:00Z","permalink":"https://blog.golang.space/p/1.%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99/","title":"1.å‘½åè§„åˆ™"},{"content":"é²²é¹å¼¹æ€§äº‘æœåŠ¡å™¨è¿è¡Œç½‘ç»œçˆ¬è™«ï¼ˆä¸Šï¼‰\né›¶ ç³»ç»Ÿï¼šubuntu 18.04\nçˆ¬è™«ï¼špyspider\nå®¹å™¨å¼•æ“ï¼šdocker\næœåŠ¡å™¨ï¼šé²²é¹å¼¹æ€§äº‘KC1\nè®°å½•å…¨éƒ¨è¿‡ç¨‹\nä¸€ å¼€æ”¾5000ç«¯å£ ã€æ§åˆ¶å°ã€‘-ã€å¼¹æ€§äº‘æœåŠ¡å™¨ECSã€‘-ã€å®‰å…¨ç»„ã€‘-ã€é…ç½®è§„åˆ™ã€‘-ã€æ·»åŠ è§„åˆ™ã€‘\näºŒ Python ç¯å¢ƒ åˆ†åˆ«æ˜¯ ä¾èµ–åº“ï¼Œ python3ï¼Œ pipåŒ…ç®¡ç†\n1 2 3 4 5 sudo apt-get install python3-dev build-essential libssl-dev libffi-dev libxml2 libxml2-dev libxslt1-dev zlib1g-dev sudo apt-get install python3 sudo apt-get install python3-pip äºŒ pyspider å®‰è£… pyspideræ˜¯ä¸€ä¸ªçˆ¬è™«æ¶æ„çš„å¼€æºåŒ–å®ç°ã€‚ä¸»è¦çš„åŠŸèƒ½éœ€æ±‚æ˜¯ï¼š\næŠ“å–ã€æ›´æ–°è°ƒåº¦å¤šç«™ç‚¹çš„ç‰¹å®šçš„é¡µé¢ éœ€è¦å¯¹é¡µé¢è¿›è¡Œç»“æ„åŒ–ä¿¡æ¯æå– çµæ´»å¯æ‰©å±•ï¼Œç¨³å®šå¯ç›‘æ§ å»é‡è°ƒåº¦ï¼Œé˜Ÿåˆ—ï¼ŒæŠ“å–ï¼Œå¼‚å¸¸å¤„ç†ï¼Œç›‘æ§ç­‰åŠŸèƒ½ä½œä¸ºæ¡†æ¶ï¼Œæä¾›ç»™æŠ“å–è„šæœ¬ï¼Œå¹¶ä¿è¯çµæ´»æ€§ã€‚æœ€ååŠ ä¸Šwebçš„ç¼–è¾‘è°ƒè¯•ç¯å¢ƒï¼Œä»¥åŠwebä»»åŠ¡ç›‘æ§ï¼Œå³æˆä¸ºäº†è¿™å¥—æ¡†æ¶ã€‚\n1 pip3 install pyspider åœ¨å®‰è£…çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†é”™è¯¯ï¼ŒæœŸé—´æ€»å…±é‡åˆ°è¿‡ 3 æ¬¡å¼‚å¸¸ï¼Œè¶…æ—¶é”™è¯¯ï¼Œé€€å‡ºå¼‚å¸¸ç­‰ï¼ŒæŒ‰ç…§æ­¥éª¤ä¸€æ­¥æ­¥æ¥ï¼Œä¼šå¥½èµ·æ¥çš„ã€‚\næ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼Œå†æ¬¡å®‰è£… pyspiderï¼Œè€å¿ƒç­‰å¾…å‡ åˆ†é’Ÿï¼ŒæŸ¥çœ‹ç‰ˆæœ¬\n1 2 apt-get install libcurl4-openssl-dev pip3 install pyspider ä¸‰ phantomjs å®‰è£… PhantomJS æ˜¯ä¸€ä¸ªåŸºäº webkit çš„ javascriptAPIã€‚å®ƒä½¿ç”¨ QtWebKit ä½œä¸ºå®ƒæ ¸å¿ƒæµè§ˆå™¨çš„åŠŸèƒ½ï¼Œä½¿ç”¨webkitæ¥ç¼–è¯‘è§£é‡Šæ‰§è¡ŒJavaScriptä»£ç ã€‚ä»»ä½•ä½ å¯ä»¥åœ¨åŸºäº webki tæµè§ˆå™¨åšçš„äº‹æƒ…ï¼Œå®ƒéƒ½èƒ½åšåˆ°ã€‚PhantomJS çš„ç”¨å¤„å¯è°“éå¸¸å¹¿æ³›ï¼Œè¯¸å¦‚ç½‘ç»œç›‘æµ‹ã€ç½‘é¡µæˆªå±ã€æ— éœ€æµè§ˆå™¨çš„Web æµ‹è¯•ã€é¡µé¢è®¿é—®è‡ªåŠ¨åŒ–ç­‰ã€‚\n1 2 3 wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2 tar -jxvf phantomjs.tar.bz2 ln -s /usr/local/phantomjs-2.1.1-linux-x86_64/bin/phantomjs /usr/bin/phantomjs ç¯å¢ƒå·²ç»é…ç½®å®Œæ¯•ï¼Œè¿è¡Œä¸€ä¸‹è¯•è¯•\nå›› å¼‚å¸¸ æœ€ä¼šï¼Œåº”è¯¥è¿˜ä¼šé‡åˆ°ä¸€ä¸ªç”Ÿå‘½ä¸­çš„ BUGï¼Œæœ¬æ–‡å¯ä»¥è¯´æ¶µç›–äº†å®‰è£…è¿‡ç¨‹çš„å¤§éƒ¨åˆ†é—®é¢˜\nä¸»è¦é”™è¯¯ä¿¡æ¯æ˜¯\n1 2 3 4 File \u0026#34;/usr/local/lib/python3.6/dist-packages/wsgidav/wsgidav_app.py\u0026#34;, line 118, in _check_config raise ValueError(\u0026#34;Invalid configuration:\\n - \u0026#34; + \u0026#34;\\n - \u0026#34;.join(errors)) ValueError: Invalid configuration: - Deprecated option \u0026#39;domaincontroller\u0026#39;: use \u0026#39;http_authenticator.domain_controller\u0026#39; instead. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤\n1 2 3 pip3 install wsgidav==2.4.1 # ç»ˆäºå¯åŠ¨ pyspider all äº” åœ¨æœ¬åœ°ç”µè„‘è¾“å…¥ ip:5000 é¢„å‘Šï¼š ä¸‹ä¸€ç¯‡åšæ–‡ï¼Œæ­£å¼å¼€å§‹ç½‘ç»œçˆ¬è™«ï¼Œå°†ä»¥å°ç™½çš„è§†è§’æ¥è®°å½•ï¼Œå¹¶ä¸ä¼šæ™¦æ¶©éš¾æ‡‚\né²²é¹å¼¹æ€§äº‘æœåŠ¡å™¨è¿è¡Œç½‘ç»œçˆ¬è™«ï¼ˆä¸‹ï¼‰\né›¶ ç³»ç»Ÿï¼šubuntu 18.04\nçˆ¬è™«ï¼špyspider\næœåŠ¡å™¨ï¼šé²²é¹å¼¹æ€§äº‘KC1\nè®°å½•å…¨éƒ¨è¿‡ç¨‹\nä¸€ è®¾ç½®ç™»å½•è´¦å·å’Œå¯†ç  åˆ›å»º db.json æ–‡ä»¶ï¼Œç”¨äºè®¾ç½®ç™»å½•è´¦å·å’Œå¯†ç \nä¸è¦åœ¨ data æ–‡ä»¶å¤¹å†…åˆ›å»º db.jsonï¼Œdata æ˜¯ pyspider ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶åˆ›å»ºçš„æ–‡ä»¶ï¼Œä¿å­˜ç€æ•°æ®ä¿¡æ¯ï¼Œæ‰€ä»¥æœ€å¥½æ¯æ¬¡è¿è¡Œéƒ½åœ¨ data çš„çˆ¶ç›®å½•æˆ–è€…æŒ‡å®š data ç›®å½•ä½ç½®ï¼Œä»¥ä¿è¯æ—§æ•°æ®å­˜åœ¨ã€‚\næ‰§è¡Œå‘½ä»¤å¯åŠ¨\n1 pyspider --config db.json all åœ¨æœ¬åœ°ç”µè„‘ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥æœåŠ¡å™¨çš„ipåœ°å€ï¼š5000ï¼Œå³å¼¹å‡ºç™»å½•å¯¹è¯æ¡†ï¼Œè¾“å…¥ä¹‹å‰è®¾ç½®çš„ç”¨æˆ·åå’Œå¯†ç \näºŒ åˆ›å»ºç¬¬ä¸€ä¸ªçˆ¬è™« ç®€å•çš„æ“ä½œï¼Œè§å›¾\nåˆ›å»ºä¹‹åï¼Œè‡ªåŠ¨ç”ŸæˆåŸºç¡€ä»£ç ï¼Œ15 è¡Œæ¨ªçº¿å¤„æ˜¯å¾…çˆ¬å–çš„é¦–é¡µé“¾æ¥ï¼Œ19 è¡Œæ˜¯æŸ¥æ‰¾è¯¦æƒ…é¡µï¼Œä¹Ÿå°±æ˜¯é¦–é¡µé¢çš„æ‰€æœ‰è·³è½¬é“¾æ¥ï¼Œæœ€åçš„æ–¹æ¡†åˆ™æ˜¯è¿”å›çš„ç»“æœ\nä¸‰ å®æˆ˜ çˆ¬å–ç½‘é¡µï¼šhttp://quotes.toscrape.com/\nä¿¡æ¯ï¼šåè¨€å†…å®¹ï¼Œä½œè€…ï¼Œæ ‡ç­¾\næŸ¥çœ‹ç½‘é¡µä¿¡æ¯ï¼Œæ¯ä¸€å¥åè¨€éƒ½æ˜¯ä¸€ä¸ªdivï¼Œclass=quoteï¼Œ è¿™é‡Œå…³é”®å­—æ˜¯ quote\n1 2 3 4 5 6 7 8 9 @every(minutes=24 * 60) def on_start(self): self.crawl(\u0026#39;http://quotes.toscrape.com/\u0026#39;, callback=self.index_page) @config(age=10 * 24 * 60 * 60) def index_page(self, response): results = [] for each in response.doc(\u0026#39;.quote\u0026#39;).items(): pass F12 æŸ¥çœ‹å…ƒç´ ï¼Œå…ƒç´ é€‰æ‹©å™¨ï¼ˆå›¾ç‰‡ä¸­çº¢æ ‡1ï¼‰é€‰æ‹©ä½œè€…åï¼Œåœ¨å³è¾¹ä»£ç æ å¯è§è¯¥æ ‡ç­¾ï¼Œå…¶å®ƒæ ‡ç­¾å±æ€§æœ‰ itemprop=\u0026quot;author\u0026quot; ï¼Œä»¥æ­¤ç±»æ¨\nä»£ç å¯ä»¥è¿™æ ·å†™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # åè¨€ç»“æœé›† results = [] # å¾ªç¯æ¯ä¸€å¥åè¨€ for each in response.doc(\u0026#39;.quote\u0026#39;).items(): # åè¨€ comment = each.find(\u0026#39;[itemprop=\u0026#34;text\u0026#34;]\u0026#39;).text() # ä½œè€… author = each.find(\u0026#39;[itemprop=\u0026#34;author\u0026#34;]\u0026#39;).text() # æ ‡ç­¾ tags = each.find(\u0026#39;.tags .tag\u0026#39;).items() # æ ‡ç­¾ç»“æœé›† tagList = [] for tag in tags: tagList.append(tag.text()) # å°†æŸ¥è¯¢åˆ°åè¨€å°è£…åˆ°åè¨€ç»“æœé›† results.append({ \u0026#34;comment\u0026#34;: comment, \u0026#34;author\u0026#34;: author, \u0026#34;tagList\u0026#34;: tagList }) ç»“æœ\nå›› å°†ç»“æœå­˜å‚¨åˆ° MongoDB å¦‚ä½•åœ¨é²²é¹å¼¹æ€§äº‘éƒ¨ç½² MongoDBï¼Œè§ä¸‹é“¾\nhttps://bbs.huaweicloud.com/forum/thread-28769-1-1.html\n1\nå®‰è£… pymongo\n1 pip3 install pymongo 2\nçˆ¬è™«ä»£ç ï¼š\n1 2 # å¯¼å…¥ import pymongo 1 2 3 4 # è¿æ¥ mongodb æ•°æ®åº“ client = pymongo.MongoClient(\u0026#39;119.3.248.122\u0026#39;) # åº“åä¸º demo1 db = client[\u0026#39;demo1\u0026#39;] 1 2 3 4 5 6 7 8 9 # å¦‚æœæœ‰ç»“æœé›†ï¼Œè°ƒç”¨å­˜å‚¨æ•°æ®åº“å‡½æ•° def on_result(self,result): if result: self.save_to_mongo(result) # å­˜åˆ°æ•°æ®åº“ def save_to_mongo(self,result): if self.db[\u0026#39;comment\u0026#39;].insert(result): print(\u0026#39;saved to mongo\u0026#39;,result) #åŒ–é²²ä¸ºé¹ï¼Œæˆ‘æœ‰è¯è¯´# é²²é¹å¼¹æ€§äº‘æœåŠ¡å™¨è¿è¡Œç½‘ç»œçˆ¬è™«ï¼ˆä¸‹ï¼‰åˆ†é¡µä¸æ€»ç»“\nä¸€ åˆ†é¡µ é€šè¿‡ä¹‹å‰çš„æ–¹æ³•ï¼Œç”¨é€‰æ‹©å™¨ç‚¹å‡»å›¾æ ‡ï¼Œå³ä¾§ä»£ç æ¡†ä¼šè‡ªåŠ¨å®šä½è¯¥å…ƒç´ ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°é€šè¿‡ /page/2/ ä»¥æœ«å°¾çš„æ•°å­—è¿›è¡Œåˆ†é¡µ\nè·å–è¯¥é“¾æ¥, ç„¶åé€’å½’è°ƒç”¨è‡ªå·±ä¸€ç›´æŸ¥è¯¢\n1 2 next = response.doc(\u0026#39;.next a\u0026#39;).attr.href self.crawl(next, callback=self.index_page) äºŒ æºç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 #!/usr/bin/env python # -*- encoding: utf-8 -*- # Created on 2019-11-24 03:27:43 # Project: demo1 from pyspider.libs.base_handler import * import pymongo class Handler(BaseHandler): crawl_config = { \u0026#39;itag\u0026#39;: \u0026#39;v224\u0026#39; } # è¿æ¥ mongodb æ•°æ®åº“ client = pymongo.MongoClient(\u0026#39;localhost\u0026#39;) # åº“åä¸º trip db = client[\u0026#39;demo1\u0026#39;] @every(minutes=24 * 60) def on_start(self): self.crawl(\u0026#39;http://quotes.toscrape.com/\u0026#39;, callback=self.index_page) @config(age=60) def index_page(self, response): self.crawl(response.url, callback=self.detail_page) next = response.doc(\u0026#39;.next a\u0026#39;).attr.href # é€’å½’è°ƒç”¨ self.crawl(next, callback=self.index_page) @config(priority=2) def detail_page(self, response): results = [] for each in response.doc(\u0026#39;.quote\u0026#39;).items(): comment = each.find(\u0026#39;[itemprop=\u0026#34;text\u0026#34;]\u0026#39;).text() author = each.find(\u0026#39;[itemprop=\u0026#34;author\u0026#34;]\u0026#39;).text()# ä½œè€… # æ ‡ç­¾ tags = each.find(\u0026#39;.tags .tag\u0026#39;).items() # æ ‡ç­¾ç»“æœé›† tagList = [] for tag in tags: tagList.append(tag.text()) # å°†æŸ¥è¯¢åˆ°åè¨€å°è£…åˆ°åè¨€ç»“æœé›† results.append({ \u0026#34;comment\u0026#34;: comment, \u0026#34;author\u0026#34;: author, \u0026#34;tagList\u0026#34;: tagList }) return results # ä¿å­˜ def on_result(self,result): if result: self.save_to_mongo(result) # å­˜åˆ°æ•°æ®åº“ def save_to_mongo(self,result): if self.db[\u0026#39;comment\u0026#39;].insert(result): print(\u0026#39;saved to mongo\u0026#39;,result) ä¸‰ å¸¸ç”¨æ–¹æ³• auto_recrawl åœ¨ä»»åŠ¡è¿‡æœŸåï¼Œè‡ªåŠ¨é‡çˆ¬å–\nmethod è¯·æ±‚æ–¹æ³•ï¼Œé»˜è®¤ get è¯·æ±‚\nparams è¿½åŠ å‚æ•° urlï¼Œ æ„Ÿè§‰ä¸å¸¸ç”¨\ndata ç”¨äºæäº¤ post è¯·æ±‚çš„æ•°æ®ï¼Œå¯ä»¥ç”¨äºç™»å½•ï¼Ÿ\nconnect_timeout è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤20ç§’\ntimeout è¶…æ—¶çš„è¯·æ±‚æ—¶é—´ï¼Œé»˜è®¤120ç§’\nvalidate_cert é’ˆå¯¹ https ç½‘ç«™ï¼Œä¼šçˆ†è¯ä¹¦é”™è¯¯ï¼Œè®¾ç½® false å¯ä»¥å¿½ç•¥å¹¶ç»§ç»­è®¿é—®ï¼Œé»˜è®¤true\nproxy ä»£ç†\netag å¸ƒå°”ç±»å‹å˜é‡ï¼Œé»˜è®¤ trueï¼Œ åˆ¤æ–­æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œæ²¡æœ‰å‘ç”Ÿå˜åŒ–å°±ä¸çˆ¬äº†\nfetch_type è¯·æ±‚çš„åŸå§‹çš„ docment, è®¾ç½® =js å,å°±å¯ä»¥è°ƒç”¨ js è¿›è¡Œæ¸²æŸ“\nfetch_type='js'\njs_script å¯ä»¥æ‰§è¡Œjs æ“ä½œ, æ¯”å¦‚æ»šåŠ¨åˆ°ç½‘é¡µçš„æœ€ä¸‹ç«¯,è§¦å‘æ›´å¤šåŠ è½½\n1 window.scrollTo(0,document.body.scrollHeight); js_run_at å°†è„šæœ¬åŠ å…¥åˆ°å‰é¢æˆ–è€…åé¢æ‰§è¡Œ,é»˜è®¤æ˜¯åé¢\njs_viewport_width/js_viewport_height è§†çª—çš„å¤§å°\nload_images æ˜¯å¦åŠ è½½å›¾ç‰‡,é»˜è®¤ false\nsave åšå¤šä¸ªå‡½æ•°ä¹‹é—´ä¼ é€’å˜é‡,ç›¸å½“äº response çš„session\ntaskid å”¯ä¸€æ ‡è¯†ç ï¼Œå»é‡\nå›› web æµè§ˆæ¡† ä½¿ç”¨çš„æ—¶å€™å‘ç°è¿™ä¸ªæµè§ˆæ¡†éå¸¸çš„å°, æ”¹å˜æ–¹æ³•è§ä¸‹å›¾2\næ­¤æ–¹æ³•åªèƒ½ç”¨äºæœ¬æ¬¡, ä¸€åŠ³æ°¸é€¸éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶\nè¯¥è·¯å¾„æ˜¯æŒ‡å‘ pyspider æ–‡ä»¶å¤¹\nsudo vim /usr/local/lib/python3.5/dist-packages/pyspider/webui/static/debug.min.css\nå¢åŠ  iframe çš„æ ·å¼: height:900px !important\n","date":"2019-10-25T15:00:00Z","permalink":"https://blog.golang.space/p/python-%E7%88%AC%E8%99%AB%E7%BB%83%E6%89%8B/","title":"python çˆ¬è™«ç»ƒæ‰‹"},{"content":"flutter ä¸€äº›æŠ€å·§ [toc]\nå±€éƒ¨è®¾ç½®æ˜æš—ä¸»é¢˜ å¤šè®¾å¤‡å¯åŠ¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 { // ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚ // æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚ // æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387 \u0026#34;version\u0026#34;: \u0026#34;0.2.0\u0026#34;, \u0026#34;configurations\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;Current Device\u0026#34;,\t// è®¾å¤‡å \u0026#34;request\u0026#34;: \u0026#34;launch\u0026#34;,\t// æ“ä½œ \u0026#34;type\u0026#34;: \u0026#34;dart\u0026#34;,\t// è¯­è¨€ç±»å‹ \u0026#34;program\u0026#34;: \u0026#34;lib/main_dev.dart\u0026#34; // å…¥å£ }, { \u0026#34;name\u0026#34;: \u0026#34;Android\u0026#34;, \u0026#34;request\u0026#34;: \u0026#34;launch\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;dart\u0026#34;, \u0026#34;deviceId\u0026#34;: \u0026#34;android\u0026#34;, \u0026#34;program\u0026#34;: \u0026#34;lib/main_dev.dart\u0026#34; // å…¥å£ }, { \u0026#34;name\u0026#34;: \u0026#34;iPhone\u0026#34;, \u0026#34;request\u0026#34;: \u0026#34;launch\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;dart\u0026#34;, \u0026#34;deviceId\u0026#34;: \u0026#34;iPhone\u0026#34; } ], \u0026#34;compounds\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;All Devices\u0026#34;, \u0026#34;configurations\u0026#34;: [\u0026#34;Android\u0026#34;, \u0026#34;iPhone\u0026#34;] } ] } ListView åµŒå¥— ListView 1 2 shrinkWrap: true, //è§£å†³æ— é™é«˜åº¦é—®é¢˜ physics: new NeverScrollableScrollPhysics(),\t//ç¦ç”¨æ»‘åŠ¨äº‹ä»¶ åˆ·æ–°æ•ˆæœ , å³è½¬åœˆåŠ¨ç”» èƒŒæ™¯é€æ˜çš„è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Navigator.of(context).push( PageRouteBuilder( opaque:false, pageBuilder: (context, animation, secondaryAnimation) { return Scaffold( backgroundColor: Colors.transparent, body: SafeArea( child: Stack( children: \u0026lt;Widget\u0026gt;[ //... ], ), ) ); } )); å±å¹•é€‚é… å‚è€ƒ https://github.com/jiang111/flutter_code/blob/master/lib/ui_4/home_page.dart\nå…¨å±€åæ ‡è½¬æ¢å±€éƒ¨åæ ‡ 1 2 RenderBox box = context.findRenderObject(); _tapPos = box.globalToLocal(details.globalPosition); å¼ºåˆ¶ç«–å± 1 2 3 // å¼ºåˆ¶ç«–å± // SystemChrome.setPreferredOrientations( // [DeviceOrientation.portraitUp, DeviceOrientation.portraitDown]); ç½‘ç»œè¯·æ±‚å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 return Center( child: FutureBuilder\u0026lt;dynamic\u0026gt;( future: CommentApi.getCommentList( elem[\u0026#34;id\u0026#34;], 10, 0), // a previously-obtained Future\u0026lt;String\u0026gt; or null builder: (BuildContext context, AsyncSnapshot snapshot) { switch (snapshot.connectionState) { // æœªæ‰§è¡Œ case ConnectionState.none: // è¿æ¥åˆ°å¼‚æ­¥æ“ä½œ return Text(\u0026#39;Press button to start.\u0026#39;); case ConnectionState.active: // è¯·æ±‚ä¸­ case ConnectionState.waiting: // // è¯·æ±‚æœªç»“æŸï¼Œæ˜¾ç¤ºloading return Text(\u0026#34;\u0026#34;); // return CircularProgressIndicator(); case ConnectionState.done: // è¯·æ±‚å®Œæˆ if (snapshot.hasError) return Text(\u0026#39;Error: ${snapshot.error}\u0026#39;); List list = snapshot.data as List; return Column( mainAxisAlignment: MainAxisAlignment.start, crossAxisAlignment: CrossAxisAlignment.start, children: comment(context, list), ); } return null; // unreachable }, )); æ—¶é—´æ ¼å¼åŒ– 1 2 3 4 5 import \u0026#39;package:intl/intl.dart\u0026#39; var _formatter = new DateFormat(\u0026#39;yyyy-MM-dd\u0026#39;); var _createTime = _formatter.format(DateTime.parse(elem[\u0026#34;create_time\u0026#34;])); æ¸å˜è‰² 1 2 3 4 5 6 7 8 Container( decoration: BoxDecoration( gradient: LinearGradient( colors: [Color(0xFFfbab66), Color(0xFFf7418c)], begin: Alignment.topCenter, end: Alignment.bottomCenter, )), ); åœ†å½¢å¤´åƒ 1 2 3 4 CircleAvatar( maxRadius: 15, backgroundImage: NetworkImage(_icon), ), likebutton 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 LikeButton( onTap: (bool flag) { return onLikeButtonTap(flag, _id); }, isLiked: _likes, size: 18, likeCount: _count, countPostion: CountPostion.left, likeCountPadding: EdgeInsets.only(right: 5), likeBuilder: (bool flag) { return Image( image: AssetImage(\u0026#34;images/like.png\u0026#34;), height: 18, color: flag ? Colors.redAccent : Colors.grey[600], ); }, ), Future\u0026lt;bool\u0026gt; onLikeButtonTap(bool isLiked, String id) { if (isLiked != true) { // send your request here CommentApi.putLike(id).then((value) { if (value.statusCode != 200) { message(\u0026#34;ç½‘ç»œå¼‚å¸¸,è¯·ç¨åå†è¯•\u0026#34;); isLiked = isLiked; } else { isLiked = true; } }); } final Completer\u0026lt;bool\u0026gt; completer = new Completer\u0026lt;bool\u0026gt;(); Timer(const Duration(milliseconds: 200), () { // if your request is failed,return null, completer.complete(isLiked); }); return completer.future; } å›¾ç‰‡ä¸Šä¼  https://www.jianshu.com/p/b582daddd737\nhttp://47.105.149.100/web/flutter-cai-kang-ri-ji-chi-xu-geng-xin-\nç‚¹å‡»å¯ä¿®æ”¹çš„å±æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 Container( height: 25, width: 100, alignment: Alignment.centerLeft, child: TextField( onTap: () { if (authorController.text == UserApi.model.getUserInfo[\u0026#34;nick_name\u0026#34;]) { authorController.text = \u0026#39;\u0026#39;; } // é»˜è®¤å€¼åˆ™è‡ªåŠ¨ç½®ç©º }, maxLines: 1, maxLength: 7, // é™åˆ¶æœ€é•¿å­—ç¬¦ controller: authorController, decoration: InputDecoration( counterText: \u0026#34;\u0026#34;, // ä¸æ˜¾ç¤ºå­—ç¬¦ä¸²æ•°é‡ disabledBorder: InputBorder.none,// æ— è¾¹æ¡† enabledBorder: InputBorder.none, focusedBorder: InputBorder.none, border: InputBorder.none, // contentPadding: EdgeInsets.all(10.0), ), autofocus: false, textAlign: TextAlign.left, style: Theme.of(context).textTheme.bodyText2, )), ], ), ç»„ä»¶ä½ç½® 1 2 3 4 5 GlobalKey anchorKey = GlobalKey(); RenderBox renderBox = anchorKey.currentContext.findRenderObject(); var offset = renderBox.localToGlobal(Offset(0.0, 0.0)); å»¶è¿Ÿæ‰§è¡Œ 1 2 3 4 5 // å»¶æ—¶1sæ‰§è¡Œè¿”å› Future.delayed(Duration(seconds: 1), (){ Navigator.of(context).pop(); print(\u0026#39;å»¶æ—¶1sæ‰§è¡Œ\u0026#39;); }); wifi çœŸæœºè°ƒè¯• https://juejin.im/post/5c9848cae51d450d91120278\nå®šæ—¶å™¨ å¾ªç¯æ‰§è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import \u0026#39;dart:async\u0026#39;; // å¼•å…¥å®šæ—¶å»æ‰€éœ€è¦çš„åŒ… Timer _timer; // å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œåœ¨é¡µé¢é”€æ¯æ—¶éœ€è¦ç”¨åˆ°ï¼Œå¦‚æœåœ¨å®šæ—¶å™¨å†…éƒ¨å·²ç»é”€æ¯äº†ï¼Œå¯ä»¥ä¸éœ€è¦ int _count = 0; // ä¸€åˆ‡ä¸ºäº†æ¼”ç¤ºã€‚å®šä¹‰çš„å˜é‡ ... myTimer() { // å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå°†å®šæ—¶å™¨åŒ…è£¹èµ·æ¥ _timer = Timer.periodic(Duration(milliseconds: 1000), (t) { _count++; if (_count==5) { t.cancel(); // å®šæ—¶å™¨å†…éƒ¨è§¦å‘é”€æ¯ } }); } ... @override void dispose(() { if (_timer != null) { // é¡µé¢é”€æ¯æ—¶è§¦å‘å®šæ—¶å™¨é”€æ¯ if (_timer.isActive) { // åˆ¤æ–­å®šæ—¶å™¨æ˜¯å¦æ˜¯æ¿€æ´»çŠ¶æ€ _timer.cancel(); } } super.dispose(); }); https://juejin.im/post/5cada409e51d456e5b66ad1b\nhttps://juejin.im/post/5d81cf6d518825485e227b8c\nä»…ä»…æ‰§è¡Œä¸€æ¬¡, åœ¨æ„é€ ä¸­å†™é€»è¾‘ 1 2 3 4 5 MineView() { WidgetsBinding.instance.addPostFrameCallback((callback) { HttpUtils.userModel.controller.callRefresh(); }); } è‡ªå®šä¹‰é«˜åº¦ appbar 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 appBar: AppBar( brightness: Brightness.dark, leading: navigatPop(context, color: Colors.white), backgroundColor: Colors.blue[300], bottom: PreferredSize( child: Column( children: [ Container( padding: EdgeInsets.only(left: 20, bottom: 30), alignment: Alignment.centerLeft, child: Text( title, style: Theme.of(context) .textTheme .headline6 .copyWith(color: Colors.white), ), ), ], ), preferredSize: Size(double.infinity, 70)), ), æ»‘åŠ¨åˆ é™¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 Slidable( key: Key(index.toString()), actionPane: SlidableScrollActionPane(), //æ»‘å‡ºé€‰é¡¹çš„é¢æ¿ åŠ¨ç”» actionExtentRatio: 0.25, dismissal: SlidableDismissal( child: SlidableDrawerDismissal(), onWillDismiss: (actionType) { return action(index, e.id); }, onDismissed: (actionType) { print(actionType); }, ), secondaryActions: \u0026lt;Widget\u0026gt;[ Padding( padding: EdgeInsetsDirectional.only(top: 20, bottom: 15), child: IconSlideAction( caption: \u0026#39;Delete\u0026#39;, color: Colors.red, icon: Icons.delete, closeOnTap: false, onTap: () { showIosDialog(context, title: title, desc: desc) .then((value) { if (value) { action(index, e.id); } }); })), ], Flutter TextFieldè®¾ç½®åªè¯»ä¸å¯ç¼–è¾‘ 1 2 3 4 TextField( enableInteractiveSelection: false, onTap: () { FocusScope.of(context).requestFocus(new FocusNode()); }, ) å‚è€ƒ : [http://www.appblog.cn/2019/01/22/Flutter%20TextField%E8%AE%BE%E7%BD%AE%E5%8F%AA%E8%AF%BB%E4%B8%8D%E5%8F%AF%E7%BC%96%E8%BE%91/](http://www.appblog.cn/2019/01/22/Flutter TextFieldè®¾ç½®åªè¯»ä¸å¯ç¼–è¾‘/)\nå¯é€‰çš„ text selectabletext ","date":"2019-10-09T00:00:00Z","permalink":"https://blog.golang.space/p/flutter-%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7/","title":"flutter ä¸€äº›æŠ€å·§"},{"content":"å›¾åºŠ ä¸ƒç‰›äº‘å…è´¹èµ é€ç”¨æˆ· 10G å­˜å‚¨ç©ºé—´ï¼Œç”¨æ¥åšå›¾åºŠç»°ç»°æœ‰ä½™\nä½¿ç”¨ PicGo ä¸Šä¼ å›¾ç‰‡ æ³¨å†Œç™»å½•ä¸ƒç‰›äº‘ï¼Œç»‘å®šç›¸å…³ä¿¡æ¯ã€‚åœ¨ å¯†é’¥ç®¡ç† é¡µé¢å¤åˆ¶ ã€ŒAKã€å’Œã€ŒSKã€ã€‚\nPicGoå¸®åŠ©æ–‡æ¡£\nå¦‚æœä½¿ç”¨å¿«æ·é”®ä¸Šä¼ , è¦ä½¿ç”¨åˆ° xclip, å¿…é¡»å®‰è£…\nå­˜å‚¨ç©ºé—´åä¼¼ä¹ä¸èƒ½ç”¨ - ï¼Œç¬¬ä¸€æ¬¡é…ç½®çš„æ—¶å€™ä¸€ç›´ä¸Šä¼ å¤±è´¥ï¼Œæ›´æ¢ç©ºé—´ååæå®š\næ›´æ¢è‡ªå®šä¹‰åŸŸå ä¸ƒç‰›äº‘çš„èåˆåŸŸååªèƒ½ä½¿ç”¨ 30 å¤©, è¿™é‡Œæ›´æ¢æˆè‡ªå·±çš„äºŒçº§åŸŸå\nè¿›å…¥é¡µé¢åæ·»åŠ åŸŸå è¿™é‡Œåˆ›å»ºæ—¶ï¼Œå¤šæ¬¡æç¤ºåŸŸåæœªå¤‡æ¡ˆï¼ŒåŸŸåé”™è¯¯ç­‰ï¼Œå¤šå°è¯•å‡ æ¬¡å³å¯åˆ›å»º\nåœ¨å¯¹è±¡å­˜å‚¨ä¸­å°†è¯¥åŸŸåè®¾ç½®ä¸ºé»˜è®¤è·¯å¾„\nåœ¨åŸŸåå•†å¤„è®¾ç½® dns è§£æ\nå…¶ä¸­çš„è®°å½•å€¼æ¥è‡ªäºä¸‹å›¾\næœ€åï¼Œå°†åŸŸåæ‹·è´è‡³ PicGo\nä½¿ç”¨ HTTPS ä½¿ç”¨æ–°ç‰ˆæœ¬è°·æ­Œæµè§ˆå™¨ http çš„å›¾ç‰‡ä¸èƒ½åŠ è½½ï¼Œå‡çº§æ›´å®‰å…¨çš„ httpsã€‚\nåˆ›å»ºè¯ä¹¦ï¼Œä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ï¼Œéƒ¨ç½² CDN å³å¯ã€‚\næ›´æ¢äº†uPic åœ¨ 20 å¹´åˆä½¿ç”¨ PicGo é‡åˆ°äº†ä¸Šä¼ å¶å°”å¤±æ•ˆçš„ bugï¼Œå› æ­¤åˆ‡æ¢æˆ uPicï¼Œå…è´¹ï¼Œå¼ºå¤§!\nä¿å­˜è·¯å¾„:\n1 PicGo/{since_millisecond}-{filename}{.suffix} ","date":"2019-03-13T00:00:00Z","image":"http://img.golang.space/1615999792525-o6sBvr.jpg","permalink":"https://blog.golang.space/p/%E5%9B%BE%E5%BA%8A/","title":"å›¾åºŠ"},{"content":"è®°å½•ç¬”è®°çš„é£æ ¼\næ–‡ä»¶åé£æ ¼ åç¼€ä½¿ç”¨å°å†™ åŒæ—¶æœ‰ä¸­è‹±æ–‡ï¼Œè‹±æ–‡ä¸¤è¾¹åŠ ç©ºæ ¼ ä½¿ç”¨è¿å­—ç¬¦ -ï¼Œè€Œéä¸‹åˆ’çº¿æˆ–é©¼å³°ï¼Œè¿å­—ç¬¦æ˜¯ç°åœ¨æœ€æµè¡Œçš„ç½‘å€åˆ†éš”ç¬¦ ä¸»é¢˜é£æ ¼ å»ºè®® ## äºŒçº§æ ‡é¢˜ä¹‹é—´å¯å¤šåŠ ä¸€è¡Œç©ºæ ¼ åç§°ç”± {å¤§æ ‡é¢˜åºå·}.{å°æ ‡é¢˜åºå·}.{æ ‡é¢˜} ç»„æˆï¼Œè‹¥æ–‡ç« æ— åºä»ä»»æ„ä½ç½®æŸ¥çœ‹éƒ½å¯ä»¥ ( æ¯”å¦‚è¿™ç¯‡ ) å¯ä¸è¦åºå· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # Title å¼•è¨€ ## 1.ç›¸å…³è§é—» ä»‹ç»ã€è¯´æ˜ ### 1.1.å°æ ‡é¢˜ ## 2.åŸºç¡€å†…å®¹ ### 2.1.å°æ ‡é¢˜ ### 2.2.å°æ ‡é¢˜ ## 3.ä½¿ç”¨æ¡ˆä¾‹ ### 3.1.å°æ ‡é¢˜ ### 3.2.å°æ ‡é¢˜ ä»£ç å— Golang ä»£ç å—ç¤ºä¾‹\n1 2 3 func main(){ fmt.Println(\u0026#34;hi\u0026#34;) } Golang ä»£ç  markdown æ ¼å¼ï¼Œæ³¨æ„å³ä¸Šè§’æ ‡æ˜ go è¯­è¨€\n1 2 3 4 5 ```go func main(){ fmt.Println(\u0026#34;hi\u0026#34;) } â€‹``` Javascript ä»£ç æ ¼å¼\n1 2 3 ```js console.log(\u0026#34;hi\u0026#34;) â€‹``` html ä»£ç æ ¼å¼\n1 2 3 4 5 ```css .body{ padding: 0px; } â€‹``` å¼•å·ä½¿ç”¨åœºæ™¯ ä½¿ç”¨ä¸­æ–‡çš„ ã€Œã€ æè¿°\næè¿°æ­¥éª¤\n1 ã€Œç³»ç»Ÿåå¥½è®¾ç½® - é”®ç›˜ - è¾“å…¥æ³•ã€ æè¿°å¿«æ·é”®\n1 ã€ŒCommand + Control + ç©ºæ ¼é”®ã€ è¿™æ˜¯è¡¨æƒ…ç¬¦å·çª—å£ æè¿°å±æ€§ ä½¿ç”¨è¡¨æ ¼\nå±æ€§è¯´æ˜ å€¼/ç¤ºä¾‹ xxx xxx 1 2 3 | å±æ€§è¯´æ˜ | å€¼/ç¤ºä¾‹ | | :---- | :---- | | xxx | xxx | æ¸…å• ä¸€ä¸ªå¤§å·¥ç¨‹ å­é¡¹å·¥ç¨‹ 1 å­é¡¹å·¥ç¨‹ 2 1 2 3 - [ ] ä¸€ä¸ªå¤§å·¥ç¨‹ - [ ] å­é¡¹å·¥ç¨‹ 1 - [ ] å­é¡¹å·¥ç¨‹ 2 è¡¨è¾¾ ä¸€ä¸ªæ®µè½åªè¡¨è¾¾ä¸€ä¸ªä¸»é¢˜ é¿å…è¿ç»­ä½¿ç”¨æ¾æ•£çš„å¥å­ ä½¿ç”¨ç›¸åŒçš„ç»“æ„è¡¨è¾¾å¹¶åˆ—çš„æ„æ€ å°†å¼ºè°ƒçš„è¯æ”¾åœ¨å¥æœ« è¡¥å……è¯´æ˜ {} å¤§æ‹¬å·å†…çš„å†…å®¹æ˜¯å˜é‡å, éœ€è¦æ›¿æ¢æˆé€‚å½“çš„å€¼ã€‚\nä¸ºæ–¹ä¾¿å†™ä»£ç ç­‰ï¼Œè®¾ç½®è¾“å…¥æ³•ã€Œåå¥½è®¾ç½® - ä¸­æ–‡ä¸‹ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹ã€ï¼Œå¦‚éœ€ä¸­æ–‡ç¬¦å·æœ‰ä¸‹é¢ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚\nå¿«æ·é”® ã€Œcontrol + command + .ã€å¿«é€Ÿå¼€å…³è¯¥åŠŸèƒ½ã€‚ ä½¿ç”¨ç¬¬ä¸‰æ–¹è½¯ä»¶æ§åˆ¶å¿«æ·é”®ï¼Œé’ˆå¯¹ä¸ªåˆ«ç¬¦å·è®¾ç½®å¿«æ·é”®ï¼Œè¯¥æ–¹æ³•æœªæ‰¾åˆ°åˆé€‚çš„è½¯ä»¶( for mac )ã€‚\nä½¿ç”¨è¾“å…¥æ³•çš„ã€Œè‡ªå®šä¹‰çŸ­è¯­è®¾ç½®ã€ã€‚ ","date":"2019-03-12T00:00:00Z","image":"http://img.golang.space/1615740287358-790867.jpg","permalink":"https://blog.golang.space/p/%E5%85%B3%E4%BA%8E-markdown-%E9%A3%8E%E6%A0%BC/","title":"å…³äº markdown é£æ ¼"},{"content":"ä»¥å‰ç”¨çš„æ˜¯ Spring boot åˆ›å»ºçš„åšå®¢ï¼Œç°åœ¨è½¬ Golang è¿™ä¹ˆä¹…äº†ï¼Œæƒ³æ¢ä¸ªä¸ä¹‹ç›¸å…³æŠ€æœ¯çš„ï¼Œäºæ˜¯ä¹æœ‰äº†è¿™ä¸ª hugo åˆ›å»ºçš„åšå®¢\nå¼€å§‹ ä¸‹è½½å®‰è£…åŒ…, å†™æ­¤ç¯‡æ–‡ç« æ—¶ç‰ˆæœ¬ä¸º 0.81\nè§£å‹ç¼©åæ”¾å…¥ /usr/bin æ–‡ä»¶å¤¹\nåˆ›å»ºåšå®¢\n1 2 3 hugo new site blog git init \u0026amp;\u0026amp; git add . git commit -m \u0026#34;create blog\u0026#34; æ·»åŠ ä¸»é¢˜ï¼Œé¦–æ¬¡åˆ›å»ºå¯ä»¥ä½¿ç”¨è¯¥ä¸»é¢˜ä¸‹çš„ä¾‹å­ï¼Œå°† exampleSite æ–‡ä»¶å¤¹ä¸‹çš„ config.yaml ï¼Œ contentï¼Œplugins æ‹·è´åˆ° blog ç›®å½•\n1 2 3 4 5 git submodule add https://github.com/CaiJimmy/hugo-theme-stack ./themes/hugo-theme-stack cd ./themes/hugo-theme-stack/exampleSite rm LICENSE README.md mv * ../../../ å›åˆ° blog ç›®å½•ï¼Œcommit ä»£ç åï¼Œåˆ›å»ºæœåŠ¡å™¨æŸ¥çœ‹åšå®¢\n1 2 3 4 git add . git commit -m \u0026#34;add theme\u0026#34; hugo server éƒ¨ç½²åˆ°å…¬ç½‘ è¿™é‡Œéƒ¨ç½²åˆ° Github\nåˆ›å»ºä»“åº“ï¼Œä»“åº“åå¿…é¡»ä»¥ github.io ç»“å°¾\nåˆ›å»ºå¥½ä»“åº“ï¼Œå›åˆ°é¡¹ç›®ï¼Œæ‰§è¡Œå‘½ä»¤åˆ›å»º html é¡µé¢\n1 hugo é¡¹ç›®æ–‡ä»¶å¤¹ä¸­è‡ªåŠ¨åˆ›å»ºäº† public æ–‡ä»¶å¤¹ï¼Œå­˜æ”¾ç€åšå®¢çš„é™æ€æ–‡ä»¶ï¼Œå°†æ­¤æ–‡ä»¶å¤¹æ¨é€åˆ°åˆšåˆšåˆ›å»ºçš„ä»“åº“\n1 2 3 4 5 6 cd public git init git add . git commit -m \u0026#34;blog\u0026#34; git remote add origin ä»“åº“åœ°å€ git push -u origin master å›åˆ°è¿œç¨‹ä»“åº“ï¼Œé€‰æ‹©èœå•æ ä¸­çš„ settings ï¼Œé¡µé¢ç¿»åˆ°åº•éƒ¨\nå¦‚ä½•è‡ªå®šä¹‰åŸŸå? åœ¨åŸŸåæ§åˆ¶é¢æ¿ï¼Œæ¯”å¦‚æˆ‘åœ¨ xxx ä¹°çš„åŸŸåï¼Œå°±ç™»å½• xxx å®˜æ–¹ï¼Œåå°æ§åˆ¶é¡µé¢ï¼Œé€‰æ‹©åŸŸåè§£æã€‚\nè®°å½•ç±»å‹ä¸º CNAME ï¼Œæˆ‘ä½¿ç”¨äºŒçº§åŸŸå blog.golang.spaceï¼Œè®°å½•å€¼å¡«å†™åšå®¢ä»“åº“å.\nè¿›å…¥åšå®¢ç›®å½•ï¼Œåˆ›å»º CNAME æ–‡ä»¶ï¼Œå†™å…¥è‡ªå®šä¹‰åŸŸåï¼Œå°†ä¿®æ”¹æ¨é€åˆ°è¿œç¨‹\n1 2 3 4 5 6 cd public echo \u0026#34;blog.golang.space\u0026#34; \u0026gt; CNAME git add . git commit -m \u0026#34;add cname\u0026#34; git push åˆ›å»ºè‡ªåŠ¨åŒ–è„šæœ¬ è‹¥æ˜¯æ¯æ¬¡å†™äº†æ–°åšæ–‡ï¼Œéƒ½è¦ hugo æ¨é€ç­‰ç­‰ä¸€å †å‘½ä»¤, æ˜¯å¾ˆéº»çƒ¦çš„ã€‚\nåœ¨ blog ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬ã€‚\n1 vim Makefile 1 2 3 4 5 6 7 8 9 10 11 12 13 build: rm -rf ./docs ./hugo -d docs \u0026gt;\u0026gt; build.log @cp ./googlec03aeb90afb546ce.html ./docs @echo \u0026#34;blog.golang.space\u0026#34; \u0026gt; ./docs/CNAME @echo -e \u0026#34;æ‰“åŒ…å®Œæˆ\u0026#34; push: git add . git commit -m $(m) \u0026gt;\u0026gt; build.log @echo \u0026#34;æ­£åœ¨å‘é€åˆ°æœåŠ¡å™¨...\u0026#34; git push @echo \u0026#34;OK\u0026#34; æ‰§è¡Œ\n1 make build push m=åˆå§‹åŒ–åšå®¢ æ·»åŠ è¯„è®ºåŠŸèƒ½ Github å®‰è£… utterances ï¼Œé…ç½®æ—¶æˆ‘ä»…ä»…é€‰æ‹©åšå®¢å­˜å‚¨ä»“åº“.\næœåŠ¡ç«¯é…ç½®å®Œæˆåï¼Œåœ¨ç½‘ç«™é…ç½®ä¸­å¡«å†™ä»“åº“åœ°å€ï¼Œä¿å­˜æ–‡ä»¶åæ‰§è¡Œè‡ªåŠ¨åŒ–è„šæœ¬æ¨é€ï¼Œå†æ¬¡æ‰“å¼€åšæ–‡æ‹‰åˆ°åº•éƒ¨å·²ç»æœ‰è¯„è®ºé¢æ¿å•¦ã€‚\n1 2 3 4 cd blog vim config.yaml # ä¿®æ”¹å¹¶ä¿å­˜æ–‡ä»¶å ./auto.sh åˆ›å»ºè‡ªå·±çš„åšæ–‡ åˆ é™¤ é¡¹ç›®/content/post ä¸‹çš„æ‰€æœ‰å†…å®¹ï¼Œå°†è‡ªå·±çš„ markdown æ–‡ä»¶å¤åˆ¶è¿›æ¥\næ‰€æœ‰çš„æ–‡ä»¶é¡¶éƒ¨éœ€è¦åŠ ä¸Šä»¥ä¸‹å†…å®¹\n1 2 3 4 5 6 7 8 9 10 11 12 --- title: {æ˜¾ç¤ºåœ¨ç½‘ç«™å†…çš„æ ‡é¢˜åŠç½‘å€å°¾éƒ¨çš„æ–‡ä»¶å} description: {æè¿°} date: {åˆ›å»ºæ—¥æœŸ} slug: {æ–‡ä»¶å¤¹/æ–‡ä»¶ è·¯å¾„, ä¼šæ˜¾ç¤ºåœ¨ç½‘å€ä¸­} image: {å°é¢å›¾} categories: - æ‚è®° {åˆ†ç±»} --- # æ­£æ–‡ SEO å¸®åŠ©ç½‘ç«™å¿«é€Ÿè¿›å…¥ ç™¾åº¦/è°·æ­Œ æœç´¢\nè°·æ­Œ google search\nç™¾åº¦ ç™»å½•ç™¾åº¦æœç´¢èµ„æºå¹³å°ï¼Œåœ¨ç«™ç‚¹ç®¡ç†ä¸­æ·»åŠ åŸŸåï¼ŒéªŒè¯ç½‘ç«™æ‰€æœ‰æƒ, æˆ‘é€‰æ‹© CNAME çš„æ–¹å¼;\nè°·æ­Œåˆ†æ æ‰“å¼€ç½‘ç«™\nå·¦ä¸‹è§’è®¾ç½® åˆ›å»ºåª’ä½“èµ„æº è¾“å…¥èµ„æºåç§°ï¼Œå¹¶æ‰“å¼€æ˜¾ç¤ºé«˜çº§é€‰é¡¹ï¼Œè¾“å…¥ç½‘å€ï¼Œé€‰æ‹©ä»…åˆ›å»º Universal Analytics åª’ä½“èµ„æº å°†è·Ÿè¸ª ID å¡«å…¥ç›¸å…³é…ç½® å¾…å®Œå–„ è°·æ­Œåˆ†æ ç½‘ç«™è®¿é—®ç»Ÿè®¡ï¼Œå•ç¯‡åšæ–‡ç‚¹å‡»ç»Ÿè®¡ å°éƒ¨ä»¶ åˆ†ç±»æ ‡ç­¾åŒåä¸åŒè‰²ï¼Œæ¯æ¬¡éƒ½ä¼šéšæœºé¢œè‰² ç›¸åŒçš„æ ‡ç­¾æœ‰ä¸åŒçš„é¢œè‰² æ¸…å•å‰é¢æœ‰æ— åºæ ‡ç‚¹ ä¸æ”¯æŒ [toc] ï¼Œæ²¡æœ‰ç›®å½• å¦‚ä½•åˆ¶ä½œä¸»é¢˜? ä»…å°†é“¾æ¥ç´¢å¼•æ”¾è¿™ï¼Œå¾…çœ‹\ntemplates è¯­æ³•\næŸä¸ªå‰ç«¯å¼€å‘å‡ºçš„ hugo æ•™ç¨‹\né›¶å£¹è»’ä¸»é¢˜å®šåˆ¶æ–¹æ³•\nå‚è€ƒ å…³äºåˆ›å»º pages GITHUB å®˜æ–¹æ–‡æ¡£ è‡ªå®šä¹‰åŸŸå GITHUB å®˜æ–¹æ–‡æ¡£ ä¸»é¢˜çš„é…ç½®è¯´æ˜ google analyticsè®¾ç½® google analytics Hugo å®˜æ–¹æ–‡æ¡£ ","date":"2019-03-11T00:00:00Z","image":"http://img.golang.space/1615716329188-64aab4ae3e632dbcbf9223995c654317.jpg","permalink":"https://blog.golang.space/p/%E5%9B%BE%E8%AE%B0%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E7%9A%84%E8%BF%87%E7%A8%8B/","title":"å›¾è®°åˆ›å»ºåšå®¢çš„è¿‡ç¨‹"},{"content":"æ–‡ä»¶è¯»å†™ æ–‡ä»¶çš„æ‰“å¼€å’Œå…³é—­ æ‰“å¼€æ–‡ä»¶ï¼Œfopen() å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ\nè¯¥ function æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå½¢å‚1è¡¨ç¤ºè·¯å¾„/æ–‡ä»¶åï¼Œå½¢å‚2è¡¨ç¤ºæ‰“å¼€çš„æ–¹å¼ï¼›\n1 2 3 4 5 \u0026#34;r\u0026#34; // åªè¯»ï¼Œæ–‡ä»¶å¿…é¡»å·²å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™ \u0026#34;w\u0026#34; // åªå†™ï¼Œåˆ›å»ºå¹¶æ‰“å¼€æ–‡ä»¶ï¼Œè‹¥å·²å­˜åœ¨åˆ™è¦†ç›– \u0026#34;a\u0026#34; // åªå†™ï¼ŒæŒ‡é’ˆç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾ï¼Œæ–‡ä»¶å¿…é¡»å·²å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™ \u0026#34;+\u0026#34; // ç»„åˆï¼Œè¯»å†™ \u0026#34;b\u0026#34; // ç»„åˆï¼Œè¡¨ç¤ºæ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ ä»¥è¯»å†™æ–¹å¼ï¼Œæ‰“å¼€ D ç›˜æ ¹ç›®å½•ä¸‹æ–‡ä»¶ demo.txt ï¼Œä¿ç•™å†…å®¹ï¼Œå‘å…¶æ–‡ä»¶å°¾éƒ¨è¿½åŠ æ•°æ®ï¼š\n1 2 FILE *fp; // æ–‡ä»¶æŒ‡é’ˆçš„å®šä¹‰ fp = fopen(\u0026#34;D:\\\\demo.txt\u0026#34;,\u0026#34;a+\u0026#34;); æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶\n1 2 FILE *fp; fp = fopen(\u0026#34;D:\\\\demo.txt\u0026#34;,\u0026#34;ab+\u0026#34;); åœ¨æ–‡ä»¶ä½¿ç”¨ç»“æŸåå¿…é¡»å…³é—­æ–‡ä»¶ï¼Œå¦åˆ™ä¼šå‡ºç°æ„æƒ³ä¸åˆ°çš„é”™è¯¯ï¼Œåœ¨ c program ä¸­ï¼Œå‡½æ•° fclose() ç”¨æ¥å…³é—­ä¸€ä¸ªç”±å‡½æ•° fopen() æ‰“å¼€çš„æ–‡ä»¶ï¼›è¯¥å‡½æ•°å…³é—­æˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›é0å€¼ï¼›\næŒ‰å­—ç¬¦è¯»å†™æ–‡ä»¶ å‡½æ•° fgetc() ç”¨äºä»ä¸€ä¸ªä»¥åªè¯»æˆ–è¯»å†™æ–¹å¼æ‰“å¼€çš„æ–‡ä»¶ä¸Šè¯»å­—ç¬¦ï¼›å¹¶å°†ä½ç½®æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œè‹¥æˆåŠŸåˆ™è¿”å›è¯¥å­—ç¬¦ï¼Œè‹¥è¯»åˆ°æ–‡ä»¶å°¾åˆ™è¿”å›EOFï¼›ï¼ˆEOFä¸ºç¬¦å·å¸¸é‡ï¼Œåœ¨ stdio ä¸­å®šä¹‰ä¸º -1ï¼‰\nå‡½æ•° fputc() ç”¨äºå°†ä¸€ä¸ªå­—ç¬¦å†™åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸Šï¼Œè‹¥å†™å…¥é”™è¯¯è¿”å›EOFï¼Œå¦åˆ™è¿”å›å­—ç¬¦C\n1 int fputc(int c, FILE *fp); // å‡½æ•°åŸå‹ Q1 ä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œç„¶åæŠŠå®ƒä»¬è½¬å­˜åˆ°ç£ç›˜æ–‡ä»¶ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stalin.h\u0026gt; int main() { FILE *fp; char ch; if ((fp = fopen(\u0026#34;demo.txt\u0026#34;,\u0026#34;w\u0026#34;)) == NULL) // åˆ¤æ–­æ˜¯å¦ä¸ºç©ºæŒ‡é’ˆï¼Œå³æ–‡ä»¶æ‰“å¼€å¤±è´¥åçš„æ“ä½œ { printf(\u0026#34;Failure to open demo.txt!\\n\u0026#34;); // æç¤ºå¤±è´¥ exit(0); // ç»“æŸç¨‹åº,è¿™é‡Œçš„é€€å‡ºå‡½æ•°å±äº stdlib.h } ch = getchar(); // è¾“å…¥ä¸€ä¸ªå­—ç¬¦ while (ch != \u0026#39;\\n\u0026#39;) // åªè¦ä¸æ˜¯æ¢è¡Œï¼Œå›è½¦ { fputc(ch,fp); // å°†è¯¥å­—ç¬¦æ”¾å…¥æ–‡ä»¶ä¸­ï¼› ch = getchar(); // å†è·å–ä¸€ä¸ªå­—ç¬¦ } fclose(fp); // å…³é—­æ–‡ä»¶ return 0; } è‹¥æ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼Œfopen() ä¼šè¿”å›ç©ºæŒ‡é’ˆ NULLï¼Œå› æ­¤å¯ä»¥é€šè¿‡æ£€æŸ¥è¿”å›å€¼æ¥åˆ¤æ–­æ–‡ä»¶æ‰“å¼€æ˜¯å¦æˆåŠŸã€‚\nQ2 å°† 0ï½127 ä¹‹é—´çš„ ASCLL å­—ç¬¦å†™åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶åä»æ–‡ä»¶ä¸­è¯»å‡ºå¹¶æ˜¾ç¤ºåˆ°å±å¹•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main() { FIEL *fp; char ch; fp = fopen(\u0026#34;demo.bin\u0026#34;,\u0026#34;wb\u0026#34;); // ä»¥äºŒè¿›åˆ¶æ–¹å¼åˆ›å»ºæ–‡ä»¶ if(fp == NULL) { printf(\u0026#34;Failure to open demo.bin!\\n\u0026#34;); exit(0); } for(int i = 0; i \u0026lt; 128; i++) { fputc(i,fp); // å°† ASCLL ç å€¼åœ¨ 0ï½127 ä¹‹é—´çš„æ‰€æœ‰å­—ç¬¦å†™å…¥æ–‡ä»¶ } fclose(fp); // è¯» if ((fp = fopen(\u0026#34;demo.bin\u0026#34;,\u0026#34;rb\u0026#34;)) == NULL) { printf(\u0026#34;Error!\\n\u0026#34;); exit(0); } while((ch = fgetc())!=EOF) // ä¸€ç›´è¯»åˆ°æ–‡ä»¶å°¾ { putchar(ch); } fclose(fp); return 0; } ä¸Šé¢æ ‡è®°çš„é‚£ä¸€è¡Œï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦è¯»åˆ°äº†æ–‡ä»¶å°¾ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥ä½¿ç”¨å‡½æ•° feof() æ¥åˆ¤æ–­æ˜¯å¦è¯»åˆ°æ–‡ä»¶æœ«å°¾ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 ch = fgetc(fp); while(!feof(fp)) // è¿™é‡Œfeof ç”¨äºæ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ–‡ä»¶å°¾ { putchar(ch); ch = fgetc(fp); } å½“æ–‡ä»¶ä½ç½®æŒ‡é’ˆæŒ‡å‘æ–‡ä»¶ç»“æŸç¬¦ï¼ˆEnd-of-file Indicatorï¼‰æ—¶ï¼Œè‹¥ç»“æŸè¿”å›é0å€¼ï¼Œæœªç»“æŸè¿”å›0å€¼ï¼›\nQ3 å°†ä¸Šé¢çš„ç¨‹åºä¿®æ”¹ä¸€ä¸‹ï¼Œè¯»å‡ºçš„æ—¶å€™åˆ¤æ–­æ˜¯å¦ä¸ºå¯æ‰“å°å­—ç¬¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main() { FILE *fp; char ch; int i; fp = fopen(\u0026#34;demo.bin\u0026#34;,\u0026#34;wb\u0026#34;); // åˆ›å»ºæ–‡ä»¶ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼å†™å…¥ if(fp == NULL) // åˆ¤æ–­æ˜¯å¦æ‰“å¼€ { printf(\u0026#34;Error!\\n\u0026#34;); exit(0); } for(i=0; i\u0026lt;123; i++) { fputc(i,fp); // å°† i è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼› } fclose(fp); // å…³é—­æ–‡ä»¶ fp = fopen(\u0026#34;demo.bin\u0026#34;,\u0026#34;rb\u0026#34;); // è¯»å–æ–‡ä»¶ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼è¯» if(fp == NULL) // åˆ¤æ–­æ˜¯å¦æ‰“å¼€ { printf(\u0026#34;Error!\\n\u0026#34;); exit(0); } while(!feof(fp)) // åˆ¤æ–­æ–‡ä»¶å°¾ { ch = fgetc(fp) if (!iscntrl(ch)) // åˆ¤æ–­æ˜¯å¦å¯æ‰“å° { printf(\u0026#34;%c\\t\u0026#34;,ch); } else { printf(\u0026#34;%d\\t\u0026#34;,ch); } } fclose(fp); return 0; } ä¸¤ä¸ªå‡½æ•°çš„ç”¨æ³•:\n1 2 isprint(å˜é‡); // å¦‚æœå˜é‡å¯ä»¥æ‰“å°æ˜¾ç¤ºï¼Œå°±è¿”å›é0å€¼ iscntrl(å˜é‡); // åˆ¤æ–­æ˜¯å¦ä¸ºæ§åˆ¶å­—ç¬¦ï¼Œå¦‚æœæ˜¯è¿”å›0 è¯»å–æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸² ä»æ–‡ä»¶è¯»å–å­—ç¬¦ä¸²å¯ä½¿ç”¨å‡½æ•° fgets() ;\n1 char *fgets(char *s, int n, FILE *fp); // å‡½æ•°åŸå‹ è¯¥å‡½æ•°ä»¥ fp æ‰€æŒ‡æ–‡ä»¶è¯»å–å­—ç¬¦ä¸²å¹¶åœ¨æœ«å°¾æ·»åŠ \\0ï¼Œç„¶åå­˜å…¥ sï¼Œæœ€å¤šè¯»å– n-1 ä¸ªå­—ç¬¦ï¼›\nå½“è¯»åˆ°æ¢è¡Œç¬¦æˆ–è¯»æ»¡æ—¶ï¼Œè¿”å›å­—ç¬¦ä¸²é¦–åœ°å€ï¼Œå³æŒ‡é’ˆsï¼Œè¯»å–å¤±è´¥è¿”å›ç©ºæŒ‡é’ˆ NULLï¼›\nferror() å‡½æ•°ç”¨æ¥æ£€æµ‹æ˜¯å¦å‡ºç°æ–‡ä»¶é”™è¯¯ï¼Œè‹¥æœ‰é”™è¯¯è¿”å›ä¸€ä¸ªé0å€¼ï¼Œå¦åˆ™è¿”å›0å€¼ï¼›\nå°†å­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶çš„å‡½æ•° fputs() ,è‹¥å‡ºç°å†™å…¥é”™è¯¯ï¼Œè¿”å›EOFï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªéè´Ÿæ•°ï¼›\n1 int fputs(const char *s, FILE *fp); Q4 ä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œç„¶åæŠŠå®ƒä»¬æ·»åŠ åˆ°æ–‡æœ¬æ–‡ä»¶ demo.txt æœ«å°¾ã€‚å‡è®¾æ–‡ä»¶ demo.txt å·²æœ‰å†…å®¹ I am a student.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #define N 80 int main() { FILE *fp; char str[N]; if ((fp = fopen(\u0026#34;demo.txt\u0026#34;,\u0026#34;a\u0026#34;))==NULL) { printf(\u0026#34;Error!n\u0026#34;); exit(0); } gets(str); fputs(str,fp); fclose; if((fp = fopen(\u0026#34;demo.txt\u0026#34;,\u0026#34;r\u0026#34;))==NULL) { printf(\u0026#34;Error!\\n\u0026#34;); exit(0); } fgets(str,N,fp); puts(str); fclose(fp); return 0; } ä¸ gets ä¸åŒï¼Œfgets() ä»æŒ‡å®šçš„æµè¯»å­—ç¬¦ä¸²ï¼Œè¯»åˆ°æ¢è¡Œç¬¦æ—¶å°†æ¢è¡Œç¬¦ä¹Ÿä½œä¸ºå­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†è¯»åˆ°å­—ç¬¦ä¸²ä¸­æ¥ï¼›åŒç†ï¼Œä¸ puts butsçš„å¸‚åœºï¼Œfputs() ä¸ä¼šåœ¨å†™å…¥æ–‡ä»¶çš„å­—ç¬¦ä¸²æœ«å°¾åŠ ä¸Šæ¢è¡Œç¬¦ã€‚\nc program å…è®¸æŒ‰æŒ‡å®šæ ¼å¼è¯»å†™æ–‡ä»¶ã€‚å‡½æ•° fscanf() ç”¨äºæŒ‰æŒ‡å®šæ ¼å¼ä»æ–‡ä»¶è¯»æ•°æ®ã€‚è¯¥å‡½æ•°æœ‰3ä¸ªå‚æ•°ï¼Œå‚æ•°1ä¸ºæ–‡ä»¶æŒ‡é’ˆï¼Œå‚æ•°2ä¸ºæ ¼å¼æ§åˆ¶å‚æ•°ï¼Œå‚æ•°3ä¸ºåœ°å€å‚æ•°åˆ—è¡¨ï¼›åä¸¤ä¸ªå‚æ•°ä¸å‡½æ•° scanf ç›¸åŒï¼›\nå‡½æ•° fprintf() ç”¨äºæŒ‰æŒ‡å®šæ ¼å¼å‘æ–‡ä»¶å†™å…¥æ•°æ®ã€‚\nQ5 ç¼–ç¨‹è®¡ç®—æ¯ä¸ªå­¦ç”Ÿçš„4é—¨è¯¾ç¨‹çš„å¹³å‡åˆ†ï¼Œå°†å­¦ç”Ÿçš„å„ç§‘æˆç»©åŠå¹³å‡åˆ†è¾“å‡ºåˆ°æ–‡ä»¶ score.txt ä¸­ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #define N 30 typedef struct date { int year; int month; int day; } DATE; typedef struct student { long studentID; char studentName[10]; char studentSex; DATE birthday; int score[4]; float aver; } STUDENT; void InputScore(STUDENT stu[], int n, int m); void AverScore(STUDENT stu[], int n, int m); void WritetoFile(STUDENT stu[], int n, int m); int main() { STUDENT stu[N]; int n; printf(\u0026#34;How many student?\u0026#34;); scanf(\u0026#34;%d\u0026#34;,\u0026amp;n); InputScore(stu,n,4); WritetoFile(stu,n,4); return 0; } ","date":"2018-08-30T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%8D%81%E4%BA%94%E8%AF%BE-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99/","title":"ç¬¬åäº”è¯¾ æ–‡ä»¶è¯»å†™"},{"content":"é€’å½’å’Œè¿­ä»£ Q1 é€’å½’è®¡ç®— æ–æ³¢é‚£å¥‘æ•°åˆ—\n1 2 3 4 5 6 7 8 int fun(int n) { n -= 1; switch(n) case 0: case 1: return 1; return fun(n-1)+fun(n-2); } åœ¨switchä¸­ï¼Œå¦‚æœdefaultè¯­å¥åœ¨æœ€å‰é¢ä¸”æ²¡æœ‰è·³å‡ºè¯­å¥ï¼Œè€Œcaseæ²¡æœ‰åŒ¹é…åˆ°ï¼Œåˆ™æ¥ç€æ‰§è¡Œåé¢çš„caseè¯­å¥ï¼› æœ‰äº›ç¼–è¯‘å™¨ï¼Œswitchè¯­å¥å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œå°±ä»å¤´æ‰§è¡Œcaseï¼Œå¤§éƒ¨åˆ†éƒ½ä¼šè·³è¿‡switchæ•´ä¸ªè¯­å¥å—ï¼› 1 2 3 4 5 6 7 8 switch(x) { default: case 0: case 1: x=1; } // å½“ x=2 æ—¶ï¼Œè¾“å‡ºçš„ç»“æœä¸º x=1ï¼› å›åˆ°é€’å½’\nå½“ä¸¤ä¸ªå‡½æ•°äº’ç›¸è°ƒç”¨å¯¹æ–¹ï¼Œç§°ä¸ºé—´æ¥è°ƒç”¨ï¼›\né€’æ¨ï¼šç”±å·²çŸ¥æ±‚æœªçŸ¥ï¼Œæ¯”å¦‚é˜¶ä¹˜ç”±1åˆ°100ï¼›\né€’å½’ï¼šç”±æœªçŸ¥åˆ°å·²çŸ¥ï¼Œç”±100åˆ°1ï¼›\nQ2 æ±‰è¯ºå¡”\nåªèƒ½ç”¨é€’å½’æ¥è§£å†³ï¼›\n","date":"2018-08-25T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%8D%81%E5%9B%9B%E8%AF%BE-%E9%80%92%E5%BD%92%E5%92%8C%E8%BF%AD%E4%BB%A3/","title":"ç¬¬åå››è¯¾ é€’å½’å’Œè¿­ä»£"},{"content":"ç»“æ„ä½“ å®šä¹‰ æ•°æ®ç±»å‹ï¼šåŸºæœ¬ç±»å‹ / è‡ªå®šä¹‰ç±»å‹\nåŸºæœ¬ç±»å‹å°±æ˜¯ç³»ç»Ÿæä¾›ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼šfloat double char int\nè‡ªå®šä¹‰ç±»å‹å°±æ˜¯ç³»ç»Ÿæ²¡æœ‰ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±éœ€è¦æ¥åˆ›å»ºçš„æ•°æ®ç±»å‹ï¼Œè¿™ç§ç±»å‹çš„ç‰¹ç‚¹ï¼šä¸€ä¸ªå˜é‡ä¸å•èƒ½å¤ŸåŒ…å«è‹¥å¹²æ•°æ®ï¼ŒåŒæ—¶è¿˜èƒ½æ˜¯ä¸åŒçš„ç±»å‹ï¼›\nint x;\nint a[]ï¼› è¿™ä¸¤ç§æ•°æ®éƒ½æ˜¯å•ä¸€ç±»å‹ï¼Œä»…ä»…å­˜å‚¨ int å˜é‡ï¼›\nç»“æ„ä½“æ•°æ®ç±»å‹ï¼Œå³å¤šåˆä¸åŒï¼›\nåœ¨ c program ä¸­ï¼Œè‡ªå®šä¹‰ç±»å‹ä¸»è¦æä¾›ä¸¤ç§ï¼šç»“æ„ä½“æ•°æ®ï¼Œå…±ç”¨ä½“ç±»å‹ï¼ˆå…±åŒä½“ï¼‰\nç»“æ„ä½“æ•°æ®ç±»å‹çš„åˆ›å»º:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 struct ç»“æ„ä½“ç±»å‹å // å®šä¹‰ç»“æ„ä½“ç±»å‹ï¼Œä¸€èˆ¬å®šä¹‰åœ¨å…¨å±€ { int a; //æˆå‘˜ç±»å‹ æˆå‘˜åï¼› float b; // æˆå‘˜ç±»å‹ æˆå‘˜åï¼› char c; char d[100]; }; struct ç»“æ„ä½“ç±»å‹å ç»“æ„ä½“å˜é‡åï¼› // å®šä¹‰ç»“æ„ä½“å˜é‡ struct intfloat a = {23,1.02,\u0026#39;a\u0026#39;,\u0026#34;aaaa\u0026#34;}; // ç»“æ„ä½“å˜é‡åˆå§‹åŒ– printf(\u0026#34;%d\u0026#34;,a.a); // ç»“æœä¸º23ï¼Œ ç»“æ„ä½“å.æˆå‘˜å å¼•ç”¨æ–¹æ³• printf(\u0026#34;%s\u0026#34;,a.d); // ç»“æœä¸º aaaa a.c = \u0026#39;k\u0026#39;; // å•ä¸ªæˆå‘˜èµ‹å€¼ a.d = \u0026#34;bbbb\u0026#34;ï¼› // å­—ç¬¦ä¸²åœ¨åˆå§‹åŒ–è¿‡åä¸å¯ä»¥ç›´æ¥å¤åˆ¶ï¼› strcpy(x.d,\u0026#34;abcdefg\u0026#34;); // è¿™æ ·èƒ½å¤Ÿå˜ç›¸èµ‹å€¼ åœ¨ç»“æ„ä½“ä¸­æƒ³åŒ…å«å“ªäº›æ•°æ®ï¼Œå°±å®šä¹‰å¯¹åº”å˜é‡ï¼›\nç»“æ„ä½“æŒ‡é’ˆ å¦‚æœç”¨ç»“æ„ä½“æŒ‡é’ˆæ¥å¼•ç”¨æˆå‘˜ï¼Œæ ¼å¼ä¸ºï¼š\n1 2 3 4 5 struct intfloat *p; struct intfloat a; p = \u0026amp;a; printf(\u0026#34;%s\u0026#34;,p-\u0026gt;d); // ç»“æ„ä¸º aaaaï¼Œæ— é¡»å¸¦æ˜Ÿå· Q1 ä»é”®ç›˜è¾“å…¥ 10 ä¸ªåŒå­¦çš„è€ƒè¯•ä¿¡æ¯ï¼Œè€ƒè¯•ä¿¡æ¯åŒ…å«\nå­¦å·ï¼šlong\næ€§åˆ«ï¼šchar m/w\næˆç»©ï¼šint\nè¾“å‡ºæœ€é«˜åˆ†åŒå­¦çš„æ‰€æœ‰ä¿¡æ¯ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 struct student{ long number; char x; int score; }; main(){ struct student data[10],*p; int k,i,max; p = \u0026amp;data; for(i=0; i\u0026lt;10; i++){ scanf(\u0026#34;%ld %c %d\u0026#34;,\u0026amp;p[i].number,\u0026amp;p[i].x,\u0026amp;p[i].score); } max=data[0].score; for(i=1; i\u0026lt;10; i++){ if(p[i]-\u0026gt;score \u0026gt; max) max = p[i]-\u0026gt;score; k = i; } printf(\u0026#34;%ld %c %d\\n\u0026#34;,p[k]-\u0026gt;number,p[k]-\u0026gt;x,p[k]-\u0026gt;score); } ç»“æ„ä½“çš„ç±»å‹é•¿åº¦ 1 2 3 sizeof(struct std); // ç»“æ„ä½“ç±»å‹é•¿åº¦ç­‰äºå„ä¸ªæˆå‘˜ç±»å‹é•¿åº¦ä¹‹å’Œ // å¦‚ä¸Šé¢˜ï¼Œ4+1+4 = 9ï¼Œå³ 9 å­—èŠ‚ï¼› å®é™…è¾“å‡º12ä¸ªå­—èŠ‚ï¼Œæ±‚å‡ºæœ€å¤§å­—èŠ‚æ•°ä¹˜ä»¥æˆå‘˜æ•°ï¼Œå³ 4*3 =12 å…±åŒä½“ å…±ç”¨ä½“å…³é”®å­—ï¼šunion\nå…±ç”¨ä½“æ‰€æœ‰çš„æˆå‘˜å…±ç”¨ä¸€ä¸ªç©ºé—´ï¼Œè¿™ä¸ªç©ºé—´å°±æ˜¯æˆå‘˜å½“ä¸­æœ€å¤§çš„é‚£ä¸ªï¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 union std { long xh; double x; int j; }; main(){ union std data; data.xh = 12; data.j = 1.333; printf(\u0026#34;%ld\u0026#34;,data.xh); } // ç»“æœä¸º 1.333 // å› ä¸ºåœ¨å…±ç”¨ä½“é‡Œï¼Œæ‰€æœ‰æˆå‘˜éƒ½æ˜¯ç”¨åŒä¸€ä¸ªç©ºé—´ï¼Œæ‰€æœ‰å…ƒç´ çš„ç»“æœ ç­‰äºæœ€åä¸€æ¬¡èµ‹å€¼çš„ç»“æœï¼› å­˜å‚¨ç±»å‹ åœ¨ c program ä¸­å­˜å‚¨ç±»å‹æœ‰ä¸‰ç§ï¼š\nauto åŠ¨æ€å­˜å‚¨ç±»å‹ static é™æ€å­˜å‚¨ç±»å‹ register å¯„å­˜å™¨ç±»å‹ auto å­˜å‚¨ç±»å‹æ˜¯æœ€å¸¸ç”¨çš„ï¼Œæœ€æœ‰æ•ˆï¼›éšç”¨éšç»™ï¼Œä¸ç”¨å›æ”¶ï¼›\nstatic é™æ€ç±»å‹ï¼Œä¸€æ—¦å°†å­˜å‚¨ç©ºé—´åˆ†é…ç»™æŸä¸ªå˜é‡ï¼Œåœ¨ç¨‹åºæ²¡æœ‰ç»“æŸå‰ï¼Œè¿™ä¸ªç©ºé—´æ˜¯ä¸èƒ½æ”¶å›çš„ï¼Œæ°¸è¿œä¿å­˜å­˜å‚¨çš„æ•°æ®ï¼Œåœ¨å‡½æ•°å†…ä¸ä¼šæ¶ˆäº¡ã€‚\nregister å¯„å­˜å™¨ç±»å‹ï¼šå¯„å­˜å™¨æ˜¯ cpu ä¸­çš„ä¸€å—ï¼Œå¦‚æœå˜é‡æ˜¯ register ç±»å‹ï¼Œé‚£ä¹ˆè¯¥å˜é‡çš„æ•°æ®æ˜¯ç›´æ¥é€ç»™ cpu å¤„ç†ï¼Œè€Œä¸éœ€è¦å†…å­˜ä¸­è½¬ï¼›\n**Q2 **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 int x; int fun(int x){ int a=1,b=1; static c = 1; a++; b++; c++ return a+b+c+x; } main(){ int i; for(i=1; i\u0026lt;=3; i++) printf(\u0026#34;%d\u0026#34;,fun(i)); } // ç¬¬ä¸€è½®å¾ªç¯ // i=1,a=b=c=2 ,re = 6+1 = 7 // ç¬¬äºŒè½®å¾ªç¯ // i=2,a=b=2,c=3 re = 7+2 = 9 // ç¬¬ä¸‰è½® // i=3,a=b=2,c=4,re=8+3 = 11 ","date":"2018-08-23T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%8D%81%E4%B8%89%E8%AF%BE-%E7%BB%93%E6%9E%84%E4%BD%93/","title":"ç¬¬åä¸‰è¯¾ ç»“æ„ä½“"},{"content":"å‡½æ•° å®šä¹‰ c è¯­è¨€å‡½æ•°è®¾è®¡ï¼šæ—©å‰æ¨¡å—åŒ–è®¾è®¡ç†å¿µçš„å…·ä½“åº”ç”¨ï¼›\nå°†ä¸€ä¸ªå¤æ‚é—®é¢˜è§£å†³ç¨‹åºçš„ä»£ç ï¼Œæ ¹æ®åŠŸèƒ½ä¸åŒæˆ‘ä»¬ç»™å®ƒåˆ’åˆ†æˆè‹¥å¹²å¤šä¸ªç®€å•æ¨¡å—ï¼Œç„¶åå¯¹æ¯ä¸ªæ¨¡å—è¿›è¡Œç¨‹åºè®¾è®¡ï¼›å®ç°å¯¹å¤æ‚é—®é¢˜è§£å†³ï¼›\næ¨¡å—åœ¨æ¯ä¸ªè¯­è¨€ä¸Šç§°å‘¼ï¼šåœ¨ c program å«åš å‡½æ•°ï¼›æœ‰çš„è¯­è¨€å«åšè¿‡ç¨‹ï¼Œåœ¨é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼šæ–¹æ³•();\næ ¼å¼:\n1 2 3 4 5 6 å‡½æ•°ç±»å‹ å‡½æ•°å(å‚æ•°ç³»åˆ—) // å‡½æ•°çš„æ•°æ®ç±»å‹å’Œå‡½æ•°è¿”å›å¤„ç†ç»“æœçš„æ•°æ®ç±»å‹ä¸€è‡´çš„ï¼› { sentence; ... return å‡½æ•°å¤„ç†çš„ç»“æœï¼› } å¦‚æœå‡½æ•°æ²¡æœ‰ return è¯­å¥ï¼Œé‚£ä¹ˆå‡½æ•°ç±»å‹å°±æ˜¯ void ç±»å‹ï¼›\nå‡½æ•°åï¼šè°ƒç”¨çš„ä¾æ®ï¼›å‡½æ•°åçš„å‘½åå’Œæ™®é€šå˜é‡çš„è§„åˆ™ç›¸åŒï¼›\nå‚æ•°ç³»åˆ—ï¼šå‚æ•°æä¾›ç»™å‡½æ•°åŠ å·¥å¤„ç†çš„æ•°æ®ï¼›ç³»åˆ—æ˜¯å¯ä»¥æä¾›å¤šä¸ªå‚æ•°\nint x,y å¦‚æœä½œä¸ºå‚æ•°å˜é‡ï¼Œéœ€è¦åˆ†å¼€è¡¨è¾¾ï¼šint x, int y;\nåœ¨å‡½æ•°ä¸­ï¼Œä¸€æ—¦æ‰§è¡Œ returnï¼Œè¯­å¥æ‰€æœ‰æ‰§è¡Œéƒ½å…¨éƒ¨åœæ­¢ï¼›\nQ1 å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ±‚ä¸‰ä¸ªæ•°çš„æœ€å¤§å€¼ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 int FindMax(int x,int y,int z){ // å‡½æ•°çš„é»˜è®¤ç±»å‹æ˜¯ int int max; max = x\u0026lt;y?y:x; max = max\u0026lt;z?z:max; return max; } main(){ int x; x = fun(12,36,4); printf(\u0026#34;%d\u0026#34;,x); } è°ƒç”¨å°±æ˜¯é€šè¿‡ä¸€ä¸ªå‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è€ƒè¯•èŒƒå›´å†…ï¼Œéƒ½æ˜¯é€šè¿‡ main() å‡½æ•°è°ƒç”¨ï¼›\nQ2 å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ±‚é˜¶ä¹˜ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 int fun(int n){ int s = 1; for(int i=1; i\u0026lt;=n; i++) s = s*i; return s; } main() { int m,n,s; printf(\u0026#34;input m,n:\u0026#34;); scanf(\u0026#34;%d,%d\u0026#34;,\u0026amp;m,\u0026amp;n); s = fum(m) / (fun(n) * fun(m-n)); printf(\u0026#34;%d\u0026#34;,s); } å°†æŒ‡é’ˆä½œä¸ºå‡½æ•°å‚æ•° æŒ‡é’ˆå‚æ•°ä¼ é€’çš„åªèƒ½æ˜¯åœ°å€\n1 2 3 4 5 6 7 8 9 10 11 void fun(int pa, int pb){ int t; t = pa; pa = pb; pb = t; // å‡½æ•°å†…æ˜¯å±€éƒ¨å˜é‡ï¼Œå³æ”¹å˜åçš„å€¼ä¸ä¼šä¼ è¾“ç»™mainå‡½æ•°ï¼› } main(){ int a,b,c; a = 3, b= 1; c = fun(a,b); // ä¼ å€¼è¿›å…¥å‡½æ•°ï¼Œå¯¹åŸæ¥çš„å‡½æ•°æ²¡æœ‰ä»»ä½•å½±å“ printf(\u0026#34;%d\\n\u0026#34;,c); } 1 2 3 4 5 6 7 8 9 10 11 void fun(int *pa, int *pb){ int t; t = *pa; *pa = *pb; *pb = t; } main(){ int a,b,c; a = 3, b= 1; fun(\u0026amp;a,\u0026amp;b); // ä¼ åœ°å€ï¼Œå³ç›´æ¥ä¿®æ”¹è¯¥å˜é‡ printf(\u0026#34;%d\\n\u0026#34;,c); } Q3 æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œå®šä¹‰å‡½æ•°æ±‚ä¸¤ä¸ªæ•°çš„æœ€å°å…¬å€æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 int fun(int *pa, int *pb){ int t,r; t = *p1 * (*p2); // æ±‚æœ€å¤§å…¬çº¦ while(*pa%*pb!=0){ t = *pa % *pb; *pa = *pb; *pb = t; } // æ±‚æœ€å°å…¬å€æ•° return t/(*p2); } main(){ int m,n; printf(\u0026#34;input m,n:\u0026#34;); scanf(\u0026#34;%d %d\u0026#34;,\u0026amp;a,\u0026amp;b); printf(\u0026#34;%d\\n\u0026#34;,fun(\u0026amp;a,\u0026amp;b)); } ä»¥æ•°ç»„åä½œä¸ºå‚æ•° 1 2 3 4 int fun(int a[],int n); // aæ˜¯æ•°ç»„åï¼Œnæ˜¯å…ƒç´ ä¸ªæ•° int fun(int *p, int n); // ä¸å‰è€…ç­‰åŒï¼Œpæ˜¯æŒ‡å‘æ•°ç»„çš„é¦–åœ°å€ï¼Œnä¸ºå…ƒç´ ä¸ªæ•° // æ— è®ºå¦‚ä½•ï¼Œå‚æ•°ä¸ºæ•°ç»„çš„ä¼ é€’çš„å®å‚ï¼Œè‚¯å®šæ˜¯åœ°å€ï¼›é€šå¸¸ä¼ é€’çš„æ˜¯æ•°ç»„çš„é¦–åœ°å€ï¼› Q4 å®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œæ±‚æ•°ç»„å…ƒç´ çš„æ¬¡æœ€å¤§å€¼ï¼›\nè§£é¢˜æ€è·¯ï¼šæ¬¡æœ€å¤§å€¼ï¼Œå®ƒæ˜¯ç”±æœ€å¤§å€¼ååº”å‡ºæ¥çš„ï¼Œåœ¨æ±‚è§£è¿‡ç¨‹ä¸­ï¼Œè¦æ±‚å‡ºæœ€å¤§å€¼ï¼Œæ¯”è‡ªå·±å€¼å¤§ï¼Œä¸”æ¯”æœ€å¤§å€¼å°è‚¯å®šå°±æ˜¯æ¬¡æœ€å¤§å€¼ï¼›å¦‚æœæœ‰æ¯”æœ€å¤§å€¼å¤§çš„ï¼Œæ­¤æ—¶æœ€å¤§å€¼å°±æ˜¯æ¬¡æœ€å¤§å€¼ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 int fun(int a[],int n){ int i,j,max,xmax; if(a[0]\u0026gt;a[1]){ max1 = a[0]; max2 = a[1]; } else{max1 = a[1]; max} for(i=0; i\u0026lt;n; i++){ if(xmax\u0026lt;a[i]){ max = xmax; xmax = a[i]; } else if(max\u0026lt;a[i]) max = a[i]; } return max; // åªèƒ½è¿”å›ä¸€ä¸ª å¯¹è±¡ï¼Œåªèƒ½æ‰§è¡Œä¸€ä¸ª returnï¼› // è‹¥è¦è¿”å›å¤šä¸ªæ•°ï¼Œå¿…é¡»è¿”å›æ•°ç»„ï¼Œé—®ï¼šæ•°ç»„æ˜¯åœ°å€ï¼Œä¿®æ”¹è¿‡åè¿˜éœ€è¦è¿”å›å—ï¼Ÿ //ç­”ï¼šæ²¡æœ‰å¿…è¦ï¼Œé™¤éè¯¥æ•°ç»„æ˜¯åœ¨å‡½æ•°å†…å®šä¹‰çš„å±€éƒ¨å˜é‡ï¼Œè¿”å›åç©ºé—´é‡Šæ”¾ï¼Œæ•°ç»„ä¸¢å¤±â€¦â€¦ } main(){ int a[] = {12,98,6,35,78,21}; int n = 6; int i; for(i=0; i\u0026lt;10; i++){ scanf(\u0026#34;%d\u0026#34;,\u0026amp;a[i]); } k = fun(a,n); printf(\u0026#34;%d\u0026#34;,k); } **Q5 è®¾è®¡ä¸€ä¸ªå‡½æ•°ï¼Œåˆ é™¤éå‰å¯¼çš„ ***\nå­—ç¬¦ä¸²ä½œä¸ºå‡½æ•°çš„å‚æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 void fun(char st[]){ // å­—ç¬¦ä¸²æœ‰ \\0 ä½œä¸ºç»“æŸï¼Œæ•…æ­¤æ— é¡»ä¼ å…¥å…ƒç´ ä¸ªæ•° int i=0,j; while(st[i]==\u0026#39;*\u0026#39;) i++; while(st[i]!=\u0026#39;\\0\u0026#39;) { if(\u0026#39;*\u0026#39; == st[i]) for(j=i+1; j\u0026lt;strlen(st); j++) st[j-1] = st[j]; if(st[i] != \u0026#39;*\u0026#39;) i++; } } int main(){ char st[] = \u0026#34;****sa**def***zffd\u0026#34;; fun(st); printf(\u0026#34;%s\\n\u0026#34;,st); return 0; } Q6 ä»¥æŒ‡é’ˆä½œä¸ºå‡½æ•°å­ä¸²çš„å‚æ•°ï¼›è®¾è®¡å‡½æ•°ï¼Œå°†ä¸€å¥è¯çš„æ¯ä¸ªå•è¯å‰é¢ç¬¬ä¸€ä¸ªå­—æ¯å˜æˆå¤§å†™ï¼›\nhow are you -\u0026gt; How Are You\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 void fun(char *p); { int i,j; *p -= 32; for(i=1; *(p+i) != \u0026#39;\\0\u0026#39;; i++){ while(*(st+i) == \u0026#39; \u0026#39;) i++; if(*(st+i-1) == \u0026#39; \u0026#39;){ *(st+i) -= 32; } } } main(){ char st[] = \u0026#34;how are you\u0026#34;; fun(st); printf(\u0026#34;%s\\n\u0026#34;,st); } è¡¥å……ï¼š\nå½“å‡½æ•°éç©ºå‹ï¼Œå¿…é¡»æœ‰returnè¿”å›å€¼ï¼Œå‡½æ•°æ²¡æœ‰return è¯­å¥æ—¶ï¼Œé»˜è®¤å‡½æ•°ç±»å‹ä¸º void è‹¥æ˜¯æ²¡æœ‰å®šä¹‰å‡½æ•°çš„ç±»å‹ï¼Œé»˜è®¤ä¸ºintæ•´å‹ å½¢å‚ä¸å®å‚å æ®ä¸åŒçš„å•å…ƒ ","date":"2018-08-23T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%8D%81%E4%BA%8C%E8%AF%BE-%E5%87%BD%E6%95%B0/","title":"ç¬¬åäºŒè¯¾ å‡½æ•°"},{"content":"æŒ‡é’ˆ å®šä¹‰ é€šå¸¸åœ¨ç¨‹åºä¸­ï¼š\n1 2 3 int x; // in system ä¸ºè¯¥å˜é‡åˆ†é…ä¸€ä¸ªå­˜å‚¨ç©ºé—´ x = 10; // å°† 10 å­˜å…¥è¯¥å­˜å‚¨ç©ºé—´ï¼Œä¸å˜é‡æ¯æ¯ç›¸å…³çš„å­˜å‚¨ç©ºé—´ x = x+1; é€šè¿‡å˜é‡èƒ½å¤Ÿæ‰¾åˆ°å­˜å‚¨åœ¨å¯¹åº”ç©ºé—´ä¸­æ•°æ®ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥å»å¼•ç”¨è¿™ä¸ªç©ºé—´åœ°å€( address ç¼–å·);\né—®ï¼šå¦‚ä½•è·å–å˜é‡åœ°å€å‘¢ï¼Ÿè·å–çš„åœ°å€åˆå¦‚ä½•å­˜æ”¾ï¼Ÿï¼ˆæŒ‡é’ˆï¼‰\nåˆ©ç”¨ä¸€ä¸ªå–åœ°å€è¿ç®—ç¬¦ï¼š\u0026amp; è¯»ä½œ and\næ ¼å¼ï¼š\n1 2 3 4 // ç±»å‹ *æŒ‡é’ˆå = \u0026amp;x; è·å–åœ°å€ç¼–å·ï¼Œæ•°ï¼›åˆ©ç”¨æŒ‡é’ˆæ¥å­˜å‚¨å˜é‡çš„åœ°å€ int x; int *px; // æŒ‡é’ˆå®šä¹‰ px = \u0026amp;x; // px æŒ‡é’ˆä¿å­˜ x å˜é‡çš„åœ°å€ï¼› æŒ‡é’ˆï¼šç”¨äºå­˜å‚¨åœ°å€ï¼ˆæŒ‡é’ˆæŒ‡å‘å˜é‡ï¼‰ï¼›\nâš ï¸ æŒ‡é’ˆç±»å‹å¿…é¡»å’Œè¢«æŒ‡å‘çš„å˜é‡ç±»å‹ä¸€è‡´ï¼›\næ˜Ÿå·ï¼Œå–æŒ‡é’ˆæ‰€æŒ‡å‘å­˜å‚¨ç©ºé—´ä¸­çš„æ•°æ®ï¼›\næŒ‡é’ˆæœ¬èº«å¯ä»¥è¿ç®—\n1 2 3 int p[10]; int *q = p; q++ æ“ä½œç³»ç»Ÿå¦‚ä½•ç®¡ç†å†…å­˜ æ ˆç©ºé—´: 4~8M å¤§å°ï¼Œæ¯è¿›å…¥ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä¼šåˆ†é…ç©ºé—´ï¼Œç¦»å¼€æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å›æ”¶ã€‚\nå †ç©ºé—´: å†…å­˜è¾ƒå¤§ï¼Œéœ€è¦æ‰‹åŠ¨åˆ†é…å›æ”¶ï¼Œä¸€æ—¦åˆ†é…ï¼Œåœ¨æ‰€æœ‰å‡½æ•°ä¸­åªè¦çŸ¥é“åœ°å€å°±å¯ä»¥è®¿é—®\nå†…å­˜æ˜ å°„: ç£ç›˜çš„æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œå¯¹å†…å­˜ä¿®æ”¹ï¼Œç£ç›˜çš„æ–‡ä»¶åŒæ—¶å‘ç”Ÿå˜åŒ–\n1 2 void * mem = malloc(size); // size éœ€è¦å­—èŠ‚å¯¹é½ free(mem); ä¸æ–­çš„å‘ç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œä¸é‡Šæ”¾ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œä½¿ç”¨å·²ç»é‡Šæ”¾å†…å­˜çš„æŒ‡é’ˆç§°ä¸ºé‡æŒ‡é’ˆã€‚\nå‡½æ•°æŒ‡é’ˆ è¿”å›å€¼ç±»å‹ (*æŒ‡é’ˆå˜é‡å) ([å½¢å‚åˆ—è¡¨]);\n1 2 3 int func(int x); // å£°æ˜å‡½æ•° int (*f) (int x); // å£°æ˜å‡½æ•°æŒ‡é’ˆ f = func; ä¾‹é¢˜ ä¸€ ä»é”®ç›˜è¾“å…¥ä¸‰ä¸ªæ•°æ±‚æœ€å°å€¼ï¼Œå¯¹å˜é‡æ•°æ®å¼•ç”¨ï¼Œé€šè¿‡åœ°å€å¼•ç”¨ï¼›\n1 2 3 4 5 6 7 8 9 int x,y,z,min; int *px=\u0026amp;x,*py=\u0026amp;y,*pc=\u0026amp;z; printf(\u0026#34;input x,y,z,ç©ºæ ¼éš”å¼€:\u0026#34;) scanf(\u0026#34;%d %d %d\u0026#34;,px,py,pc); min = *px\u0026lt;*py?*px:*py; min = min\u0026gt;*pz?*pz:min; printf(\u0026#34;%d\\n\u0026#34;,min); äºŒ åˆ©ç”¨æŒ‡é’ˆå¼•ç”¨æ•°ç»„å…ƒç´ çš„å€¼\næ•°ç»„åå°±æ˜¯æ•°ç»„å…ƒç´ çš„é¦–åœ°å€ï¼›\n1 2 3 4 5 \u0026amp;a[0] == a; // ä¸¤è€…ç­‰ä»·ï¼Œé¦–åœ°å€ int *p = a; // ä½¿ p æŒ‡é’ˆæŒ‡å‘æ•°ç»„å…ƒç´ é¦–åœ°å€ p++; // æŒ‡é’ˆç§»åŠ¨åˆ°ç¬¬äºŒä¸ªå…ƒç´  p+1ï¼› // è¡¨ç¤ºç¬¬äºŒä¸ªå…ƒç´ ï¼Œä½†æ˜¯æŒ‡é’ˆä¾ç„¶åœç•™åœ¨é¦–åœ°å€ æ•°ç»„ä¸­å…ƒç´ çš„åœ°å€æ˜¯è¿ç»­çš„ï¼›\næ•°ç»„åæ˜¯é¦–åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯å›ºå®šä¸å˜çš„ï¼Œconstantï¼›å› æ­¤ä¸èƒ½æœ‰ a++ï¼›\nå½“ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°ç»„çš„é¦–åœ°å€ï¼Œæ­¤æ—¶æŒ‡é’ˆå’Œæ•°ç»„åå…·æœ‰å®Œå…¨çš„ç­‰ä»·æ•ˆæœï¼›ï¼ˆå‡¡æ˜¯æ•°ç»„åèƒ½åšçš„äº‹æƒ…ï¼ŒæŒ‡é’ˆéƒ½å¯ä»¥åšåˆ°ï¼‰\n1 2 3 4 5 6 7 // æ•°ç»„åä½œä¸ºåœ°å€ï¼Œå¯ä»¥åŠ å‡ï¼›å…¶ä½™æ•ˆæœå¾…éªŒè¯ï¼› int *p; int a[10] = {1,2,3,4,5,6,7}; p = a+4; // p æŒ‡é’ˆæŒ‡å‘ä¸‹æ ‡ä¸º 4 çš„å…ƒç´ ï¼Œç­‰ä»· a[4]; a = a+4; // Errorï¼Œå¸¸é‡ä¸èƒ½èµ‹å€¼ printf(\u0026#34;%d\\n\u0026#34;,*(a+3)); // aæ˜¯åœ°å€ï¼Œæ•…æ­¤ç­‰ä»·äº *(p+3) // a[3] == *(a+3) == *(p+3) == p[3] ä¸‰ ä»é”®ç›˜è¾“å…¥10ä¸ªæ•°ï¼Œå­˜å…¥æ•°ç»„ä¸­ï¼Œæ±‚10ä¸ªæ•°å¹³å‡æ•°ï¼Œå¯¹æ•°ç»„å…ƒç´ çš„å¼•ç”¨ä½¿ç”¨æŒ‡é’ˆï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 int a[10]; int *p = a; int i,sum=0; while(p \u0026lt;= a+9){ // è¯»å…¥10ä¸ªå…ƒç´  scanf(\u0026#34;%d\u0026#34;,p); p++; } p = a; // å°†æŒ‡é’ˆæ¢å¤åˆ°æ•°ç»„é¦–åœ°å€ for(i=0; i\u0026lt;10; i++){ sum += *(p+i); // * çš„è¿ç®—ç¬¦å¾ˆé«˜ï¼Œå…ˆå–åœ°å€éœ€è¦åŠ æ‹¬å· } printf(\u0026#34;%f\\n\u0026#34;,sum/10.0); // è‹¥æ˜¯æ±‚å¹³å‡æ•°ï¼Œä¸€å®šè¦é™¤ä»¥ æµ®ç‚¹æ•° å¯¹æŒ‡é’ˆæ¥è¯´ï¼Œå¯ä»¥åŠ ä¸€ä¸ªæ•° or å‡ä¸€ä¸ªæ•°ï¼Œä¸¤ä¸ªæŒ‡é’ˆå¯ä»¥ç›¸å‡ï¼Œä¸¤ä¸ªæŒ‡é’ˆå¯ä»¥æ¯”è¾ƒå¤§å°ï¼›\nä¸‰ åˆ©ç”¨æŒ‡é’ˆæ¥å¼•ç”¨å­—ç¬¦ä¸²\nå­—ç¬¦ä¸²æœ‰ç»“æŸæ ‡å¿— ï¼š\n1 st[i] != \u0026#39;\\0\u0026#39; ä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œå€’ç½®å­—ç¬¦ä¸²å…ƒç´ ï¼Œä¾‹å¦‚ abced â€”\u0026gt; decbaï¼›\nè§£é¢˜æ€è·¯ï¼šåœ¨å­—ç¬¦ä¸²çš„é¦–ä½åˆ†åˆ«è®¾ç½®ä¸€ä¸ªæŒ‡é’ˆï¼Œäº¤æ¢ä»¥åi++,j\u0026ndash;ï¼›ç›´åˆ°ä¸¤ä¸ªæŒ‡é’ˆç›¸é‡ååœæ­¢ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 char st[100]; char *i,*j,t; gets(st); i = st; j = st+strlen(st)-1; // æ€»æ•°-1 = æœ€åä¸€ä¸ªä¸‹æ ‡ while(i\u0026lt;=j){ t = *i; *i = *j; *j = t; i++; j--; } printf(\u0026#34;%s\\n\u0026#34;,st); ","date":"2018-08-22T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%8D%81%E4%B8%80%E8%AF%BE-%E6%8C%87%E9%92%88/","title":"ç¬¬åä¸€è¯¾ æŒ‡é’ˆ"},{"content":"äºŒç»´æ•°ç»„ å®šä¹‰ æ•°ç»„å…ƒç´ ä¸‹æ ‡çš„ä¸ªæ•°;\näºŒç»´æ•°ç»„å…ƒç´ çš„ä¸‹æ ‡è‚¯å®šæ˜¯ä¸¤ä¸ªï¼›åœ¨äºŒç»´ä¸­ï¼Œè¦è¡¨è¾¾æ•°å…·ä½“ä½ç½®æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªä¸‹æ ‡â€”â€”è¡Œåˆ—ï¼›\näºŒç»´æ•°ç»„æ˜¯ç”±è‹¥å¹²ä¸ªè¡Œåˆ—æ„æˆï¼› ä¸è®ºæ˜¯å‡ ä½æ•°ç»„ï¼Œåœ¨å­˜å‚¨å™¨ä¸­éƒ½æ˜¯è¿ç»­çš„ã€‚\nforcmtï¼šæ•°ç»„å[è¡Œæ•°][åˆ—æ•°]ï¼›\nåœ¨å®šä¹‰äºŒç»´æ•°ç»„åŒæ—¶ï¼Œå¯ä»¥æ•´ä½“èµ‹å€¼ï¼›\næœ‰ä¸¤èµ‹å€¼æ ¼å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 int a[3][3] = { {2,3,4},{4},{6,} }, /* 1 2 3 4 0 0 6 0 0 */ int a[][3] = {1,2,3,5,3,6}; // 234 // 536 // 000 æœ‰è¡Œï¼Œåˆ—æœ‰=ä¸¤ä¸ªéƒ¨åˆ†æ„æˆï¼Œè¡Œå·ä» 0-n-1ï¼›åˆ—å¥½ 0-m-1ï¼› åœ¨å®šä¹‰äºŒç»´æ•°ç»„æ—¶ï¼Œå¦‚æœåé¢æœ‰èµ‹å€¼ï¼Œè¡Œå¯ä»¥çœç•¥\nä¾‹é¢˜ ä¸€ ä»æ—å»ºè¾“å…¥ 12 ä¸ªæ•°å­˜å…¥æ•°ç»„ï¼Œè¾“å…¥è¯­å¥å¦‚ä½•å†™ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 int a[3][4]; for(i=0;i\u0026lt;3;i++){ form(j=0; j\u0026lt;4; j++){ scanf(\u0026#34;%d\u0026#34;,\u0026amp;a[i][j]); } } for(i=0; i\u0026lt;3; i++){ for(j=0; j\u0026lt;4; j++){ printf(\u0026#34;%2d\u0026#34;,a[i][j]); } printf(\u0026#34;\\n\u0026#34;); } è¾“å…¥éœ€è¦ä¸¤ä¸ªå¾ªç¯ï¼Œä¸€ä¸ªèµ°è¡Œä¸€ä¸ªèµ°åˆ—ï¼›\nå…³äºäºŒç»´æ•°ç»„çš„æ¦‚å¿µï¼š\nçŸ©é˜µï¼šé€šå¸¸å°±è¡Œåˆ—ç›¸ç­‰çš„äºŒç»´æ•°ç»„å«åšçŸ©é˜µï¼›\nçŸ©é˜µå¯¹è§’çº¿ï¼šè¡Œæ ‡å’Œåˆ—æ ‡æ˜¯ç›¸ç­‰çš„ï¼Œi == j ä¸»å¯¹è§’çº¿ï¼ˆå·¦ï¼‰ï¼Œæ¬¡å¯¹è§’çº¿ï¼ˆå³ï¼‰ï¼Œè¡Œæ ‡+åˆ—è¡¨==è¡Œæ•°-1\n0ï¼Œ0 ä¸»å¯¹è§’çº¿ 0ï¼Œ3 æ¬¡å¯¹è§’çº¿ 0+3=4-1\n1ï¼Œ1 1ï¼Œ2 1+2=4-1\n2ï¼Œ2 2ï¼Œ1\n3ï¼Œ3 3ï¼Œ0\näºŒ ä»é”®ç›˜è¾“å…¥ä¸€ä¸ª 4x4 çŸ©é˜µï¼Œæ±‚å¯¹è§’çº¿å…ƒç´ ä¹‹å’Œ\n1 2 3 4 5 6 7 8 9 10 11 12 int a[4][4]; int i,j,sum=0; for(i=0; i\u0026lt;4; i++) for(j=0; j\u0026lt;4; j++) scanf(\u0026#34;%d\u0026#34;,\u0026amp;a[i][j]); // å°†æ¨¡å—åˆ†å¼€ï¼Œä¸è¦è¯»å…¥çš„æ—¶å€™åš for(i=0; i\u0026lt;4; i++) for(j=0; j\u0026lt;4; j++) if(i=j || i+j==4-1) sum += a[i][j]; printf(\u0026#34;%d\\n\u0026#34;,sum); çŸ©é˜µçš„ä¸Šä¸‰è§’å’Œä¸‹ä¸‰è§’ï¼Œå¯¹è§’çº¿çš„ä¸‹é¢æ˜¯ä¸‹ä¸‰è§’ï¼Œä¸Šé¢æ˜¯ä¸Šä¸‰è§’ï¼›\nä¸åŒ…æ‹¬å¯¹è§’çº¿ï¼š\nä¸‹ä¸‰è§’ï¼šè¡Œæ ‡å¤§äºåˆ—æ ‡ ä¸Šä¸‰è§’ï¼šè¡Œæ ‡å°äºåˆ—æ ‡ æŠŠä¸€ä¸ªçŸ©é˜µçš„ä¸Šä¸‰è§’å’Œä¸‹ä¸‰è§’éƒ¨åˆ†å¯¹è°ƒï¼Œå°±åœ¨çŸ©é˜µè½¬ç½® a[i][j] å’Œ a[j][i] æ„æˆè½¬ç½®çŸ©é˜µï¼›\nä¸‰ ä»é”®ç›˜è¾“å…¥ 4x4 çŸ©é˜µï¼Œè¾“å‡ºä»–çš„è½¬ç½®çŸ©é˜µ\nè§£é¢˜æ€è·¯ï¼šç«™åœ¨ä¸‹ä¸‰è§’æ‰¾ä¸Šä¸‰è§’äº¤æ¢ï¼Œæˆ–è€…ç«™åœ¨ä¸Šä¸‰è§’æ‰¾ä¸‹ä¸‰è§’æ›¿æ¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 int a[4][4]; int i,j,t; for(i=0; i\u0026lt;4; i++) for(j=0; j\u0026lt;4; j++) scanf(\u0026#34;%d\u0026#34;,\u0026amp;a[0][0]); for(i=0; i\u0026lt;4; i++){ for(j=0; j\u0026lt;=i; j++){ t = a[i][j]; a[i][j] = a[j][i]; a[j][i] = t; } } printf(\u0026#34;\\n\\n\u0026#34;); for(i=0; i\u0026lt;4; i++) for(j=0; j\u0026lt;4; j++) printf(\u0026#34;%3d\u0026#34;,a[i][j]); å›› æ¨è¾‰ä¸‰è§’å½¢\nç¬¬ä¸€åˆ—ï¼š1 ä¸»å¯¹è§’çº¿ï¼š1\né™¤äº†ç¬¬ä¸€åˆ—å’Œä¸»å¯¹è§’çº¿å¤–ï¼Œa[i][j] = a[i-1][j-1] + a[i-1][j]\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 int a[7][7]; int i,j; for(i=0; i\u0026lt;7; i++) for(j=0; j\u0026lt;strlen;); scanf(\u0026#34;5d\u0026#34;ï¼Œstrlen); for(i=0; i\u0026lt;7; i++){ a[i][0] = 1; a[i][i] = 1; } for(i=2; i\u0026lt;7; i++) for(j=1; j\u0026lt;=i+1; j++) a[i][j] = a[i-19[j-1 + a[i-1][j]; // å¾…å®Œæˆ äº” ä»é”®ç›˜è¾“å…¥ 4x4çš„çŸ©é˜µ ï¼Œæ±‚æ¯çŸ©é˜µæ¯è¡Œæœ€å°å€¼\n1 2 3 4 5 6 7 8 9 10 int a[4][4]; int i,j,,max,mink; for(i=0; i\u0026lt;4; i++ { max[i] = a[i][0]; for(j=1; j\u0026lt;4; j++) if(max[i]\u0026lt;a[i]]j]); }) scanf(\u0026#34;%d\u0026#34;,\u0026amp;[i][j]); ","date":"2018-08-22T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%8D%81%E8%AF%BE-%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84/","title":"ç¬¬åè¯¾ äºŒç»´æ•°ç»„"},{"content":"å­—ç¬¦æ•°ç»„ä¾‹é¢˜ å®šä½ç½®åˆ é™¤ ä¸€ ä»é”®ç›˜è·å–ä¸€ä¸²å­—ç¬¦ï¼ŒåŒæ—¶è¾“å…¥ä¸€ä¸ªä½ç½® lï¼Œå°†å­—ç¬¦ä¸­ l ä½ç½®å­—ç¬¦åˆ é™¤ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 char st[50]; int i,l,t; printf(\u0026#34;input char:\u0026#34;); gets(st); printf(\u0026#34;æ¸…è¾“å…¥ä½ç½®lï¼š\u0026#34;); scanf(\u0026#34;%d\u0026#34;,\u0026amp;l); for(i=i+1; i\u0026lt;strlen(st)+1; i++){ // +1ï¼›æ³¨æ„æœ€åé¢çš„ \\0 st[i-1] = st[i]; } printf(\u0026#34;%s\\n\u0026#34;,st); äºŒ ä»é”®ç›˜è·å–ä¸€ä¸²å­—ç¬¦ï¼Œå†è¾“å…¥ä¸€ä¸ªmï¼Œnï¼ˆm\u0026lt;=nï¼‰ï¼Œè¯·åˆ é™¤å­—ç¬¦ä¸²ä¸­ m åˆ° n ä¹‹é—´å­—ç¬¦;\n1 2 3 4 5 6 7 8 9 10 11 12 char st[100]; int i,j,m,n,k=0; gets(st); printf(\u0026#34;input m,n:\u0026#34;) while(m\u0026gt;n) scanf(\u0026#34;%d%*c%d\u0026#34;,\u0026amp;m,\u0026amp;man); i = m; for(j=n+1; j\u0026lt;=strlen(st); j++){ st[i++] = st[j]; } } printf(\u0026#34;%s\\n\u0026#34;,st); ä¸‰ å®šå­—ç¬¦åˆ é™¤ï¼šä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦stï¼Œå†è¾“å…¥ä¸€ä¸ªå­—ç¬¦cï¼Œå°†å­—ç¬¦ä¸²ä¸­çš„cåˆ é™¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 char st[100]; int i,j; char c; printf(\u0026#34;input st:\u0026#34;); gets(st); printf(\u0026#34;input c:\u0026#34;) scanf(\u0026#34;%c\u0026#34;,\u0026amp;c); // å‡è‹¥ getsåè·Ÿç€getcharï¼Œè¾“å…¥çš„ç©ºæ ¼æ˜¯å¦ä¼šè¢«è¯»å…¥ for(i=0; i\u0026lt;strlen(st); i++){ // æŸ¥æ‰¾è¦åˆ é™¤çš„å­—ç¬¦ if(c == st[i])ï¼› for(j=i+1; j\u0026lt;strlen(st)+1; j++){ // ä»i+1ä½ç½®åˆ°endï¼ˆåŒ…æ‹¬ï¼‰ï¼ŒæŠŠæ¯ä¸ªå­—ç¬¦å¾€å‰ç§»åŠ¨ä¸€ä½ï¼Œè¦†ç›– a[j-1] = a[j]; } if(st[i]==c) i--; // æ­¤å¤„å¼¥è¡¥æ¼æ´,å¦‚æœä¸‹ä¸€ä¸ªæ•°è¿˜æ˜¯cï¼Œå°±i-- } } printf(\u0026#34;%s\\n\u0026#34;,st); å›› å­ä¸²çš„æŸ¥æ‰¾:å·²çŸ¥ st1ï¼Œé—® st2 æ˜¯å¦å‡ºç°åœ¨ st1 ä¸­ï¼Œè‹¥æ˜¯å‡ºç°ï¼Œè¿”å›é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼Œå¦åˆ™è¿”å›-1ï¼›æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼Œä¸€ç§ç›´è§‚æœ´ç´ åŒ¹é…æ–¹æ³•ï¼Œä¸€ç§æ˜¯KMPåŒ¹é…ç»å…¸ç®—æ³•ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // ç»å…¸ç®—æ³•ï¼Œå›æº¯ï¼Œè¿™ä¸ªä»£ç æœ‰ç‚¹å„¿ä¸æµç•…ï¼Œéœ€é‡æ–°æ„å»º char st1[100],st2[100]; int i,j,k=-1; printf(\u0026#34;input st1:\u0026#34;); gets(st1); printf(\u0026#34;input st2:\u0026#34;); gets(st2); i = 0; while(st1[i]!=\u0026#39;\\0\u0026#39;){ k = i; for(j=0; st2[j]!=\u0026#39;\\0\u0026#39;; j++) if(st1[k]==st2[j]) k++; else break; if(st2[j] == \u0026#39;\\0\u0026#39;){ printf(\u0026#34;%d\\n\u0026#34;,i); break; }else i++; } if(st1[i]==\u0026#39;\\0\u0026#39;){ printf(\u0026#34;-1\u0026#34;); } å¦‚æœ st1[i] == st2[j], i++,j++\nå¦‚æœ st1[i] != st2[j], j=0,i++\nå½“ st2 åˆ°åº•æ—¶ï¼Œè¯´æ˜æ‰¾åˆ°ä½ç½®ï¼›\nå½“ st1 åˆ°åº•æ—¶ï¼Œè¯´æ˜æ²¡æœ‰æ‰¾åˆ°ï¼›\näº” ç”¨æˆ·è‡ªå·±è®¾è®¡ç¨‹åºå®ç°ä¸¤ä¸ªå­—ç¬¦ä¸²çš„è¿æ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 char s1[20] = \u0026#34;aaa\u0026#34;; char s2[] = \u0026#34;bbb\u0026#34;; // ä¸ä½¿ç”¨ strcat å‡½æ•°ï¼Œæ‹¼æ¥å­—ç¬¦ä¸² int i,j,k; for(i=0;s1[i]!=\u0026#39;0\u0026#39;;i++); // å°† i æŒ‡å‘æœ«å°¾ï¼Œå³\u0026#39;\\0\u0026#39;ï¼› è·å–s1çš„ç»“æŸä½ç½® for(j=0; s2[j]!=\u0026#39;\\0\u0026#39;; j++) // å°† s2 å¼€å§‹ä½ç½®é€ä¸€å¾€ s1 è¿æ¥ s1[i++] = s2[j]; // s2æ•°ç»„æ‹¼æ¥åœ¨s1åé¢ s1[i] = \u0026#39;\\0\u0026#39;; // è¡¥ä¸Š \u0026#39;\\0\u0026#39; printf(\u0026#34;%s\\n\u0026#34;,s1); // è¾“å‡º result å›æ–‡åˆ¤å®š ä»€ä¹ˆæ˜¯å›æ–‡ï¼Ÿä»å­—ç¬¦ä¸²çš„å·¦è¾¹è¯»å’Œä»å­—ç¬¦ä¸²çš„å³è¾¹è¯»é¡ºåºæ˜¯ç›¸åŒçš„ï¼›\nä¾‹å¦‚ï¼šabcba\nä¸€ ä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œåˆ¤å®šæ˜¯å¦ä¸ºå›æ–‡ï¼Œæ˜¯è¾“å‡º\u0026quot;yes\u0026quot;ï¼Œä¸æ˜¯è¾“å‡º\u0026quot;no\u0026quot;ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 char st[30]; int i,j; printf(\u0026#34;input st:\u0026#34;); gets(st); i = 0; j = strlen(st)-1; // åŒºåˆ†ä¸ªæ•°å’Œä¸‹æ ‡ while(i\u0026lt;=j){ if(st[i] == st[j]){ i++; i--; }else break; } if(i\u0026lt;j) printf(\u0026#34;No\u0026#34;); else printf(\u0026#34;Yes\u0026#34;); äºŒ ä»é”®ç›˜è¾“å…¥ä¸€ä¸²ç¬¦å·ï¼Œåˆ¤å®šè¿™ä¸²ç¬¦å·å¦‚æœéƒ½æ˜¯æ•°å­—ï¼Œè¾“å‡º1ï¼Œå¦åˆ™è¾“å‡º0ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 char a[100]; int i,j,k; gets(a); for(i=0; i\u0026lt;strlen(a); i++) if(!(a[0]\u0026gt;=48 \u0026amp;\u0026amp; a[0]\u0026lt;=57)) break; if(a[i]==\u0026#39;\\0\u0026#39;) k=1; else k=0; printf(\u0026#34;%d\\n\u0026#34;,k); æ›´å¤š ä¸€ ä»é”®ç›˜è¾“å…¥ä¸€ä¸²æ•°å­—ç¬¦å·ï¼ŒæŠŠæ•°å­—ç¬¦å·è½¬åŒ–ä¸ºæ•°\n1 2 3 4 5 6 7 8 9 10 11 char st[100]; int i,j=0,k; printf(\u0026#34;input st:\u0026#34;); gets(st); for(i=0;i\u0026lt;strlen(st);i++){ // å–ä½ j = st[i]-\u0026#39;0\u0026#39;; // ä»»ä½•æ•°å­—ç¬¦å·-\u0026#39;0\u0026#39;éƒ½ç­‰äºæ•°å­—æœ¬èº« k=k*10+j; } printf(\u0026#34;%d\\n\u0026#34;,k); è§£å†³æ€è·¯ï¼š\nå–ä½ æŠŠè¿™ä¸ªä½å’Œæ•°å­—ç¬¦å·ï¼Œè¦è½¬æ¢ä¸ºæ•° å–å‡ºæ¥ä¸€ä½ï¼Œå‰é¢å°±å’Œå‡ä½ï¼ŒæŠŠå½“å‰è¿™ä¸ªä½åŠ ä¸Šå» äºŒ ä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œç»Ÿè®¡æ¯ä¸ªå°å†™å­—æ¯å‡ºç°çš„æ¬¡æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 int st[100],f[26]; int i,j,k=0; printf(\u0026#34;input st:\u0026#34;); gets(st); for(i=0; st[i]!=\u0026#39;\\0\u0026#39;;i++){ if(st[i]\u0026gt;=97 \u0026amp;\u0026amp; st[i]\u0026lt;=122){ f[st[i]-\u0026#39;a\u0026#39;]++; // é€šè¿‡ç¬¦å·åˆ¤æ–­ä¸‹æ ‡ } } for(i=0; i\u0026lt;26; i++){ if(f[i]!=0) printf(\u0026#34;%c:%d\\n\u0026#34;,i+\u0026#39;a\u0026#39;,f[i]); } ","date":"2018-08-21T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E4%B9%9D%E8%AF%BE-%E5%AD%97%E7%AC%A6%E6%95%B0%E7%BB%84%E4%BE%8B%E9%A2%98/","title":"ç¬¬ä¹è¯¾ å­—ç¬¦æ•°ç»„ä¾‹é¢˜"},{"content":"å­—ç¬¦ä¸² æ•°ç»„å¤ä¹ ä¾‹é¢˜ ä»é”®ç›˜è¾“å…¥ 10 ä½åŒå­¦çš„è€ƒè¯•æˆç»©å­˜å…¥æ•°ç»„ï¼ŒæŒ‰ç…§ä½åˆ†åˆ°é«˜åˆ†æ’åºï¼›ç„¶åè¾“å‡ºï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #include \u0026lt;stdbool.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #define arrLen 10 void print(int a[], int size) { for (int i = 0; i \u0026lt; size; i++) { printf(\u0026#34;%d \u0026#34;, a[i]); } printf(\u0026#34;\\n\u0026#34;); } // sort å†’æ³¡æ’åº void sort(int a[], int size) { // å¤–å±‚å¾ªç¯ 0:n-1 æ¬¡ for (int i = 0; i \u0026lt; size - 1; i++) { bool exchange = false; // å†…å­˜å¾ªç¯ 1:n-i æ¬¡ for (int j = 1; j \u0026lt; size - i; j++) { if (a[j - 1] \u0026gt; a[j]) { int t = a[j - 1]; a[j - 1] = a[j]; a[j] = t; } } if (exchange) { break; } } } int main(int argc, char const* argv[]) { int a[arrLen]; printf(\u0026#34;è¯·è¾“å…¥ 10 ä¸ªæˆç»©:\\n\u0026#34;); for (int i = 0; i \u0026lt; arrLen; i++) { scanf(\u0026#34;%d\u0026#34;, \u0026amp;a[i]); } printf(\u0026#34;æ­£åœ¨æ’åº...\\n\u0026#34;); sort(a, arrLen); print(a, arrLen); return 0; } æ•°ç»„å…ƒç´ æ‹†åˆ†ï¼Œä»é”®ç›˜è¾“å…¥ nï¼Œè¡¨ç¤ºæ•°ç»„ä¸­å­˜å‚¨å…ƒç´ ä¸ªæ•°ï¼Œç„¶åè¾“å…¥ n ä¸ªæ•°å­˜å…¥æ•°ç»„ï¼ŒæŠŠå¶æ•°æ”¾åœ¨b æ•°ç»„ï¼Œå¥‡æ•°æ”¾åœ¨ c æ•°ç»„ä¸­ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 #include \u0026lt;stdio.h\u0026gt; void print(int a[], int size) { for (int i = 0; i \u0026lt; size; i++) { printf(\u0026#34;%d \u0026#34;, a[i]); } printf(\u0026#34;\\n\u0026#34;); } int inputNum() { printf(\u0026#34;è¯·è¾“å…¥ä¸€ä¸ªæ•°:\u0026#34;); int v = 0; scanf(\u0026#34;%d\u0026#34;, \u0026amp;v); return v; } void inputArray(int a[], int size) { printf(\u0026#34;è¯·ä¾æ¬¡è¾“å…¥ %d ä¸ªæ•°å€¼\\n\u0026#34;, size); for (int i = 0; i \u0026lt; size; i++) { scanf(\u0026#34;%d\u0026#34;, \u0026amp;a[i]); } } int main(int argc, char const* argv[]) { int n = inputNum(); int a[n]; inputArray(a, n); int b[n], c[n]; int b1 = 0, c1 = 0; // åˆ¤æ–­æ•°ç»„å…ƒç´ æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°ï¼Œå¹¶ä¸”èµ‹å€¼åˆ°è§„å®šæ•°ç»„ for (int i = 0; i \u0026lt; n; i++) { if (a[i] % 2 == 0) { b[b1] = a[i]; b1++; } else { c[c1] = a[i]; c1++; } } print(b, b1); print(c, c1); return 0; } å·²çŸ¥æ•°ç»„ aï¼Œå°† 0 é›†ä¸­æ”¾åœ¨æ•°ç»„å‰é¢ï¼ŒæŠŠ 1 æ”¾åœ¨ååŠéƒ¨åˆ†ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #include \u0026lt;stdio.h\u0026gt; #define arrLen 10 void print(int a[], int size) { for (int i = 0; i \u0026lt; size; i++) { printf(\u0026#34;%d \u0026#34;, a[i]); } printf(\u0026#34;\\n\u0026#34;); } void core(int a[], int size) { int i = 0, j = size - 1; while (i \u0026lt; j) { if (a[i] == 0) { i++; continue; } if (a[j] != 0) { j--; continue; } int t = a[i]; a[i] = a[j]; a[j] = t; } } int main(int argc, char const* argv[]) { int a[arrLen] = {1, 1, 0, 0, 1, 0, 1, 1, 1, 0}; // result a[] = {0,0,0,0,1,1,1,1,1,1}; 4ä¸ª0ï¼Œ6ä¸ª1 core(a, arrLen); print(a, arrLen); return 0; } å­—ç¬¦ä¸² å­—ç¬¦ä¸²å¸¸é‡çš„è¡¨ç¤ºï¼Œä¸€å®šè¦åŠ åŒå¼•å·ï¼Œå­—ç¬¦å¸¸é‡è¦åŠ å•å¼•å·ï¼›\nå­—ç¬¦ä¸²æ¦‚å¿µï¼šæ˜¯æœ‰è‹¥å¹²å¤šä¸ªç¬¦å·ç»„æˆï¼›\nä¾‹å¦‚ï¼š\n1 2 3 \u0026#34;\u0026#34; // è¿™æ˜¯å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºç©ºä¸² \u0026#34;a\u0026#34; \u0026#34;abcde\u0026#34; å­—ç¬¦ä¸²å˜é‡ï¼š\nin c program ,æ²¡æœ‰å­—ç¬¦ä¸²æ•°æ®ç±»å‹ï¼›å­—ç¬¦ä¸²æ˜¯ç”¨å­—ç¬¦æ•°ç»„æ¥å­˜å‚¨ï¼›å­—ç¬¦ä¸²å˜é‡çš„å®šä¹‰ä¹Ÿå°±æ˜¯å®šä¹‰å­—ç¬¦æ•°ç»„ï¼›\n1 char st[100]; // å­—ç¬¦æ•°ç»„ å­—ç¬¦èµ‹å€¼ï¼Œåªæœ‰åœ¨å®šä¹‰å­—ç¬¦ä¸²æ—¶ï¼Œæ‰èƒ½æ•´ä½“èµ‹å€¼ï¼Œå®šä¹‰åä¸èƒ½æ•´ä½“èµ‹å€¼ï¼›\nå­—ç¬¦æ•°ç»„çš„ sizeof æ˜¯ 1ï¼Œæ¯ä¸ªä¸‹æ ‡åªèƒ½å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ï¼›ç»“å°¾æ˜¯ \\0ï¼Œè¡¨ç¤ºç»“æŸï¼Œå­˜å‚¨æ—¶ä»…åŠ ä¸€æ¬¡ï¼Œè‹¥æ˜¯ç”¨æˆ·åˆ é™¤æ’å…¥æ“ä½œï¼Œå¿…é¡»è‡ªå·±æ‰‹åŠ¨æ·»åŠ ï¼›\nåœ¨è®¿é—®å­—ç¬¦ä¸²æ—¶ï¼Œåªè¦é‡åˆ°ç»“æŸæ ‡å¿—ï¼Œå°±åœæ­¢è®¿é—®ï¼›\n1 2 3 4 st[i] != \u0026#39;\\0\u0026#39;; // è®¿é—®å­—ç¬¦ä¸²æ—¶çš„æ¡ä»¶ char st[5] = \u0026#34;aaaaa\u0026#34;; // æº¢å‡º char st[5] = \u0026#34;aaaaa\\0\u0026#34;; // å®é™…å­˜å‚¨æ–¹å¼ char st[] = \u0026#34;aaaaa\u0026#34;; // è¯¥å­˜å‚¨ç©ºé—´æ˜¯ 6 é‡ç‚¹ï¼ï¼,å³å­—ç¬¦æ•°ç»„é¢å¤–å ç”¨ä¸€ä¸ªchar 1 2 scanf(\u0026#34;%s\u0026#34;,å­—ç¬¦ä¸²å); // å­—ç¬¦ä¸²çš„è¾“å…¥æ–¹å¼ï¼Œæ— é¡»+ å–å€ç¬¦å· printf(\u0026#34;%s\u0026#34;,st); // è¾“å‡º ä½¿ç”¨ scanf è·å–å­—ç¬¦ä¸²ï¼Œè¾“å…¥æ—¶ä¸èƒ½å¸¦æœ‰ç©ºæ ¼ï¼Œå¦åˆ™ç©ºæ ¼åé¢å°±è‡ªåŠ¨æ–­å¼€ï¼›\n1 2 fgets // è¾“å…¥å­—ç¬¦ä¸² fputs // è¾“å‡ºå­—ç¬¦ä¸² å­—ç¬¦ä¸²å¸¸é‡\n1 2 3 4 5 6 char *s = \u0026#34;hello\u0026#34;; char *s1 = \u0026#34;hello\u0026#34;; // s å’Œ s1 æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œåœ°å€å¾ˆå°ï¼Œä½äºç¨‹åºçš„ä»£ç æ®µï¼Œåªè¯»!! // åªè¯»ä¸å¯æ”¹ // æƒ³è¦ä¿®æ”¹çš„å­—ç¬¦ä¸² char s[] = \u0026#34;hello\u0026#34; c program å…³äºå­—ç¬¦ä¸²æ“ä½œçš„ä¸€äº›åº“å‡½æ•° å‡½æ•°éƒ½æ˜¯åœ¨ \u0026lt;string.h\u0026gt; å¤´æ–‡ä»¶ä¸­ï¼›\n1 2 3 4 5 6 7 8 9 strlen(st); // æ±‚å­—ç¬¦ä¸²é•¿åº¦ï¼ˆä¸ªæ•°ï¼‰ï¼Œä¸åŒ…å«ç»“æŸæ ‡å¿—ï¼Œsizeof åŒ…å« // sizeof è®¡ç®—çš„æ˜¯æ€»å…±å­˜å‚¨ç©ºé—´ï¼Œè€Œä¸æ˜¯ä»…ä»…å­—ç¬¦ä¸²ç©ºé—´ strcat(s1,s2); // å°†å­—ç¬¦ä¸² s2 è¿æ¥åœ¨ s1 çš„åé¢ï¼Œæ„æˆä¸€ä¸ªæ•´ä½“ï¼› è¦æ±‚å­—ç¬¦ä¸² s1 å­˜å‚¨ç©ºé—´å¿…é¡»å¤Ÿå¤§ strcpy(s1,s2); // å®ç°å­—ç¬¦ä¸²çš„æ‹·è´ï¼Œåœ¨cè¯­è¨€ä¸­å­—ç¬¦ä¸²ä¸å…è®¸èµ‹å€¼ï¼Œè¦æƒ³å¯¹å­—ç¬¦ä¸²è¿›è¡Œèµ‹å€¼ï¼Œå¿…é¡»ç”¨èµ‹å€¼å‡½æ•° st1 = st2ï¼› // Error strcmp(s1,s2); //æ¯”è¾ƒå­—ç¬¦ä¸²st1ä¸st2æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥æ˜¯ç›¸ç­‰è¿”å›0ï¼Œè‹¥æ˜¯ä¸ç­‰ï¼Œè¿”å›-1/1ï¼› // é€ä¸€ä½ç½®æ¯”è¾ƒï¼Œå¦‚æœé‡åˆ°ä¸ç›¸ç­‰ï¼Œåœæ­¢æ¯”è¾ƒï¼Œå¦‚æœs1å­—ç¬¦ ascll å€¼å¤§è¿”å›1(s1\u0026gt;s2)ï¼Œè‹¥æ˜¯s1çš„ ascll å€¼å°ï¼Œè¿”å›-1(s1\u0026lt;s2) è‹¥æ˜¯ getchar è·å–ä¸€ä¸ªå­—ç¬¦ï¼Œæƒ³è¦çš„ä¸æ˜¯å­—ç¬¦ï¼Œè€Œæ˜¯æ•°å­—æœ¬èº«ï¼Œå‡å» \u0026lsquo;0\u0026rsquo; å³å¯å¾—åˆ°æ•°å­—æœ¬èº«ï¼Œçœ‹ä¸‹é¢ä¾‹å­ï¼š\n1 2 3 n = getchar(); // input 2 n-0 = 50; // ascll å³æ— ç”¨åŠŸï¼Œn æœ¬èº«å°±æ˜¯50 n-\u0026#39;0\u0026#39; = 2; // æ•°å­—æœ¬èº« 50-48=2 å­—ç¬¦ä¸²ä¾‹é¢˜ å­—ç¬¦ä¸²æ“ä½œï¼šä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼ŒæŠŠå…¶ä¸­å¤§å†™å­—æ¯æ”¹æˆå°å†™å­—æ¯ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 #include \u0026lt;stdio.h\u0026gt; int main(int argc, char const* argv[]) { char p[100]; fgets(p, 100, stdin); for (int i = 0; i \u0026lt; p[i] != \u0026#39;\\0\u0026#39;; i++) { if (p[i] \u0026gt;= \u0026#39;A\u0026#39; \u0026amp;\u0026amp; p[i] \u0026lt;= \u0026#39;Z\u0026#39;) { p[i] += 32; } } fputs(p, stdout); return 0; } å­—ç¬¦ä¸²ç»Ÿè®¡ï¼šä»é”®ç›˜è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼ˆä¸€å¥è¯ï¼‰ï¼Œç»Ÿè®¡è¿™å¥è¯ä¸­å•è¯çš„ä¸ªæ•°ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #include \u0026lt;stdio.h\u0026gt; int count(char a[]) { int sum = 0; for (int i = 0; i \u0026lt; a[i] != \u0026#39;\\0\u0026#39;; i++) { if (a[i] == \u0026#39; \u0026#39;) { sum++; } } return sum + 1; } int main(int argc, char const* argv[]) { char a[100]; fgets(a, 100, stdin); int c = count(a); printf(\u0026#34;%d\\n\u0026#34;, c); return 0; } ","date":"2018-08-19T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%85%AB%E8%AF%BE-%E5%AD%97%E7%AC%A6%E4%B8%B2/","title":"ç¬¬å…«è¯¾ å­—ç¬¦ä¸²"},{"content":"æ•°ç»„ å®šä¹‰ 1 2 3 4 5 6 7 8 æ•°æ®ç±»å‹ æ•°ç»„å[æ•°ç»„å…ƒç´ ä¸ªæ•°]ï¼› // æ•°æ®ç±»å‹æ˜¯å­˜å‚¨çš„ç¬¬ä¸€æ¡ä»¶ // æ•°æ®åå¼•ç”¨æ•°ç»„çš„ä¾æ® // å…ƒç´ çš„ä¸ªæ•°å¿…é¡»æ˜¯å¸¸é‡ï¼ int a[10]; // å®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨ 10 ä¸ª int å‹æ•°æ®ï¼Œ10 ä¸ºå…ƒç´ ä¸ªæ•°ï¼Œæœ€å¤§ä¸‹æ ‡ä¸º 9 // å¼•ç”¨æ–¹æ³• æ•°ç»„å[ä¸‹æ ‡]ï¼› // å‡è®¾æ•°ç»„çš„å…ƒç´ ä¸ªæ•°ä¸º n ä¸ªï¼Œå³ä¸‹æ ‡ä¸º 0 è‡³ n-1ï¼› å½“å®šä¹‰æ•°ç»„æ—¶ä¸å¡«å†™å…ƒç´ ä¸ªæ•°ï¼Œå³èµ‹å€¼nä¸ªï¼Œå°±ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸ºn+1\n1 æ•°æ®ç±»å‹ æ•°ç»„å[] = {value1,value2,...} åœ¨å®šä¹‰æ•°ç»„æ—¶ï¼Œå¦‚æœæœ‰èµ‹å€¼ï¼Œèµ‹å€¼çš„ä¸ªæ•°ä¸èƒ½è¶…è¿‡å…ƒç´ ä¸ªæ•°ï¼›è‹¥æ˜¯è¶…è¿‡ï¼Œåˆ™æº¢å‡ºæŠ¥é”™ï¼›\n1 int a[5] = {1,2,3,4,5,6} // æº¢å‡º å½“èµ‹å€¼ä¸ªæ•°\u0026lt;å…ƒç´ ä¸ªæ•°ï¼Œåˆ™å¤šä½™å…ƒç´ è‡ªåŠ¨åˆå§‹åŒ–ä¸º0ï¼›\n1 int a[100] = {0}; // æ•°ç»„æ‰€æœ‰å…ƒç´ åˆå§‹åŒ–ä¸º0ï¼Œåœ¨ç§»æ¤ä¸Šä¼¼ä¹æœ‰é—®é¢˜ï¼Œè¯¦è§ç¬”è®°\u0026#34;ä¸‰ç§åˆå§‹åŒ–æ•°ç»„çš„æ–¹æ³•\u0026#34; æ•°ç»„å…ƒç´ é”®ç›˜è¾“å…¥(åŸºæœ¬éƒ½æ˜¯é å¾ªç¯)\n1 2 3 4 5 int a[10]; for (int i=0; i\u0026lt;10; i++) { scanf(\u0026#34;%d\u0026#34;,\u0026amp;a[i]); // å¯ä»¥ä¸åŠ å–å€ç¬¦ } 1 2 3 4 // æ•°ç»„ä¸ç”¨å–å€¼ç¬¦å·çš„æƒ…å†µ a[10] = {1}; // ä¾ç„¶åˆå§‹åŒ–ä¸º 0 scanf(\u0026#34;%d\u0026#34;,a); // ä»é”®ç›˜è·å–ä¸€ä¸ªæ•°å€¼ç»™ a scanf(\u0026#34;%d\u0026#34;,a+2); // ä»é”®ç›˜è·å–ä¸€ä¸ªvalue ç»™ a[2]; ä¾‹é¢˜ æ•°ç»„é€†åºè¾“å‡º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #include \u0026lt;stdio.h\u0026gt; void print(int a[], int size) { int i = size; while (i \u0026gt; 0) { i--; printf(\u0026#34;%d \u0026#34;, a[i]); } printf(\u0026#34;\\n\u0026#34;); } int main(int argc, char const* argv[]) { int a[] = {10, 20, 30, 40, 50, 60, 70, 80, 90, 100}; int i = sizeof(a) / sizeof(a[0]); print(a, i); } æ‰¾å‡ºæœ€å¤§å€¼ï¼Œä»¥åŠå…¶ä½ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #include \u0026lt;stdio.h\u0026gt; int main(int argc, char const *argv[]) { int n; int a[100]; printf(\u0026#34;æœ‰å¤šå°‘ä¸ªæ•°: \u0026#34;); scanf(\u0026#34;%d\u0026#34;, \u0026amp;n); printf(\u0026#34;è¯·ä¾æ¬¡è¾“å…¥è¿™äº›æ•°å€¼\\n\u0026#34;); /* code */ for (int i = 0; i \u0026lt; n; i++) { scanf(\u0026#34;%d\u0026#34;, \u0026amp;a[i]); } int max = 0; for (int j = 1; j \u0026lt; n; j++) { if (a[max] \u0026lt; a[j]) max = j; } printf(\u0026#34;%d %d\\n\u0026#34;, a[max], max); return 0; } æ•°æ®æŸ¥æ‰¾ï¼Œä»é”®ç›˜è¾“å…¥xï¼ŒæŸ¥æ‰¾é¦–æ¬¡å‡ºç°xï¼Œåœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰è¿”å›-1\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #include \u0026lt;stdio.h\u0026gt; int main(int argc, char const *argv[]) { const int a[] = {10, 20, 30, 40, 50, 60, 70, 80, 90, 100}; printf(\u0026#34;è¯·è¾“å…¥å¾…æŸ¥æ‰¾çš„å€¼:\u0026#34;); int x = 0; scanf(\u0026#34;%d\u0026#34;, \u0026amp;x); int idx = -1; for (int i = 0; i \u0026lt; 10; i++) { if (x == a[i]) { idx = i; break; } } printf(\u0026#34;%d\\n\u0026#34;, idx); return 0; } ç»Ÿè®¡ï¼Œä»é”®ç›˜è¾“å…¥10ä¸ªåŒå­¦æˆç»©å­˜å…¥æ•°ç»„ï¼Œç»Ÿè®¡å°äºå¹³å‡åˆ†çš„äººæ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #include \u0026lt;stdio.h\u0026gt; #define ArrayLen 10 int main(int argc, char const *argv[]) { printf(\u0026#34;è¯·è¾“å…¥ 10 ä½åŒå­¦çš„åˆ†æ•°:\\n\u0026#34;); int number[ArrayLen]; int sum = 0; for (int i = 0; i \u0026lt; ArrayLen; i++) { scanf(\u0026#34;%d\u0026#34;, \u0026amp;number[i]); sum += number[i]; } printf(\u0026#34;æ­£åœ¨ç»Ÿè®¡ä¸­...\\n\u0026#34;); int j = 0; for (int i = 0; i \u0026lt; ArrayLen; i++) { // åŒºåˆ† float å’Œ int é™¤æ³• if (sum / 10.0 \u0026gt; number[i]) j++; } printf(\u0026#34;å°äºå¹³å‡åˆ†çš„äººæ•°: %d\\n\u0026#34;, j); return 0; } æ•°ç»„æ’å…¥ï¼Œä»é”®ç›˜è¾“å…¥ä¸€ä¸ªä½ç½® lï¼Œä¸€ä¸ªæ•° xï¼Œå°† x æ’å…¥åˆ° l çš„ä½ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #include \u0026lt;stdio.h\u0026gt; int main(int argc, char const *argv[]) { int a[5] = {1, 2, 3, 5}; printf(\u0026#34;è¯·è¾“å…¥ä½ç½®å’Œæ•°å€¼:\u0026#34;); int idx, v; scanf(\u0026#34;%d%*c%d\u0026#34;, \u0026amp;idx, \u0026amp;v); if (idx \u0026lt; 0) { printf(\u0026#34;è¾“å…¥ä¸‹æ ‡æœ‰è¯¯\\n\u0026#34;); return -1; } for (int i = 4; i \u0026gt; idx; i--) { a[i] = a[i - 1]; } a[idx] = v; for (int i = 0; i \u0026lt; 5; i++) { printf(\u0026#34;%d\\t\u0026#34;, a[i]); } return 0; } æœ‰åºæ’å…¥ï¼Œå°†æ•°ç»„ä¸­å­˜å‚¨æ•°æ®æ˜¯æœ‰é¡ºåºçš„ï¼ŒæŠŠ x æ’å…¥åˆ°æ•°ç»„ä¸­ï¼Œè¿˜æœ‰ä¿è¯æ•°ç»„ä¸­å…ƒç´ å€¼ä»ç„¶æœ‰åºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #include \u0026lt;stdio.h\u0026gt; int main(int argc, char const *argv[]) { printf(\u0026#34;è¯·è¾“å…¥å‚æ•°:\u0026#34;); int a[10] = {10, 20, 30, 40, 50, 60, 70, 80, 90}; int v = 9; scanf(\u0026#34;%d\u0026#34;, \u0026amp;v); int idx = 0; // åˆ¤æ–­ x æ’å…¥çš„ä½ç½® for (int i = 0; i \u0026lt; 10; i++) { if (v \u0026lt;= a[i]) { idx = i; break; } } // å°†è¯¥ä½ç½®åŠä»¥åçš„æ‰€æœ‰å€¼å…¨éƒ¨åç§»åŠ¨ä¸€ä½ for (int i = 9; i \u0026gt; idx; i--) { a[i] = a[i - 1]; } // æ’å…¥è¯¥å€¼ a[idx] = v; // è¾“å‡ºç»“æœ for (int i = 0; i \u0026lt; 10; i++) { printf(\u0026#34;%d\\t\u0026#34;, a[i]); } return 0; } åˆ é™¤ï¼šå®šä½å†åˆ é™¤ï¼›è¾“å…¥ä½ç½® Lï¼Œåˆ é™¤ L ä½ç½®çš„å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 int a[10] = {23,4,67,3,46,8,40,10,90,40}; int l,i; scanf(\u0026#34;%d\u0026#34;,\u0026amp;l); for(i=l; i\u0026lt;10; i++){ // åˆ é™¤ä¸€ä¸ªæ•°ï¼Œç›´æ¥å°†åé¢çš„æ•°å‘å‰è¦†ç›– a[i] = a[i+1]; } // Qï¼šåˆ é™¤è¦†ç›–åï¼Œæœ€åé¢ç©ºå‡ºæ¥çš„å€¼ä¾ç„¶ä¿æŒåŸå€¼ for(i=0; i\u0026lt;9; i++){ // è¾“å‡ºç»“æœ printf(\u0026#34;%d \u0026#34;,a[i]); } printf(\u0026#34;\\n\u0026#34;); æŒ‡å®šæ•°æ®åˆ é™¤ï¼šå‡å¦‚è¦åˆ é™¤xï¼Œifï¼ˆx==a[i]ï¼‰ç§»åŠ¨è¦†ç›–ï¼Œè®°ä½å¯èƒ½æœ‰å¤šä¸ªè¦åˆ é™¤çš„æ•°æ®ï¼Œè¿™æ—¶æˆ‘ä»¬åˆ é™¤ä¸€ä¸ªä¸èƒ½åœæ­¢ã€‚å¿…é¡»è¦æŠŠæ•°ç»„ä¸­æ‰€æœ‰æ•°éƒ½è¦åˆ é™¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 int a[] = {1,2,3,4,6,2,4,5,6,2}; int x,tï¼Œj=0; scanf(\u0026#34;%d\u0026#34;,\u0026amp;x); // é¦–å…ˆå¯¹åˆ é™¤çš„æ•°æ®è¿›è¡Œè®¡æ•°ï¼Œåˆ é™¤èµ°åˆ°æœ€åï¼Œä¿è¯æŒ‡å®šçš„ valve å…¨éƒ¨åˆ é™¤ for(int i=0; i\u0026lt;10; ){ if(x==a[i]){ t = i; for(int i=t; i\u0026lt;10-j; i++){ a[i] = a[i+1]; j++; } if(a[i]!=x) i++; } } for(int i=0; i\u0026lt;10-j; i++){ printf(\u0026#34;%d \u0026#34;,a[i]); } printf(\u0026#34;\\n\u0026#34;); æ•°ç»„åˆå¹¶ï¼Œabåˆå¹¶åˆ°c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 #include \u0026lt;stdio.h\u0026gt; #define arrayLen 8 void print(int a[], int size) { for (int i = 0; i \u0026lt; size; i++) { printf(\u0026#34;%d \u0026#34;, a[i]); } printf(\u0026#34;\\n\u0026#34;); } void merge(const int a[], const int b[], int c[], int size) { int i = 0, j = 0; int k = 0; while (i \u0026lt; 4 \u0026amp;\u0026amp; j \u0026lt; 4) { if (a[i] \u0026lt;= b[j]) { c[k] = a[i]; i++; } else { c[k] = b[j]; j++; } k++; } for (int n = i; n \u0026lt; 4; n++) { c[k] = a[n]; k++; } for (int n = j; n \u0026lt; 4; n++) { c[k] = b[n]; k++; } } int main(int argc, char const* argv[]) { const int a[] = {12, 40, 98, 100}; const int b[] = {25, 79, 86, 300}; // 12,25,40,79,86,98,100,300 int c[arrayLen]; // ä¸¤ä¸ªæ•°ç»„æ— åºæ—¶ï¼Œå…ˆåˆå¹¶åœ¨æ’åº // ä¸¤ä¸ªæ•°æ®æœ‰åºæ—¶ï¼Œä¸€ä¸€æ¯”è¾ƒ merge(a, b, c, arrayLen); print(c, arrayLen); return 0; } æ³¨ï¼š\nç¼–è¯‘å™¨ä¸æ£€æŸ¥ä¸‹æ ‡æ˜¯å¦è¶Šç•Œï¼› æ•°ç»„ä¼ é€’ç»™å‡½æ•°ï¼Œä¸å¸¦æ–¹æ‹¬å·çš„æ•°ç»„åå³å¯ï¼› ","date":"2018-08-17T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E4%B8%83%E8%AF%BE-%E6%95%B0%E7%BB%84/","title":"ç¬¬ä¸ƒè¯¾ æ•°ç»„"},{"content":"å¾ªç¯ while è¯­å¥ å¾ªç¯ä¸‰è¦ç´ ï¼šèµ·ç‚¹ï¼Œç»ˆç‚¹ï¼Œæ•°æ®å˜åŒ–è§„å¾‹\nfor ä¸ while çš„åŒºåˆ«ï¼šä» structure æ¥è¯´ï¼Œfor æ¯”è¾ƒä¸¥è°¨ï¼Œwhile æ¯”è¾ƒè‡ªç”±\nwhile è¯­å¥ä½¿ç”¨æ ¼å¼\n1 2 3 4 5 6 7 è¡¨è¾¾å¼1ï¼› while (è¡¨è¾¾å¼2) { sentenceï¼› ... è¡¨è¾¾å¼3ï¼› } break or continue breakï¼šç›´æ¥è·³å‡ºå¾ªç¯ï¼Œä»»æ„ä½ç½®æ‰§è¡Œå³ç›´æ¥è·³å‡ºå¾ªç¯ï¼Œæ— è§†åé¢çš„è¯­å¥\ncontinueï¼šç»“æŸå½“æ¬¡å¾ªç¯\n1 2 3 4 5 6 7 8 9 // æ±‚ 1-10 å¥‡æ•° int sum=0; for (int i=1; i\u0026lt;=10; i++) { if(i%2) continue; // å¦‚æœæ˜¯å¶æ•°å°±è·³å‡ºæœ¬æ¬¡å¾ªç¯ sum+=i; // å¦åˆ™å°±ç›¸åŠ æ±‚å’Œ } printf(\u0026#34;%d\u0026#34;,sum); do\u0026hellip;while 1 2 3 4 do{ sentence; ... }while(è¡¨è¾¾å¼1); // first carry out ååˆ¤æ–­ è¯¥è¯­å¥è‡³å°‘è¦è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œ while è¯­å¥å¯èƒ½ä¸€æ¬¡éƒ½ä¸ä¼šæ‰§è¡Œ\nå¾ªç¯åµŒå¥— 1 2 3 4 5 6 7 8 9 // format for (è¡¨è¾¾å¼1ï¼›2ï¼›3){ sentence; ... for (è¡¨è¾¾å¼1ï¼›2ï¼›3){ sentence; ... } } ä¾‹é¢˜ æ–æ³¢é‚£å¥‘æ•°åˆ—çš„å‰ 20 é¡¹ï¼ˆa1=1; a2=1; an=an-1+an-2,n\u0026gt;=3ï¼‰ï¼Œæ¯è¡Œä»…ä»…æ‰“å° 5 ä¸ª â€‹ if ï¼ˆi%5==0ï¼‰printf('\\n');\næ±‚ä¸¤ä¸ªæ•°æœ€å¤§å…¬çº¦æ•°/æœ€å°å…¬å€æ•°\næœ€å¤§å…¬çº¦æ•°ï¼šèƒ½åŒæ—¶æ•´é™¤è¿™ä¸¤ä¸ªæ•°çš„æœ€å¤§æ•° 25 15 â€”â€” 5\næ±‚è§£æ–¹æ³•ï¼šè¾—è½¬ç›¸é™¤\n1 2 3 4 28 % 6 = 4 != 0 6 % 4 = 2 != 0 4 % 2 = 0 // æ­¤æ—¶ 2 çš„å€¼å°±æ˜¯æœ€å¤§å…¬çº¦æ•° 1 2 3 4 5 6 7 8 9 10 int m,n,r; int a=m,b=n; scanf(\u0026#34;%d%*c%d\u0026#34;,\u0026amp;m,\u0026amp;n); while(m%n!=0) { r = m%n; m = n; n = r; } printf(\u0026#34;æœ€å¤§å…¬çº¦æ•°=%dï¼Œæœ€å°å…¬å€æ•°=%d\u0026#34;,nï¼Œa*b/n); æœ€å°å…¬å€æ•°ï¼šä¸¤ä¸ªæ•°çš„ä¹˜ç§¯é™¤ä»¥æœ€å¤§å…¬çº¦æ•°\n1 2 3 4 // 8å’Œ6 ï¼Œæœ€å¤§å…¬çº¦æ•° 2 6*8/2 =48/2 =24 ä¸å®šæ¬¡æ•°çš„è¾“å…¥ğŸ®ï¼Œä»é”®ç›˜è¾“å…¥ï¼Œä»¥ 0 ç»“æŸï¼Œask input of valve\n1 2 3 4 5 6 7 8 9 10 11 int n,a,i=1; float aver; scanf(\u0026#34;%d\u0026#34;,\u0026amp;a); aver = a; while(n!=0) { scanf(\u0026#34;%d\u0026#34;,\u0026amp;n); aver += n; i++; printf(\u0026#34;%f\u0026#34;,aver/i); // æ³¨æ„è¿™é‡Œä¼¼ä¹åœ¨è¾“å…¥ç»“æŸåæ‰ä¼šæ‰“å°ï¼Ÿ } ä»é”®ç›˜è¾“å…¥å­—ç¬¦ä»¥å›è½¦é”®ç»“æŸï¼Œç»Ÿè®¡æ•°å­—ç¬¦å·çš„ä¸ªæ•°\n1 2 3 4 5 6 7 char n, int i=0; while((n=getchar())!=\u0026#39;\\n\u0026#39;) { if(n\u0026gt;=48 \u0026amp;\u0026amp; n\u0026lt;=57) i++; } printf(\u0026#34;%d\u0026#34;,i); ä»é”®ç›˜è¾“å…¥ n æ±‚ 1ï¼+2ï¼+3ï¼+4ï¼\u0026hellip;+n!\n1 2 3 4 5 6 7 8 9 10 11 int n,sum; int b; scanf(\u0026#34;%d\u0026#34;,\u0026amp;n); for (int i=1; i\u0026lt;=n; i++){ b = 1; for (int j=1; j\u0026lt;=i; j++){ b *= j; } sum += b; } printf(\u0026#34;%d\u0026#34;,sum); è¾“å‡º 1-1000 ä¹‹é—´å®Œæ•°ï¼Œæ‰€æœ‰å› å­çš„å’Œï¼ˆä¸åŒ…æ‹¬è‡ªèº«ï¼‰ç­‰äºè¯¥æ•°\n1 2 3 4 5 6 7 for (int i=1; i\u0026lt;1000; i++){ // åˆ¤æ–­æœ‰æ•ˆèŒƒå›´å†…æ•° sum = 0; // å› å­ä¹‹å’Œ for (int j=1; i\u0026lt;i; j++){ // æ±‚å› å­ if (i%j==0) sum+=j; } if(sum==i) printf(\u0026#34;%d\u0026#34;,i); } è¾“å‡º 50-100 ä¹‹é—´çš„ç´ æ•°ï¼Œå³åªèƒ½è¢«1ä¸ªè‡ªèº«æ•´é™¤\n1 2 3 4 5 6 7 8 9 10 for(int i=50; i\u0026lt;=100; i++){ int f = 0; // è®¾ç½®æœºå…³ for(int j=2;j\u0026lt;i; j++){ // sqrt(1) | i/2 | i-1 if(i%j==0){ f++; break; } } if(f==0) printf(\u0026#34;%d \u0026#34;,i); } ä»é”®ç›˜è¾“å…¥ m,kï¼Œè¾“å‡ºæ¯” m å¤§ï¼Œä½†æ˜¯æœ€é è¿‘ m çš„ k ä¸ªç´ æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 int m,k; printf(\u0026#34;input m,k:\u0026#34;); scanf(\u0026#34;%d%*c%d\u0026#34;,\u0026amp;m,\u0026amp;k); // è®¾ç½®èŒƒå›´ for (int i=m+1,j=1; j\u0026lt;=k; i++) { int f = 0; // æ— è®ºåœ¨å“ªä¸ªä½ç½®è¢«å¿˜è®°åˆå§‹åŒ– for (int n=2; n\u0026lt;i; n++) { if (i%n==0){ f++; break; } } if(f==1){ printf(\u0026#34;%d \u0026#34;,i); j++;vuvuvu } printf(\u0026#34;\\n\u0026#34;); } ä»é”®ç›˜è¾“å…¥ä¸€ä¸ªæ•´æ•°ï¼Œæ±‚è¿™ä¸ªæ•´æ•°çš„å„ä½ä¹‹å’Œï¼Œè®¡ç®—è¿™ä¸ªæ•´æ•°çš„ä½æ•°\n1 2 3 4 5 6 7 8 9 10 11 int number; scanf(\u0026#34;%d\u0026#34;,\u0026amp;number); int i=0; // è®¡æ•°ï¼Œæ˜¯å¤šå°‘ä½ int sum=0; // å„ä¸ªä½æ•°æ±‚å’Œ while(number!=0) { i++; sum += number%10; number /= 10; } printf(\u0026#34;%d-%d\u0026#34;,sum,i); å›¾å½¢è¾“å‡ºï¼ˆè¡Œ/åˆ—ï¼‰ï¼Œå¤–å¾ªç¯æ§åˆ¶è¡Œï¼Œå†…å¾ªç¯æ§åˆ¶åˆ—\n1 2 3 4 5 6 7 int i,j; for (i=1; i\u0026lt;=7; i++){ for (j=1; j\u0026lt;i+1; j++){ printf(\u0026#34;*\u0026#34;); } printf(\u0026#34;\\n\u0026#34;); } 1 2 3 4 5 6 7 8 9 10 11 // æ‰“å°ä¸‰è§’å½¢ int i,j; for (i=1; i\u0026lt;=6; i++){ for (j=5; j\u0026gt;=i; j--){ // for (j=1; j\u0026lt;=6-i; j++) printf(\u0026#34; \u0026#34;); } for (int k=1; k\u0026lt;=2*i-1; k++){ printf(\u0026#34;*\u0026#34;); } printf(\u0026#34;\\n\u0026#34;); } 1 2 3 4 5 6 7 8 9 10 11 12 13 // æ‰“å°è±å½¢ #include \u0026lt;math.h\u0026gt; int i,j,k; for (i=-4; i\u0026lt;=4; i++){ for (j=1; j\u0026lt;=abs(i); j++){ printf(\u0026#34; \u0026#34;); } for (k=1; k\u0026lt;=9-2*abs(i); k++){ printf(\u0026#34;*\u0026#34;); } printf(\u0026#34;\\n\u0026#34;); } ","date":"2018-08-16T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%85%AD%E8%AF%BE-%E5%BE%AA%E7%8E%AF/","title":"ç¬¬å…­è¯¾ å¾ªç¯"},{"content":"Switch if åµŒå¥—å¾ªç¯ formatï¼š\n1 2 3 4 5 6 if (æ¡ä»¶1) sentence; else if (æ¡ä»¶2) sentence; else sentence; ä»æ¡ä»¶è¡¨è¾¾å¼ 1 å¼€å§‹åˆ¤æ–­ï¼Œè‹¥æˆç«‹åˆ™æ‰§è¡Œåé¢çš„è¯­å¥ï¼Œè‹¥æ¡ä»¶ä¸æˆç«‹åˆ™ç»§ç»­åˆ¤æ–­ï¼Œç›´åˆ°é‡åˆ°æ¡ä»¶æˆç«‹çš„æ‰æ‰§è¡Œã€‚\nswitch switch è¯­å¥å’Œ if åµŒå¥—è¯­å¥æ˜¯ä¸åŒçš„ï¼›\nx \u0026gt; 10ï¼› x \u0026gt; 100; åœ¨ if ä¸‹çš„æƒ…å†µæœ‰å¤šä¸ª value æ»¡è¶³æ¡ä»¶ x = 10; x = 100; æ¯ç§æƒ…å†µéƒ½åªæœ‰ one valueï¼Œä¸”è¯¥å€¼å›ºå®š ç‰¹ç‚¹ï¼šClear structure\nformatï¼š\n1 2 3 4 5 6 7 8 9 10 switch (object) { case constant1: sentence; break; case constant2: sentence; break; // â€¦â€¦ defaultï¼š sentence; } object with constant åšæ¯”è¾ƒï¼Œå½“ä¸¤è€…ç›¸ç­‰æ—¶æ‰§è¡Œï¼Œè‹¥æ‰€æœ‰ constant çš†ä¸ç­‰äº objectï¼Œå³æ‰§è¡Œ defaultï¼›\nbreak ç»“æŸå½“å‰ä»»åŠ¡ï¼Œcontinue ç»“æŸæœ¬è½®ä»»åŠ¡ã€‚\ndefault å¯ä»¥åœ¨ä»»æ„ä½ç½®ï¼ç›¸å½“äºä¸€ä¸ª case æ¥æ‰§è¡Œï¼Œä¸è¿‡è¯¥ case çš„æ¡ä»¶æ˜¯ä¸åŒ¹é…å½“å‰æ‰€æœ‰ constantï¼›\nä¾‹é¢˜ è¾“å…¥å¹´æœˆæ—¥ï¼Œåˆ¤æ–­è¯¥æ—¥æœŸå±äºå¹´å†…çš„ç¬¬ nå¤© è¾“å…¥å¹´æœˆï¼Œåˆ¤æ–­è¯¥æœˆä»½æœ‰å¤šå°‘å¤© è¾“å…¥ä¸€ä¸ªæ•°ï¼Œåˆ¤æ–­èƒ½å¦è¢« n æ•´é™¤ï¼Œèƒ½å°±è¾“å…¥nï¼ˆ3ï¼Œ5ï¼Œ7ï¼‰ï¼Œéƒ½ä¸èƒ½å°±è¾“å‡º 0 åˆ¤æ–­è¾“å…¥çš„ç¬¦å·æ˜¯ä»€ä¹ˆç±»å‹ï¼šå¤§å†™ï¼Œå°å†™ï¼Œæ•°å­—ï¼Œç©ºæ ¼ è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹ ç®€å•è®¡ç®—å™¨ï¼šåŠ å‡ä¹˜é™¤ è¡¥å……ï¼š\nprintf åªä¼šçœ‹åŒç²¾åº¦ï¼Œfloat å‹ä¼šè¢«æå‡ä¸º doubleï¼Œscanf æ²¡æœ‰ç±»å‹æå‡ï¼›%lf åœ¨ printf ä¸‹æ˜¯æœªå®šä¹‰çš„ï¼Œè¦ç¡®ä¿å¯ç§»æ¤æ€§ï¼Œå°±è¦åšæŒä½¿ç”¨ %fï¼›\nåœ¨è¿è¡Œæ—¶ç¡®å®šå®½åº¦ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹ä»£ç \n1 printf(\u0026#34;%*d\u0026#34;,weight,x); // ä¸­é—´çš„æ˜Ÿå·è¡¨ç¤ºï¼Œåœ¨å‚æ•°åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªintå‚æ•°ä½œä¸ºå®½åº¦ å½“å‘ scanf ä¼ å…¥æ•°ç»„æ—¶ï¼Œä¸éœ€è¦ä½¿ç”¨å–å€ç¬¦å·\nscanf ä½¿ç”¨ %d ç­‰æ•°å€¼æ ¼å¼ç¬¦æ—¶ï¼Œä¸ä¼šè¯»å–æ¢è¡Œï¼Œè€Œ gets æœ¬èº«ä½œä¸ºè¯»å…¥å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œå´ä¼šå°†æ¢è¡Œè¯»å…¥ã€‚æ•…ï¼šscanf å’Œ gets è¦ä¹ˆäºŒé€‰ä¸€ï¼Œè¦ä¹ˆå¹²è„†ä¸ç”¨\nscanf ä¼šå°†æœªåŒ¹é…çš„å­—ç¬¦ç•™åœ¨è¾“å…¥æµä¸­\nåœ¨ scanf ä¸­ï¼Œè‹¥æƒ³ä»»æ„åˆ†éš”ç¬¦\n1 scanf(\u0026#34;%d%*c%d\u0026#34;,\u0026amp;a,\u0026amp;b); scanf ä½¿ç”¨ %c æ ¼å¼ç¬¦è¯»å…¥å­—ç¬¦æ—¶ï¼Œç©ºæ ¼å­—ç¬¦å’Œè½¬ä¹‰å­—ç¬¦ï¼ˆåŒ…æ‹¬å›è½¦ï¼‰éƒ½ä¼šè¢«æœ‰æ•ˆå­—ç¬¦è¯»å…¥\nå¯¹äºä¸Šä¸€æ¡ï¼Œscanf å‡½æ•° %c å­˜åœ¨çš„é—®é¢˜ï¼å¯ä½¿ç”¨ getchar() å°†æ— æ•ˆå­—ç¬¦è¯»èµ°ï¼Œä»¥å…è¢«åé¢çš„å­—ç¬¦å‹å˜é‡è¯¯è¯»ã€‚\nscanf æ²¡æœ‰ç²¾åº¦ä¿®é¥°è¯ï¼Œå³ scanf() ä¸èƒ½è§„å®šç²¾åº¦\nEPS ï¼Œè‹¥è¦åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦ä¸º0ï¼Œå°±çœ‹ è¯¥æ•°çš„ç»å¯¹å€¼æ˜¯ä¸æ˜¯\u0026lt;= EPS\nåœ¨ if/while çš„æ¡ä»¶è¡¨è¾¾å¼é‡Œï¼Œn%2!=0 ç­‰ä»·äº n%2\n","date":"2018-08-14T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E4%BA%94%E8%AF%BE-switch/","title":"ç¬¬äº”è¯¾ switch"},{"content":"è¾“å‡ºæ§åˆ¶ å¤åˆè¿ç®—ç¬¦ åœ¨èµ‹å€¼æ—¶å·¦å³ä¸¤ä¾§æœ‰åŒä¸€ä¸ªå˜é‡ï¼Œå¯è¿›è¡Œç¬¦åˆè¡¨ç¤ºã€‚\n1 2 3 4 x += 3; // x += 3; a += b; // æ—¢ a = a + (b); å³ä¾§è§†ä¸ºä¸€ä¸ªæ•´ä½“ï¼ŒåŒæ—¶ï¼Œå¤åˆè¿ç®—ç¬¦ä¼˜å…ˆçº§è¾ƒä½ã€‚ a += a -= a * a; // a += a -= 9; a += -6; a = -12 a += a -= a *= a; // a += a -=9; a += 0; a = 0; Go\nä¸æ”¯æŒè¿™æ ·å¤æ‚çš„ç¬¦åˆè¿ç®—ï¼Œç®€æ´é«˜æ•ˆæ¸…æ™°ã€‚\nä¸åŒè¿›åˆ¶çš„è¡¨è¾¾æ–¹å¼ å¸¸è§„æ•°æ®ä»¥åè¿›åˆ¶è¡¨ç¤ºï¼Œå•æ•°æœ‰ 8ã€16 è¿›åˆ¶çš„è¡¨ç¤ºï¼Œæ²¡æœ‰äºŒè¿›åˆ¶çš„è¡¨ç¤ºï¼\næ§åˆ¶ç¬¦ è¡¨ç¤ºæ–¹æ³• å…«è¿›åˆ¶ %o 023 åå…­è¿›åˆ¶ %x 0x7A è¾“å…¥è¾“å‡ºæ§åˆ¶ç¬¦ 1 æ•´å‹\n%md mæ˜¯æ§åˆ¶è¾“å…¥è¾“å‡ºä½æ•° m\u0026gt;å®é™…ä½æ•°ï¼Œå‰è¡¥ç©ºæ ¼ %-md â€˜-â€™ç¬¦å·è¡¨ç¤ºå·¦å¯¹é½ m\u0026lt;å®é™…ä½æ•°ï¼Œæ— æ•ˆè¾“å‡º 1 scanf(\u0026#34;%2d%3d\u0026#34;,\u0026amp;x,\u0026amp;y); // 1234567 â†’ x=12, y=345 2 æµ®ç‚¹æ•°\n%.nf nè¡¨ç¤ºä¿ç•™å°æ•°ä½æ•° %m.nf mè¡¨ç¤ºæ€»ä½æ•°ï¼Œå°æ•°ç‚¹ç®—ä¸€ä½ m\u0026lt;å®é™…ä½æ•°ï¼Œmçš„æ§åˆ¶æ— æ•ˆ\næ•´æ•°æˆªæ–­ï¼Œæµ®ç‚¹æ•°å››èˆäº”å…¥\nç»“æ„ç¨‹åºè®¾è®¡ c program æ˜¯å…¸å‹çš„ç»“æ„åŒ–ç¨‹åºè®¾è®¡ï¼Œé¢å‘è¿‡ç¨‹ã€‚\næœ‰ä¸‰å¤§ç»“æ„ï¼šé¡ºåºç»“æ„ï¼Œé€‰æ‹©ç»“æ„ï¼Œå¾ªç¯ç»“æ„\né¡ºåºç»“æ„ï¼Œè‡ªé¡¶å‘ä¸‹ï¼Œé€ä¸€æ‰§è¡Œç¨‹åºä¸­çš„æ¯ä¸ªè¯­å¥ï¼› é€‰æ‹©ç»“æ„ï¼Œå°±æ˜¯ç»™ç¨‹åºä¸­çš„æŸäº›è¯­å¥è®¾ç½®æ‰§è¡Œæ¡ä»¶ï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶æ‰§è¡Œï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è·³è¿‡ï¼› å¾ªç¯ç»“æ„ï¼Œå¯¹ç¨‹åºä¸­çš„è¯­å¥å¤šæ¬¡çš„é‡å¤æ‰§è¡Œï¼› é€‰æ‹©ç»“æ„ä¹‹ if è¯­å¥ if ï¼ˆè¡¨è¾¾å¼ï¼‰ï¼Œå½“æ¡ä»¶è¡¨è¾¾å¼çš„å€¼æ˜¯é 0ï¼Œåˆ™æ¡ä»¶æˆç«‹ï¼Œæ‰§è¡Œæ‹¬å·å†…å®¹ï¼›è‹¥ if åªæœ‰ä¸€æ¡è¯­å¥ï¼Œå¤§æ‹¬å·å¯çœç•¥ã€‚\nif â€¦â€¦ else â€¦â€¦ ï¼ˆè¯­å¥å®ç°æ˜¯ä¸¤ç§æƒ…å†µçš„é€‰æ‹©ï¼‰\né€‰æ‹©å¯¹è±¡ä¸­åªæœ‰ä¸¤ç§å¯èƒ½ï¼Œæˆ‘ä»¬é€‰æ‹©å…¶ä¸­ä¸¤ç§å¯èƒ½ï¼ˆéæ­¤å³å½¼ï¼‰\neg ï¼š è¾“å…¥ç¬¬ä¸‰è¾¹ï¼Œæ±‚æ˜¯å¦æ˜¯ä¸‰è§’å½¢ï¼Œè‹¥æ˜¯æ±‚é¢ç§¯\né¢ç§¯å…¬å¼ï¼š\nâ€‹ l = ï¼ˆa+b+cï¼‰/2\nâ€‹ s = sqrtï¼ˆlï¼ˆl-aï¼‰ï¼ˆl-bï¼‰ï¼ˆl-cï¼‰ï¼‰\nâ€‹ ä¸‰è§’å½¢å®šä¹‰ï¼šä»»æ„ä¸¤è¾¹å¤§äºç¬¬ä¸‰è¾¹\nè¡¥å……ï¼š\n1 å®å®šä¹‰çš„å­—ç¬¦ä¸²åä¸€èˆ¬ä¸ä»¥åˆ†å·ç»“å°¾ï¼Œå› ä¸ºå®å®šä¹‰ä¸æ˜¯ c è¯­å¥ï¼›\n2 å®å¸¸é‡æ²¡æœ‰æ•°æ®ç±»å‹ï¼Œåªè¿›è¡Œç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼›\n3 const å¸¸é‡åªèƒ½åœ¨å®šä¹‰æ—¶èµ‹äºˆåˆå€¼ï¼›\n4 åœ¨ä¸€ä¸ªèµ‹å€¼è¯­å¥ä¸­ï¼Œè‹¥å·¦å³ç±»å‹ä¸ä¸€è‡´ï¼Œåˆ™èµ‹å€¼æ—¶å³è¾¹è¡¨è¾¾å¼å°†è¿›è¡Œè‡ªåŠ¨ç±»å‹è½¬æ¢\n5 åŒå¼•å·æ‰©èµ·æ¥çš„å†…å®¹ä¸ä¼šå‘ç”Ÿå®æ›¿æ¢\n","date":"2018-08-11T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E5%9B%9B%E8%AF%BE-%E8%BE%93%E5%87%BA%E6%8E%A7%E5%88%B6/","title":"ç¬¬å››è¯¾ è¾“å‡ºæ§åˆ¶"},{"content":"è¿ç®—ç¬¦ åŸºæœ¬è¿ç®—ç¬¦ æ‰€æœ‰æ•°æ®çš„å¤„ç†ï¼Œé€šè¿‡è¿ç®—ç¬¦æ¥å®ç°ï¼›\nä¸¤ä¸ªæ•´å‹åœ¨ä¸€èµ·è¿ç®—ç»“æœè¿˜æ˜¯æ•´å‹ï¼›å¦‚æœæœ‰å°æ•°å‚åŠ è¿ç®—çš„ï¼Œè¿ç®—ç»“æœæ˜¯åŒç²¾åº¦å°æ•°ï¼ˆdoubleï¼‰\n1 2 3 3/2 : 1 ï¼ˆèˆå»å°æ•°éƒ¨åˆ†ï¼‰ 3.0/2 : 1.500000ï¼ˆdoubleï¼‰ Go\næ•´å‹è¿ç®—è¿˜æ˜¯æ•´å‹\næ•´å‹å’Œæµ®ç‚¹å‹è¿ç®—ï¼Œéœ€è¦åšç±»å‹è½¬æ¢\n%ï¼šå–ä½™æ ¼å¼ï¼ša%bï¼Œa and b å¿…é¡»ä¸ºæ•´æ•°ï¼\n23 % 6 = 3â€¦â€¦5 6 % 23 = 0â€¦â€¦6 -23 % 6 = 3â€¦â€¦-5 23 % -6 = -3â€¦â€¦5\nå–ä½™çš„ç»“æœä¸€å®šè¦ä¸è¢«å–ä½™çš„æ•°ç¬¦å·ä¿æŒä¸€è‡´ã€‚\n1 2 3 4 5 int x,y; scanf(\u0026#34;%d,%d\u0026#34;,\u0026amp;a,\u0026amp;b); // x % y : 0 xèƒ½è¢«yæ•´é™¤ // x % 2 : 0 xæ˜¯å¶æ•° // x % 2 : 1 xæ˜¯å¥‡æ•° ä»»ä½•å‚æ•°å¯¹ 10 å–ä½™ï¼Œå¾—åˆ°çš„éƒ½æ˜¯ä¸ªä½\nä¾‹é¢˜: ä»é”®ç›˜è¾“å…¥ä¸€ä¸ªä¸‰ä½æ•°çš„æ•´æ•°ï¼Œäº¤æ¢ç™¾ä½å’Œåä½ï¼Œç„¶åè¾“å‡º\n1 2 3 4 int x = 142 x/100 = 1 // è·å–ç™¾ä½ x/10%10 = 4 // è·å–åä½ 142%10 // è·å–ä¸ªä½ è‡ªåŠ è‡ªå‡ 1 ++nï¼› n++ï¼›\nç¬¦å·æ— è®ºåœ¨å˜é‡çš„å“ªä¸€ä¾§ï¼Œéƒ½æ˜¯å®ç°è‡ªèº« +1ï¼›++ åªèƒ½å¯¹å˜é‡è¿›è¡Œè¿ç®—\n1 2 (x+y)++ï¼› // é”™è¯¯ 7++ï¼› // é”™è¯¯ 2 (++n) and (n++) çš„åŒºåˆ«\n1 2 3 4 5 6 int x = 9,y; // åˆ†åˆ«æ‰§è¡Œä»¥ä¸‹è¯­å¥ y = x++; // x=10,y=9 y = ++x; // x=10,y=10 y = ++x + ++x; // x=11,y=22 y = x-- + x--; // x=7,y=18 åœ¨è¿ç®—å¼ä¸­å¦‚æœ ++ åœ¨å˜é‡çš„å‰é¢ï¼Œå…ˆåšè‡ªèº« +1ï¼Œ ç„¶åå†åšå…¶å®ƒè¿ç®—ï¼›\nå¦‚æœ ++ åœ¨å˜é‡çš„åé¢ï¼Œå…ˆåšè¿ç®—åè‡ªèº« +1ï¼›\nGo\nä»…æ”¯æŒ i++ï¼Œé¿å…æ­§ä¹‰ã€‚\næ¡ä»¶è¿ç®—ç¬¦ ï¼Ÿï¼š c program å”¯ä¸€çš„ä¸€ä¸ªä¸‰ç›®è¿ç®—ç¬¦\nè¿ç®—æ ¼å¼ è¡¨è¾¾å¼1ï¼Ÿ è¡¨è¾¾å¼2 ï¼šè¡¨è¾¾å¼3ï¼›\nè¡¨è¾¾å¼1çš„å€¼ï¼Œå¦‚æœå®ƒçš„å€¼æ˜¯é0ï¼ˆæ¡ä»¶æˆç«‹ï¼‰ï¼Œé‚£ä¹ˆè¿ç®—ç»“æœå°±æ˜¯è¡¨è¾¾å¼2çš„å€¼ï¼›\nå¦‚æœè¡¨è¾¾å¼1çš„å€¼ä¸º0ï¼ˆæ¡ä»¶ä¸æˆç«‹ï¼‰ï¼Œè¿™æ—¶è¿ç®—ç»“æœå°±æ˜¯è¡¨è¾¾å¼3çš„å€¼ã€‚\n1 2 2\u0026lt;3? 3\u0026gt;4? 2+6 : 2-5 : 2+3 //ç¬¬ä¸€ä¸ªé—®å·å’Œæœ€åä¸€ä¸ªå†’å·å¤–åµŒå¥— 2\u0026lt;3? (3\u0026gt;4? 2+6 : 2-5) : 2+3 // -3 a \u0026gt; b? a : b; å–a/bæœ€å¤§å€¼\negï¼šä»é”®ç›˜è¾“å…¥ 4 é—¨è¯¾è€ƒè¯•æˆç»©ï¼Œæ±‚æœ€ä½åˆ†\n1 2 3 4 5 6 float a,b,c,d,mix; mix = a; mix = (mix\u0026lt;b)? mix:b; // æ³¨æ„åˆ¤æ–­å–å¤§å°å€¼çš„ç¬¦å· mix = (mix\u0026lt;c)? mix:c; mix = (mix\u0026lt;d)? mix:d; åˆ¤æ–­å¤§å°ï¼Œç”¨ ?: æ¯” if è¯­å¥ä¼˜åŠ¿\nGo\nä¸æ”¯æŒä¸‰ç›®è¿ç®—ç¬¦ï¼Œä»ä»¥ä¸Šè¯­æ³•ä¸­ä¹Ÿèƒ½çœ‹å‡ºï¼Œå¤åˆä¸‰ç›®è¿ç®—æä¸ºå¤æ‚ï¼Œéš¾è¯»ã€‚\nå…³ç³»è¿ç®—ç¬¦ ä½œç”¨ï¼šæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡ä¹‹é—´é‡çš„å¤§å°å…³ç³»\nå¸¸è§ï¼š\u0026lt; \u0026lt;= \u0026gt; \u0026gt;= == !=\næ³¨ï¼šæ–°æ‰‹å¸¸å¸¸é”™åœ¨ == å’Œ = å·ä¸Šï¼Œæ€»æ˜¯è¯¯å°†åˆ¤æ–­å†™æˆèµ‹å€¼ï¼›\nå…³ç³»è¿ç®—çš„ç»“æœï¼šTrue(1) and False(0)ï¼ˆæˆç«‹ or ä¸æˆç«‹ï¼‰\n1 2 3 4 5 int x,y=1,z=4; x = y == z; // y==z:0 x = 0 x = y = z; // y=4; x=4; x=4 èµ‹å€¼ç¬¦å· è‡ªå³å‘å·¦ x = y != z; // y!=z:1; x=1 èµ‹å€¼ç¬¦å·å·¦ä¾§åªèƒ½ä¸ºå˜é‡ï¼Œä¸èƒ½ä¸ºè¡¨è¾¾å¼\né€»è¾‘è¿ç®—ç¬¦ ï¼ˆå°å¿ƒçŸ­è·¯ï¼‰ 1 ä½œç”¨ï¼šé€»è¾‘æ¨ç†æˆ–é€»è¾‘åˆ¤æ–­æ—¶ï¼Œç”¨äºè¿æ¥æ¨ç†çš„æ¡ä»¶ã€‚\nè¿ç®—ç¬¦æœ‰ä¸‰ä¸ªï¼š\né€»è¾‘ä¸ \u0026amp;\u0026amp; è¦æ‰€æœ‰æ¡ä»¶éƒ½æˆç«‹ï¼Œæ¨ç†æ‰æˆç«‹ é€»è¾‘æˆ– || åªè¦ä¸€ä¸ªæ¡ä»¶æˆç«‹ï¼Œæ¨ç†å°±æˆç«‹ é€»è¾‘é ï¼ å–åï¼ˆ !(2\u0026gt;3) : 2\u0026lt;=3 ï¼‰ 2 \u0026amp;\u0026amp; and || (å°å¿ƒçŸ­è·¯)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 x\u0026gt;=10 \u0026amp;\u0026amp; x\u0026lt;=100; // lvalue ä¸æˆç«‹ rvalve ä¸æ‰§è¡Œ 10\u0026lt;=x\u0026lt;=100 x\u0026gt;10 || x\u0026lt;-100; // lvalue æˆç«‹åˆ™ rvalue ä¸åˆ¤æ–­ /* è¡¨è¾¾å°å†™å­—æ¯ */ char n; scanf(\u0026#34;%c\u0026#34;,\u0026amp;n); n\u0026gt;=\u0026#39;a\u0026#39; \u0026amp;\u0026amp; n\u0026lt;=\u0026#39;z\u0026#39;; /* n\u0026gt;=97 \u0026amp;\u0026amp; n\u0026lt;=122; */ (n\u0026gt;=\u0026#39;a\u0026#39; \u0026amp;\u0026amp; t\u0026lt;=\u0026#39;z\u0026#39;) || (n\u0026gt;=\u0026#39;A\u0026#39; \u0026amp;\u0026amp; n\u0026lt;=\u0026#39;Z\u0026#39;) // åˆ¤æ–­æ˜¯å¦åœ¨å­—æ¯èŒƒå›´ /* çŸ­è·¯æ±‚å€¼ä¾‹é¢˜ */ int a=2,b=3,x; x = (++a\u0026gt;=b) \u0026amp;\u0026amp; (a\u0026lt;b++) // a=3ï¼›b=4;x=0 x = (++a\u0026gt;b) \u0026amp;\u0026amp; (a\u0026lt;b++) // a=3;b=3;x=0 x = (++a\u0026gt;=b) \u0026amp;\u0026amp; (a\u0026lt;++b) // a=3;b=4;x=1 x = (++a\u0026gt;=b) || (a\u0026lt;++b) // a=3;b=3;x=1 x = (++a\u0026gt;b) || (a\u0026lt;++b) // a=3;b=4;x=1 3\té€»è¾‘çœŸ ä¸ é€»è¾‘å‡ï¼ˆå¸ƒå°”è¿ç®—ï¼‰\n4\tå°ç»“\nå¦‚æœåœ¨ a\u0026amp;\u0026amp;b è¿ç®—ä¸­ a çš„å€¼ä¸º0ï¼Œè®¡ç®—æœºå°±ä¸ä¼šå†å¤„ç† b çš„å€¼ã€‚ å¦‚æœåœ¨ a || b è¿ç®—ä¸­ï¼Œå¦‚æœ a æ¡ä»¶æˆç«‹ï¼Œè®¡ç®—æœºä¸ä¼šå†å¤„ç†b egï¼šè¡¨ç¤ºéæ•°å­—ç¬¦å·\n1 2 3 4 5 6 7 8 char x; x = getchar(); /* æ•°å­—ç¬¦å· */ x\u0026gt;=\u0026#39;0\u0026#39; \u0026amp;\u0026amp; x\u0026lt;=\u0026#39;9\u0026#39; // ç­‰åŒäº x\u0026gt;=48 \u0026amp;\u0026amp; x\u0026lt;=57 /* éæ•°å­—ç¬¦å· */ !(x\u0026gt;=\u0026#39;0\u0026#39; \u0026amp;\u0026amp; x\u0026lt;=\u0026#39;9\u0026#39;) ç±»å‹å¼ºåˆ¶è¿ç®—ç¬¦ ä¸æŒ‰ç…§è‡ªç„¶è¿ç®—è§„å¾‹è¿›è¡Œï¼ŒæŒ‰ç…§è®¾è®¡ç¨‹åºå‘˜çš„è¦æ±‚è¿›è¡Œç±»å‹è½¬æ¢ã€‚\næ ¼å¼ï¼šï¼ˆå¼ºåˆ¶ç±»å‹ï¼‰ï¼ˆå¼ºåˆ¶å¯¹è±¡ï¼‰\n1 2 3 (int)2.3+8.9 // 10.9 (int)(2.3+8.9) // 11 (int)(8.9) // é”™è¯¯ ç±»å‹å¼ºåˆ¶è½¬æ¢ç¬¦ä¸èƒ½ç”¨äºå¸¸é‡ ç±»å‹é•¿åº¦è®¡ç®—ï¼ˆå­˜å‚¨å ç”¨å­—èŠ‚ï¼‰ sizeof()\næ ¼å¼ï¼šsizeof(è¿ç®—å¼/å…·ä½“ç±»å‹/æ•°ç»„)\n1 2 sizeof(3.0/2); // = 8(double) sizeof(\u0026#39;a\u0026#39;+1); // = 4(int) char æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œå­—ç¬¦ä¸²å¤šä¸€ä¸ª\u0026rsquo;\\0\u0026rsquo;ï¼Œè·å–å…ƒç´ ä¸ªæ•°éœ€è¦é™¤ä»¥å•å­—èŠ‚ã€‚\nGo\nunsafe.Sizeof(any)\né€—å·è¿ç®—ç¬¦ æ ¼å¼ï¼šè¡¨è¾¾å¼1ï¼Œè¡¨è¾¾å¼2ï¼Œè¡¨è¾¾å¼3ï¼Œ\nä»è¡¨è¾¾å¼1å¼€å§‹è®¡ç®—ï¼Œä¸€ç›´è®¡ç®—åˆ°è¡¨è¾¾å¼ nï¼Œæœ€åæŠŠè¡¨è¾¾å¼ n ä½œä¸ºè¿ç®—ç»“æœã€‚\n1 2 x = (1,2,3); // x=3 x = (z=1, y=2, x+y); // x= x+y =3 Go\nx,y,z = 1,2,3\n","date":"2018-08-10T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E4%B8%89%E8%AF%BE-%E8%BF%90%E7%AE%97%E7%AC%A6/","title":"ç¬¬ä¸‰è¯¾ è¿ç®—ç¬¦"},{"content":"è¾“å…¥ä¸è¾“å‡º æµ®ç‚¹å‹ï¼š\nfloatï¼šé™¤éç‰¹åˆ«æŒ‡å®šï¼Œå¦åˆ™éšå«è¾“å‡º6ä½å°æ•°\nName æ§åˆ¶ç¬¦ Byte å°æ•°ç‚¹æœ‰æ•ˆä½æ•° float å•ç²¾åº¦ %f 4 7 double åŒç²¾åº¦ %lf 8 16 ç§‘å­¦è®¡æ•°æ³• 1 2 3 10000 =\u0026gt; 1e5 12300 =\u0026gt; 1.23e4 0.0034 =\u0026gt; 3.4e-3 e åé¢å¿…é¡»ä¸ºæ•´æ•°(æ­£è´Ÿ)ï¼Œä¸”å‰åå¿…é¡»æœ‰å‚æ•°ï¼›\nfloat å¯ä»¥è¡¨ç¤ºæ•´æ•°ï¼Œè‹¥å°æ•°ç‚¹å‰é¢ä¸º 0ï¼Œåˆ™ 0 å¯ä»¥å¿½ç•¥\nåœ¨ç¨‹åºä¸­ï¼Œå­—ç¬¦çš„è¡¨ç¤ºæœ‰ä¸¤ç§ï¼š\nå­—ç¬¦å¸¸é‡ï¼šè§„å®šç¬¦å·ï¼Œä¸å‡†æ”¹å˜\nName Byte æ§åˆ¶ç¬¦ char å­—ç¬¦å˜é‡ 1 %c å­—ç¬¦è¾“å…¥å¦‚æœæ²¡æœ‰éš”å¼€æ§åˆ¶ç¬¦ï¼Œåƒä¸‡ä¸è¦éš”å¼€\nè‹¥æœ‰éš”å¼€å°±ç”¨å¯¹åº”çš„ç¬¦å·éš”å¼€\nå­—ç¬¦ç±»å‹ä»…ä¸€ä¸ªï¼Œchar å‹ä»…ä»ç¼“å†²åŒºè·å–ä¸€ä¸ªå­—ç¬¦ï¼ˆåŒ…æ‹¬æ•°å­—ï¼‰\n1 2 scanf(\u0026#34;%c%c\u0026#34;,\u0026amp;a,\u0026amp;b); // input : ab Ascll ç è¡¨ é”®ç›˜çš„æ¯ä¸ªç¬¦å·éƒ½å¯¹åº”ä¸€ä¸ªæ•°å€¼ï¼Œåœ¨ c program ä¸­ï¼Œç¬¦å·å¯å‚åŠ æ•°è¿ç®—\n1 2 3 â€˜aâ€™ = 97 ~ 122 â€˜Aâ€™ = 65 ~ 90 â€˜0â€™ = 48 ~ 57 å¤§å†™å¯¹åº”å°å†™ï¼Œç›¸å·®32ï¼›å‡¡æ˜¯é”®ç›˜ç¬¦å·æœ‰åºï¼Œå¯¹åº”çš„ ascll ç  value ä¹Ÿæ˜¯æœ‰åºçš„ï¼\nå­—ç¬¦çš„è½¬ä¹‰è¡¨ç¤º ä¸ç”¨è‡ªèº«è¡¨è¾¾è‡ªèº«ï¼Œè€Œæ˜¯ç”¨å¦å¤–ä¸€ç§å½¢å¼ï¼›è½¬ä¹‰ç¬¦ï¼š\\\nä¸¤ç§å½¢å¼ï¼šå¿…é¡»è½¬ä¹‰ å’Œ 8è¿›åˆ¶ã€16è¿›åˆ¶\n1 å¿…é¡»è½¬ä¹‰\n\u0026rsquo; \\n ' æ¢è¡Œï¼ˆNewlineï¼‰ \u0026rsquo; \u0026quot; ' ä¸€ä¸ªåŒå¼•å· \u0026rsquo; \\r ' å›è½¦ï¼ˆä¸æ¢è¡Œï¼Œå›åˆ°è¡Œé¦–ï¼‰ \u0026rsquo; ' ' å•å¼•å· \u0026rsquo; \\0 ' ç©ºå­—ç¬¦ï¼Œå­—ç¬¦ä¸²ç»“æŸæ ‡å¿— \u0026rsquo; \\ ' ä¸€ä¸ªåæ–œæ  \u0026rsquo; \\b ' é€€æ ¼ï¼ˆBackspaceï¼‰ \u0026rsquo; \\ddd ' 1 åˆ° 3 ä½å…«è¿›åˆ¶ ascll ç  \u0026rsquo; \\f ' èµ°çº¸æ¢é¡µï¼ˆForm Feedï¼‰ \u0026rsquo; \\xhh ' 1 åˆ° 2 ä½åå…­è¿›åˆ¶ asc \u0026rsquo; \\t ' åˆ¶è¡¨ç¬¦ï¼ˆæ°´å¹³ï¼‰ \u0026rsquo; \\v ' åˆ¶è¡¨ç¬¦ï¼ˆå‚ç›´ï¼‰ 2 è¿›åˆ¶è½¬ä¹‰\nåè¿›åˆ¶è½¬æ¢ä¸º N è¿›åˆ¶ï¼ˆ2ï¼Œ8ï¼Œ16ï¼‰ï¼Œé‡‡ç”¨çš„æ–¹æ³•å°±æ˜¯ é™¤Nå–ä½™\n1 e = (d)\u0026#39;101\u0026#39; = (o)\u0026#39;\\145\u0026#39; = (h)\u0026#39;\\7A\u0026#39; ä»¥ä¸‹è¡¨è¾¾å¼ç›¸ç­‰\n1 2 3 4 5 printf(\u0026#34;%c\u0026#34;,e); printf(\u0026#34;%c\u0026#34;,\u0026#39;/145\u0026#39;); printf(\u0026#34;%c\u0026#34;,\u0026#39;/x7A\u0026#39;); printf(\u0026#34;%c\u0026#34;,0145); printf(\u0026#34;%c\u0026#34;,0x7A); å›› ç³»ç»Ÿçš„ä¸¤ä¸ªä¸“é—¨ç”¨äºå­—ç¬¦è¾“å…¥/è¾“å‡º\n1\tgetchar()\nä»…ä»…è·å–ä¸€ä¸ªå­—ç¬¦ï¼Œå›è½¦è¡¨ç¤ºè¾“å…¥ç»“æŸï¼›\nâš ï¸ è¯¥å‡½æ•°æ²¡æœ‰å‚æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼å°±æ˜¯ä»ç»ˆç«¯é”®ç›˜è¯»å…¥çš„å­—ç¬¦\n1 2 char n; n = getchar(); // scanf(\u0026#34;%c\u0026#34;,\u0026amp;n); 2\tputchar()\nè¯¥å‡½æ•°çš„å‚æ•°å°±æ˜¯å¾…è¾“å‡ºçš„å­—ç¬¦ï¼Œä»…ä»…è¾“å‡ºä¸€ä¸ªå­—ç¬¦\n1 putchar(n); // äº¦å¯è¾“å‡ºå¸¸é‡ï¼Œä¸ä¼šè‡ªåŠ¨æ¢è¡Œ è¡¥å……ï¼š\næ•´æ•°ä¸æµ®ç‚¹å®æ•°è¿ç®—æ—¶ï¼Œå…¶ä¸­çš„æ•´æ•°æ“ä½œæ•°åœ¨è¿ç®—ä¹‹å‰è¢«è‡ªåŠ¨è½¬æ¢ä¸ºäº†æµ®ç‚¹æ•°ï¼ˆfloatï¼‰ ä¸¤ä¸ªæ•´æ•°ç›¸é™¤åçš„å•†ä»æ˜¯æ•´æ•°ï¼ˆintï¼‰ ä½™æ•°çš„ç¬¦å·ä¸è¢«é™¤æ•°çš„ç¬¦å·ç›¸åŒï¼ˆ(-10) / 3 = 3\u0026hellip;..(-1)ï¼‰ æ±‚ä½™è¿ç®—é™å®šå‚ä¸è¿ç®—çš„ä¸¤ä¸ªæ“ä½œæ•°éƒ½æ˜¯æ•´æ•°ï¼ï¼ˆint % intï¼‰ ","date":"2018-08-09T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E4%BA%8C%E8%AF%BE-%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BA/","title":"ç¬¬äºŒè¯¾ è¾“å…¥ä¸è¾“å‡º"},{"content":"ç¬¬ä¸€è¯¾ è®¤è¯† C è¯­è¨€ äº†è§£ç¨‹åºè¯­è¨€ ä¸‰ä¸ªå‘å±•é˜¶æ®µï¼š\næœºå™¨è¯­è¨€ï¼ˆäºŒè¿›åˆ¶ Binaryï¼‰ æ±‡ç¼–è¯­è¨€ï¼ˆç¬¦å·åŒ–è¯­è¨€ï¼‰ é«˜çº§è¯­è¨€ï¼ˆæ•°å­¦+è‹±è¯­æ„æˆï¼‰ é™¤äº†æœºå™¨è¯­è¨€å’Œæ±‡ç¼–è¯­è¨€å¤–ï¼Œå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½è¢«ç»Ÿç§°ä¸ºé«˜çº§è¯­è¨€ã€‚\né«˜çº§è¯­è¨€åˆ†ä¸º é¢å‘è¿‡ç¨‹ï¼ˆç»“æ„åŒ–ç¨‹åºè®¾è®¡ï¼‰ å’Œ é¢å‘å¯¹è±¡ï¼ŒC Program å±äºç»“æ„åŒ–è¯­è¨€ï¼›\nç»“æ„åŒ–æœ‰ä¸‰ç§ï¼šé¡ºåºç»“æ„ã€é€‰æ‹©ç»“æ„ã€å¾ªç¯ç»“æ„ï¼›\nç¼–ç¨‹æµç¨‹ï¼šéœ€æ±‚åˆ†æ â†’ è®¾è®¡ â†’ ç¼–å†™ç¨‹åº â†’ è°ƒè¯•ç¨‹åº â†’ ç»´æŠ¤\nC Program æ¡†æ¶ 1 main() //ä»»ä½• c å¿…é¡»æœ‰ä¸»å‡½æ•°ä¸”å”¯ä¸€ä¸»å‡½æ•°ï¼› è¯­å¥ç»“æŸï¼šä»¥åˆ†å·åˆ’åˆ†ï¼Œæ¯è¡Œè¯­å¥ç»“æŸå¿…é¡»æœ‰;\næ³¨é‡Šè¯­å¥ï¼šä¾¿äºä»–äººé˜…è¯»å’Œè‡ªå·±ä¿®æ”¹\n1 2 // ç¬¬ä¸€ç§æ³¨é‡Šè¯­å¥ï¼Œæ³¨é‡Šè¯­å¥å¯ä»¥åœ¨ç¨‹åºçš„ä»»ä½•ä½ç½®ï¼ˆå¹¿ä¹‰ï¼‰ /* ç¬¬äºŒç§æ³¨é‡Šè¯­å¥ */ å¤æ‚æ¡†æ¶ç»“æ„å¼•å…¥å‡½æ•°ï¼Œæ¨¡å—åŒ–è®¾è®¡ç†å¿µï¼Œæ„æˆç¨‹åºçš„å•ä½æ˜¯å‡½æ•°ï¼Œä¸€ä¸ªä¸»å‡½æ•° mainï¼Œè‹¥å¹²å­å‡½æ•°\nä¸»å‡½æ•°çš„ä½ç½®æ˜¯ä»»æ„çš„ï¼Œä½†ç¨‹åºçš„æ‰§è¡Œå¿…é¡»ä»ä¸»å‡½æ•°å¼€å§‹ï¼\nç¨‹åºä¸­çš„æ•°æ®ï¼šæ•°æ®æ˜¯ç¨‹åºçš„ç”Ÿå‘½ï¼Œæ²¡æœ‰ä¸å¤„ç†æ•°æ®çš„è¯­è¨€\næ•°æ®åˆ†ç±»ï¼ˆç±»å‹ï¼‰ åŸºæœ¬ç±»å‹ï¼šæ•´å‹ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹\næ•´å‹ï¼š\nName Byte æ§åˆ¶ç¬¦ èŒƒå›´ int ä¸€èˆ¬æ•´å‹ 4 %d short çŸ­æ•´å‹ 2 %hd -32768~32767 long é•¿æ•´å‹ 4 %ld unsigned æ— ç¬¦å·æ•´å‹ 4 %u unsigned å¯ä»¥è¡¨ç¤ºæ•´æ•°å’Œæ— ç¬¦å·æ•°ï¼Œä½†ä¸èƒ½è¡¨ç¤ºè´Ÿæ•°\næ•´å‹æ•°æ®åœ¨ç¨‹åºä¸­çš„è¡¨ç¤ºï¼ˆå­˜å‚¨ï¼‰ï¼š\nå¸¸é‡ï¼šconst å›ºå®šä¸å˜ å˜é‡ï¼šå¯ä»¥å­˜å‚¨èµ‹å€¼æ”¹å˜çš„æ•°å­— å˜é‡è§„åˆ™ï¼š\nåªèƒ½ç”±ä¸‹åˆ’çº¿ã€å­—æ¯ã€æ•°å­—ç»„æˆï¼šâ€œa~zâ€ï¼Œâ€œA~Zâ€ï¼Œâ€œ0~9â€ï¼Œâ€œ_â€ ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼Œå¹¶ä¸”ä¸¥æ ¼åŒºåˆ†å¤§å°å†™ï¼Œä¸å¯å’Œç³»ç»Ÿå…³é”®å­—å†²çªã€‚ å‡¡æ˜¯ç”¨æˆ·ç»„åˆçš„å˜é‡ï¼šç”¨æˆ·æ ‡è¯†ç¬¦ å˜é‡å¿…é¡»å£°æ˜åä½¿ç”¨ï¼ åªèƒ½å¯¹å˜é‡è¿›è¡Œèµ‹å€¼ï¼Œå˜é‡åœ¨èµ‹å€¼ç¬¦å·å·¦ä¾§ï¼› æ³¨ï¼šc89 ä¸­è§„å®šæ‰€æœ‰å˜é‡å¿…é¡»åœ¨ç¬¬ä¸€æ¡å¯æ‰§è¡Œè¯­å¥ä¹‹å‰å®šä¹‰ï¼ˆc99å…è®¸ï¼‰\nåœ¨èµ‹å€¼æ—¶ï¼Œè‹¥èµ‹å€¼ç¬¦å³ä¾§çš„æ•°æ®ç±»å‹ä¸åŒ¹é…ï¼Œåˆ™ä¸€å®šè¦è½¬åŒ–ä¸ºå·¦ä¾§å˜é‡ä¸€è‡´ï¼ˆintä¸ä¼šå››èˆäº”å…¥ï¼Œåªä¼šæˆªæ–­å°æ•°ç‚¹ï¼‰\n1 int x = 12.96; //resulf : x = 12 åœ¨ C program ä¸­æ— æ‰€è°“ï¼Œå…¶å®ƒè¯­è¨€ä¸å®¹å¿ å¦‚æœå®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œä½†æ˜¯æœªå¯¹å…¶åˆå§‹åŒ–ï¼Œåˆ™è¯¥å˜é‡çš„å€¼æ˜¯ä¸€ä¸ªéšæœºæ•°(é™æ€å˜é‡å’Œå…¨å±€å˜é‡é™¤å¤–)\nGo\næœªåˆå§‹åŒ–çš„å˜é‡é»˜è®¤æ˜¯é›¶å€¼ï¼Œå¦‚ int é›¶å€¼ä¸º 0ï¼Œbool é›¶å€¼ä¸º falseã€‚\nå†™ c è¯­è¨€ï¼Œå£°æ˜æ—¶åº”ç«‹å³åˆå§‹åŒ–ã€‚\nå›› è¾“å…¥ä¸è¾“å‡º\né”®ç›˜è¾“å…¥å€¼ï¼š\n1 2 3 scanf(\u0026#34;%d %d\u0026#34;ï¼Œ\u0026amp;aï¼Œ\u0026amp;b)ï¼› // å½“è¾“å…¥å‚æ•°æ—¶ï¼Œè‹¥æ§åˆ¶ç¬¦æ²¡æœ‰éš”å¼€ï¼Œè¾“å…¥çš„å‚æ•°ä¹‹é—´å¿…é¡» ç©ºæ ¼/å›è½¦/Tab éš”å¼€ ç´¢å¼•ï¼šgetsï¼ˆå­—ç¬¦ä¸²è¾“å…¥ï¼‰ ï¼Œgetcharï¼ˆå­—ç¬¦è¾“å…¥ï¼‰ è§ç¬¬äºŒè¯¾ â—¢ æ³¨ï¼šåœ¨ scanf é‡Œï¼Œå½“æ§åˆ¶ç¬¦æœ‰éš”å¼€ï¼Œè¾“å…¥å°±éœ€è¦ç›¸åŒçš„æ ¼å¼\nâ€‹ åœ¨ printf é‡Œï¼Œå¼•å·å†…æœ‰ä»€ä¹ˆå†…å®¹ï¼Œå°±æ‰“å°ä»€ä¹ˆå†…å®¹\n1 2 scanf(\u0026#34;%d---%d\u0026#34;,\u0026amp;a,\u0026amp;b); // input ï¼š 12---34 æ³¨æ„åŒºåˆ† long or unsigned å’Œå…¶å®ƒæ•´å‹ï¼š\n1 2 3 4 123L = longï¼ˆ4Byteï¼‰ // è‹¥è¦è¡¨è¾¾é•¿æ•´å‹å¸¸é‡ï¼Œéœ€åœ¨æ•°å€¼åé¢ Lï¼ˆlï¼‰ 234U = unsignedï¼ˆ4Byteï¼‰ // è‹¥è¦è¡¨è¾¾æ— ç¬¦å·æ•´å‹å¸¸é‡ï¼Œéœ€åœ¨æ•°å€¼åé¢ Uï¼ˆuï¼‰ 345LU = unsigned long // æ— ç¬¦å·é•¿æ•´å‹å¸¸é‡ 1.23F = float // å•ç²¾åº¦å®å‹å¸¸é‡ constant å¸¸é‡ variable å˜é‡ integer æ•´å‹ Decimal åè¿›åˆ¶ Octal å…«è¿›åˆ¶ Hexadecimal åå…­è¿›åˆ¶ Keyword å…³é”®å­— Statement è¯­å¥ identifier æ ‡è¯†ç¬¦ Rules è§„åˆ™ readability å¯è¯»æ€§ comment æ³¨é‡Š separator åˆ†éš”ç¬¦ Header files å¤´æ–‡ä»¶ ","date":"2018-08-01T00:00:00Z","permalink":"https://blog.golang.space/p/%E7%AC%AC%E4%B8%80%E8%AF%BE-%E8%AE%A4%E8%AF%86-c-%E8%AF%AD%E8%A8%80/","title":"ç¬¬ä¸€è¯¾ è®¤è¯† C è¯­è¨€"},{"content":"æµåª’ä½“æœåŠ¡å™¨ 16 æ ¸ 64GB å­˜å‚¨ï¼Œå°è¯• RTMP æ¨æµ 1000 è·¯ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è·‘æ»¡ï¼Œä½†æ˜¯ç”»é¢äº§ç”Ÿäº†å»¶è¿Ÿæˆ–åœé¡¿ï¼Œä»¥åŠæ–­å¼€è¿æ¥ã€‚\nä»¥ä¸‹æ˜¯è®°å½•æˆ‘çš„è§£å†³æ–¹æ¡ˆ:\næŸ¥è¯¢ memstats ä¿¡æ¯ æˆ‘å°è¯•é€šè¿‡ /debug/vars æŸ¥è¯¢ç¨‹åºå†…ä¿¡æ¯ï¼Œæ­¤æ—¶ GC æ¬¡æ•°æ˜¯ 168 æ¬¡ï¼Œå ç”¨ CPU æ¯”ä¾‹æ˜¯ 2%ï¼ŒGC æ€»å…±åœæ­¢æ—¶é—´æ˜¯ 263æ¯«ç§’ã€‚\nå½“å‰æ•°å€¼çš„æ¶ˆè€—ï¼Œä¸åº”è¯¥å¯¹ç¨‹åºå½±å“é‚£ä¹ˆå¤§ã€‚\nçœ‹çœ‹ cpu è¿è¡Œæ¶ˆè€— å–ä¸€ä¸‹ CPU ä¿¡æ¯ï¼Œ/debug/pprof/profile?seconds=30s\nå±€éƒ¨æ”¾å¤§\nå°å¯¹è±¡(mallocgcSmallNoscan)åˆ†é…å ç”¨ 34.18% å †æ‰©å®¹(growslice)å ç”¨ 7.31% å°†æ¶‰åŠåˆ°é¢‘ç¹åˆ†é…å¯¹è±¡çš„ä»£ç æ³¨é‡Šæ‰ï¼Œå†å‹æµ‹ä¸€ä¸‹çœ‹çœ‹è§†é¢‘æµç¡®å®æµç•…å¤šäº†ï¼Œä½†ä¾ç„¶å­˜åœ¨å¡é¡¿ã€‚\nå†æŠ“ä¸€æ¬¡ cpu ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ä¸»è¦æ¶ˆè€—æ˜¯ç³»ç»Ÿè°ƒç”¨\nå¤šæ¨ä¸€ä¼šæµï¼Œåœ¨æŠ“ cpuï¼Œgrow æ˜¯ä¸€ä¸ªå†…å­˜åˆ†é…çš„å‡½æ•°ï¼Œç¨‹åºåœ¨é¢‘ç¹å†…å­˜æ‰©å®¹\næå‰åˆ›å»ºä¸€å®šå¤§å°çš„å†…å­˜ï¼Œé¿å…æ‰©å®¹åï¼ŒèŠ‚çœä¸€åŠæ€§èƒ½\nç½‘ç»œæƒ…å†µ\ntx æ˜¯å‡ºç«™\ntx æ˜¯å…¥ç«™\n","date":"0001-01-01T00:00:00Z","permalink":"https://blog.golang.space/p/","title":""},{"content":"","date":"0001-01-01T00:00:00Z","permalink":"https://blog.golang.space/p/","title":""}]