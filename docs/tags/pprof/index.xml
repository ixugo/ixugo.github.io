<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>PProf on ixugo</title>
        <link>https://blog.golang.space/tags/pprof/</link>
        <description>Recent content in PProf on ixugo</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Thu, 22 May 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.golang.space/tags/pprof/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>记一次性能优化</title>
        <link>https://blog.golang.space/p/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</link>
        <pubDate>Thu, 22 May 2025 00:00:00 +0000</pubDate>
        
        <guid>https://blog.golang.space/p/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</guid>
        <description>&lt;p&gt;流媒体服务器 16 核 64GB 存储，尝试 RTMP 推流 1000 路，服务器没有跑满，但是画面产生了延迟或停顿，以及断开连接。&lt;/p&gt;
&lt;p&gt;以下是记录我的解决方案:&lt;/p&gt;
&lt;h2 id=&#34;查询-memstats-信息&#34;&gt;查询 memstats 信息&lt;/h2&gt;
&lt;p&gt;我尝试通过 &lt;code&gt;/debug/vars&lt;/code&gt; 查询程序内信息，此时 GC 次数是 168 次，占用 CPU 比例是 2%，GC 总共停止时间是 263毫秒。&lt;/p&gt;
&lt;p&gt;当前数值的消耗，不应该对程序影响那么大。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.golang.space/img-1747884098669.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;image-20250522112138586&#34;
	
	
&gt;&lt;/p&gt;
&lt;h2 id=&#34;看看-cpu-运行消耗&#34;&gt;看看 cpu 运行消耗&lt;/h2&gt;
&lt;p&gt;取一下 CPU 信息，&lt;code&gt;/debug/pprof/profile?seconds=30s&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.golang.space/img-1747884491961.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;image-20250522112811795&#34;
	
	
&gt;&lt;/p&gt;
&lt;p&gt;局部放大&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.golang.space/img-1747886967914.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;image-20250522120927723&#34;
	
	
&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;小对象(mallocgcSmallNoscan)分配占用 34.18%&lt;/li&gt;
&lt;li&gt;堆扩容(growslice)占用 7.31%&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;将涉及到频繁分配对象的代码注释掉，再压测一下看看视频流确实流畅多了，但依然存在卡顿。&lt;/p&gt;
&lt;p&gt;再抓一次 cpu 信息，可以看到主要消耗是系统调用&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.golang.space/img-1747897026853.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;image-20250522145706685&#34;
	
	
&gt;&lt;/p&gt;
&lt;p&gt;多推一会流，在抓 cpu，grow 是一个内存分配的函数，程序在频繁内存扩容&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.golang.space/img-1747977871180.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;image-20250523132430984&#34;
	
	
&gt;&lt;/p&gt;
&lt;p&gt;提前创建一定大小的内存，避免扩容后，节省一半性能&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.golang.space/img-1747977951431.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;image-20250523132551286&#34;
	
	
&gt;&lt;/p&gt;
&lt;p&gt;网络情况&lt;/p&gt;
&lt;p&gt;tx 是出站&lt;/p&gt;
&lt;p&gt;tx 是入站&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.golang.space/img-1747980993370.png&#34;
	
	
	
	loading=&#34;lazy&#34;
	
		alt=&#34;image-20250523141633187&#34;
	
	
&gt;&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
